<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë‚˜ì˜ ì‘ì€ í…Œë¼ë¦¬ì›€ - Spirit Garden</title>
    <link href="https://fonts.googleapis.com/css2?family=Nanum+Myeongjo:wght@400;700;800&family=Gowun+Batang:wght@400;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg: #fafaf8;
            --text: #2a2a2a;
            --border: #e0e0dc;
            --card: #ffffff;
            --shadow: rgba(0, 0, 0, 0.06);
            
            --fire: #ff6b4a;
            --water: #4a9eff;
            --wind: #7bdb8f;
            --earth: #d4a574;
            --light: #ffd94a;
            --dark: #8e7cc3;
        }

        body {
            font-family: 'Gowun Batang', serif;
            background: var(--bg);
            color: var(--text);
            line-height: 1.6;
            padding: 20px;
            max-width: 1400px;
            margin: 0 auto;
        }

        h1 {
            font-family: 'Nanum Myeongjo', serif;
            font-size: 2.5rem;
            font-weight: 800;
            text-align: center;
            margin-bottom: 10px;
            letter-spacing: -1px;
        }

        .subtitle {
            text-align: center;
            font-size: 0.9rem;
            color: #888;
            margin-bottom: 40px;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            border-bottom: 1px solid var(--border);
        }

        .tab {
            padding: 12px 24px;
            background: none;
            border: none;
            font-family: 'Gowun Batang', serif;
            font-size: 1rem;
            cursor: pointer;
            color: #888;
            transition: all 0.3s;
            border-bottom: 2px solid transparent;
        }

        .tab.active {
            color: var(--text);
            border-bottom-color: var(--text);
        }

        .tab:hover {
            color: var(--text);
        }

        .section {
            display: none;
        }

        .section.active {
            display: block;
        }

        .main-layout {
            display: grid;
            grid-template-columns: 300px 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }

        .inventory-panel {
            background: var(--card);
            border: 1px solid var(--border);
            padding: 24px;
            height: fit-content;
            position: sticky;
            top: 20px;
        }

        .inventory-title {
            font-family: 'Nanum Myeongjo', serif;
            font-size: 1.2rem;
            font-weight: 700;
            margin-bottom: 16px;
        }

        .inventory-section {
            margin-bottom: 20px;
        }

        .inventory-label {
            font-size: 0.85rem;
            color: #888;
            margin-bottom: 8px;
        }

        .inventory-items {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .inventory-item {
            padding: 6px 12px;
            background: var(--bg);
            border: 1px solid var(--border);
            font-size: 0.85rem;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .spirits-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 20px;
        }

        .spirit-card {
            background: var(--card);
            border: 1px solid var(--border);
            padding: 24px;
            transition: all 0.3s;
        }

        .spirit-card:hover {
            box-shadow: 0 4px 20px var(--shadow);
            transform: translateY(-2px);
        }

        .spirit-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 16px;
        }

        .spirit-icon {
            font-size: 3rem;
            line-height: 1;
        }

        .spirit-info {
            flex: 1;
            margin-left: 16px;
        }

        .spirit-name {
            font-family: 'Nanum Myeongjo', serif;
            font-size: 1.2rem;
            font-weight: 700;
            margin-bottom: 4px;
            cursor: pointer;
        }

        .spirit-name:hover {
            color: var(--fire);
        }

        .spirit-stage {
            font-size: 0.85rem;
            color: #888;
        }

        .progress-bar {
            height: 6px;
            background: var(--border);
            margin-bottom: 8px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--light), var(--fire));
            transition: width 0.5s;
        }

        .progress-text {
            font-size: 0.8rem;
            color: #888;
            margin-bottom: 16px;
        }

        .parameters {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
            margin-bottom: 16px;
            padding: 12px;
            background: var(--bg);
            border: 1px solid var(--border);
        }

        .param {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.85rem;
        }

        .param-icon {
            font-size: 1.1rem;
        }

        .environment {
            margin-bottom: 16px;
            padding: 12px;
            background: var(--bg);
            border: 1px solid var(--border);
        }

        .env-title {
            font-size: 0.85rem;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .env-bars {
            display: grid;
            gap: 6px;
        }

        .env-bar {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.8rem;
        }

        .env-bar-bg {
            flex: 1;
            height: 8px;
            background: var(--border);
            position: relative;
            overflow: hidden;
        }

        .env-bar-fill {
            height: 100%;
            transition: width 0.5s;
        }

        .spirit-status {
            font-size: 0.85rem;
            color: #888;
            margin-bottom: 16px;
            min-height: 40px;
        }

        .action-buttons {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
        }

        button {
            padding: 10px 16px;
            border: 1px solid var(--border);
            background: var(--card);
            font-family: 'Gowun Batang', serif;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        button:hover {
            background: var(--bg);
            border-color: var(--text);
        }

        button:active {
            transform: scale(0.98);
        }

        button:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }

        .new-spirit-btn {
            width: 100%;
            padding: 16px;
            font-size: 1rem;
            font-weight: 700;
            margin-top: 20px;
        }

        .walk-btn {
            width: 100%;
            padding: 16px;
            font-size: 1rem;
            font-weight: 700;
            margin-bottom: 20px;
            background: var(--light);
            border-color: var(--light);
            color: #000 !important;
        }

        .walk-btn:hover {
            background: var(--fire);
            border-color: var(--fire);
            color: #000 !important;
        }

        .walk-btn:disabled {
            color: #666 !important;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.6);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: var(--card);
            padding: 32px;
            max-width: 500px;
            width: 100%;
            max-height: 80vh;
            overflow-y: auto;
            border: 1px solid var(--border);
        }

        .modal-title {
            font-family: 'Nanum Myeongjo', serif;
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 20px;
        }

        .food-grid, .music-grid, .decor-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-bottom: 20px;
        }

        .option-btn {
            padding: 16px;
            text-align: left;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .option-icon {
            font-size: 1.5rem;
        }

        .option-info {
            flex: 1;
        }

        .option-name {
            font-weight: 700;
            margin-bottom: 2px;
        }

        .option-effect {
            font-size: 0.8rem;
            color: #888;
        }

        .close-btn {
            width: 100%;
            margin-top: 16px;
        }

        .collection-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px;
        }
        
        .encyclopedia-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .encyclopedia-card {
            background: var(--card);
            border: 2px solid var(--border);
            padding: 20px;
            text-align: center;
            position: relative;
            min-height: 120px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        
        .encyclopedia-card.unlocked {
            border-color: #4CAF50;
        }
        
        .encyclopedia-card.locked {
            background: repeating-linear-gradient(
                45deg,
                var(--card),
                var(--card) 10px,
                var(--border) 10px,
                var(--border) 11px
            );
            opacity: 0.6;
        }
        
        .encyclopedia-icon {
            font-size: 3rem;
            margin-bottom: 8px;
        }
        
        .encyclopedia-name {
            font-family: 'Nanum Myeongjo', serif;
            font-size: 1rem;
            font-weight: 700;
            color: var(--text);
        }
        
        .encyclopedia-count {
            font-size: 0.85rem;
            color: #888;
            margin-top: 4px;
        }

        .collection-card {
            background: var(--card);
            border: 1px solid var(--border);
            padding: 24px;
            text-align: center;
        }

        .collection-icon {
            font-size: 4rem;
            margin-bottom: 12px;
        }

        .collection-name {
            font-family: 'Nanum Myeongjo', serif;
            font-size: 1.2rem;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #888;
        }

        .empty-icon {
            font-size: 3rem;
            margin-bottom: 16px;
            opacity: 0.3;
        }

        .time-display {
            text-align: center;
            font-size: 0.9rem;
            color: #888;
            margin-bottom: 20px;
        }

        .notification {
            position: fixed;
            top: 80px;
            right: 20px;
            background: var(--card);
            border: 1px solid var(--border);
            padding: 16px 24px;
            box-shadow: 0 4px 20px var(--shadow);
            z-index: 999;
            animation: slideIn 0.3s ease-out;
            max-width: 300px;
            word-wrap: break-word;
        }

        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes slideOut {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(400px);
                opacity: 0;
            }
        }

        .name-input {
            width: 100%;
            padding: 12px;
            font-family: 'Gowun Batang', serif;
            font-size: 1rem;
            border: 1px solid var(--border);
            margin-bottom: 16px;
        }

        .decor-btn:disabled::after {
            content: 'ì¬ë£Œ ë¶€ì¡±';
            position: absolute;
            top: 8px;
            right: 8px;
            font-size: 0.7rem;
            padding: 2px 6px;
            background: #f44;
            color: white;
            border-radius: 2px;
        }

        @media (max-width: 900px) {
            .main-layout {
                grid-template-columns: 1fr;
            }

            .inventory-panel {
                position: static;
            }
        }

        .light-toggle {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 60px;
            height: 32px;
            background: #4CAF50;
            border: none;
            border-radius: 16px;
            cursor: pointer;
            transition: background-color 0.3s ease;
            z-index: 1000;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            padding: 0;
        }
        
        /* ëª¨ë°”ì¼ì—ì„œ ì¡°ëª… ë²„íŠ¼ í¬ê¸° ì¡°ì • */
        @media (max-width: 768px) {
            .light-toggle {
                bottom: 15px;
                right: 15px;
                width: 50px;
                height: 28px;
            }
            
            .light-toggle::before {
                width: 22px !important;
                height: 22px !important;
            }
            
            body.dark-mode .light-toggle::before {
                transform: translateX(22px) !important;
            }
            
            /* ìƒì  ë ˆì´ì•„ì›ƒ 1ì—´ë¡œ ë³€ê²½ */
            .shop-grid {
                grid-template-columns: 1fr !important;
                gap: 15px !important;
            }
            
            /* ìƒì  ì„¹ì…˜ íŒ¨ë”© ì¡°ì • */
            .shop-section {
                padding: 20px !important;
            }
            
            /* ì œëª© í¬ê¸° ì¡°ì • */
            h1 {
                font-size: 1.8rem !important;
            }
            
            h2 {
                font-size: 1.5rem !important;
            }
            
            /* íƒ­ ë²„íŠ¼ í¬ê¸° ì¡°ì • */
            .tab {
                padding: 10px 15px !important;
                font-size: 0.9rem !important;
            }
            
            /* ìƒì  ì œëª© í¬ê¸° ì¡°ì • */
            .shop-section h3 {
                font-size: 1.1rem !important;
            }
            
            /* ì „ì²´ ì—¬ë°± ì¡°ì • */
            body {
                padding: 10px !important;
            }
        }

        .light-toggle::before {
            content: '';
            position: absolute;
            width: 26px;
            height: 26px;
            border-radius: 50%;
            background: white;
            top: 3px;
            left: 3px;
            transition: transform 0.3s ease;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        body.dark-mode .light-toggle {
            background: #666;
        }

        body.dark-mode .light-toggle::before {
            transform: translateX(28px);
        }

        .light-toggle #lightIcon {
            display: none;
        }

        body.dark-mode {
            --bg: #1a1a1a;
            --card: #2d2d2d;
            --text: #e0e0e0;
            --border: #404040;
        }

        body.dark-mode .spirit-name,
        body.dark-mode .spirit-stage,
        body.dark-mode .progress-text,
        body.dark-mode .param,
        body.dark-mode .spirit-status,
        body.dark-mode .env-title,
        body.dark-mode .modal-title,
        body.dark-mode .option-name,
        body.dark-mode .option-effect,
        body.dark-mode .inventory-label,
        body.dark-mode .collection-name,
        body.dark-mode h1,
        body.dark-mode h2,
        body.dark-mode .subtitle,
        body.dark-mode .time-display {
            color: #e0e0e0;
        }

        body.dark-mode button {
            color: #e0e0e0;
        }

        body.dark-mode button:disabled {
            color: #888;
        }
    </style>
</head>
<body>
    <button id="lightToggle" class="light-toggle" onclick="toggleLight()">
        <span id="lightIcon">â˜€ï¸</span>
    </button>

    <h1>ë‚˜ì˜ ì‘ì€ í…Œë¼ë¦¬ì›€</h1>
    <div class="subtitle">Spirit Garden</div>

    <div class="time-display" id="timeDisplay"></div>

    <div class="tabs">
        <button class="tab active" onclick="switchTab('garden')">ìœ¡ì„±</button>
        <button class="tab" onclick="switchTab('terrarium')">í…Œë¼ë¦¬ì›€</button>
        <button class="tab" onclick="switchTab('shop')">ìƒì  ğŸ’°<span id="coinDisplay">0</span></button>
        <button class="tab" onclick="switchTab('encyclopedia')">ë„ê°</button>
        <button class="tab" onclick="switchTab('album')">ì•¨ë²”</button>
    </div>

    <div id="gardenSection" class="section active">
        <div class="main-layout">
            <div class="inventory-panel">
                <div class="inventory-title">ë‚´ ì†Œì§€í’ˆ</div>
                
                <div class="inventory-section">
                    <div class="inventory-label">ğŸ ë¨¹ì´</div>
                    <div class="inventory-items" id="foodInventory">
                        <div class="inventory-item">ì—†ìŒ</div>
                    </div>
                </div>

                <div class="inventory-section">
                    <div class="inventory-label">ğŸµ ìŒì•…</div>
                    <div class="inventory-items" id="musicInventory">
                        <div class="inventory-item">ì—†ìŒ</div>
                    </div>
                </div>

                <div class="inventory-section">
                    <div class="inventory-label">ğŸŒ³ ë‚˜ë¬´ & ì¥ì‹ë¬¼</div>
                    <div class="inventory-items" id="decorInventory">
                        <div class="inventory-item">ì—†ìŒ</div>
                    </div>
                </div>

                <div style="margin-bottom: 12px;">
                    <label for="titleSelect" style="display: block; font-size: 0.9rem; margin-bottom: 6px; color: var(--text); font-weight: 600;">ğŸ† ì¹­í˜¸ ì„ íƒ</label>
                    <select id="titleSelect" onchange="changeTitle()" style="width: 100%; padding: 10px; border: 2px solid var(--border); border-radius: 8px; background: var(--card); color: var(--text); font-size: 0.9rem; cursor: pointer;">
                        <option value="none">ì—†ìŒ (ê¸°ë³¸)</option>
                        <option value="hawk_eye">ğŸ¦… ë§¤ì˜ ëˆˆ (ëª¨ë“  ì±„ì§‘ë¬¼ í™•ë¥  1.5ë°°)</option>
                        <option value="gatherer">ğŸ ì±„ì§‘ê¾¼ (ë¨¹ì´ í™•ë¥  2ë°°)</option>
                        <option value="musician">ğŸµ ìŒì•…ê°€ (ë ˆì½”ë“œ í™•ë¥  2ë°°)</option>
                        <option value="collector">ğŸ’ ìˆ˜ì§‘ê°€ (í…Œë¼ë¦¬ì›€ ë¬¼í’ˆ í™•ë¥  2ë°°)</option>
                    </select>
                </div>

                <button class="walk-btn" onclick="goGather()">ğŸŒ¿ ì±„ì§‘í•˜ê¸°</button>
            </div>

            <div>
                <div class="spirits-grid" id="spiritsGrid"></div>
                <button class="new-spirit-btn" onclick="createNewSpirit()">+ ìƒˆë¡œìš´ ì•Œ ë°›ê¸°</button>
            </div>
        </div>
    </div>

    <div id="encyclopediaSection" class="section">
        <h2 style="text-align: center; font-family: 'Nanum Myeongjo', serif; font-size: 2rem; margin-bottom: 30px;">ğŸ“– ì •ë ¹ ë„ê°</h2>
        <div class="encyclopedia-grid" id="encyclopediaGrid"></div>
    </div>

    <div id="albumSection" class="section">
        <h2 style="text-align: center; font-family: 'Nanum Myeongjo', serif; font-size: 2rem; margin-bottom: 30px;">ğŸ’ ì •ë ¹ ì•¨ë²”</h2>
        <div class="collection-grid" id="collectionGrid"></div>
    </div>

    <div id="shopSection" class="section">
        <div style="max-width: 1000px; margin: 0 auto;">
            <div style="text-align: center; margin-bottom: 30px;">
                <h2 style="font-family: 'Nanum Myeongjo', serif; font-size: 2rem; margin-bottom: 10px;">ğŸª ì •ë ¹ ìƒì </h2>
                <div style="font-size: 1.5rem; font-weight: 700; color: var(--fire);">ë³´ìœ  ì½”ì¸: <span id="shopCoinDisplay">0</span> ğŸ’°</div>
            </div>

            <div class="shop-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 30px;">
                <!-- íŒë§¤ (ì†Œì§€í’ˆ â†’ ì½”ì¸) -->
                <div class="shop-section" style="background: var(--card); border: 1px solid var(--border); padding: 32px;">
                    <h3 style="font-family: 'Nanum Myeongjo', serif; font-size: 1.3rem; margin-bottom: 20px; color: var(--fire);">ğŸ’¸ íŒë§¤í•˜ê¸°</h3>
                    <div id="sellList"></div>
                </div>

                <!-- êµ¬ë§¤ (ì½”ì¸ â†’ ì•„ì´í…œ) -->
                <div class="shop-section" style="background: var(--card); border: 1px solid var(--border); padding: 32px;">
                    <h3 style="font-family: 'Nanum Myeongjo', serif; font-size: 1.3rem; margin-bottom: 20px; color: var(--water);">ğŸ›’ êµ¬ë§¤í•˜ê¸°</h3>
                    <div id="buyList"></div>
                </div>
            </div>
        </div>
    </div>

    <div id="terrariumSection" class="section">
        <div style="max-width: 800px; margin: 0 auto;">
            <div style="background: var(--card); border: 1px solid var(--border); padding: 32px; margin-bottom: 20px;">
                <h2 style="font-family: 'Nanum Myeongjo', serif; font-size: 1.5rem; margin-bottom: 20px;">í…Œë¼ë¦¬ì›€ í™˜ê²½</h2>
                <div class="env-bars" style="display: grid; gap: 12px;">
                    <div class="env-bar" style="display: flex; align-items: center; gap: 12px;">
                        <span style="font-size: 1.5rem;">ğŸ”¥</span>
                        <div class="env-bar-bg" style="flex: 1; height: 12px; background: var(--border);">
                            <div class="env-bar-fill" id="terrFireBar" style="height: 100%; background: var(--fire); width: 0%;"></div>
                        </div>
                        <span id="terrFireValue" style="min-width: 30px; text-align: right;">0</span>
                    </div>
                    <div class="env-bar" style="display: flex; align-items: center; gap: 12px;">
                        <span style="font-size: 1.5rem;">ğŸ’§</span>
                        <div class="env-bar-bg" style="flex: 1; height: 12px; background: var(--border);">
                            <div class="env-bar-fill" id="terrWaterBar" style="height: 100%; background: var(--water); width: 0%;"></div>
                        </div>
                        <span id="terrWaterValue" style="min-width: 30px; text-align: right;">0</span>
                    </div>
                    <div class="env-bar" style="display: flex; align-items: center; gap: 12px;">
                        <span style="font-size: 1.5rem;">ğŸƒ</span>
                        <div class="env-bar-bg" style="flex: 1; height: 12px; background: var(--border);">
                            <div class="env-bar-fill" id="terrWindBar" style="height: 100%; background: var(--wind); width: 0%;"></div>
                        </div>
                        <span id="terrWindValue" style="min-width: 30px; text-align: right;">0</span>
                    </div>
                    <div class="env-bar" style="display: flex; align-items: center; gap: 12px;">
                        <span style="font-size: 1.5rem;">ğŸŒ±</span>
                        <div class="env-bar-bg" style="flex: 1; height: 12px; background: var(--border);">
                            <div class="env-bar-fill" id="terrEarthBar" style="height: 100%; background: var(--earth); width: 0%;"></div>
                        </div>
                        <span id="terrEarthValue" style="min-width: 30px; text-align: right;">0</span>
                    </div>
                    <div class="env-bar" style="display: flex; align-items: center; gap: 12px;">
                        <span style="font-size: 1.5rem;">âœ¨</span>
                        <div class="env-bar-bg" style="flex: 1; height: 12px; background: var(--border);">
                            <div class="env-bar-fill" id="terrLightBar" style="height: 100%; background: var(--light); width: 0%;"></div>
                        </div>
                        <span id="terrLightValue" style="min-width: 30px; text-align: right;">0</span>
                    </div>
                    <div class="env-bar" style="display: flex; align-items: center; gap: 12px;">
                        <span style="font-size: 1.5rem;">ğŸŒ™</span>
                        <div class="env-bar-bg" style="flex: 1; height: 12px; background: var(--border);">
                            <div class="env-bar-fill" id="terrDarkBar" style="height: 100%; background: var(--dark); width: 0%;"></div>
                        </div>
                        <span id="terrDarkValue" style="min-width: 30px; text-align: right;">0</span>
                    </div>
                </div>
            </div>

            <div style="background: var(--card); border: 1px solid var(--border); padding: 32px; margin-bottom: 20px;">
                <h2 style="font-family: 'Nanum Myeongjo', serif; font-size: 1.5rem; margin-bottom: 10px;">ì„¤ì¹˜ëœ ì¥ì‹ë¬¼</h2>
                <div style="font-size: 0.9rem; color: #888; margin-bottom: 20px;" id="installedCount">0 / 20</div>
                <div id="installedDecorList"></div>
            </div>

            <div style="background: var(--card); border: 1px solid var(--border); padding: 32px;">
                <h2 style="font-family: 'Nanum Myeongjo', serif; font-size: 1.5rem; margin-bottom: 20px;">ì¸ë²¤í† ë¦¬ ì¥ì‹ë¬¼</h2>
                <div id="terrariumDecorList"></div>
            </div>
        </div>
    </div>

    <!-- Name Modal -->
    <div class="modal" id="nameModal">
        <div class="modal-content">
            <div class="modal-title">ì •ë ¹ì˜ ì´ë¦„ì„ ì§€ì–´ì£¼ì„¸ìš”</div>
            <input type="text" class="name-input" id="nameInput" placeholder="ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”" maxlength="10">
            <button onclick="confirmName()" style="width: 100%;">í™•ì¸</button>
        </div>
    </div>

    <!-- Feed Modal -->
    <div class="modal" id="feedModal">
        <div class="modal-content">
            <div class="modal-title">ë¬´ì—‡ì„ ë¨¹ì¼ê¹Œìš”?</div>
            <div class="food-grid">
                <!-- ì´ˆê¸° ë”ë¯¸ ë²„íŠ¼ (renderFeedOptions()ë¡œ ë™ì  ìƒì„±ë¨) -->
            </div>
            <button class="close-btn" onclick="closeModal('feedModal')">ë‹«ê¸°</button>
        </div>
    </div>

    <!-- Music Modal -->
    <div class="modal" id="musicModal">
        <div class="modal-content">
            <div class="modal-title">ì–´ë–¤ ìŒì•…ì„ ë“¤ë ¤ì¤„ê¹Œìš”?</div>
            <div id="musicOptions"></div>
            <button class="close-btn" onclick="closeModal('musicModal')">ë‹«ê¸°</button>
        </div>
    </div>

    <!-- Decorate Modal -->
    <div class="modal" id="decorateModal">
        <div class="modal-content">
            <div class="modal-title">í…Œë¼ë¦¬ì›€ ê¾¸ë¯¸ê¸°</div>
            <div id="decorOptions"></div>
            <button class="close-btn" onclick="closeModal('decorateModal')">ë‹«ê¸°</button>
        </div>
    </div>

    <script>
        let spirits = [];
        let collection = [];
        let encyclopedia = {}; // ë„ê°: { evolutionKey: count }
        let inventory = {
            music: [],
            decorations: [],
            food: ['fire', 'fire', 'fire', 'water', 'water', 'water', 'wind', 'wind', 'wind', 'earth', 'earth', 'earth']
        };
        let terrarium = {
            fire: 0,
            water: 0,
            wind: 0,
            earth: 0,
            light: 0,
            dark: 0
        };
        let installedDecorations = []; // ì„¤ì¹˜ëœ ì¥ì‹ë¬¼ ëª©ë¡
        let lightMode = true; // ì¡°ëª… ëª¨ë“œ (true: ë¹›, false: ì–´ë‘ )
        let coins = 0; // í™”í
        let currentSpiritId = null;
        let pendingSpirit = null;
        let lastGatherTime = null;
        let currentTab = 'garden'; // í˜„ì¬ í™œì„± íƒ­
        let currentTitle = 'none'; // í˜„ì¬ ì¹­í˜¸ (none, hawk_eye, gatherer, musician, collector)

        const STAGE_REQUIREMENTS = {
            egg: 0,
            larva1: 10,
            larva2: 25,
            larva3: 45,
            pupa: 70,
            adult: 100
        };

        const STAGE_ICONS = {
            egg: 'ğŸ¥š',
            larva1: 'ğŸ›',
            larva2: 'ğŸ›',
            larva3: 'ğŸ›',
            pupa: 'ğŸ¦‹',
            adult: 'ğŸ¦‹'
        };

        const STAGE_NAMES = {
            egg: 'ì•Œ',
            larva1: 'ì• ë²Œë ˆ I',
            larva2: 'ì• ë²Œë ˆ II',
            larva3: 'ì• ë²Œë ˆ III',
            pupa: 'ë²ˆë°ê¸°',
            adult: 'ì„±ì¶©'
        };

        const PARAM_ICONS = {
            intelligence: 'ğŸ§ ',
            strength: 'ğŸ’ª',
            charm: 'ğŸ’–',
            affection: 'â¤ï¸'
        };

        const ENV_ICONS = {
            fire: 'ğŸ”¥',
            water: 'ğŸ’§',
            wind: 'ğŸƒ',
            earth: 'ğŸŒ±',
            light: 'âœ¨',
            dark: 'ğŸŒ™'
        };

        const MUSIC_TYPES = {
            quest: { name: 'íƒí—˜ì˜ ë ˆì½”ë“œ', icon: 'âš”ï¸', effect: 'ì²´ë ¥ +3, ì§€ë ¥ +1' },
            lullaby: { name: 'ìì¥ê°€ ë ˆì½”ë“œ', icon: 'ğŸŒ™', effect: 'ë§¤ë ¥ +2, ì§€ë ¥ +1' },
            march: { name: 'í–‰ì§„ê³¡ ë ˆì½”ë“œ', icon: 'ğŸº', effect: 'ì²´ë ¥ +3, ì§€ë ¥ +1' },
            ballad: { name: 'ë°œë¼ë“œ ë ˆì½”ë“œ', icon: 'ğŸµ', effect: 'ë§¤ë ¥ +3, ì²´ë ¥ +1' },
            classical: { name: 'í´ë˜ì‹ ë ˆì½”ë“œ', icon: 'ğŸ»', effect: 'ì§€ë ¥ +3, ë§¤ë ¥ +1' },
            dance: { name: 'ëŒ„ìŠ¤ ë ˆì½”ë“œ', icon: 'ğŸ’ƒ', effect: 'ì²´ë ¥ +2, ë§¤ë ¥ +2' }
        };

        const DECORATION_TYPES = {
            fire: { name: 'ìš©ì•”ì„', icon: 'ğŸ”¥', effect: 'ë¶ˆ +1' },
            water: { name: 'ë¶„ìˆ˜', icon: 'ğŸ’§', effect: 'ë¬¼ +1' },
            wind: { name: 'ë°”ëŒê°œë¹„', icon: 'ğŸƒ', effect: 'ë°”ëŒ +1' },
            earth: { name: 'í™”ë¶„', icon: 'ğŸŒ±', effect: 'ë•… +1' },
            light: { name: 'ìˆ˜ì •', icon: 'âœ¨', effect: 'ë¹› +1' },
            dark: { name: 'í‘ìš”ì„', icon: 'ğŸŒ™', effect: 'ì–´ë‘  +1' }
        };

        const FOOD_NAMES = {
            fire: 'ë¶ˆê½ƒì—´ë§¤',
            water: 'ë§‘ì€ì´ìŠ¬',
            wind: 'ë°”ëŒê¿€',
            earth: 'ëŒ€ì§€ë²„ì„¯',
            light: 'ë¹›ë‚˜ëŠ” ë„¥íƒ€',
            dark: 'ê²€ì€ ê½ƒê°€ë£¨'
        };

        // ìƒì  ê°€ê²©í‘œ
        const SHOP_PRICES = {
            // íŒë§¤ ê°€ê²© (ì¸ë²¤í† ë¦¬ â†’ ì½”ì¸)
            sell: {
                food_common: 8,    // ì¼ë°˜ ë¨¹ì´ íŒë§¤
                food_rare: 15,     // í¬ê·€ ë¨¹ì´ íŒë§¤
                decoration: 15,    // ì¥ì‹ë¬¼ 1ê°œ = 15ì½”ì¸
                music: 25          // ìŒì•… 1ê°œ = 25ì½”ì¸
            },
            // êµ¬ë§¤ ê°€ê²© (ì½”ì¸ â†’ ì¸ë²¤í† ë¦¬)
            buy: {
                food_common: 20,   // ì¼ë°˜ ë¨¹ì´ (í™”ìˆ˜í’ì§€)
                food_rare: 40,     // í¬ê·€ ë¨¹ì´ (ë¹›ì•”)
                music: 80,         // ìŒì•… ë ˆì½”ë“œ
                decoration: 50     // ì¥ì‹ë¬¼
            }
        };

        const EVOLUTION_TYPES = {
            // ë…¸ë©€ (ëª¨ë“  ìŠ¤íƒ­ì´ 10 ë¯¸ë§Œ)
            normal: { name: 'ë°±ì˜ ì •ë ¹', icon: 'ğŸ¤', desc: 'ìˆœìˆ˜í•œ ë¹›ì„ ê°„ì§í•œ ì •ë ¹. ëª¨ë“  ì •ë ¹ì˜ ì‹œì‘ì´ì ê·¼ì›.' },
            
            // ì§€ì ì¸ ê³„ì—´ (intelligence ìµœê³ )
            'intelligent-basic': { prefix: 'ì§€ì ì¸', icon: 'âœ¨' },
            'intelligent-advanced': { prefix: 'ì§€ì ì¸', icon: 'ğŸ’' },
            'intelligent-master': { prefix: 'ì§€ì ì¸', icon: 'ğŸ”®' },
            
            // ê°•í•œ ê³„ì—´ (strength ìµœê³ )
            'strong-basic': { prefix: 'ê°•í•œ', icon: 'âœ¨' },
            'strong-advanced': { prefix: 'ê°•í•œ', icon: 'ğŸ’ª' },
            'strong-master': { prefix: 'ê°•í•œ', icon: 'âš¡' },
            
            // ì•„ë¦„ë‹¤ìš´ ê³„ì—´ (charm ìµœê³ )
            'beautiful-basic': { prefix: 'ì•„ë¦„ë‹¤ìš´', icon: 'âœ¨' },
            'beautiful-advanced': { prefix: 'ì•„ë¦„ë‹¤ìš´', icon: 'ğŸŒ¸' },
            'beautiful-master': { prefix: 'ì•„ë¦„ë‹¤ìš´', icon: 'ğŸŒº' }
        };
        
        // ì†ì„±ë³„ ì •ë ¹ ì´ë¦„
        const ATTRIBUTE_NAMES = {
            fire: { name: 'í™”ì—¼ì˜ ì •ë ¹', icon: 'ğŸ”¥', desc: 'íƒ€ì˜¤ë¥´ëŠ” ì—´ì •ì„ ê°„ì§í•œ í™”ì—¼ì˜ ì •ë ¹.' },
            water: { name: 'ë¹™í•˜ì˜ ì •ë ¹', icon: 'ğŸ’§', desc: 'ì°¨ê°€ìš´ ì§€í˜œë¥¼ í’ˆì€ ë¬¼ì˜ ì •ë ¹.' },
            wind: { name: 'ì§ˆí’ì˜ ì •ë ¹', icon: 'ğŸƒ', desc: 'ììœ ë¡œìš´ ë°”ëŒì„ ë‹´ì€ ì§ˆí’ì˜ ì •ë ¹.' },
            earth: { name: 'ëŒ€ì§€ì˜ ì •ë ¹', icon: 'ğŸŒ±', desc: 'ê²¬ê³ í•œ ëŒ€ì§€ì˜ í˜ì„ ì§€ë‹Œ ì •ë ¹.' },
            light: { name: 'ê´‘ëª…ì˜ ì •ë ¹', icon: 'âœ¨', desc: 'ì°¬ë€í•œ ë¹›ìœ¼ë¡œ ê°€ë“í•œ ê´‘ëª…ì˜ ì •ë ¹.' },
            dark: { name: 'ì•”í‘ì˜ ì •ë ¹', icon: 'ğŸŒ™', desc: 'ì‹ ë¹„ë¡œìš´ ì–´ë‘ ì„ ë‹´ì€ ì•”í‘ì˜ ì •ë ¹.' },
            
            // 2ì†ì„± ì¡°í•©
            'fire-water': { name: 'ì¦ê¸°ì˜ ì •ë ¹', icon: 'ğŸ’¨', desc: 'ë¶ˆê³¼ ë¬¼ì´ ë§Œë‚˜ íƒ„ìƒí•œ ì¦ê¸°ì˜ ì •ë ¹.' },
            'fire-wind': { name: 'í­í’ì˜ ì •ë ¹', icon: 'ğŸŒªï¸', desc: 'ë¶ˆê³¼ ë°”ëŒì´ ë§Œë“  ëœ¨ê±°ìš´ í­í’ì˜ ì •ë ¹.' },
            'fire-earth': { name: 'ìš©ì•”ì˜ ì •ë ¹', icon: 'ğŸŒ‹', desc: 'ë¶ˆê³¼ ëŒ€ì§€ê°€ ë¹šì–´ë‚¸ ìš©ì•”ì˜ ì •ë ¹.' },
            'fire-light': { name: 'íƒœì–‘ì˜ ì •ë ¹', icon: 'â˜€ï¸', desc: 'ë¶ˆê³¼ ë¹›ì´ í•©ì³ì§„ íƒœì–‘ì˜ ì •ë ¹.' },
            'fire-dark': { name: 'ì—°ê¸°ì˜ ì •ë ¹', icon: 'ğŸ’¨', desc: 'ë¶ˆê³¼ ì–´ë‘ ì´ ë§Œë“  ì—°ê¸°ì˜ ì •ë ¹.' },
            'water-wind': { name: 'êµ¬ë¦„ì˜ ì •ë ¹', icon: 'â˜ï¸', desc: 'ë¬¼ê³¼ ë°”ëŒì´ ë§Œë“  êµ¬ë¦„ì˜ ì •ë ¹.' },
            'water-earth': { name: 'ì§„í™ì˜ ì •ë ¹', icon: 'ğŸª¨', desc: 'ë¬¼ê³¼ ëŒ€ì§€ê°€ ì„ì¸ ì§„í™ì˜ ì •ë ¹.' },
            'water-light': { name: 'ë¬´ì§€ê°œì˜ ì •ë ¹', icon: 'ğŸŒˆ', desc: 'ë¬¼ê³¼ ë¹›ì´ ë§Œë“  ë¬´ì§€ê°œì˜ ì •ë ¹.' },
            'water-dark': { name: 'ì•ˆê°œì˜ ì •ë ¹', icon: 'ğŸŒ«ï¸', desc: 'ë¬¼ê³¼ ì–´ë‘ ì´ ë§Œë“  ì•ˆê°œì˜ ì •ë ¹.' },
            'wind-earth': { name: 'ëª¨ë˜ì˜ ì •ë ¹', icon: 'ğŸœï¸', desc: 'ë°”ëŒê³¼ ëŒ€ì§€ê°€ ë§Œë“  ëª¨ë˜ì˜ ì •ë ¹.' },
            'wind-light': { name: 'ì˜¤ë¡œë¼ì˜ ì •ë ¹', icon: 'ğŸŒŒ', desc: 'ë°”ëŒê³¼ ë¹›ì´ ë§Œë“  ì˜¤ë¡œë¼ì˜ ì •ë ¹.' },
            'wind-dark': { name: 'íšŒì˜¤ë¦¬ì˜ ì •ë ¹', icon: 'ğŸŒ€', desc: 'ë°”ëŒê³¼ ì–´ë‘ ì´ ë§Œë“  íšŒì˜¤ë¦¬ì˜ ì •ë ¹.' },
            'earth-light': { name: 'ìˆ˜ì •ì˜ ì •ë ¹', icon: 'ğŸ’', desc: 'ëŒ€ì§€ì™€ ë¹›ì´ ë§Œë“  ìˆ˜ì •ì˜ ì •ë ¹.' },
            'earth-dark': { name: 'ë™êµ´ì˜ ì •ë ¹', icon: 'â›°ï¸', desc: 'ëŒ€ì§€ì™€ ì–´ë‘ ì´ ë§Œë“  ë™êµ´ì˜ ì •ë ¹.' },
            'light-dark': { name: 'í™˜í˜¹ì˜ ì •ë ¹', icon: 'âœ¨ğŸŒ™', desc: 'ë¹›ê³¼ ì–´ë‘ ì´ ê³µì¡´í•˜ëŠ” í™˜í˜¹ì˜ ì •ë ¹.' },
            
            // 3ì†ì„± ì´ìƒ (ë³µí•©)
            balanced: { name: 'ì¡°í™”ì˜ ì •ë ¹', icon: 'âš–ï¸', desc: 'ëª¨ë“  ì†ì„±ì´ ì¡°í™”ë¡­ê²Œ ê· í˜• ì¡íŒ ì •ë ¹.' },
            multi: { name: 'í˜¼ëˆì˜ ì •ë ¹', icon: 'ğŸŒªï¸', desc: 'ì—¬ëŸ¬ ì†ì„±ì´ ë’¤ì„ì¸ í˜¼ëˆì˜ ì •ë ¹.' }
        };

        function loadGame() {
            const saved = localStorage.getItem('spiritGardenV2');
            if (saved) {
                const data = JSON.parse(saved);
                spirits = data.spirits || [];
                collection = data.collection || [];
                encyclopedia = data.encyclopedia || {};
                
                // ê¸°ì¡´ ë„ê° ë°ì´í„° í˜¸í™˜ì„± ì²˜ë¦¬ - ì¡´ì¬í•˜ì§€ ì•ŠëŠ” ì§„í™” íƒ€ì… ì œê±°
                collection = collection.filter(item => {
                    return EVOLUTION_TYPES[item.type] !== undefined;
                });
                
                inventory = data.inventory || { 
                    music: [], 
                    decorations: [],
                    food: ['fire', 'fire', 'fire', 'water', 'water', 'water', 'wind', 'wind', 'wind', 'earth', 'earth', 'earth']
                };
                terrarium = data.terrarium || {
                    fire: 0, water: 0, wind: 0, earth: 0, light: 0, dark: 0
                };
                installedDecorations = data.installedDecorations || [];
                lightMode = data.lightMode !== undefined ? data.lightMode : true;
                coins = data.coins || 0;
                lastGatherTime = data.lastGatherTime || null;
                currentTitle = data.currentTitle || 'none';

                // ì¹­í˜¸ UI ë°˜ì˜
                const titleSelect = document.getElementById('titleSelect');
                if (titleSelect) {
                    titleSelect.value = currentTitle;
                }

                // ì„¤ì¹˜ëœ ì¥ì‹ë¬¼ë¡œ í™˜ê²½ ì¬ê³„ì‚°
                if (installedDecorations.length > 0) {
                    recalculateTerrariumEnvironment();
                }

                // ì¡°ëª… ìƒíƒœ ì ìš©
                applyLightMode();
            }
        }

        function saveGame() {
            localStorage.setItem('spiritGardenV2', JSON.stringify({
                spirits,
                collection,
                encyclopedia,
                inventory,
                terrarium,
                installedDecorations,
                lightMode,
                coins,
                lastGatherTime,
                currentTitle
            }));
        }

        const EGG_NAMES = [
            'ë°˜ì§ì´ëŠ” ì•Œ', 'ë§¤ëˆë§¤ëˆí•œ ì•Œ', 'ì–¼ë£©ë¬´ëŠ¬ ì•Œ', 'ë³´ë¼ìƒ‰ ì•Œ',
            'íˆ¬ëª…í•œ ì•Œ', 'í™©ê¸ˆë¹› ì•Œ', 'ì€ë¹› ì•Œ', 'ê²€ì€ìƒ‰ ì•Œ',
            'í•˜ì–€ìƒ‰ ì•Œ', 'ë¬´ì§€ê°œ ì•Œ', 'ì‘ì€ ì•Œ', 'í° ì•Œ',
            'ë”°ëœ»í•œ ì•Œ', 'ì°¨ê°€ìš´ ì•Œ', 'ë¶€ë“œëŸ¬ìš´ ì•Œ', 'ë‹¨ë‹¨í•œ ì•Œ'
        ];

        function addLog(spirit, message) {
            if (!spirit.logs) spirit.logs = [];
            const timestamp = new Date().toLocaleString('ko-KR', {
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            });
            spirit.logs.unshift({ time: timestamp, message }); // ìµœì‹ ì´ ìœ„ë¡œ
            if (spirit.logs.length > 50) spirit.logs.pop(); // ìµœëŒ€ 50ê°œ ìœ ì§€
            
            // ì¼ì§€ ì¶”ê°€ ì‹œì—ë§Œ ì „ì²´ ë Œë”ë§
            renderSpirits();
        }

        function createNewSpirit() {
            if (spirits.length >= 6) {
                showNotification('ì •ì›ì´ ê°€ë“ ì°¼ìŠµë‹ˆë‹¤ (ìµœëŒ€ 6ë§ˆë¦¬)');
                return;
            }

            const randomName = EGG_NAMES[Math.floor(Math.random() * EGG_NAMES.length)];

            const spirit = {
                id: Date.now(),
                name: randomName,
                growth: 0,
                // ê³µê°œ ìŠ¤íƒ¯
                parameters: {
                    intelligence: 0,  // ì§€ë ¥
                    strength: 0,      // ì²´ë ¥
                    charm: 0,         // ë§¤ë ¥
                    affection: 0      // ì• ì •
                },
                // ìˆ¨ê²¨ì§„ ì†ì„± (ì§„í™” ê²°ì •)
                hiddenAttributes: {
                    fire: 0,
                    water: 0,
                    wind: 0,
                    earth: 0,
                    light: 0,
                    dark: 0
                },
                lastFed: null,
                lastMusic: null,
                lastPat: null,
                lastDecorate: null,
                status: 'ë°°ê³ íŒŒ ë³´ì…ë‹ˆë‹¤...',
                birthTime: Date.now(),
                logs: [],  // ì¼ì§€
                lightTime: 0,  // ë¹› ëª¨ë“œ ëˆ„ì  ì‹œê°„ (ì´ˆ)
                darkTime: 0    // ì–´ë‘  ëª¨ë“œ ëˆ„ì  ì‹œê°„ (ì´ˆ)
            };

            spirits.push(spirit);
            saveGame();
            renderSpirits();
            showNotification(`${randomName}ì´(ê°€) íƒœì–´ë‚¬ìŠµë‹ˆë‹¤! ğŸ¥š`);
        }

        function changeName(spiritId) {
            currentSpiritId = spiritId;
            const spirit = spirits.find(s => s.id === spiritId);
            document.getElementById('nameInput').value = spirit.name;
            document.getElementById('nameModal').classList.add('active');
            
            // ì´ë¦„ ë³€ê²½ ëª¨ë“œë¡œ ì „í™˜
            const confirmBtn = document.querySelector('#nameModal button');
            const originalHandler = confirmBtn.onclick;
            confirmBtn.onclick = function() {
                const newName = document.getElementById('nameInput').value.trim();
                if (!newName) {
                    showNotification('ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”');
                    return;
                }
                spirit.name = newName;
                closeModal('nameModal');
                saveGame();
                updateSpiritCard(spirit);
                showNotification('ì´ë¦„ì„ ë³€ê²½í–ˆìŠµë‹ˆë‹¤');
                
                // ì›ë˜ í•¨ìˆ˜ë¡œ ë³µêµ¬
                confirmBtn.onclick = originalHandler;
            };
        }

        function getStage(growth) {
            if (growth >= STAGE_REQUIREMENTS.adult) return 'adult';
            if (growth >= STAGE_REQUIREMENTS.pupa) return 'pupa';
            if (growth >= STAGE_REQUIREMENTS.larva3) return 'larva3';
            if (growth >= STAGE_REQUIREMENTS.larva2) return 'larva2';
            if (growth >= STAGE_REQUIREMENTS.larva1) return 'larva1';
            return 'egg';
        }

        function getNextStageRequirement(growth) {
            const stage = getStage(growth);
            const stages = Object.keys(STAGE_REQUIREMENTS);
            const currentIndex = stages.indexOf(stage);
            if (currentIndex < stages.length - 1) {
                return STAGE_REQUIREMENTS[stages[currentIndex + 1]];
            }
            return STAGE_REQUIREMENTS.adult;
        }

        function canDoAction(spirit, action) {
            const now = Date.now();
            const cooldown = 10000; // 10ì´ˆ

            if (action === 'feed') {
                return !spirit.lastFed || (now - spirit.lastFed > cooldown);
            }
            if (action === 'music') {
                return !spirit.lastMusic || (now - spirit.lastMusic > cooldown);
            }
            if (action === 'pat') {
                return !spirit.lastPat || (now - spirit.lastPat > cooldown);
            }
            if (action === 'decorate') {
                return !spirit.lastDecorate || (now - spirit.lastDecorate > cooldown);
            }
            return false;
        }

        function openFeedModal(spiritId) {
            const spirit = spirits.find(s => s.id === spiritId);
            if (!canDoAction(spirit, 'feed')) {
                showNotification('ì•„ì§ ë°°ê°€ ë¶€ë¦…ë‹ˆë‹¤');
                return;
            }
            if (!inventory.food) inventory.food = [];
            if (inventory.food.length === 0) {
                showNotification('ë¨¹ì´ê°€ ì—†ìŠµë‹ˆë‹¤. ì±„ì§‘ì„ í•´ë³´ì„¸ìš”!');
                return;
            }
            currentSpiritId = spiritId;
            renderFeedOptions();
            document.getElementById('feedModal').classList.add('active');
        }

        function renderFeedOptions() {
            if (!inventory.food) inventory.food = [];
            
            const modal = document.getElementById('feedModal');
            const foodCounts = {};
            inventory.food.forEach(f => {
                foodCounts[f] = (foodCounts[f] || 0) + 1;
            });

            const content = `
                <div class="modal-title">ë¬´ì—‡ì„ ë¨¹ì¼ê¹Œìš”?</div>
                <div class="food-grid">
                    ${Object.entries(foodCounts).map(([type, count]) => {
                        const isRare = type === 'light' || type === 'dark';
                        const gain = isRare ? 2 : 1;
                        const growth = isRare ? 3 : 2;
                        return `
                            <button class="option-btn" onclick="feedSpiritFromInventory(${currentSpiritId}, '${type}')">
                                <span class="option-icon">${ENV_ICONS[type]}</span>
                                <div class="option-info">
                                    <div class="option-name">${FOOD_NAMES[type]} Ã—${count}</div>
                                    <div class="option-effect">${ENV_ICONS[type]}+${gain} ì„±ì¥+${growth}</div>
                                </div>
                            </button>
                        `;
                    }).join('')}
                </div>
                <button class="close-btn" onclick="closeModal('feedModal')">ë‹«ê¸°</button>
            `;
            modal.querySelector('.modal-content').innerHTML = content;
        }

        function feedSpiritFromInventory(spiritId, foodType) {
            const spirit = spirits.find(s => s.id === spiritId);
            if (!spirit) return;

            if (!inventory.food) inventory.food = [];
            const foodIndex = inventory.food.indexOf(foodType);
            if (foodIndex === -1) {
                showNotification('ë¨¹ì´ê°€ ì—†ìŠµë‹ˆë‹¤');
                return;
            }

            // ë¨¹ì´ ì†Œëª¨
            inventory.food.splice(foodIndex, 1);

            const isRare = foodType === 'light' || foodType === 'dark';
            const attrGain = isRare ? 6 : 3;  // í¬ê·€ +6, ì¼ë°˜ +3
            const growthGain = isRare ? 3 : 2;

            // ì •ë ¹ì˜ ìˆ¨ê²¨ì§„ ì†ì„± ì¦ê°€
            if (!spirit.hiddenAttributes) {
                spirit.hiddenAttributes = {
                    fire: 0, water: 0, wind: 0, earth: 0, light: 0, dark: 0
                };
            }
            spirit.hiddenAttributes[foodType] += attrGain;

            spirit.growth += growthGain;
            spirit.lastFed = Date.now();
            spirit.status = 'ë§›ìˆê²Œ ë¨¹ì—ˆìŠµë‹ˆë‹¤!';
            spirit.parameters.affection += 1;

            // ì¼ì§€ ì¶”ê°€
            addLog(spirit, `${FOOD_NAMES[foodType]}ë¥¼ ë¨¹ì—ˆìŠµë‹ˆë‹¤`);

            // ì„±ì¶© ì²´í¬
            if (spirit.growth >= STAGE_REQUIREMENTS.adult && getStage(spirit.growth - growthGain) !== 'adult') {
                completeSpirit(spirit);
            }

            closeModal('feedModal');
            saveGame();
            updateSpiritCard(spirit);
            renderInventory();
            showNotification(`${ENV_ICONS[foodType]} ${FOOD_NAMES[foodType]}ë¥¼ ì£¼ì—ˆìŠµë‹ˆë‹¤`);
        }

        function openMusicModal(spiritId) {
            const spirit = spirits.find(s => s.id === spiritId);
            if (!canDoAction(spirit, 'music')) {
                showNotification('ì•„ì§ ìŒì•…ì„ ë“£ê³  ìˆìŠµë‹ˆë‹¤');
                return;
            }
            if (inventory.music.length === 0) {
                showNotification('ë³´ìœ í•œ ìŒì•…ì´ ì—†ìŠµë‹ˆë‹¤. ì±„ì§‘ì„ í•´ë³´ì„¸ìš”!');
                return;
            }
            currentSpiritId = spiritId;
            renderMusicOptions();
            document.getElementById('musicModal').classList.add('active');
        }

        function renderMusicOptions() {
            const container = document.getElementById('musicOptions');
            container.innerHTML = '<div class="music-grid">' + 
                inventory.music.map((music, index) => {
                    const musicData = MUSIC_TYPES[music];
                    return `
                        <button class="option-btn" onclick="playMusic(${currentSpiritId}, '${music}', ${index})">
                            <span class="option-icon">${musicData.icon}</span>
                            <div class="option-info">
                                <div class="option-name">${musicData.name}</div>
                                <div class="option-effect">${musicData.effect}</div>
                            </div>
                        </button>
                    `;
                }).join('') + '</div>';
        }

        function playMusic(spiritId, musicType, inventoryIndex) {
            const spirit = spirits.find(s => s.id === spiritId);
            if (!spirit) return;

            const musicData = MUSIC_TYPES[musicType];
            
            // íš¨ê³¼ ì ìš©
            if (musicType === 'quest') {
                spirit.parameters.strength += 3;
                spirit.parameters.intelligence += 1;
            } else if (musicType === 'lullaby') {
                spirit.parameters.charm += 2;
                spirit.parameters.intelligence += 1;
            } else if (musicType === 'march') {
                spirit.parameters.strength += 3;
                spirit.parameters.intelligence += 1;
            } else if (musicType === 'ballad') {
                spirit.parameters.charm += 3;
                spirit.parameters.strength += 1;
            } else if (musicType === 'classical') {
                spirit.parameters.intelligence += 3;
                spirit.parameters.charm += 1;
            } else if (musicType === 'dance') {
                spirit.parameters.strength += 2;
                spirit.parameters.charm += 2;
            }

            // ì• ì •ë„ ì¦ê°€ (ìƒí˜¸ì‘ìš©)
            spirit.parameters.affection += 2;

            spirit.lastMusic = Date.now();
            spirit.status = `${musicData.name}ì„(ë¥¼) ë“£ê³  ìˆìŠµë‹ˆë‹¤...`;

            // ì¼ì§€ ì¶”ê°€
            addLog(spirit, `${musicData.name}ì„(ë¥¼) ë“¤ì—ˆìŠµë‹ˆë‹¤`);

            // ìŒì•… ì†Œëª¨
            inventory.music.splice(inventoryIndex, 1);

            closeModal('musicModal');
            saveGame();
            updateSpiritCard(spirit);
            renderInventory();
            showNotification(`ğŸµ ${musicData.name}ì„(ë¥¼) ë“¤ë ¤ì£¼ì—ˆìŠµë‹ˆë‹¤`);
        }

        function patSpirit(spiritId) {
            const spirit = spirits.find(s => s.id === spiritId);
            if (!spirit) return;

            if (!canDoAction(spirit, 'pat')) {
                showNotification('ì•„ì§ ì“°ë‹¤ë“¬ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
                return;
            }

            spirit.parameters.affection += 1;
            spirit.lastPat = Date.now();
            
            const messages = [
                'ì •ë ¹ì´ ê¸°ë»í•©ë‹ˆë‹¤! ğŸ’•',
                'ì •ë ¹ì´ ë‹¹ì‹ ì„ ë”°ë¦…ë‹ˆë‹¤ â¤ï¸',
                'ì •ë ¹ì´ í–‰ë³µí•´ ë³´ì…ë‹ˆë‹¤ âœ¨',
                'ì •ë ¹ì´ í¸ì•ˆí•´ ë³´ì…ë‹ˆë‹¤ ğŸ’–',
                'ì •ë ¹ì´ ë‹¹ì‹ ì„ ì¢‹ì•„í•©ë‹ˆë‹¤ ğŸ¥°'
            ];
            spirit.status = messages[Math.floor(Math.random() * messages.length)];

            // ì¼ì§€ ì¶”ê°€
            addLog(spirit, 'ì“°ë‹¤ë“¬ì—ˆìŠµë‹ˆë‹¤');

            saveGame();
            updateSpiritCard(spirit);
            showNotification('ì“°ë‹¤ë“¬ì—ˆìŠµë‹ˆë‹¤ (ì• ì • +1)');
        }

        function changeTitle() {
            const select = document.getElementById('titleSelect');
            currentTitle = select.value;
            
            const titleNames = {
                'none': 'ì—†ìŒ',
                'hawk_eye': 'ğŸ¦… ë§¤ì˜ ëˆˆ',
                'gatherer': 'ğŸ ì±„ì§‘ê¾¼',
                'musician': 'ğŸµ ìŒì•…ê°€',
                'collector': 'ğŸ’ ìˆ˜ì§‘ê°€'
            };
            
            showNotification(`ì¹­í˜¸ë¥¼ ${titleNames[currentTitle]}(ìœ¼)ë¡œ ë³€ê²½í–ˆìŠµë‹ˆë‹¤`);
            saveGame();
        }

        function goGather() {
            const now = Date.now();
            const gatherCooldown = 15000; // 15ì´ˆ

            // ì¿¨ë‹¤ìš´ ì²´í¬
            if (lastGatherTime && (now - lastGatherTime < gatherCooldown)) {
                const remainingTime = Math.ceil((gatherCooldown - (now - lastGatherTime)) / 1000);
                showNotification(`${remainingTime}ì´ˆ í›„ì— ë‹¤ì‹œ ì±„ì§‘í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤`);
                return;
            }

            if (!inventory.food) inventory.food = [];
            if (!inventory.music) inventory.music = [];
            if (!inventory.decorations) inventory.decorations = [];

            const discoveries = [];
            
            // ì¹­í˜¸ë³„ í™•ë¥  ë³´ë„ˆìŠ¤
            const titleBonus = {
                hawk_eye: 1.5,    // ë§¤ì˜ ëˆˆ: ëª¨ë“  í™•ë¥  1.5ë°°
                gatherer: 1.0,    // ì±„ì§‘ê¾¼: ë¨¹ì´ë§Œ 2ë°° (ì•„ë˜ì„œ ë”°ë¡œ ì²˜ë¦¬)
                musician: 1.0,    // ìŒì•…ê°€: ë ˆì½”ë“œë§Œ 2ë°° (ì•„ë˜ì„œ ë”°ë¡œ ì²˜ë¦¬)
                collector: 1.0    // ìˆ˜ì§‘ê°€: í…Œë¼ë¦¬ì›€ë§Œ 2ë°° (ì•„ë˜ì„œ ë”°ë¡œ ì²˜ë¦¬)
            };
            
            const baseBonus = currentTitle !== 'none' && titleBonus[currentTitle] ? titleBonus[currentTitle] : 1.0;
            
            // 60% í™•ë¥ ë¡œ ì¼ë°˜ ë¨¹ì´ ë°œê²¬ (í™”ìˆ˜í’ì§€)
            const foodBonus = currentTitle === 'gatherer' ? 2.0 : baseBonus;
            if (Math.random() < (0.6 * foodBonus)) {
                const foodTypes = ['fire', 'water', 'wind', 'earth'];
                const randomFood = foodTypes[Math.floor(Math.random() * foodTypes.length)];
                inventory.food.push(randomFood);
                discoveries.push(`ğŸ ${FOOD_NAMES[randomFood]}`);
            }

            // 30% í™•ë¥ ë¡œ í¬ê·€ ë¨¹ì´ ë°œê²¬ (ë¹›ì•”)
            if (Math.random() < (0.3 * foodBonus)) {
                const rareFoodTypes = ['light', 'dark'];
                const randomRareFood = rareFoodTypes[Math.floor(Math.random() * rareFoodTypes.length)];
                inventory.food.push(randomRareFood);
                discoveries.push(`âœ¨ ${FOOD_NAMES[randomRareFood]}`);
            }

            // 40% í™•ë¥ ë¡œ ì¼ë°˜ ì¥ì‹ë¬¼ ë°œê²¬ (í™”ìˆ˜í’ì§€)
            const decoBonus = currentTitle === 'collector' ? 2.0 : baseBonus;
            if (Math.random() < (0.4 * decoBonus)) {
                const decoTypes = ['fire', 'water', 'wind', 'earth'];
                const randomDeco = decoTypes[Math.floor(Math.random() * decoTypes.length)];
                inventory.decorations.push(randomDeco);
                discoveries.push(`${DECORATION_TYPES[randomDeco].icon} ${DECORATION_TYPES[randomDeco].name}`);
            }

            // 20% í™•ë¥ ë¡œ í¬ê·€ ì¥ì‹ë¬¼ ë°œê²¬ (ë¹›ì•”)
            if (Math.random() < (0.2 * decoBonus)) {
                const rareDecoTypes = ['light', 'dark'];
                const randomRareDeco = rareDecoTypes[Math.floor(Math.random() * rareDecoTypes.length)];
                inventory.decorations.push(randomRareDeco);
                discoveries.push(`${DECORATION_TYPES[randomRareDeco].icon} ${DECORATION_TYPES[randomRareDeco].name}`);
            }

            // 15% í™•ë¥ ë¡œ ìŒì•… ë ˆì½”ë“œ ë°œê²¬
            const musicBonus = currentTitle === 'musician' ? 2.0 : baseBonus;
            if (Math.random() < (0.15 * musicBonus)) {
                const musicKeys = Object.keys(MUSIC_TYPES);
                const randomMusic = musicKeys[Math.floor(Math.random() * musicKeys.length)];
                inventory.music.push(randomMusic);
                discoveries.push(`ğŸµ ${MUSIC_TYPES[randomMusic].name}`);
            }

            if (discoveries.length === 0) {
                showNotification('ì•„ë¬´ê²ƒë„ ë°œê²¬í•˜ì§€ ëª»í–ˆìŠµë‹ˆë‹¤...');
            } else {
                showNotification(`ì±„ì§‘: ${discoveries.join(', ')}`);
            }

            lastGatherTime = now;
            saveGame();
            renderInventory();
            updateGatherButton();
        }

        function updateGatherButton() {
            const gatherBtn = document.querySelector('.walk-btn');
            if (!gatherBtn) return;

            const now = Date.now();
            const gatherCooldown = 15000; // 15ì´ˆ

            if (lastGatherTime && (now - lastGatherTime < gatherCooldown)) {
                gatherBtn.disabled = true;
                const remainingTime = Math.ceil((gatherCooldown - (now - lastGatherTime)) / 1000);
                gatherBtn.textContent = `ğŸŒ¿ ì±„ì§‘í•˜ê¸° (${remainingTime}ì´ˆ)`;
            } else {
                gatherBtn.disabled = false;
                gatherBtn.textContent = 'ğŸŒ¿ ì±„ì§‘í•˜ê¸°';
            }
        }

        function confirmDeleteSpirit(spiritId) {
            const spirit = spirits.find(s => s.id === spiritId);
            if (!spirit) return;

            if (confirm(`ì •ë§ë¡œ ${spirit.name}ì„(ë¥¼) ë³´ë‚´ì‹œê² ìŠµë‹ˆê¹Œ?\n\nì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`)) {
                deleteSpirit(spiritId);
            }
        }

        function deleteSpirit(spiritId) {
            spirits = spirits.filter(s => s.id !== spiritId);
            saveGame();
            renderSpirits();
            showNotification('ì •ë ¹ì„ ë– ë‚˜ë³´ëƒˆìŠµë‹ˆë‹¤');
        }

        function renderInventory() {
            // ë¨¹ì´ê°€ ì—†ìœ¼ë©´ ì´ˆê¸°í™”
            if (!inventory.food) {
                inventory.food = [];
            }

            // ë¨¹ì´ ì¸ë²¤í† ë¦¬
            const foodContainer = document.getElementById('foodInventory');
            if (inventory.food.length === 0) {
                foodContainer.innerHTML = '<div class="inventory-item">ì—†ìŒ</div>';
            } else {
                const foodCounts = {};
                inventory.food.forEach(f => {
                    foodCounts[f] = (foodCounts[f] || 0) + 1;
                });
                foodContainer.innerHTML = Object.entries(foodCounts)
                    .map(([type, count]) => `
                        <div class="inventory-item">
                            ${ENV_ICONS[type]} Ã—${count}
                        </div>
                    `).join('');
            }

            // ìŒì•… ì¸ë²¤í† ë¦¬
            const musicContainer = document.getElementById('musicInventory');
            if (!inventory.music) inventory.music = [];
            if (inventory.music.length === 0) {
                musicContainer.innerHTML = '<div class="inventory-item">ì—†ìŒ</div>';
            } else {
                const musicCounts = {};
                inventory.music.forEach(m => {
                    musicCounts[m] = (musicCounts[m] || 0) + 1;
                });
                musicContainer.innerHTML = Object.entries(musicCounts)
                    .map(([type, count]) => `
                        <div class="inventory-item">
                            ${MUSIC_TYPES[type].icon} Ã—${count}
                        </div>
                    `).join('');
            }

            // ì¥ì‹ë¬¼ ì¸ë²¤í† ë¦¬
            const decorContainer = document.getElementById('decorInventory');
            if (!inventory.decorations) inventory.decorations = [];
            if (inventory.decorations.length === 0) {
                decorContainer.innerHTML = '<div class="inventory-item">ì—†ìŒ</div>';
            } else {
                const decorCounts = {};
                inventory.decorations.forEach(d => {
                    decorCounts[d] = (decorCounts[d] || 0) + 1;
                });
                decorContainer.innerHTML = Object.entries(decorCounts)
                    .map(([type, count]) => `
                        <div class="inventory-item">
                            ${DECORATION_TYPES[type].icon} Ã—${count}
                        </div>
                    `).join('');
            }
        }

        function completeSpirit(spirit) {
            // ìŠ¤íƒ¯ìœ¼ë¡œ ì§„í™” ê²°ì •
            const params = spirit.parameters;
            const maxStat = Math.max(params.intelligence, params.strength, params.charm);
            
            // ë…¸ë©€ ì§„í™” (ëª¨ë“  ìŠ¤íƒ¯ì´ 10 ë¯¸ë§Œ)
            if (maxStat < 10) {
                const evolution = EVOLUTION_TYPES['normal'];
                spirit.isCompleted = true;
                spirit.evolutionData = {
                    type: 'normal',
                    name: evolution.name,
                    icon: evolution.icon,
                    desc: evolution.desc,
                    wingType: null
                };
                saveGame();
                renderSpirits();
                showNotification('ğŸ‰ ì •ë ¹ì´ ì„±ì¥ì„ ì™„ë£Œí–ˆìŠµë‹ˆë‹¤! ìœ¡ì„± íƒ­ì—ì„œ í™•ì¸í•´ì£¼ì„¸ìš”.');
                return;
            }

            // ìµœê³  ìŠ¤íƒ¯ ê²°ì •
            let statType = '';
            if (params.intelligence >= params.strength && params.intelligence >= params.charm) {
                statType = 'intelligent';
            } else if (params.strength >= params.intelligence && params.strength >= params.charm) {
                statType = 'strong';
            } else {
                statType = 'beautiful';
            }

            // ì§„í™” ë‹¨ê³„ ê²°ì •
            let evolutionKey = '';
            if (maxStat >= 30) {
                evolutionKey = `${statType}-master`;  // 30+ : ëˆˆë¶€ì‹ 
            } else if (maxStat >= 20) {
                evolutionKey = `${statType}-advanced`;  // 20-29 : ì°¬ë€í•œ
            } else {
                evolutionKey = `${statType}-basic`;  // 10-19 : ë°˜ì§ì´ëŠ”
            }

            const evolution = EVOLUTION_TYPES[evolutionKey];
            
            // ì§„í™” íƒ€ì…ì´ ì—†ìœ¼ë©´ ê¸°ë³¸ê°’ ì‚¬ìš©
            if (!evolution) {
                console.error(`Evolution type not found: ${evolutionKey}`);
                evolutionKey = 'normal';
                const fallbackEvolution = EVOLUTION_TYPES['normal'];
                spirit.isCompleted = true;
                spirit.evolutionData = {
                    type: 'normal',
                    name: fallbackEvolution.name,
                    icon: fallbackEvolution.icon,
                    desc: fallbackEvolution.desc,
                    wingType: null
                };
                saveGame();
                renderSpirits();
                showNotification('ğŸ‰ ì •ë ¹ì´ ì„±ì¥ì„ ì™„ë£Œí–ˆìŠµë‹ˆë‹¤! ìœ¡ì„± íƒ­ì—ì„œ í™•ì¸í•´ì£¼ì„¸ìš”.');
                return;
            }
            
            // ì†ì„± ë¶„ì„ (ìˆ¨ê²¨ì§„ ì†ì„± ê¸°ë°˜)
            const attrs = spirit.hiddenAttributes || { fire: 0, water: 0, wind: 0, earth: 0, light: 0, dark: 0 };
            const sortedAttrs = Object.entries(attrs)
                .filter(([_, value]) => value > 10) // 10 ì´ìƒì¸ ì†ì„±ë§Œ
                .sort((a, b) => b[1] - a[1]); // ë‚´ë¦¼ì°¨ìˆœ ì •ë ¬
            
            let attributeKey = '';
            let attributeData = null;
            
            if (sortedAttrs.length === 0) {
                // ì†ì„± ì—†ìŒ - ë°±ì˜ ì •ë ¹
                attributeKey = 'normal';
                attributeData = { name: 'ë°±ì˜ ì •ë ¹', icon: 'ğŸ¤', desc: 'ì†ì„±ì´ ê¹ƒë“¤ì§€ ì•Šì€ ìˆœìˆ˜í•œ ì •ë ¹.' };
            } else if (sortedAttrs.length === 1) {
                // ë‹¨ì¼ ì†ì„±
                attributeKey = sortedAttrs[0][0];
                attributeData = ATTRIBUTE_NAMES[attributeKey];
            } else if (sortedAttrs.length === 2) {
                // 2ì†ì„± ì¡°í•©
                const attr1 = sortedAttrs[0][0];
                const attr2 = sortedAttrs[1][0];
                const comboKey = [attr1, attr2].sort().join('-');
                attributeData = ATTRIBUTE_NAMES[comboKey];
                attributeKey = comboKey;
            } else if (sortedAttrs.length >= 3) {
                // 3ì†ì„± ì´ìƒ
                const topValues = sortedAttrs.slice(0, 3).map(a => a[1]);
                const isBalanced = Math.max(...topValues) - Math.min(...topValues) <= 10;
                
                if (isBalanced) {
                    attributeKey = 'balanced';
                    attributeData = ATTRIBUTE_NAMES['balanced'];
                } else {
                    attributeKey = 'multi';
                    attributeData = ATTRIBUTE_NAMES['multi'];
                }
            }
            
            // ìµœì¢… ì´ë¦„ê³¼ ì•„ì´ì½˜ ì¡°í•©
            let finalName = '';
            let finalIcon = '';
            let finalDesc = '';
            
            if (attributeKey === 'normal') {
                finalName = attributeData.name;
                finalIcon = attributeData.icon;
                finalDesc = attributeData.desc;
            } else {
                // "ìŠ¤íƒ¯ ê³„ì—´ + ì†ì„± ì´ë¦„" í˜•íƒœ
                finalName = `${evolution.prefix} ${attributeData.name}`;
                finalIcon = `${evolution.icon}${attributeData.icon}`;
                finalDesc = attributeData.desc;
            }
            
            // ë‚ ê°œ íƒ€ì… ê²°ì • (ì¡°ëª… ëˆ„ì  ì‹œê°„ ê¸°ë°˜)
            if (!spirit.lightTime) spirit.lightTime = 0;
            if (!spirit.darkTime) spirit.darkTime = 0;
            
            let wingType = null;
            if (spirit.lightTime > spirit.darkTime) {
                wingType = 'butterfly';
            } else if (spirit.darkTime > spirit.lightTime) {
                wingType = 'moth';
            } else {
                wingType = 'butterfly'; // ë™ì ì´ë©´ ë‚˜ë¹„
            }
            
            // ì •ë ¹ì„ ì™„ì„± ìƒíƒœë¡œ í‘œì‹œ (ì•„ì§ ì œê±°í•˜ì§€ ì•ŠìŒ)
            spirit.isCompleted = true;
            spirit.evolutionData = {
                type: evolutionKey,
                attributeType: attributeKey,
                name: finalName,
                icon: finalIcon,
                desc: finalDesc,
                wingType: wingType
            };
            
            saveGame();
            renderSpirits();
            showNotification('ğŸ‰ ì •ë ¹ì´ ì„±ì¥ì„ ì™„ë£Œí–ˆìŠµë‹ˆë‹¤! ìœ¡ì„± íƒ­ì—ì„œ í™•ì¸í•´ì£¼ì„¸ìš”.');
        }
        
        function confirmEvolution(spiritId) {
            const spirit = spirits.find(s => s.id === spiritId);
            if (!spirit || !spirit.isCompleted) return;
            
            const evolutionData = spirit.evolutionData;
            const affection = spirit.parameters.affection || 0;
            
            // ì• ì •ë„ë³„ ì—”ë”© ë©”ì‹œì§€
            let endingMessage = '';
            
            if (affection >= 150) {
                endingMessage = `${spirit.name}ì€(ëŠ”) ë‹¹ì‹ ì—ê²Œ "ã…ã…ã…ã…"ë¼ëŠ” ë§ì„ ë‚¨ê¸°ê³  ë– ë‚©ë‹ˆë‹¤.\n\nì •ë ¹ì–´ ì‚¬ì „ì„ ì°¾ì•„ë³´ë©´ ê·¸ ë§ì€ "ì‚¬ë‘í•´ìš”"ë¼ëŠ” ì˜ë¯¸ì…ë‹ˆë‹¤.`;
            } else if (affection >= 100) {
                endingMessage = `${spirit.name}ì€(ëŠ”) ë‹¹ì‹ ì˜ ëº¨ì— ì…ë§ì¶¤ì„ ë‚¨ê¸°ê³  ë– ë‚©ë‹ˆë‹¤.`;
            } else if (affection >= 50) {
                endingMessage = `${spirit.name}ì€(ëŠ”) ë‹¹ì‹ ì—ê²Œ ê°ì‚¬ì˜ ì¸ì‚¬ë¥¼ ë‚¨ê¸°ê³  ë– ë‚©ë‹ˆë‹¤.`;
            } else {
                endingMessage = `${spirit.name}ì´(ê°€) ë– ë‚˜ê°‘ë‹ˆë‹¤.`;
            }
            
            if (confirm(endingMessage)) {
                // ì•¨ë²”ì— ì¶”ê°€
                collection.push({
                    type: evolutionData.type,
                    attributeType: evolutionData.attributeType,
                    name: evolutionData.name,
                    icon: evolutionData.icon,
                    desc: evolutionData.desc,
                    parameters: { ...spirit.parameters },
                    originalName: spirit.name,
                    wingType: evolutionData.wingType,
                    lightTime: spirit.lightTime,
                    darkTime: spirit.darkTime,
                    completedAt: Date.now()
                });
                
                // ë„ê°ì— ë“±ë¡ (ì§„í™” íƒ€ì…ë³„ ì¹´ìš´íŠ¸)
                const encyclopediaKey = `${evolutionData.type}-${evolutionData.attributeType || 'normal'}`;
                if (!encyclopedia[encyclopediaKey]) {
                    encyclopedia[encyclopediaKey] = 0;
                }
                encyclopedia[encyclopediaKey]++;
                
                // ì •ë ¹ ì œê±°
                spirits = spirits.filter(s => s.id !== spiritId);
                saveGame();
                renderSpirits();
                showNotification(`${evolutionData.icon} ${spirit.name}ì´(ê°€) ${evolutionData.name}(ìœ¼)ë¡œ ì•¨ë²”ì— ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤`);
            }
        }

        function applyGrowth() {
            spirits.forEach(spirit => {
                if (spirit.isDead || spirit.isCompleted) return;

                // ì„±ì¥ë„ +1
                const previousGrowth = spirit.growth;
                spirit.growth += 1;

                // ì„±ì¶© ì²´í¬
                if (spirit.growth >= STAGE_REQUIREMENTS.adult && getStage(previousGrowth) !== 'adult') {
                    completeSpirit(spirit);
                }
            });

            saveGame();
            updateAllSpiritCards();
        }

        function applyTerrariumGrowth() {
            spirits.forEach(spirit => {
                if (spirit.isDead || spirit.isCompleted) return;  // ì£½ì—ˆê±°ë‚˜ ì™„ì„±ëœ ì •ë ¹ ì œì™¸

                // ì¡°ëª… ëˆ„ì  ì‹œê°„ ì¶”ê°€ (300ì´ˆ = 5ë¶„)
                if (!spirit.lightTime) spirit.lightTime = 0;
                if (!spirit.darkTime) spirit.darkTime = 0;
                
                if (lightMode) {
                    spirit.lightTime += 300;
                } else {
                    spirit.darkTime += 300;
                }

                // ì •ë ¹ì˜ ìˆ¨ê²¨ì§„ ì†ì„±ì— í…Œë¼ë¦¬ì›€ í™˜ê²½ê°’ ì¶”ê°€
                if (!spirit.hiddenAttributes) {
                    spirit.hiddenAttributes = {
                        fire: 0, water: 0, wind: 0, earth: 0, light: 0, dark: 0
                    };
                }

                // í…Œë¼ë¦¬ì›€ì˜ ê° ì†ì„±ê°’ë§Œí¼ ì •ë ¹ì˜ ì†ì„± ì¦ê°€ (ìµœëŒ€ 100ê¹Œì§€ë§Œ)
                Object.keys(terrarium).forEach(attr => {
                    if (terrarium[attr] > 0) {
                        spirit.hiddenAttributes[attr] = Math.min(
                            spirit.hiddenAttributes[attr] + terrarium[attr],
                            100  // ì†ì„± ìµœëŒ€ì¹˜
                        );
                    }
                });
            });

            saveGame();
            updateAllSpiritCards();
        }

        function checkSpiritStatus() {
            const now = Date.now();
            spirits.forEach(spirit => {
                if (!spirit.lastFed) {
                    spirit.lastFed = spirit.birthTime;
                }

                const timeSinceLastFed = now - spirit.lastFed;
                const minutes = timeSinceLastFed / 1000 / 60;
                const hours = minutes / 60;

                // 10ë¶„ ê²½ê³¼ - ë°°ê³ í””
                if (minutes >= 10 && minutes < 24 * 60) {
                    if (getStage(spirit.growth) === 'egg') {
                        spirit.status = 'ì•Œì´ í”ë“¤ë¦¬ê³  ìˆìŠµë‹ˆë‹¤... ë°°ê³ í”ˆ ê²ƒ ê°™ì•„ìš”';
                    } else {
                        spirit.status = 'ë°°ê³ íŒŒí•˜ëŠ” ê²ƒ ê°™ìŠµë‹ˆë‹¤...';
                    }
                }

                // 24ì‹œê°„ ê²½ê³¼ - ì‚¬ë§
                if (hours >= 24) {
                    if (getStage(spirit.growth) === 'egg') {
                        spirit.status = 'âŒ ì•Œì´ ê¹¨ì ¸ì„œ ë¯¸ë™ì´ ì—†ìŠµë‹ˆë‹¤...';
                        spirit.isDead = true;
                    } else {
                        spirit.status = 'âŒ í…Œë¼ë¦¬ì›€ ë°–ìœ¼ë¡œ ë‚˜ê°€ ì‚¬ë¼ì¡ŒìŠµë‹ˆë‹¤...';
                        spirit.isDead = true;
                    }
                }
            });
        }

        function updateAllSpiritCards() {
            spirits.forEach(spirit => {
                updateSpiritCard(spirit);
            });
        }

        function updateSpiritCard(spirit) {
            const cards = document.querySelectorAll('.spirit-card');
            const index = spirits.findIndex(s => s.id === spirit.id);
            if (index === -1 || !cards[index]) return;

            const card = cards[index];
            const stage = getStage(spirit.growth);
            const nextReq = getNextStageRequirement(spirit.growth);
            const progress = (spirit.growth / nextReq) * 100;
            
            const canFeed = canDoAction(spirit, 'feed') && !spirit.isDead;
            const canMusic = canDoAction(spirit, 'music') && !spirit.isDead;
            const canPat = canDoAction(spirit, 'pat') && !spirit.isDead;

            let icon = STAGE_ICONS[stage];
            if (stage === 'adult' && spirit.evolutionType) {
                const evolutionData = EVOLUTION_TYPES[spirit.evolutionType];
                if (evolutionData) {
                    icon = evolutionData.icon;
                }
            }
            if (spirit.isDead) {
                icon = stage === 'egg' ? 'ğŸ’”' : 'ğŸ‘»';
            }

            // ì•„ì´ì½˜ ì—…ë°ì´íŠ¸
            const iconElement = card.querySelector('.spirit-icon');
            if (iconElement && iconElement.textContent !== icon) {
                iconElement.textContent = icon;
            }

            // ìŠ¤í…Œì´ì§€ ì—…ë°ì´íŠ¸
            const stageElement = card.querySelector('.spirit-stage');
            if (stageElement) {
                stageElement.textContent = STAGE_NAMES[stage];
            }

            // ì§„í–‰ë„ ì—…ë°ì´íŠ¸
            const progressFill = card.querySelector('.progress-fill');
            if (progressFill) {
                progressFill.style.width = `${Math.min(progress, 100)}%`;
            }

            const progressText = card.querySelector('.progress-text');
            if (progressText) {
                progressText.textContent = `ì„±ì¥ ${spirit.growth} / ${nextReq}`;
            }

            // íŒŒë¼ë¯¸í„° ì—…ë°ì´íŠ¸
            const params = card.querySelectorAll('.param');
            if (params.length >= 4) {
                params[0].innerHTML = `<span class="param-icon">ğŸ§ </span>ì§€ë ¥ ${spirit.parameters.intelligence}`;
                params[1].innerHTML = `<span class="param-icon">ğŸ’ª</span>ì²´ë ¥ ${spirit.parameters.strength}`;
                params[2].innerHTML = `<span class="param-icon">ğŸ’–</span>ë§¤ë ¥ ${spirit.parameters.charm}`;
                params[3].innerHTML = `<span class="param-icon">â¤ï¸</span>ì• ì • ${spirit.parameters.affection}`;
            }

            // ìƒíƒœ ë©”ì‹œì§€ ì—…ë°ì´íŠ¸
            const statusElement = card.querySelector('.spirit-status');
            if (statusElement) {
                statusElement.textContent = spirit.status;
            }

            // ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
            const actionButtons = card.querySelector('.action-buttons');
            if (actionButtons) {
                const buttons = actionButtons.querySelectorAll('button');
                if (buttons.length >= 4) {
                    buttons[0].disabled = !canFeed;
                    buttons[1].disabled = !canMusic;
                    buttons[2].disabled = !canPat;
                    // buttons[3]ëŠ” ë³´ë‚´ê¸° ë²„íŠ¼ì´ë¯€ë¡œ í•­ìƒ í™œì„±í™”
                }
            }
        }

        function toggleLogs(spiritId) {
            const logsDiv = document.getElementById(`logs${spiritId}`);
            const toggleIcon = document.getElementById(`logToggle${spiritId}`);
            
            if (logsDiv.style.display === 'none') {
                logsDiv.style.display = 'block';
                toggleIcon.textContent = 'â–²';
            } else {
                logsDiv.style.display = 'none';
                toggleIcon.textContent = 'â–¼';
            }
        }

        function renderSpirits() {
            const grid = document.getElementById('spiritsGrid');
            
            if (spirits.length === 0) {
                grid.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">ğŸ¥š</div>
                        <div>ì•„ì§ ì •ë ¹ì´ ì—†ìŠµë‹ˆë‹¤<br>ìƒˆë¡œìš´ ì•Œì„ ë°›ì•„ë³´ì„¸ìš”</div>
                    </div>
                `;
                return;
            }

            grid.innerHTML = spirits.map(spirit => {
                const stage = getStage(spirit.growth);
                const nextReq = getNextStageRequirement(spirit.growth);
                const progress = (spirit.growth / nextReq) * 100;
                
                const canFeed = canDoAction(spirit, 'feed') && !spirit.isDead;
                const canMusic = canDoAction(spirit, 'music') && !spirit.isDead;
                const canPat = canDoAction(spirit, 'pat') && !spirit.isDead;

                let icon = STAGE_ICONS[stage];
                if (stage === 'adult' && spirit.evolutionType) {
                    const evolutionData = EVOLUTION_TYPES[spirit.evolutionType];
                    if (evolutionData) {
                        icon = evolutionData.icon;
                    }
                }
                if (spirit.isDead) {
                    icon = stage === 'egg' ? 'ğŸ’”' : 'ğŸ‘»';
                }

                // í•˜ìœ„ í˜¸í™˜ì„±ì„ ìœ„í•œ íŒŒë¼ë¯¸í„° ì²´í¬
                if (!spirit.parameters.affection && spirit.parameters.mystery !== undefined) {
                    spirit.parameters.affection = spirit.parameters.mystery;
                    delete spirit.parameters.mystery;
                }
                if (!spirit.hiddenAttributes) {
                    spirit.hiddenAttributes = {
                        fire: 0, water: 0, wind: 0, earth: 0, light: 0, dark: 0
                    };
                }
                if (!spirit.logs) {
                    spirit.logs = [];
                }
                if (!spirit.lightTime) {
                    spirit.lightTime = 0;
                }
                if (!spirit.darkTime) {
                    spirit.darkTime = 0;
                }
                
                // ì™„ì„±ëœ ì •ë ¹ì¸ ê²½ìš° íŠ¹ë³„í•œ ì¹´ë“œ í‘œì‹œ
                if (spirit.isCompleted && spirit.evolutionData) {
                    return `
                        <div class="spirit-card" style="background: linear-gradient(135deg, #ffd700 0%, #ffed4e 100%); border: 3px solid #ffa500;">
                            <div style="text-align: center; padding: 20px;">
                                <div style="font-size: 4rem; margin-bottom: 15px;">${spirit.evolutionData.icon}</div>
                                <div style="font-size: 1.3rem; font-weight: 700; color: #333; margin-bottom: 10px;">
                                    ğŸ‰ ë²ˆë°ê¸°ì—ì„œ ì •ë ¹ì´ ë¶€í™”í–ˆìŠµë‹ˆë‹¤! ğŸ‰
                                </div>
                                <div style="font-size: 1rem; color: #555; margin-bottom: 8px;">
                                    ${spirit.name} â†’ ${spirit.evolutionData.name}
                                </div>
                                <div style="font-size: 0.9rem; color: #666; margin-bottom: 20px;">
                                    ì• ì •ë„: ${spirit.parameters.affection || 0}
                                </div>
                                <button onclick="confirmEvolution(${spirit.id})" style="
                                    background: #ff6b6b;
                                    color: white;
                                    border: none;
                                    padding: 15px 30px;
                                    font-size: 1.1rem;
                                    font-weight: 700;
                                    border-radius: 8px;
                                    cursor: pointer;
                                    box-shadow: 0 4px 8px rgba(0,0,0,0.2);
                                ">
                                    âœ¨ í™•ì¸í•˜ê¸° âœ¨
                                </button>
                            </div>
                        </div>
                    `;
                }

                return `
                    <div class="spirit-card">
                        <div class="spirit-header">
                            <div class="spirit-icon">${icon}</div>
                            <div class="spirit-info">
                                <div class="spirit-name" onclick="changeName(${spirit.id})">${spirit.name}</div>
                                <div class="spirit-stage">${STAGE_NAMES[stage]}</div>
                            </div>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${Math.min(progress, 100)}%"></div>
                        </div>
                        <div class="progress-text">ì„±ì¥ ${spirit.growth} / ${nextReq}</div>
                        <div class="parameters">
                            <div class="param"><span class="param-icon">ğŸ§ </span>ì§€ë ¥ ${spirit.parameters.intelligence}</div>
                            <div class="param"><span class="param-icon">ğŸ’ª</span>ì²´ë ¥ ${spirit.parameters.strength}</div>
                            <div class="param"><span class="param-icon">ğŸ’–</span>ë§¤ë ¥ ${spirit.parameters.charm}</div>
                            <div class="param"><span class="param-icon">â¤ï¸</span>ì• ì • ${spirit.parameters.affection}</div>
                        </div>
                        <div class="spirit-status">${spirit.status}</div>
                        ${spirit.logs && spirit.logs.length > 0 ? `
                            <div style="margin-top: 12px; border-top: 1px solid var(--border); padding-top: 12px;">
                                <div style="display: flex; justify-content: space-between; align-items: center; cursor: pointer;" onclick="toggleLogs(${spirit.id})">
                                    <span style="font-size: 0.9rem; font-weight: 600;">ğŸ“ ì¼ì§€ (${spirit.logs.length}ê°œ)</span>
                                    <span id="logToggle${spirit.id}" style="font-size: 0.8rem;">â–¼</span>
                                </div>
                                <div id="logs${spirit.id}" style="display: none; margin-top: 8px; max-height: 200px; overflow-y: auto;">
                                    ${spirit.logs.map(log => `
                                        <div style="font-size: 0.85rem; color: #888; padding: 4px 0; border-bottom: 1px solid var(--border);">
                                            <span style="color: #666;">${log.time}</span> - ${log.message}
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        ` : ''}
                        <div class="action-buttons">
                            <button onclick="openFeedModal(${spirit.id})" ${!canFeed ? 'disabled' : ''}>
                                ë¨¹ì´ì£¼ê¸°
                            </button>
                            <button onclick="openMusicModal(${spirit.id})" ${!canMusic ? 'disabled' : ''}>
                                ìŒì•… ë“£ê¸°
                            </button>
                            <button onclick="patSpirit(${spirit.id})" ${!canPat ? 'disabled' : ''}>
                                ì“°ë‹¤ë“¬ê¸°
                            </button>
                            <button onclick="confirmDeleteSpirit(${spirit.id})">
                                ë³´ë‚´ê¸°
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function updateCoinDisplay() {
            const displays = document.querySelectorAll('#coinDisplay, #shopCoinDisplay');
            displays.forEach(el => {
                if (el) el.textContent = coins;
            });
        }

        function renderShop() {
            updateCoinDisplay();
            renderSellList();
            renderBuyList();
        }

        function renderSellList() {
            const container = document.getElementById('sellList');
            if (!container) return;

            const items = [];

            // ë¨¹ì´ íŒë§¤
            if (inventory.food && inventory.food.length > 0) {
                const foodCounts = {};
                inventory.food.forEach(f => {
                    foodCounts[f] = (foodCounts[f] || 0) + 1;
                });

                Object.entries(foodCounts).forEach(([type, count]) => {
                    const isRare = type === 'light' || type === 'dark';
                    const price = isRare ? SHOP_PRICES.sell.food_rare : SHOP_PRICES.sell.food_common;
                    items.push(`
                        <div style="display: flex; align-items: center; justify-content: space-between; padding: 12px; background: var(--bg); border: 1px solid var(--border); margin-bottom: 10px;">
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <span style="font-size: 1.5rem;">${isRare ? 'âœ¨' : 'ğŸ'}</span>
                                <div>
                                    <div style="font-weight: 700;">${FOOD_NAMES[type]} Ã—${count}</div>
                                    <div style="font-size: 0.85rem; color: #888;">íŒë§¤ê°€: ${price}ğŸ’°</div>
                                </div>
                            </div>
                            <button onclick="sellItem('food', '${type}')" style="padding: 8px 16px; background: var(--fire); color: white;">íŒë§¤</button>
                        </div>
                    `);
                });
            }

            // ì¥ì‹ë¬¼ íŒë§¤
            if (inventory.decorations && inventory.decorations.length > 0) {
                const decorCounts = {};
                inventory.decorations.forEach(d => {
                    decorCounts[d] = (decorCounts[d] || 0) + 1;
                });

                Object.entries(decorCounts).forEach(([type, count]) => {
                    const decoData = DECORATION_TYPES[type];
                    items.push(`
                        <div style="display: flex; align-items: center; justify-content: space-between; padding: 12px; background: var(--bg); border: 1px solid var(--border); margin-bottom: 10px;">
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <span style="font-size: 1.5rem;">${decoData.icon}</span>
                                <div>
                                    <div style="font-weight: 700;">${decoData.name} Ã—${count}</div>
                                    <div style="font-size: 0.85rem; color: #888;">íŒë§¤ê°€: ${SHOP_PRICES.sell.decoration}ğŸ’°</div>
                                </div>
                            </div>
                            <button onclick="sellItem('decoration', '${type}')" style="padding: 8px 16px; background: var(--fire); color: white;">íŒë§¤</button>
                        </div>
                    `);
                });
            }

            // ìŒì•… íŒë§¤
            if (inventory.music && inventory.music.length > 0) {
                const musicCounts = {};
                inventory.music.forEach(m => {
                    musicCounts[m] = (musicCounts[m] || 0) + 1;
                });

                Object.entries(musicCounts).forEach(([type, count]) => {
                    const musicData = MUSIC_TYPES[type];
                    items.push(`
                        <div style="display: flex; align-items: center; justify-content: space-between; padding: 12px; background: var(--bg); border: 1px solid var(--border); margin-bottom: 10px;">
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <span style="font-size: 1.5rem;">ğŸµ</span>
                                <div>
                                    <div style="font-weight: 700;">${musicData.name} Ã—${count}</div>
                                    <div style="font-size: 0.85rem; color: #888;">íŒë§¤ê°€: ${SHOP_PRICES.sell.music}ğŸ’°</div>
                                </div>
                            </div>
                            <button onclick="sellItem('music', '${type}')" style="padding: 8px 16px; background: var(--fire); color: white;">íŒë§¤</button>
                        </div>
                    `);
                });
            }

            if (items.length === 0) {
                container.innerHTML = '<p style="color: #888; text-align: center; padding: 20px;">íŒë§¤í•  ë¬¼í’ˆì´ ì—†ìŠµë‹ˆë‹¤</p>';
            } else {
                container.innerHTML = items.join('');
            }
        }

        function renderBuyList() {
            const container = document.getElementById('buyList');
            if (!container) return;

            const items = [];

            // ì¼ë°˜ ë¨¹ì´ êµ¬ë§¤
            ['fire', 'water', 'wind', 'earth'].forEach(type => {
                items.push(`
                    <div style="display: flex; align-items: center; justify-content: space-between; padding: 12px; background: var(--bg); border: 1px solid var(--border); margin-bottom: 10px;">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <span style="font-size: 1.5rem;">ğŸ</span>
                            <div>
                                <div style="font-weight: 700;">${FOOD_NAMES[type]}</div>
                                <div style="font-size: 0.85rem; color: #888;">ê°€ê²©: ${SHOP_PRICES.buy.food_common}ğŸ’°</div>
                            </div>
                        </div>
                        <button onclick="buyItem('food', '${type}', ${SHOP_PRICES.buy.food_common})" style="padding: 8px 16px;">êµ¬ë§¤</button>
                    </div>
                `);
            });

            // í¬ê·€ ë¨¹ì´ êµ¬ë§¤
            ['light', 'dark'].forEach(type => {
                items.push(`
                    <div style="display: flex; align-items: center; justify-content: space-between; padding: 12px; background: var(--bg); border: 1px solid var(--border); margin-bottom: 10px;">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <span style="font-size: 1.5rem;">âœ¨</span>
                            <div>
                                <div style="font-weight: 700;">${FOOD_NAMES[type]}</div>
                                <div style="font-size: 0.85rem; color: #888;">ê°€ê²©: ${SHOP_PRICES.buy.food_rare}ğŸ’°</div>
                            </div>
                        </div>
                        <button onclick="buyItem('food', '${type}', ${SHOP_PRICES.buy.food_rare})" style="padding: 8px 16px;">êµ¬ë§¤</button>
                    </div>
                `);
            });

            // ìŒì•… êµ¬ë§¤
            Object.keys(MUSIC_TYPES).forEach(type => {
                const musicData = MUSIC_TYPES[type];
                items.push(`
                    <div style="display: flex; align-items: center; justify-content: space-between; padding: 12px; background: var(--bg); border: 1px solid var(--border); margin-bottom: 10px;">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <span style="font-size: 1.5rem;">ğŸµ</span>
                            <div>
                                <div style="font-weight: 700;">${musicData.name}</div>
                                <div style="font-size: 0.85rem; color: #888;">ê°€ê²©: ${SHOP_PRICES.buy.music}ğŸ’°</div>
                            </div>
                        </div>
                        <button onclick="buyItem('music', '${type}', ${SHOP_PRICES.buy.music})" style="padding: 8px 16px;">êµ¬ë§¤</button>
                    </div>
                `);
            });

            // ì¥ì‹ë¬¼ êµ¬ë§¤
            Object.keys(DECORATION_TYPES).forEach(type => {
                const decoData = DECORATION_TYPES[type];
                items.push(`
                    <div style="display: flex; align-items: center; justify-content: space-between; padding: 12px; background: var(--bg); border: 1px solid var(--border); margin-bottom: 10px;">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <span style="font-size: 1.5rem;">${decoData.icon}</span>
                            <div>
                                <div style="font-weight: 700;">${decoData.name}</div>
                                <div style="font-size: 0.85rem; color: #888;">ê°€ê²©: ${SHOP_PRICES.buy.decoration}ğŸ’°</div>
                            </div>
                        </div>
                        <button onclick="buyItem('decoration', '${type}', ${SHOP_PRICES.buy.decoration})" style="padding: 8px 16px;">êµ¬ë§¤</button>
                    </div>
                `);
            });

            container.innerHTML = items.join('');
        }

        function sellItem(category, type) {
            if (category === 'food') {
                const index = inventory.food.indexOf(type);
                if (index === -1) return;
                inventory.food.splice(index, 1);
                const isRare = type === 'light' || type === 'dark';
                const price = isRare ? SHOP_PRICES.sell.food_rare : SHOP_PRICES.sell.food_common;
                coins += price;
                showNotification(`${FOOD_NAMES[type]}ì„(ë¥¼) ${price}ğŸ’°ì— íŒë§¤í–ˆìŠµë‹ˆë‹¤`);
            } else if (category === 'decoration') {
                const index = inventory.decorations.indexOf(type);
                if (index === -1) return;
                inventory.decorations.splice(index, 1);
                coins += SHOP_PRICES.sell.decoration;
                showNotification(`${DECORATION_TYPES[type].name}ì„(ë¥¼) ${SHOP_PRICES.sell.decoration}ğŸ’°ì— íŒë§¤í–ˆìŠµë‹ˆë‹¤`);
            } else if (category === 'music') {
                const index = inventory.music.indexOf(type);
                if (index === -1) return;
                inventory.music.splice(index, 1);
                coins += SHOP_PRICES.sell.music;
                showNotification(`${MUSIC_TYPES[type].name}ì„(ë¥¼) ${SHOP_PRICES.sell.music}ğŸ’°ì— íŒë§¤í–ˆìŠµë‹ˆë‹¤`);
            }

            saveGame();
            renderShop();
            renderInventory();
        }

        function buyItem(category, type, price) {
            if (coins < price) {
                showNotification('ì½”ì¸ì´ ë¶€ì¡±í•©ë‹ˆë‹¤!');
                return;
            }

            coins -= price;

            if (category === 'food') {
                if (!inventory.food) inventory.food = [];
                inventory.food.push(type);
                showNotification(`${FOOD_NAMES[type]}ì„(ë¥¼) ${price}ğŸ’°ì— êµ¬ë§¤í–ˆìŠµë‹ˆë‹¤`);
            } else if (category === 'music') {
                if (!inventory.music) inventory.music = [];
                inventory.music.push(type);
                showNotification(`${MUSIC_TYPES[type].name}ì„(ë¥¼) ${price}ğŸ’°ì— êµ¬ë§¤í–ˆìŠµë‹ˆë‹¤`);
            } else if (category === 'decoration') {
                if (!inventory.decorations) inventory.decorations = [];
                inventory.decorations.push(type);
                showNotification(`${DECORATION_TYPES[type].name}ì„(ë¥¼) ${price}ğŸ’°ì— êµ¬ë§¤í–ˆìŠµë‹ˆë‹¤`);
            }

            saveGame();
            renderShop();
            renderInventory();
        }

        function renderEncyclopedia() {
            const grid = document.getElementById('encyclopediaGrid');
            
            // ëª¨ë“  ê°€ëŠ¥í•œ ì§„í™” ì¡°í•© ìƒì„±
            const statTypes = ['intelligent', 'strong', 'beautiful'];
            const attributeTypes = [
                'fire', 'water', 'wind', 'earth', 'light', 'dark',
                'fire-water', 'fire-wind', 'fire-earth', 'fire-light', 'fire-dark',
                'water-wind', 'water-earth', 'water-light', 'water-dark',
                'wind-earth', 'wind-light', 'wind-dark',
                'earth-light', 'earth-dark',
                'light-dark',
                'balanced', 'multi', 'normal'
            ];
            
            let html = '';
            
            // ìŠ¤íƒ¯ ê³„ì—´ë³„ë¡œ ê·¸ë£¹í™”
            statTypes.forEach(statType => {
                const statPrefix = EVOLUTION_TYPES[`${statType}-basic`].prefix;
                
                html += `<div style="grid-column: 1 / -1; margin-top: 20px; margin-bottom: 10px;">
                    <h3 style="font-family: 'Nanum Myeongjo', serif; font-size: 1.3rem; color: var(--text); border-bottom: 2px solid var(--border); padding-bottom: 8px;">
                        ${statPrefix} ê³„ì—´
                    </h3>
                </div>`;
                
                attributeTypes.forEach(attrType => {
                    // basic, advanced, master ëª¨ë‘ í•©ì‚°
                    const count = (encyclopedia[`${statType}-basic-${attrType}`] || 0) +
                                  (encyclopedia[`${statType}-advanced-${attrType}`] || 0) +
                                  (encyclopedia[`${statType}-master-${attrType}`] || 0);
                    const isUnlocked = count > 0;
                    
                    const attributeData = ATTRIBUTE_NAMES[attrType];
                    if (!attributeData) return;
                    
                    const cardClass = isUnlocked ? 'encyclopedia-card unlocked' : 'encyclopedia-card locked';
                    const displayIcon = isUnlocked ? attributeData.icon : 'â“';
                    const displayName = isUnlocked ? `${statPrefix} ${attributeData.name}` : '???????';
                    const countText = isUnlocked ? `ë‹¬ì„± ${count}íšŒ` : 'ë¯¸ë‹¬ì„±';
                    
                    html += `
                        <div class="${cardClass}">
                            <div class="encyclopedia-icon">${displayIcon}</div>
                            <div class="encyclopedia-name">${displayName}</div>
                            <div class="encyclopedia-count">${countText}</div>
                        </div>
                    `;
                });
            });
            
            grid.innerHTML = html;
        }

        function renderCollection() {
            const grid = document.getElementById('collectionGrid');
            
            if (collection.length === 0) {
                grid.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">ğŸ“–</div>
                        <div>ì•„ì§ ë“±ë¡ëœ ì •ë ¹ì´ ì—†ìŠµë‹ˆë‹¤<br>ì •ë ¹ì„ ì„±ì¶©ê¹Œì§€ í‚¤ì›Œë³´ì„¸ìš”</div>
                    </div>
                `;
                return;
            }

            grid.innerHTML = collection.map(item => {
                // descëŠ” ë„ê° ì•„ì´í…œì— ì €ì¥ë˜ì–´ ìˆìŒ
                const desc = item.desc || '';
                const originalName = item.originalName || item.name || 'ì´ë¦„ ì—†ìŒ';
                
                // ë‚ ê°œ ì´ëª¨ì§€ ê²°ì •
                let wingEmoji = '';
                if (item.wingType === 'butterfly') {
                    wingEmoji = 'ğŸ¦‹';
                } else if (item.wingType === 'moth') {
                    wingEmoji = 'ğŸ¦‹'; // ë‚˜ë°©ë„ ë‚˜ë¹„ ì´ëª¨ì§€ ì‚¬ìš© (ì‹œê°ì ìœ¼ë¡œ êµ¬ë¶„)
                } else if (item.wingType === 'both') {
                    wingEmoji = 'ğŸ¦‹ğŸ¦‹';
                }
                
                return `
                    <div class="collection-card">
                        <div class="collection-icon">${item.icon}${wingEmoji}</div>
                        <div class="collection-name">${item.name}</div>
                        <div style="font-size: 0.85rem; color: #666; margin-top: 4px;">ë³¸ëª…: ${originalName}</div>
                        ${item.wingType ? `<div style="font-size: 0.85rem; color: #888; margin-top: 4px;">${item.wingType === 'butterfly' ? 'ë‚˜ë¹„ì˜ ë‚ ê°œ' : item.wingType === 'moth' ? 'ë‚˜ë°©ì˜ ë‚ ê°œ' : 'ë‚˜ë¹„ì™€ ë‚˜ë°©ì˜ ë‚ ê°œ'}</div>` : ''}
                        ${desc ? `<div style="font-size: 0.85rem; color: #888; margin-top: 8px; line-height: 1.4;">${desc}</div>` : ''}
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; margin-top: 12px;">
                            <div class="param">ğŸ§  ${item.parameters.intelligence}</div>
                            <div class="param">ğŸ’ª ${item.parameters.strength}</div>
                            <div class="param">ğŸ’– ${item.parameters.charm}</div>
                            <div class="param">â¤ï¸ ${item.parameters.affection || 0}</div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function switchTab(tab) {
            currentTab = tab; // í˜„ì¬ íƒ­ ì €ì¥
            
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            
            if (tab === 'garden') {
                document.querySelector('.tab:nth-child(1)').classList.add('active');
                document.getElementById('gardenSection').classList.add('active');
            } else if (tab === 'terrarium') {
                document.querySelector('.tab:nth-child(2)').classList.add('active');
                document.getElementById('terrariumSection').classList.add('active');
                renderTerrariumManagement();
            } else if (tab === 'shop') {
                document.querySelector('.tab:nth-child(3)').classList.add('active');
                document.getElementById('shopSection').classList.add('active');
                renderShop();
            } else if (tab === 'encyclopedia') {
                document.querySelector('.tab:nth-child(4)').classList.add('active');
                document.getElementById('encyclopediaSection').classList.add('active');
                renderEncyclopedia();
            } else if (tab === 'album') {
                document.querySelector('.tab:nth-child(5)').classList.add('active');
                document.getElementById('albumSection').classList.add('active');
                renderCollection();
            }
        }

        function recalculateTerrariumEnvironment() {
            // í™˜ê²½ ì´ˆê¸°í™”
            terrarium = {
                fire: 0,
                water: 0,
                wind: 0,
                earth: 0,
                light: 0,
                dark: 0
            };

            // ì„¤ì¹˜ëœ ëª¨ë“  ì¥ì‹ë¬¼ì„ ìˆœíšŒí•˜ë©° í™˜ê²½ ê³„ì‚°
            installedDecorations.forEach(decorationType => {
                terrarium[decorationType] = Math.min(10, terrarium[decorationType] + 1);

                // ëŒ€ë¦½ ì†ì„± ê°ì†Œ
                const opposites = {
                    fire: 'water',
                    water: 'fire',
                    wind: 'earth',
                    earth: 'wind',
                    light: 'dark',
                    dark: 'light'
                };
                const opposite = opposites[decorationType];
                terrarium[opposite] = Math.max(0, terrarium[opposite] - 1);
            });

            // ì¡°ëª… íš¨ê³¼ ì ìš©
            if (lightMode) {
                terrarium.light = Math.min(10, terrarium.light + 3);
                terrarium.dark = Math.max(0, terrarium.dark - 2);
            } else {
                terrarium.dark = Math.min(10, terrarium.dark + 3);
                terrarium.light = Math.max(0, terrarium.light - 2);
            }
        }

        function toggleLight() {
            lightMode = !lightMode;
            applyLightMode();
            recalculateTerrariumEnvironment();
            saveGame();
            updateAllSpiritCards();
            if (document.getElementById('terrariumSection').classList.contains('active')) {
                renderTerrariumManagement();
            }
            showNotification(lightMode ? 'â˜€ï¸ ì¡°ëª…ì„ ì¼°ìŠµë‹ˆë‹¤' : 'ğŸŒ™ ì¡°ëª…ì„ ê»ìŠµë‹ˆë‹¤');
        }

        function applyLightMode() {
            const icon = document.getElementById('lightIcon');
            if (lightMode) {
                document.body.classList.remove('dark-mode');
                if (icon) icon.textContent = 'â˜€ï¸';
            } else {
                document.body.classList.add('dark-mode');
                if (icon) icon.textContent = 'ğŸŒ™';
            }
        }

        function renderTerrariumManagement() {
            // í™˜ê²½ ë°” ì—…ë°ì´íŠ¸
            Object.entries(terrarium).forEach(([attr, value]) => {
                const bar = document.getElementById(`terr${attr.charAt(0).toUpperCase() + attr.slice(1)}Bar`);
                const valueSpan = document.getElementById(`terr${attr.charAt(0).toUpperCase() + attr.slice(1)}Value`);
                if (bar) bar.style.width = `${value * 10}%`;
                if (valueSpan) valueSpan.textContent = value;
            });

            // ì„¤ì¹˜ëœ ì¥ì‹ë¬¼ ê°œìˆ˜ ì—…ë°ì´íŠ¸
            const installedCountEl = document.getElementById('installedCount');
            if (installedCountEl) {
                installedCountEl.textContent = `${installedDecorations.length} / 20`;
            }

            // ì„¤ì¹˜ëœ ì¥ì‹ë¬¼ ëª©ë¡
            const installedContainer = document.getElementById('installedDecorList');
            if (installedDecorations.length === 0) {
                installedContainer.innerHTML = '<p style="color: #888; text-align: center; padding: 20px;">ì„¤ì¹˜ëœ ì¥ì‹ë¬¼ì´ ì—†ìŠµë‹ˆë‹¤</p>';
            } else {
                const installedCounts = {};
                installedDecorations.forEach(d => {
                    installedCounts[d] = (installedCounts[d] || 0) + 1;
                });

                installedContainer.innerHTML = `
                    <div style="display: grid; gap: 12px;">
                        ${Object.entries(installedCounts).map(([type, count]) => {
                            const decoData = DECORATION_TYPES[type];
                            return `
                                <div style="display: flex; align-items: center; justify-content: space-between; padding: 16px; background: var(--bg); border: 1px solid var(--border);">
                                    <div style="display: flex; align-items: center; gap: 12px;">
                                        <span style="font-size: 1.5rem;">${decoData.icon}</span>
                                        <div>
                                            <div style="font-weight: 700;">${decoData.name} Ã—${count}</div>
                                            <div style="font-size: 0.85rem; color: #888;">${decoData.effect}</div>
                                        </div>
                                    </div>
                                    <button onclick="removeDecorationFromTerrarium('${type}')" style="padding: 8px 16px; background: #dc3545; color: white;">
                                        íšŒìˆ˜
                                    </button>
                                </div>
                            `;
                        }).join('')}
                    </div>
                `;
            }

            // ì¸ë²¤í† ë¦¬ ì¥ì‹ë¬¼ ëª©ë¡
            const listContainer = document.getElementById('terrariumDecorList');
            if (!inventory.decorations) inventory.decorations = [];
            
            if (inventory.decorations.length === 0) {
                listContainer.innerHTML = '<p style="color: #888; text-align: center; padding: 20px;">ë³´ìœ í•œ ì¥ì‹ë¬¼ì´ ì—†ìŠµë‹ˆë‹¤</p>';
                return;
            }

            const decorCounts = {};
            inventory.decorations.forEach(d => {
                decorCounts[d] = (decorCounts[d] || 0) + 1;
            });

            const canInstall = installedDecorations.length < 20;

            listContainer.innerHTML = `
                <div style="display: grid; gap: 12px;">
                    ${Object.entries(decorCounts).map(([type, count]) => {
                        const decoData = DECORATION_TYPES[type];
                        return `
                            <div style="display: flex; align-items: center; justify-content: space-between; padding: 16px; background: var(--bg); border: 1px solid var(--border);">
                                <div style="display: flex; align-items: center; gap: 12px;">
                                    <span style="font-size: 1.5rem;">${decoData.icon}</span>
                                    <div>
                                        <div style="font-weight: 700;">${decoData.name} Ã—${count}</div>
                                        <div style="font-size: 0.85rem; color: #888;">${decoData.effect}</div>
                                    </div>
                                </div>
                                <button onclick="placeDecorationInTerrarium('${type}')" style="padding: 8px 16px;" ${!canInstall ? 'disabled' : ''}>
                                    ${canInstall ? 'ì„¤ì¹˜' : 'ê³µê°„ ë¶€ì¡±'}
                                </button>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
        }

        function placeDecorationInTerrarium(decorationType) {
            if (!inventory.decorations) inventory.decorations = [];
            
            // ìµœëŒ€ 20ê°œ ì²´í¬
            if (installedDecorations.length >= 20) {
                showNotification('í…Œë¼ë¦¬ì›€ì´ ê°€ë“ ì°¼ìŠµë‹ˆë‹¤ (ìµœëŒ€ 20ê°œ)');
                return;
            }

            const index = inventory.decorations.indexOf(decorationType);
            if (index === -1) return;

            const decoData = DECORATION_TYPES[decorationType];

            // ì¸ë²¤í† ë¦¬ì—ì„œ ì œê±°í•˜ê³  ì„¤ì¹˜ ëª©ë¡ì— ì¶”ê°€
            inventory.decorations.splice(index, 1);
            installedDecorations.push(decorationType);

            // í™˜ê²½ ì¬ê³„ì‚°
            recalculateTerrariumEnvironment();

            saveGame();
            renderTerrariumManagement();
            renderInventory();
            updateAllSpiritCards();
            showNotification(`${decoData.icon} ${decoData.name} ì„¤ì¹˜ ì™„ë£Œ`);
        }

        function removeDecorationFromTerrarium(decorationType) {
            const index = installedDecorations.indexOf(decorationType);
            if (index === -1) return;

            const decoData = DECORATION_TYPES[decorationType];

            // ì„¤ì¹˜ ëª©ë¡ì—ì„œ ì œê±°í•˜ê³  ì¸ë²¤í† ë¦¬ì— ì¶”ê°€
            installedDecorations.splice(index, 1);
            if (!inventory.decorations) inventory.decorations = [];
            inventory.decorations.push(decorationType);

            // í™˜ê²½ ì¬ê³„ì‚°
            recalculateTerrariumEnvironment();

            saveGame();
            renderTerrariumManagement();
            renderInventory();
            updateAllSpiritCards();
            showNotification(`${decoData.icon} ${decoData.name} íšŒìˆ˜ ì™„ë£Œ`);
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        function showNotification(message) {
            // ê¸°ì¡´ ì•Œë¦¼ë“¤ì˜ ê°œìˆ˜ë¥¼ ì„¸ì„œ ìœ„ì¹˜ ì¡°ì •
            const existingNotifs = document.querySelectorAll('.notification');
            const offset = existingNotifs.length * 70; // ê° ì•Œë¦¼ë§ˆë‹¤ 70px ê°„ê²©
            
            const notif = document.createElement('div');
            notif.className = 'notification';
            notif.textContent = message;
            notif.style.top = `${80 + offset}px`;
            document.body.appendChild(notif);
            
            setTimeout(() => {
                notif.style.animation = 'slideOut 0.3s ease-out';
                setTimeout(() => notif.remove(), 300);
            }, 3000);
        }

        function updateTimeDisplay() {
            const now = new Date();
            const timeStr = now.toLocaleTimeString('ko-KR', { 
                hour: '2-digit', 
                minute: '2-digit',
                second: '2-digit'
            });
            document.getElementById('timeDisplay').textContent = timeStr;
        }

        // ê²Œì„ ë£¨í”„
        setInterval(() => {
            saveGame();
        }, 5000);

        // 1ì´ˆë§ˆë‹¤ ë²„íŠ¼ ìƒíƒœ ë° ì •ë ¹ ìƒíƒœ ì²´í¬
        setInterval(() => {
            checkSpiritStatus();
            // garden íƒ­ì´ í™œì„±í™”ëœ ê²½ìš°ì—ë§Œ ì¹´ë“œ ì—…ë°ì´íŠ¸
            if (currentTab === 'garden') {
                spirits.forEach(spirit => {
                    updateSpiritCard(spirit);
                });
            }
            updateGatherButton();
        }, 1000);

        // 1ë¶„ë§ˆë‹¤ ì„±ì¥ë„ ì¦ê°€
        setInterval(() => {
            applyGrowth();
        }, 60000);  // 60000ms = 1ë¶„

        // 5ë¶„ë§ˆë‹¤ í…Œë¼ë¦¬ì›€ í™˜ê²½ íš¨ê³¼ ì ìš©
        setInterval(() => {
            applyTerrariumGrowth();
        }, 300000);  // 300000ms = 5ë¶„

        setInterval(updateTimeDisplay, 1000);

        // ì´ˆê¸°í™”
        loadGame();
        renderSpirits();
        renderInventory();
        updateTimeDisplay();
        applyLightMode();
        updateCoinDisplay();

        // ëª¨ë‹¬ ë°°ê²½ í´ë¦­ ì‹œ ë‹«ê¸°
        document.querySelectorAll('.modal').forEach(modal => {
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.classList.remove('active');
                }
            });
        });
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ë‚˜ì˜ ì‘ì€ í…Œë¼ë¦¬ì›€ - Spirit Garden</title>
    <link href="https://fonts.googleapis.com/css2?family=Nanum+Myeongjo:wght@400;700;800&family=Gowun+Batang:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg: #fafaf8;
            --text: #2a2a2a;
            --text-muted: #666;
            --border: #e0e0dc;
            --card: #ffffff;
            --shadow: rgba(0, 0, 0, 0.06);
            
            --fire: #ff6b4a;
            --water: #4a9eff;
            --wind: #7bdb8f;
            --earth: #d4a574;
            --light: #ffd94a;
            --dark: #8e7cc3;
        }

        body {
            font-family: 'Gowun Batang', serif;
            background: var(--bg);
            color: var(--text);
            line-height: 1.6;
            padding: 20px;
            max-width: 1400px;
            margin: 0 auto;
        }

        h1 {
            font-family: 'Nanum Myeongjo', serif;
            font-size: 2.5rem;
            font-weight: 800;
            text-align: center;
            margin-bottom: 10px;
            letter-spacing: -1px;
        }

        .subtitle {
            text-align: center;
            font-size: 0.9rem;
            color: #888;
            margin-bottom: 40px;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            border-bottom: 1px solid var(--border);
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none;
        }
        
        .tabs::-webkit-scrollbar {
            display: none;
        }

        .tab {
            padding: 12px 24px;
            background: none;
            border: none;
            font-family: 'Gowun Batang', serif;
            font-size: 1rem;
            cursor: pointer;
            color: #888;
            transition: all 0.3s;
            border-bottom: 2px solid transparent;
            white-space: nowrap;
            flex-shrink: 0;
        }

        .tab.active {
            color: var(--text);
            border-bottom-color: var(--text);
        }

        .tab:hover {
            color: var(--text);
        }

        .section {
            display: none;
        }

        .section.active {
            display: block;
        }

        .main-layout {
            display: grid;
            grid-template-columns: 300px 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }

        .inventory-panel {
            background: var(--card);
            border: 1px solid var(--border);
            padding: 24px;
            height: fit-content;
            position: sticky;
            top: 20px;
        }

        .inventory-title {
            font-family: 'Nanum Myeongjo', serif;
            font-size: 1.2rem;
            font-weight: 700;
            margin-bottom: 16px;
        }

        .inventory-section {
            margin-bottom: 20px;
        }

        .inventory-label {
            font-size: 0.85rem;
            color: #888;
            margin-bottom: 8px;
        }

        .inventory-items {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .inventory-item {
            padding: 6px 12px;
            background: var(--bg);
            border: 1px solid var(--border);
            font-size: 0.85rem;
            display: flex;
            align-items: center;
            gap: 6px;
            border-radius: 4px;
        }

        .spirits-grid {
            display: grid !important;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 20px;
        }
        
        /* PCì—ì„œ Swiper ìŠ¤íƒ€ì¼ ì™„ì „ ë¬´ì‹œ - ê·¸ë¦¬ë“œ ë ˆì´ì•„ì›ƒ ìœ ì§€ */
        body:not(.mobile-layout) .spirits-swiper {
            overflow: visible !important;
        }
        
        /* PCì—ì„œ swiper-wrapper(spirits-grid)ëŠ” ê·¸ë¦¬ë“œë¡œ ì‘ë™ */
        body:not(.mobile-layout) .swiper-wrapper.spirits-grid,
        body:not(.mobile-layout) .spirits-swiper .swiper-wrapper {
            display: grid !important;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)) !important;
            gap: 20px !important;
            transform: none !important;
            width: auto !important;
        }
        
        /* PCì—ì„œ swiper-slideëŠ” ê·¸ë¦¬ë“œ ì•„ì´í…œì²˜ëŸ¼ ì‘ë™ */
        body:not(.mobile-layout) .spirits-grid .swiper-slide,
        body:not(.mobile-layout) .spirits-swiper .swiper-slide {
            width: auto !important;
            min-width: auto !important;
            max-width: none !important;
            flex-shrink: 1 !important;
            padding: 0 !important;
            margin-right: 0 !important;
        }
        
        /* Swiper í˜ì´ì§€ë„¤ì´ì…˜ - PCì—ì„œ ìˆ¨ê¹€ */
        .swiper-pagination-container {
            display: none;
        }
        
        /* ëª¨ë°”ì¼ ì •ë ¹ ìŠ¬ë¼ì´ë” ë„¤ë¹„ê²Œì´ì…˜ - ê¸°ë³¸ ìˆ¨ê¹€ */
        .mobile-spirit-nav {
            display: none;
        }

        .spirit-card {
            background: var(--card);
            border: 1px solid var(--border);
            padding: 24px;
            transition: all 0.3s;
        }

        .spirit-card:hover {
            box-shadow: 0 4px 20px var(--shadow);
            transform: translateY(-2px);
        }
        
        /* ì •ë ¹ ì¹´ë“œ ìƒì„¸ ì •ë³´ ì ‘ê¸°/í¼ì¹˜ê¸° */
        .spirit-card-toggle {
            width: calc(100% + 48px);
            margin: 12px -24px -24px -24px;
            padding: 6px;
            background: #333;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 0.8rem;
        }
        
        .spirit-card-toggle:hover {
            background: #444;
        }
        
        .spirit-detail-section {
            display: none;
        }
        
        .spirit-detail-section.show {
            display: block;
        }

        .spirit-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 16px;
        }

        .spirit-icon {
            font-size: 3rem;
            line-height: 1;
        }
        
        .spirit-icon img {
            width: 3rem;
            height: 3rem;
            object-fit: contain;
        }

        .spirit-info {
            flex: 1;
            margin-left: 16px;
        }

        .spirit-name {
            font-family: 'Nanum Myeongjo', serif;
            font-size: 1.2rem;
            font-weight: 700;
            margin-bottom: 4px;
            cursor: pointer;
        }

        .spirit-name:hover {
            color: var(--fire);
        }

        .spirit-stage {
            font-size: 0.85rem;
            color: #888;
        }

        .progress-bar {
            height: 6px;
            background: var(--border);
            margin-bottom: 8px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--light), var(--fire));
            transition: width 0.5s;
        }

        .progress-text {
            font-size: 0.8rem;
            color: #888;
            margin-bottom: 16px;
        }

        .parameters {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
            margin-bottom: 16px;
            padding: 12px;
            background: var(--bg);
            border: 1px solid var(--border);
        }

        .param {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.85rem;
        }

        .param-icon {
            font-size: 1.1rem;
        }

        .environment {
            margin-bottom: 16px;
            padding: 12px;
            background: var(--bg);
            border: 1px solid var(--border);
        }

        .env-title {
            font-size: 0.85rem;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .env-bars {
            display: grid;
            gap: 6px;
        }

        .env-bar {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.8rem;
        }

        .env-bar-bg {
            flex: 1;
            height: 8px;
            background: var(--border);
            position: relative;
            overflow: hidden;
        }

        .env-bar-fill {
            height: 100%;
            transition: width 0.5s;
        }

        .spirit-status {
            font-size: 0.85rem;
            color: #888;
            margin-bottom: 4px;
            min-height: 40px;
        }

        .spirit-appearance {
            color: var(--text-muted);
        }

        .action-buttons {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
        }

        button {
            padding: 10px 16px;
            border: 1px solid var(--border);
            background: var(--card);
            font-family: 'Gowun Batang', serif;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.2s;
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
            user-select: none;
            -webkit-user-select: none;
        }

        button:hover {
            background: var(--bg);
            border-color: var(--text);
        }

        button:active {
            transform: scale(0.98);
        }

        button:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }

        select {
            padding: 8px 12px;
            border: 1px solid var(--border);
            background: var(--card);
            color: var(--text);
            font-family: 'Gowun Batang', serif;
            font-size: 0.9rem;
            border-radius: 4px;
            cursor: pointer;
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
            -webkit-appearance: none;
            appearance: none;
        }
        
        select:focus {
            outline: 2px solid var(--fire);
            outline-offset: 2px;
        }

        .new-spirit-btn {
            width: 100%;
            padding: 16px;
            font-size: 1rem;
            font-weight: 700;
            margin-top: 20px;
        }

        .walk-btn {
            width: 100%;
            padding: 16px;
            font-size: 1rem;
            font-weight: 700;
            margin-bottom: 20px;
            background: var(--light);
            border-color: var(--light);
            color: #000 !important;
        }

        .walk-btn:hover {
            background: var(--fire);
            border-color: var(--fire);
            color: #000 !important;
        }

        .walk-btn:disabled {
            color: #666 !important;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.6);
            z-index: 1000;
            align-items: flex-start;
            justify-content: center;
            padding: 20px;
            padding-top: 180px;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: var(--card);
            padding: 32px;
            max-width: 500px;
            width: 100%;
            border: 1px solid var(--border);
            margin-bottom: 40px;
        }

        .modal-title {
            font-family: 'Nanum Myeongjo', serif;
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 20px;
        }

        .food-grid, .music-grid, .decor-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-bottom: 20px;
        }

        .option-btn {
            padding: 16px;
            text-align: left;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .option-icon {
            font-size: 1.5rem;
        }

        .option-info {
            flex: 1;
        }

        .option-name {
            font-weight: 700;
            margin-bottom: 2px;
        }

        .option-effect {
            font-size: 0.8rem;
            color: #888;
        }

        .close-btn {
            width: 100%;
            margin-top: 16px;
        }

        .collection-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px;
        }
        
        .encyclopedia-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .encyclopedia-card {
            background: var(--card);
            border: 2px solid var(--border);
            padding: 20px;
            text-align: center;
            position: relative;
            min-height: 120px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        
        .encyclopedia-card.unlocked {
            border-color: #4CAF50;
        }
        
        .encyclopedia-card.locked {
            background: repeating-linear-gradient(
                45deg,
                var(--card),
                var(--card) 10px,
                var(--border) 10px,
                var(--border) 11px
            );
            opacity: 0.6;
        }
        
        .encyclopedia-icon {
            font-size: 3rem;
            margin-bottom: 8px;
        }
        
        .encyclopedia-icon img {
            width: 3rem;
            height: 3rem;
            object-fit: contain;
        }
        
        .encyclopedia-name {
            font-family: 'Nanum Myeongjo', serif;
            font-size: 1rem;
            font-weight: 700;
            color: var(--text);
        }
        
        .encyclopedia-count {
            font-size: 0.85rem;
            color: #888;
            margin-top: 4px;
        }

        .collection-card {
            background: var(--card);
            border: 1px solid var(--border);
            padding: 24px;
            text-align: center;
        }

        .collection-icon {
            font-size: 4rem;
            margin-bottom: 12px;
        }

        .collection-name {
            font-family: 'Nanum Myeongjo', serif;
            font-size: 1.2rem;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #888;
        }

        .empty-icon {
            font-size: 3rem;
            margin-bottom: 16px;
            opacity: 0.3;
        }

        .time-display {
            text-align: center;
            font-size: 0.9rem;
            color: #888;
            margin-bottom: 20px;
        }

        .notification {
            position: fixed;
            top: 80px;
            right: 20px;
            background: var(--card);
            border: 1px solid var(--border);
            padding: 16px 24px;
            box-shadow: 0 4px 20px var(--shadow);
            z-index: 999;
            animation: slideIn 0.3s ease-out;
            max-width: 300px;
            word-wrap: break-word;
        }

        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes slideOut {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(400px);
                opacity: 0;
            }
        }

        .name-input {
            width: 100%;
            padding: 12px;
            font-family: 'Gowun Batang', serif;
            font-size: 1rem;
            border: 1px solid var(--border);
            margin-bottom: 16px;
        }

        .decor-btn:disabled::after {
            content: 'ì¬ë£Œ ë¶€ì¡±';
            position: absolute;
            top: 8px;
            right: 8px;
            font-size: 0.7rem;
            padding: 2px 6px;
            background: #f44;
            color: white;
            border-radius: 2px;
        }

        @media (max-width: 900px) {
            .main-layout {
                grid-template-columns: 1fr;
            }

            .inventory-panel {
                position: static;
            }
        }

        .light-toggle {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 60px;
            height: 32px;
            background: #4CAF50;
            border: none;
            border-radius: 16px;
            cursor: pointer;
            transition: background-color 0.3s ease;
            z-index: 1000;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            padding: 0;
        }
        
        /* í”Œë¡œíŒ… ìŠ¤í¬ë¡¤ ë²„íŠ¼ */
        .scroll-buttons {
            position: fixed;
            right: 20px;
            bottom: 20px;
            display: flex;
            flex-direction: column;
            gap: 8px;
            z-index: 10000;
        }
        
        .scroll-btn {
            width: 45px;
            height: 45px;
            border: none;
            border-radius: 50%;
            background: var(--card);
            color: var(--text);
            cursor: pointer;
            font-size: 1.3rem;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            border: 1px solid var(--border);
            transition: all 0.2s ease;
        }
        
        .scroll-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }
        
        .scroll-btn:active {
            transform: scale(0.95);
        }
        
        /* ìƒì  ì•„ì´í…œ ê·¸ë¦¬ë“œ - ê¸°ë³¸ 2ì—´ (ëª¨ë°”ì¼ ìš°ì„ ) */
        .shop-items-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }
        
        /* í° í™”ë©´ì—ì„œë§Œ 3ì—´ (1200px ì´ìƒ) */
        @media (min-width: 1200px) {
            .shop-items-grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }
        
        /* ëª¨ë°”ì¼ ë°˜ì‘í˜• */
        @media (max-width: 768px) {
            
            .scroll-buttons {
                right: 15px;
                bottom: 15px;
            }
            
            .scroll-btn {
                width: 40px;
                height: 40px;
                font-size: 1.1rem;
            }
            
            /* ìƒì  ë ˆì´ì•„ì›ƒ 1ì—´ë¡œ ë³€ê²½ */
            .shop-grid {
                grid-template-columns: 1fr !important;
                gap: 15px !important;
            }
            
            /* í…Œë¼ë¦¬ì›€ ë¯¸ë‹ˆì–´ì²˜ ëª©ë¡ 1ì—´ë¡œ ë³€ê²½ */
            #installedDecorList > div,
            #terrariumDecorList > div {
                grid-template-columns: 1fr !important;
            }
            
            /* ìƒì  ì„¹ì…˜ íŒ¨ë”© ì¡°ì • */
            .shop-section {
                padding: 20px !important;
            }
            
            /* ì œëª© í¬ê¸° ì¡°ì • */
            h1 {
                font-size: 1.8rem !important;
            }
            
            h2 {
                font-size: 1.5rem !important;
            }
            
            /* íƒ­ ë²„íŠ¼ í¬ê¸° ì¡°ì • */
            .tab {
                padding: 10px 15px !important;
                font-size: 0.9rem !important;
            }
            
            /* ìƒì  ì œëª© í¬ê¸° ì¡°ì • */
            .shop-section h3 {
                font-size: 1.1rem !important;
            }
            
            /* ì „ì²´ ì—¬ë°± ì¡°ì • */
            body {
                padding: 10px !important;
            }
        }

        .light-toggle::before {
            content: '';
            position: absolute;
            width: 26px;
            height: 26px;
            border-radius: 50%;
            background: white;
            top: 3px;
            left: 3px;
            transition: transform 0.3s ease;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        body.dark-mode .light-toggle {
            background: #666;
        }

        body.dark-mode .light-toggle::before {
            transform: translateX(28px);
        }

        .light-toggle #lightIcon {
            display: none;
        }

        body.dark-mode {
            --bg: #0d0d14;
            --card: #1a1a24;
            --text: #e0e0e0;
            --text-muted: #b0b0b0;
            --border: #2a2a3a;
        }

        body.dark-mode .spirit-name,
        body.dark-mode .spirit-stage,
        body.dark-mode .progress-text,
        body.dark-mode .param,
        body.dark-mode .spirit-status,
        body.dark-mode .spirit-appearance,
        body.dark-mode .env-title,
        body.dark-mode .modal-title,
        body.dark-mode .option-name,
        body.dark-mode .option-effect,
        body.dark-mode .inventory-label,
        body.dark-mode .collection-name,
        body.dark-mode h1,
        body.dark-mode h2,
        body.dark-mode .subtitle,
        body.dark-mode .time-display {
            color: #e0e0e0;
        }

        body.dark-mode button {
            color: #e0e0e0;
        }

        body.dark-mode button:disabled {
            color: #888;
        }
        
        /* ë¯¸ë‹ˆê²Œì„ ëª¨ë°”ì¼ ëŒ€ì‘ */
        @media (max-width: 768px) {
            #minigameArea {
                height: 200px !important;
            }
            
            #minigameSpirit {
                font-size: 2rem !important;
                bottom: 5px !important;
            }
            
            #shieldEffect {
                width: 60px !important;
                height: 60px !important;
            }
            
            .minigame-word {
                font-size: 0.8rem !important;
                padding: 5px 8px !important;
            }
            
            #minigameInput {
                font-size: 1rem !important;
                padding: 12px !important;
            }
            
            /* ë¯¸ë‹ˆê²Œì„ í”Œë ˆì´ ì¤‘ í™”ë©´ ê³ ì • */
            body.minigame-active {
                overflow: hidden;
                position: fixed;
                width: 100%;
                height: 100%;
            }
            
            body.minigame-active #minigamePlay {
                position: fixed;
                left: 0;
                right: 0;
                bottom: 0;
                z-index: 9999;
                background: var(--bg);
                padding: 0;
                display: flex !important;
                flex-direction: column;
            }
            
            body.minigame-active #minigamePlay > div:first-child {
                /* ìƒíƒœë°” (í•˜íŠ¸, ì ìˆ˜, í¬ê¸°ë²„íŠ¼) */
                margin: 0;
                border-radius: 0;
                padding: 10px 15px !important;
            }
            
            body.minigame-active #minigameArea {
                flex: 0 0 auto;
                height: 220px !important;
                border-radius: 0;
                border-left: none;
                border-right: none;
                margin: 0;
            }
            
            body.minigame-active #minigamePlay > div:last-child {
                /* ì…ë ¥ì°½ ì»¨í…Œì´ë„ˆ */
                margin: 0 !important;
            }
            
            body.minigame-active #minigameInput {
                border-radius: 0;
                border-left: none;
                border-right: none;
                border-bottom: none;
            }
        }
        
        /* íŠœí† ë¦¬ì–¼ ë²„íŠ¼ ê°•ì¡° íš¨ê³¼ */
        @keyframes tutorialPulse {
            0% { box-shadow: 0 0 0 0 rgba(255, 193, 7, 0.7); }
            50% { box-shadow: 0 0 20px 10px rgba(255, 193, 7, 0.4); }
            100% { box-shadow: 0 0 0 0 rgba(255, 193, 7, 0.7); }
        }
        
        .tutorial-highlight {
            animation: tutorialPulse 1.5s infinite !important;
            border: 3px solid #ffc107 !important;
            position: relative;
            z-index: 100;
        }
        
        .tutorial-highlight::after {
            content: 'ğŸ‘‡';
            position: absolute;
            top: -30px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 1.5rem;
            animation: bounce 0.5s infinite alternate;
        }
        
        @keyframes bounce {
            from { transform: translateX(-50%) translateY(0); }
            to { transform: translateX(-50%) translateY(-5px); }
        }
        
        /* ===== ëª¨ë°”ì¼ ë ˆì´ì•„ì›ƒ (768px ì´í•˜) ===== */
        @media (max-width: 768px) {
            /* í—¤ë” ê³ ì • */
            .mobile-fixed-header {
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                background: var(--card);
                border-bottom: 1px solid var(--border);
                z-index: 1000;
                padding: 10px 16px;
            }
            
            .mobile-fixed-header h1 {
                font-size: 1.3rem !important;
                margin: 0;
                text-align: center;
            }
            
            .mobile-fixed-header .subtitle {
                font-size: 0.8rem;
                text-align: center;
                margin: 0;
            }
            
            /* í•˜ë‹¨ íƒ­ë°” ê³ ì • */
            .mobile-fixed-tabs {
                position: fixed;
                bottom: 0;
                left: 0;
                right: 0;
                background: var(--card);
                border-top: 1px solid var(--border);
                z-index: 1000;
                display: flex;
                flex-wrap: nowrap;
                padding: 8px 4px;
                padding-bottom: calc(8px + env(safe-area-inset-bottom));
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
                scrollbar-width: none;
            }
            
            .mobile-fixed-tabs::-webkit-scrollbar {
                display: none;
            }
            
            .mobile-fixed-tabs .tab {
                flex: 0 0 auto;
                padding: 10px 16px !important;
                font-size: 0.9rem !important;
                white-space: nowrap;
            }
            
            .mobile-fixed-tabs .control-btns {
                display: flex;
                gap: 4px;
                flex-shrink: 0;
                margin-left: auto;
            }
            
            .mobile-fixed-tabs .control-btns button {
                padding: 8px 12px !important;
                font-size: 1.2rem !important;
            }
            
            /* ë³¸ë¬¸ íŒ¨ë”© ì¡°ì • */
            body.mobile-layout {
                padding: 140px 0 70px 0 !important;
                overflow-x: hidden !important;
                max-width: 100vw !important;
            }
            
            body.mobile-layout .section {
                width: 100% !important;
                max-width: 100vw !important;
                padding: 0 !important;
                margin: 0 !important;
                overflow-x: hidden !important;
            }
            
            body.mobile-layout.gather-expanded {
                padding-top: 340px !important;
            }
            
            /* ëª¨ë°”ì¼ ì•Œë¦¼ì°½ ìœ„ì¹˜ ì¡°ì • */
            body.mobile-layout .notification {
                top: 150px !important;
                right: 10px !important;
                max-width: 250px !important;
            }
            
            body.mobile-layout.gather-expanded .notification {
                top: 350px !important;
            }
            
            /* ê¸°ì¡´ í—¤ë”/íƒ­ ìˆ¨ê¸°ê¸° */
            body.mobile-layout .desktop-header,
            body.mobile-layout .desktop-tabs {
                display: none !important;
            }
            
            /* ëª¨ë°”ì¼ì—ì„œ ìƒë‹¨ ì„œë¸Œíƒ­ ë°” ìˆ¨ê¸°ê¸° */
            body.mobile-layout #subTabBar {
                display: none !important;
            }
            
            /* ëª¨ë°”ì¼ì—ì„œ ì„¹ì…˜ ë‚´ë¶€ ì„œë¸Œíƒ­ ìˆ¨ê¸°ê¸° (í•˜ë‹¨ ì„œë¸Œíƒ­ ë°” ì‚¬ìš©) */
            body.mobile-layout .mobile-sub-tabs {
                display: none !important;
            }
            
            /* ëª¨ë°”ì¼ í•˜ë‹¨ ì„œë¸Œíƒ­ ë°” */
            .mobile-sub-tab-bar {
                position: fixed;
                bottom: 60px;
                left: 0;
                right: 0;
                background: var(--card);
                border-top: 1px solid var(--border);
                z-index: 999;
                display: flex;
                justify-content: center;
                gap: 8px;
                padding: 8px 16px;
                padding-bottom: calc(8px + env(safe-area-inset-bottom) * 0.3);
            }
            
            .mobile-sub-tab {
                padding: 8px 16px;
                background: var(--bg);
                color: var(--text);
                border: 1px solid var(--border);
                border-radius: 20px;
                font-size: 0.85rem;
                font-weight: 600;
                cursor: pointer;
                transition: all 0.2s;
            }
            
            .mobile-sub-tab.active {
                background: #f39c12;
                color: white;
                border-color: #f39c12;
            }
            
            /* ëª¨ë°”ì¼ì—ì„œ ê¸°ì¡´ ì¸ë²¤í† ë¦¬ íŒ¨ë„ ìˆ¨ê¸°ê¸° */
            body.mobile-layout .inventory-panel {
                display: none !important;
            }
            
            /* ëª¨ë°”ì¼ ê³ ì • ì±„ì§‘ ì„¹ì…˜ */
            .mobile-fixed-gather {
                position: fixed;
                top: 50px;
                left: 0;
                right: 0;
                background: var(--card);
                border-bottom: 1px solid var(--border);
                z-index: 999;
                display: flex;
                flex-direction: column;
            }
            
            .mobile-gather-main {
                padding: 12px 16px;
                display: flex;
                gap: 8px;
            }
            
            .mobile-gather-content {
                display: none;
                padding: 0 16px 12px;
                max-height: 200px;
                overflow-y: auto;
            }
            
            .mobile-gather-content.show {
                display: block;
            }
            
            .mobile-gather-toggle {
                width: 100%;
                padding: 6px;
                background: #333;
                border: none;
                cursor: pointer;
                display: flex;
                align-items: center;
                justify-content: center;
                color: white;
                font-size: 0.8rem;
            }
            
            .mobile-gather-toggle .arrow {
                transition: transform 0.3s;
            }
            
            .mobile-gather-toggle.expanded .arrow {
                transform: rotate(180deg);
            }
            
            /* ëª¨ë°”ì¼ ì •ë ¹ ì¹´ë“œ ìŠ¤í¬ë¡¤ ìŠ¤íƒ€ì¼ */
            body.mobile-layout .spirits-swiper {
                width: 100% !important;
                max-width: 100vw !important;
                overflow-x: auto !important;
                overflow-y: hidden !important;
                margin: 0 !important;
                padding: 0 !important;
                scroll-snap-type: x mandatory;
                scroll-behavior: smooth;
                -webkit-overflow-scrolling: auto;
                scrollbar-width: none;
                -ms-overflow-style: none;
            }
            
            body.mobile-layout .spirits-swiper::-webkit-scrollbar {
                display: none;
            }
            
            body.mobile-layout .swiper-wrapper {
                display: flex !important;
                width: max-content !important;
                gap: 0 !important;
            }
            
            body.mobile-layout .swiper-slide {
                width: 100vw !important;
                min-width: 100vw !important;
                max-width: 100vw !important;
                flex-shrink: 0 !important;
                box-sizing: border-box !important;
                padding: 8px 16px !important;
                scroll-snap-align: start;
                scroll-snap-stop: always;
            }
            
            body.mobile-layout .spirit-card {
                width: calc(100vw - 32px) !important;
                max-width: calc(100vw - 32px) !important;
                margin: 0 auto !important;
                padding: 16px !important;
                box-sizing: border-box !important;
            }
            
            body.mobile-layout .spirit-card-toggle {
                width: calc(100% + 32px) !important;
                margin: 12px -16px -16px -16px !important;
            }
            
            /* Swiper í˜ì´ì§€ë„¤ì´ì…˜ ìŠ¤íƒ€ì¼ */
            .swiper-pagination-container {
                display: none;
                background: var(--card);
                border-bottom: 1px solid var(--border);
                padding: 12px;
                text-align: center;
            }
            
            body.mobile-layout .swiper-pagination-container {
                display: block !important;
                padding: 20px 12px !important;
            }
            
            #spiritsPagination {
                position: static !important;
            }
            
            .swiper-pagination-bullet {
                background: var(--text-muted);
                opacity: 0.5;
                width: 10px;
                height: 10px;
                margin: 0 4px !important;
            }
            
            .swiper-pagination-bullet-active {
                background: var(--primary);
                opacity: 1;
            }
            
            /* ì •ë ¹ ìŠ¬ë¼ì´ë” ì¸ë””ì¼€ì´í„° - ë” ì´ìƒ ì‚¬ìš© ì•ˆí•¨ */
            .mobile-spirit-nav {
                display: none !important;
            }
            
            /* ì •ë ¹ ì¸ë””ì¼€ì´í„° */
            .mobile-spirit-dots {
                display: flex;
                justify-content: center;
                gap: 8px;
                padding: 12px 0;
            }
            
            .mobile-spirit-dot {
                width: 10px;
                height: 10px;
                border-radius: 50%;
                background: var(--border);
                cursor: pointer;
            }
            
            .mobile-spirit-dot.active {
                background: var(--fire);
            }
            
            /* ì±„ì§‘ ì˜ì—­ ì ‘ê¸°/í¼ì¹˜ê¸° */
            .mobile-gather-collapsible {
                background: var(--card);
                border: 1px solid var(--border);
                border-radius: 8px;
                margin-bottom: 16px;
                overflow: hidden;
            }
            
            .mobile-gather-header {
                display: flex;
                align-items: center;
                padding: 12px;
                gap: 8px;
                cursor: pointer;
            }
            
            .mobile-gather-header .walk-btn {
                flex: 1;
                margin: 0 !important;
            }
            
            .mobile-gather-content {
                display: none;
                padding: 0 12px 12px;
            }
            
            .mobile-gather-content.show {
                display: block;
            }
            
            /* ì •ë ¹ ì¹´ë“œ ìŠ¬ë¼ì´ë“œ */
            .mobile-spirits-slider {
                display: flex;
                overflow-x: auto;
                scroll-snap-type: x mandatory;
                -webkit-overflow-scrolling: touch;
                scrollbar-width: none;
                gap: 16px;
                padding: 8px 0;
            }
            
            .mobile-spirits-slider::-webkit-scrollbar {
                display: none;
            }
            
            .mobile-spirits-slider .spirit-card {
                flex: 0 0 calc(100% - 32px);
                scroll-snap-align: start;
                margin: 0;
            }
            
            /* ì •ë ¹ ì¸ë””ì¼€ì´í„° */
            .mobile-spirit-dots {
                display: flex;
                justify-content: center;
                gap: 8px;
                padding: 12px;
            }
            
            .mobile-spirit-dot {
                width: 10px;
                height: 10px;
                border-radius: 50%;
                background: var(--border);
                cursor: pointer;
                transition: background 0.3s;
            }
            
            .mobile-spirit-dot.active {
                background: var(--fire);
            }
            
            /* ì •ë ¹ ì¹´ë“œ ìƒì„¸ ì ‘ê¸°/í¼ì¹˜ê¸° */
            .spirit-card-detail-toggle {
                width: 100%;
                padding: 8px;
                background: var(--bg);
                border: none;
                border-radius: 6px;
                cursor: pointer;
                display: flex;
                align-items: center;
                justify-content: center;
                gap: 6px;
                font-size: 0.85rem;
                color: var(--text-muted);
                margin-top: 8px;
            }
            
            .spirit-card-detail-toggle .arrow {
                transition: transform 0.3s;
            }
            
            .spirit-card-detail-toggle.expanded .arrow {
                transform: rotate(180deg);
            }
            
            .spirit-detail-section {
                display: none;
                margin-top: 12px;
                padding-top: 12px;
                border-top: 1px solid var(--border);
            }
            
            .spirit-detail-section.show {
                display: block;
            }
            
            /* í”Œë¡œíŒ… ìŠ¤í¬ë¡¤ ë²„íŠ¼ ìœ„ì¹˜ ì¡°ì • */
            .scroll-buttons {
                bottom: 90px !important;
            }
        }
        
        /* ì„œë¸Œíƒ­ ìŠ¤íƒ€ì¼ */
        .sub-tab {
            padding: 8px 20px;
            margin: 0 8px;
            background: transparent;
            color: var(--text-muted);
            border: none;
            border-bottom: 2px solid transparent;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.2s;
            white-space: nowrap;
        }
        .sub-tab:hover {
            color: var(--text);
        }
        .sub-tab.active {
            color: #f39c12;
            font-weight: 600;
            border-bottom: 2px solid #f39c12;
        }
        
        /* ê¸°ì¡´ ì„¹ì…˜ ë‚´ë¶€ ì„œë¸Œíƒ­ í•­ìƒ ìˆ¨ê¸°ê¸° */
        .mobile-sub-tabs {
            display: none !important;
        }
    </style>
    <!-- Swiper CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css">
    
</head>
<body>
    <!-- ì˜¤í”„ë‹ ìŠ¤í† ë¦¬ íŒì—… -->
    <div id="openingModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 99999; justify-content: center; align-items: center;">
        <div style="max-width: 500px; width: 90%; padding: 40px; text-align: center; display: flex; flex-direction: column; align-items: center;">
            <div style="min-height: 120px; display: flex; align-items: center; justify-content: center;">
                <div id="openingText" style="color: #e0e0e0; font-family: 'Nanum Myeongjo', serif; font-size: 1.1rem; line-height: 2; opacity: 0; transition: opacity 1s; word-break: keep-all;">
                </div>
            </div>
            <div style="height: 80px; display: flex; align-items: flex-start; justify-content: center; padding-top: 20px;">
                <button id="openingNextBtn" onclick="nextOpeningScene()" style="display: none; padding: 12px 40px; background: transparent; border: 1px solid #888; color: #888; font-family: 'Gowun Batang', serif; font-size: 1rem; cursor: pointer; transition: all 0.3s;">
                    ë‹¤ìŒ
                </button>
            </div>
            <button id="openingSkipBtn" onclick="skipOpening()" style="position: absolute; top: 20px; right: 20px; background: none; border: none; color: #666; font-size: 0.9rem; cursor: pointer;">
                ê±´ë„ˆë›°ê¸°
            </button>
        </div>
    </div>

    <!-- ===== ëª¨ë°”ì¼ ê³ ì • í—¤ë” ===== -->
    <div id="mobileHeader" class="mobile-fixed-header" style="display: none;">
        <h1 style="margin: 0;">ë‚˜ì˜ ì‘ì€ í…Œë¼ë¦¬ì›€</h1>
        <button onclick="switchTab('settings')" style="position: absolute; right: 16px; background: none; border: none; cursor: pointer; font-size: 1.2rem;">âš™ï¸</button>
    </div>
    
    <!-- ===== ëª¨ë°”ì¼ ê³ ì • ì±„ì§‘ ì„¹ì…˜ ===== -->
    <div id="mobileGatherSection" class="mobile-fixed-gather" style="display: none;">
        <div class="mobile-gather-main">
            <button class="walk-btn" onclick="goGather()" style="flex: 1; margin: 0;">ì±„ì§‘í•˜ê¸°</button>
        </div>
        <div id="mobileGatherContent" class="mobile-gather-content">
            <div style="margin-bottom: 12px;">
                <label style="font-size: 0.85rem; color: var(--text-muted); margin-bottom: 4px; display: block;">ì¹­í˜¸</label>
                <select id="mobileTitleSelect" onchange="document.getElementById('titleSelect').value = this.value; changeTitle();" style="width: 100%; padding: 8px; border: 1px solid var(--border); border-radius: 6px; background: var(--bg); color: var(--text); font-size: 0.85rem;">
                    <option value="none">ìë™ì±„ì§‘ (í™•ë¥  ì ˆë°˜)</option>
                    <option value="hawk_eye">ë§¤ì˜ ëˆˆ (ëª¨ë“  ì±„ì§‘ë¬¼ í™•ë¥  1.5ë°°)</option>
                    <option value="gatherer">ì±„ì§‘ê¾¼ (ë¨¹ì´ í™•ë¥  2ë°°)</option>
                    <option value="musician">ìŒì•…ê°€ (ë ˆì½”ë“œ í™•ë¥  2ë°°)</option>
                    <option value="collector">ìˆ˜ì§‘ê°€ (í…Œë¼ë¦¬ì›€ ë¬¼í’ˆ í™•ë¥  2ë°°)</option>
                </select>
            </div>
            <div style="margin-bottom: 12px;">
                <label style="font-size: 0.85rem; color: var(--text-muted); margin-bottom: 4px; display: block;">ì±„ì§‘ ì¥ì†Œ</label>
                <select id="mobileLocationSelect" onchange="document.getElementById('gatherLocationSelect').value = this.value; changeGatherLocation();" style="width: 100%; padding: 8px; border: 1px solid var(--border); border-radius: 6px; background: var(--bg); color: var(--text); font-size: 0.85rem;">
                    <option value="garden">ğŸŒ¸ ì •ì› (ëª¨ë“  ì†ì„±)</option>
                    <option value="lake">ğŸŒŠ í˜¸ìˆ˜ (ë¬¼Â·ë°”ëŒ)</option>
                    <option value="forest">ğŸŒ² ìˆ² (ë•…Â·ë¶ˆ)</option>
                </select>
            </div>
            <div style="font-size: 0.9rem; font-weight: 600; margin-bottom: 8px;">ë‚´ ì†Œì§€í’ˆ</div>
            <div id="mobileInventoryDisplay" style="font-size: 0.85rem;"></div>
        </div>
        <button class="mobile-gather-toggle" onclick="toggleMobileGatherSection()">
            <span id="mobileGatherArrow">â–¼</span>
        </button>
    </div>
    
    <!-- ===== ëª¨ë°”ì¼ ì„œë¸Œíƒ­ ë°” (í•˜ë‹¨ íƒ­ ë°” ìœ„ì— í‘œì‹œ) ===== -->
    <div id="mobileSubTabBar" class="mobile-sub-tab-bar" style="display: none;">
        <!-- ìƒì  ì„œë¸Œíƒ­ -->
        <div id="mobileShopSubTabs" style="display: none;">
            <button class="mobile-sub-tab active" onclick="switchShopTab('sell')" data-tab="sell">ğŸ’¸ íŒë§¤</button>
            <button class="mobile-sub-tab" onclick="switchShopTab('buy')" data-tab="buy">ğŸ›’ êµ¬ë§¤</button>
        </div>
        <!-- ì¼ì§€ ì„œë¸Œíƒ­ -->
        <div id="mobileJournalSubTabs" style="display: none;">
            <button class="mobile-sub-tab active" onclick="switchJournalTab('encyclopedia')" data-tab="encyclopedia">ë„ê°</button>
            <button class="mobile-sub-tab" onclick="switchJournalTab('album')" data-tab="album">ì•¨ë²”</button>
            <button class="mobile-sub-tab" onclick="switchJournalTab('achievement')" data-tab="achievement">ì—…ì </button>
            <button class="mobile-sub-tab" onclick="switchJournalTab('memo')" data-tab="memo">ë©”ëª¨</button>
            <button class="mobile-sub-tab" onclick="switchJournalTab('help')" data-tab="help">ë„ì›€ë§</button>
        </div>
    </div>
    
    <!-- ===== ëª¨ë°”ì¼ ê³ ì • íƒ­ë°” ===== -->
    <div id="mobileTabs" class="mobile-fixed-tabs" style="display: none;">
        <button class="tab active" onclick="switchTab('garden')">ìœ¡ì„±</button>
        <button class="tab" onclick="switchTab('terrarium')">í…Œë¼ë¦¬ì›€</button>
        <button class="tab" onclick="switchTab('lab')">ì—°êµ¬ì‹¤</button>
        <button class="tab" onclick="switchTab('shop')">ìƒì  ğŸ’°<span id="mobileCoinDisplay">0</span></button>
        <button class="tab" onclick="switchTab('minigame')">ê²Œì„</button>
        <button class="tab" onclick="switchTab('journal')">ì¼ì§€</button>
        <div class="control-btns">
            <button id="mobilePauseBtn" onclick="togglePause()">â¸ï¸</button>
            <button id="mobileLightBtn" onclick="toggleLight()">â˜€ï¸</button>
        </div>
    </div>

    <!-- ì œëª© ì˜ì—­ (ë°ìŠ¤í¬í†±) -->
    <div class="desktop-header" style="display: flex; justify-content: center; align-items: center; position: relative; margin-bottom: 10px;">
        <h1 style="margin: 0;">ë‚˜ì˜ ì‘ì€ í…Œë¼ë¦¬ì›€</h1>
        <button id="settingsBtn" onclick="switchTab('settings')" style="position: absolute; right: 0; background: none; border: none; cursor: pointer; font-size: 1.2rem; opacity: 0.5;" onmouseover="this.style.opacity='1'" onmouseout="this.style.opacity='0.5'">âš™ï¸</button>
    </div>
    <div class="subtitle desktop-header">Spirit Garden</div>

    <div class="time-display desktop-header" id="timeDisplay"></div>

    <div class="tabs desktop-tabs">
        <button class="tab active" onclick="switchTab('garden')">ìœ¡ì„±</button>
        <button class="tab" onclick="switchTab('terrarium')">í…Œë¼ë¦¬ì›€</button>
        <button class="tab" onclick="switchTab('lab')">ì—°êµ¬ì‹¤</button>
        <button class="tab" onclick="switchTab('shop')">ìƒì  ğŸ’°<span id="coinDisplay">0</span></button>
        <button class="tab" onclick="switchTab('minigame')">ë¯¸ë‹ˆê²Œì„</button>
        <button class="tab" onclick="switchTab('journal')">ì¼ì§€</button>
        <!-- ì¼ì‹œì •ì§€ / ì¡°ëª… ë²„íŠ¼ -->
        <button id="pauseBtn" onclick="togglePause()" style="padding: 8px 12px; background: #ff9800; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 1.2rem; margin-left: auto;">â¸ï¸</button>
        <button id="lightBtn" onclick="toggleLight()" style="padding: 8px 12px; background: #2196F3; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 1.2rem;"><span id="lightIcon">â˜€ï¸</span></button>
    </div>
    
    <!-- ì„œë¸Œíƒ­ ë°” (ìƒì /ì¼ì§€ íƒ­ ì„ íƒ ì‹œ í‘œì‹œ) -->
    <div id="subTabBar" style="display: none; background: transparent; padding: 0; margin-top: -25px; margin-bottom: 20px; text-align: left;">
        <!-- ìƒì  ì„œë¸Œíƒ­ -->
        <div id="shopSubTabs" style="display: none; flex-wrap: nowrap; gap: 0;">
            <button class="sub-tab active" onclick="switchShopTab('sell')" data-tab="sell">íŒë§¤</button>
            <button class="sub-tab" onclick="switchShopTab('buy')" data-tab="buy">êµ¬ë§¤</button>
        </div>
        <!-- ì¼ì§€ ì„œë¸Œíƒ­ -->
        <div id="journalSubTabs" style="display: none; flex-wrap: nowrap; gap: 0;">
            <button class="sub-tab active" onclick="switchJournalTab('encyclopedia')" data-tab="encyclopedia">ë„ê°</button>
            <button class="sub-tab" onclick="switchJournalTab('album')" data-tab="album">ì•¨ë²”</button>
            <button class="sub-tab" onclick="switchJournalTab('achievement')" data-tab="achievement">ì—…ì </button>
            <button class="sub-tab" onclick="switchJournalTab('memo')" data-tab="memo">ë©”ëª¨</button>
            <button class="sub-tab" onclick="switchJournalTab('help')" data-tab="help">ë„ì›€ë§</button>
        </div>
    </div>

    <div id="gardenSection" class="section active">
        <div class="main-layout">
            <div class="inventory-panel">
                <div style="margin-bottom: 16px;">
                    <label for="titleSelect" style="display: block; font-size: 0.9rem; margin-bottom: 6px; color: var(--text); font-weight: 600;">ì¹­í˜¸ ì„ íƒ</label>
                    <select id="titleSelect" onchange="changeTitle()" style="width: 100%; padding: 10px; border: 2px solid var(--border); border-radius: 8px; background: var(--card); color: var(--text); font-size: 0.9rem; cursor: pointer;">
                        <option value="none">ìë™ì±„ì§‘ (í™•ë¥  ì ˆë°˜)</option>
                        <option value="hawk_eye">ë§¤ì˜ ëˆˆ (ëª¨ë“  ì±„ì§‘ë¬¼ í™•ë¥  1.5ë°°)</option>
                        <option value="gatherer">ì±„ì§‘ê¾¼ (ë¨¹ì´ í™•ë¥  2ë°°)</option>
                        <option value="musician">ìŒì•…ê°€ (ë ˆì½”ë“œ í™•ë¥  2ë°°)</option>
                        <option value="collector">ìˆ˜ì§‘ê°€ (í…Œë¼ë¦¬ì›€ ë¬¼í’ˆ í™•ë¥  2ë°°)</option>
                    </select>
                </div>

                <div style="margin-bottom: 16px;">
                    <label for="gatherLocationSelect" style="display: block; font-size: 0.9rem; margin-bottom: 6px; color: var(--text); font-weight: 600;">ì±„ì§‘ ì¥ì†Œ</label>
                    <select id="gatherLocationSelect" onchange="changeGatherLocation()" style="width: 100%; padding: 10px; border: 2px solid var(--border); border-radius: 8px; background: var(--card); color: var(--text); font-size: 0.9rem; cursor: pointer;">
                        <option value="garden">ğŸŒ¸ ì •ì› (ëª¨ë“  ì†ì„±)</option>
                        <option value="lake">ğŸŒŠ í˜¸ìˆ˜ (ë¬¼Â·ë°”ëŒ)</option>
                        <option value="forest">ğŸŒ² ìˆ² (ë•…Â·ë¶ˆ)</option>
                    </select>
                </div>

                <button class="walk-btn" onclick="goGather()" style="margin-bottom: 20px;">ì±„ì§‘í•˜ê¸°</button>

                <div class="inventory-title" onclick="toggleInventoryCollapse()" style="cursor: pointer; display: flex; justify-content: space-between; align-items: center;">
                    <span>ë‚´ ì†Œì§€í’ˆ</span>
                    <span id="inventoryToggleIcon" style="font-size: 0.8rem; color: #888;">â–¼</span>
                </div>
                
                <div id="inventoryContent">
                    <div class="inventory-section">
                        <div class="inventory-label">ğŸ ë¨¹ì´</div>
                        <div class="inventory-items" id="foodInventory">
                            <div class="inventory-item">ì—†ìŒ</div>
                        </div>
                    </div>

                    <div class="inventory-section">
                        <div class="inventory-label">ğŸ¼ ë ˆì½”ë“œ</div>
                        <div class="inventory-items" id="musicInventory">
                            <div class="inventory-item">ì—†ìŒ</div>
                        </div>
                    </div>

                    <div class="inventory-section">
                        <div class="inventory-label">ğŸŒ³ ë¯¸ë‹ˆì–´ì²˜</div>
                        <div class="inventory-items" id="decorInventory">
                            <div class="inventory-item">ì—†ìŒ</div>
                        </div>
                    </div>
                </div>
            </div>

            <div>
                <!-- ëª¨ë°”ì¼ Swiper í˜ì´ì§€ë„¤ì´ì…˜ -->
                <div class="swiper-pagination-container" id="swiperPaginationContainer">
                    <div class="swiper-pagination" id="spiritsPagination"></div>
                </div>
                <!-- PC: ê¸°ì¡´ ê·¸ë¦¬ë“œ / ëª¨ë°”ì¼: Swiper -->
                <div class="swiper spirits-swiper" id="spiritsSwiper">
                    <div class="swiper-wrapper spirits-grid" id="spiritsGrid"></div>
                </div>
                <button class="new-spirit-btn" onclick="createNewSpirit()">+ ìƒˆë¡œìš´ ì•Œ ë°›ê¸°</button>
            </div>
        </div>
    </div>

    <div id="encyclopediaSection" class="section" style="display: none;"></div>

    <div id="albumSection" class="section" style="display: none;"></div>
    
    <!-- ì¼ì§€ ì„¹ì…˜ -->
    <div id="labSection" class="section">
        
        <div style="max-width: 800px; margin: 0 auto;">
            <!-- í•©ì„± ì˜ì—­ -->
            <div style="background: var(--card); border: 1px solid var(--border); padding: 16px; margin-bottom: 20px;">
                <h3 style="font-family: 'Nanum Myeongjo', serif; font-size: 1.2rem; margin-bottom: 15px; text-align: center;">ì¬ë£Œ í•©ì„±</h3>
                
                <div style="display: flex; justify-content: center; align-items: center; gap: 6px; margin-bottom: 15px;">
                    <!-- ìŠ¬ë¡¯ 1 -->
                    <div id="labSlot1" onclick="openLabSlotModal(1)" style="width: 70px; height: 70px; flex-shrink: 0; border: 2px dashed var(--border); display: flex; flex-direction: column; justify-content: center; align-items: center; cursor: pointer; background: var(--bg); transition: all 0.2s;">
                        <div style="font-size: 1.3rem; margin-bottom: 2px;">â•</div>
                        <div style="font-size: 0.65rem; color: #888;">ì¬ë£Œ1</div>
                    </div>
                    
                    <div style="font-size: 1rem; color: #888; flex-shrink: 0;">+</div>
                    
                    <!-- ìŠ¬ë¡¯ 2 -->
                    <div id="labSlot2" onclick="openLabSlotModal(2)" style="width: 70px; height: 70px; flex-shrink: 0; border: 2px dashed var(--border); display: flex; flex-direction: column; justify-content: center; align-items: center; cursor: pointer; background: var(--bg); transition: all 0.2s;">
                        <div style="font-size: 1.3rem; margin-bottom: 2px;">â•</div>
                        <div style="font-size: 0.65rem; color: #888;">ì¬ë£Œ2</div>
                    </div>
                    
                    <div style="font-size: 1rem; color: #888; flex-shrink: 0;">â†’</div>
                    
                    <!-- ê²°ê³¼ ìŠ¬ë¡¯ -->
                    <div id="labResultSlot" style="width: 70px; height: 70px; flex-shrink: 0; border: 2px solid var(--border); display: flex; flex-direction: column; justify-content: center; align-items: center; background: var(--bg);">
                        <div style="font-size: 1.3rem; margin-bottom: 2px;">â“</div>
                        <div style="font-size: 0.65rem; color: #888;">ê²°ê³¼</div>
                    </div>
                </div>
                
                <div style="text-align: center;">
                    <button id="synthesizeBtn" onclick="synthesize()" style="padding: 10px 30px; background: #9b59b6; color: white; border: none; font-size: 0.95rem; font-weight: 700; cursor: pointer; opacity: 0.5;" disabled>
                        ğŸ”® í•©ì„±í•˜ê¸°
                    </button>
                </div>
                
                <div id="labMessage" style="margin-top: 12px; text-align: center; font-size: 0.85rem; color: #888; min-height: 20px;"></div>
            </div>
            
            <!-- ë ˆì‹œí”¼ ëª©ë¡ -->
            <div style="background: var(--card); border: 1px solid var(--border); padding: 24px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 12px;">
                    <h3 style="font-family: 'Nanum Myeongjo', serif; font-size: 1.3rem; margin: 0;">ğŸ“œ ë ˆì‹œí”¼ ëª©ë¡</h3>
                    <div style="display: flex; align-items: center; gap: 8px; flex-wrap: wrap;">
                        <span id="recipeCountDisplay" style="font-size: 0.85rem; color: #888;"></span>
                        <select id="recipeFilterSelect" onchange="applyRecipeFilters()" style="padding: 6px 10px; border: 1px solid var(--border); background: var(--bg); color: var(--text); font-size: 0.85rem; cursor: pointer;">
                            <option value="all">ğŸ“‹ ì „ì²´</option>
                            <option value="food">ğŸ ë¨¹ì´</option>
                            <option value="decoration">ğŸŒ³ ë¯¸ë‹ˆì–´ì²˜</option>
                            <option value="music">ğŸµ ë ˆì½”ë“œ</option>
                        </select>
                        <select id="recipeAttrFilter" onchange="applyRecipeFilters()" style="padding: 6px 10px; border: 1px solid var(--border); background: var(--bg); color: var(--text); font-size: 0.85rem; cursor: pointer;">
                            <option value="all">ì†ì„±</option>
                            <option value="fire">ğŸ”¥ ë¶ˆ</option>
                            <option value="water">ğŸ’§ ë¬¼</option>
                            <option value="wind">ğŸŒªï¸ ë°”ëŒ</option>
                            <option value="earth">ğŸŒ± ë•…</option>
                            <option value="light">âœ¨ ë¹›</option>
                            <option value="dark">ğŸŒ™ ì–´ë‘ </option>
                            <option value="all_attr">ğŸŒˆ ì „ì†ì„±</option>
                        </select>
                        <select id="recipeQualityFilter" onchange="applyRecipeFilters()" style="padding: 6px 10px; border: 1px solid var(--border); background: var(--bg); color: var(--text); font-size: 0.85rem; cursor: pointer;">
                            <option value="all">í’ˆì§ˆ</option>
                            <option value="common">ì¼ë°˜</option>
                            <option value="rare">ğŸ’ í¬ê·€</option>
                            <option value="epic">â­ ìµœìƒê¸‰</option>
                            <option value="legendary">ğŸ‘‘ ì „ì„¤</option>
                        </select>
                    </div>
                </div>
                
                <div id="recipeList" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 12px;"></div>
            </div>
        </div>
    </div>
    
    <div id="journalSection" class="section">
        
        <!-- ì„œë¸Œíƒ­ ì¸ë±ìŠ¤ (ë°ìŠ¤í¬í†±ì—ì„œëŠ” ìƒë‹¨ ì„œë¸Œíƒ­ ë°”ë¡œ ì´ë™, ëª¨ë°”ì¼ì—ì„œëŠ” ì—¬ê¸° í‘œì‹œ) -->
        <div id="journalOldSubTabs" class="mobile-sub-tabs" style="display: none; justify-content: center; gap: 8px; margin-bottom: 25px; flex-wrap: wrap; padding-top: 10px;">
            <button id="journalTabEncyclopedia" onclick="switchJournalTab('encyclopedia')" style="padding: 10px 20px; background: #9b59b6; color: white; border: none; border-radius: 20px; font-size: 0.9rem; font-weight: 600; cursor: pointer;">ğŸ“š ë„ê°</button>
            <button id="journalTabAlbum" onclick="switchJournalTab('album')" style="padding: 10px 20px; background: var(--bg); color: var(--text); border: 1px solid var(--border); border-radius: 20px; font-size: 0.9rem; font-weight: 600; cursor: pointer;">ğŸ’ ì•¨ë²”</button>
            <button id="journalTabAchievement" onclick="switchJournalTab('achievement')" style="padding: 10px 20px; background: var(--bg); color: var(--text); border: 1px solid var(--border); border-radius: 20px; font-size: 0.9rem; font-weight: 600; cursor: pointer;">ğŸ… ì—…ì </button>
            <button id="journalTabMemo" onclick="switchJournalTab('memo')" style="padding: 10px 20px; background: var(--bg); color: var(--text); border: 1px solid var(--border); border-radius: 20px; font-size: 0.9rem; font-weight: 600; cursor: pointer;">ğŸ“ ë©”ëª¨</button>
            <button id="journalTabHelp" onclick="switchJournalTab('help')" style="padding: 10px 20px; background: var(--bg); color: var(--text); border: 1px solid var(--border); border-radius: 20px; font-size: 0.9rem; font-weight: 600; cursor: pointer;">â“ ë„ì›€ë§</button>
        </div>
        
        <!-- ë„ê° íƒ­ -->
        <div id="journalEncyclopediaTab">
            <div class="encyclopedia-grid" id="encyclopediaGrid"></div>
        </div>
        
        <!-- ì•¨ë²” íƒ­ -->
        <div id="journalAlbumTab" style="display: none;">
            <div class="collection-grid" id="collectionGrid"></div>
        </div>
        
        <!-- ì—…ì  íƒ­ -->
        <div id="journalAchievementTab" style="display: none; max-width: 700px; margin: 0 auto;">
            <!-- ì—…ì  ìš”ì•½ -->
            <div style="background: var(--card); padding: 24px; border: 1px solid var(--border); border-radius: 12px; margin-bottom: 20px;">
                <h3 style="font-family: 'Nanum Myeongjo', serif; font-size: 1.3rem; margin-bottom: 16px; color: var(--text);">ğŸ… ì—…ì  í˜„í™©</h3>
                <div id="achievementSummary" style="display: flex; gap: 20px; justify-content: center; flex-wrap: wrap;">
                    <!-- ìë°”ìŠ¤í¬ë¦½íŠ¸ë¡œ ì±„ì›Œì§ -->
                </div>
            </div>
            
            <!-- í‚¤ìš´ ì •ë ¹ ìˆ˜ ì—…ì  -->
            <div style="background: var(--card); padding: 24px; border: 1px solid var(--border); border-radius: 12px; margin-bottom: 20px;">
                <h3 style="font-family: 'Nanum Myeongjo', serif; font-size: 1.3rem; margin-bottom: 16px; color: var(--text);">
                    ğŸ¦‹ í‚¤ìš´ ì •ë ¹ì˜ ìˆ˜
                    <span id="albumCountDisplay" style="font-size: 0.9rem; color: #888; font-weight: normal; margin-left: 10px;"></span>
                </h3>
                <div id="albumAchievements" style="display: flex; flex-direction: column; gap: 12px;">
                    <!-- ìë°”ìŠ¤í¬ë¦½íŠ¸ë¡œ ì±„ì›Œì§ -->
                </div>
            </div>
            
            <!-- ë„ê° ìˆ˜ì§‘ ì—…ì  -->
            <div style="background: var(--card); padding: 24px; border: 1px solid var(--border); border-radius: 12px; margin-bottom: 20px;">
                <h3 style="font-family: 'Nanum Myeongjo', serif; font-size: 1.3rem; margin-bottom: 16px; color: var(--text);">
                    ğŸ“š ë„ê° ìˆ˜ì§‘
                    <span id="encyclopediaCountDisplay" style="font-size: 0.9rem; color: #888; font-weight: normal; margin-left: 10px;"></span>
                </h3>
                <div id="encyclopediaAchievements" style="display: flex; flex-direction: column; gap: 12px;">
                    <!-- ìë°”ìŠ¤í¬ë¦½íŠ¸ë¡œ ì±„ì›Œì§ -->
                </div>
            </div>
            
            <!-- ë ˆì‹œí”¼ ë°œê²¬ ì—…ì  -->
            <div style="background: var(--card); padding: 24px; border: 1px solid var(--border); border-radius: 12px; margin-bottom: 20px;">
                <h3 style="font-family: 'Nanum Myeongjo', serif; font-size: 1.3rem; margin-bottom: 16px; color: var(--text);">
                    ğŸ§ª ë ˆì‹œí”¼ ë°œê²¬
                    <span id="recipeCountDisplay" style="font-size: 0.9rem; color: #888; font-weight: normal; margin-left: 10px;"></span>
                </h3>
                <div id="recipeAchievements" style="display: flex; flex-direction: column; gap: 12px;">
                    <!-- ìë°”ìŠ¤í¬ë¦½íŠ¸ë¡œ ì±„ì›Œì§ -->
                </div>
            </div>
            
            <!-- íŠ¹ë³„ ì—…ì  -->
            <div style="background: var(--card); padding: 24px; border: 1px solid var(--border); border-radius: 12px; margin-bottom: 20px;">
                <h3 style="font-family: 'Nanum Myeongjo', serif; font-size: 1.3rem; margin-bottom: 16px; color: var(--text);">
                    ğŸ… íŠ¹ë³„ ì—…ì 
                    <span id="specialCountDisplay" style="font-size: 0.9rem; color: #888; font-weight: normal; margin-left: 10px;"></span>
                </h3>
                <div id="specialAchievements" style="display: flex; flex-direction: column; gap: 12px;">
                    <!-- ìë°”ìŠ¤í¬ë¦½íŠ¸ë¡œ ì±„ì›Œì§ -->
                </div>
            </div>
        </div>
        
        <!-- ë©”ëª¨ íƒ­ -->
        <div id="journalMemoTab" style="display: none; max-width: 700px; margin: 0 auto;">
            <div style="background: var(--card); padding: 60px 24px; border: 1px solid var(--border); border-radius: 12px; text-align: center;">
                <div style="font-size: 4rem; margin-bottom: 20px;">ğŸš§</div>
                <p style="font-size: 1.2rem; color: var(--text-muted); font-family: 'Gowun Batang', serif;">ì¤€ë¹„ì¤‘...</p>
                <p style="font-size: 0.9rem; color: #888; margin-top: 12px;">ìŠ¤í† ë¦¬ ì¶”ê°€ ì˜ˆì •</p>
            </div>
        </div>
        
        <!-- ë„ì›€ë§ íƒ­ -->
        <div id="journalHelpTab" style="display: none; max-width: 700px; margin: 0 auto;">
            <!-- íŠœí† ë¦¬ì–¼ ë‹¤ì‹œë³´ê¸° -->
            <div style="background: var(--card); padding: 24px; border: 1px solid var(--border); border-radius: 12px; margin-bottom: 20px;">
                <h3 style="font-family: 'Nanum Myeongjo', serif; font-size: 1.3rem; margin-bottom: 20px; color: var(--text);">ğŸ“– íŠœí† ë¦¬ì–¼ ë‹¤ì‹œë³´ê¸°</h3>
                <p style="font-size: 0.9rem; color: #888; margin-bottom: 16px;">ê²Œì„ í”Œë ˆì´ì— ë„ì›€ì´ ë˜ëŠ” íŠœí† ë¦¬ì–¼ì„ ë‹¤ì‹œ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤. íŠœí† ë¦¬ì–¼ì„ ëê¹Œì§€ ì™„ë£Œí•˜ë©´ ë³´ìƒì„ ë°›ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
                
                <div id="tutorialReplayList" style="display: flex; flex-direction: column; gap: 12px;">
                    <!-- ë™ì ìœ¼ë¡œ ë Œë”ë§ë¨ -->
                </div>
            </div>
        </div>
    </div>
    
    <!-- ì„¤ì • ì„¹ì…˜ -->
    <div id="settingsSection" class="section">
        <h2 style="text-align: center; font-family: 'Nanum Myeongjo', serif; font-size: 2rem; margin-bottom: 30px;">ì„¤ì •</h2>
        
        <div style="max-width: 600px; margin: 0 auto;">
            <!-- ë°ì´í„° ê´€ë¦¬ -->
            <div style="background: var(--card); padding: 24px; border: 1px solid var(--border); border-radius: 12px; margin-bottom: 20px;">
                <h3 style="font-family: 'Nanum Myeongjo', serif; font-size: 1.3rem; margin-bottom: 20px; color: var(--text);">ë°ì´í„° ê´€ë¦¬</h3>
                
                <div style="display: flex; flex-direction: column; gap: 12px;">
                    <button onclick="exportGameData()" style="padding: 14px; background: var(--water); color: white; border: none; border-radius: 8px; font-size: 1rem; font-weight: 700; cursor: pointer;">
                        ê²Œì„ ë°ì´í„° ë‚´ë³´ë‚´ê¸°
                    </button>
                    
                    <button onclick="importGameData()" style="padding: 14px; background: var(--wind); color: white; border: none; border-radius: 8px; font-size: 1rem; font-weight: 700; cursor: pointer;">
                        ê²Œì„ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°
                    </button>
                    
                    <button onclick="manualRebuildEncyclopedia()" style="padding: 14px; background: var(--earth); color: white; border: none; border-radius: 8px; font-size: 1rem; font-weight: 700; cursor: pointer;">
                        ì•¨ë²”ì—ì„œ ë„ê° ë³µêµ¬
                    </button>
                    
                    <button onclick="showAlbumBackupRestore()" style="padding: 14px; background: #e67e22; color: white; border: none; border-radius: 8px; font-size: 1rem; font-weight: 700; cursor: pointer;">
                        ì•¨ë²” ë°±ì—… ë³µêµ¬
                    </button>
                    
                    <button onclick="showAlbumRecoveryDialog()" style="padding: 14px; background: #3498db; color: white; border: none; border-radius: 8px; font-size: 1rem; font-weight: 700; cursor: pointer;">
                        ë„ê°ì—ì„œ ì•¨ë²” ë³µêµ¬
                    </button>
                    
                    <button onclick="repairBrokenSpirits()" style="padding: 14px; background: #9b59b6; color: white; border: none; border-radius: 8px; font-size: 1rem; font-weight: 700; cursor: pointer;">
                        ì—°ê²° ì •ë ¹ ê´€ë¦¬
                    </button>
                </div>
                
                <div style="margin-top: 16px; padding: 12px; background: var(--bg); border-radius: 8px; font-size: 0.85rem; color: #888;">
                    ğŸ’¡ ë°ì´í„° ë‚´ë³´ë‚´ê¸°ë¥¼ í†µí•´ ê²Œì„ ì§„í–‰ìƒí™©ì„ ë°±ì—…í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.<br>
                    ë‹¤ë¥¸ ê¸°ê¸°ë‚˜ ë¸Œë¼ìš°ì €ì—ì„œ ë¶ˆëŸ¬ì˜¤ê¸°ë¥¼ í†µí•´ ë³µì›í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.<br>
                    ğŸ“š ì•¨ë²” ë°±ì—… ë³µêµ¬: ì •ë ¹ ì™„ì„± ì‹œ ìë™ ì €ì¥ëœ ë°±ì—…ì—ì„œ ì•¨ë²”ì„ ë³µêµ¬í•©ë‹ˆë‹¤.<br>
                    ğŸ“– ë„ê°ì—ì„œ ì•¨ë²” ë³µêµ¬: ë„ê°ì—ëŠ” ìˆì§€ë§Œ ì•¨ë²”ì— ì—†ëŠ” ì •ë ¹ì„ ë³µêµ¬í•©ë‹ˆë‹¤.
                </div>
            </div>
            
            <!-- í™”ë©´ ì„¤ì • -->
            <div style="background: var(--card); padding: 24px; border: 1px solid var(--border); border-radius: 12px; margin-bottom: 20px;">
                <h3 style="font-family: 'Nanum Myeongjo', serif; font-size: 1.3rem; margin-bottom: 20px; color: var(--text);">í™”ë©´ ì„¤ì •</h3>
                
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: var(--bg); border-radius: 8px; margin-bottom: 12px;">
                    <div>
                        <div style="font-weight: 700; margin-bottom: 4px;">ë¼ì´íŠ¸ ëª¨ë“œ ê³ ì •</div>
                        <div style="font-size: 0.85rem; color: #888;">í™œì„±í™” ì‹œ ì¡°ëª… ìƒíƒœì™€ ë¬´ê´€í•˜ê²Œ ë¼ì´íŠ¸ ëª¨ë“œ ìœ ì§€</div>
                    </div>
                    <label style="position: relative; display: inline-block; width: 60px; height: 32px;">
                        <input type="checkbox" id="lightModeToggle" onchange="toggleLightModeLock()" style="opacity: 0; width: 0; height: 0;">
                        <span style="position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 32px;">
                            <span id="lightModeSlider" style="position: absolute; content: ''; height: 24px; width: 24px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%;"></span>
                        </span>
                    </label>
                </div>
                
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: var(--bg); border-radius: 8px;">
                    <div>
                        <div style="font-weight: 700; margin-bottom: 4px;">ë‹¤í¬ ëª¨ë“œ ê³ ì •</div>
                        <div style="font-size: 0.85rem; color: #888;">í™œì„±í™” ì‹œ ì¡°ëª… ìƒíƒœì™€ ë¬´ê´€í•˜ê²Œ ë‹¤í¬ ëª¨ë“œ ìœ ì§€</div>
                    </div>
                    <label style="position: relative; display: inline-block; width: 60px; height: 32px;">
                        <input type="checkbox" id="darkModeToggle" onchange="toggleDarkModeLock()" style="opacity: 0; width: 0; height: 0;">
                        <span style="position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 32px;">
                            <span id="darkModeSlider" style="position: absolute; content: ''; height: 24px; width: 24px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%;"></span>
                        </span>
                    </label>
                </div>
            </div>
            
            <!-- ì´ë²¤íŠ¸ ì½”ë“œ -->
            <div style="background: var(--card); padding: 24px; border: 1px solid var(--border); border-radius: 12px; margin-bottom: 20px;">
                <h3 style="font-family: 'Nanum Myeongjo', serif; font-size: 1.3rem; margin-bottom: 20px; color: var(--text);">ì´ë²¤íŠ¸ ì½”ë“œ</h3>
                
                <p style="font-size: 0.9rem; color: #888; margin-bottom: 16px;">ì´ë²¤íŠ¸ ì½”ë“œë¥¼ ì…ë ¥í•˜ë©´ ì‹œì¦Œ ì •ë ¹ ì•Œì„ ë°›ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤!</p>
                
                <div style="display: flex; gap: 8px; margin-bottom: 12px;">
                    <input type="text" id="eventCodeInput" placeholder="SGEVENT-ë¡œ ì‹œì‘í•˜ëŠ” ì½”ë“œ ì…ë ¥..." style="flex: 1; padding: 12px; border: 1px solid var(--border); border-radius: 6px; background: var(--bg); color: var(--text); font-family: monospace;">
                    <button onclick="redeemEventCode()" style="padding: 12px 20px; background: #333; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 700;">
                        ì‚¬ìš©
                    </button>
                </div>
            </div>
            
            <!-- ê²Œì„ ì´ˆê¸°í™” -->
            <div style="background: var(--card); padding: 24px; border: 1px solid var(--border); border-radius: 12px; margin-bottom: 20px;">
                <h3 style="font-family: 'Nanum Myeongjo', serif; font-size: 1.3rem; margin-bottom: 20px; color: var(--text);">ê²Œì„ ì´ˆê¸°í™”</h3>
                
                <button onclick="resetGame()" style="width: 100%; padding: 14px; background: #e74c3c; color: white; border: none; border-radius: 8px; font-size: 1rem; font-weight: 700; cursor: pointer;">
                    ğŸ”„ ê²Œì„ ì´ˆê¸°í™”
                </button>
                
                <div style="margin-top: 16px; padding: 12px; background: var(--bg); border-radius: 8px; font-size: 0.85rem; color: #e74c3c;">
                    âš ï¸ ì£¼ì˜: ëª¨ë“  ì •ë ¹, ì•„ì´í…œ, ì§„í–‰ ìƒí™©ì´ ì‚­ì œë©ë‹ˆë‹¤.<br>
                    ì´ˆê¸°í™” ì „ ë°ì´í„° ë‚´ë³´ë‚´ê¸°ë¥¼ ê¶Œì¥í•©ë‹ˆë‹¤.
                </div>
            </div>
            
            <!-- ê²Œì„ ì •ë³´ -->
            <div style="background: var(--card); padding: 24px; border: 1px solid var(--border); border-radius: 12px;">
                <h3 style="font-family: 'Nanum Myeongjo', serif; font-size: 1.3rem; margin-bottom: 20px; color: var(--text);">ê²Œì„ ì •ë³´</h3>
                
                <div style="display: flex; flex-direction: column; gap: 12px; font-size: 0.9rem; color: var(--text);">
                    <div style="display: flex; justify-content: space-between; padding: 8px 0;">
                        <span>ë²„ì „</span>
                        <span style="font-weight: 700;">ë² íƒ€</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-top: 1px solid var(--border);">
                        <span>ê²Œì„ ê´€ë ¨ ë¬¸ì˜</span>
                        <a href="https://forms.gle/MSVctTQWDBScWZb27" target="_blank" style="color: var(--water); text-decoration: none; font-weight: 600;">ë¬¸ì˜í•˜ê¸°</a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ì•¨ë²” ìƒì„¸ ì •ë³´ ëª¨ë‹¬ -->
    <div id="albumDetailModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 10000; justify-content: center; align-items: center;">
        <div id="albumDetailContent" style="background: var(--card); border: 2px solid var(--border); border-radius: 12px; padding: 30px; max-width: 500px; width: 90%; max-height: 80vh; overflow-y: auto;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2 id="modalTitle" style="font-family: 'Nanum Myeongjo', serif; font-size: 1.5rem; color: var(--text); margin: 0;"></h2>
                <button onclick="closeAlbumDetail()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--text);">âœ•</button>
            </div>
            <div id="modalContent"></div>
            <div style="margin-top: 15px; text-align: center;">
                <button onclick="saveAlbumDetailImage()" style="padding: 10px 20px; background: var(--water); color: white; border: none; border-radius: 8px; font-size: 0.9rem; font-weight: 600; cursor: pointer;">
                    ğŸ“· ì´ë¯¸ì§€ë¡œ ì €ì¥
                </button>
            </div>
        </div>
    </div>

    <div id="shopSection" class="section">
        <div style="max-width: 1000px; margin: 0 auto;">
            <!-- ìƒì  ì£¼ì¸ ëŒ€ì‚¬ -->
            <div id="shopkeeperArea" style="background: var(--card); border: 1px solid var(--border); border-radius: 12px; padding: 20px; margin-bottom: 20px; display: flex; align-items: center; gap: 15px;">
                <div>
                    <img src="https://raw.githubusercontent.com/mongyeonlab-cpu/mylittleterrarium/main/images/NPC_%EC%83%81%EC%A0%90%EC%A3%BC%EC%9D%B8.png" alt="ìƒì  ì£¼ì¸" style="width: 150px; height: 150px; object-fit: cover;">
                </div>
                <div style="flex: 1;">
                    <div style="font-size: 1rem; font-weight: 600; color: var(--fire); margin-bottom: 8px;">ìƒì  ì£¼ì¸</div>
                    <div style="font-family: 'Gowun Batang', serif; font-size: 1.1rem; color: var(--text); font-style: italic;" id="shopkeeperDialogue">
                        ì–´ì„œì˜¤ì„¸ìš”...
                    </div>
                </div>
            </div>
            
            <!-- ìƒì  íƒ­ (ë°ìŠ¤í¬í†±ì—ì„œëŠ” ìƒë‹¨ ì„œë¸Œíƒ­ ë°”ë¡œ ì´ë™, ëª¨ë°”ì¼ì—ì„œëŠ” ì—¬ê¸° í‘œì‹œ) -->
            <div id="shopOldSubTabs" class="mobile-sub-tabs" style="display: none; gap: 10px; margin-bottom: 20px; justify-content: center;">
                <button id="shopTabSell" onclick="switchShopTab('sell')" style="padding: 12px 30px; font-size: 1rem; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; background: var(--fire); color: white;">ğŸ’¸ íŒë§¤</button>
                <button id="shopTabBuy" onclick="switchShopTab('buy')" style="padding: 12px 30px; font-size: 1rem; border: 1px solid var(--border); border-radius: 8px; cursor: pointer; font-weight: 600; background: var(--card); color: var(--text);">ğŸ›’ êµ¬ë§¤</button>
            </div>
            
            <div style="text-align: center; margin-bottom: 20px;">
                
                <!-- ì¹´í…Œê³ ë¦¬ ì„ íƒ ë“œë¡­ë‹¤ìš´ -->
                <select id="shopCategorySelect" onchange="changeShopCategory()" style="padding: 12px 20px; font-size: 1rem; border: 2px solid var(--border); border-radius: 8px; background: var(--card); color: var(--text); cursor: pointer; min-width: 200px;">
                    <option value="all">ğŸ“¦ ì „ì²´</option>
                    <option value="food">ğŸ ë¨¹ì´</option>
                    <option value="decoration">ğŸŒ³ ë¯¸ë‹ˆì–´ì²˜</option>
                    <option value="music">ë ˆì½”ë“œ</option>
                </select>
            </div>

            <!-- íŒë§¤ í˜ì´ì§€ -->
            <div id="shopSellPage" style="display: block;">
                <div class="shop-section" style="background: var(--card); border: 1px solid var(--border); padding: 32px; border-radius: 12px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h3 style="font-family: 'Nanum Myeongjo', serif; font-size: 1.3rem; margin: 0; color: var(--fire);">ğŸ’¸ íŒë§¤í•˜ê¸°</h3>
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <button id="lockModeBtn" onclick="toggleLockMode()" style="padding: 8px 12px; font-size: 0.9rem; border: 1px solid var(--border); border-radius: 6px; background: var(--card); color: var(--text); cursor: pointer;" title="ì ê¸ˆ ëª¨ë“œ ì „í™˜">ğŸ”“</button>
                            <select id="sellFilterSelect" onchange="changeSellFilter()" style="padding: 8px 12px; font-size: 0.9rem; border: 1px solid var(--border); border-radius: 6px; background: var(--card); color: var(--text); cursor: pointer;">
                            <option value="all">ì „ì²´</option>
                            <option value="fire">ğŸ”¥ ë¶ˆ</option>
                            <option value="water">ğŸ’§ ë¬¼</option>
                            <option value="wind">ğŸŒ¬ï¸ ë°”ëŒ</option>
                            <option value="earth">ğŸŒ± ë•…</option>
                            <option value="light">âœ¨ ë¹›</option>
                            <option value="dark">ğŸŒ™ ì–´ë‘ </option>
                            <option value="intelligence">ğŸ§  ì§€ë ¥</option>
                            <option value="strength">ğŸ’ª ì²´ë ¥</option>
                            <option value="charm">ğŸ’– ë§¤ë ¥</option>
                            <option value="etc">ğŸ“¦ ê¸°íƒ€</option>
                        </select>
                        </div>
                    </div>
                    <div id="sellList"></div>
                </div>
            </div>

            <!-- êµ¬ë§¤ í˜ì´ì§€ -->
            <div id="shopBuyPage" style="display: none;">
                <div class="shop-section" style="background: var(--card); border: 1px solid var(--border); padding: 32px; border-radius: 12px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h3 style="font-family: 'Nanum Myeongjo', serif; font-size: 1.3rem; margin: 0; color: var(--water);">ğŸ›’ êµ¬ë§¤í•˜ê¸°</h3>
                        <select id="buyFilterSelect" onchange="changeBuyFilter()" style="padding: 8px 12px; font-size: 0.9rem; border: 1px solid var(--border); border-radius: 6px; background: var(--card); color: var(--text); cursor: pointer;">
                            <option value="all">ì „ì²´</option>
                            <option value="fire">ğŸ”¥ ë¶ˆ</option>
                            <option value="water">ğŸ’§ ë¬¼</option>
                            <option value="wind">ğŸŒ¬ï¸ ë°”ëŒ</option>
                            <option value="earth">ğŸŒ± ë•…</option>
                            <option value="light">âœ¨ ë¹›</option>
                            <option value="dark">ğŸŒ™ ì–´ë‘ </option>
                            <option value="intelligence">ğŸ§  ì§€ë ¥</option>
                            <option value="strength">ğŸ’ª ì²´ë ¥</option>
                            <option value="charm">ğŸ’– ë§¤ë ¥</option>
                            <option value="etc">ğŸ“¦ ê¸°íƒ€</option>
                        </select>
                    </div>
                    <div id="buyList"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- ë¯¸ë‹ˆê²Œì„ ì„¹ì…˜ -->
    <div id="minigameSection" class="section">
        <div style="max-width: 800px; margin: 0 auto;">
            
            <!-- ê²Œì„ ì‹œì‘ ì „ í™”ë©´ -->
            <div id="minigameIntro" style="background: var(--card); border: 1px solid var(--border); padding: 40px; text-align: center;">
                <div style="font-size: 4rem; margin-bottom: 20px;">ğŸ›¡ï¸</div>
                <h3 style="font-family: 'Nanum Myeongjo', serif; font-size: 1.5rem; margin-bottom: 20px;">ê²Œì„ ë°©ë²•</h3>
                <div style="text-align: left; max-width: 400px; margin: 0 auto 30px; line-height: 1.8; color: var(--text);">
                    <p>â€¢ ìœ„ì—ì„œ í•´ì¶©ê³¼ ë…ë²„ì„¯ì´ ë–¨ì–´ì§‘ë‹ˆë‹¤</p>
                    <p>â€¢ ë‹¨ì–´ë¥¼ íƒ€ì´í•‘í•´ì„œ ì œê±°í•˜ì„¸ìš”</p>
                    <p>â€¢ ë°”ë‹¥ì— ë‹¿ìœ¼ë©´ ì •ë ¹ì´ ë‹¤ì¹©ë‹ˆë‹¤</p>
                    <p>â€¢ ëª©ìˆ¨ 3ê°œê°€ ëª¨ë‘ ì†Œì§„ë˜ë©´ ê²Œì„ ì˜¤ë²„!</p>
                </div>
                <div style="margin-bottom: 20px;">
                    <label style="font-weight: 600; margin-right: 10px;">ë‚œì´ë„:</label>
                    <select id="minigameDifficulty" style="padding: 10px 20px; font-size: 1rem; border: 2px solid var(--border); border-radius: 8px; background: var(--card); color: var(--text);">
                        <option value="easy" selected>ì‰¬ì›€</option>
                        <option value="hard">ì–´ë ¤ì›€ (ë³´ìƒ 2ë°°)</option>
                    </select>
                </div>
                <button onclick="startMinigame()" style="padding: 16px 48px; font-size: 1.2rem; font-weight: 700; background: var(--fire); color: white; border: none; border-radius: 12px; cursor: pointer;">
                    ê²Œì„ ì‹œì‘
                </button>
            </div>
            
            <!-- ê²Œì„ í”Œë ˆì´ í™”ë©´ -->
            <div id="minigamePlay" style="display: none;">
                <!-- ê²Œì„ ìƒíƒœ ë°” -->
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; padding: 15px 20px; background: var(--card); border: 1px solid var(--border); border-radius: 8px;">
                    <div style="font-size: 1.2rem;">
                        <span style="color: #e74c3c;">â¤ï¸</span> 
                        <span id="minigameLives">â¤ï¸â¤ï¸â¤ï¸</span>
                    </div>
                    <div style="font-size: 1.3rem; font-weight: 700; color: var(--fire);">
                        â±ï¸ <span id="minigameTimer">60</span>ì´ˆ
                    </div>
                    <div style="font-size: 1.3rem; font-weight: 700; color: var(--text);">
                        ì ìˆ˜: <span id="minigameScore">0</span>
                    </div>
                    <button onclick="endMinigame()" style="padding: 8px 16px; background: #888; color: white; border: none; border-radius: 6px; cursor: pointer;">í¬ê¸°</button>
                </div>
                
                <!-- ê²Œì„ ì˜ì—­ -->
                <div id="minigameArea" style="position: relative; width: 100%; height: 500px; background: linear-gradient(180deg, #87CEEB 0%, #E0F6FF 50%, #90EE90 95%, #228B22 100%); border: 3px solid var(--border); border-radius: 12px; overflow: hidden; user-select: none;">
                    <!-- ë–¨ì–´ì§€ëŠ” ë‹¨ì–´ë“¤ì´ ì—¬ê¸°ì— ìƒì„±ë¨ -->
                    
                    <!-- ì •ë ¹ (í•˜ë‹¨) -->
                    <div id="minigameSpirit" style="position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%); font-size: 4rem; transition: all 0.3s; filter: drop-shadow(0 4px 8px rgba(0,0,0,0.3));">
                        ğŸ›
                    </div>
                    
                    <!-- ë³´í˜¸ë§‰ ì´í™íŠ¸ -->
                    <div id="shieldEffect" style="position: absolute; bottom: 10px; left: 50%; transform: translateX(-50%); width: 120px; height: 120px; border-radius: 50%; background: radial-gradient(circle, rgba(100,200,255,0.3) 0%, transparent 70%); opacity: 0; transition: opacity 0.2s;"></div>
                </div>
                
                <!-- ì…ë ¥ ì˜ì—­ -->
                <div style="margin-top: 15px;">
                    <input type="text" id="minigameInput" placeholder="ë‹¨ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš”..." autocomplete="off" autocapitalize="off" spellcheck="false" lang="ko"
                        style="width: 100%; padding: 18px 24px; font-size: 1.3rem; border: 3px solid var(--border); border-radius: 12px; text-align: center; font-family: 'Gowun Batang', serif; background: var(--card); color: var(--text); box-sizing: border-box; ime-mode: active;">
                </div>
            </div>
            
            <!-- ê²Œì„ ê²°ê³¼ í™”ë©´ -->
            <div id="minigameResult" style="display: none; background: var(--card); border: 1px solid var(--border); padding: 40px; text-align: center;">
                <div id="resultIcon" style="font-size: 5rem; margin-bottom: 20px;">ğŸ‰</div>
                <h3 id="resultTitle" style="font-family: 'Nanum Myeongjo', serif; font-size: 1.8rem; margin-bottom: 15px;">ê²Œì„ ì¢…ë£Œ!</h3>
                <div style="font-size: 1.5rem; margin-bottom: 10px; color: var(--text);">
                    ìµœì¢… ì ìˆ˜: <span id="finalScore" style="font-weight: 700; color: var(--fire);">0</span>
                </div>
                <div style="font-size: 1.1rem; margin-bottom: 30px; color: #888;">
                    ì²˜ì¹˜í•œ í•´ì¶©: <span id="defeatedCount">0</span>ë§ˆë¦¬
                </div>
                
                <!-- ë³´ìƒ ì„ íƒ -->
                <div id="rewardSection" style="margin-bottom: 30px;">
                    <h4 style="font-size: 1.2rem; margin-bottom: 20px; color: var(--text);">ë³´ìƒì„ ì„ íƒí•˜ì„¸ìš”</h4>
                    <div style="display: flex; gap: 20px; justify-content: center; flex-wrap: wrap;">
                        <button onclick="claimReward('coin')" class="reward-btn" style="padding: 20px 30px; background: linear-gradient(135deg, #FFD700, #FFA500); color: #333; border: none; border-radius: 12px; cursor: pointer; min-width: 150px;">
                            <div style="font-size: 2rem; margin-bottom: 8px;">ğŸ’°</div>
                            <div style="font-weight: 700;">ì½”ì¸ ë°›ê¸°</div>
                            <div id="coinRewardAmount" style="font-size: 0.9rem; margin-top: 4px;">+0</div>
                        </button>
                        <button onclick="claimReward('item')" class="reward-btn" style="padding: 20px 30px; background: linear-gradient(135deg, #9B59B6, #8E44AD); color: white; border: none; border-radius: 12px; cursor: pointer; min-width: 150px;">
                            <div style="font-size: 2rem; margin-bottom: 8px;">ğŸ</div>
                            <div style="font-weight: 700;">ì•„ì´í…œ ë°›ê¸°</div>
                            <div style="font-size: 0.9rem; margin-top: 4px;">ëœë¤ ë³´ìƒ</div>
                        </button>
                    </div>
                </div>
                
                <button onclick="backToMinigameIntro()" style="padding: 14px 40px; font-size: 1rem; background: var(--border); color: var(--text); border: none; border-radius: 8px; cursor: pointer;">
                    ëŒì•„ê°€ê¸°
                </button>
            </div>
        </div>
    </div>

    <div id="terrariumSection" class="section">
        <div style="max-width: 800px; margin: 0 auto;">
            <!-- í…Œë¼ë¦¬ì›€ í™˜ê²½ -->
            <div style="background: var(--card); border: 1px solid var(--border); padding: 32px; margin-bottom: 20px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2 style="font-family: 'Nanum Myeongjo', serif; font-size: 1.5rem; margin: 0;">í…Œë¼ë¦¬ì›€ í™˜ê²½</h2>
                    <div style="display: flex; align-items: center; gap: 8px; padding: 8px 16px; background: #f0f0f0; border-radius: 8px;" title="ë¯¸ë‹ˆì–´ì²˜ í’ˆì§ˆì˜ í•©ê³„ (ë¯¸ë‹ˆì–´ì²˜ë¥¼ ì¶”ê°€í• ìˆ˜ë¡ ì˜¬ë¼ê°)">
                        <span style="font-weight: 600; color: #666;">í’ˆì§ˆ í•©ê³„:</span>
                        <span id="terrariumQuality" style="font-size: 1.2rem; font-weight: 700; color: #ff9800;">0.0</span>
                    </div>
                </div>
                <div class="env-bars" style="display: grid; gap: 12px;">
                    <div class="env-bar" style="display: flex; align-items: center; gap: 12px;">
                        <span style="font-size: 1.5rem;">ğŸ”¥</span>
                        <div class="env-bar-bg" style="flex: 1; height: 12px; background: var(--border);">
                            <div class="env-bar-fill" id="terrFireBar" style="height: 100%; background: var(--fire); width: 0%;"></div>
                        </div>
                        <span id="terrFireValue" style="min-width: 30px; text-align: right;">0</span>
                    </div>
                    <div class="env-bar" style="display: flex; align-items: center; gap: 12px;">
                        <span style="font-size: 1.5rem;">ğŸ’§</span>
                        <div class="env-bar-bg" style="flex: 1; height: 12px; background: var(--border);">
                            <div class="env-bar-fill" id="terrWaterBar" style="height: 100%; background: var(--water); width: 0%;"></div>
                        </div>
                        <span id="terrWaterValue" style="min-width: 30px; text-align: right;">0</span>
                    </div>
                    <div class="env-bar" style="display: flex; align-items: center; gap: 12px;">
                        <span style="font-size: 1.5rem;">ğŸŒ¬ï¸</span>
                        <div class="env-bar-bg" style="flex: 1; height: 12px; background: var(--border);">
                            <div class="env-bar-fill" id="terrWindBar" style="height: 100%; background: var(--wind); width: 0%;"></div>
                        </div>
                        <span id="terrWindValue" style="min-width: 30px; text-align: right;">0</span>
                    </div>
                    <div class="env-bar" style="display: flex; align-items: center; gap: 12px;">
                        <span style="font-size: 1.5rem;">ğŸŒ±</span>
                        <div class="env-bar-bg" style="flex: 1; height: 12px; background: var(--border);">
                            <div class="env-bar-fill" id="terrEarthBar" style="height: 100%; background: var(--earth); width: 0%;"></div>
                        </div>
                        <span id="terrEarthValue" style="min-width: 30px; text-align: right;">0</span>
                    </div>
                    <div class="env-bar" style="display: flex; align-items: center; gap: 12px;">
                        <span style="font-size: 1.5rem;">âœ¨</span>
                        <div class="env-bar-bg" style="flex: 1; height: 12px; background: var(--border);">
                            <div class="env-bar-fill" id="terrLightBar" style="height: 100%; background: var(--light); width: 0%;"></div>
                        </div>
                        <span id="terrLightValue" style="min-width: 30px; text-align: right;">0</span>
                    </div>
                    <div class="env-bar" style="display: flex; align-items: center; gap: 12px;">
                        <span style="font-size: 1.5rem;">ğŸŒ™</span>
                        <div class="env-bar-bg" style="flex: 1; height: 12px; background: var(--border);">
                            <div class="env-bar-fill" id="terrDarkBar" style="height: 100%; background: var(--dark); width: 0%;"></div>
                        </div>
                        <span id="terrDarkValue" style="min-width: 30px; text-align: right;">0</span>
                    </div>
                </div>
            </div>

            <!-- ì„¤ì¹˜ëœ ë¯¸ë‹ˆì–´ì²˜ -->
            <div style="background: var(--card); border: 1px solid var(--border); padding: 32px; margin-bottom: 20px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                    <h2 style="font-family: 'Nanum Myeongjo', serif; font-size: 1.5rem; margin: 0;">ì„¤ì¹˜ëœ ë¯¸ë‹ˆì–´ì²˜</h2>
                    <button onclick="removeAllDecorations()" style="padding: 6px 12px; background: var(--fire); color: white; border: none; border-radius: 4px; font-size: 0.85rem; cursor: pointer;">
                        ì „ì²´ í•´ì œ
                    </button>
                </div>
                <div style="font-size: 0.9rem; color: #888; margin-bottom: 20px;">
                    <span id="installedCount">0 / 20</span>
                    <span style="margin-left: 12px;">ğŸ‘‘ ì „ì„¤: <span id="legendaryCount" style="color: #9c27b0; font-weight: 600;">0</span> / 5</span>
                </div>
                <div id="installedDecorList"></div>
            </div>

            <!-- ì¸ë²¤í† ë¦¬ ë¯¸ë‹ˆì–´ì²˜ -->
            <div style="background: var(--card); border: 1px solid var(--border); padding: 32px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2 style="font-family: 'Nanum Myeongjo', serif; font-size: 1.5rem; margin: 0;">ì¸ë²¤í† ë¦¬ ë¯¸ë‹ˆì–´ì²˜</h2>
                    <div id="terrariumFilterArea" style="display: flex; gap: 8px;"></div>
                </div>
                <div id="terrariumDecorList"></div>
            </div>
        </div>
    </div>

    <!-- Name Modal -->
    <div class="modal" id="nameModal">
        <div class="modal-content">
            <div class="modal-title">ì •ë ¹ì˜ ì´ë¦„ì„ ì§€ì–´ì£¼ì„¸ìš”</div>
            <input type="text" class="name-input" id="nameInput" placeholder="ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”" maxlength="10" onkeypress="if(event.key === 'Enter') confirmName()" lang="ko" style="ime-mode: active;">
            <button onclick="confirmName()" style="width: 100%;">í™•ì¸</button>
        </div>
    </div>

    <!-- Feed Modal -->
    <div class="modal" id="feedModal">
        <div class="modal-content">
            <div class="modal-title">ë¬´ì—‡ì„ ë¨¹ì¼ê¹Œìš”?</div>
            <div class="food-grid">
                <!-- ì´ˆê¸° ë”ë¯¸ ë²„íŠ¼ (renderFeedOptions()ë¡œ ë™ì  ìƒì„±ë¨) -->
            </div>
            <button class="close-btn" onclick="closeModal('feedModal')">ë‹«ê¸°</button>
        </div>
    </div>

    <!-- Music Modal -->
    <div class="modal" id="musicModal">
        <div class="modal-content">
            <div class="modal-title">ì–´ë–¤ ìŒì•…ì„ ë“¤ë ¤ì¤„ê¹Œìš”?</div>
            <div id="musicOptions"></div>
            <button class="close-btn" onclick="closeModal('musicModal')">ë‹«ê¸°</button>
        </div>
    </div>

    <!-- Decorate Modal -->
    <div class="modal" id="decorateModal">
        <div class="modal-content">
            <div class="modal-title">í…Œë¼ë¦¬ì›€ ê¾¸ë¯¸ê¸°</div>
            <div id="decorOptions"></div>
            <button class="close-btn" onclick="closeModal('decorateModal')">ë‹«ê¸°</button>
        </div>
    </div>

    <!-- ì»¤ìŠ¤í…€ í™•ì¸ ëª¨ë‹¬ -->
    <div id="confirmModal" class="modal">
        <div class="modal-content" style="max-width: 400px;">
            <h3 id="confirmTitle" style="font-family: 'Nanum Myeongjo', serif; font-size: 1.3rem; margin-bottom: 15px; color: var(--text);"></h3>
            <p id="confirmMessage" style="margin-bottom: 25px; line-height: 1.6; color: var(--text); white-space: pre-line;"></p>
            <div style="display: flex; gap: 10px; justify-content: flex-end;">
                <button id="confirmCancelBtn" style="background: #888; color: white;">ì·¨ì†Œ</button>
                <button id="confirmOkBtn" style="background: var(--fire); color: white;">í™•ì¸</button>
            </div>
        </div>
    </div>

    <script>      let spirits = [];
        let collection = [];
        let encyclopedia = {}; // ë„ê°: { evolutionKey: count }
        let encyclopediaDetails = {}; // ë„ê° ìƒì„¸: { evolutionKey: [ì •ë ¹ ìƒì„¸ ì •ë³´ ë°°ì—´] } - ë³µêµ¬ìš© ìˆ¨ê¹€ ë°ì´í„°
        let darkModeLocked = false; // ë‹¤í¬ ëª¨ë“œ ê³ ì • ì—¬ë¶€
        let lightModeLocked = false; // ë¼ì´íŠ¸ ëª¨ë“œ ê³ ì • ì—¬ë¶€
        let spiritCardExpanded = JSON.parse(localStorage.getItem('spiritGarden_cardExpanded') || '{}'); // ì •ë ¹ ì¹´ë“œ ìƒì„¸ ì •ë³´ í¼ì¹¨ ìƒíƒœ
        let isMobileMode = false; // ëª¨ë°”ì¼ ë ˆì´ì•„ì›ƒ ìƒíƒœ
        let mobileGatherExpanded = false; // ëª¨ë°”ì¼ ì±„ì§‘ ì„¹ì…˜ í¼ì¹¨ ìƒíƒœ
        let inventory = {
            music: [],
            decorations: [],
            food: ['fire', 'fire', 'fire', 'water', 'water', 'water', 'wind', 'wind', 'wind', 'earth', 'earth', 'earth'],
            medicine: [] // ì•½ì´ˆ
        };
        let terrarium = {
            fire: 0,
            water: 0,
            wind: 0,
            earth: 0,
            light: 0,
            dark: 0
        };
        let installedDecorations = []; // ì„¤ì¹˜ëœ ë¯¸ë‹ˆì–´ì²˜ ëª©ë¡ (ê°ì²´ ë°°ì—´: { type, index })
        let lightMode = true; // ì¡°ëª… ëª¨ë“œ (true: ë¹›, false: ì–´ë‘ )
        let coins = 0; // í™”í
        let totalEggsCreated = 0; // ì§€ê¸ˆê¹Œì§€ ìƒì„±ëœ ì•Œì˜ ì´ ê°œìˆ˜
        let hasVisitedShop = false; // ìƒì  ì²« ë°©ë¬¸ ì—¬ë¶€
        let currentSpiritId = null;
        let pendingSpirit = null;
        let lastGatherTime = null;
        let currentTab = 'garden'; // í˜„ì¬ í™œì„± íƒ­
        let currentTitle = 'none'; // í˜„ì¬ ì¹­í˜¸ (none, hawk_eye, gatherer, musician, collector)
        let currentShopCategory = 'all'; // í˜„ì¬ ìƒì  ì¹´í…Œê³ ë¦¬ (all, food, decoration, music)
        let sellFilter = 'all'; // íŒë§¤ í•„í„° (all, fire, water, wind, earth, light, dark, intelligence, strength, charm)
        let buyFilter = 'all'; // êµ¬ë§¤ í•„í„° (all, fire, water, wind, earth, light, dark, intelligence, strength, charm)
        let shopFoldState = { etc: false, food: false, music: false, decoration: false }; // ìƒì  íŒë§¤ ì¹´í…Œê³ ë¦¬ ì ‘ê¸° ìƒíƒœ (true=ì ‘í˜)
        let currentShopTab = 'sell'; // í˜„ì¬ ìƒì  íƒ­ (sell/buy)
        let encyclopediaFoldState = {}; // ë„ê° ì ‘ê¸° ìƒíƒœ { 'nostat': false, 'intelligent': true, ... }
        let shopBuyFoldState = { etc: false, food: false, music: false, decoration: false }; // ìƒì  êµ¬ë§¤ ì¹´í…Œê³ ë¦¬ ì ‘ê¸° ìƒíƒœ (true=ì ‘í˜)
        let lockedItems = { food: [], decorations: [], music: [] }; // íŒë§¤ ì ê¸ˆëœ ì•„ì´í…œ ëª©ë¡
        let isLockMode = false; // ì ê¸ˆ ëª¨ë“œ ìƒíƒœ
        let terrariumInvFilter = 'all'; // í…Œë¼ë¦¬ì›€ ì¸ë²¤í† ë¦¬ í•„í„° (all, fire, water, wind, earth, light, dark, event)
        let terrariumQualityFilter = 'all'; // í…Œë¼ë¦¬ì›€ í’ˆì§ˆ í•„í„° (all, common, rare, epic, legendary)
        let labCategoryFilter = 'all'; // ì—°êµ¬ì‹¤ ì¹´í…Œê³ ë¦¬ í•„í„° (all, food, decoration, music)
        let labAttrFilter = 'all'; // ì—°êµ¬ì‹¤ ì†ì„± í•„í„°
        let labQualityFilter = 'all'; // ì—°êµ¬ì‹¤ í’ˆì§ˆ í•„í„°
        let currentGatherLocation = 'garden'; // í˜„ì¬ ì±„ì§‘ ì¥ì†Œ (garden, lake, forest)
        let lightToggleHistory = []; // ì¡°ëª… ë³€ê²½ ê¸°ë¡ (íƒ€ì„ìŠ¤íƒ¬í”„ ë°°ì—´)
        let isPaused = false; // ê²Œì„ ì¼ì‹œì •ì§€ ìƒíƒœ
        let pausedAt = null; // ì¼ì‹œì •ì§€ ì‹œì‘ ì‹œê°„
        let totalPausedTime = 0; // ì´ ì¼ì‹œì •ì§€ ì‹œê°„
        let activatedEvents = []; // í™œì„±í™”ëœ ì´ë²¤íŠ¸ ëª©ë¡
        let lowSatisfactionStartTime = {}; // ì •ë ¹ë³„ ë¶ˆë§Œ ìƒíƒœ ì‹œì‘ ì‹œê°„
        let achievements = {}; // ë‹¬ì„±í•œ ì—…ì  ëª©ë¡ { achievementId: timestamp }
        let claimedAchievementRewards = []; // ë³´ìƒ ìˆ˜ë ¹í•œ ì—…ì  ëª©ë¡

        // ì—…ì  ì •ì˜
        const ACHIEVEMENTS = {
            // í‚¤ìš´ ì •ë ¹ì˜ ìˆ˜ (ì•¨ë²”)
            album_1: {
                id: 'album_1',
                category: 'album',
                requirement: 1,
                title: 'í…Œë¼ë¦¬ì›€ í‚¤í¼ë¡œì„œì˜ ì²« ì‹œì‘',
                icon: 'ğŸŒ±',
                desc: 'ì²« ë²ˆì§¸ ì •ë ¹ì„ ì„±ì¶©ê¹Œì§€ í‚¤ì› ìŠµë‹ˆë‹¤.'
            },
            album_10: {
                id: 'album_10',
                category: 'album',
                requirement: 10,
                title: 'ì´ˆë³´ í…Œë¼ë¦¬ì›€ í‚¤í¼',
                icon: 'ğŸŒ¿',
                desc: '10ë§ˆë¦¬ì˜ ì •ë ¹ì„ ì„±ì¶©ê¹Œì§€ í‚¤ì› ìŠµë‹ˆë‹¤.'
            },
            album_25: {
                id: 'album_25',
                category: 'album',
                requirement: 25,
                title: 'ì„±ì¥í•˜ëŠ” í…Œë¼ë¦¬ì›€ í‚¤í¼',
                icon: 'ğŸŒ³',
                desc: '25ë§ˆë¦¬ì˜ ì •ë ¹ì„ ì„±ì¶©ê¹Œì§€ í‚¤ì› ìŠµë‹ˆë‹¤.'
            },
            album_50: {
                id: 'album_50',
                category: 'album',
                requirement: 50,
                title: 'ìˆ™ë ¨ëœ í…Œë¼ë¦¬ì›€ í‚¤í¼',
                icon: 'ğŸŒ²',
                desc: '50ë§ˆë¦¬ì˜ ì •ë ¹ì„ ì„±ì¶©ê¹Œì§€ í‚¤ì› ìŠµë‹ˆë‹¤.'
            },
            album_70: {
                id: 'album_70',
                category: 'album',
                requirement: 70,
                title: 'ë² í…Œë‘ í…Œë¼ë¦¬ì›€ í‚¤í¼',
                icon: 'ğŸ†',
                desc: '70ë§ˆë¦¬ì˜ ì •ë ¹ì„ ì„±ì¶©ê¹Œì§€ í‚¤ì› ìŠµë‹ˆë‹¤.'
            },
            album_100: {
                id: 'album_100',
                category: 'album',
                requirement: 100,
                title: 'ì „ì„¤ì˜ í…Œë¼ë¦¬ì›€ í‚¤í¼',
                icon: 'ğŸ‘‘',
                desc: '100ë§ˆë¦¬ì˜ ì •ë ¹ì„ ì„±ì¶©ê¹Œì§€ í‚¤ì› ìŠµë‹ˆë‹¤.'
            },
            // ë„ê° ì±„ìš´ ìˆ˜
            encyclopedia_5: {
                id: 'encyclopedia_5',
                category: 'encyclopedia',
                requirement: 5,
                title: 'ë„ê° ìˆ˜ì§‘ê°€',
                icon: 'ğŸ“–',
                desc: 'ë„ê°ì— 5ì¢…ë¥˜ì˜ ì •ë ¹ì„ ë“±ë¡í–ˆìŠµë‹ˆë‹¤.'
            },
            encyclopedia_10: {
                id: 'encyclopedia_10',
                category: 'encyclopedia',
                requirement: 10,
                title: 'ì—´ì •ì ì¸ ìˆ˜ì§‘ê°€',
                icon: 'ğŸ“š',
                desc: 'ë„ê°ì— 10ì¢…ë¥˜ì˜ ì •ë ¹ì„ ë“±ë¡í–ˆìŠµë‹ˆë‹¤.'
            },
            encyclopedia_25: {
                id: 'encyclopedia_25',
                category: 'encyclopedia',
                requirement: 25,
                title: 'ë°•í•™ë‹¤ì‹í•œ ìˆ˜ì§‘ê°€',
                icon: 'ğŸ”¬',
                desc: 'ë„ê°ì— 25ì¢…ë¥˜ì˜ ì •ë ¹ì„ ë“±ë¡í–ˆìŠµë‹ˆë‹¤.'
            },
            encyclopedia_50: {
                id: 'encyclopedia_50',
                category: 'encyclopedia',
                requirement: 50,
                title: 'ì •ë ¹ ë°•ì‚¬',
                icon: 'ğŸ“',
                desc: 'ë„ê°ì— 50ì¢…ë¥˜ì˜ ì •ë ¹ì„ ë“±ë¡í–ˆìŠµë‹ˆë‹¤.'
            },
            // ë ˆì‹œí”¼ ë°œê²¬ ìˆ˜
            recipe_5: {
                id: 'recipe_5',
                category: 'recipe',
                requirement: 5,
                title: 'ê²¬ìŠµ ì—°ê¸ˆìˆ ì‚¬',
                icon: 'ğŸ§ª',
                desc: '5ê°œì˜ ë ˆì‹œí”¼ë¥¼ ë°œê²¬í–ˆìŠµë‹ˆë‹¤.'
            },
            recipe_15: {
                id: 'recipe_15',
                category: 'recipe',
                requirement: 15,
                title: 'ìˆ™ë ¨ ì—°ê¸ˆìˆ ì‚¬',
                icon: 'âš—ï¸',
                desc: '15ê°œì˜ ë ˆì‹œí”¼ë¥¼ ë°œê²¬í–ˆìŠµë‹ˆë‹¤.'
            },
            recipe_28: {
                id: 'recipe_28',
                category: 'recipe',
                requirement: 28,
                title: 'ë§ˆìŠ¤í„° ì—°ê¸ˆìˆ ì‚¬',
                icon: 'ğŸ”®',
                desc: 'ëª¨ë“  ë ˆì‹œí”¼ë¥¼ ë°œê²¬í–ˆìŠµë‹ˆë‹¤!'
            },
            // ë ˆì‹œí”¼ë¶ ì—†ì´ ì§ì ‘ ë°œê²¬ (íŠ¹ë³„ ì—…ì )
            recipe_self_all: {
                id: 'recipe_self_all',
                category: 'recipe_special',
                requirement: 28,
                title: 'ì§„ì •í•œ ì—°ê¸ˆìˆ ì˜ ëŒ€ê°€',
                icon: 'ğŸ…',
                desc: 'ë ˆì‹œí”¼ë¶ ì—†ì´ ëª¨ë“  ë ˆì‹œí”¼ë¥¼ ì§ì ‘ ë°œê²¬í–ˆìŠµë‹ˆë‹¤!'
            }
        };

        // ëœë¤ ë¬¸êµ¬ ì‹œìŠ¤í…œ
        const RANDOM_MESSAGES = {
            // ì•Œ ìƒíƒœ ê¸°ë³¸ í–‰ë™
            egg_basic: [
                '{name}ì´(ê°€) ê°€ë§Œíˆ ìˆìŠµë‹ˆë‹¤.',
                '{name}ì´(ê°€) ì¡°ìš©íˆ ë†“ì—¬ ìˆìŠµë‹ˆë‹¤.',
                '{name}ì—ì„œ ë¯¸ì„¸í•œ ì˜¨ê¸°ê°€ ëŠê»´ì§‘ë‹ˆë‹¤.',
                '{name}ì˜ ê»ì§ˆì´ ì‚´ì§ í”ë“¤ë¦½ë‹ˆë‹¤.',
                '{name}ì—ì„œ ì‘ì€ ì†Œë¦¬ê°€ ë“¤ë¦¬ëŠ” ê²ƒ ê°™ìŠµë‹ˆë‹¤.',
                '{name}ì´(ê°€) í¬ë¯¸í•˜ê²Œ ë¹›ë‚©ë‹ˆë‹¤.',
                '{name}ì˜ í‘œë©´ì— ì´ìŠ¬ì´ ë§ºí˜€ ìˆìŠµë‹ˆë‹¤.',
                '{name}ì´(ê°€) ë”°ëœ»í•˜ê²Œ í’ˆì–´ì§€ê¸¸ ê¸°ë‹¤ë¦¬ëŠ” ë“¯í•©ë‹ˆë‹¤.',
                '{name} ì•ˆì—ì„œ ë¬´ì–¸ê°€ ì›€ì§ì´ëŠ” ê²ƒ ê°™ìŠµë‹ˆë‹¤.',
                '{name}ì´(ê°€) ë¶€í™”ë¥¼ ì¤€ë¹„í•˜ê³  ìˆëŠ” ê²ƒ ê°™ìŠµë‹ˆë‹¤.'
            ],
            // ë²ˆë°ê¸° ìƒíƒœ ê¸°ë³¸ í–‰ë™
            pupa_basic: [
                '{name}ì´(ê°€) ë¯¸ë™ë„ í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.',
                '{name}ì´(ê°€) ì¡°ìš©íˆ ë³€íƒœ ì¤‘ì…ë‹ˆë‹¤.',
                '{name}ì—ì„œ ì•½í•œ ì§„ë™ì´ ëŠê»´ì§‘ë‹ˆë‹¤.',
                '{name}ì˜ ê»ì§ˆì´ ì•„ì£¼ ì‚´ì§ ê¿ˆí‹€ê±°ë¦½ë‹ˆë‹¤.',
                '{name}ì´(ê°€) ê³ ìš”íˆ ì ë“¤ì–´ ìˆìŠµë‹ˆë‹¤.',
                '{name} ì•ˆì—ì„œ ë³€í™”ê°€ ì¼ì–´ë‚˜ê³  ìˆëŠ” ê²ƒ ê°™ìŠµë‹ˆë‹¤.',
                '{name}ì˜ í‘œë©´ì´ í¬ë¯¸í•˜ê²Œ ë¹›ë‚©ë‹ˆë‹¤.',
                '{name}ì´(ê°€) ë‚˜ë¹„ê°€ ë  ê¿ˆì„ ê¾¸ê³  ìˆëŠ” ê²ƒ ê°™ìŠµë‹ˆë‹¤.',
                '{name}ì´(ê°€) ìƒˆë¡œìš´ ëª¨ìŠµì„ ì¤€ë¹„í•˜ê³  ìˆìŠµë‹ˆë‹¤.',
                '{name}ì—ì„œ ì‹ ë¹„ë¡œìš´ ê¸°ìš´ì´ ëŠê»´ì§‘ë‹ˆë‹¤.'
            ],
            // ê¸°ë³¸ í–‰ë™ (ì¡°ê±´ ì—†ìŒ) - ì• ë²Œë ˆìš©
            basic: [
                '{name}ì´(ê°€) ê¿ˆí‹€ê±°ë¦½ë‹ˆë‹¤.',
                '{name}ì´(ê°€) ëª¸ì„ ë¶€ë¥´ë¥´ ë–±ë‹ˆë‹¤.',
                '{name}ì´(ê°€) ì£¼ë³€ì„ ë‘ë¦¬ë²ˆê±°ë¦½ë‹ˆë‹¤.',
                '{name}ì´(ê°€) ì‘ê²Œ ìš¸ìŒì†Œë¦¬ë¥¼ ëƒ…ë‹ˆë‹¤.',
                '{name}ì´(ê°€) ê°€ë§Œíˆ ì›…í¬ë¦¬ê³  ìˆìŠµë‹ˆë‹¤.',
                '{name}ì´(ê°€) ì²œì²œíˆ ì›€ì§ì…ë‹ˆë‹¤.',
                '{name}ì´(ê°€) í…Œë¼ë¦¬ì›€ ìœ ë¦¬ì— ëª¸ì„ ë¬¸ì§€ë¦…ë‹ˆë‹¤.',
                '{name}ì´(ê°€) ëª¸ì„ ì‚´ì§ ë–¨ê³  ìˆìŠµë‹ˆë‹¤.',
                '{name}ì´(ê°€) ìì‹ ì˜ ëª¸ì„ ì •ë¦¬í•©ë‹ˆë‹¤.',
                '{name}ì´(ê°€) ë¬´ì–¸ê°€ë¥¼ ì°¾ëŠ” ë“¯í•©ë‹ˆë‹¤.',
                '{name}ì´(ê°€) ì™¸ë¡œì›Œí•©ë‹ˆë‹¤.',
                '{name}ì´(ê°€) ì‹¬ì‹¬í•´ ë³´ì…ë‹ˆë‹¤.',
                '{name}ì´(ê°€) í•œìˆ¨ì„ ì‰½ë‹ˆë‹¤.'
            ],
            // ì•Œ ìƒíƒœ ë°°ê³ í””
            egg_hungry: [
                '{name}ì—ì„œ í—ˆê¸°ì§„ ê¸°ìš´ì´ ëŠê»´ì§‘ë‹ˆë‹¤.',
                '{name}ì´(ê°€) ì˜ì–‘ë¶„ì´ í•„ìš”í•œ ê²ƒ ê°™ìŠµë‹ˆë‹¤.',
                '{name}ì˜ ë¹›ì´ ì¡°ê¸ˆ ì•½í•´ì§„ ê²ƒ ê°™ìŠµë‹ˆë‹¤.',
                '{name}ì´(ê°€) í˜ì—†ì´ ë†“ì—¬ ìˆìŠµë‹ˆë‹¤.'
            ],
            // ë²ˆë°ê¸° ìƒíƒœ ë°°ê³ í””
            pupa_hungry: [
                '{name}ì´(ê°€) í˜ì—†ì´ ì¶• ì²˜ì ¸ ìˆìŠµë‹ˆë‹¤.',
                '{name}ì—ì„œ ì•½í•œ ê¸°ìš´ì´ ëŠê»´ì§‘ë‹ˆë‹¤.',
                '{name}ì˜ ë³€íƒœê°€ ëŠë ¤ì§„ ê²ƒ ê°™ìŠµë‹ˆë‹¤.',
                '{name}ì´(ê°€) ì—ë„ˆì§€ê°€ ë¶€ì¡±í•´ ë³´ì…ë‹ˆë‹¤.'
            ],
            // ë°°ê³ í”” - ì• ë²Œë ˆìš©
            hungry: [
                '{name}ì´(ê°€) ë°°ê³ íŒŒ ë³´ì…ë‹ˆë‹¤.',
                '{name}ì´(ê°€) ë¨¹ì´ë¥¼ ì°¾ê³  ìˆìŠµë‹ˆë‹¤.',
                '{name}ì´(ê°€) í—ˆê¸°ì§„ ëˆˆë¹›ìœ¼ë¡œ ë‹¹ì‹ ì„ ë´…ë‹ˆë‹¤.',
                '{name}ì´(ê°€) ì…ë§›ì„ ë‹¤ì‹­ë‹ˆë‹¤.',
                '{name}ì´(ê°€) ë°°ë¥¼ ì›€ì¼œì¥ê³  ìˆìŠµë‹ˆë‹¤.'
            ],
            // ì•Œ ìƒíƒœ ë‚®ì 
            egg_napLight: [
                '{name}ì´(ê°€) í–‡ì‚´ ì•„ë˜ì—ì„œ ë”°ëœ»í•©ë‹ˆë‹¤.',
                '{name}ì—ì„œ í‰ì˜¨í•œ ê¸°ìš´ì´ ëŠê»´ì§‘ë‹ˆë‹¤.',
                '{name}ì´(ê°€) í¬ê·¼í•˜ê²Œ ë†“ì—¬ ìˆìŠµë‹ˆë‹¤.'
            ],
            // ì•Œ ìƒíƒœ ë°¤ì 
            egg_sleepDark: [
                '{name}ì´(ê°€) ì–´ë‘  ì†ì—ì„œ ê³ ìš”í•©ë‹ˆë‹¤.',
                '{name}ì´(ê°€) ì¡°ìš©íˆ ì‰¬ê³  ìˆìŠµë‹ˆë‹¤.',
                '{name}ì—ì„œ ì”ì”í•œ ìˆ¨ì†Œë¦¬ê°€ ë“¤ë¦¬ëŠ” ë“¯í•©ë‹ˆë‹¤.'
            ],
            // ë²ˆë°ê¸° ìƒíƒœ ë‚®ì 
            pupa_napLight: [
                '{name}ì´(ê°€) í–‡ì‚´ ì•„ë˜ì—ì„œ ë³€íƒœ ì¤‘ì…ë‹ˆë‹¤.',
                '{name}ì´(ê°€) ë”°ëœ»í•œ ë¹›ì„ ë°›ìœ¼ë©° ì‰¬ê³  ìˆìŠµë‹ˆë‹¤.',
                '{name}ì˜ ê»ì§ˆì´ í–‡ì‚´ì— ë¹›ë‚©ë‹ˆë‹¤.'
            ],
            // ë²ˆë°ê¸° ìƒíƒœ ë°¤ì 
            pupa_sleepDark: [
                '{name}ì´(ê°€) ì–´ë‘  ì†ì—ì„œ ê¹Šì´ ì ë“¤ì–´ ìˆìŠµë‹ˆë‹¤.',
                '{name}ì´(ê°€) ê³ ìš”í•œ ë°¤ì— ë³€í™”í•˜ê³  ìˆìŠµë‹ˆë‹¤.',
                '{name}ì´(ê°€) ë‹¬ë¹› ì•„ë˜ ì¡°ìš©íˆ ì‰¬ê³  ìˆìŠµë‹ˆë‹¤.'
            ],
            // ë‚®ì  (ì¡°ëª… ì¼œì§) - ì• ë²Œë ˆìš©
            napLight: [
                '{name}ì´(ê°€) ë‚®ì ì„ ìê³  ìˆìŠµë‹ˆë‹¤.',
                '{name}ì´(ê°€) í–‡ì‚´ ì•„ë˜ì—ì„œ ì¡¸ê³  ìˆìŠµë‹ˆë‹¤.',
                '{name}ì´(ê°€) í¸ì•ˆí•˜ê²Œ ëˆˆì„ ê°ê³  ìˆìŠµë‹ˆë‹¤.',
                '{name}ì´(ê°€) ìŠ¤ë¥´ë¥µ ì ì´ ë“¤ì—ˆìŠµë‹ˆë‹¤.',
                '{name}ì´(ê°€) ë‚˜ë­‡ì ìœ„ì—ì„œ ë‚®ì ì„ ì¦ê¹ë‹ˆë‹¤.'
            ],
            // ë°¤ì  (ì¡°ëª… êº¼ì§) - ì• ë²Œë ˆìš©
            sleepDark: [
                '{name}ì´(ê°€) ì ì„ ìê³  ìˆìŠµë‹ˆë‹¤.',
                '{name}ì´(ê°€) ê¹Šì€ ì ì— ë¹ ì¡ŒìŠµë‹ˆë‹¤.',
                '{name}ì´(ê°€) ê³ ìš”íˆ ì ë“¤ì–´ ìˆìŠµë‹ˆë‹¤.',
                '{name}ì´(ê°€) ì–´ë‘  ì†ì—ì„œ í¸íˆ ì‰¬ê³  ìˆìŠµë‹ˆë‹¤.',
                '{name}ì´(ê°€) ì¡°ìš©íˆ ê¿ˆë‚˜ë¼ë¡œ ë– ë‚¬ìŠµë‹ˆë‹¤.'
            ],
            // ì•Œ ìƒíƒœ ì• ì •ë„ ë‚®ìŒ
            egg_affectionLow: [
                '{name}ì´(ê°€) ì“¸ì“¸í•´ ë³´ì…ë‹ˆë‹¤.',
                '{name}ì—ì„œ ì™¸ë¡œìš´ ê¸°ìš´ì´ ëŠê»´ì§‘ë‹ˆë‹¤.',
                '{name}ì´(ê°€) ê´€ì‹¬ì´ í•„ìš”í•œ ê²ƒ ê°™ìŠµë‹ˆë‹¤.'
            ],
            // ë²ˆë°ê¸° ìƒíƒœ ì• ì •ë„ ë‚®ìŒ
            pupa_affectionLow: [
                '{name}ì´(ê°€) ì™¸ë¡œì›Œ ë³´ì…ë‹ˆë‹¤.',
                '{name}ì—ì„œ ì“¸ì“¸í•œ ê¸°ìš´ì´ ëŠê»´ì§‘ë‹ˆë‹¤.',
                '{name}ì´(ê°€) ë³´ì‚´í•Œì´ í•„ìš”í•´ ë³´ì…ë‹ˆë‹¤.'
            ],
            // ì• ì •ë„ ë‚®ìŒ (0-10) - ì• ë²Œë ˆìš©
            affectionVeryLow: [
                '{name}ì´(ê°€) ë‹¹ì‹ ì„ í”¼í•´ í…Œë¼ë¦¬ì›€ êµ¬ì„ì— ìˆ¨ìŠµë‹ˆë‹¤.',
                '{name}ì´(ê°€) ë‹¹ì‹ ì„ ê²½ê³„í•˜ë©° ë©€ë¦¬ ë–¨ì–´ì§‘ë‹ˆë‹¤.',
                '{name}ì´(ê°€) ê³ ê°œë¥¼ ëŒë ¤ ë‹¹ì‹ ì„ ì™¸ë©´í•©ë‹ˆë‹¤.',
                '{name}ì´(ê°€) ë¶ˆì•ˆí•œ ë“¯ ëª¸ì„ ë–¨ê³  ìˆìŠµë‹ˆë‹¤.',
                '{name}ì´(ê°€) ë‹¹ì‹  ì•ì—ì„œ ì›€ì¸ ëŸ¬ë“­ë‹ˆë‹¤.'
            ],
            // ì• ì •ë„ ë‚®ìŒ (10-30)
            affectionLow: [
                '{name}ì´(ê°€) ë‹¹ì‹ ì„ ë¹¤íˆ ë°”ë¼ë´…ë‹ˆë‹¤.',
                '{name}ì´(ê°€) ì¡°ì‹¬ìŠ¤ëŸ½ê²Œ ë‹¹ì‹ ì„ ê´€ì°°í•©ë‹ˆë‹¤.',
                '{name}ì´(ê°€) ì‚´ì§ ë‹¹ì‹ ì—ê²Œ ë‹¤ê°€ì˜µë‹ˆë‹¤.',
                '{name}ì´(ê°€) ë‹¹ì‹ ì—ê²Œ ê´€ì‹¬ì„ ë³´ì´ê¸° ì‹œì‘í•©ë‹ˆë‹¤.',
                '{name}ì´(ê°€) í˜¸ê¸°ì‹¬ ì–´ë¦° ëˆˆìœ¼ë¡œ ë‹¹ì‹ ì„ ë´…ë‹ˆë‹¤.'
            ],
            // ì• ì •ë„ ì¤‘ê°„ (30-50)
            affectionMedium: [
                '{name}ì´(ê°€) ë‹¹ì‹ ì˜ ì†ì— ëº¨ì„ ë¶€ë¹•ë‹ˆë‹¤.',
                '{name}ì´(ê°€) ë‹¹ì‹  ì£¼ë³€ì„ ë¹™ê¸€ë¹™ê¸€ ë•ë‹ˆë‹¤.',
                '{name}ì´(ê°€) ë‹¹ì‹ ì˜ ì†ê°€ë½ì„ ì‚´ì§ ê±´ë“œë¦½ë‹ˆë‹¤.',
                '{name}ì´(ê°€) ë‹¹ì‹ ì—ê²Œ ì• êµë¥¼ ë¶€ë¦½ë‹ˆë‹¤.',
                '{name}ì´(ê°€) ë‹¹ì‹  ê³ì— ê°€ê¹Œì´ ë‹¤ê°€ì˜µë‹ˆë‹¤.'
            ],
            // ì• ì •ë„ ë†’ìŒ (50-100)
            affectionHigh: [
                '{name}ì´(ê°€) ë‹¹ì‹ ì„ ë³´ë©° í–‰ë³µí•´í•©ë‹ˆë‹¤.',
                '{name}ì´(ê°€) ë‹¹ì‹ ì˜ ì†ë°”ë‹¥ì—ì„œ ë’¹êµ½ë‹ˆë‹¤.',
                '{name}ì´(ê°€) ë‹¹ì‹ ì—ê²Œ ì• ì • ì–´ë¦° ëˆˆë¹›ì„ ë³´ëƒ…ë‹ˆë‹¤.',
                '{name}ì´(ê°€) ë‹¹ì‹ ì˜ ì†ì„ ê¼­ ë¶™ì¡ìŠµë‹ˆë‹¤.',
                '{name}ì´(ê°€) ë‹¹ì‹ ê³¼ í•¨ê»˜ ìˆì–´ ì¦ê±°ì›Œ ë³´ì…ë‹ˆë‹¤.'
            ],
            // ì• ì •ë„ ë§¤ìš° ë†’ìŒ (100+)
            affectionVeryHigh: [
                '{name}ì´(ê°€) ë‹¹ì‹ ì„ ê¹Šì´ ì‹ ë¢°í•˜ê³  ìˆìŠµë‹ˆë‹¤.',
                '{name}ì´(ê°€) ë‹¹ì‹ ì˜ í’ˆì— íŒŒê³ ë“­ë‹ˆë‹¤.',
                '{name}ì´(ê°€) ë‹¹ì‹ ì„ í–¥í•œ ì‚¬ë‘ì„ í‘œí˜„í•©ë‹ˆë‹¤.',
                '{name}ì´(ê°€) ë‹¹ì‹ ì˜ ì†ì— ì…ë§ì¶¤í•©ë‹ˆë‹¤.',
                '{name}ì´(ê°€) ë‹¹ì‹  ì—†ì´ëŠ” ëª» ì‚°ë‹¤ëŠ” ë“¯ ì³ë‹¤ë´…ë‹ˆë‹¤.'
            ],
            // ìŒì•… ê´€ë ¨ (ìµœê·¼ì— ìŒì•… ë“¤ìŒ) - ì• ë²Œë ˆìš©
            music: [
                '{name}ì´(ê°€) {music}ì„(ë¥¼) í¥ì–¼ê±°ë¦½ë‹ˆë‹¤.',
                '{name}ì´(ê°€) {music}ì— ë§ì¶° ì¶¤ì„ ì¶¥ë‹ˆë‹¤.',
                '{name}ì´(ê°€) {music}ì˜ ì„ ìœ¨ì„ ë– ì˜¬ë¦½ë‹ˆë‹¤.',
                '{name}ì´(ê°€) ìŒì•…ì— ì·¨í•´ ìˆìŠµë‹ˆë‹¤.',
                '{name}ì´(ê°€) {music}ì˜ ì—¬ìš´ì— ì –ì–´ ìˆìŠµë‹ˆë‹¤.'
            ],
            // ì•Œ ìƒíƒœ ìŒì•… ê´€ë ¨
            egg_music: [
                '{name}ì—ì„œ {music}ì— ë°˜ì‘í•˜ëŠ” ì§„ë™ì´ ëŠê»´ì§‘ë‹ˆë‹¤.',
                '{name}ì˜ ê»ì§ˆì´ {music}ì— ë§ì¶° í¬ë¯¸í•˜ê²Œ ë¹›ë‚©ë‹ˆë‹¤.',
                '{name}ì´(ê°€) {music}ì˜ ì„ ìœ¨ì— ë°˜ì‘í•©ë‹ˆë‹¤.',
                '{name} ì•ˆì—ì„œ ìŒì•…ì„ ì¦ê¸°ëŠ” ë“¯í•œ ê¸°ìš´ì´ ëŠê»´ì§‘ë‹ˆë‹¤.'
            ],
            // ë²ˆë°ê¸° ìƒíƒœ ìŒì•… ê´€ë ¨
            pupa_music: [
                '{name}ì—ì„œ {music}ì— ë°˜ì‘í•˜ëŠ” ì•½í•œ ì§„ë™ì´ ëŠê»´ì§‘ë‹ˆë‹¤.',
                '{name}ì˜ ê»ì§ˆì´ {music}ì— ë§ì¶° ì‚´ì§ ë–¨ë¦½ë‹ˆë‹¤.',
                '{name}ì´(ê°€) {music}ì˜ ì„ ìœ¨ì— ë¯¸ì„¸í•˜ê²Œ ë°˜ì‘í•©ë‹ˆë‹¤.',
                '{name} ì•ˆì—ì„œ ìŒì•…ì„ ì¦ê¸°ëŠ” ë“¯í•œ ê¸°ìš´ì´ ëŠê»´ì§‘ë‹ˆë‹¤.'
            ],
            // ë¯¸ë‹ˆì–´ì²˜ ê´€ë ¨ (30ê°œ ì „ì²´)
            decorations: {
                // ë¶ˆ ì†ì„±
                fire_common1: [
                    '{name}ì´(ê°€) ìš©ì•”ì„ì—ì„œ íë¥´ëŠ” ì—´ê¸°ë¥¼ ë°”ë¼ë´…ë‹ˆë‹¤.',
                    '{name}ì´(ê°€) ìš©ì•”ì„ì˜ ë¶ˆì„ ì‹ ê¸°í•˜ê²Œ ì³ë‹¤ë´…ë‹ˆë‹¤.',
                    '{name}ì´(ê°€) ëœ¨ê±°ìš´ ìš©ì•”ì„ ê·¼ì²˜ì—ì„œ ë”°ëœ»í•¨ì„ ëŠë‚ë‹ˆë‹¤.'
                ],
                fire_common2: [
                    '{name}ì´(ê°€) í™”ì‚°ì¬ë¥¼ í†¡í†¡ ê±´ë“œë¦½ë‹ˆë‹¤.',
                    '{name}ì´(ê°€) í™”ì‚°ì¬ì˜ í–¥ì„ ë§¡ê³  ìˆìŠµë‹ˆë‹¤.',
                    '{name}ì´(ê°€) í™”ì‚°ì¬ ë”ë¯¸ ì˜†ì—ì„œ ë†€ê³  ìˆìŠµë‹ˆë‹¤.'
                ],
                fire_rare1: [
                    '{name}ì´(ê°€) ë¶ˆê½ƒ ì¡°ê°ìƒì„ ê²½ì™¸í•˜ë©° ë°”ë¼ë´…ë‹ˆë‹¤.',
                    '{name}ì´(ê°€) ë¶ˆê½ƒ ì¡°ê°ìƒì˜ ì•„ë¦„ë‹¤ì›€ì— ë§¤ë£Œë˜ì–´ ìˆìŠµë‹ˆë‹¤.',
                    '{name}ì´(ê°€) ë¶ˆê½ƒ ì¡°ê°ìƒ ì£¼ë³€ì„ ë¹™ê¸€ë¹™ê¸€ ë•ë‹ˆë‹¤.'
                ],
                fire_rare2: [
                    '{name}ì´(ê°€) íƒ€ì˜¤ë¥´ëŠ” ë¨í”„ì˜ ë¶ˆë¹›ì„ êµ¬ê²½í•©ë‹ˆë‹¤.',
                    '{name}ì´(ê°€) ë¨í”„ ë¶ˆë¹›ì— ê·¸ë¦¼ìë¥¼ ë“œë¦¬ì›ë‹ˆë‹¤.',
                    '{name}ì´(ê°€) ë¨í”„ì˜ ë”°ëœ»í•œ ë¹›ì„ ì¦ê¹ë‹ˆë‹¤.'
                ],
                fire_epic: [
                    '{name}ì´(ê°€) ë¶ˆì‚¬ì¡° ê¹ƒí„¸ì˜ ì‹ ë¹„ë¡œìš´ ê¸°ìš´ì„ ëŠë‚ë‹ˆë‹¤.',
                    '{name}ì´(ê°€) ë¶ˆì‚¬ì¡° ê¹ƒí„¸ì´ ë‚´ë¿œëŠ” ë¶ˆê½ƒì— ê°íƒ„í•©ë‹ˆë‹¤.',
                    '{name}ì´(ê°€) ë¶ˆì‚¬ì¡° ê¹ƒí„¸ ì•ì—ì„œ ê²½ê±´í•´ì§‘ë‹ˆë‹¤.'
                ],
                
                // ë¬¼ ì†ì„±
                water_common1: [
                    '{name}ì´(ê°€) ë¶„ìˆ˜ì˜ ë¬¼ì¤„ê¸°ë¥¼ êµ¬ê²½í•©ë‹ˆë‹¤.',
                    '{name}ì´(ê°€) ë¶„ìˆ˜ ë¬¼ì†Œë¦¬ì— ê·€ë¥¼ ê¸°ìš¸ì…ë‹ˆë‹¤.',
                    '{name}ì´(ê°€) ë¶„ìˆ˜ì—ì„œ íŠ€ëŠ” ë¬¼ë°©ìš¸ê³¼ ë†€ê³  ìˆìŠµë‹ˆë‹¤.'
                ],
                water_common2: [
                    '{name}ì´(ê°€) ì¡°ì•½ëŒì„ í†¡í†¡ ë‘ë“œë¦½ë‹ˆë‹¤.',
                    '{name}ì´(ê°€) ë§¤ëˆí•œ ì¡°ì•½ëŒì„ êµ´ë¦¬ê³  ìˆìŠµë‹ˆë‹¤.',
                    '{name}ì´(ê°€) ì¡°ì•½ëŒ ìœ„ì—ì„œ ì‰¬ê³  ìˆìŠµë‹ˆë‹¤.'
                ],
                water_rare1: [
                    '{name}ì´(ê°€) ì‚°í˜¸ ì¥ì‹ì˜ ìƒ‰ê¹”ì— ê°íƒ„í•©ë‹ˆë‹¤.',
                    '{name}ì´(ê°€) ì‚°í˜¸ ì‚¬ì´ë¥¼ í—¤ì—„ì¹˜ë“¯ ì›€ì§ì…ë‹ˆë‹¤.',
                    '{name}ì´(ê°€) ì‚°í˜¸ì˜ ì‹ ë¹„ë¡œìš´ ëª¨ìŠµì„ ê´€ì°°í•©ë‹ˆë‹¤.'
                ],
                water_rare2: [
                    '{name}ì´(ê°€) ë¬¼ë°©ìš¸ êµ¬ìŠ¬ì— ìì‹ ì˜ ëª¨ìŠµì„ ë¹„ì¶°ë´…ë‹ˆë‹¤.',
                    '{name}ì´(ê°€) êµ¬ìŠ¬ ì† ë¬¼ë°©ìš¸ì„ ì‹ ê¸°í•˜ê²Œ ì³ë‹¤ë´…ë‹ˆë‹¤.',
                    '{name}ì´(ê°€) ë¬¼ë°©ìš¸ êµ¬ìŠ¬ì„ êµ´ë¦¬ë©° ë†€ê³  ìˆìŠµë‹ˆë‹¤.'
                ],
                water_epic: [
                    '{name}ì´(ê°€) ì¸ì–´ì˜ ëˆˆë¬¼ì´ ë¹›ë‚˜ëŠ” ëª¨ìŠµì— ë„‹ì„ ìƒìŠµë‹ˆë‹¤.',
                    '{name}ì´(ê°€) ì¸ì–´ì˜ ëˆˆë¬¼ì—ì„œ ë‚˜ì˜¤ëŠ” ë¬¼ì˜ ê¸°ìš´ì„ ëŠë‚ë‹ˆë‹¤.',
                    '{name}ì´(ê°€) ì¸ì–´ì˜ ëˆˆë¬¼ ì•ì—ì„œ ê²½ê±´í•´ì§‘ë‹ˆë‹¤.'
                ],
                
                // ë°”ëŒ ì†ì„±
                wind_common1: [
                    '{name}ì´(ê°€) ë°”ëŒê°œë¹„ë¥¼ ì‹ ê¸°í•˜ê²Œ ë°”ë¼ë´…ë‹ˆë‹¤.',
                    '{name}ì´(ê°€) ë°”ëŒê°œë¹„ê°€ ë„ëŠ” ëª¨ìŠµì— ê°íƒ„í•©ë‹ˆë‹¤.',
                    '{name}ì´(ê°€) ë°”ëŒê°œë¹„ì™€ í•¨ê»˜ ë¹™ê¸€ë¹™ê¸€ ë•ë‹ˆë‹¤.'
                ],
                wind_common2: [
                    '{name}ì´(ê°€) ë¶€ë“œëŸ¬ìš´ ê¹ƒí„¸ì„ ì‚´ì§ ë§Œì§‘ë‹ˆë‹¤.',
                    '{name}ì´(ê°€) ê¹ƒí„¸ì´ í”ë“¤ë¦¬ëŠ” ëª¨ìŠµì„ êµ¬ê²½í•©ë‹ˆë‹¤.',
                    '{name}ì´(ê°€) ê¹ƒí„¸ ìœ„ì—ì„œ ê°€ë³ê²Œ ë›°ì–´ë†‰ë‹ˆë‹¤.'
                ],
                wind_rare1: [
                    '{name}ì´(ê°€) í’ê²½ ì†Œë¦¬ì— ê·€ë¥¼ ê¸°ìš¸ì…ë‹ˆë‹¤.',
                    '{name}ì´(ê°€) í’ê²½ì´ ìš¸ë¦¬ëŠ” ì†Œë¦¬ë¥¼ ì¦ê¹ë‹ˆë‹¤.',
                    '{name}ì´(ê°€) í’ê²½ê³¼ í•¨ê»˜ ë¦¬ë“¬ì„ íƒ€ê³  ìˆìŠµë‹ˆë‹¤.'
                ],
                wind_rare2: [
                    '{name}ì´(ê°€) ë¯¼ë“¤ë ˆ ì†œí„¸ì˜ ì”¨ì•—ì´ ë‚ ì•„ê°€ëŠ” ê²ƒì„ ë°”ë¼ë´…ë‹ˆë‹¤.',
                    '{name}ì´(ê°€) ë¯¼ë“¤ë ˆ ì†œí„¸ì— ì‚´ì§ ì…ê¹€ì„ ë¶ˆì–´ë´…ë‹ˆë‹¤.',
                    '{name}ì´(ê°€) ë¯¼ë“¤ë ˆ ì†œí„¸ ì‚¬ì´ì—ì„œ ìˆ¨ë°”ê¼­ì§ˆì„ í•©ë‹ˆë‹¤.'
                ],
                wind_epic: [
                    '{name}ì´(ê°€) í•˜ëŠ˜ì˜ ê¹ƒí„¸ì—ì„œ ë‚˜ì˜¤ëŠ” ë°”ëŒì„ ëŠë‚ë‹ˆë‹¤.',
                    '{name}ì´(ê°€) í•˜ëŠ˜ì˜ ê¹ƒí„¸ì´ ë¹›ë‚˜ëŠ” ëª¨ìŠµì— ê°íƒ„í•©ë‹ˆë‹¤.',
                    '{name}ì´(ê°€) í•˜ëŠ˜ì˜ ê¹ƒí„¸ ì•ì—ì„œ ê²½ê±´í•´ì§‘ë‹ˆë‹¤.'
                ],
                
                // ë•… ì†ì„±
                earth_common1: [
                    '{name}ì´(ê°€) í™”ë¶„ì˜ í™ëƒ„ìƒˆë¥¼ ë§¡ê³  ìˆìŠµë‹ˆë‹¤.',
                    '{name}ì´(ê°€) í™”ë¶„ ì† ì‹ë¬¼ì„ ì‚´í´ë´…ë‹ˆë‹¤.',
                    '{name}ì´(ê°€) í™”ë¶„ ì£¼ë³€ì„ ê¸°ì–´ë‹¤ë‹™ë‹ˆë‹¤.'
                ],
                earth_common2: [
                    '{name}ì´(ê°€) ì´ë¼ëŒì˜ ì´‰ì´‰í•œ í‘œë©´ì„ ë§Œì§‘ë‹ˆë‹¤.',
                    '{name}ì´(ê°€) ì´ë¼ ì‚¬ì´ë¥¼ íƒí—˜í•˜ê³  ìˆìŠµë‹ˆë‹¤.',
                    '{name}ì´(ê°€) ì´ë¼ëŒì—ì„œ ìì—°ì˜ ê¸°ìš´ì„ ëŠë‚ë‹ˆë‹¤.'
                ],
                earth_rare1: [
                    '{name}ì´(ê°€) ë‚˜ë¬´ ì¡°ê°ì˜ ë‚˜ì´í…Œë¥¼ ì„¸ì–´ë´…ë‹ˆë‹¤.',
                    '{name}ì´(ê°€) ë‚˜ë¬´ ì¡°ê°ì˜ ì§ˆê°ì„ ì¦ê¹ë‹ˆë‹¤.',
                    '{name}ì´(ê°€) ë‚˜ë¬´ ì¡°ê° ìœ„ë¥¼ ì˜¤ë¥´ë‚´ë¦¬ê³  ìˆìŠµë‹ˆë‹¤.'
                ],
                earth_rare2: [
                    '{name}ì´(ê°€) ë²„ì„¯ êµ°ë½ì„ ì‹ ê¸°í•˜ê²Œ ì³ë‹¤ë´…ë‹ˆë‹¤.',
                    '{name}ì´(ê°€) ë²„ì„¯ ì‚¬ì´ë¥¼ í—¤ì§‘ê³  ë‹¤ë‹™ë‹ˆë‹¤.',
                    '{name}ì´(ê°€) ë²„ì„¯ì˜ í¬ì í–¥ì„ ë§¡ê³  ìˆìŠµë‹ˆë‹¤.'
                ],
                earth_epic: [
                    '{name}ì´(ê°€) ì„¸ê³„ìˆ˜ ê°€ì§€ì˜ ìƒëª…ë ¥ì„ ëŠë‚ë‹ˆë‹¤.',
                    '{name}ì´(ê°€) ì„¸ê³„ìˆ˜ ê°€ì§€ì—ì„œ ë‚˜ì˜¤ëŠ” ê³ ëŒ€ì˜ ê¸°ìš´ì— ì••ë„ë©ë‹ˆë‹¤.',
                    '{name}ì´(ê°€) ì„¸ê³„ìˆ˜ ê°€ì§€ ì•ì—ì„œ ê²½ê±´í•´ì§‘ë‹ˆë‹¤.'
                ],
                
                // ë¹› ì†ì„±
                light_common1: [
                    '{name}ì´(ê°€) ìˆ˜ì •ì— ìì‹ ì˜ ì–¼êµ´ì„ ë¹„ì¶°ë´…ë‹ˆë‹¤.',
                    '{name}ì´(ê°€) ë¹›ë‚˜ëŠ” ìˆ˜ì •ì„ êµ¬ê²½í•©ë‹ˆë‹¤.',
                    '{name}ì´(ê°€) ìˆ˜ì •ì´ ë°˜ì‚¬í•˜ëŠ” ë¬´ì§€ê°œë¥¼ ì«“ì•„ê°‘ë‹ˆë‹¤.'
                ],
                light_common2: [
                    '{name}ì´(ê°€) ë°˜ì§ì´ ê°€ë£¨ë¥¼ í†¡í†¡ ê±´ë“œë¦½ë‹ˆë‹¤.',
                    '{name}ì´(ê°€) ë°˜ì§ì´ëŠ” ê°€ë£¨ì— ë’¹êµ½ë‹ˆë‹¤.',
                    '{name}ì´(ê°€) ë°˜ì§ì´ ê°€ë£¨ê°€ ë¹›ë‚˜ëŠ” ëª¨ìŠµì„ ì¦ê¹ë‹ˆë‹¤.'
                ],
                light_rare1: [
                    '{name}ì´(ê°€) ë¹›ë‚˜ëŠ” ë³´ì„ì˜ ê´‘ì±„ì— ë„‹ì„ ìƒìŠµë‹ˆë‹¤.',
                    '{name}ì´(ê°€) ë³´ì„ì´ ë§Œë“¤ì–´ë‚´ëŠ” ë¹›ì˜ í–¥ì—°ì„ ê°ìƒí•©ë‹ˆë‹¤.',
                    '{name}ì´(ê°€) ë³´ì„ ì˜†ì—ì„œ í•¨ê»˜ ë¹›ë‚˜ê³  ìˆìŠµë‹ˆë‹¤.'
                ],
                light_rare2: [
                    '{name}ì´(ê°€) íƒœì–‘ì„ì˜ ë”°ëœ»í•œ ë¹›ì„ ì¬¡ë‹ˆë‹¤.',
                    '{name}ì´(ê°€) íƒœì–‘ì„ ì•ì—ì„œ ëª¸ì„ ì­‰ í´ê³  ìˆìŠµë‹ˆë‹¤.',
                    '{name}ì´(ê°€) íƒœì–‘ì„ì˜ ê´‘ì±„ë¥¼ ì˜¨ëª¸ìœ¼ë¡œ ë°›ê³  ìˆìŠµë‹ˆë‹¤.'
                ],
                light_epic: [
                    '{name}ì´(ê°€) ë³„ì˜ íŒŒí¸ì´ ë¹›ë‚˜ëŠ” ëª¨ìŠµì— ê²½ì™¸í•©ë‹ˆë‹¤.',
                    '{name}ì´(ê°€) ë³„ì˜ íŒŒí¸ì—ì„œ ë‚˜ì˜¤ëŠ” ìš°ì£¼ì˜ ê¸°ìš´ì„ ëŠë‚ë‹ˆë‹¤.',
                    '{name}ì´(ê°€) ë³„ì˜ íŒŒí¸ ì•ì—ì„œ ê²½ê±´í•´ì§‘ë‹ˆë‹¤.'
                ],
                
                // ì–´ë‘  ì†ì„±
                dark_common1: [
                    '{name}ì´(ê°€) í‘ìš”ì„ì˜ ê¹Šì€ ì–´ë‘ ì— ë¹ ì ¸ë“­ë‹ˆë‹¤.',
                    '{name}ì´(ê°€) í‘ìš”ì„ì˜ ë§¤ëˆí•œ í‘œë©´ì„ ì“°ë‹¤ë“¬ìŠµë‹ˆë‹¤.',
                    '{name}ì´(ê°€) í‘ìš”ì„ ì˜†ì—ì„œ ì¡°ìš©íˆ ëª…ìƒí•©ë‹ˆë‹¤.'
                ],
                dark_common2: [
                    '{name}ì´(ê°€) ê²€ì€ ëª¨ë˜ë¥¼ íŒŒí—¤ì¹˜ê³  ìˆìŠµë‹ˆë‹¤.',
                    '{name}ì´(ê°€) ê²€ì€ ëª¨ë˜ ìœ„ì— ê·¸ë¦¼ì„ ê·¸ë¦½ë‹ˆë‹¤.',
                    '{name}ì´(ê°€) ê²€ì€ ëª¨ë˜ì˜ ê°ì´‰ì„ ì¦ê¹ë‹ˆë‹¤.'
                ],
                dark_rare1: [
                    '{name}ì´(ê°€) ë‹¬ë¹›ì„ì„ ì¡°ìš©íˆ ë°”ë¼ë´…ë‹ˆë‹¤.',
                    '{name}ì´(ê°€) ë‹¬ë¹›ì„ì˜ ì€ì€í•œ ë¹›ì— ì ê¹ë‹ˆë‹¤.',
                    '{name}ì´(ê°€) ë‹¬ë¹›ì„ê³¼ í•¨ê»˜ ë°¤ì˜ ê¸°ìš´ì„ ëŠë‚ë‹ˆë‹¤.'
                ],
                dark_rare2: [
                    '{name}ì´(ê°€) ê·¸ë¦¼ì ìˆ˜ì • ì†ì„ ë“¤ì—¬ë‹¤ë´…ë‹ˆë‹¤.',
                    '{name}ì´(ê°€) ê·¸ë¦¼ì ìˆ˜ì •ì˜ ì‹ ë¹„ë¡œìš´ ëª¨ìŠµì— ë§¤ë£Œë©ë‹ˆë‹¤.',
                    '{name}ì´(ê°€) ê·¸ë¦¼ì ìˆ˜ì •ì´ ë§Œë“¤ì–´ë‚´ëŠ” ì–´ë‘ ì„ ì¦ê¹ë‹ˆë‹¤.'
                ],
                dark_epic: [
                    '{name}ì´(ê°€) ë°¤ì˜ ì •ìˆ˜ì—ì„œ ë‚˜ì˜¤ëŠ” ì–´ë‘ ì˜ í˜ì„ ëŠë‚ë‹ˆë‹¤.',
                    '{name}ì´(ê°€) ë°¤ì˜ ì •ìˆ˜ê°€ í’ˆì€ ì‹ ë¹„ì— ì••ë„ë©ë‹ˆë‹¤.',
                    '{name}ì´(ê°€) ë°¤ì˜ ì •ìˆ˜ ì•ì—ì„œ ê²½ê±´í•´ì§‘ë‹ˆë‹¤.'
                ]
            },
            // ì •ë ¹ ê°„ ìƒí˜¸ì‘ìš©
            interaction: {
                decoration: [
                    '{name1}ê³¼(ì™€) {name2}ì´(ê°€) í•¨ê»˜ {deco}ì„(ë¥¼) êµ¬ê²½í•©ë‹ˆë‹¤.',
                    '{name1}ì´(ê°€) {name2}ì—ê²Œ {deco}ì„(ë¥¼) ë³´ì—¬ì¤ë‹ˆë‹¤.',
                    '{name1}ê³¼(ì™€) {name2}ì´(ê°€) {deco} ì£¼ìœ„ë¥¼ ë¹™ê¸€ë¹™ê¸€ ë•ë‹ˆë‹¤.',
                    '{name1}ê³¼(ì™€) {name2}ì´(ê°€) {deco} ì˜†ì—ì„œ í•¨ê»˜ ì‰¬ê³  ìˆìŠµë‹ˆë‹¤.',
                    '{name1}ì´(ê°€) {name2}ì™€(ê³¼) {deco}ì„(ë¥¼) í•¨ê»˜ ì¦ê¸°ê³  ìˆìŠµë‹ˆë‹¤.'
                ],
                sharing: [
                    '{name1}ì´(ê°€) {name2}ì—ê²Œ ë¨¹ì´ë¥¼ ë‚˜ëˆ ì¤ë‹ˆë‹¤.',
                    '{name1}ì´(ê°€) {name2}ì™€(ê³¼) ë¨¹ì´ë¥¼ í•¨ê»˜ ë¨¹ìŠµë‹ˆë‹¤.',
                    '{name1}ê³¼(ì™€) {name2}ì´(ê°€) ì„œë¡œì˜ ë¨¹ì´ë¥¼ ë‚˜ëˆ„ê³  ìˆìŠµë‹ˆë‹¤.'
                ],
                fight: [
                    '{name1}ê³¼(ì™€) {name2}ì´(ê°€) ì„œë¡œë¥¼ ê¹¨ë­…ë‹ˆë‹¤.',
                    '{name1}ì´(ê°€) {name2}ì™€(ê³¼) ì¥ë‚œìŠ¤ëŸ½ê²Œ ì‹¸ì›ë‹ˆë‹¤.',
                    '{name1}ê³¼(ì™€) {name2}ì´(ê°€) ìœ¼ë¥´ë ê±°ë¦¬ë©° ëŒ€ì¹˜í•©ë‹ˆë‹¤.',
                    '{name1}ì´(ê°€) {name2}ë¥¼(ì„) ì«“ì•„ë‹¤ë‹™ë‹ˆë‹¤.'
                ],
                rest: [
                    '{name1}ê³¼(ì™€) {name2}ì´(ê°€) ì„œë¡œì—ê²Œ ê¸°ëŒ€ì–´ ì ì´ ë“­ë‹ˆë‹¤.',
                    '{name1}ì´(ê°€) {name2} ì˜†ì—ì„œ í¸ì•ˆíˆ ì‰¬ê³  ìˆìŠµë‹ˆë‹¤.',
                    '{name1}ê³¼(ì™€) {name2}ì´(ê°€) ë‚˜ë€íˆ ë‚®ì ì„ ìê³  ìˆìŠµë‹ˆë‹¤.',
                    '{name1}ì´(ê°€) {name2}ë¥¼(ì„) ë² ê°œ ì‚¼ì•„ ì ë“¤ì—ˆìŠµë‹ˆë‹¤.',
                    '{name1}ê³¼(ì™€) {name2}ì´(ê°€) í•¨ê»˜ ê¿ˆë‚˜ë¼ë¡œ ë– ë‚¬ìŠµë‹ˆë‹¤.'
                ],
                song: [
                    '{name1}ì´(ê°€) {name2}ì—ê²Œ ìì‹ ì´ ì¢‹ì•„í•˜ëŠ” ë…¸ë˜ë¥¼ ë¶ˆëŸ¬ì¤ë‹ˆë‹¤.',
                    '{name1}ê³¼(ì™€) {name2}ì´(ê°€) í•¨ê»˜ ë…¸ë˜ë¥¼ ë¶€ë¦…ë‹ˆë‹¤.',
                    '{name1}ì´(ê°€) {name2}ë¥¼(ì„) ìœ„í•´ ìŒì•…ì„ ì—°ì£¼í•©ë‹ˆë‹¤.',
                    '{name1}ì´(ê°€) {name2}ì™€(ê³¼) í•¨ê»˜ ì¶¤ì„ ì¶¥ë‹ˆë‹¤.'
                ],
                play: [
                    '{name1}ê³¼(ì™€) {name2}ì´(ê°€) ìˆ¨ë°”ê¼­ì§ˆì„ í•˜ê³  ìˆìŠµë‹ˆë‹¤.',
                    '{name1}ì´(ê°€) {name2}ì™€(ê³¼) ìˆ ë˜ì¡ê¸°ë¥¼ ì¦ê¹ë‹ˆë‹¤.',
                    '{name1}ê³¼(ì™€) {name2}ì´(ê°€) ì¬ë¯¸ìˆê²Œ ë†€ê³  ìˆìŠµë‹ˆë‹¤.',
                    '{name1}ì´(ê°€) {name2}ë¥¼(ì„) ê°„ì§€ëŸ½í™ë‹ˆë‹¤.',
                    '{name1}ê³¼(ì™€) {name2}ì´(ê°€) í•¨ê»˜ ì›ƒê³  ë– ë“¤ê³  ìˆìŠµë‹ˆë‹¤.'
                ],
                talk: [
                    '{name1}ê³¼(ì™€) {name2}ì´(ê°€) ìˆ˜ë‹¤ë¥¼ ë–¨ê³  ìˆìŠµë‹ˆë‹¤.',
                    '{name1}ì´(ê°€) {name2}ì—ê²Œ ë¬´ì–¸ê°€ ì´ì•¼ê¸°í•˜ê³  ìˆìŠµë‹ˆë‹¤.',
                    '{name1}ê³¼(ì™€) {name2}ì´(ê°€) ì¦ê²ê²Œ ëŒ€í™”ë¥¼ ë‚˜ëˆ•ë‹ˆë‹¤.',
                    '{name1}ì´(ê°€) {name2}ì˜ ì´ì•¼ê¸°ë¥¼ ê²½ì²­í•˜ê³  ìˆìŠµë‹ˆë‹¤.'
                ]
            }
        };

        const STAGE_REQUIREMENTS = {
            egg: 0,
            larva1: 10,
            larva2: 25,
            larva3: 45,
            pupa: 70,
            adult: 100
        };

        const STAGE_ICONS = {
            egg: '<img src="https://raw.githubusercontent.com/mongyeonlab-cpu/mylittleterrarium/main/images/%EC%A0%95%EB%A0%B9%EC%95%8C_%EA%B8%B0%EB%B3%B8.png" style="width:150px;height:150px;vertical-align:middle;">',
            larva1: '<img src="https://raw.githubusercontent.com/mongyeonlab-cpu/mylittleterrarium/main/images/%EC%95%A0%EB%B2%8C%EB%A0%88_%EA%B8%B0%EB%B3%B8_1%EB%A0%B9.png" style="width:150px;height:150px;vertical-align:middle;">',
            larva2: '<img src="https://raw.githubusercontent.com/mongyeonlab-cpu/mylittleterrarium/main/images/%EC%95%A0%EB%B2%8C%EB%A0%88_%EA%B8%B0%EB%B3%B8_2%EB%A0%B9.png" style="width:150px;height:150px;vertical-align:middle;">',
            larva3: '<img src="https://raw.githubusercontent.com/mongyeonlab-cpu/mylittleterrarium/main/images/%EC%95%A0%EB%B2%8C%EB%A0%88_%EA%B8%B0%EB%B3%B8_3%EB%A0%B9.png" style="width:150px;height:150px;vertical-align:middle;">',
            pupa: '<img src="https://raw.githubusercontent.com/mongyeonlab-cpu/mylittleterrarium/main/images/%EB%B2%88%EB%8D%B0%EA%B8%B0.png" style="width:150px;height:150px;vertical-align:middle;">',
            adult: 'ğŸ¦‹'
        };
        
        // ì†ì„±ë³„ ìŠ¤í…Œì´ì§€ ì•„ì´ì½˜ (ë‹¨ì¼ ì†ì„±ìš©)
        const ATTRIBUTE_STAGE_ICONS = {
            fire: {
                larva1: '<img src="https://raw.githubusercontent.com/mongyeonlab-cpu/mylittleterrarium/main/images/%EC%95%A0%EB%B2%8C%EB%A0%88_%EB%B6%88_1%EB%A0%B9.png" style="width:150px;height:150px;vertical-align:middle;">',
                larva2: '<img src="https://raw.githubusercontent.com/mongyeonlab-cpu/mylittleterrarium/main/images/%EC%95%A0%EB%B2%8C%EB%A0%88_%EB%B6%88_2%EB%A0%B9.png" style="width:150px;height:150px;vertical-align:middle;">',
                larva3: '<img src="https://raw.githubusercontent.com/mongyeonlab-cpu/mylittleterrarium/main/images/%EC%95%A0%EB%B2%8C%EB%A0%88_%EB%B6%88_3%EB%A0%B9.png" style="width:150px;height:150px;vertical-align:middle;">',
                pupa: '<img src="https://raw.githubusercontent.com/mongyeonlab-cpu/mylittleterrarium/main/images/%EB%B2%88%EB%8D%B0%EA%B8%B0_%EB%B6%88.png" style="width:150px;height:150px;vertical-align:middle;">'
            },
            water: {
                larva1: '<img src="https://raw.githubusercontent.com/mongyeonlab-cpu/mylittleterrarium/main/images/%EC%95%A0%EB%B2%8C%EB%A0%88_%EB%AC%BC_1%EB%A0%B9.png" style="width:150px;height:150px;vertical-align:middle;">',
                larva2: '<img src="https://raw.githubusercontent.com/mongyeonlab-cpu/mylittleterrarium/main/images/%EC%95%A0%EB%B2%8C%EB%A0%88_%EB%AC%BC_2%EB%A0%B9.png" style="width:150px;height:150px;vertical-align:middle;">',
                larva3: '<img src="https://raw.githubusercontent.com/mongyeonlab-cpu/mylittleterrarium/main/images/%EC%95%A0%EB%B2%8C%EB%A0%88_%EB%AC%BC_3%EB%A0%B9.png" style="width:150px;height:150px;vertical-align:middle;">'
            }
        };
        
        // ì†ì„±ì„ ê³ ë ¤í•œ ìŠ¤í…Œì´ì§€ ì•„ì´ì½˜ ê°€ì ¸ì˜¤ê¸°
        function getStageIcon(stage, spirit) {
            // ê¸°ë³¸ ì•„ì´ì½˜
            let icon = STAGE_ICONS[stage];
            
            // ì •ë ¹ì´ ìˆê³ , ì†ì„±ë³„ ì•„ì´ì½˜ì´ ìˆëŠ” ê²½ìš°
            if (spirit && spirit.hiddenAttributes) {
                const dominantAttr = getDominantAttribute(spirit);
                if (dominantAttr && ATTRIBUTE_STAGE_ICONS[dominantAttr]) {
                    const attrIcons = ATTRIBUTE_STAGE_ICONS[dominantAttr];
                    if (attrIcons[stage]) {
                        icon = attrIcons[stage];
                    }
                }
            }
            
            return icon;
        }

        const STAGE_NAMES = {
            egg: 'ì•Œ',
            larva1: 'ì• ë²Œë ˆ 1ë ¹',
            larva2: 'ì• ë²Œë ˆ 2ë ¹',
            larva3: 'ì• ë²Œë ˆ 3ë ¹',
            pupa: 'ë²ˆë°ê¸°',
            adult: 'ì„±ì¶©'
        };
        
        // ì„±ì¥ ë‹¨ê³„ë³„ ì†ì„± ì™¸í˜• ë¬˜ì‚¬
        const APPEARANCE_DESCRIPTIONS = {
            egg: {
                fire: 'ê»ì§ˆì´ ë”°ëœ»í•˜ê³  ë¯¸ì„¸í•œ ì—´ê¸°ê°€ ëŠê»´ì§‘ë‹ˆë‹¤.',
                water: 'ì´‰ì´‰í•˜ê³  íˆ¬ëª…í•œ ê´‘íƒì´ íë¦…ë‹ˆë‹¤.',
                wind: 'ê»ì§ˆì´ ë¶€ë“œëŸ½ê³  ê°€ë³ìŠµë‹ˆë‹¤.',
                earth: 'ë‹¨ë‹¨í•˜ê³  ê±°ì¹œ ì§ˆê°ì´ ìˆìŠµë‹ˆë‹¤.',
                light: 'ì€ì€í•œ ë¹›ì´ ë‚´ë¶€ì—ì„œ ë¹„ì¹©ë‹ˆë‹¤.',
                dark: 'ì§™ì€ ìƒ‰ìœ¼ë¡œ ê¹Šì´ë¥¼ ì•Œ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.',
                normal: 'í‰ë²”í•œ í°ìƒ‰ ì•Œì…ë‹ˆë‹¤.'
            },
            larva1: {
                fire: 'ëª¸ì´ ë¶‰ê²Œ ë¬¼ë“¤ê³  ë”°ëœ»í•œ ê¸°ìš´ì´ ëŠê»´ì§‘ë‹ˆë‹¤.',
                water: 'ì´‰ì´‰í•œ í”¼ë¶€ì—ì„œ ë¬¼ë°©ìš¸ì´ ë§ºí™ë‹ˆë‹¤.',
                wind: 'ëª¸ì´ ê°€ë³ê³  ë°”ëŒì— í”ë“¤ë¦½ë‹ˆë‹¤.',
                earth: 'ë‹¨ë‹¨í•œ ê°ˆìƒ‰ í”¼ë¶€ë¡œ ë®ì—¬ìˆìŠµë‹ˆë‹¤.',
                light: 'ì˜¨ëª¸ì—ì„œ ì€ì€í•œ ë¹›ì´ ë‚©ë‹ˆë‹¤.',
                dark: 'ì–´ë‘ìš´ ë³´ë¼ë¹› ëª¸ì„ í•˜ê³  ìˆìŠµë‹ˆë‹¤.',
                normal: 'íˆ¬ëª…í•œ ì´ˆë¡ë¹› ëª¸ì„ í•˜ê³  ìˆìŠµë‹ˆë‹¤.'
            },
            larva2: {
                fire: 'ì™¸ê²¬ì´ ë¶‰ê³ , ë§Œì¡Œì„ ë•Œ ë”°ëœ»í•˜ë©° ì§§ì€ ë”ë“¬ì´ê°€ ë¶ˆê½ƒì²˜ëŸ¼ ì¼ë ì…ë‹ˆë‹¤.',
                water: 'í‘¸ë¥¸ë¹›ì´ ë„ëŠ” ëª¸ì—ì„œ ì‹œì›í•œ ê¸°ìš´ì´ ë‚˜ë©°, ëª¸ í‘œë©´ì— ë¬¼ê²° ë¬´ëŠ¬ê°€ ìˆìŠµë‹ˆë‹¤.',
                wind: 'ì—°í•œ í•˜ëŠ˜ìƒ‰ ëª¸ì— ê¹ƒí„¸ ê°™ì€ ì†œí„¸ì´ ë‹ì•„ìˆê³ , ê³µì¤‘ì— ë‘¥ë‘¥ ë– ì˜¤ë¦…ë‹ˆë‹¤.',
                earth: 'ê°ˆìƒ‰ë¹› ëª¸ì— ì‘ì€ ì´ë¼ê°€ ìë¼ê³ , ë§Œì§€ë©´ í™ ëƒ„ìƒˆê°€ ë‚©ë‹ˆë‹¤.',
                light: 'ê¸ˆë¹›ìœ¼ë¡œ ë¹›ë‚˜ëŠ” ëª¸ì—ì„œ ë”°ëœ»í•œ ë¹›ì´ ë°œì‚°ë˜ë©°, ì£¼ë³€ì„ ë°í™ë‹ˆë‹¤.',
                dark: 'ê¹Šì€ ë‚¨ìƒ‰ ëª¸ì— ë³„ë¹› ê°™ì€ ë°˜ì ì´ ìˆê³ , ì£¼ë³€ì˜ ë¹›ì„ í¡ìˆ˜í•©ë‹ˆë‹¤.',
                normal: 'íˆ¬ëª…í•œ ëª¸ì— ë¬´ì§€ê°œë¹›ì´ ì€ì€í•˜ê²Œ ê°ë•ë‹ˆë‹¤.',
                // í˜¼í•© ì†ì„±
                'dark-earth': 'ì–´ë‘ìš´ ê°ˆìƒ‰ ëª¸ì— ë°¤ ì´ìŠ¬ì´ ë§ºíˆê³  í™ì˜ í–¥ê¸°ê°€ ë‚©ë‹ˆë‹¤.',
                'dark-fire': 'ê²€ë¶‰ì€ ëª¸ì—ì„œ ì–´ë‘ìš´ ì—´ê¸°ê°€ í”¼ì–´ì˜¤ë¥´ë©° ì‹ ë¹„ë¡œìš´ ë¹›ì´ ê¹œë¹¡ì…ë‹ˆë‹¤.',
                'dark-light': 'ë°˜ì€ ë¹›ë‚˜ê³  ë°˜ì€ ì–´ë‘ìš´ ëª¸ì´ í™©í˜¼ì˜ ì•„ë¦„ë‹¤ì›€ì„ ë‹´ê³  ìˆìŠµë‹ˆë‹¤.',
                'dark-water': 'ì§™ì€ ì²­ìƒ‰ ëª¸ì—ì„œ ì‹¬í•´ì˜ ë¬¼ê²° ë¬´ëŠ¬ê°€ íë¥´ê³  ì°¨ê°€ìš´ ê¸°ìš´ì´ ë‚©ë‹ˆë‹¤.',
                'dark-wind': 'ê²€ì€ ì†œí„¸ì´ ë‹ì€ ëª¸ì´ ë°¤ë°”ëŒì²˜ëŸ¼ ê°€ë³ê²Œ í”ë“¤ë¦½ë‹ˆë‹¤.',
                'earth-fire': 'ë¶‰ì€ í™ë¹› ëª¸ì— ì‘ì€ ë¶ˆê½ƒ ë¬´ëŠ¬ê°€ ìˆê³  ë”°ëœ»í•œ ì˜¨ê¸°ê°€ ëŠê»´ì§‘ë‹ˆë‹¤.',
                'earth-light': 'í™©ê¸ˆë¹› ëª¸ì— ì‘ì€ ìƒˆì‹¹ì´ ë‹ì•„ë‚˜ê³  ìƒëª…ì˜ ë¹›ì„ ë°œí•©ë‹ˆë‹¤.',
                'earth-water': 'ì²­ë¡ìƒ‰ ëª¸ì— ì´ë¼ì™€ ë¬¼ë°©ìš¸ì´ í•¨ê»˜ ë§ºí˜€ìˆê³  ì´‰ì´‰í•©ë‹ˆë‹¤.',
                'earth-wind': 'ì—°ë‘ìƒ‰ ëª¸ì—ì„œ í’€ì í–¥ê¸°ê°€ ë‚˜ê³  ì‚°ë“¤ë°”ëŒì— í”ë“¤ë¦½ë‹ˆë‹¤.',
                'fire-light': 'ëˆˆë¶€ì‹  í™©ê¸ˆë¹› ëª¸ì—ì„œ íƒœì–‘ ê°™ì€ ì—´ê¸°ì™€ ë¹›ì´ ë¿œì–´ì ¸ ë‚˜ì˜µë‹ˆë‹¤.',
                'fire-water': 'ë¶‰ì€ ë³´ë¼ë¹› ëª¸ì—ì„œ ì¦ê¸°ê°€ í”¼ì–´ì˜¤ë¥´ê³  ì—´ê¸°ì™€ ìŠµê¸°ê°€ ë’¤ì„ì…ë‹ˆë‹¤.',
                'fire-wind': 'ì£¼í™©ìƒ‰ ëª¸ ì£¼ë³€ìœ¼ë¡œ ëœ¨ê±°ìš´ ë°”ëŒì´ ì¼ë ì´ë©° íë¦…ë‹ˆë‹¤.',
                'light-water': 'ë§‘ì€ í•˜ëŠ˜ë¹› ëª¸ì—ì„œ ì€ì€í•œ ë¹›ê³¼ ì‹œì›í•œ ë¬¼ë°©ìš¸ì´ íë¦…ë‹ˆë‹¤.',
                'light-wind': 'ë¹›ë‚˜ëŠ” í° ì†œí„¸ì— ë‘˜ëŸ¬ì‹¸ì—¬ ë¹›ì˜ ë°”ëŒì„ íƒ€ê³  ë– ì˜¤ë¦…ë‹ˆë‹¤.',
                'water-wind': 'í•˜ëŠ˜ìƒ‰ ëª¸ ì£¼ë³€ì— ë¬¼ì•ˆê°œê°€ ê°ëŒê³  ì‚°ë“¤ë°”ëŒì´ ë¶ˆì–´ì˜µë‹ˆë‹¤.'
            },
            larva3: {
                fire: 'ì˜¨ëª¸ì´ ì£¼í™©ë¹› ë¶ˆê½ƒìœ¼ë¡œ ê°ì‹¸ì—¬ ìˆê³ , ìˆ¨ì„ ì‰´ ë•Œë§ˆë‹¤ ì‘ì€ ë¶ˆë˜¥ì´ íŠ‘ë‹ˆë‹¤.',
                water: 'ê¹Šì€ ì²­ë¡ìƒ‰ ëª¸ì—ì„œ ì‘ì€ ë¬¼ì¤„ê¸°ê°€ í˜ëŸ¬ë‚´ë¦¬ê³ , ì£¼ë³€ ê³µê¸°ê°€ ì¶•ì¶•í•©ë‹ˆë‹¤.',
                wind: 'ì€ë¹› ë‚ ê°œ ë¹„ëŠ˜ì´ ë‹ì•„ë‚˜ê³ , ì›€ì§ì¼ ë•Œë§ˆë‹¤ ë°”ëŒì´ ì¼ì–´ë‚©ë‹ˆë‹¤.',
                earth: 'ë‹¨ë‹¨í•œ ë‚˜ë¬´ê»ì§ˆ ê°™ì€ ì™¸í”¼ì— ì‘ì€ ê½ƒë´‰ì˜¤ë¦¬ê°€ í”¼ì–´ìˆìŠµë‹ˆë‹¤.',
                light: 'ëˆˆë¶€ì‹  í™©ê¸ˆë¹›ìœ¼ë¡œ ë¹›ë‚˜ë©°, ì£¼ë³€ì— ë¬´ì§€ê°œ í›„ê´‘ì´ ë³´ì…ë‹ˆë‹¤.',
                dark: 'ì¹ í‘ ê°™ì€ ëª¸ì— ì€í•˜ìˆ˜ ê°™ì€ ë¹›ì˜ ë ê°€ íë¥´ê³ , ê·¸ë¦¼ìê°€ ì¶¤ì¶¥ë‹ˆë‹¤.',
                normal: 'ë§‘ê³  íˆ¬ëª…í•œ ëª¸ì— ëª¨ë“  ìƒ‰ì´ ì€ì€í•˜ê²Œ ì–´ìš°ëŸ¬ì§‘ë‹ˆë‹¤.',
                // í˜¼í•© ì†ì„±
                'dark-earth': 'ê²€ì€ ë‚˜ë¬´ê»ì§ˆ ê°™ì€ ì™¸í”¼ì— ë°¤ê½ƒì´ í”¼ì–´ìˆê³  ì–´ë‘ ì˜ í–¥ê¸°ê°€ ë‚©ë‹ˆë‹¤.',
                'dark-fire': 'ê²€ë¶‰ì€ ë¶ˆê½ƒì´ ì–´ë‘  ì†ì—ì„œ íƒ€ì˜¤ë¥´ë©° ì‘ì€ ë¶ˆë˜¥ê³¼ ê·¸ë¦¼ìê°€ ì¶¤ì¶¥ë‹ˆë‹¤.',
                'dark-light': 'ë¹›ê³¼ ì–´ë‘ ì´ êµì°¨í•˜ëŠ” ëª¸ì—ì„œ ìƒˆë²½ê³¼ í™©í˜¼ì˜ ê¸°ìš´ì´ ë™ì‹œì— ëŠê»´ì§‘ë‹ˆë‹¤.',
                'dark-water': 'ê¹Šì€ ë‚¨ìƒ‰ ëª¸ì—ì„œ ë°¤ë°”ë‹¤ì˜ ë¬¼ê²°ì´ íë¥´ê³  ì‹ ë¹„ë¡œìš´ ë¬¼ë°©ìš¸ì´ ë§ºí™ë‹ˆë‹¤.',
                'dark-wind': 'ê²€ì€ ë‚ ê°œ ë¹„ëŠ˜ì´ ë‹ì•„ë‚˜ë©° ë°¤ë°”ëŒì´ ì†Œìš©ëŒì´ì¹˜ê³  ê·¸ë¦¼ìê°€ í©ë‚ ë¦½ë‹ˆë‹¤.',
                'earth-fire': 'ì ê°ˆìƒ‰ ëª¸ì—ì„œ ìš©ì•” ê°™ì€ ì—´ê¸°ê°€ ë¿œì–´ì ¸ ë‚˜ì˜¤ê³  ì‘ì€ ê½ƒë¶ˆì´ í•ë‹ˆë‹¤.',
                'earth-light': 'í™©ê¸ˆë¹› ë‚˜ë¬´ê»ì§ˆì— ë¹›ë‚˜ëŠ” ê½ƒë“¤ì´ ë§Œê°œí•˜ê³  ìƒëª…ì˜ í›„ê´‘ì´ ë¹›ë‚©ë‹ˆë‹¤.',
                'earth-water': 'ì²­ë¡ìƒ‰ ëª¸ì— ì´ë¼ì™€ ë¬¼ì´ë¼ê°€ ìë¼ê³  ê³„ê³¡ë¬¼ì´ í˜ëŸ¬ë‚´ë¦½ë‹ˆë‹¤.',
                'earth-wind': 'ì—°ë‘ë¹› ëª¸ì—ì„œ ìƒˆì‹¹ì´ ë‹ì•„ë‚˜ê³  ë´„ë°”ëŒì— ì‹¤ë ¤ í–¥ê¸°ê°€ í¼ì§‘ë‹ˆë‹¤.',
                'fire-light': 'ì°¬ë€í•œ íƒœì–‘ë¹› ë¶ˆê½ƒì´ ì˜¨ëª¸ì„ ê°ì‹¸ê³  ëˆˆë¶€ì‹  í™©ê¸ˆë¹›ì´ í­ë°œí•©ë‹ˆë‹¤.',
                'fire-water': 'ë¶‰ì€ ëª¸ì—ì„œ ëœ¨ê±°ìš´ ì¦ê¸°ê°€ ì†Ÿì•„ì˜¤ë¥´ê³  ë¬¼ê³¼ ë¶ˆì´ ì—­ë™ì ìœ¼ë¡œ ì¶©ëŒí•©ë‹ˆë‹¤.',
                'fire-wind': 'ì£¼í™©ë¹› ëª¸ ì£¼ë³€ìœ¼ë¡œ ì—´í’ì´ ì†Œìš©ëŒì´ì¹˜ê³  ë¶ˆê½ƒì´ ë°”ëŒì„ íƒ€ê³  ì¶¤ì¶¥ë‹ˆë‹¤.',
                'light-water': 'ì€ì€í•œ ì²­ë°±ìƒ‰ ëª¸ì—ì„œ ë§‘ì€ ë¹›ê³¼ ë¬¼ë°©ìš¸ì´ ì¡°í™”ë¡­ê²Œ íë¦…ë‹ˆë‹¤.',
                'light-wind': 'ë¹›ë‚˜ëŠ” ì€ë¹› ë‚ ê°œ ë¹„ëŠ˜ì´ ë¹›ì˜ ë°”ëŒì„ ì¼ìœ¼í‚¤ë©° ë¬´ì§€ê°œë¹›ìœ¼ë¡œ ë°˜ì§ì…ë‹ˆë‹¤.',
                'water-wind': 'í•˜ëŠ˜ë¹› ëª¸ ì£¼ë³€ì— ë¬¼ë³´ë¼ì™€ ë°”ëŒì´ ì†Œìš©ëŒì´ì¹˜ë©° ì•„ë¦„ë‹¤ìš´ ì•ˆê°œë¥¼ ë§Œë“­ë‹ˆë‹¤.'
            },
            pupa: {
                fire: 'ë¶‰ì€ ìˆ˜ì • ê°™ì€ ë²ˆë°ê¸°ì—ì„œ ì—´ê¸°ê°€ í”¼ì–´ì˜¤ë¥´ê³ , ë‚´ë¶€ì— ë¶ˆê½ƒì´ ì¶¤ì¶¥ë‹ˆë‹¤.',
                water: 'í‘¸ë¥¸ ì–¼ìŒ ê°™ì€ ë²ˆë°ê¸° ì†ì—ì„œ ë¬¼ê²°ì´ ì¼ë ì´ë©° ë³€í™”ê°€ ì¼ì–´ë‚©ë‹ˆë‹¤.',
                wind: 'í•˜ì–€ êµ¬ë¦„ ê°™ì€ ë²ˆë°ê¸°ê°€ ê³µì¤‘ì— ë– ìˆê³ , ë°”ëŒì— ë§ì¶° íšŒì „í•©ë‹ˆë‹¤.',
                earth: 'ë‚˜ë¬´ ì˜¹ì´ ê°™ì€ ë²ˆë°ê¸°ì—ì„œ ìƒˆìˆœì´ ë‹ì•„ë‚˜ê³  ìˆìŠµë‹ˆë‹¤.',
                light: 'ë¹›ë‚˜ëŠ” í¬ë¦¬ìŠ¤íƒˆ ë²ˆë°ê¸°ì—ì„œ ë¬´ì§€ê°œë¹›ì´ í¼ì ¸ë‚˜ì˜µë‹ˆë‹¤.',
                dark: 'ê²€ì€ ë³´ì„ ê°™ì€ ë²ˆë°ê¸°ì—ì„œ ì‹ ë¹„ë¡œìš´ ë³„ë¹›ì´ ê¹œë¹¡ì…ë‹ˆë‹¤.',
                normal: 'ìˆœë°±ì˜ ë²ˆë°ê¸°ê°€ ì¡°ìš©íˆ ë³€í™”ë¥¼ ì¤€ë¹„í•˜ê³  ìˆìŠµë‹ˆë‹¤.',
                // í˜¼í•© ì†ì„± (15ê°œ ì¡°í•©)
                'dark-earth': 'ì§™ì€ ê°ˆìƒ‰ ë²ˆë°ê¸°ì—ì„œ ë°¤ì˜ ê¸°ìš´ê³¼ ëŒ€ì§€ì˜ í–¥ê¸°ê°€ ë’¤ì„ì…ë‹ˆë‹¤.',
                'dark-fire': 'ê²€ë¶‰ì€ ë²ˆë°ê¸°ì—ì„œ ì–´ë‘  ì† ë¶ˆê½ƒì´ íƒ€ì˜¤ë¥´ë©° ì‹ ë¹„ë¡œìš´ ì—´ê¸°ê°€ ë‚©ë‹ˆë‹¤.',
                'dark-light': 'í‘ë°±ì´ êµì°¨í•˜ëŠ” ë²ˆë°ê¸°ì—ì„œ ë¹›ê³¼ ì–´ë‘ ì´ ì¡°í™”ë¡­ê²Œ ì¶¤ì¶¥ë‹ˆë‹¤.',
                'dark-water': 'ì§™ì€ ë‚¨ìƒ‰ ë²ˆë°ê¸° ì†ì—ì„œ ì‹¬í•´ì˜ ë¬¼ê²°ì´ ì¼ë ì…ë‹ˆë‹¤.',
                'dark-wind': 'ê²€ì€ êµ¬ë¦„ ê°™ì€ ë²ˆë°ê¸°ê°€ ë°¤ë°”ëŒì„ íƒ€ê³  ì²œì²œíˆ íšŒì „í•©ë‹ˆë‹¤.',
                'earth-fire': 'ë¶‰ì€ í™ë¹› ë²ˆë°ê¸°ì—ì„œ ìš©ì•”ì˜ ì—´ê¸°ì™€ ëŒ€ì§€ì˜ ìƒëª…ë ¥ì´ ëŠê»´ì§‘ë‹ˆë‹¤.',
                'earth-light': 'í™©ê¸ˆë¹› ë‚˜ë¬´ ë²ˆë°ê¸°ì—ì„œ ë”°ëœ»í•œ ë¹›ê³¼ ìƒëª…ì˜ ê¸°ìš´ì´ ë„˜ì¹©ë‹ˆë‹¤.',
                'earth-water': 'ì²­ë¡ìƒ‰ ë²ˆë°ê¸°ì—ì„œ ìˆ²ì˜ ì´ìŠ¬ê³¼ ëŒ€ì§€ì˜ í–¥ê¸°ê°€ ì„ì—¬ ë‚˜ì˜µë‹ˆë‹¤.',
                'earth-wind': 'ì—°ë‘ë¹› ë²ˆë°ê¸°ê°€ ë¯¸í’ì— í”ë“¤ë¦¬ë©° ìƒˆì‹¹ì˜ í–¥ê¸°ë¥¼ í’ê¹ë‹ˆë‹¤.',
                'fire-light': 'ì°¬ë€í•œ í™©ê¸ˆë¹› ë²ˆë°ê¸°ì—ì„œ íƒœì–‘ ê°™ì€ ë¹›ê³¼ ì—´ê¸°ê°€ ë¿œì–´ì ¸ ë‚˜ì˜µë‹ˆë‹¤.',
                'fire-water': 'ë¶‰ì€ ìˆ˜ì¦ê¸°ë¡œ ë‘˜ëŸ¬ì‹¸ì¸ ë²ˆë°ê¸°ì—ì„œ ë¶ˆê³¼ ë¬¼ì´ ì—­ë™ì ìœ¼ë¡œ ì„ì…ë‹ˆë‹¤.',
                'fire-wind': 'ì£¼í™©ë¹› ë²ˆë°ê¸° ì£¼ë³€ìœ¼ë¡œ ëœ¨ê±°ìš´ ë°”ëŒì´ ì†Œìš©ëŒì´ì¹©ë‹ˆë‹¤.',
                'light-water': 'ì€ì€í•œ ì²­ë°±ìƒ‰ ë²ˆë°ê¸°ì—ì„œ ë§‘ì€ ë¹›ê³¼ ì‹œì›í•œ ê¸°ìš´ì´ í¼ì§‘ë‹ˆë‹¤.',
                'light-wind': 'ë¹›ë‚˜ëŠ” ë°±ìƒ‰ ë²ˆë°ê¸°ê°€ ë¹›ì˜ ë°”ëŒì„ íƒ€ê³  ë¶€ë“œëŸ½ê²Œ ë– ì˜¤ë¦…ë‹ˆë‹¤.',
                'water-wind': 'í•˜ëŠ˜ë¹› ë²ˆë°ê¸° ì£¼ë³€ì— ë¬¼ì•ˆê°œì™€ ì‚°ë“¤ë°”ëŒì´ ê°ë•ë‹ˆë‹¤.'
            }
        };

        const PARAM_ICONS = {
            intelligence: 'ğŸ§ ',
            strength: 'ğŸ’ª',
            charm: 'ğŸ’–',
            affection: 'â¤ï¸'
        };

        const ENV_ICONS = {
            fire: 'ğŸ”¥',
            water: 'ğŸ’§',
            wind: 'ğŸŒ¬ï¸',
            earth: 'ğŸŒ±',
            light: 'âœ¨',
            dark: 'ğŸŒ™'
        };
        
        const ENV_NAMES = {
            fire: 'ë¶ˆ',
            water: 'ë¬¼',
            wind: 'ë°”ëŒ',
            earth: 'ë•…',
            light: 'ë¹›',
            dark: 'ì–´ë‘ '
        };

        // ê¸°ë³¸ ì•…ê¸° ë ˆì½”ë“œ (ì±„ì§‘/ìƒì )
        const MUSIC_TYPES = {
            // 1ë‹¨ê³„: ê¸°ë³¸ ì•…ê¸° (ì±„ì§‘/ìƒì ì—ì„œ íšë“)
            piano: { name: 'í”¼ì•„ë…¸', icon: 'ğŸ¹', effect: 'ì§€ë ¥ +3', stats: { intelligence: 3 }, tier: 1 },
            violin: { name: 'ë°”ì´ì˜¬ë¦°', icon: 'ğŸ»', effect: 'ì§€ë ¥ +3', stats: { intelligence: 3 }, tier: 1 },
            guitar: { name: 'ê¸°íƒ€', icon: 'ğŸ¸', effect: 'ì²´ë ¥ +3', stats: { strength: 3 }, tier: 1 },
            drum: { name: 'ë“œëŸ¼', icon: 'ğŸ¥', effect: 'ì²´ë ¥ +3', stats: { strength: 3 }, tier: 1 },
            trumpet: { name: 'íŠ¸ëŸ¼í«', icon: 'ğŸº', effect: 'ë§¤ë ¥ +3', stats: { charm: 3 }, tier: 1 },
            synth: { name: 'ì‹ ìŠ¤', icon: 'ğŸ§', effect: 'ë§¤ë ¥ +3', stats: { charm: 3 }, tier: 1 },
            
            // 2ë‹¨ê³„: ì¥ë¥´ ë ˆì½”ë“œ (í•©ì„±ìœ¼ë¡œ íšë“) - ê¸°ì¡´ ë ˆì½”ë“œ í˜¸í™˜
            classic: { name: 'í´ë˜ì‹', icon: 'ğŸ¼', effect: 'ì§€ë ¥ +10', stats: { intelligence: 10 }, tier: 2 },
            jazz: { name: 'ì¬ì¦ˆ', icon: 'ğŸ·', effect: 'ë§¤ë ¥ +10', stats: { charm: 10 }, tier: 2 },
            rock: { name: 'ë¡', icon: 'ğŸ¤˜', effect: 'ì²´ë ¥ +10', stats: { strength: 10 }, tier: 2 },
            pop: { name: 'íŒ', icon: 'ğŸ¤', effect: 'ì§€ë ¥ +5, ë§¤ë ¥ +5', stats: { intelligence: 5, charm: 5 }, tier: 2 },
            ballad: { name: 'ë°œë¼ë“œ', icon: 'ğŸ’•', effect: 'ì²´ë ¥ +5, ë§¤ë ¥ +5', stats: { strength: 5, charm: 5 }, tier: 2 },
            edm: { name: 'EDM', icon: 'âš¡', effect: 'ì§€ë ¥ +5, ì²´ë ¥ +5', stats: { intelligence: 5, strength: 5 }, tier: 2 },
            
            // 3ë‹¨ê³„: í”„ë¦¬ë¯¸ì—„ ì¥ë¥´ (ì¥ë¥´ í•©ì„±ìœ¼ë¡œ íšë“)
            symphonic_metal: { name: 'ì‹¬í¬ë‹‰ ë©”íƒˆ', icon: 'ğŸ”¥ğŸ»', effect: 'ì§€ë ¥ +10, ì²´ë ¥ +5', stats: { intelligence: 10, strength: 5 }, tier: 3 },
            future_jazz: { name: 'í“¨ì²˜ ì¬ì¦ˆ', icon: 'ğŸ·âš¡', effect: 'ë§¤ë ¥ +10, ì§€ë ¥ +5', stats: { charm: 10, intelligence: 5 }, tier: 3 },
            pop_ballad: { name: 'íŒ ë°œë¼ë“œ', icon: 'ğŸ’', effect: 'ë§¤ë ¥ +10, ì²´ë ¥ +5', stats: { charm: 10, strength: 5 }, tier: 3 },
            electro_rock: { name: 'ì¼ë ‰íŠ¸ë¡œ ë¡', icon: 'âš¡ğŸ¸', effect: 'ì²´ë ¥ +10, ì§€ë ¥ +5', stats: { strength: 10, intelligence: 5 }, tier: 3 },
            crossover: { name: 'í¬ë¡œìŠ¤ì˜¤ë²„', icon: 'ğŸ©', effect: 'ì§€ë ¥ +10, ë§¤ë ¥ +5', stats: { intelligence: 10, charm: 5 }, tier: 3 },
            jazz_ballad: { name: 'ì¬ì¦ˆ ë°œë¼ë“œ', icon: 'ğŸŒ™', effect: 'ì²´ë ¥ +10, ë§¤ë ¥ +5', stats: { strength: 10, charm: 5 }, tier: 3 },
            
            // 4ë‹¨ê³„: ì „ì„¤ ì¥ë¥´ (í”„ë¦¬ë¯¸ì—„ í•©ì„±ìœ¼ë¡œ íšë“)
            maestro: { name: 'ë§ˆì—ìŠ¤íŠ¸ë¡œ', icon: 'ğŸ‘‘ğŸµ', effect: 'ì§€ë ¥ +10, ë§¤ë ¥ +10', stats: { intelligence: 10, charm: 10 }, tier: 4 },
            cyberpunk: { name: 'ì‚¬ì´ë²„í‘í¬', icon: 'ğŸ¤–ğŸ¸', effect: 'ì§€ë ¥ +10, ì²´ë ¥ +10', stats: { intelligence: 10, strength: 10 }, tier: 4 },
            serenade: { name: 'ì„¸ë ˆë‚˜ë°', icon: 'ğŸ’•ğŸŒ¹', effect: 'ë§¤ë ¥ +10, ì²´ë ¥ +10', stats: { charm: 10, strength: 10 }, tier: 4 }
        };
        
        // ì±„ì§‘/ìƒì ìš© ê¸°ë³¸ ì•…ê¸° ëª©ë¡
        const BASIC_MUSIC = ['piano', 'violin', 'guitar', 'drum', 'trumpet', 'synth'];

        const DECORATION_TYPES = {
            // ë¶ˆ ì†ì„± (6ê°œ)
            fire_common1: { name: 'ìš©ì•”ì„', icon: 'ğŸ”¥', attr: 'fire', power: 1, quality: 'common', price: 30 },
            fire_common2: { name: 'í™”ì‚°ì¬', icon: 'ğŸŒ‹', attr: 'fire', power: 1, quality: 'common', price: 30 },
            fire_rare1: { name: 'ë¶ˆê½ƒ ì¡°ê°ìƒ', icon: 'ğŸ”†', attr: 'fire', power: 2, quality: 'rare', price: 60 },
            fire_rare2: { name: 'íƒ€ì˜¤ë¥´ëŠ” ë¨í”„', icon: 'ğŸ®', attr: 'fire', power: 2, quality: 'rare', price: 60 },
            fire_epic: { name: 'ë¶ˆì‚¬ì¡° ê¹ƒí„¸', icon: 'ğŸ¦…', attr: 'fire', power: 3, quality: 'epic', price: 100 },
            fire_legendary: { name: 'íƒœì´ˆì˜ ë¶ˆê½ƒ', icon: 'ğŸ”±', attr: 'fire', power: 5, quality: 'legendary', price: 999 },
            
            // ë¬¼ ì†ì„± (6ê°œ)
            water_common1: { name: 'ë¶„ìˆ˜', icon: 'ğŸ’§', attr: 'water', power: 1, quality: 'common', price: 30 },
            water_common2: { name: 'ì¡°ì•½ëŒ', icon: 'ğŸª¨', attr: 'water', power: 1, quality: 'common', price: 30 },
            water_rare1: { name: 'ì‚°í˜¸ ì¥ì‹', icon: 'ğŸª¸', attr: 'water', power: 2, quality: 'rare', price: 60 },
            water_rare2: { name: 'ë¬¼ë°©ìš¸ êµ¬ìŠ¬', icon: 'ğŸ’', attr: 'water', power: 2, quality: 'rare', price: 60 },
            water_epic: { name: 'ì¸ì–´ì˜ ëˆˆë¬¼', icon: 'ğŸ§œ', attr: 'water', power: 3, quality: 'epic', price: 100 },
            water_legendary: { name: 'ì‹¬í•´ì˜ ì‹¬ì¥', icon: 'ğŸ«€', attr: 'water', power: 5, quality: 'legendary', price: 999 },
            
            // ë°”ëŒ ì†ì„± (6ê°œ)
            wind_common1: { name: 'ë°”ëŒê°œë¹„', icon: 'ğŸŒ¬ï¸', attr: 'wind', power: 1, quality: 'common', price: 30 },
            wind_common2: { name: 'ë¶€ë“œëŸ¬ìš´ ê¹ƒí„¸', icon: 'ğŸª¶', attr: 'wind', power: 1, quality: 'common', price: 30 },
            wind_rare1: { name: 'í’ê²½', icon: 'ğŸ', attr: 'wind', power: 2, quality: 'rare', price: 60 },
            wind_rare2: { name: 'ë¯¼ë“¤ë ˆ ì†œí„¸', icon: 'ğŸŒ¾', attr: 'wind', power: 2, quality: 'rare', price: 60 },
            wind_epic: { name: 'í•˜ëŠ˜ì˜ ê¹ƒí„¸', icon: 'â˜ï¸', attr: 'wind', power: 3, quality: 'epic', price: 100 },
            wind_legendary: { name: 'í­í’ì˜ ëˆˆ', icon: 'ğŸŒ€', attr: 'wind', power: 5, quality: 'legendary', price: 999 },
            
            // ë•… ì†ì„± (6ê°œ)
            earth_common1: { name: 'í™”ë¶„', icon: 'ğŸŒ±', attr: 'earth', power: 1, quality: 'common', price: 30 },
            earth_common2: { name: 'ì´ë¼ëŒ', icon: 'ğŸªµ', attr: 'earth', power: 1, quality: 'common', price: 30 },
            earth_rare1: { name: 'ë‚˜ë¬´ ì¡°ê°', icon: 'ğŸŒ³', attr: 'earth', power: 2, quality: 'rare', price: 60 },
            earth_rare2: { name: 'ë²„ì„¯ êµ°ë½', icon: 'ğŸ„', attr: 'earth', power: 2, quality: 'rare', price: 60 },
            earth_epic: { name: 'ì„¸ê³„ìˆ˜ ê°€ì§€', icon: 'ğŸŒ²', attr: 'earth', power: 3, quality: 'epic', price: 100 },
            earth_legendary: { name: 'ëŒ€ì§€ì˜ ì •ìˆ˜', icon: 'ğŸ’', attr: 'earth', power: 5, quality: 'legendary', price: 999 },
            
            // ë¹› ì†ì„± (6ê°œ)
            light_common1: { name: 'ìˆ˜ì •', icon: 'âœ¨', attr: 'light', power: 1, quality: 'common', price: 30 },
            light_common2: { name: 'ë°˜ì§ì´ ê°€ë£¨', icon: 'â­', attr: 'light', power: 1, quality: 'common', price: 30 },
            light_rare1: { name: 'ë¹›ë‚˜ëŠ” ë³´ì„', icon: 'ğŸ’ ', attr: 'light', power: 2, quality: 'rare', price: 60 },
            light_rare2: { name: 'íƒœì–‘ì„', icon: 'â˜€ï¸', attr: 'light', power: 2, quality: 'rare', price: 60 },
            light_epic: { name: 'ë³„ì˜ íŒŒí¸', icon: 'ğŸŒŸ', attr: 'light', power: 3, quality: 'epic', price: 100 },
            light_legendary: { name: 'ì²œìƒì˜ ê´‘íœ˜', icon: 'ğŸ‘¼', attr: 'light', power: 5, quality: 'legendary', price: 999 },
            
            // ì–´ë‘  ì†ì„± (6ê°œ)
            dark_common1: { name: 'í‘ìš”ì„', icon: 'ğŸŒ™', attr: 'dark', power: 1, quality: 'common', price: 30 },
            dark_common2: { name: 'ê²€ì€ ëª¨ë˜', icon: 'ğŸ–¤', attr: 'dark', power: 1, quality: 'common', price: 30 },
            dark_rare1: { name: 'ë‹¬ë¹›ì„', icon: 'ğŸŒ‘', attr: 'dark', power: 2, quality: 'rare', price: 60 },
            dark_rare2: { name: 'ê·¸ë¦¼ì ìˆ˜ì •', icon: 'ğŸ”®', attr: 'dark', power: 2, quality: 'rare', price: 60 },
            dark_epic: { name: 'ë°¤ì˜ ì •ìˆ˜', icon: 'ğŸŒŒ', attr: 'dark', power: 3, quality: 'epic', price: 100 },
            dark_legendary: { name: 'ì˜ì›í•œ ì–´ë‘ ', icon: 'ğŸ•³ï¸', attr: 'dark', power: 5, quality: 'legendary', price: 999 },
            
            // ë³µí•© ì†ì„± (í¬ê·€)
            dual_fire_water: { name: 'ì¦ê¸°ì˜ ì˜¤ë¥´ê³¨', icon: 'â™¨ï¸', attr: 'dual', power: 1, quality: 'rare', price: 80, dualAttr: ['fire', 'water'] },
            dual_earth_wind: { name: 'ì‚¬ë§‰ì˜ ëª¨ë˜ì‹œê³„', icon: 'â³', attr: 'dual', power: 1, quality: 'rare', price: 80, dualAttr: ['earth', 'wind'] },
            dual_light_dark: { name: 'í™©í˜¼ì˜ ê±°ìš¸', icon: 'ğŸª', attr: 'dual', power: 1, quality: 'rare', price: 80, dualAttr: ['light', 'dark'] },
            all_elements: { name: 'ë¬´ì§€ê°œ í”„ë¦¬ì¦˜', icon: 'ğŸŒˆ', attr: 'all', power: 1, quality: 'rare', price: 120 }
            // í•©ì„± ë¯¸ë‹ˆì–´ì²˜ì€ SYNTH_ITEMSì—ì„œë§Œ ê´€ë¦¬
        };

        const FOOD_NAMES = {
            fire: 'ë¶ˆê½ƒì—´ë§¤',
            water: 'ë§‘ì€ì´ìŠ¬',
            wind: 'ë°”ëŒê¿€',
            earth: 'ëŒ€ì§€ë²„ì„¯',
            light: 'ë¹›ë‚˜ëŠ” ë„¥íƒ€',
            dark: 'ê²€ì€ ê½ƒê°€ë£¨'
        };
        
        // ì•½ì´ˆ ì•„ì´í…œ
        const MEDICINE = {
            name: 'ë§Œë³‘í†µì¹˜ ì•½ì´ˆ',
            icon: 'ğŸŒ¿',
            price: 50,
            description: 'ì •ë ¹ì˜ ì§ˆë³‘ì„ ì¹˜ë£Œí•©ë‹ˆë‹¤'
        };

        // ===== ë ˆì‹œí”¼ë¶ ì •ì˜ =====
        const RECIPE_BOOKS = {
            food: {
                name: 'ë¨¹ì´ ë ˆì‹œí”¼ë¶',
                icon: 'ğŸ“•',
                price: 500,
                desc: 'ëª¨ë“  ë¨¹ì´ í•©ì„± ë ˆì‹œí”¼ê°€ ë‹´ê¸´ ì±…',
                recipes: [
                    'fire_tart', 'water_jelly', 'wind_candy', 'earth_pie', 'light_cookie', 'dark_chocolate', 'rainbow_cake',
                    'fire_water_steam', 'fire_wind_heat', 'fire_earth_lava', 'fire_light_sun', 'fire_dark_ash',
                    'water_wind_mist', 'water_earth_mud', 'water_light_aurora', 'water_dark_abyss',
                    'wind_earth_sand', 'wind_light_sky', 'wind_dark_shadow',
                    'earth_light_crystal', 'earth_dark_cave',
                    'light_dark_twilight'
                ]
            },
            decoration: {
                name: 'ë¯¸ë‹ˆì–´ì²˜ ë ˆì‹œí”¼ë¶',
                icon: 'ğŸ“—',
                price: 250,
                desc: 'ëª¨ë“  ë¯¸ë‹ˆì–´ì²˜ í•©ì„± ë ˆì‹œí”¼ê°€ ë‹´ê¸´ ì±…',
                recipes: [
                    'flame_lamp', 'aqua_fountain', 'wind_chime', 'earth_statue', 'light_orb', 'shadow_crystal'
                ]
            },
            music: {
                name: 'ë ˆì½”ë“œ ë ˆì‹œí”¼ë¶',
                icon: 'ğŸ“˜',
                price: 400,
                desc: 'ëª¨ë“  ë ˆì½”ë“œ í•©ì„± ë ˆì‹œí”¼ê°€ ë‹´ê¸´ ì±…',
                recipes: [
                    // í‹°ì–´ 2: ì¥ë¥´ ë ˆì½”ë“œ
                    'classic', 'jazz', 'rock', 'pop', 'ballad', 'edm',
                    // í‹°ì–´ 3: í”„ë¦¬ë¯¸ì—„ ì¥ë¥´
                    'symphonic_metal', 'future_jazz', 'pop_ballad', 'electro_rock', 'crossover', 'jazz_ballad',
                    // í‹°ì–´ 4: ì „ì„¤ ì¥ë¥´
                    'maestro', 'cyberpunk', 'serenade'
                ]
            }
        };

        // ===== ì—°êµ¬ì‹¤ í•©ì„± ì‹œìŠ¤í…œ =====
        // í•©ì„± ì•„ì´í…œ ì •ì˜ (ê²°ê³¼ë¬¼)
        const SYNTH_ITEMS = {
            // ë¨¹ì´ í•©ì„± ê²°ê³¼ë¬¼ (ë‹¨ì¼ ì†ì„±)
            fire_tart: { name: 'ë¶ˆê½ƒì—´ë§¤ íƒ€ë¥´íŠ¸', icon: 'ğŸ¥§', type: 'food', attr: 'fire', attrGain: 6, affectionGain: 3, growthGain: 2 },
            water_jelly: { name: 'ì´ìŠ¬ ì—ì´ë“œ', icon: 'ğŸ¥¤', type: 'food', attr: 'water', attrGain: 6, affectionGain: 3, growthGain: 2 },
            wind_candy: { name: 'ë°”ëŒê¿€ì°¨', icon: 'ğŸµ', type: 'food', attr: 'wind', attrGain: 6, affectionGain: 3, growthGain: 2 },
            earth_pie: { name: 'ëŒ€ì§€ë²„ì„¯ ë³¶ìŒ', icon: 'ğŸ¥˜', type: 'food', attr: 'earth', attrGain: 6, affectionGain: 3, growthGain: 2 },
            light_cookie: { name: 'ë„¥íƒ€ë¥´', icon: 'ğŸ¯', type: 'food', attr: 'light', attrGain: 6, affectionGain: 3, growthGain: 2 },
            dark_chocolate: { name: 'ë‹¤í¬ ì´ˆì½œë¦¿', icon: 'ğŸ«', type: 'food', attr: 'dark', attrGain: 6, affectionGain: 3, growthGain: 2 },
            rainbow_cake: { name: 'ë¬´ì§€ê°œ ì¼€ì´í¬', icon: 'ğŸ‚', type: 'food', attr: 'dual', dualAttr: ['light', 'dark'], attrGain: 4, affectionGain: 3, growthGain: 2 },
            
            // í¬ê·€ í•©ì„± ì¬ë£Œ (íš¨ê³¼ ì—†ìŒ)
            moon_cheese: { name: 'ë‹¬ì¹˜ì¦ˆ', icon: 'ğŸ§€ğŸŒ™', type: 'food', attr: 'dark', attrGain: 0, affectionGain: 0, growthGain: 0 },
            golden_apple: { name: 'í™©ê¸ˆì‚¬ê³¼', icon: 'ğŸâœ¨', type: 'food', attr: 'light', attrGain: 0, affectionGain: 0, growthGain: 0 },
            
            // ì „ì„¤ í•©ì„± ë¨¹ì´
            celestial_sandwich: { name: 'ì²œì²´ì˜ ìƒŒë“œìœ„ì¹˜', icon: 'ğŸ¥ªğŸŒŒ', type: 'food', attr: 'all', attrGain: 5, affectionGain: 5, growthGain: 2 },
            
            // ë¨¹ì´ í•©ì„± ê²°ê³¼ë¬¼ (í˜¼í•© ì†ì„±)
            fire_water_steam: { name: 'ìŠ¤íŒ€ í‘¸ë”©', icon: 'â™¨ï¸', type: 'food', attr: 'dual', dualAttr: ['fire', 'water'], attrGain: 4, affectionGain: 3, growthGain: 2 },
            fire_wind_heat: { name: 'ì—´í’ í¬ë˜ì»¤', icon: 'ğŸŒªï¸', type: 'food', attr: 'dual', dualAttr: ['fire', 'wind'], attrGain: 4, affectionGain: 3, growthGain: 2 },
            fire_earth_lava: { name: 'í™”ì‚° ìŠ¤í”„', icon: 'ğŸ²', type: 'food', attr: 'dual', dualAttr: ['fire', 'earth'], attrGain: 4, affectionGain: 3, growthGain: 2 },
            fire_light_sun: { name: 'íƒœì–‘ íƒ€ë¥´íŠ¸', icon: 'ğŸŒ…', type: 'food', attr: 'dual', dualAttr: ['fire', 'light'], attrGain: 4, affectionGain: 3, growthGain: 2 },
            fire_dark_ash: { name: 'ì¿ë¹› ë¨¸ë­ì¿ í‚¤', icon: 'ğŸ–¤', type: 'food', attr: 'dual', dualAttr: ['fire', 'dark'], attrGain: 4, affectionGain: 3, growthGain: 2 },
            water_wind_mist: { name: 'ì•ˆê°œ ìº”ë””', icon: 'ğŸŒ«ï¸', type: 'food', attr: 'dual', dualAttr: ['water', 'wind'], attrGain: 4, affectionGain: 3, growthGain: 2 },
            water_earth_pond: { name: 'ì—°ëª» ìƒëŸ¬ë“œ', icon: 'ğŸ¥—', type: 'food', attr: 'dual', dualAttr: ['water', 'earth'], attrGain: 4, affectionGain: 3, growthGain: 2 },
            water_light_ice: { name: 'ë¹™í•˜ ì•„ì´ìŠ¤ë°”', icon: 'ğŸ§Š', type: 'food', attr: 'dual', dualAttr: ['water', 'light'], attrGain: 4, affectionGain: 3, growthGain: 2 },
            water_dark_deep: { name: 'ì‹¬í•´ ì ¤ë¦¬', icon: 'ğŸª¼', type: 'food', attr: 'dual', dualAttr: ['water', 'dark'], attrGain: 4, affectionGain: 3, growthGain: 2 },
            wind_earth_desert: { name: 'í™©ì•¼ ë¹„ìŠ¤í‚·', icon: 'ğŸœï¸', type: 'food', attr: 'dual', dualAttr: ['wind', 'earth'], attrGain: 4, affectionGain: 3, growthGain: 2 },
            wind_light_cloud: { name: 'êµ¬ë¦„ ì†œì‚¬íƒ•', icon: 'â˜ï¸', type: 'food', attr: 'dual', dualAttr: ['wind', 'light'], attrGain: 4, affectionGain: 3, growthGain: 2 },
            wind_dark_night: { name: 'ë°¤ë°”ëŒì²­', icon: 'ğŸŒƒ', type: 'food', attr: 'dual', dualAttr: ['wind', 'dark'], attrGain: 4, affectionGain: 3, growthGain: 2 },
            earth_light_sprout: { name: 'ìƒˆì‹¹ íŒŒì´', icon: 'ğŸŒ¿', type: 'food', attr: 'dual', dualAttr: ['earth', 'light'], attrGain: 4, affectionGain: 3, growthGain: 2 },
            earth_dark_mushroom: { name: 'ë™êµ´ ë²„ì„¯ ìˆ˜í”„', icon: 'ğŸ„', type: 'food', attr: 'dual', dualAttr: ['earth', 'dark'], attrGain: 4, affectionGain: 3, growthGain: 2 },
            
            // íŠ¹ìˆ˜ ë¨¹ì´ - ì„±ì¥ ì–µì œ
            dark_nectar: { name: 'ì•”í‘ì˜ ë„¥íƒ€ë¥´', icon: 'ğŸ–¤ğŸ¯', type: 'food', attr: 'special', attrGain: 0, affectionGain: 2, growthGain: -2, desc: 'ì„±ì¥ì„ ëŠ¦ì¶”ëŠ” ì‹ ë¹„í•œ ìŒë£Œ' },
            
            // íŠ¹ìˆ˜ ë¨¹ì´ - í™”í•´ íš¨ê³¼ (ì•™ìˆ™ ì „ìš©)
            reconciliation_flower: { name: 'ìˆ˜ì„ í™” ê½ƒì', icon: 'ğŸŒ¼ğŸ’«', type: 'food', attr: 'special', attrGain: 0, affectionGain: 5, growthGain: 2, desc: 'ì•™ìˆ™ ê´€ê³„ì¸ ì •ë ¹ì—ê²Œ ì‚¬ìš©. 30ë¶„ê°„ ì‹¸ìš°ì§€ ì•ŠìŠµë‹ˆë‹¤', effectDuration: 30 * 60 * 1000, requiresRival: true },
            
            // íŠ¹ìˆ˜ ë¨¹ì´ - ì¹œë°€ë„ ì¦ê°€ íš¨ê³¼
            acacia_honey: { name: 'ì•„ì¹´ì‹œì•„ ê¿€', icon: 'ğŸ¯âœ¨', type: 'food', attr: 'special', attrGain: 0, affectionGain: 3, growthGain: 2, desc: '30ë¶„ê°„ ë‹¤ë¥¸ ì •ë ¹ê³¼ ë¹ ë¥´ê²Œ ì¹œí•´ì§‘ë‹ˆë‹¤', effectDuration: 30 * 60 * 1000 },
            
            // ë¯¸ë‹ˆì–´ì²˜ í•©ì„± ê²°ê³¼ë¬¼
            flame_lamp: { name: 'í™”ì—¼ ë¨í”„', icon: 'ğŸ®', type: 'decoration', attr: 'fire', power: 3, quality: 'rare' },
            aqua_fountain: { name: 'ì•„ì¿ ì•„ ë¶„ìˆ˜', icon: 'â›²', type: 'decoration', attr: 'water', power: 3, quality: 'rare' },
            wind_chime: { name: 'ë°”ëŒì˜ ì¢…', icon: 'ğŸ””', type: 'decoration', attr: 'wind', power: 3, quality: 'rare' },
            earth_statue: { name: 'ëŒ€ì§€ì˜ ì„ìƒ', icon: 'ğŸ—¿', type: 'decoration', attr: 'earth', power: 3, quality: 'rare' },
            light_orb: { name: 'ë¹›ì˜ ì˜¤ë¸Œ', icon: 'ğŸ’¡', type: 'decoration', attr: 'light', power: 3, quality: 'rare' },
            shadow_crystal: { name: 'ê·¸ë¦¼ì ê²°ì •', icon: 'ğŸ”³', type: 'decoration', attr: 'dark', power: 3, quality: 'rare' }
        };
        
        // í•©ì„± ë ˆì‹œí”¼ ì •ì˜
        const RECIPES = {
            // ë¨¹ì´ í•©ì„± (ê°™ì€ ë¨¹ì´ 5+5 = íƒ€ë¥´íŠ¸ë¥˜ 3ê°œ)
            fire_tart: {
                ingredients: [
                    { type: 'fire', category: 'food', count: 5 },
                    { type: 'fire', category: 'food', count: 5 }
                ],
                result: { type: 'fire_tart', count: 3 },
                category: 'food'
            },
            water_jelly: {
                ingredients: [
                    { type: 'water', category: 'food', count: 5 },
                    { type: 'water', category: 'food', count: 5 }
                ],
                result: { type: 'water_jelly', count: 3 },
                category: 'food'
            },
            wind_candy: {
                ingredients: [
                    { type: 'wind', category: 'food', count: 5 },
                    { type: 'wind', category: 'food', count: 5 }
                ],
                result: { type: 'wind_candy', count: 3 },
                category: 'food'
            },
            earth_pie: {
                ingredients: [
                    { type: 'earth', category: 'food', count: 5 },
                    { type: 'earth', category: 'food', count: 5 }
                ],
                result: { type: 'earth_pie', count: 3 },
                category: 'food'
            },
            light_cookie: {
                ingredients: [
                    { type: 'light', category: 'food', count: 5 },
                    { type: 'light', category: 'food', count: 5 }
                ],
                result: { type: 'light_cookie', count: 3 },
                category: 'food'
            },
            dark_chocolate: {
                ingredients: [
                    { type: 'dark', category: 'food', count: 5 },
                    { type: 'dark', category: 'food', count: 5 }
                ],
                result: { type: 'dark_chocolate', count: 3 },
                category: 'food'
            },
            rainbow_cake: {
                ingredients: [
                    { type: 'light', category: 'food', count: 3 },
                    { type: 'dark', category: 'food', count: 3 }
                ],
                result: { type: 'rainbow_cake', count: 1 },
                category: 'food'
            },
            // í˜¼í•© ì†ì„± ë¨¹ì´ (ì„œë¡œ ë‹¤ë¥¸ ì†ì„± 3+3 = í˜¼í•© ë¨¹ì´ 2ê°œ)
            fire_water_steam: {
                ingredients: [
                    { type: 'fire', category: 'food', count: 3 },
                    { type: 'water', category: 'food', count: 3 }
                ],
                result: { type: 'fire_water_steam', count: 2 },
                category: 'food'
            },
            fire_wind_heat: {
                ingredients: [
                    { type: 'fire', category: 'food', count: 3 },
                    { type: 'wind', category: 'food', count: 3 }
                ],
                result: { type: 'fire_wind_heat', count: 2 },
                category: 'food'
            },
            fire_earth_lava: {
                ingredients: [
                    { type: 'fire', category: 'food', count: 3 },
                    { type: 'earth', category: 'food', count: 3 }
                ],
                result: { type: 'fire_earth_lava', count: 2 },
                category: 'food'
            },
            fire_light_sun: {
                ingredients: [
                    { type: 'fire', category: 'food', count: 3 },
                    { type: 'light', category: 'food', count: 3 }
                ],
                result: { type: 'fire_light_sun', count: 2 },
                category: 'food'
            },
            fire_dark_ash: {
                ingredients: [
                    { type: 'fire', category: 'food', count: 3 },
                    { type: 'dark', category: 'food', count: 3 }
                ],
                result: { type: 'fire_dark_ash', count: 2 },
                category: 'food'
            },
            water_wind_mist: {
                ingredients: [
                    { type: 'water', category: 'food', count: 3 },
                    { type: 'wind', category: 'food', count: 3 }
                ],
                result: { type: 'water_wind_mist', count: 2 },
                category: 'food'
            },
            water_earth_pond: {
                ingredients: [
                    { type: 'water', category: 'food', count: 3 },
                    { type: 'earth', category: 'food', count: 3 }
                ],
                result: { type: 'water_earth_pond', count: 2 },
                category: 'food'
            },
            water_light_ice: {
                ingredients: [
                    { type: 'water', category: 'food', count: 3 },
                    { type: 'light', category: 'food', count: 3 }
                ],
                result: { type: 'water_light_ice', count: 2 },
                category: 'food'
            },
            water_dark_deep: {
                ingredients: [
                    { type: 'water', category: 'food', count: 3 },
                    { type: 'dark', category: 'food', count: 3 }
                ],
                result: { type: 'water_dark_deep', count: 2 },
                category: 'food'
            },
            wind_earth_desert: {
                ingredients: [
                    { type: 'wind', category: 'food', count: 3 },
                    { type: 'earth', category: 'food', count: 3 }
                ],
                result: { type: 'wind_earth_desert', count: 2 },
                category: 'food'
            },
            wind_light_cloud: {
                ingredients: [
                    { type: 'wind', category: 'food', count: 3 },
                    { type: 'light', category: 'food', count: 3 }
                ],
                result: { type: 'wind_light_cloud', count: 2 },
                category: 'food'
            },
            wind_dark_night: {
                ingredients: [
                    { type: 'wind', category: 'food', count: 3 },
                    { type: 'dark', category: 'food', count: 3 }
                ],
                result: { type: 'wind_dark_night', count: 2 },
                category: 'food'
            },
            earth_light_sprout: {
                ingredients: [
                    { type: 'earth', category: 'food', count: 3 },
                    { type: 'light', category: 'food', count: 3 }
                ],
                result: { type: 'earth_light_sprout', count: 2 },
                category: 'food'
            },
            earth_dark_mushroom: {
                ingredients: [
                    { type: 'earth', category: 'food', count: 3 },
                    { type: 'dark', category: 'food', count: 3 }
                ],
                result: { type: 'earth_dark_mushroom', count: 2 },
                category: 'food'
            },
            // ë¯¸ë‹ˆì–´ì²˜ í•©ì„± (ê°™ì€ ì†ì„± common ë¯¸ë‹ˆì–´ì²˜ 2ê°œ = rare ë¯¸ë‹ˆì–´ì²˜ 1ê°œ)
            flame_lamp: {
                ingredients: [
                    { type: 'fire_common1', category: 'decoration', count: 1 },
                    { type: 'fire_common2', category: 'decoration', count: 1 }
                ],
                result: { type: 'flame_lamp', count: 1 },
                category: 'decoration'
            },
            aqua_fountain: {
                ingredients: [
                    { type: 'water_common1', category: 'decoration', count: 1 },
                    { type: 'water_common2', category: 'decoration', count: 1 }
                ],
                result: { type: 'aqua_fountain', count: 1 },
                category: 'decoration'
            },
            wind_chime: {
                ingredients: [
                    { type: 'wind_common1', category: 'decoration', count: 1 },
                    { type: 'wind_common2', category: 'decoration', count: 1 }
                ],
                result: { type: 'wind_chime', count: 1 },
                category: 'decoration'
            },
            earth_statue: {
                ingredients: [
                    { type: 'earth_common1', category: 'decoration', count: 1 },
                    { type: 'earth_common2', category: 'decoration', count: 1 }
                ],
                result: { type: 'earth_statue', count: 1 },
                category: 'decoration'
            },
            light_orb: {
                ingredients: [
                    { type: 'light_common1', category: 'decoration', count: 1 },
                    { type: 'light_common2', category: 'decoration', count: 1 }
                ],
                result: { type: 'light_orb', count: 1 },
                category: 'decoration'
            },
            shadow_crystal: {
                ingredients: [
                    { type: 'dark_common1', category: 'decoration', count: 1 },
                    { type: 'dark_common2', category: 'decoration', count: 1 }
                ],
                result: { type: 'shadow_crystal', count: 1 },
                category: 'decoration'
            },
            // íŠ¹ìˆ˜ ë¨¹ì´ - ì„±ì¥ ì–µì œ
            dark_nectar: {
                ingredients: [
                    { type: 'dark_chocolate', category: 'food', count: 1 },
                    { type: 'light_cookie', category: 'food', count: 1 }
                ],
                result: { type: 'dark_nectar', count: 2 },
                category: 'food'
            },
            // ì „ì„¤ ë¨¹ì´ - ì²œì²´ì˜ ìƒŒë“œìœ„ì¹˜
            celestial_sandwich: {
                ingredients: [
                    { type: 'moon_cheese', category: 'food', count: 1 },
                    { type: 'golden_apple', category: 'food', count: 1 }
                ],
                result: { type: 'celestial_sandwich', count: 1 },
                category: 'food'
            },
            
            // ===== ë ˆì½”ë“œ í•©ì„± ë ˆì‹œí”¼ =====
            // 2ë‹¨ê³„: ì¥ë¥´ ë ˆì½”ë“œ (ì•…ê¸° 3+3 = ì¥ë¥´ 2ê°œ)
            classic: {
                ingredients: [
                    { type: 'piano', category: 'music', count: 3 },
                    { type: 'violin', category: 'music', count: 3 }
                ],
                result: { type: 'classic', count: 2 },
                category: 'music'
            },
            jazz: {
                ingredients: [
                    { type: 'trumpet', category: 'music', count: 3 },
                    { type: 'synth', category: 'music', count: 3 }
                ],
                result: { type: 'jazz', count: 2 },
                category: 'music'
            },
            rock: {
                ingredients: [
                    { type: 'guitar', category: 'music', count: 3 },
                    { type: 'drum', category: 'music', count: 3 }
                ],
                result: { type: 'rock', count: 2 },
                category: 'music'
            },
            pop: {
                ingredients: [
                    { type: 'piano', category: 'music', count: 3 },
                    { type: 'trumpet', category: 'music', count: 3 }
                ],
                result: { type: 'pop', count: 2 },
                category: 'music'
            },
            ballad: {
                ingredients: [
                    { type: 'guitar', category: 'music', count: 3 },
                    { type: 'synth', category: 'music', count: 3 }
                ],
                result: { type: 'ballad', count: 2 },
                category: 'music'
            },
            edm: {
                ingredients: [
                    { type: 'violin', category: 'music', count: 3 },
                    { type: 'drum', category: 'music', count: 3 }
                ],
                result: { type: 'edm', count: 2 },
                category: 'music'
            },
            
            // 3ë‹¨ê³„: í”„ë¦¬ë¯¸ì—„ ì¥ë¥´ (ì¥ë¥´ 1+1 = í”„ë¦¬ë¯¸ì—„ 1ê°œ)
            symphonic_metal: {
                ingredients: [
                    { type: 'classic', category: 'music', count: 1 },
                    { type: 'rock', category: 'music', count: 1 }
                ],
                result: { type: 'symphonic_metal', count: 1 },
                category: 'music'
            },
            future_jazz: {
                ingredients: [
                    { type: 'jazz', category: 'music', count: 1 },
                    { type: 'edm', category: 'music', count: 1 }
                ],
                result: { type: 'future_jazz', count: 1 },
                category: 'music'
            },
            pop_ballad: {
                ingredients: [
                    { type: 'pop', category: 'music', count: 1 },
                    { type: 'ballad', category: 'music', count: 1 }
                ],
                result: { type: 'pop_ballad', count: 1 },
                category: 'music'
            },
            electro_rock: {
                ingredients: [
                    { type: 'rock', category: 'music', count: 1 },
                    { type: 'edm', category: 'music', count: 1 }
                ],
                result: { type: 'electro_rock', count: 1 },
                category: 'music'
            },
            crossover: {
                ingredients: [
                    { type: 'classic', category: 'music', count: 1 },
                    { type: 'jazz', category: 'music', count: 1 }
                ],
                result: { type: 'crossover', count: 1 },
                category: 'music'
            },
            jazz_ballad: {
                ingredients: [
                    { type: 'ballad', category: 'music', count: 1 },
                    { type: 'jazz', category: 'music', count: 1 }
                ],
                result: { type: 'jazz_ballad', count: 1 },
                category: 'music'
            },
            
            // 4ë‹¨ê³„: ì „ì„¤ ì¥ë¥´ (í”„ë¦¬ë¯¸ì—„ 1+1 = ì „ì„¤ 1ê°œ)
            maestro: {
                ingredients: [
                    { type: 'symphonic_metal', category: 'music', count: 1 },
                    { type: 'crossover', category: 'music', count: 1 }
                ],
                result: { type: 'maestro', count: 1 },
                category: 'music'
            },
            cyberpunk: {
                ingredients: [
                    { type: 'electro_rock', category: 'music', count: 1 },
                    { type: 'future_jazz', category: 'music', count: 1 }
                ],
                result: { type: 'cyberpunk', count: 1 },
                category: 'music'
            },
            serenade: {
                ingredients: [
                    { type: 'pop_ballad', category: 'music', count: 1 },
                    { type: 'jazz_ballad', category: 'music', count: 1 }
                ],
                result: { type: 'serenade', count: 1 },
                category: 'music'
            }
        };
        
        // ì—°êµ¬ì‹¤ ìŠ¬ë¡¯ ìƒíƒœ
        let labSlot1 = null; // { type: 'fire', category: 'food', count: 5 }
        let labSlot2 = null;
        let currentLabSlot = null; // í˜„ì¬ ì„ íƒ ì¤‘ì¸ ìŠ¬ë¡¯
        let discoveredRecipes = []; // ë°œê²¬í•œ ë ˆì‹œí”¼ ëª©ë¡
        let purchasedRecipeBooks = []; // êµ¬ë§¤í•œ ë ˆì‹œí”¼ë¶ ëª©ë¡ ('food', 'decoration')
        let selfDiscoveredRecipes = []; // ë ˆì‹œí”¼ë¶ ì—†ì´ ì§ì ‘ ë°œê²¬í•œ ë ˆì‹œí”¼ ëª©ë¡
        const ENCYCLOPEDIA_HINTS = {
            // ì „ì„¤
            'spiritking': 'ë§Œê°œí•œ ìì—°ì˜ í™”ì‹ . ì •ë ¹ê³„ì˜ ìœ ì¼ë¬´ì´í•œ ì§€ë°°ì.',
            'titania': 'ë‚˜ë¹„ë¥¼ ê±°ëŠë¦¬ëŠ” ì •ë ¹ë“¤ì˜ êµ°ì£¼.',
            'oberon': 'ë‚˜ë°©ì„ ê±°ëŠë¦¬ëŠ” ì •ë ¹ë“¤ì˜ êµ°ì£¼.',
            
            // nostat (íƒ€ì´í‹€ ì—†ìŒ) - ê¸°ë³¸ ì†ì„±
            'nostat-normal': 'ì•„ë¬´ ì†ì„±ë„ ê¹ƒë“¤ì§€ ì•Šì€ ì •ë ¹.',
            'nostat-fire': 'ë¶ˆì˜ ê¸°ìš´ì„ í’ˆì€ ì •ë ¹.',
            'nostat-water': 'ë¬¼ì˜ ê¸°ìš´ì„ í’ˆì€ ì •ë ¹.',
            'nostat-wind': 'ë°”ëŒì˜ ê¸°ìš´ì„ í’ˆì€ ì •ë ¹.',
            'nostat-earth': 'ë•…ì˜ ê¸°ìš´ì„ í’ˆì€ ì •ë ¹.',
            'nostat-light': 'ë¹›ì˜ ê¸°ìš´ì„ í’ˆì€ ì •ë ¹.',
            'nostat-dark': 'ì–´ë‘ ì˜ ê¸°ìš´ì„ í’ˆì€ ì •ë ¹.',
            'nostat-balanced': 'ëª¨ë“  ì†ì„±ì„ í’ˆì€ ì¡°í™” ì •ë ¹.',
            'nostat-multi': 'ì—¬ëŸ¬ ì†ì„±ì´ ë’¤ì„ì¸ í˜¼ëˆì˜ ì •ë ¹.',
            // nostat - 2ì†ì„± ì¡°í•©
            'nostat-fire-water': 'ë¶ˆê³¼ ë¬¼ì´ ë§Œë‚˜ í”¼ì–´ì˜¤ë¥¸ ì¦ê¸°ì˜ ì •ë ¹.',
            'nostat-fire-wind': 'ë¶ˆê³¼ ë°”ëŒì´ ë§Œë‚˜ ë§Œë“¤ì–´ì§„ ëœ¨ê±°ìš´ í­í’ì˜ ì •ë ¹.',
            'nostat-earth-fire': 'ë¶ˆê³¼ ëŒ€ì§€ê°€ ë§Œë‚˜ ë¹šì–´ë‚¸ ìš©ì•”ì˜ ì •ë ¹.',
            'nostat-fire-light': 'ë¶ˆê³¼ ë¹›ì´ ë§Œë‚˜ ì°¬ë€íˆ ë¹›ë‚˜ëŠ” íƒœì–‘ì˜ ì •ë ¹.',
            'nostat-dark-fire': 'ë¶ˆê³¼ ì–´ë‘ ì´ ë§Œë‚˜ í”¼ì–´ë‚˜ëŠ” ì—°ê¸°ì˜ ì •ë ¹.',
            'nostat-water-wind': 'ë¬¼ê³¼ ë°”ëŒì´ ë§Œë‚˜ í˜•ì„±ëœ êµ¬ë¦„ì˜ ì •ë ¹.',
            'nostat-earth-water': 'ë¬¼ê³¼ ëŒ€ì§€ê°€ ë§Œë‚˜ ë­‰ì³ì§„ ì§„í™ì˜ ì •ë ¹.',
            'nostat-light-water': 'ë¬¼ê³¼ ë¹›ì´ ë§Œë‚˜ ì´ì–´ì§„ ë¬´ì§€ê°œì˜ ì •ë ¹.',
            'nostat-dark-water': 'ë¬¼ê³¼ ì–´ë‘ ì´ ë§Œë‚˜ ëˆˆì•ì„ ê°€ë¦¬ëŠ” ì•ˆê°œì˜ ì •ë ¹.',
            'nostat-earth-wind': 'ë°”ëŒê³¼ ëŒ€ì§€ê°€ ë§Œë‚˜ í©ë‚ ë¦¬ëŠ” ëª¨ë˜ì˜ ì •ë ¹.',
            'nostat-light-wind': 'ë°”ëŒê³¼ ë¹›ì´ ë§Œë‚˜ í•˜ëŠ˜ì„ ë©”ìš°ëŠ” ì˜¤ë¡œë¼ì˜ ì •ë ¹.',
            'nostat-dark-wind': 'ë°”ëŒê³¼ ì–´ë‘ ì´ ë§Œë‚˜ ì¶¤ì¶”ëŠ” íšŒì˜¤ë¦¬ì˜ ì •ë ¹.',
            'nostat-earth-light': 'ëŒ€ì§€ì™€ ë¹›ì´ ë§Œë‚˜ ëŒì— ê°‡íŒ ë¹›, ìˆ˜ì •ì˜ ì •ë ¹.',
            'nostat-dark-earth': 'ëŒ€ì§€ì™€ ì–´ë‘ ì´ ë§Œë‚˜ ì„œëŠ˜í•œ ê·¸ë¦¼ì, ê·¸ëŠ˜ì˜ ì •ë ¹.',
            'nostat-dark-light': 'ë¹›ê³¼ ì–´ë‘ ì´ ë§Œë‚˜ í˜„í˜¹ì‹œí‚¤ëŠ” í™˜ì˜ì˜ ì •ë ¹.',
            
            // intelligent (ì§€ì‹ì˜ ì”¨ì•—) - ê¸°ë³¸ ì†ì„±
            'intelligent-normal': 'ì•„ë¬´ ì†ì„±ë„ ê¹ƒë“¤ì§€ ì•Šì€ ì •ë ¹.',
            'intelligent-fire': 'ë¶ˆì˜ ê¸°ìš´ì„ í’ˆì€ ì •ë ¹.',
            'intelligent-water': 'ë¬¼ì˜ ê¸°ìš´ì„ í’ˆì€ ì •ë ¹.',
            'intelligent-wind': 'ë°”ëŒì˜ ê¸°ìš´ì„ í’ˆì€ ì •ë ¹.',
            'intelligent-earth': 'ë•…ì˜ ê¸°ìš´ì„ í’ˆì€ ì •ë ¹.',
            'intelligent-light': 'ë¹›ì˜ ê¸°ìš´ì„ í’ˆì€ ì •ë ¹.',
            'intelligent-dark': 'ì–´ë‘ ì˜ ê¸°ìš´ì„ í’ˆì€ ì •ë ¹.',
            'intelligent-balanced': 'ëª¨ë“  ì†ì„±ì„ í’ˆì€ ì¡°í™” ì •ë ¹.',
            'intelligent-multi': 'ì—¬ëŸ¬ ì†ì„±ì´ ë’¤ì„ì¸ í˜¼ëˆì˜ ì •ë ¹.',
            // intelligent - 2ì†ì„± ì¡°í•©
            'intelligent-fire-water': 'ë¶ˆê³¼ ë¬¼ì´ ë§Œë‚˜ í”¼ì–´ì˜¤ë¥¸ ì¦ê¸°ì˜ ì •ë ¹.',
            'intelligent-fire-wind': 'ë¶ˆê³¼ ë°”ëŒì´ ë§Œë‚˜ ë§Œë“¤ì–´ì§„ ëœ¨ê±°ìš´ í­í’ì˜ ì •ë ¹.',
            'intelligent-earth-fire': 'ë¶ˆê³¼ ëŒ€ì§€ê°€ ë§Œë‚˜ ë¹šì–´ë‚¸ ìš©ì•”ì˜ ì •ë ¹.',
            'intelligent-fire-light': 'ë¶ˆê³¼ ë¹›ì´ ë§Œë‚˜ ì°¬ë€íˆ ë¹›ë‚˜ëŠ” íƒœì–‘ì˜ ì •ë ¹.',
            'intelligent-dark-fire': 'ë¶ˆê³¼ ì–´ë‘ ì´ ë§Œë‚˜ í”¼ì–´ë‚˜ëŠ” ì—°ê¸°ì˜ ì •ë ¹.',
            'intelligent-water-wind': 'ë¬¼ê³¼ ë°”ëŒì´ ë§Œë‚˜ í˜•ì„±ëœ êµ¬ë¦„ì˜ ì •ë ¹.',
            'intelligent-earth-water': 'ë¬¼ê³¼ ëŒ€ì§€ê°€ ë§Œë‚˜ ë­‰ì³ì§„ ì§„í™ì˜ ì •ë ¹.',
            'intelligent-light-water': 'ë¬¼ê³¼ ë¹›ì´ ë§Œë‚˜ ì´ì–´ì§„ ë¬´ì§€ê°œì˜ ì •ë ¹.',
            'intelligent-dark-water': 'ë¬¼ê³¼ ì–´ë‘ ì´ ë§Œë‚˜ ëˆˆì•ì„ ê°€ë¦¬ëŠ” ì•ˆê°œì˜ ì •ë ¹.',
            'intelligent-earth-wind': 'ë°”ëŒê³¼ ëŒ€ì§€ê°€ ë§Œë‚˜ í©ë‚ ë¦¬ëŠ” ëª¨ë˜ì˜ ì •ë ¹.',
            'intelligent-light-wind': 'ë°”ëŒê³¼ ë¹›ì´ ë§Œë‚˜ í•˜ëŠ˜ì„ ë©”ìš°ëŠ” ì˜¤ë¡œë¼ì˜ ì •ë ¹.',
            'intelligent-dark-wind': 'ë°”ëŒê³¼ ì–´ë‘ ì´ ë§Œë‚˜ ì¶¤ì¶”ëŠ” íšŒì˜¤ë¦¬ì˜ ì •ë ¹.',
            'intelligent-earth-light': 'ëŒ€ì§€ì™€ ë¹›ì´ ë§Œë‚˜ ëŒì— ê°‡íŒ ë¹›, ìˆ˜ì •ì˜ ì •ë ¹.',
            'intelligent-dark-earth': 'ëŒ€ì§€ì™€ ì–´ë‘ ì´ ë§Œë‚˜ ì„œëŠ˜í•œ ê·¸ë¦¼ì, ê·¸ëŠ˜ì˜ ì •ë ¹.',
            'intelligent-dark-light': 'ë¹›ê³¼ ì–´ë‘ ì´ ë§Œë‚˜ í˜„í˜¹ì‹œí‚¤ëŠ” í™˜ì˜ì˜ ì •ë ¹.',
            
            // strong (ë¶ˆêµ´ì˜ ê¸°ì‚¬) - ê¸°ë³¸ ì†ì„±
            'strong-normal': 'ì•„ë¬´ ì†ì„±ë„ ê¹ƒë“¤ì§€ ì•Šì€ ì •ë ¹.',
            'strong-fire': 'ë¶ˆì˜ ê¸°ìš´ì„ í’ˆì€ ì •ë ¹.',
            'strong-water': 'ë¬¼ì˜ ê¸°ìš´ì„ í’ˆì€ ì •ë ¹.',
            'strong-wind': 'ë°”ëŒì˜ ê¸°ìš´ì„ í’ˆì€ ì •ë ¹.',
            'strong-earth': 'ë•…ì˜ ê¸°ìš´ì„ í’ˆì€ ì •ë ¹.',
            'strong-light': 'ë¹›ì˜ ê¸°ìš´ì„ í’ˆì€ ì •ë ¹.',
            'strong-dark': 'ì–´ë‘ ì˜ ê¸°ìš´ì„ í’ˆì€ ì •ë ¹.',
            'strong-balanced': 'ëª¨ë“  ì†ì„±ì„ í’ˆì€ ì¡°í™” ì •ë ¹.',
            'strong-multi': 'ì—¬ëŸ¬ ì†ì„±ì´ ë’¤ì„ì¸ í˜¼ëˆì˜ ì •ë ¹.',
            // strong - 2ì†ì„± ì¡°í•©
            'strong-fire-water': 'ë¶ˆê³¼ ë¬¼ì´ ë§Œë‚˜ í”¼ì–´ì˜¤ë¥¸ ì¦ê¸°ì˜ ì •ë ¹.',
            'strong-fire-wind': 'ë¶ˆê³¼ ë°”ëŒì´ ë§Œë‚˜ ë§Œë“¤ì–´ì§„ ëœ¨ê±°ìš´ í­í’ì˜ ì •ë ¹.',
            'strong-earth-fire': 'ë¶ˆê³¼ ëŒ€ì§€ê°€ ë§Œë‚˜ ë¹šì–´ë‚¸ ìš©ì•”ì˜ ì •ë ¹.',
            'strong-fire-light': 'ë¶ˆê³¼ ë¹›ì´ ë§Œë‚˜ ì°¬ë€íˆ ë¹›ë‚˜ëŠ” íƒœì–‘ì˜ ì •ë ¹.',
            'strong-dark-fire': 'ë¶ˆê³¼ ì–´ë‘ ì´ ë§Œë‚˜ í”¼ì–´ë‚˜ëŠ” ì—°ê¸°ì˜ ì •ë ¹.',
            'strong-water-wind': 'ë¬¼ê³¼ ë°”ëŒì´ ë§Œë‚˜ í˜•ì„±ëœ êµ¬ë¦„ì˜ ì •ë ¹.',
            'strong-earth-water': 'ë¬¼ê³¼ ëŒ€ì§€ê°€ ë§Œë‚˜ ë­‰ì³ì§„ ì§„í™ì˜ ì •ë ¹.',
            'strong-light-water': 'ë¬¼ê³¼ ë¹›ì´ ë§Œë‚˜ ì´ì–´ì§„ ë¬´ì§€ê°œì˜ ì •ë ¹.',
            'strong-dark-water': 'ë¬¼ê³¼ ì–´ë‘ ì´ ë§Œë‚˜ ëˆˆì•ì„ ê°€ë¦¬ëŠ” ì•ˆê°œì˜ ì •ë ¹.',
            'strong-earth-wind': 'ë°”ëŒê³¼ ëŒ€ì§€ê°€ ë§Œë‚˜ í©ë‚ ë¦¬ëŠ” ëª¨ë˜ì˜ ì •ë ¹.',
            'strong-light-wind': 'ë°”ëŒê³¼ ë¹›ì´ ë§Œë‚˜ í•˜ëŠ˜ì„ ë©”ìš°ëŠ” ì˜¤ë¡œë¼ì˜ ì •ë ¹.',
            'strong-dark-wind': 'ë°”ëŒê³¼ ì–´ë‘ ì´ ë§Œë‚˜ ì¶¤ì¶”ëŠ” íšŒì˜¤ë¦¬ì˜ ì •ë ¹.',
            'strong-earth-light': 'ëŒ€ì§€ì™€ ë¹›ì´ ë§Œë‚˜ ëŒì— ê°‡íŒ ë¹›, ìˆ˜ì •ì˜ ì •ë ¹.',
            'strong-dark-earth': 'ëŒ€ì§€ì™€ ì–´ë‘ ì´ ë§Œë‚˜ ì„œëŠ˜í•œ ê·¸ë¦¼ì, ê·¸ëŠ˜ì˜ ì •ë ¹.',
            'strong-dark-light': 'ë¹›ê³¼ ì–´ë‘ ì´ ë§Œë‚˜ í˜„í˜¹ì‹œí‚¤ëŠ” í™˜ì˜ì˜ ì •ë ¹.',
            
            // beautiful (ë‹¬ì½¤í•œ í–¥ê¸°) - ê¸°ë³¸ ì†ì„±
            'beautiful-normal': 'ì•„ë¬´ ì†ì„±ë„ ê¹ƒë“¤ì§€ ì•Šì€ ì •ë ¹.',
            'beautiful-fire': 'ë¶ˆì˜ ê¸°ìš´ì„ í’ˆì€ ì •ë ¹.',
            'beautiful-water': 'ë¬¼ì˜ ê¸°ìš´ì„ í’ˆì€ ì •ë ¹.',
            'beautiful-wind': 'ë°”ëŒì˜ ê¸°ìš´ì„ í’ˆì€ ì •ë ¹.',
            'beautiful-earth': 'ë•…ì˜ ê¸°ìš´ì„ í’ˆì€ ì •ë ¹.',
            'beautiful-light': 'ë¹›ì˜ ê¸°ìš´ì„ í’ˆì€ ì •ë ¹.',
            'beautiful-dark': 'ì–´ë‘ ì˜ ê¸°ìš´ì„ í’ˆì€ ì •ë ¹.',
            'beautiful-balanced': 'ëª¨ë“  ì†ì„±ì„ í’ˆì€ ì¡°í™” ì •ë ¹.',
            'beautiful-multi': 'ì—¬ëŸ¬ ì†ì„±ì´ ë’¤ì„ì¸ í˜¼ëˆì˜ ì •ë ¹.',
            // beautiful - 2ì†ì„± ì¡°í•©
            'beautiful-fire-water': 'ë¶ˆê³¼ ë¬¼ì´ ë§Œë‚˜ í”¼ì–´ì˜¤ë¥¸ ì¦ê¸°ì˜ ì •ë ¹.',
            'beautiful-fire-wind': 'ë¶ˆê³¼ ë°”ëŒì´ ë§Œë‚˜ ë§Œë“¤ì–´ì§„ ëœ¨ê±°ìš´ í­í’ì˜ ì •ë ¹.',
            'beautiful-earth-fire': 'ë¶ˆê³¼ ëŒ€ì§€ê°€ ë§Œë‚˜ ë¹šì–´ë‚¸ ìš©ì•”ì˜ ì •ë ¹.',
            'beautiful-fire-light': 'ë¶ˆê³¼ ë¹›ì´ ë§Œë‚˜ ì°¬ë€íˆ ë¹›ë‚˜ëŠ” íƒœì–‘ì˜ ì •ë ¹.',
            'beautiful-dark-fire': 'ë¶ˆê³¼ ì–´ë‘ ì´ ë§Œë‚˜ í”¼ì–´ë‚˜ëŠ” ì—°ê¸°ì˜ ì •ë ¹.',
            'beautiful-water-wind': 'ë¬¼ê³¼ ë°”ëŒì´ ë§Œë‚˜ í˜•ì„±ëœ êµ¬ë¦„ì˜ ì •ë ¹.',
            'beautiful-earth-water': 'ë¬¼ê³¼ ëŒ€ì§€ê°€ ë§Œë‚˜ ë­‰ì³ì§„ ì§„í™ì˜ ì •ë ¹.',
            'beautiful-light-water': 'ë¬¼ê³¼ ë¹›ì´ ë§Œë‚˜ ì´ì–´ì§„ ë¬´ì§€ê°œì˜ ì •ë ¹.',
            'beautiful-dark-water': 'ë¬¼ê³¼ ì–´ë‘ ì´ ë§Œë‚˜ ëˆˆì•ì„ ê°€ë¦¬ëŠ” ì•ˆê°œì˜ ì •ë ¹.',
            'beautiful-earth-wind': 'ë°”ëŒê³¼ ëŒ€ì§€ê°€ ë§Œë‚˜ í©ë‚ ë¦¬ëŠ” ëª¨ë˜ì˜ ì •ë ¹.',
            'beautiful-light-wind': 'ë°”ëŒê³¼ ë¹›ì´ ë§Œë‚˜ í•˜ëŠ˜ì„ ë©”ìš°ëŠ” ì˜¤ë¡œë¼ì˜ ì •ë ¹.',
            'beautiful-dark-wind': 'ë°”ëŒê³¼ ì–´ë‘ ì´ ë§Œë‚˜ ì¶¤ì¶”ëŠ” íšŒì˜¤ë¦¬ì˜ ì •ë ¹.',
            'beautiful-earth-light': 'ëŒ€ì§€ì™€ ë¹›ì´ ë§Œë‚˜ ëŒì— ê°‡íŒ ë¹›, ìˆ˜ì •ì˜ ì •ë ¹.',
            'beautiful-dark-earth': 'ëŒ€ì§€ì™€ ì–´ë‘ ì´ ë§Œë‚˜ ì„œëŠ˜í•œ ê·¸ë¦¼ì, ê·¸ëŠ˜ì˜ ì •ë ¹.',
            'beautiful-dark-light': 'ë¹›ê³¼ ì–´ë‘ ì´ ë§Œë‚˜ í˜„í˜¹ì‹œí‚¤ëŠ” í™˜ì˜ì˜ ì •ë ¹.',
            
            // sage (ì •ë ¹ì™•ì˜ ë¶€ë¦„ì„ ë°›ì€) - ê¸°ë³¸ ì†ì„±
            'sage-normal': 'ì •ë ¹ì™•ì˜ ë¶€ë¦„ì„ ë°›ì€ ë°±ì˜ ì •ë ¹.',
            'sage-fire': 'ì •ë ¹ì™•ì˜ ë¶€ë¦„ì„ ë°›ì€ ë¶ˆê½ƒì˜ ì •ë ¹.',
            'sage-water': 'ì •ë ¹ì™•ì˜ ë¶€ë¦„ì„ ë°›ì€ ë¬¼ê²°ì˜ ì •ë ¹.',
            'sage-wind': 'ì •ë ¹ì™•ì˜ ë¶€ë¦„ì„ ë°›ì€ ì§ˆí’ì˜ ì •ë ¹.',
            'sage-earth': 'ì •ë ¹ì™•ì˜ ë¶€ë¦„ì„ ë°›ì€ ëŒ€ì§€ì˜ ì •ë ¹.',
            'sage-light': 'ì •ë ¹ì™•ì˜ ë¶€ë¦„ì„ ë°›ì€ ê´‘ëª…ì˜ ì •ë ¹.',
            'sage-dark': 'ì •ë ¹ì™•ì˜ ë¶€ë¦„ì„ ë°›ì€ ì•”í‘ì˜ ì •ë ¹.',
            'sage-balanced': 'ì •ë ¹ì™•ì˜ ë¶€ë¦„ì„ ë°›ì€ ì¡°í™”ì˜ ì •ë ¹.',
            'sage-multi': 'ì •ë ¹ì™•ì˜ ë¶€ë¦„ì„ ë°›ì€ í˜¼ëˆì˜ ì •ë ¹.',
            // sage - 2ì†ì„± ì¡°í•©
            'sage-fire-water': 'ì •ë ¹ì™•ì˜ ë¶€ë¦„ì„ ë°›ì€ ì¦ê¸°ì˜ ì •ë ¹.',
            'sage-fire-wind': 'ì •ë ¹ì™•ì˜ ë¶€ë¦„ì„ ë°›ì€ í­í’ì˜ ì •ë ¹.',
            'sage-earth-fire': 'ì •ë ¹ì™•ì˜ ë¶€ë¦„ì„ ë°›ì€ ìš©ì•”ì˜ ì •ë ¹.',
            'sage-fire-light': 'ì •ë ¹ì™•ì˜ ë¶€ë¦„ì„ ë°›ì€ íƒœì–‘ì˜ ì •ë ¹.',
            'sage-dark-fire': 'ì •ë ¹ì™•ì˜ ë¶€ë¦„ì„ ë°›ì€ ì—°ê¸°ì˜ ì •ë ¹.',
            'sage-water-wind': 'ì •ë ¹ì™•ì˜ ë¶€ë¦„ì„ ë°›ì€ êµ¬ë¦„ì˜ ì •ë ¹.',
            'sage-earth-water': 'ì •ë ¹ì™•ì˜ ë¶€ë¦„ì„ ë°›ì€ ì§„í™ì˜ ì •ë ¹.',
            'sage-light-water': 'ì •ë ¹ì™•ì˜ ë¶€ë¦„ì„ ë°›ì€ ë¬´ì§€ê°œì˜ ì •ë ¹.',
            'sage-dark-water': 'ì •ë ¹ì™•ì˜ ë¶€ë¦„ì„ ë°›ì€ ì•ˆê°œì˜ ì •ë ¹.',
            'sage-earth-wind': 'ì •ë ¹ì™•ì˜ ë¶€ë¦„ì„ ë°›ì€ ëª¨ë˜ì˜ ì •ë ¹.',
            'sage-light-wind': 'ì •ë ¹ì™•ì˜ ë¶€ë¦„ì„ ë°›ì€ ì˜¤ë¡œë¼ì˜ ì •ë ¹.',
            'sage-dark-wind': 'ì •ë ¹ì™•ì˜ ë¶€ë¦„ì„ ë°›ì€ íšŒì˜¤ë¦¬ì˜ ì •ë ¹.',
            'sage-earth-light': 'ì •ë ¹ì™•ì˜ ë¶€ë¦„ì„ ë°›ì€ ìˆ˜ì •ì˜ ì •ë ¹.',
            'sage-dark-earth': 'ì •ë ¹ì™•ì˜ ë¶€ë¦„ì„ ë°›ì€ ê·¸ëŠ˜ì˜ ì •ë ¹.',
            'sage-dark-light': 'ì •ë ¹ì™•ì˜ ë¶€ë¦„ì„ ë°›ì€ í™˜ì˜ì˜ ì •ë ¹.'
        };

        // ìƒíƒœ í‚¤ì›Œë“œ ì‹œìŠ¤í…œ
        function getStatusKeywords(spirit) {
            const keywords = [];
            const keywordColor = '#2a2a2a';  // ê²€ì •ìƒ‰ í†µì¼
            
            // ğŸ§¬ ìœ ì „ë°›ì€ í‚¤ì›Œë“œ (ë¶€ëª¨ì—ê²Œì„œ ë¬¼ë ¤ë°›ì€ íŠ¹ì„±)
            if (spirit.inheritedKeywords && spirit.inheritedKeywords.length > 0) {
                spirit.inheritedKeywords.forEach(keyword => {
                    keywords.push({ text: `ğŸ§¬ ${keyword}`, color: '#9c27b0', desc: `ë¶€ëª¨ì—ê²Œì„œ ìœ ì „ë°›ì€ íŠ¹ì„±ì…ë‹ˆë‹¤.` });
                });
            }
            
            // ì• ì •ë„ ê¸°ë°˜
            if (spirit.parameters.affection >= 100) {
                keywords.push({ text: 'ì‚¬ë‘ì´ ê°€ë“í•œ', color: keywordColor, desc: 'ì• ì •ë„ê°€ ìµœëŒ€ì¹˜ì— ë„ë‹¬í–ˆìŠµë‹ˆë‹¤.' });
            } else if (spirit.parameters.affection >= 70) {
                keywords.push({ text: 'ì• ì • ì–´ë¦°', color: keywordColor, desc: 'ì• ì •ë„ê°€ ë†’ìŠµë‹ˆë‹¤. ì •ë ¹ì´ ë‹¹ì‹ ì„ ì¢‹ì•„í•©ë‹ˆë‹¤.' });
            } else if (spirit.parameters.affection <= 10) {
                keywords.push({ text: 'ê²½ê³„í•˜ëŠ”', color: keywordColor, desc: 'ì• ì •ë„ê°€ ë„ˆë¬´ ë‚®ìŠµë‹ˆë‹¤. ë¨¹ì´ë¥¼ ì£¼ê±°ë‚˜ ìŒì•…ì„ ë“¤ë ¤ì£¼ì„¸ìš”.' });
            }
            
            // ì§ˆë³‘ ìƒíƒœ
            if (spirit.isSick) {
                keywords.push({ text: 'ì§ˆë³‘ì— ê±¸ë¦°', color: keywordColor, desc: 'ì •ë ¹ì´ ì•„í”•ë‹ˆë‹¤! ë§Œë³‘í†µì¹˜ ì•½ì´ˆë¡œ ì¹˜ë£Œí•´ì£¼ì„¸ìš”.' });
            }
            
            // í™”í•´ì˜ ê½ƒ íš¨ê³¼ (30ë¶„ê°„ ì§€ì†)
            if (spirit.reconciliationUntil && spirit.reconciliationUntil > Date.now()) {
                const remaining = Math.ceil((spirit.reconciliationUntil - Date.now()) / 60000);
                keywords.push({ text: 'ğŸŒ¼ í™”í•´ ì¤‘', color: '#f9a825', desc: `${remaining}ë¶„ê°„ ë‹¤ë¥¸ ì •ë ¹ê³¼ ì‹¸ìš°ì§€ ì•ŠìŠµë‹ˆë‹¤.` });
            }
            
            // ì•„ì¹´ì‹œì•„ ê¿€ íš¨ê³¼ (30ë¶„ê°„ ì§€ì†)
            if (spirit.acaciaHoneyUntil && spirit.acaciaHoneyUntil > Date.now()) {
                const remaining = Math.ceil((spirit.acaciaHoneyUntil - Date.now()) / 60000);
                keywords.push({ text: 'ğŸ¯ ì¹œë°€ íš¨ê³¼', color: '#ff9800', desc: `${remaining}ë¶„ê°„ ë‹¤ë¥¸ ì •ë ¹ê³¼ì˜ í˜¸ê°ë„ê°€ 2ë°°ë¡œ ì¦ê°€í•©ë‹ˆë‹¤.` });
            }
            
            // ìŒì•… ì²­ì·¨ íšŸìˆ˜ (musicListened ì¹´ìš´íŠ¸)
            if (spirit.musicListened >= 10) {
                keywords.push({ text: 'ìŒì•…ì„ ì‚¬ë‘í•˜ëŠ”', color: keywordColor, desc: `ìŒì•…ì„ ${spirit.musicListened}ë²ˆ ë“¤ì—ˆìŠµë‹ˆë‹¤.` });
            }
            
            // ìŠ¤íƒ¯ 50 ê¸°ì¤€ í‚¤ì›Œë“œ (ìœ ì „ë°›ì€ í‚¤ì›Œë“œëŠ” ì¤‘ë³µ í‘œì‹œ ì•ˆ í•¨)
            const inherited = spirit.inheritedKeywords || [];
            if (spirit.parameters.intelligence >= 50 && !inherited.includes('ë˜‘ë˜‘í•œ')) {
                keywords.push({ text: 'ë˜‘ë˜‘í•œ', color: keywordColor, desc: `ì§€ë ¥ì´ 50 ì´ìƒì…ë‹ˆë‹¤. (${spirit.parameters.intelligence}) ìŒì•… ì²­ì·¨ ì‹œ ìŠ¤íƒ¯ ë³´ë„ˆìŠ¤ +2!` });
            }
            if (spirit.parameters.strength >= 50 && !inherited.includes('ê°•í•œ')) {
                keywords.push({ text: 'ê°•í•œ', color: keywordColor, desc: `ì²´ë ¥ì´ 50 ì´ìƒì…ë‹ˆë‹¤. (${spirit.parameters.strength}) ì§ˆë³‘ì— ê±¸ë¦¬ì§€ ì•ŠìŠµë‹ˆë‹¤!` });
            }
            if (spirit.parameters.charm >= 50 && !inherited.includes('ë§¤ë ¥ì ì¸')) {
                keywords.push({ text: 'ë§¤ë ¥ì ì¸', color: keywordColor, desc: `ë§¤ë ¥ì´ 50 ì´ìƒì…ë‹ˆë‹¤. (${spirit.parameters.charm}) ë‹¤ë¥¸ ì •ë ¹ê³¼ ìƒí˜¸ì‘ìš© í™•ë¥ ì´ ë†’ì•„ì§‘ë‹ˆë‹¤!` });
            }
            
            // ìŠ¤íƒ¯ ê¸°ë°˜ ê²½ê³ 
            if (spirit.parameters.intelligence <= 10) {
                keywords.push({ text: 'ì‚¬êµì„±ì´ ì ì€', color: keywordColor, desc: `ì§€ë ¥ì´ ë„ˆë¬´ ë‚®ìŠµë‹ˆë‹¤. (${spirit.parameters.intelligence}) ë‹¤ë¥¸ ì •ë ¹ê³¼ ì‹¸ìš¸ ìˆ˜ ìˆìŠµë‹ˆë‹¤.` });
            }
            if (spirit.parameters.strength <= 5) {
                keywords.push({ text: 'ëª¸ì´ ì•½í•œ', color: keywordColor, desc: `ì²´ë ¥ì´ ë„ˆë¬´ ë‚®ìŠµë‹ˆë‹¤. (${spirit.parameters.strength}) ì§ˆë³‘ì— ê±¸ë¦¬ê¸° ì‰½ìŠµë‹ˆë‹¤.` });
            }
            
            // ì„±ì¥ ë‹¨ê³„ ê¸°ë°˜
            const stage = getStage(spirit.growth);
            if (stage === 'adult' && !spirit.isCompleted) {
                keywords.push({ text: 'ë²ˆë°ê¸°ê°€ ëœ', color: keywordColor, desc: 'ë²ˆë°ê¸° ë‹¨ê³„ì…ë‹ˆë‹¤. ì¡°ê¸ˆë§Œ ë” ì„±ì¥í•˜ë©´ ì•¨ë²”ì— ë“±ë¡ë©ë‹ˆë‹¤.' });
            }
            
            // ë§Œì¡±ë„ ê¸°ë°˜
            if (spirit.satisfaction === 'high') {
                keywords.push({ text: 'í–‰ë³µí•œ', color: keywordColor, desc: 'ì •ë ¹ì˜ ë§Œì¡±ë„ê°€ ë†’ìŠµë‹ˆë‹¤. ì˜ ëŒë´ì£¼ê³  ê³„ì‹œë„¤ìš”!' });
            } else if (spirit.satisfaction === 'low') {
                keywords.push({ text: 'ë¶ˆë§Œì¡±ìŠ¤ëŸ¬ìš´', color: keywordColor, desc: 'ì •ë ¹ì˜ ë§Œì¡±ë„ê°€ ë‚®ìŠµë‹ˆë‹¤. ë¨¹ì´ë‚˜ ìŒì•…ìœ¼ë¡œ ê´€ì‹¬ì„ ë³´ì—¬ì£¼ì„¸ìš”.' });
            }
            
            // ë°©ì¹˜ ì‹œê°„ ê¸°ë°˜ (30ë¶„ ì´ìƒ)
            const timeSinceInteraction = Date.now() - (spirit.lastInteraction || Date.now());
            if (timeSinceInteraction > 30 * 60 * 1000) {
                const mins = Math.floor(timeSinceInteraction / 60000);
                keywords.push({ text: 'ì™¸ë¡œìš´', color: keywordColor, desc: `${mins}ë¶„ ë™ì•ˆ ìƒí˜¸ì‘ìš©ì´ ì—†ì—ˆìŠµë‹ˆë‹¤.` });
            }
            
            // í…Œë¼ë¦¬ì›€ í™˜ê²½ê³¼ ì†ì„± ì¼ì¹˜ë„
            const dominantAttr = getDominantAttribute(spirit);
            const terrariumEnv = Object.keys(terrarium).reduce((a, b) => 
                terrarium[a] > terrarium[b] ? a : b
            );
            if (dominantAttr === terrariumEnv && terrarium[terrariumEnv] >= 30) {
                keywords.push({ text: 'í™˜ê²½ì— ì ì‘í•œ', color: keywordColor, desc: `í…Œë¼ë¦¬ì›€ í™˜ê²½(${ENV_NAMES[terrariumEnv]})ì´ ì •ë ¹ì˜ ì£¼ ì†ì„±ê³¼ ë§ìŠµë‹ˆë‹¤.` });
            }
            
            // ë¹›/ì–´ë‘  ì‹œê°„ ê¸°ë°˜ (ë” ë§ì€ ìª½ë§Œ í‘œì‹œ)
            const lightTime = spirit.lightTime || 0;
            const darkTime = spirit.darkTime || 0;
            if (lightTime >= 10 || darkTime >= 10) {
                if (lightTime > darkTime) {
                    keywords.push({ text: 'íƒœì–‘ì„ ë™ê²½í•˜ëŠ”', color: keywordColor, desc: 'ë°ì€ ì¡°ëª… í™˜ê²½ì—ì„œ ë” ì˜¤ë˜ ìëìŠµë‹ˆë‹¤.' });
                } else if (darkTime > lightTime) {
                    keywords.push({ text: 'ë‹¬ì„ ìˆ­ë°°í•˜ëŠ”', color: keywordColor, desc: 'ì–´ë‘ìš´ ì¡°ëª… í™˜ê²½ì—ì„œ ë” ì˜¤ë˜ ìëìŠµë‹ˆë‹¤.' });
                }
                // ê°™ìœ¼ë©´ ì•„ë¬´ê²ƒë„ í‘œì‹œ ì•ˆ í•¨
            }
            
            // ë¨¹ì´ íšŸìˆ˜ (feedCount ì¹´ìš´íŠ¸)
            if (spirit.feedCount >= 20) {
                keywords.push({ text: 'ë¯¸ì‹ê°€', color: keywordColor, desc: `ë¨¹ì´ë¥¼ ${spirit.feedCount}ë²ˆ ë¨¹ì—ˆìŠµë‹ˆë‹¤.` });
            }
            
            // ì§ê¿ ê´€ê³„
            const bestFriend = getBestFriend(spirit);
            if (bestFriend) {
                keywords.push({ text: `ì§ê¿ : ${bestFriend.name}`, color: '#e91e63', desc: `${bestFriend.name}ì™€(ê³¼) ì§ê¿ ê´€ê³„ì…ë‹ˆë‹¤.` });
            }
            
            // ì—°ëª¨ ê´€ê³„
            const lover = getLover(spirit);
            if (lover) {
                keywords.push({ text: `ì—°ëª¨ : ${lover.name}`, color: '#e91e63', desc: `${lover.name}ì—ê²Œ ì—°ëª¨ì˜ ê°ì •ì„ ëŠë¼ê³  ìˆìŠµë‹ˆë‹¤. ë‘˜ ë‹¤ ì„±ì¥ì„ ë§ˆì¹˜ë©´ ì—°ê²° ì•Œì´ ìƒê¸¸ ìˆ˜ ìˆìŠµë‹ˆë‹¤.` });
            }
            
            // ì•™ìˆ™ ê´€ê³„ (í˜¸ê°ë„ 0 ë¯¸ë§Œ)
            if (spirit.relationships) {
                const activeSpirits = spirits.filter(s => !s.isDead && !s.isCompleted && s.id !== spirit.id);
                activeSpirits.forEach(other => {
                    const rel = spirit.relationships[other.id] || 0;
                    if (rel < 0) {
                        keywords.push({ text: `ì•™ìˆ™ : ${other.name}`, color: '#e74c3c', desc: `${other.name}ì™€(ê³¼) ì‚¬ì´ê°€ ì¢‹ì§€ ì•ŠìŠµë‹ˆë‹¤. (í˜¸ê°ë„: ${rel}) ìˆ˜ì„ í™” ê½ƒììœ¼ë¡œ í™”í•´ì‹œí‚¬ ìˆ˜ ìˆìŠµë‹ˆë‹¤.` });
                    }
                });
            }
            
            return keywords;
        }

                // ìƒì  ê°€ê²©í‘œ
        const SHOP_PRICES = {
            // íŒë§¤ ê°€ê²© (ì¸ë²¤í† ë¦¬ â†’ ì½”ì¸)
            sell: {
                food_common: 8,    // ì¼ë°˜ ë¨¹ì´ íŒë§¤
                food_rare: 15,     // í¬ê·€ ë¨¹ì´ íŒë§¤
                decoration: 15,    // ë¯¸ë‹ˆì–´ì²˜ 1ê°œ = 15ì½”ì¸
                music: 25          // ìŒì•… 1ê°œ = 25ì½”ì¸
            },
            // êµ¬ë§¤ ê°€ê²© (ì½”ì¸ â†’ ì¸ë²¤í† ë¦¬)
            buy: {
                food_common: 20,   // ì¼ë°˜ ë¨¹ì´ (í™”ìˆ˜í’ì§€)
                food_rare: 40,     // í¬ê·€ ë¨¹ì´ (ë¹›ì•”)
                music: 80,         // ìŒì•… ë ˆì½”ë“œ
                decoration: 50     // ë¯¸ë‹ˆì–´ì²˜
            }
        };

        const EVOLUTION_TYPES = {
            // ë…¸ë©€ (ìŠ¤íƒ¯ 100 ë¯¸ë‹¬)
            'nostat': { prefix: '', icon: '' },
            
            // ì§€ë ¥ 100
            'intelligent': { prefix: 'ì§€ì‹ì˜ ì”¨ì•—', icon: 'ğŸ“š' },
            
            // ì²´ë ¥ 100
            'strong': { prefix: 'ë¶ˆêµ´ì˜ ê¸°ì‚¬', icon: 'âš”ï¸' },
            
            // ë§¤ë ¥ 100
            'beautiful': { prefix: 'ë‹¬ì½¤í•œ í–¥ê¸°', icon: 'ğŸŒ¸' },
            
            // ëª¨ë“  ìŠ¤íƒ¯ 100
            'sage': { prefix: 'ì •ë ¹ì™•ì˜ ë¶€ë¦„ì„ ë°›ì€', icon: 'ğŸ‘‘' }
        };
        
        // ì†ì„±ë³„ ì •ë ¹ ì´ë¦„
        const ATTRIBUTE_NAMES = {
            normal: { name: 'ë°±ì˜ ì •ë ¹', icon: 'âšª', desc: 'ìˆœìˆ˜í•œ ë°±ìƒ‰ì˜ ë¹›ì„ ì§€ë‹Œ ì •ë ¹.' },
            fire: { 
                name: 'í™”ì—¼ì˜ ì •ë ¹', 
                icon: { 
                    butterfly: '<img src="https://raw.githubusercontent.com/mongyeonlab-cpu/mylittleterrarium/main/images/%EC%A0%95%EB%A0%B9_%EB%B6%88_%EA%B8%B0%EB%B3%B8_%EB%82%98%EB%B9%84.png" style="width:270px;height:370px;vertical-align:middle;">', 
                    moth: '<img src="https://raw.githubusercontent.com/mongyeonlab-cpu/mylittleterrarium/main/images/%EC%A0%95%EB%A0%B9_%EB%B6%88_%EA%B8%B0%EB%B3%B8_%EB%82%98%EB%B0%A9.png" style="width:270px;height:370px;vertical-align:middle;">' 
                }, 
                desc: 'íƒ€ì˜¤ë¥´ëŠ” ì—´ì •ì„ ê°„ì§í•œ í™”ì—¼ì˜ ì •ë ¹.' 
            },
            water: { 
                name: 'ë¹™í•˜ì˜ ì •ë ¹', 
                icon: { 
                    butterfly: '<img src="https://raw.githubusercontent.com/mongyeonlab-cpu/mylittleterrarium/main/images/%EC%A0%95%EB%A0%B9_%EB%AC%BC_%EA%B8%B0%EB%B3%B8_%EB%82%98%EB%B9%84.png" style="width:270px;height:370px;vertical-align:middle;">', 
                    moth: '<img src="https://raw.githubusercontent.com/mongyeonlab-cpu/mylittleterrarium/main/images/%EC%A0%95%EB%A0%B9_%EB%AC%BC_%EA%B8%B0%EB%B3%B8_%EB%82%98%EB%B0%A9.png" style="width:270px;height:370px;vertical-align:middle;">' 
                }, 
                desc: 'ì°¨ê°€ìš´ ì§€í˜œë¥¼ í’ˆì€ ë¬¼ì˜ ì •ë ¹.' 
            },
            wind: { name: 'ì§ˆí’ì˜ ì •ë ¹', icon: 'ğŸŒ¬ï¸', desc: 'ììœ ë¡œìš´ ë°”ëŒì„ ë‹´ì€ ì§ˆí’ì˜ ì •ë ¹.' },
            earth: { name: 'ëŒ€ì§€ì˜ ì •ë ¹', icon: 'ğŸŒ±', desc: 'ê²¬ê³ í•œ ëŒ€ì§€ì˜ í˜ì„ ì§€ë‹Œ ì •ë ¹.' },
            light: { name: 'ê´‘ëª…ì˜ ì •ë ¹', icon: 'âœ¨', desc: 'ì°¬ë€í•œ ë¹›ìœ¼ë¡œ ê°€ë“í•œ ê´‘ëª…ì˜ ì •ë ¹.' },
            dark: { name: 'ì•”í‘ì˜ ì •ë ¹', icon: 'ğŸŒ™', desc: 'ì‹ ë¹„ë¡œìš´ ì–´ë‘ ì„ ë‹´ì€ ì•”í‘ì˜ ì •ë ¹.' },
            
            // 2ì†ì„± ì¡°í•© (ì•ŒíŒŒë²³ ìˆœ ì •ë ¬)
            'fire-water': { name: 'ë°”í¬ë¥´', icon: 'ğŸ’¨', desc: 'ë¶ˆê³¼ ë¬¼ì´ ë§Œë‚˜ íƒ„ìƒí•œ ì¦ê¸°ì˜ ì •ë ¹.' },
            'fire-wind': { name: 'í…œí˜ìŠ¤íˆ¬ìŠ¤', icon: 'ğŸŒªï¸', desc: 'ë¶ˆê³¼ ë°”ëŒì´ ë§Œë“  ëœ¨ê±°ìš´ í­í’ì˜ ì •ë ¹.' },
            'earth-fire': { name: 'ë¼ë°”', icon: 'ğŸŒ‹', desc: 'ë¶ˆê³¼ ëŒ€ì§€ê°€ ë¹šì–´ë‚¸ ìš©ì•”ì˜ ì •ë ¹.' },
            'fire-light': { name: 'ì†”', icon: 'â˜€ï¸', desc: 'ë¶ˆê³¼ ë¹›ì´ í•©ì³ì§„ íƒœì–‘ì˜ ì •ë ¹.' },
            'dark-fire': { name: 'í‘¸ë¬´ìŠ¤', icon: 'ğŸ’¨', desc: 'ë¶ˆê³¼ ì–´ë‘ ì´ ë§Œë“  ì—°ê¸°ì˜ ì •ë ¹.' },
            'water-wind': { name: 'ëˆ„ë² ', icon: 'â˜ï¸', desc: 'ë¬¼ê³¼ ë°”ëŒì´ ë§Œë“  êµ¬ë¦„ì˜ ì •ë ¹.' },
            'earth-water': { name: 'ê¸€ë¦¬ìŠ¤', icon: 'ğŸª¨', desc: 'ë¬¼ê³¼ ëŒ€ì§€ê°€ ì„ì¸ ì§„í™ì˜ ì •ë ¹.' },
            'light-water': { name: 'ì´ë¦¬ìŠ¤', icon: 'ğŸŒˆ', desc: 'ë¬¼ê³¼ ë¹›ì´ ë§Œë“  ë¬´ì§€ê°œì˜ ì •ë ¹.' },
            'dark-water': { name: 'ì¹¼ë¦¬ê³ ', icon: 'ğŸŒ«ï¸', desc: 'ë¬¼ê³¼ ì–´ë‘ ì´ ë§Œë“  ì•ˆê°œì˜ ì •ë ¹.' },
            'earth-wind': { name: 'í•˜ë ˆë‚˜', icon: 'ğŸœï¸', desc: 'ë°”ëŒê³¼ ëŒ€ì§€ê°€ ë§Œë“  ëª¨ë˜ì˜ ì •ë ¹.' },
            'light-wind': { name: 'ì˜¤ë¡œë¼', icon: 'ğŸŒŒ', desc: 'ë°”ëŒê³¼ ë¹›ì´ ë§Œë“  ì˜¤ë¡œë¼ì˜ ì •ë ¹.' },
            'dark-wind': { name: 'íˆ¬ë¥´ë³´', icon: 'ğŸŒ€', desc: 'ë°”ëŒê³¼ ì–´ë‘ ì´ ë§Œë“  íšŒì˜¤ë¦¬ì˜ ì •ë ¹.' },
            'earth-light': { name: 'í¬ë¦¬ìŠ¤íƒˆ', icon: 'ğŸ’', desc: 'ëŒ€ì§€ì™€ ë¹›ì´ ë§Œë“  ìˆ˜ì •ì˜ ì •ë ¹.' },
            'dark-earth': { name: 'ì•ˆíŠ¸ë£¸', icon: 'â›°ï¸', desc: 'ëŒ€ì§€ì™€ ì–´ë‘ ì´ ë§Œë“  ë™êµ´ì˜ ì •ë ¹.' },
            'dark-light': { name: 'íŒíƒ€ì¦ˆë§ˆ', icon: 'âœ¨ğŸŒ™', desc: 'ë¹›ê³¼ ì–´ë‘ ì´ ë§Œë“¤ì–´ë‚¸ í™˜ì˜ì˜ ì •ë ¹.' },
            
            // 3ì†ì„± ì´ìƒ (ë³µí•©)
            balanced: { name: 'ì¡°í™”ì˜ ì •ë ¹', icon: 'âš–ï¸', desc: 'ëª¨ë“  ì†ì„±ì´ ê³ ë¥´ê²Œ ê· í˜• ì¡íŒ ì •ë ¹.' },
            multi: { name: 'í˜¼ëˆì˜ ì •ë ¹', icon: 'ğŸŒªï¸', desc: 'ì†ì„±ì˜ í¸ì°¨ê°€ í° í˜¼ëˆì˜ ì •ë ¹.' }
        };
        
        // í•©ì„± ì „ìš© ì •ë ¹
        const FUSION_TYPES = {
            // ê°™ì€ ì†ì„± ìƒìœ„ ë²„ì „
            'fusion-fire': { name: 'ì´í”„ë¦¬íŠ¸', icon: 'ğŸ”¥ğŸ’¥', desc: 'ë‘ ë¶ˆê½ƒì´ ë§Œë‚˜ íƒœì–´ë‚œ íƒ€ì˜¤ë¥´ëŠ” í™”ì—¼ì˜ ì •ë ¹.', recipe: ['fire', 'fire'], rarity: 'rare' },
            'fusion-water': { name: 'ì—˜ë¼ì„', icon: 'ğŸ’§ğŸŒŠ', desc: 'ë‘ ë¬¼ê²°ì´ ë§Œë‚˜ íƒœì–´ë‚œ ê¹Šì´ ê°€ë¼ì•‰ëŠ” í˜¸ìˆ˜ì˜ ì •ë ¹.', recipe: ['water', 'water'], rarity: 'rare' },
            'fusion-wind': { name: 'ë¯¸ë„¤ë¥´ë°”', icon: 'ğŸŒ¬ï¸ğŸŒªï¸', desc: 'ë‘ ë°”ëŒì´ ë§Œë‚˜ íƒœì–´ë‚œ ê±°ëŒ€í•œ í­í’ì˜ ì •ë ¹.', recipe: ['wind', 'wind'], rarity: 'rare' },
            'fusion-earth': { name: 'ë…¸ì•„ìŠ¤', icon: 'ğŸŒ±ğŸ”ï¸', desc: 'ë‘ ë•…ì´ ë§Œë‚˜ íƒœì–´ë‚œ ìš°ê±°ì§„ ì‚°ë§¥ì˜ ì •ë ¹.', recipe: ['earth', 'earth'], rarity: 'rare' },
            'fusion-light': { name: 'ë£¨ë¯¸ì—˜', icon: 'âœ¨âš¡', desc: 'ë‘ ë¹›ì´ ë§Œë‚˜ íƒœì–´ë‚œ ëˆˆë¶€ì‹  ì„¬ê´‘ì˜ ì •ë ¹.', recipe: ['light', 'light'], rarity: 'rare' },
            'fusion-dark': { name: 'ë…¹íˆ¬ìŠ¤', icon: 'ğŸŒ™ğŸ•³ï¸', desc: 'ë‘ ì–´ë‘ ì´ ë§Œë‚˜ íƒœì–´ë‚œ ëì—†ëŠ” ì‹¬ì—°ì˜ ì •ë ¹.', recipe: ['dark', 'dark'], rarity: 'rare' },
            'fusion-normal': { name: 'í”„ë¦¬ë§ˆ', icon: 'âšªâœ¨', desc: 'ë‘ ìˆœìˆ˜í•œ í˜ì´ ë§Œë‚˜ íƒœì–´ë‚œ ê·¼ì›ì˜ ì •ë ¹.', recipe: ['normal', 'normal'], rarity: 'rare' },
            
            // ìƒê·¹ ì†ì„± (ê· í˜• ê³„ì—´)
            'fusion-balance-flame': { name: 'ì—í…Œë¥´ë‚˜', icon: 'ğŸ”¥ğŸ’§', desc: 'ë¶ˆê³¼ ë¬¼ì´ ë§Œë‚˜ íƒœì–´ë‚œ ì˜ì›ì˜ ì •ë ¹.', recipe: ['fire', 'water'], rarity: 'epic' },
            'fusion-balance-storm': { name: 'ì‚¬ì¼ë Œì‹œì•„', icon: 'ğŸŒ¬ï¸ğŸŒ±', desc: 'ë°”ëŒê³¼ ëŒ€ì§€ê°€ ë§Œë‚˜ íƒœì–´ë‚œ ê³ ìš”ì˜ ì •ë ¹.', recipe: ['wind', 'earth'], rarity: 'epic' },
            'fusion-balance-twilight': { name: 'íŠ¸ì™€ì¼ë¼', icon: 'âœ¨ğŸŒ™', desc: 'ë¹›ê³¼ ì–´ë‘ ì´ ë§Œë‚˜ íƒœì–´ë‚œ í™©í˜¼ì˜ ì •ë ¹.', recipe: ['light', 'dark'], rarity: 'epic' },
            
            // ë¶ˆ ì¡°í•©
            'fusion-phoenix': { name: 'ì†”ë¼ë¦¬ìŠ¤', icon: 'ğŸ”¥ğŸ¦', desc: 'ë¶ˆê³¼ ë¹›ì´ ë§Œë‚˜ íƒœì–´ë‚œ íƒœì–‘ì˜ ì •ë ¹.', recipe: ['fire', 'light'], rarity: 'legendary' },
            'fusion-dragon': { name: 'í…œí˜ìŠ¤íƒ€', icon: 'ğŸ”¥ğŸŒ¬ï¸', desc: 'ë¶ˆê³¼ ë°”ëŒì´ ë§Œë‚˜ íƒœì–´ë‚œ í­ì—¼ì˜ ì •ë ¹.', recipe: ['fire', 'wind'], rarity: 'legendary' },
            'fusion-lava': { name: 'ë§ˆê·¸ë§ˆ', icon: 'ğŸ”¥ğŸŒ±', desc: 'ë¶ˆê³¼ ëŒ€ì§€ê°€ ë§Œë‚˜ íƒœì–´ë‚œ ìš©ì•”ì˜ ì •ë ¹.', recipe: ['fire', 'earth'], rarity: 'legendary' },
            'fusion-shadow-flame': { name: 'ì¸í˜ë¥´ë…¸', icon: 'ğŸ”¥ğŸŒ™', desc: 'ë¶ˆê³¼ ì–´ë‘ ì´ ë§Œë‚˜ íƒœì–´ë‚œ ì§€ì˜¥ë¶ˆì˜ ì •ë ¹.', recipe: ['fire', 'dark'], rarity: 'legendary' },
            
            // ë¬¼ ì¡°í•©
            'fusion-leviathan': { name: 'ì•„ë¹„ìˆ˜ìŠ¤', icon: 'ğŸ’§ğŸ‰', desc: 'ë¬¼ê³¼ ì–´ë‘ ì´ ë§Œë‚˜ íƒœì–´ë‚œ ì‹¬í•´ì˜ ì •ë ¹.', recipe: ['water', 'dark'], rarity: 'legendary' },
            'fusion-cloud': { name: 'ëˆ„ë² ', icon: 'ğŸ’§â˜ï¸', desc: 'ë¬¼ê³¼ ë°”ëŒì´ ë§Œë‚˜ íƒœì–´ë‚œ êµ¬ë¦„ì˜ ì •ë ¹.', recipe: ['water', 'wind'], rarity: 'legendary' },
            'fusion-swamp': { name: 'ê¸€ë¦¬ìŠ¤', icon: 'ğŸ’§ğŸŒ±', desc: 'ë¬¼ê³¼ ëŒ€ì§€ê°€ ë§Œë‚˜ íƒœì–´ë‚œ ëŠªì˜ ì •ë ¹.', recipe: ['water', 'earth'], rarity: 'legendary' },
            'fusion-rainbow': { name: 'ì´ë¦¬ìŠ¤', icon: 'ğŸ’§ğŸŒˆ', desc: 'ë¬¼ê³¼ ë¹›ì´ ë§Œë‚˜ íƒœì–´ë‚œ ë¬´ì§€ê°œì˜ ì •ë ¹.', recipe: ['water', 'light'], rarity: 'legendary' },
            
            // ë°”ëŒ ì¡°í•©
            'fusion-aurora': { name: 'ì˜¤ë¡œë¼', icon: 'ğŸŒ¬ï¸ğŸŒŒ', desc: 'ë°”ëŒê³¼ ë¹›ì´ ë§Œë‚˜ íƒœì–´ë‚œ ì˜¤ë¡œë¼ì˜ ì •ë ¹.', recipe: ['wind', 'light'], rarity: 'legendary' },
            'fusion-void': { name: 'íˆ¬ë¥´ë³´', icon: 'ğŸŒ¬ï¸ğŸŒ€', desc: 'ë°”ëŒê³¼ ì–´ë‘ ì´ ë§Œë‚˜ íƒœì–´ë‚œ íšŒì˜¤ë¦¬ì˜ ì •ë ¹.', recipe: ['wind', 'dark'], rarity: 'legendary' },
            
            // ëŒ€ì§€ ì¡°í•©
            'fusion-golem': { name: 'í¬ë¦¬ìŠ¤íƒˆë¦¬ì•„', icon: 'ğŸŒ±ğŸ’', desc: 'ëŒ€ì§€ì™€ ë¹›ì´ ë§Œë‚˜ íƒœì–´ë‚œ ìˆ˜ì •ì˜ ì •ë ¹.', recipe: ['earth', 'light'], rarity: 'legendary' },
            'fusion-cave': { name: 'ì•ˆíŠ¸ë£¸', icon: 'ğŸŒ±â›°ï¸', desc: 'ëŒ€ì§€ì™€ ì–´ë‘ ì´ ë§Œë‚˜ íƒœì–´ë‚œ ë™êµ´ì˜ ì •ë ¹.', recipe: ['earth', 'dark'], rarity: 'legendary' },
            
            // íŠ¹ìˆ˜ ì¡°í•©
            'fusion-spirit-king': { name: 'í•˜ëª¨ë‹ˆì•„', icon: 'ğŸ‘‘âœ¨', desc: 'ëª¨ë“  ì›ì†Œë¥¼ í’ˆê³  íƒœì–´ë‚œ ì¡°í™”ì˜ ì •ë ¹.', recipe: ['balanced', 'balanced'], rarity: 'legendary' },
            'fusion-chaos-king': { name: 'ì½”ìŠ¤ëª¨ìŠ¤', icon: 'ğŸŒªï¸ğŸ‘‘', desc: 'ì„¸ìƒì˜ í˜¼ëˆì„ í’ˆê³  íƒœì–´ë‚œ ì§ˆì„œì˜ ì •ë ¹.', recipe: ['multi', 'multi'], rarity: 'legendary' },
            'fusion-balance-chaos': { name: 'ë¦¬ë©˜', icon: 'âš–ï¸ğŸŒªï¸', desc: 'ì¡°í™”ì™€ í˜¼ëˆì„ í’ˆê³  íƒœì–´ë‚œ ê²½ê³„ì˜ ì •ë ¹.', recipe: ['balanced', 'multi'], rarity: 'legendary' },
            
            // ì „ì„¤ ì •ë ¹ ì—°ê²°
            'fusion-oblivion': { name: 'ì˜¤ë¸”ë¦¬ë¹„ì˜¨', icon: 'ğŸ¦‹ğŸŒŒ', desc: 'ì •ë ¹ì˜ êµ°ì£¼ë“¤ì´ ë§Œë‚˜ íƒœì–´ë‚œ ë§ê°ì˜ ì •ë ¹.', recipe: ['titania', 'oberon'], rarity: 'mythic' }
        };
        
        // ========== ì´ë²¤íŠ¸ ì •ë ¹ ì‹œìŠ¤í…œ ==========
        const EVENT_TYPES = {
            'christmas2025': {
                name: 'ê¸°í”„í‹°',
                icon: 'ğŸ„',
                attribute: 'event_christmas',
                desc: 'ì‚°íƒ€ í• ì•„ë²„ì§€ê°€ í¬ë¦¬ìŠ¤ë§ˆìŠ¤ ì„ ë¬¼ê³¼ í•¨ê»˜ íŠ¹ë³„í•œ ì •ë ¹ì˜ ì•Œì„ ì„ ë¬¼í–ˆì–´ìš”!',
                validUntil: '2026-01-31',
                stages: {
                    egg: '<img src="https://raw.githubusercontent.com/mongyeonlab-cpu/mylittleterrarium/main/images/%EC%A0%95%EB%A0%B9%EC%95%8C_%ED%81%AC%EB%A6%AC%EC%8A%A4%EB%A7%88%EC%8A%A4_%EA%B8%B0%ED%94%84%ED%8B%B0.png" style="width:150px;height:150px;vertical-align:middle;">',
                    larva1: '<img src="https://raw.githubusercontent.com/mongyeonlab-cpu/mylittleterrarium/main/images/%EC%95%A0%EB%B2%8C%EB%A0%88_%ED%81%AC%EB%A6%AC%EC%8A%A4%EB%A7%88%EC%8A%A4_%EA%B8%B0%ED%94%84%ED%8B%B0_1%EB%A0%B9.png" style="width:150px;height:150px;vertical-align:middle;">',
                    larva2: '<img src="https://raw.githubusercontent.com/mongyeonlab-cpu/mylittleterrarium/main/images/%EC%95%A0%EB%B2%8C%EB%A0%88_%ED%81%AC%EB%A6%AC%EC%8A%A4%EB%A7%88%EC%8A%A4_%EA%B8%B0%ED%94%84%ED%8B%B0_2%EB%A0%B9.png" style="width:150px;height:150px;vertical-align:middle;">',
                    larva3: '<img src="https://raw.githubusercontent.com/mongyeonlab-cpu/mylittleterrarium/main/images/%EC%95%A0%EB%B2%8C%EB%A0%88_%ED%81%AC%EB%A6%AC%EC%8A%A4%EB%A7%88%EC%8A%A4_%EA%B8%B0%ED%94%84%ED%8B%B0_2%EB%A0%B9.png" style="width:150px;height:150px;vertical-align:middle;">',
                    pupa: '<img src="https://raw.githubusercontent.com/mongyeonlab-cpu/mylittleterrarium/main/images/%ED%81%AC%EB%A6%AC%EC%8A%A4%EB%A7%88%EC%8A%A4_%EB%B2%88%EB%8D%B0%EA%B8%B0.png" style="width:150px;height:150px;vertical-align:middle;">',
                    adult: {
                        butterfly: '<img src="https://raw.githubusercontent.com/mongyeonlab-cpu/mylittleterrarium/main/images/%EC%A0%95%EB%A0%B9_%ED%81%AC%EB%A6%AC%EC%8A%A4%EB%A7%88%EC%8A%A4_%EA%B8%B0%ED%94%84%ED%8B%B0_%EB%82%98%EB%B9%84.png" style="width:270px;height:370px;vertical-align:middle;">',
                        moth: '<img src="https://raw.githubusercontent.com/mongyeonlab-cpu/mylittleterrarium/main/images/%EC%A0%95%EB%A0%B9_%ED%81%AC%EB%A6%AC%EC%8A%A4%EB%A7%88%EC%8A%A4_%EA%B8%B0%ED%94%84%ED%8B%B0_%EB%82%98%EB%B0%A9.png" style="width:270px;height:370px;vertical-align:middle;">'
                    }
                },
                rewards: [
                    { type: 'decoration', id: 'christmas_tree', name: 'í¬ë¦¬ìŠ¤ë§ˆìŠ¤ íŠ¸ë¦¬', icon: 'ğŸ„' },
                    { type: 'decoration', id: 'christmas_gift', name: 'ì„ ë¬¼ ìƒì', icon: 'ğŸ' },
                    { type: 'food', id: 'christmas_cookie', name: 'í¬ë¦¬ìŠ¤ë§ˆìŠ¤ ì¿ í‚¤', icon: 'ğŸª' },
                    { type: 'music', id: 'christmas_carol', name: 'í¬ë¦¬ìŠ¤ë§ˆìŠ¤ ìºë¡¤', icon: 'ğŸµ' }
                ],
                // ì»¬ëŸ¬ ë°˜ì „ ë²„ì „ (25% í™•ë¥ )
                shiny: {
                    name: 'ìŠ¤ë…¸ìœ„',
                    icon: 'â„ï¸',
                    desc: 'ê²¨ìš¸ì˜ ëˆˆê½ƒì„ ë‹®ì€ ì •ë ¹.',
                    stages: {
                        egg: '<img src="https://raw.githubusercontent.com/mongyeonlab-cpu/mylittleterrarium/main/images/%EC%A0%95%EB%A0%B9%EC%95%8C_%ED%81%AC%EB%A6%AC%EC%8A%A4%EB%A7%88%EC%8A%A4_%EC%8A%A4%EB%85%B8%EC%9C%84.png" style="width:150px;height:150px;vertical-align:middle;">',
                        larva1: '<img src="https://raw.githubusercontent.com/mongyeonlab-cpu/mylittleterrarium/main/images/%EC%95%A0%EB%B2%8C%EB%A0%88_%ED%81%AC%EB%A6%AC%EC%8A%A4%EB%A7%88%EC%8A%A4_%EC%8A%A4%EB%85%B8%EC%9C%84_1%EB%A0%B9.png" style="width:150px;height:150px;vertical-align:middle;">',
                        larva2: '<img src="https://raw.githubusercontent.com/mongyeonlab-cpu/mylittleterrarium/main/images/%EC%95%A0%EB%B2%8C%EB%A0%88_%ED%81%AC%EB%A6%AC%EC%8A%A4%EB%A7%88%EC%8A%A4_%EC%8A%A4%EB%85%B8%EC%9C%84_2%EB%A0%B9.png" style="width:150px;height:150px;vertical-align:middle;">',
                        larva3: '<img src="https://raw.githubusercontent.com/mongyeonlab-cpu/mylittleterrarium/main/images/%EC%95%A0%EB%B2%8C%EB%A0%88_%ED%81%AC%EB%A6%AC%EC%8A%A4%EB%A7%88%EC%8A%A4_%EC%8A%A4%EB%85%B8%EC%9C%84_2%EB%A0%B9.png" style="width:150px;height:150px;vertical-align:middle;">',
                        pupa: '<img src="https://raw.githubusercontent.com/mongyeonlab-cpu/mylittleterrarium/main/images/%ED%81%AC%EB%A6%AC%EC%8A%A4%EB%A7%88%EC%8A%A4_%EB%88%88%EA%BD%83_%EB%B2%88%EB%8D%B0%EA%B8%B0.png" style="width:150px;height:150px;vertical-align:middle;">',
                        adult: {
                            butterfly: '<img src="https://raw.githubusercontent.com/mongyeonlab-cpu/mylittleterrarium/main/images/%EC%A0%95%EB%A0%B9_%ED%81%AC%EB%A6%AC%EC%8A%A4%EB%A7%88%EC%8A%A4_%EC%8A%A4%EB%85%B8%EC%9C%84_%EB%82%98%EB%B9%84.png" style="width:270px;height:370px;vertical-align:middle;">',
                            moth: '<img src="https://raw.githubusercontent.com/mongyeonlab-cpu/mylittleterrarium/main/images/%EC%A0%95%EB%A0%B9_%ED%81%AC%EB%A6%AC%EC%8A%A4%EB%A7%88%EC%8A%A4_%EC%8A%A4%EB%85%B8%EC%9C%84_%EB%82%98%EB%B0%A9.png" style="width:270px;height:370px;vertical-align:middle;">'
                        }
                    },
                    chance: 0.4 // 40% í™•ë¥ 
                }
            }
        };
        
        // ì´ë²¤íŠ¸ ì „ìš© ì•„ì´í…œ ì •ì˜
        const EVENT_ITEMS = {
            // í¬ë¦¬ìŠ¤ë§ˆìŠ¤ ì¥ì‹
            'christmas_tree': {
                name: 'í¬ë¦¬ìŠ¤ë§ˆìŠ¤ íŠ¸ë¦¬',
                icon: 'ğŸ„',
                type: 'decoration',
                event: 'christmas2025',
                quality: 'legendary',
                effects: { fire: 5, water: 5, wind: 5, earth: 5, light: 10, dark: 0 },
                desc: 'íŠ¹ë³„í•œ í¬ë¦¬ìŠ¤ë§ˆìŠ¤ ì„ ë¬¼. ëª¨ë“  ì†ì„±ì„ ë†’ì—¬ì¤ë‹ˆë‹¤.'
            },
            // í¬ë¦¬ìŠ¤ë§ˆìŠ¤ ì„ ë¬¼ìƒì
            'christmas_gift': {
                name: 'ì„ ë¬¼ ìƒì',
                icon: 'ğŸ',
                type: 'decoration',
                event: 'christmas2025',
                quality: 'legendary',
                effects: { fire: 3, water: 3, wind: 3, earth: 3, light: 5, dark: 5 },
                desc: 'íŠ¹ë³„í•œ í¬ë¦¬ìŠ¤ë§ˆìŠ¤ ì„ ë¬¼. ë¬´ì—‡ì´ ë“¤ì–´ìˆì„ê¹Œìš”?'
            },
            // í¬ë¦¬ìŠ¤ë§ˆìŠ¤ ë¨¹ì´
            'christmas_cookie': {
                name: 'í¬ë¦¬ìŠ¤ë§ˆìŠ¤ ì¿ í‚¤',
                icon: 'ğŸª',
                type: 'food',
                event: 'christmas2025',
                effects: { intelligence: 5, strength: 5, charm: 5, growth: 10 },
                desc: 'íŠ¹ë³„í•œ í¬ë¦¬ìŠ¤ë§ˆìŠ¤ ì„ ë¬¼. ëª¨ë“  ìŠ¤íƒ¯ì„ í¬ê²Œ ì˜¬ë ¤ì¤ë‹ˆë‹¤.'
            },
            // í¬ë¦¬ìŠ¤ë§ˆìŠ¤ ìŒì•…
            'christmas_carol': {
                name: 'í¬ë¦¬ìŠ¤ë§ˆìŠ¤ ìºë¡¤',
                icon: 'ğŸµ',
                type: 'music',
                event: 'christmas2025',
                effects: { affection: 10, charm: 5 },
                desc: 'íŠ¹ë³„í•œ í¬ë¦¬ìŠ¤ë§ˆìŠ¤ ì„ ë¬¼. ì• ì •ë„ë¥¼ í¬ê²Œ ì˜¬ë ¤ì¤ë‹ˆë‹¤.'
            }
        };
        
        // ì´ë²¤íŠ¸ ì½”ë“œ ìƒì„± í•¨ìˆ˜
        function generateEventCode(eventType) {
            const event = EVENT_TYPES[eventType];
            if (!event) return null;
            
            const data = {
                e: eventType,
                ts: Date.now()
            };
            
            try {
                const json = JSON.stringify(data);
                const base64 = btoa(unescape(encodeURIComponent(json)));
                return 'SGEVENT-' + base64;
            } catch (e) {
                console.error('ì´ë²¤íŠ¸ ì½”ë“œ ìƒì„± ì˜¤ë¥˜:', e);
                return null;
            }
        }
        
        // ì´ë²¤íŠ¸ ì½”ë“œ í•´ì„ í•¨ìˆ˜
        function decodeEventCode(code) {
            try {
                if (!code.startsWith('SGEVENT-')) return null;
                const base64 = code.substring(8);
                const json = decodeURIComponent(escape(atob(base64)));
                const data = JSON.parse(json);
                
                if (!data.e || !EVENT_TYPES[data.e]) return null;
                
                const event = EVENT_TYPES[data.e];
                
                // ìœ íš¨ê¸°ê°„ ì²´í¬
                if (event.validUntil && new Date() > new Date(event.validUntil)) {
                    return { expired: true, eventType: data.e };
                }
                
                return {
                    eventType: data.e,
                    event: event,
                    timestamp: data.ts
                };
            } catch (e) {
                console.error('ì´ë²¤íŠ¸ ì½”ë“œ í•´ì„ ì˜¤ë¥˜:', e);
                return null;
            }
        }
        
        // ì´ë²¤íŠ¸ ì•Œ ìƒì„± í•¨ìˆ˜
        function createEventSpirit(eventType) {
            const event = EVENT_TYPES[eventType];
            if (!event) return null;
            
            // ì´ë¡œì¹˜ í™•ë¥  ì²´í¬
            const isShiny = event.shiny && Math.random() < event.shiny.chance;
            
            const timestamp = new Date().toLocaleString('ko-KR', {
                month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit'
            });
            
            const spiritName = isShiny ? event.shiny.name : event.name;
            const birthMessage = isShiny 
                ? `âœ¨ ì´ë²¤íŠ¸ ì½”ë“œë¡œ í¬ê·€í•œ ${spiritName}ì˜ ì•Œì´ íƒœì–´ë‚¬ìŠµë‹ˆë‹¤!`
                : `ğŸ„ ì´ë²¤íŠ¸ ì½”ë“œë¡œ íŠ¹ë³„í•œ ì•Œì´ íƒœì–´ë‚¬ìŠµë‹ˆë‹¤!`;
            
            const spirit = {
                id: Date.now(),
                name: spiritName,
                originalName: spiritName,
                growth: 0,
                parameters: {
                    intelligence: 0,
                    strength: 0,
                    charm: 0,
                    affection: 0
                },
                hiddenAttributes: {
                    fire: 0, water: 0, wind: 0, earth: 0, light: 0, dark: 0
                },
                satisfaction: 'mid',
                lastFed: null,
                lastMusic: null,
                lastPat: null,
                lastDecorate: null,
                lastInteraction: Date.now(),
                status: isShiny ? 'í¬ê·€í•œ ì•Œì´ ì€ì€í•˜ê²Œ ë¹›ë‚˜ê³  ìˆìŠµë‹ˆë‹¤...' : 'íŠ¹ë³„í•œ ì•Œì´ ë¹›ë‚˜ê³  ìˆìŠµë‹ˆë‹¤...',
                birthTime: Date.now(),
                logs: [
                    { time: timestamp, message: birthMessage }
                ],
                lightTime: 0,
                darkTime: 0,
                musicListened: 0,
                feedCount: 0,
                // ì´ë²¤íŠ¸ ì „ìš© ì†ì„±
                isEventSpirit: true,
                eventType: eventType,
                isShiny: isShiny // ì´ë¡œì¹˜ ì—¬ë¶€
            };
            
            return spirit;
        }
        
        // ì´ë²¤íŠ¸ ì •ë ¹ ìŠ¤í…Œì´ì§€ ì•„ì´ì½˜ ê°€ì ¸ì˜¤ê¸°
        function getEventStageIcon(spirit) {
            if (!spirit.isEventSpirit || !spirit.eventType) return null;
            const event = EVENT_TYPES[spirit.eventType];
            if (!event) return null;
            
            const stage = getStage(spirit.growth);
            
            // ì´ë¡œì¹˜ë©´ ì´ë¡œì¹˜ ìŠ¤í…Œì´ì§€ ì•„ì´ì½˜ ì‚¬ìš©
            if (spirit.isShiny && event.shiny && event.shiny.stages) {
                const stageIcon = event.shiny.stages[stage];
                // adultê°€ ê°ì²´(ë‚˜ë¹„/ë‚˜ë°©)ì¸ ê²½ìš°
                if (stage === 'adult' && typeof stageIcon === 'object' && stageIcon.butterfly) {
                    const wingType = spirit.wingType || 'butterfly';
                    return stageIcon[wingType] || stageIcon.butterfly;
                }
                return stageIcon || event.shiny.icon;
            }
            
            const stageIcon = event.stages[stage];
            // adultê°€ ê°ì²´(ë‚˜ë¹„/ë‚˜ë°©)ì¸ ê²½ìš°
            if (stage === 'adult' && typeof stageIcon === 'object' && stageIcon.butterfly) {
                const wingType = spirit.wingType || 'butterfly';
                return stageIcon[wingType] || stageIcon.butterfly;
            }
            return stageIcon || event.icon;
        }
        
        // ì´ë²¤íŠ¸ ì •ë ¹ ì™„ì„± ì‹œ ë³´ìƒ ì§€ê¸‰
        function giveEventRewards(eventType) {
            const event = EVENT_TYPES[eventType];
            if (!event || !event.rewards) return;
            
            event.rewards.forEach(reward => {
                if (reward.type === 'decoration') {
                    if (!inventory.decorations) inventory.decorations = [];
                    inventory.decorations.push(reward.id);
                } else if (reward.type === 'food') {
                    if (!inventory.food) inventory.food = [];
                    inventory.food.push(reward.id);
                } else if (reward.type === 'music') {
                    if (!inventory.music) inventory.music = [];
                    inventory.music.push(reward.id);
                }
            });
            
            const rewardNames = event.rewards.map(r => `${r.icon} ${r.name}`).join(', ');
            showNotification(`ğŸ ì´ë²¤íŠ¸ ë³´ìƒ íšë“! ${rewardNames}`);
        }
        
        // í•©ì„± ê´€ë ¨ ë³€ìˆ˜
        let fusionSlot1Spirit = null;
        let fusionSlot2Spirit = null;
        const FUSION_COST = 100;
        const BREED_COST = 50;
        
        // ëª¨ë‹¬ z-index ê´€ë¦¬
        let currentZIndex = 10000;
        function getNextZIndex() {
            currentZIndex += 10;
            return currentZIndex;
        }

        function loadGame() {
            const saved = localStorage.getItem('spiritGardenV2');
            if (saved) {
                const data = JSON.parse(saved);
                spirits = data.spirits || [];
                
                // ë¬¸ìì—´ idë¥¼ ìˆ«ì idë¡œ ë³€í™˜ (ì—°ëª¨ ì•Œ í˜¸í™˜ì„±)
                spirits.forEach(spirit => {
                    if (typeof spirit.id === 'string') {
                        spirit.id = Date.now() + Math.floor(Math.random() * 10000);
                    }
                });
                
                collection = data.collection || [];
                encyclopedia = data.encyclopedia || {};
                
                // ë„ê° ë°ì´í„° í˜•ì‹ í†µì¼ (ê°ì²´ â†’ ìˆ«ì)
                Object.keys(encyclopedia).forEach(key => {
                    if (typeof encyclopedia[key] === 'object' && encyclopedia[key] !== null) {
                        encyclopedia[key] = encyclopedia[key].count || 1;
                    }
                });
                
                // ===== ìŠ¤íƒ¯ íƒ€ì… ë§ˆì´ê·¸ë ˆì´ì…˜ (v41 ì´ì „ â†’ v41+) =====
                // ì´ì „ ë²„ì „: intelligent-low, intelligent-mid, intelligent-high
                // ìƒˆ ë²„ì „: intelligent
                const statLevelPattern = /^(intelligent|strong|beautiful)-(low|mid|high)$/;
                
                // ìœ¡ì„± ì¤‘ì¸ ì •ë ¹ ë§ˆì´ê·¸ë ˆì´ì…˜
                spirits.forEach(spirit => {
                    if (spirit.evolutionType && statLevelPattern.test(spirit.evolutionType)) {
                        spirit.evolutionType = spirit.evolutionType.replace(/-(low|mid|high)$/, '');
                    }
                    if (spirit.evolutionData && spirit.evolutionData.type && statLevelPattern.test(spirit.evolutionData.type)) {
                        spirit.evolutionData.type = spirit.evolutionData.type.replace(/-(low|mid|high)$/, '');
                    }
                });
                
                // ì•¨ë²” ë§ˆì´ê·¸ë ˆì´ì…˜
                collection.forEach(spirit => {
                    if (spirit.type && statLevelPattern.test(spirit.type)) {
                        spirit.type = spirit.type.replace(/-(low|mid|high)$/, '');
                    }
                    
                    // ì´ë²¤íŠ¸ ì •ë ¹ wingType ë§ˆì´ê·¸ë ˆì´ì…˜ (ê¸°ì¡´ ë°ì´í„°ì— wingTypeì´ ì—†ëŠ” ê²½ìš°)
                    if (spirit.type && spirit.type.startsWith('event_') && !spirit.wingType) {
                        if (spirit.lightTime !== undefined && spirit.darkTime !== undefined) {
                            spirit.wingType = spirit.lightTime > spirit.darkTime ? 'butterfly' : 'moth';
                            if (spirit.lightTime === spirit.darkTime) spirit.wingType = 'butterfly';
                        } else {
                            spirit.wingType = 'butterfly'; // ê¸°ë³¸ê°’
                        }
                    }
                });
                
                // ë„ê° ë§ˆì´ê·¸ë ˆì´ì…˜ (í‚¤ ë³€í™˜ ë° í•©ì‚°)
                const newEncyclopedia = {};
                Object.entries(encyclopedia).forEach(([key, count]) => {
                    // í‚¤ì—ì„œ -low, -mid, -high ì œê±°
                    // ì˜ˆ: intelligent-mid-fire-butterfly â†’ intelligent-fire-butterfly
                    const newKey = key.replace(/-(low|mid|high)-/, '-');
                    
                    if (!newEncyclopedia[newKey]) {
                        newEncyclopedia[newKey] = 0;
                    }
                    newEncyclopedia[newKey] += count;
                });
                encyclopedia = newEncyclopedia;
                // ===== ë§ˆì´ê·¸ë ˆì´ì…˜ ë =====
                
                // ===== ì´ë²¤íŠ¸ ì •ë ¹ ë„ê° í‚¤ ë§ˆì´ê·¸ë ˆì´ì…˜ (ë‚˜ë¹„/ë‚˜ë°© ë¶„ë¦¬) =====
                const eventKeysToMigrate = Object.keys(encyclopedia).filter(key => 
                    key.startsWith('event_') && !key.endsWith('_butterfly') && !key.endsWith('_moth')
                );
                
                eventKeysToMigrate.forEach(key => {
                    // ê¸°ì¡´ ì´ë²¤íŠ¸ í‚¤ (ì˜ˆ: event_christmas2025_shiny)
                    const typeParts = key.replace('event_', '').split('_');
                    const eventKey = typeParts[0];
                    const isShiny = typeParts.includes('shiny');
                    const event = EVENT_TYPES[eventKey];
                    
                    // ì´ë²¤íŠ¸ê°€ ë‚˜ë¹„/ë‚˜ë°© ë¶„ë¦¬ë¥¼ ì§€ì›í•˜ëŠ”ì§€ í™•ì¸
                    const stages = isShiny && event?.shiny ? event.shiny.stages : event?.stages;
                    const hasWingTypes = stages?.adult && typeof stages.adult === 'object' && stages.adult.butterfly;
                    
                    if (hasWingTypes) {
                        // ê¸°ì¡´ ì¹´ìš´íŠ¸ë¥¼ ë‚˜ë¹„í˜•ìœ¼ë¡œ ì´ì „ (ê¸°ë³¸ê°’)
                        const count = encyclopedia[key];
                        const newKey = isShiny ? `event_${eventKey}_shiny_butterfly` : `event_${eventKey}_butterfly`;
                        encyclopedia[newKey] = (encyclopedia[newKey] || 0) + count;
                        delete encyclopedia[key];
                        console.log(`ë„ê° í‚¤ ë§ˆì´ê·¸ë ˆì´ì…˜: ${key} â†’ ${newKey} (${count}íšŒ)`);
                    }
                });
                // ===== ì´ë²¤íŠ¸ ì •ë ¹ ë„ê° í‚¤ ë§ˆì´ê·¸ë ˆì´ì…˜ ë =====
                
                // ë„ê° ìƒì„¸ ì •ë³´ ë¡œë“œ (ë³µêµ¬ìš©)
                encyclopediaDetails = data.encyclopediaDetails || {};
                
                // ê¸°ì¡´ ë„ê° ë°ì´í„° í˜¸í™˜ì„± ì²˜ë¦¬ - ì¡´ì¬í•˜ì§€ ì•ŠëŠ” ì§„í™” íƒ€ì… ì œê±° (ì´ë²¤íŠ¸/í•©ì„± ì •ë ¹ì€ ìœ ì§€)
                collection = collection.filter(item => {
                    // ì´ë²¤íŠ¸ ì •ë ¹ì€ í•­ìƒ ìœ ì§€
                    if (item.type && item.type.startsWith('event_')) return true;
                    // í•©ì„± ì •ë ¹(fusion-)ì€ í•­ìƒ ìœ ì§€
                    if (item.type && (item.type.startsWith('fusion-') || FUSION_TYPES[item.type])) return true;
                    // isFusion í”Œë˜ê·¸ê°€ ìˆìœ¼ë©´ ìœ ì§€
                    if (item.isFusion) return true;
                    // í‹°íƒ€ë‹ˆì•„/ì˜¤ë² ë¡ ì€ í•­ìƒ ìœ ì§€
                    if (item.type === 'titania' || item.type === 'oberon' || item.type === 'spiritking') return true;
                    // ì¼ë°˜ ì •ë ¹ì€ EVOLUTION_TYPESì— ìˆëŠ”ì§€ í™•ì¸
                    return EVOLUTION_TYPES[item.type] !== undefined;
                });
                
                inventory = data.inventory || { 
                    music: [], 
                    decorations: [],
                    food: ['fire', 'fire', 'fire', 'water', 'water', 'water', 'wind', 'wind', 'wind', 'earth', 'earth', 'earth']
                };
                
                // ì˜ëª»ëœ ìŒì•… í‚¤ ì œê±° (ì¡´ì¬í•˜ì§€ ì•ŠëŠ” ë ˆì½”ë“œë§Œ)
                if (inventory.music) {
                    // MUSIC_TYPESì— ìˆëŠ” ëª¨ë“  ë ˆì½”ë“œ + ì´ë²¤íŠ¸ ìŒì•…
                    const validMusicKeys = Object.keys(MUSIC_TYPES);
                    const eventMusicKeys = Object.keys(EVENT_ITEMS).filter(key => EVENT_ITEMS[key].type === 'music');
                    const allValidMusicKeys = [...validMusicKeys, ...eventMusicKeys];
                    inventory.music = inventory.music.filter(m => allValidMusicKeys.includes(m));
                }
                
                // ê¸°ì¡´ ë¯¸ë‹ˆì–´ì²˜ í‚¤ë¥¼ ìƒˆ í˜•ì‹ìœ¼ë¡œ ë³€í™˜ (fire â†’ fire_common1 ë“±)
                const oldToNewDecoMapping = {
                    fire: 'fire_common1',
                    water: 'water_common1',
                    wind: 'wind_common1',
                    earth: 'earth_common1',
                    light: 'light_common1',
                    dark: 'dark_common1'
                };
                
                if (inventory.decorations) {
                    inventory.decorations = inventory.decorations.map(d => {
                        // ì´ë¯¸ ìƒˆ í˜•ì‹ì´ë©´ ê·¸ëŒ€ë¡œ, ì•„ë‹ˆë©´ ë³€í™˜
                        return oldToNewDecoMapping[d] || d;
                    });
                }
                
                if (installedDecorations) {
                    installedDecorations = installedDecorations.map(d => {
                        return oldToNewDecoMapping[d] || d;
                    });
                }
                
                terrarium = data.terrarium || {
                    fire: 0, water: 0, wind: 0, earth: 0, light: 0, dark: 0
                };
                installedDecorations = data.installedDecorations || [];
                
                // ê¸°ì¡´ ë¬¸ìì—´ ë°°ì—´ì„ ê°ì²´ ë°°ì—´ë¡œ ë³€í™˜ (í•˜ìœ„ í˜¸í™˜ì„±)
                installedDecorations = installedDecorations.map((d, index) => {
                    if (typeof d === 'string') {
                        return { type: d, index: index };
                    }
                    return d;
                });
                
                lightMode = data.lightMode !== undefined ? data.lightMode : true;
                coins = data.coins || 0;
                totalEggsCreated = data.totalEggsCreated || 0;
                
                // ê¸°ì¡´ ë°ì´í„° í˜¸í™˜: totalEggsCreatedê°€ ì—†ìœ¼ë©´ ì•¨ë²”+í˜„ì¬ì •ë ¹ ìˆ˜ë¡œ ì¶”ì •
                if (data.totalEggsCreated === undefined) {
                    totalEggsCreated = (collection.length || 0) + (spirits.length || 0);
                }
                
                lastGatherTime = data.lastGatherTime || null;
                currentTitle = data.currentTitle || 'none';
                currentGatherLocation = data.currentGatherLocation || 'garden';
                isPaused = data.isPaused || false;
                darkModeLocked = data.darkModeLocked || false;
                lightModeLocked = data.lightModeLocked || false;
                activatedEvents = data.activatedEvents || [];
                lowSatisfactionStartTime = data.lowSatisfactionStartTime || {};
                hasVisitedShop = data.hasVisitedShop || false;
                discoveredRecipes = data.discoveredRecipes || [];
                purchasedRecipeBooks = data.purchasedRecipeBooks || [];
                selfDiscoveredRecipes = data.selfDiscoveredRecipes || [];
                
                // ê¸°ì¡´ ë°ì´í„° í˜¸í™˜: selfDiscoveredRecipesê°€ ì—†ìœ¼ë©´ discoveredRecipesë¥¼ ë³µì‚¬
                // (ë ˆì‹œí”¼ë¶ ì‹œìŠ¤í…œ ë„ì… ì „ì— ë°œê²¬í•œ ë ˆì‹œí”¼ëŠ” ì§ì ‘ ë°œê²¬ìœ¼ë¡œ ê°„ì£¼)
                if (data.selfDiscoveredRecipes === undefined && discoveredRecipes.length > 0) {
                    selfDiscoveredRecipes = [...discoveredRecipes];
                }
                
                achievements = data.achievements || {};
                claimedAchievementRewards = data.claimedAchievementRewards || [];
                labSlot1 = data.labSlot1 || null;
                labSlot2 = data.labSlot2 || null;
                
                // ë¡œë“œ ì‹œ ìŠ¬ë¡¯ ë¹„ìš°ê¸° (í˜„ì¬ ì‹œìŠ¤í…œì€ ìŠ¬ë¡¯ì— ì˜¬ë ¤ë„ ì¸ë²¤í† ë¦¬ì—ì„œ ì°¨ê° ì•ˆ í•¨)
                labSlot1 = null;
                labSlot2 = null;
                
                lockedItems = data.lockedItems || { food: [], decorations: [], music: [] };
                if (!lockedItems.music) lockedItems.music = []; // ê¸°ì¡´ ì„¸ì´ë¸Œ í˜¸í™˜

                // ì¹­í˜¸ UI ë°˜ì˜
                const titleSelect = document.getElementById('titleSelect');
                if (titleSelect) {
                    titleSelect.value = currentTitle;
                }
                
                // ì¼ì‹œì •ì§€ ë²„íŠ¼ UI ë°˜ì˜
                const pauseBtn = document.getElementById('pauseBtn');
                if (pauseBtn && isPaused) {
                    pauseBtn.textContent = 'â–¶ï¸';
                    pauseBtn.classList.add('paused');
                    pauseBtn.title = 'ì¬ê°œ';
                    // ì¼ì‹œì •ì§€ ìƒíƒœë¡œ ë¡œë“œë˜ë©´ pausedAtì„ í˜„ì¬ ì‹œê°„ìœ¼ë¡œ ì„¤ì •
                    pausedAt = Date.now();
                }

                // ì„¤ì¹˜ëœ ë¯¸ë‹ˆì–´ì²˜ë¡œ í™˜ê²½ ì¬ê³„ì‚°
                if (installedDecorations.length > 0) {
                    recalculateTerrariumEnvironment();
                }
                
                // ê¸°ì¡´ ì •ë ¹ë“¤ì˜ ë§Œì¡±ë„ ì´ˆê¸°í™” ë° ë°°ê³ í”” íƒ€ì´ë¨¸ ë¦¬ì…‹ (í•˜ìœ„ í˜¸í™˜ì„±)
                const now = Date.now();
                spirits.forEach(spirit => {
                    if (!spirit.satisfaction) {
                        spirit.satisfaction = 'mid';
                    }
                    // ë¶ˆëŸ¬ì˜¤ê¸° ì‹œ ë°°ê³ í”” íƒ€ì´ë¨¸ ë¦¬ì…‹ (ì˜¤í”„ë¼ì¸ ë™ì•ˆ ì£½ì§€ ì•Šë„ë¡)
                    // ë‹¨, ì´ë¯¸ ì£½ì€ ì •ë ¹ì€ ë¦¬ì…‹í•˜ì§€ ì•ŠìŒ
                    if (!spirit.isDead && !spirit.isCompleted) {
                        spirit.lastFed = now;
                    }
                    
                    // hiddenAttributes 400 ìº¡ ë§ˆì´ê·¸ë ˆì´ì…˜ (v2.3.0+)
                    if (spirit.hiddenAttributes) {
                        Object.keys(spirit.hiddenAttributes).forEach(attr => {
                            if (spirit.hiddenAttributes[attr] > 400) {
                                spirit.hiddenAttributes[attr] = 400;
                            }
                        });
                    }
                });

                // ì¡°ëª… ìƒíƒœ ì ìš©
                applyLightMode();
            }
        }

        function saveGame() {
            localStorage.setItem('spiritGardenV2', JSON.stringify({
                spirits,
                collection,
                encyclopedia,
                encyclopediaDetails,
                inventory,
                terrarium,
                installedDecorations,
                lightMode,
                coins,
                totalEggsCreated,
                lastGatherTime,
                currentTitle,
                currentGatherLocation,
                isPaused,
                darkModeLocked,
                lightModeLocked,
                activatedEvents,
                lowSatisfactionStartTime,
                hasVisitedShop,
                discoveredRecipes,
                purchasedRecipeBooks,
                selfDiscoveredRecipes,
                achievements,
                claimedAchievementRewards,
                // labSlotì€ ì €ì¥í•˜ì§€ ì•ŠìŒ (ìƒˆ ì‹œìŠ¤í…œì—ì„œëŠ” í•©ì„± ì „ê¹Œì§€ ì¸ë²¤í† ë¦¬ ì°¨ê° ì•ˆ í•¨)
                lockedItems
            }));
        }

        const EGG_NAMES = [
            'ë°˜ì§ì´ëŠ” ì•Œ', 'ë§¤ëˆë§¤ëˆí•œ ì•Œ', 'ì–¼ë£©ë¬´ëŠ¬ ì•Œ', 'ë³´ë¼ìƒ‰ ì•Œ',
            'íˆ¬ëª…í•œ ì•Œ', 'í™©ê¸ˆë¹› ì•Œ', 'ì€ë¹› ì•Œ', 'ê²€ì€ìƒ‰ ì•Œ',
            'í•˜ì–€ìƒ‰ ì•Œ', 'ë¬´ì§€ê°œ ì•Œ', 'ì‘ì€ ì•Œ', 'í° ì•Œ',
            'ë”°ëœ»í•œ ì•Œ', 'ì°¨ê°€ìš´ ì•Œ', 'ë¶€ë“œëŸ¬ìš´ ì•Œ', 'ë‹¨ë‹¨í•œ ì•Œ'
        ];
        
        function generateSpiritName() {
            totalEggsCreated++;
            saveGame();
            return `${totalEggsCreated}í˜¸`;
        }

        function addLog(spirit, message) {
            if (!spirit.logs) spirit.logs = [];
            const timestamp = new Date().toLocaleString('ko-KR', {
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            });
            spirit.logs.unshift({ time: timestamp, message }); // ìµœì‹ ì´ ìœ„ë¡œ
            if (spirit.logs.length > 50) spirit.logs.pop(); // ìµœëŒ€ 50ê°œ ìœ ì§€
            
            // ì¼ì§€ ì¶”ê°€ ì‹œì—ë§Œ ì „ì²´ ë Œë”ë§
            renderSpirits();
        }

        // ì—…ì  ì²´í¬ ë° ë‹¬ì„± í•¨ìˆ˜
        function checkAchievements() {
            const albumCount = collection.length;
            const encyclopediaCount = Object.keys(encyclopedia).length;
            let newAchievements = [];
            
            // ì•¨ë²” ì—…ì  ì²´í¬
            Object.values(ACHIEVEMENTS).filter(a => a.category === 'album').forEach(achievement => {
                if (!achievements[achievement.id] && albumCount >= achievement.requirement) {
                    achievements[achievement.id] = Date.now();
                    newAchievements.push(achievement);
                }
            });
            
            // ë„ê° ì—…ì  ì²´í¬
            Object.values(ACHIEVEMENTS).filter(a => a.category === 'encyclopedia').forEach(achievement => {
                if (!achievements[achievement.id] && encyclopediaCount >= achievement.requirement) {
                    achievements[achievement.id] = Date.now();
                    newAchievements.push(achievement);
                }
            });
            
            // ë ˆì‹œí”¼ ì—…ì  ì²´í¬
            const recipeCount = discoveredRecipes.length;
            Object.values(ACHIEVEMENTS).filter(a => a.category === 'recipe').forEach(achievement => {
                if (!achievements[achievement.id] && recipeCount >= achievement.requirement) {
                    achievements[achievement.id] = Date.now();
                    newAchievements.push(achievement);
                }
            });
            
            // ë ˆì‹œí”¼ë¶ ì—†ì´ ì§ì ‘ ë°œê²¬ íŠ¹ë³„ ì—…ì  ì²´í¬
            const selfDiscoveredCount = selfDiscoveredRecipes.length;
            Object.values(ACHIEVEMENTS).filter(a => a.category === 'recipe_special').forEach(achievement => {
                if (!achievements[achievement.id] && selfDiscoveredCount >= achievement.requirement) {
                    achievements[achievement.id] = Date.now();
                    newAchievements.push(achievement);
                }
            });
            
            // ìƒˆë¡œìš´ ì—…ì  ë‹¬ì„± ì‹œ ì•Œë¦¼
            newAchievements.forEach(achievement => {
                showNotification(`ğŸ† ì—…ì  ë‹¬ì„±! "${achievement.title}"`);
            });
            
            if (newAchievements.length > 0) {
                saveGame();
                renderJournal();
            }
            
            return newAchievements;
        }
        
        // ì¼ì§€ ì„œë¸Œíƒ­ ì „í™˜
        let currentJournalTab = 'encyclopedia'; // ê¸°ë³¸ íƒ­
        
        function switchJournalTab(tab) {
            currentJournalTab = tab;
            
            // ëª¨ë“  íƒ­ ì½˜í…ì¸  ìˆ¨ê¸°ê¸°
            const tabs = ['encyclopedia', 'album', 'achievement', 'memo', 'help'];
            tabs.forEach(t => {
                const tabContent = document.getElementById(`journal${t.charAt(0).toUpperCase() + t.slice(1)}Tab`);
                const tabBtn = document.getElementById(`journalTab${t.charAt(0).toUpperCase() + t.slice(1)}`);
                if (tabContent) tabContent.style.display = 'none';
                if (tabBtn) {
                    tabBtn.style.background = 'var(--bg)';
                    tabBtn.style.color = 'var(--text)';
                    tabBtn.style.border = '1px solid var(--border)';
                }
            });
            
            // ì„ íƒí•œ íƒ­ í‘œì‹œ
            const selectedContent = document.getElementById(`journal${tab.charAt(0).toUpperCase() + tab.slice(1)}Tab`);
            const selectedBtn = document.getElementById(`journalTab${tab.charAt(0).toUpperCase() + tab.slice(1)}`);
            if (selectedContent) selectedContent.style.display = 'block';
            if (selectedBtn) {
                selectedBtn.style.background = '#9b59b6';
                selectedBtn.style.color = 'white';
                selectedBtn.style.border = 'none';
            }
            
            // ìƒë‹¨ ì„œë¸Œíƒ­ ë°” ì—…ë°ì´íŠ¸
            updateJournalSubTabUI();
            
            // íƒ­ë³„ ë Œë”ë§ í˜¸ì¶œ
            if (tab === 'encyclopedia') {
                renderEncyclopedia();
            } else if (tab === 'album') {
                renderCollection();
                // íŠœí† ë¦¬ì–¼2: ì•¨ë²” íƒ­ ì—´ê¸° ì•¡ì…˜ ì²´í¬
                checkTutorialAction('openAlbum');
            } else if (tab === 'achievement') {
                renderJournal();
            } else if (tab === 'help') {
                renderTutorialReplayList();
            }
        }
        
        // ì¼ì§€ ì„œë¸Œíƒ­ ë°” UI ì—…ë°ì´íŠ¸
        function updateJournalSubTabUI() {
            // ë°ìŠ¤í¬í†± ì„œë¸Œíƒ­ ì—…ë°ì´íŠ¸
            const journalSubTabs = document.getElementById('journalSubTabs');
            if (journalSubTabs) {
                journalSubTabs.querySelectorAll('.sub-tab').forEach(btn => {
                    btn.classList.remove('active');
                    if (btn.dataset.tab === currentJournalTab) {
                        btn.classList.add('active');
                    }
                });
            }
            
            // ëª¨ë°”ì¼ ì„œë¸Œíƒ­ ì—…ë°ì´íŠ¸
            const mobileJournalSubTabs = document.getElementById('mobileJournalSubTabs');
            if (mobileJournalSubTabs) {
                mobileJournalSubTabs.querySelectorAll('.mobile-sub-tab').forEach(btn => {
                    btn.classList.remove('active');
                    if (btn.dataset.tab === currentJournalTab) {
                        btn.classList.add('active');
                    }
                });
            }
        }
        
        // ì¼ì§€ íƒ­ ë Œë”ë§
        function renderJournal() {
            const albumCount = collection.length;
            const encyclopediaCount = Object.keys(encyclopedia).length;
            const totalAchievements = Object.keys(ACHIEVEMENTS).length;
            const completedAchievements = Object.keys(achievements).length;
            const unclaimedRewards = Object.keys(achievements).filter(id => !claimedAchievementRewards.includes(id)).length;
            
            // ì—…ì  ìš”ì•½
            const summaryDiv = document.getElementById('achievementSummary');
            if (summaryDiv) {
                // ìˆ˜ë ¹ ì™„ë£Œ ì‹œ ì´ íšë“ ì½”ì¸ ê³„ì‚°
                const totalClaimedCoins = claimedAchievementRewards.length * 25;
                
                summaryDiv.innerHTML = `
                    <div style="text-align: center; padding: 12px 20px; background: var(--bg); border-radius: 8px;">
                        <div style="font-size: 2rem; margin-bottom: 4px;">ğŸ†</div>
                        <div style="font-size: 1.5rem; font-weight: 700; color: var(--text);">${completedAchievements} / ${totalAchievements}</div>
                        <div style="font-size: 0.85rem; color: #888;">ë‹¬ì„±í•œ ì—…ì </div>
                    </div>
                    <div style="text-align: center; padding: 12px 20px; background: var(--bg); border-radius: 8px; ${unclaimedRewards > 0 ? 'border: 2px solid #ffd700;' : ''}">
                        <div style="font-size: 2rem; margin-bottom: 4px;">${unclaimedRewards > 0 ? 'ğŸ’°' : 'âœ…'}</div>
                        <div style="font-size: 1.5rem; font-weight: 700; color: ${unclaimedRewards > 0 ? '#ffd700' : '#27ae60'};">${unclaimedRewards > 0 ? unclaimedRewards * 25 : totalClaimedCoins}</div>
                        <div style="font-size: 0.85rem; color: #888;">${unclaimedRewards > 0 ? `ë¯¸ìˆ˜ë ¹ (${unclaimedRewards}ê°œ)` : 'ì´ íšë“ ì½”ì¸'}</div>
                    </div>
                    <div style="text-align: center; padding: 12px 20px; background: var(--bg); border-radius: 8px;">
                        <div style="font-size: 2rem; margin-bottom: 4px;">ğŸ“š</div>
                        <div style="font-size: 1.5rem; font-weight: 700; color: var(--text);">${encyclopediaCount}</div>
                        <div style="font-size: 0.85rem; color: #888;">ë„ê° ìˆ˜ì§‘</div>
                    </div>
                `;
            }
            
            // ì•¨ë²” ì¹´ìš´íŠ¸ í‘œì‹œ
            const albumCountDisplay = document.getElementById('albumCountDisplay');
            if (albumCountDisplay) {
                albumCountDisplay.textContent = `(í˜„ì¬ ${albumCount}ë§ˆë¦¬)`;
            }
            
            // ë„ê° ì¹´ìš´íŠ¸ í‘œì‹œ
            const encyclopediaCountDisplay = document.getElementById('encyclopediaCountDisplay');
            if (encyclopediaCountDisplay) {
                encyclopediaCountDisplay.textContent = `(í˜„ì¬ ${encyclopediaCount}ì¢…)`;
            }
            
            // ë ˆì‹œí”¼ ì¹´ìš´íŠ¸ í‘œì‹œ
            const recipeCountDisplay = document.getElementById('recipeCountDisplay');
            if (recipeCountDisplay) {
                recipeCountDisplay.textContent = `(í˜„ì¬ ${discoveredRecipes.length}ê°œ)`;
            }
            
            // ì•¨ë²” ì—…ì  ë Œë”ë§
            const albumAchievementsDiv = document.getElementById('albumAchievements');
            if (albumAchievementsDiv) {
                const albumAchievements = Object.values(ACHIEVEMENTS).filter(a => a.category === 'album').sort((a, b) => a.requirement - b.requirement);
                albumAchievementsDiv.innerHTML = albumAchievements.map(achievement => {
                    const isCompleted = achievements[achievement.id];
                    const isRewardClaimed = claimedAchievementRewards.includes(achievement.id);
                    const progress = Math.min(albumCount, achievement.requirement);
                    const progressPercent = (progress / achievement.requirement) * 100;
                    const completedDate = isCompleted ? new Date(isCompleted).toLocaleDateString('ko-KR') : null;
                    
                    // ë³´ìƒ ë²„íŠ¼/ìƒíƒœ í‘œì‹œ
                    let rewardDisplay = '';
                    if (isCompleted && !isRewardClaimed) {
                        rewardDisplay = `<button onclick="claimAchievementReward('${achievement.id}')" style="padding: 6px 12px; background: linear-gradient(135deg, #ffd700, #ffed4a); color: #333; border: none; border-radius: 6px; font-weight: 700; cursor: pointer; font-size: 0.8rem;">ğŸ’° 25ì½”ì¸ ë°›ê¸°</button>`;
                    } else if (isCompleted && isRewardClaimed) {
                        rewardDisplay = '<span style="color: #27ae60; font-size: 0.8rem; font-weight: 600;">âœ“ ìˆ˜ë ¹ì™„ë£Œ</span>';
                    }
                    
                    return `
                        <div style="padding: 16px; background: ${isCompleted ? 'linear-gradient(135deg, rgba(255,215,0,0.1), rgba(255,215,0,0.05))' : 'var(--bg)'}; border-radius: 8px; border: 1px solid ${isCompleted ? 'rgba(255,215,0,0.3)' : 'var(--border)'};">
                            <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 8px;">
                                <span style="font-size: 1.8rem; ${isCompleted ? '' : 'filter: grayscale(100%); opacity: 0.5;'}">${achievement.icon}</span>
                                <div style="flex: 1;">
                                    <div style="font-weight: 700; color: ${isCompleted ? 'var(--text)' : '#888'}; font-size: 1.05rem;">${achievement.title}</div>
                                    <div style="font-size: 0.85rem; color: #888;">${achievement.desc}</div>
                                </div>
                                ${isCompleted ? '<span style="color: #ffd700; font-size: 1.2rem;">âœ“</span>' : ''}
                            </div>
                            <div style="background: var(--border); height: 6px; border-radius: 3px; overflow: hidden;">
                                <div style="width: ${progressPercent}%; height: 100%; background: ${isCompleted ? 'linear-gradient(90deg, #ffd700, #ffed4a)' : 'var(--water)'}; transition: width 0.3s;"></div>
                            </div>
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 6px; font-size: 0.8rem; color: #888;">
                                <span>${progress} / ${achievement.requirement}ë§ˆë¦¬</span>
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    ${completedDate ? `<span>ë‹¬ì„±: ${completedDate}</span>` : ''}
                                    ${rewardDisplay}
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
            }
            
            // ë„ê° ì—…ì  ë Œë”ë§
            const encyclopediaAchievementsDiv = document.getElementById('encyclopediaAchievements');
            if (encyclopediaAchievementsDiv) {
                const encyclopediaAchievements = Object.values(ACHIEVEMENTS).filter(a => a.category === 'encyclopedia').sort((a, b) => a.requirement - b.requirement);
                encyclopediaAchievementsDiv.innerHTML = encyclopediaAchievements.map(achievement => {
                    const isCompleted = achievements[achievement.id];
                    const isRewardClaimed = claimedAchievementRewards.includes(achievement.id);
                    const progress = Math.min(encyclopediaCount, achievement.requirement);
                    const progressPercent = (progress / achievement.requirement) * 100;
                    const completedDate = isCompleted ? new Date(isCompleted).toLocaleDateString('ko-KR') : null;
                    
                    // ë³´ìƒ ë²„íŠ¼/ìƒíƒœ í‘œì‹œ
                    let rewardDisplay = '';
                    if (isCompleted && !isRewardClaimed) {
                        rewardDisplay = `<button onclick="claimAchievementReward('${achievement.id}')" style="padding: 6px 12px; background: linear-gradient(135deg, #ffd700, #ffed4a); color: #333; border: none; border-radius: 6px; font-weight: 700; cursor: pointer; font-size: 0.8rem;">ğŸ’° 25ì½”ì¸ ë°›ê¸°</button>`;
                    } else if (isCompleted && isRewardClaimed) {
                        rewardDisplay = '<span style="color: #27ae60; font-size: 0.8rem; font-weight: 600;">âœ“ ìˆ˜ë ¹ì™„ë£Œ</span>';
                    }
                    
                    return `
                        <div style="padding: 16px; background: ${isCompleted ? 'linear-gradient(135deg, rgba(255,215,0,0.1), rgba(255,215,0,0.05))' : 'var(--bg)'}; border-radius: 8px; border: 1px solid ${isCompleted ? 'rgba(255,215,0,0.3)' : 'var(--border)'};">
                            <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 8px;">
                                <span style="font-size: 1.8rem; ${isCompleted ? '' : 'filter: grayscale(100%); opacity: 0.5;'}">${achievement.icon}</span>
                                <div style="flex: 1;">
                                    <div style="font-weight: 700; color: ${isCompleted ? 'var(--text)' : '#888'}; font-size: 1.05rem;">${achievement.title}</div>
                                    <div style="font-size: 0.85rem; color: #888;">${achievement.desc}</div>
                                </div>
                                ${isCompleted ? '<span style="color: #ffd700; font-size: 1.2rem;">âœ“</span>' : ''}
                            </div>
                            <div style="background: var(--border); height: 6px; border-radius: 3px; overflow: hidden;">
                                <div style="width: ${progressPercent}%; height: 100%; background: ${isCompleted ? 'linear-gradient(90deg, #ffd700, #ffed4a)' : 'var(--earth)'}; transition: width 0.3s;"></div>
                            </div>
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 6px; font-size: 0.8rem; color: #888;">
                                <span>${progress} / ${achievement.requirement}ì¢…</span>
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    ${completedDate ? `<span>ë‹¬ì„±: ${completedDate}</span>` : ''}
                                    ${rewardDisplay}
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
            }
            
            // ë ˆì‹œí”¼ ì—…ì  ë Œë”ë§
            const recipeAchievementsDiv = document.getElementById('recipeAchievements');
            if (recipeAchievementsDiv) {
                const recipeCount = discoveredRecipes.length;
                const recipeAchievements = Object.values(ACHIEVEMENTS).filter(a => a.category === 'recipe').sort((a, b) => a.requirement - b.requirement);
                recipeAchievementsDiv.innerHTML = recipeAchievements.map(achievement => {
                    const isCompleted = achievements[achievement.id];
                    const isRewardClaimed = claimedAchievementRewards.includes(achievement.id);
                    const progress = Math.min(recipeCount, achievement.requirement);
                    const progressPercent = (progress / achievement.requirement) * 100;
                    const completedDate = isCompleted ? new Date(isCompleted).toLocaleDateString('ko-KR') : null;
                    
                    // ë³´ìƒ ë²„íŠ¼/ìƒíƒœ í‘œì‹œ
                    let rewardDisplay = '';
                    if (isCompleted && !isRewardClaimed) {
                        rewardDisplay = `<button onclick="claimAchievementReward('${achievement.id}')" style="padding: 6px 12px; background: linear-gradient(135deg, #ffd700, #ffed4a); color: #333; border: none; border-radius: 6px; font-weight: 700; cursor: pointer; font-size: 0.8rem;">ğŸ’° 25ì½”ì¸ ë°›ê¸°</button>`;
                    } else if (isCompleted && isRewardClaimed) {
                        rewardDisplay = '<span style="color: #27ae60; font-size: 0.8rem; font-weight: 600;">âœ“ ìˆ˜ë ¹ì™„ë£Œ</span>';
                    }
                    
                    return `
                        <div style="padding: 16px; background: ${isCompleted ? 'linear-gradient(135deg, rgba(255,215,0,0.1), rgba(255,215,0,0.05))' : 'var(--bg)'}; border-radius: 8px; border: 1px solid ${isCompleted ? 'rgba(255,215,0,0.3)' : 'var(--border)'};">
                            <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 8px;">
                                <span style="font-size: 1.8rem; ${isCompleted ? '' : 'filter: grayscale(100%); opacity: 0.5;'}">${achievement.icon}</span>
                                <div style="flex: 1;">
                                    <div style="font-weight: 700; color: ${isCompleted ? 'var(--text)' : '#888'}; font-size: 1.05rem;">${achievement.title}</div>
                                    <div style="font-size: 0.85rem; color: #888;">${achievement.desc}</div>
                                </div>
                                ${isCompleted ? '<span style="color: #ffd700; font-size: 1.2rem;">âœ“</span>' : ''}
                            </div>
                            <div style="background: var(--border); height: 6px; border-radius: 3px; overflow: hidden;">
                                <div style="width: ${progressPercent}%; height: 100%; background: ${isCompleted ? 'linear-gradient(90deg, #ffd700, #ffed4a)' : '#9b59b6'}; transition: width 0.3s;"></div>
                            </div>
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 6px; font-size: 0.8rem; color: #888;">
                                <span>${progress} / ${achievement.requirement}ê°œ</span>
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    ${completedDate ? `<span>ë‹¬ì„±: ${completedDate}</span>` : ''}
                                    ${rewardDisplay}
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
            }
            
            // íŠ¹ë³„ ì—…ì  ë Œë”ë§
            const specialAchievementsDiv = document.getElementById('specialAchievements');
            if (specialAchievementsDiv) {
                const selfDiscoveredCount = selfDiscoveredRecipes.length;
                const specialAchievements = Object.values(ACHIEVEMENTS).filter(a => a.category === 'recipe_special').sort((a, b) => a.requirement - b.requirement);
                specialAchievementsDiv.innerHTML = specialAchievements.map(achievement => {
                    const isCompleted = achievements[achievement.id];
                    const isRewardClaimed = claimedAchievementRewards.includes(achievement.id);
                    const progress = Math.min(selfDiscoveredCount, achievement.requirement);
                    const progressPercent = (progress / achievement.requirement) * 100;
                    const completedDate = isCompleted ? new Date(isCompleted).toLocaleDateString('ko-KR') : null;
                    
                    // ë ˆì‹œí”¼ë¶ êµ¬ë§¤ ì—¬ë¶€ì— ë”°ë¥¸ ì•ˆë‚´ ë©”ì‹œì§€
                    const hasBookPurchased = purchasedRecipeBooks.length > 0;
                    const warningMsg = hasBookPurchased && !isCompleted
                        ? '<div style="font-size: 0.75rem; color: #e74c3c; margin-top: 8px;">âš ï¸ ë ˆì‹œí”¼ë¶ì„ êµ¬ë§¤í•˜ì—¬ ì´ ì—…ì ì„ ë‹¬ì„±í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</div>'
                        : '';
                    
                    // ë³´ìƒ ë²„íŠ¼/ìƒíƒœ í‘œì‹œ
                    let rewardDisplay = '';
                    if (isCompleted && !isRewardClaimed) {
                        rewardDisplay = `<button onclick="claimAchievementReward('${achievement.id}')" style="padding: 6px 12px; background: linear-gradient(135deg, #ffd700, #ffed4a); color: #333; border: none; border-radius: 6px; font-weight: 700; cursor: pointer; font-size: 0.8rem;">ğŸ’° 25ì½”ì¸ ë°›ê¸°</button>`;
                    } else if (isCompleted && isRewardClaimed) {
                        rewardDisplay = '<span style="color: #27ae60; font-size: 0.8rem; font-weight: 600;">âœ“ ìˆ˜ë ¹ì™„ë£Œ</span>';
                    }
                    
                    return `
                        <div style="padding: 16px; background: ${isCompleted ? 'linear-gradient(135deg, rgba(255,215,0,0.15), rgba(255,215,0,0.05))' : 'var(--bg)'}; border-radius: 8px; border: 2px solid ${isCompleted ? '#ffd700' : hasBookPurchased ? '#e74c3c' : 'var(--border)'};">
                            <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 8px;">
                                <span style="font-size: 1.8rem; ${isCompleted ? '' : 'filter: grayscale(100%); opacity: 0.5;'}">${achievement.icon}</span>
                                <div style="flex: 1;">
                                    <div style="font-weight: 700; color: ${isCompleted ? '#ffd700' : '#888'}; font-size: 1.05rem;">${achievement.title}</div>
                                    <div style="font-size: 0.85rem; color: #888;">${achievement.desc}</div>
                                </div>
                                ${isCompleted ? '<span style="color: #ffd700; font-size: 1.2rem;">âœ“</span>' : ''}
                            </div>
                            <div style="background: var(--border); height: 6px; border-radius: 3px; overflow: hidden;">
                                <div style="width: ${progressPercent}%; height: 100%; background: ${isCompleted ? 'linear-gradient(90deg, #ffd700, #ffed4a)' : '#27ae60'}; transition: width 0.3s;"></div>
                            </div>
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 6px; font-size: 0.8rem; color: #888;">
                                <span>ì§ì ‘ ë°œê²¬: ${progress} / ${achievement.requirement}ê°œ</span>
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    ${completedDate ? `<span>ë‹¬ì„±: ${completedDate}</span>` : ''}
                                    ${rewardDisplay}
                                </div>
                            </div>
                            ${warningMsg}
                        </div>
                    `;
                }).join('');
            }
        }
        
        // ì—…ì  ë³´ìƒ ìˆ˜ë ¹ í•¨ìˆ˜
        function claimAchievementReward(achievementId) {
            // ì´ë¯¸ ìˆ˜ë ¹í–ˆëŠ”ì§€ í™•ì¸
            if (claimedAchievementRewards.includes(achievementId)) {
                showNotification('ì´ë¯¸ ë³´ìƒì„ ìˆ˜ë ¹í–ˆìŠµë‹ˆë‹¤.');
                return;
            }
            
            // ë‹¬ì„±í–ˆëŠ”ì§€ í™•ì¸
            if (!achievements[achievementId]) {
                showNotification('ì•„ì§ ë‹¬ì„±í•˜ì§€ ì•Šì€ ì—…ì ì…ë‹ˆë‹¤.');
                return;
            }
            
            // ë³´ìƒ ì§€ê¸‰
            coins += 25;
            claimedAchievementRewards.push(achievementId);
            
            // ì—…ì  ì •ë³´ ê°€ì ¸ì˜¤ê¸°
            const achievement = ACHIEVEMENTS[achievementId];
            const achievementTitle = achievement ? achievement.title : 'ì—…ì ';
            
            saveGame();
            renderJournal();
            updateCoinDisplay();
            
            showNotification(`ğŸ‰ "${achievementTitle}" ë³´ìƒ 25ì½”ì¸ì„ ë°›ì•˜ìŠµë‹ˆë‹¤!`);
        }

        function createNewSpirit() {
            if (spirits.length >= 6) {
                showNotification('ì •ì›ì´ ê°€ë“ ì°¼ìŠµë‹ˆë‹¤ (ìµœëŒ€ 6ë§ˆë¦¬)');
                return;
            }

            totalEggsCreated++;
            const eggName = `${totalEggsCreated}í˜¸`;

            const spirit = {
                id: Date.now(),
                name: eggName,
                growth: 0,
                // ê³µê°œ ìŠ¤íƒ¯
                parameters: {
                    intelligence: 0,  // ì§€ë ¥
                    strength: 0,      // ì²´ë ¥
                    charm: 0,         // ë§¤ë ¥
                    affection: 0      // ì• ì •
                },
                // ìˆ¨ê²¨ì§„ ì†ì„± (ì§„í™” ê²°ì •)
                hiddenAttributes: {
                    fire: 0,
                    water: 0,
                    wind: 0,
                    earth: 0,
                    light: 0,
                    dark: 0
                },
                satisfaction: 'mid',  // ë§Œì¡±ë„: 'high', 'mid', 'low'
                lastFed: null,
                lastMusic: null,
                lastPat: null,
                lastDecorate: null,
                lastInteraction: Date.now(),  // ë§ˆì§€ë§‰ ìƒí˜¸ì‘ìš© ì‹œê°„
                status: 'ë°°ê³ íŒŒ ë³´ì…ë‹ˆë‹¤...',
                birthTime: Date.now(),
                logs: [],  // ì¼ì§€
                lightTime: 0,  // ë¹› ëª¨ë“œ ëˆ„ì  ì‹œê°„ (ì´ˆ)
                darkTime: 0,   // ì–´ë‘  ëª¨ë“œ ëˆ„ì  ì‹œê°„ (ì´ˆ)
                musicListened: 0,  // ìŒì•… ì²­ì·¨ íšŸìˆ˜
                feedCount: 0,      // ë¨¹ì´ íšŸìˆ˜
                relationships: {},  // ë‹¤ë¥¸ ì •ë ¹ê³¼ì˜ ê´€ê³„ { spiritId: ìˆ˜ì¹˜(0~100) }
                bond: null  // ì˜êµ¬ ê´€ê³„ { type: 'bestfriend' | 'lover', partnerId: 'id' }
            };

            spirits.push(spirit);
            saveGame();
            renderSpirits();
            showNotification(`${eggName}ì´(ê°€) íƒœì–´ë‚¬ìŠµë‹ˆë‹¤! ğŸ¥š`);
            
            // íŠœí† ë¦¬ì–¼ ì²´í¬
            checkTutorialAction('getEgg');
        }

        function changeName(spiritId) {
            currentSpiritId = spiritId;
            const spirit = spirits.find(s => s.id === spiritId);
            document.getElementById('nameInput').value = spirit.name;
            document.getElementById('nameModal').classList.add('active');
            
            // íŠœí† ë¦¬ì–¼: ì´ë¦„ í´ë¦­ ì•¡ì…˜ ì²´í¬
            checkTutorialAction('clickName');
        }
        
        // ì´ë¦„ í™•ì¸ í•¨ìˆ˜
        function confirmName() {
            const spirit = spirits.find(s => s.id === currentSpiritId);
            if (!spirit) return;
            
            const newName = document.getElementById('nameInput').value.trim();
            if (!newName) {
                showNotification('ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”');
                return;
            }
            spirit.name = newName;
            closeModal('nameModal');
            saveGame();
            updateSpiritCard(spirit);
            showNotification('ì´ë¦„ì„ ë³€ê²½í–ˆìŠµë‹ˆë‹¤');
            
            // íŠœí† ë¦¬ì–¼: ì´ë¦„ ë³€ê²½ ì™„ë£Œ ì•¡ì…˜ ì²´í¬
            checkTutorialAction('rename');
        }

        // ì •ë ¹ì˜ ì£¼ìš” ì†ì„± ì°¾ê¸°
        function getDominantAttribute(spirit) {
            if (!spirit.hiddenAttributes) {
                return 'normal';
            }
            
            let maxAttr = 'normal';
            let maxValue = 0;
            
            // ë¨¹ì´ ì†ì„± + í…Œë¼ë¦¬ì›€ ì†ì„± í•©ì‚°
            for (let attr in spirit.hiddenAttributes) {
                const totalValue = spirit.hiddenAttributes[attr] + (terrarium[attr] || 0);
                if (totalValue > maxValue) {
                    maxValue = totalValue;
                    maxAttr = attr;
                }
            }
            
            // ìµœê³  ì†ì„±ê°’ì´ 10 ë¯¸ë§Œì´ë©´ normal (ì™¸ê²¬ ì„¤ëª…ê³¼ ë™ì¼ ê¸°ì¤€)
            if (maxValue < 10) {
                return 'normal';
            }
            
            return maxAttr;
        }

                function getStage(growth) {
            if (growth >= STAGE_REQUIREMENTS.adult) return 'adult';
            if (growth >= STAGE_REQUIREMENTS.pupa) return 'pupa';
            if (growth >= STAGE_REQUIREMENTS.larva3) return 'larva3';
            if (growth >= STAGE_REQUIREMENTS.larva2) return 'larva2';
            if (growth >= STAGE_REQUIREMENTS.larva1) return 'larva1';
            return 'egg';
        }
        
        // í˜„ì¬ ì†ì„±ì— ë”°ë¥¸ ì™¸í˜• ë¬˜ì‚¬ ê°€ì ¸ì˜¤ê¸°
        function getAppearanceDescription(spirit) {
            const stage = getStage(spirit.growth);
            
            // ì„±ì¶©ì´ë©´ ì™¸í˜• ë¬˜ì‚¬ ì—†ìŒ
            if (stage === 'adult') return null;
            
            // ì´ë²¤íŠ¸ ì •ë ¹ ì™¸í˜• ë¬˜ì‚¬
            if (spirit.isEventSpirit && spirit.eventType) {
                const eventAppearances = {
                    christmas2025: {
                        normal: {
                            egg: 'ë¹¨ê°„ìƒ‰ê³¼ ì´ˆë¡ìƒ‰ ì¤„ë¬´ëŠ¬ì˜ ì•Œë¡ë‹¬ë¡í•œ ì•Œì…ë‹ˆë‹¤.',
                            larva1: 'ì´ˆë¡ìƒ‰ ëª¸ì— ë¹¨ê°„ìƒ‰ ì  ë¬´ëŠ¬ê°€ ìˆìŠµë‹ˆë‹¤.',
                            larva2: 'ì´ˆë¡ìƒ‰ ëª¸ì— ë¹¨ê°„ìƒ‰ ì  ë¬´ëŠ¬ê°€ ìˆìœ¼ë©° ë¨¸ë¦¬ ìœ„ì— ë³„ëª¨ì–‘ ë”ë“¬ì´ê°€ ìˆìŠµë‹ˆë‹¤.',
                            larva3: 'ì´ˆë¡ìƒ‰ ëª¸ì— ë¹¨ê°„ìƒ‰ ì  ë¬´ëŠ¬ê°€ ìˆìœ¼ë©° ë¨¸ë¦¬ ìœ„ì˜ ë³„ëª¨ì–‘ ë”ë“¬ì´ê°€ ë°˜ì§ì´ê³  ìˆìŠµë‹ˆë‹¤.',
                            pupa: 'ë°˜ì§ì´ëŠ” ê¸ˆìƒ‰ ì‹¤ë¡œ ê°ì‹¸ì§„ ë²ˆë°ê¸°ì…ë‹ˆë‹¤. ì•ˆì—ì„œ ë¶‰ì€ ë¹›ì´ ìƒˆì–´ë‚˜ì˜µë‹ˆë‹¤.'
                        },
                        shiny: {
                            egg: 'ì€ì€í•œ íŒŒë€ë¹›ì´ ê°ë„ëŠ” í•˜ì–€ ì•Œì…ë‹ˆë‹¤. ì°¨ê°€ìš´ ê¸°ìš´ì´ ëŠê»´ì§‘ë‹ˆë‹¤.',
                            larva1: 'ì—°í•œ íŒŒë€ìƒ‰ ëª¸ì— ì€ìƒ‰ ì  ë¬´ëŠ¬ê°€ ìˆìŠµë‹ˆë‹¤.',
                            larva2: 'ì—°í•œ íŒŒë€ìƒ‰ ëª¸ì— ì€ìƒ‰ ì  ë¬´ëŠ¬ê°€ ìˆìœ¼ë©° ë¨¸ë¦¬ ìœ„ì— ëˆˆê½ƒ ëª¨ì–‘ ë”ë“¬ì´ê°€ ìˆìŠµë‹ˆë‹¤.',
                            larva3: 'ì—°í•œ íŒŒë€ìƒ‰ ëª¸ì— ì€ìƒ‰ ì  ë¬´ëŠ¬ê°€ ìˆìœ¼ë©° ë¨¸ë¦¬ ìœ„ì˜ ëˆˆê½ƒ ë”ë“¬ì´ì—ì„œ ëˆˆì´ í©ë‚ ë¦½ë‹ˆë‹¤.',
                            pupa: 'ë°˜ì§ì´ëŠ” ì€ìƒ‰ ì‹¤ë¡œ ê°ì‹¸ì§„ ë²ˆë°ê¸°ì…ë‹ˆë‹¤. ì•ˆì—ì„œ í‘¸ë¥¸ ë¹›ì´ ìƒˆì–´ë‚˜ì˜µë‹ˆë‹¤.'
                        }
                    }
                };
                
                const eventDesc = eventAppearances[spirit.eventType];
                if (eventDesc) {
                    const variant = spirit.isShiny ? 'shiny' : 'normal';
                    if (eventDesc[variant] && eventDesc[variant][stage]) {
                        return eventDesc[variant][stage];
                    }
                }
            }
            
            // ì•Œ ~ ë²ˆë°ê¸°ë§Œ ì™¸í˜• ë¬˜ì‚¬ ìˆìŒ
            if (!APPEARANCE_DESCRIPTIONS[stage]) return null;
            
            // í˜„ì¬ ì†ì„± ê³„ì‚° (ë¨¹ì´ + í…Œë¼ë¦¬ì›€, ìµœëŒ€ 500)
            const foodAttrs = spirit.hiddenAttributes || { fire: 0, water: 0, wind: 0, earth: 0, light: 0, dark: 0 };
            const finalAttrs = {};
            for (let attr in foodAttrs) {
                finalAttrs[attr] = Math.min(500, foodAttrs[attr] + (terrarium[attr] || 0));
            }
            
            // ì†ì„±ì„ ë‚´ë¦¼ì°¨ìˆœìœ¼ë¡œ ì •ë ¬
            const sortedAttrs = Object.entries(finalAttrs)
                .sort((a, b) => b[1] - a[1]);
            
            const firstAttr = sortedAttrs[0][0];
            const firstValue = sortedAttrs[0][1];
            const secondAttr = sortedAttrs[1][0];
            const secondValue = sortedAttrs[1][1];
            
            // ì†ì„±ì´ 10 ë¯¸ë§Œì´ë©´ normal
            if (firstValue < 10) {
                return APPEARANCE_DESCRIPTIONS[stage]['normal'] || 'í‰ë²”í•œ ëª¨ìŠµì…ë‹ˆë‹¤.';
            }
            
            // 2ê°œ ì†ì„±ì´ ë¹„ìŠ·í•œì§€ í™•ì¸ (ì°¨ì´ê°€ 30% ì´í•˜)
            // larva2, larva3, pupaë§Œ í˜¼í•© ì™¸í˜• ìˆìŒ
            if ((stage === 'larva2' || stage === 'larva3' || stage === 'pupa') && secondValue >= 10) {
                const diffPercent = ((firstValue - secondValue) / firstValue) * 100;
                
                if (diffPercent <= 30) {
                    // í˜¼í•© ì†ì„±!
                    const comboKey = [firstAttr, secondAttr].sort().join('-');
                    const mixedDesc = APPEARANCE_DESCRIPTIONS[stage][comboKey];
                    
                    if (mixedDesc) {
                        return mixedDesc;
                    }
                }
            }
            
            // ë‹¨ì¼ ì†ì„±
            return APPEARANCE_DESCRIPTIONS[stage][firstAttr] || 'í‰ë²”í•œ ëª¨ìŠµì…ë‹ˆë‹¤.';
        }
        
        // í’ˆì§ˆ ë“±ê¸‰ì„ ì ìˆ˜ë¡œ ë³€í™˜
        function getQualityScore(quality) {
            const qualityScores = {
                'common': 1,     // ë‚®ìŒ
                'rare': 3,       // ë³´í†µ
                'epic': 5,       // ë†’ìŒ
                'legendary': 7   // ì „ì„¤
            };
            return qualityScores[quality] || 1;
        }
        
        // í…Œë¼ë¦¬ì›€ í’ˆì§ˆ í•©ê³„ ê³„ì‚°
        function calculateTerrariumQuality() {
            if (installedDecorations.length === 0) return 0;
            
            let totalQuality = 0;
            
            installedDecorations.forEach(deco => {
                // ë¬¸ìì—´ ë˜ëŠ” ê°ì²´ ëª¨ë‘ ì§€ì›
                const key = typeof deco === 'string' ? deco : deco.type;
                const decoData = DECORATION_TYPES[key];
                const eventItem = EVENT_ITEMS[key];
                const synthItem = SYNTH_ITEMS[key];
                
                if (decoData) {
                    totalQuality += getQualityScore(decoData.quality);
                } else if (eventItem && eventItem.quality) {
                    totalQuality += getQualityScore(eventItem.quality);
                } else if (synthItem) {
                    totalQuality += 6; // í•©ì„± ë¯¸ë‹ˆì–´ì²˜ì€ ìµœìƒê¸‰(5)ê³¼ ì „ì„¤(7) ì‚¬ì´
                }
            });
            
            return totalQuality;
        }
        
        // ì •ë ¹ë³„ ë¶ˆë§Œ ìƒíƒœ ì§€ì† ì‹œê°„ ì²´í¬ ë° ì—…ë°ì´íŠ¸
        function updateLowSatisfactionTimer() {
            spirits.forEach(spirit => {
                if (spirit.isDead || spirit.isCompleted) return;
                
                const satisfaction = calculateSatisfaction(spirit);
                
                if (satisfaction === 'low') {
                    // ë¶ˆë§Œ ìƒíƒœì¸ë° íƒ€ì´ë¨¸ê°€ ì—†ìœ¼ë©´ ì‹œì‘
                    if (!lowSatisfactionStartTime[spirit.id]) {
                        lowSatisfactionStartTime[spirit.id] = Date.now();
                    }
                } else {
                    // ë¶ˆë§Œ ìƒíƒœê°€ ì•„ë‹ˆë©´ íƒ€ì´ë¨¸ ë¦¬ì…‹
                    delete lowSatisfactionStartTime[spirit.id];
                }
            });
        }
        
        // ì •ë ¹ì´ ìƒí˜¸ì‘ìš©ì„ ê±°ë¶€í•˜ëŠ” ìƒíƒœì¸ì§€ í™•ì¸ (ë¶ˆë§Œ ìƒíƒœê°€ 10ë¶„ ì´ìƒ ì§€ì†)
        function isSpiritRefusing(spiritId) {
            const startTime = lowSatisfactionStartTime[spiritId];
            if (!startTime) return false;
            const elapsed = Date.now() - startTime;
            return elapsed >= 10 * 60 * 1000; // 10ë¶„
        }
        
        // ê±°ë¶€ ëŒ€ì‚¬ ë°˜í™˜
        function getRefusalMessage(spiritName, action) {
            const messages = {
                feed: [
                    `${spiritName}ì´(ê°€) ê³ ê°œë¥¼ ëŒë¦½ë‹ˆë‹¤. í™˜ê²½ì´ ë§ˆìŒì— ì•ˆ ë“œëŠ” ê²ƒ ê°™ìŠµë‹ˆë‹¤.`,
                    `${spiritName}ì´(ê°€) ë¨¹ì´ë¥¼ ê±°ë¶€í•©ë‹ˆë‹¤. ê¸°ë¶„ì´ ì•ˆ ì¢‹ì•„ ë³´ì…ë‹ˆë‹¤.`,
                    `${spiritName}ì´(ê°€) ìŠ¬í”ˆ ëˆˆìœ¼ë¡œ ì³ë‹¤ë´…ë‹ˆë‹¤. ë¶ˆë§Œì´ ìŒ“ì¸ ê²ƒ ê°™ìŠµë‹ˆë‹¤.`,
                    `${spiritName}ì´(ê°€) ì…ì„ ê¾¹ ë‹¤ë­…ë‹ˆë‹¤. ë¬´ì–¸ê°€ ë¶ˆí¸í•œ ê²ƒ ê°™ìŠµë‹ˆë‹¤.`,
                    `${spiritName}ì´(ê°€) ë¬´ê¸°ë ¥í•˜ê²Œ ìˆìŠµë‹ˆë‹¤. í˜ì´ ì—†ì–´ ë³´ì…ë‹ˆë‹¤.`
                ],
                pet: [
                    `${spiritName}ì´(ê°€) ì†ê¸¸ì„ í”¼í•©ë‹ˆë‹¤. í™˜ê²½ì´ ë§ˆìŒì— ì•ˆ ë“œëŠ” ê²ƒ ê°™ìŠµë‹ˆë‹¤.`,
                    `${spiritName}ì´(ê°€) ì“°ë‹¤ë“¬ê¸°ë¥¼ ê±°ë¶€í•©ë‹ˆë‹¤. ê¸°ë¶„ì´ ì•ˆ ì¢‹ì•„ ë³´ì…ë‹ˆë‹¤.`,
                    `${spiritName}ì´(ê°€) ëª¸ì„ ì›…í¬ë¦½ë‹ˆë‹¤. ë¶ˆë§Œì´ ìŒ“ì¸ ê²ƒ ê°™ìŠµë‹ˆë‹¤.`,
                    `${spiritName}ì´(ê°€) ê³ ê°œë¥¼ ì €ìŠµë‹ˆë‹¤. ë¬´ì–¸ê°€ ë¶ˆí¸í•œ ê²ƒ ê°™ìŠµë‹ˆë‹¤.`,
                    `${spiritName}ì´(ê°€) ì‚ì§„ ë“¯ ë“±ì„ ëŒë¦½ë‹ˆë‹¤. í† ë¼ì§„ ê²ƒ ê°™ìŠµë‹ˆë‹¤.`
                ]
            };
            const list = messages[action] || messages.feed;
            return list[Math.floor(Math.random() * list.length)];
        }
        
        // ë§Œì¡±ë„ ê³„ì‚° í•¨ìˆ˜
        function calculateSatisfaction(spirit) {
            const stage = getStage(spirit.growth);
            
            // ì£½ì—ˆê±°ë‚˜ ì™„ì„±ëœ ì •ë ¹ì€ ë§Œì¡±ë„ ê³„ì‚° ì•ˆ í•¨
            if (spirit.isDead || spirit.isCompleted) return spirit.satisfaction || 'mid';
            
            // ë¯¸ë‹ˆì–´ì²˜ê°€ ì—†ìœ¼ë©´ ë‚®ìŒ
            if (installedDecorations.length === 0) return 'low';
            
            // í…Œë¼ë¦¬ì›€ í’ˆì§ˆ í•©ê³„
            const totalQuality = calculateTerrariumQuality();
            
            // ì„±ì¥ ë‹¨ê³„ë³„ í’ˆì§ˆ í•©ê³„ ìš”êµ¬ì¹˜
            // í’ˆì§ˆ ì ìˆ˜: ì¼ë°˜=1, í¬ê·€=3, ìµœìƒê¸‰=5, í•©ì„±=6, ì „ì„¤=7
            // ì•Œ/ì• ë²Œë ˆ1: ì¼ë°˜ 3ê°œ(3) ~ í¬ê·€ 3ê°œ(9) ìˆ˜ì¤€
            // ì• ë²Œë ˆ2: í¬ê·€ 3ê°œ(9) ~ ìµœìƒê¸‰ 3ê°œ(15) ìˆ˜ì¤€
            // ì• ë²Œë ˆ3: ìµœìƒê¸‰ 3ê°œ(15) ~ ì „ì„¤ 3ê°œ(21) ìˆ˜ì¤€
            // ë²ˆë°ê¸°: ì „ì„¤ 3ê°œ(21) ~ ì „ì„¤ 5ê°œ(35) ìˆ˜ì¤€
            let qualityThresholdMid, qualityThresholdHigh;
            
            if (stage === 'egg' || stage === 'larva1') {
                qualityThresholdMid = 3;   // ì¼ë°˜ 3ê°œ
                qualityThresholdHigh = 9;  // í¬ê·€ 3ê°œ
            } else if (stage === 'larva2') {
                qualityThresholdMid = 9;   // í¬ê·€ 3ê°œ
                qualityThresholdHigh = 15; // ìµœìƒê¸‰ 3ê°œ
            } else if (stage === 'larva3') {
                qualityThresholdMid = 15;  // ìµœìƒê¸‰ 3ê°œ
                qualityThresholdHigh = 21; // ì „ì„¤ 3ê°œ
            } else { // pupa
                qualityThresholdMid = 21;  // ì „ì„¤ 3ê°œ
                qualityThresholdHigh = 35; // ì „ì„¤ 5ê°œ
            }
            
            // ì•Œ ~ ì• ë²Œë ˆ1: í’ˆì§ˆ í•©ê³„ë§Œ í™•ì¸
            if (stage === 'egg' || stage === 'larva1') {
                if (totalQuality >= qualityThresholdHigh) return 'high';
                else if (totalQuality >= qualityThresholdMid) return 'mid';
                else return 'low';
            }
            // ì• ë²Œë ˆ2, ì• ë²Œë ˆ3, ë²ˆë°ê¸°: í’ˆì§ˆ í•©ê³„ + ì†ì„± ìœ ì‚¬ë„
            else {
                // ì •ë ¹ì˜ í˜„ì¬ ì†ì„± ê³„ì‚° (ë¨¹ì´ + í…Œë¼ë¦¬ì›€, ìµœëŒ€ 500)
                const foodAttrs = spirit.hiddenAttributes || { fire: 0, water: 0, wind: 0, earth: 0, light: 0, dark: 0 };
                const spiritAttrs = {};
                for (let attr in foodAttrs) {
                    spiritAttrs[attr] = Math.min(500, foodAttrs[attr] + (terrarium[attr] || 0));
                }
                
                // ì •ë ¹ì˜ ì£¼ ì†ì„± ì°¾ê¸° (ê°€ì¥ ë†’ì€ ì†ì„±)
                let maxAttr = null;
                let maxValue = 0;
                for (let attr in spiritAttrs) {
                    if (spiritAttrs[attr] > maxValue) {
                        maxValue = spiritAttrs[attr];
                        maxAttr = attr;
                    }
                }
                
                // ì†ì„±ì´ 10 ë¯¸ë§Œì´ë©´ ì†ì„±ì´ ëª…í™•í•˜ì§€ ì•ŠìŒ â†’ í’ˆì§ˆë§Œìœ¼ë¡œ íŒë‹¨
                if (maxValue < 10) {
                    if (totalQuality >= qualityThresholdHigh) return 'high';
                    else if (totalQuality >= qualityThresholdMid) return 'mid';
                    else return 'low';
                }
                
                // í…Œë¼ë¦¬ì›€ì˜ ìƒìœ„ 2ê°œ ì†ì„±
                const topTerrariumAttrs = Object.entries(terrarium)
                    .sort((a, b) => b[1] - a[1])
                    .slice(0, 2)
                    .map(([attr]) => attr);
                
                if (topTerrariumAttrs.includes(maxAttr)) {
                    // ì†ì„± ì¼ì¹˜ ì‹œ ìš”êµ¬ì¹˜ ì™„í™”
                    if (totalQuality >= qualityThresholdMid) return 'high';
                    else if (totalQuality >= qualityThresholdMid * 0.7) return 'mid';
                    else return 'low';
                } else {
                    // ì†ì„± ë¶ˆì¼ì¹˜ ì‹œ ìš”êµ¬ì¹˜ ìƒí–¥
                    if (totalQuality >= qualityThresholdHigh) return 'mid';
                    else return 'low';
                }
            }
        }

        function getNextStageRequirement(growth) {
            const stage = getStage(growth);
            const stages = Object.keys(STAGE_REQUIREMENTS);
            const currentIndex = stages.indexOf(stage);
            if (currentIndex < stages.length - 1) {
                return STAGE_REQUIREMENTS[stages[currentIndex + 1]];
            }
            return STAGE_REQUIREMENTS.adult;
        }

        function canDoAction(spirit, action) {
            const now = Date.now();
            const cooldown = 10000; // 10ì´ˆ

            if (action === 'feed') {
                return !spirit.lastFeed || (now - spirit.lastFeed > cooldown);
            }
            if (action === 'music') {
                return !spirit.lastMusic || (now - spirit.lastMusic > cooldown);
            }
            if (action === 'pat') {
                return !spirit.lastPat || (now - spirit.lastPat > cooldown);
            }
            if (action === 'decorate') {
                return !spirit.lastDecorate || (now - spirit.lastDecorate > cooldown);
            }
            return false;
        }

        // ì»¤ìŠ¤í…€ í™•ì¸ ì°½ í‘œì‹œ
        function showConfirm(title, message, onConfirm, confirmText = 'í™•ì¸', cancelText = 'ì·¨ì†Œ', onCancel = null) {
            return new Promise((resolve) => {
                const modal = document.getElementById('confirmModal');
                const titleEl = document.getElementById('confirmTitle');
                const messageEl = document.getElementById('confirmMessage');
                const okBtn = document.getElementById('confirmOkBtn');
                const cancelBtn = document.getElementById('confirmCancelBtn');
                
                titleEl.textContent = title;
                messageEl.textContent = message;
                
                // ë²„íŠ¼ í…ìŠ¤íŠ¸ ì„¤ì •
                okBtn.textContent = confirmText;
                cancelBtn.textContent = cancelText;
                
                // ë™ì  z-index ì ìš©
                modal.style.zIndex = getNextZIndex();
                modal.classList.add('active');
                
                // ì´ì „ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì œê±°
                const newOkBtn = okBtn.cloneNode(true);
                const newCancelBtn = cancelBtn.cloneNode(true);
                newOkBtn.textContent = confirmText;
                newCancelBtn.textContent = cancelText;
                okBtn.parentNode.replaceChild(newOkBtn, okBtn);
                cancelBtn.parentNode.replaceChild(newCancelBtn, cancelBtn);
                
                // í™•ì¸ ë²„íŠ¼
                document.getElementById('confirmOkBtn').onclick = () => {
                    modal.classList.remove('active');
                    if (onConfirm) onConfirm();
                    resolve(true);
                };
                
                // ì·¨ì†Œ ë²„íŠ¼
                document.getElementById('confirmCancelBtn').onclick = () => {
                    modal.classList.remove('active');
                    if (onCancel) onCancel();
                    resolve(false);
                };
            });
        }

        function openFeedModal(spiritId) {
            const spirit = spirits.find(s => s.id === spiritId);
            if (!canDoAction(spirit, 'feed')) {
                showNotification('ì•„ì§ ë°°ê°€ ë¶€ë¦…ë‹ˆë‹¤');
                return;
            }
            if (!inventory.food) inventory.food = [];
            if (inventory.food.length === 0) {
                showNotification('ë¨¹ì´ê°€ ì—†ìŠµë‹ˆë‹¤. ì±„ì§‘ì„ í•´ë³´ì„¸ìš”!');
                return;
            }
            currentSpiritId = spiritId;
            renderFeedOptions();
            document.getElementById('feedModal').classList.add('active');
        }

        function renderFeedOptions() {
            if (!inventory.food) inventory.food = [];
            
            const modal = document.getElementById('feedModal');
            const spirit = spirits.find(s => s.id === currentSpiritId);
            
            const foodCounts = {};
            inventory.food.forEach(f => {
                foodCounts[f] = (foodCounts[f] || 0) + 1;
            });
            
            // medicineì„ foodCountsì—ì„œ ë¶„ë¦¬
            const medicineCount = foodCounts['medicine'] || 0;
            delete foodCounts['medicine'];
            
            let medicineSection = '';
            if (spirit && spirit.isSick && medicineCount > 0) {
                medicineSection = `
                    <button class="option-btn" onclick="giveMedicineFromModal(${currentSpiritId})">
                        <span class="option-icon">ğŸŒ¿</span>
                        <div class="option-info">
                            <div class="option-name">${MEDICINE.name} Ã—${medicineCount}</div>
                            <div class="option-effect">ë³‘ì„ ì™„ì „íˆ ì¹˜ë£Œí•©ë‹ˆë‹¤</div>
                        </div>
                    </button>
                `;
            } else if (spirit && spirit.isSick) {
                medicineSection = `
                    <div style="margin-bottom: 10px; padding: 10px; background: var(--card); border: 1px solid var(--border);">
                        <div style="font-size: 0.9rem; color: #666;">ì •ë ¹ì´ ì•„í”•ë‹ˆë‹¤! ì•½ì´ˆê°€ í•„ìš”í•©ë‹ˆë‹¤.</div>
                    </div>
                `;
            }
            
            // ì´ë²¤íŠ¸ ë¨¹ì´ì™€ ì¼ë°˜ ë¨¹ì´ ë¶„ë¦¬ (ê³ ì • ìˆœì„œ)
            const FOOD_ORDER = ['fire', 'water', 'wind', 'earth', 'light', 'dark'];
            const eventFoods = [];
            const normalFoods = [];
            const synthFoods = [];
            const legendaryMaterials = []; // ì „ì„¤ í•©ì„± ì¬ë£Œ (ë‹¬ì¹˜ì¦ˆ, í™©ê¸ˆì‚¬ê³¼)
            const etcFoods = []; // ê¸°íƒ€ ë¨¹ì´ (ìˆ˜ì„ í™” ê½ƒì, ì•„ì¹´ì‹œì•„ ê¿€)
            const ETC_FOOD_TYPES = ['reconciliation_flower', 'acacia_honey'];
            const LEGENDARY_MATERIAL_TYPES = ['moon_cheese', 'golden_apple'];
            
            // ê³ ì •ëœ ìˆœì„œëŒ€ë¡œ ì •ë ¬
            FOOD_ORDER.forEach(type => {
                if (foodCounts[type]) {
                    normalFoods.push([type, foodCounts[type]]);
                }
            });
            
            // ì´ë²¤íŠ¸ ë¨¹ì´ (ì´ë²¤íŠ¸ ì•„ì´í…œ í‚¤ ìˆœì„œëŒ€ë¡œ)
            Object.keys(EVENT_ITEMS).forEach(type => {
                if (foodCounts[type] && EVENT_ITEMS[type].type === 'food') {
                    eventFoods.push([type, foodCounts[type]]);
                }
            });
            
            // í•©ì„± ë¨¹ì´ (ìˆ˜ì„ í™” ê½ƒì, ì•„ì¹´ì‹œì•„ ê¿€, ì „ì„¤ ì¬ë£Œ ì œì™¸)
            Object.keys(SYNTH_ITEMS).forEach(type => {
                if (foodCounts[type] && SYNTH_ITEMS[type].type === 'food') {
                    if (ETC_FOOD_TYPES.includes(type)) {
                        etcFoods.push([type, foodCounts[type]]);
                    } else if (LEGENDARY_MATERIAL_TYPES.includes(type)) {
                        legendaryMaterials.push([type, foodCounts[type]]);
                    } else {
                        synthFoods.push([type, foodCounts[type]]);
                    }
                }
            });

            const content = `
                <div class="modal-title">ë¬´ì—‡ì„ ë¨¹ì¼ê¹Œìš”?</div>
                ${eventFoods.length > 0 ? `
                    <div style="font-weight: 600; margin-bottom: 10px; color: #c41e3a;">ğŸ„ ì´ë²¤íŠ¸ ë¨¹ì´</div>
                    <div class="food-grid" style="margin-bottom: 15px;">
                        ${eventFoods.map(([type, count]) => {
                            const item = EVENT_ITEMS[type];
                            return `
                                <button class="option-btn" style="border: 2px solid #c41e3a;" onclick="feedSpiritFromInventory(${currentSpiritId}, '${type}')">
                                    <span class="option-icon">${item.icon}</span>
                                    <div class="option-info">
                                        <div class="option-name">${item.name} Ã—${count}</div>
                                        <div class="option-effect" style="color: #c41e3a;">ëª¨ë“  ìŠ¤íƒ¯+5, ì„±ì¥+10</div>
                                    </div>
                                </button>
                            `;
                        }).join('')}
                    </div>
                ` : ''}
                ${synthFoods.length > 0 ? `
                    <div style="font-weight: 600; margin-bottom: 10px; color: #9b59b6;">ğŸ”¬ í•©ì„± ë¨¹ì´</div>
                    <div class="food-grid" style="margin-bottom: 15px;">
                        ${synthFoods.map(([type, count]) => {
                            const item = SYNTH_ITEMS[type];
                            let effectText;
                            if (item.attr === 'all') {
                                effectText = `ì „ì†ì„±+${item.attrGain}`;
                            } else if (item.attr === 'dual' && item.dualAttr) {
                                effectText = `${item.dualAttr.join('+')} ê°+${item.attrGain}`;
                            } else {
                                effectText = `${item.attr}+${item.attrGain}`;
                            }
                            return `
                                <button class="option-btn" style="border: 2px solid #9b59b6;" onclick="feedSpiritFromInventory(${currentSpiritId}, '${type}')">
                                    <span class="option-icon">${item.icon}</span>
                                    <div class="option-info">
                                        <div class="option-name">${item.name} Ã—${count}</div>
                                        <div class="option-effect" style="color: #9b59b6;">${effectText}, ì• ì •+${item.affectionGain}</div>
                                    </div>
                                </button>
                            `;
                        }).join('')}
                    </div>
                ` : ''}
                <div style="font-weight: 600; margin-bottom: 10px; color: var(--text);">ğŸ ë¨¹ì´</div>
                <div class="food-grid">
                    ${medicineSection}
                    ${normalFoods.map(([type, count]) => {
                        const isRare = type === 'light' || type === 'dark';
                        const gain = isRare ? 3 : 1;
                        const growth = 2;
                        return `
                            <button class="option-btn" onclick="feedSpiritFromInventory(${currentSpiritId}, '${type}')">
                                <span class="option-icon">${ENV_ICONS[type]}</span>
                                <div class="option-info">
                                    <div class="option-name">${FOOD_NAMES[type]} Ã—${count}</div>
                                    <div class="option-effect">${ENV_ICONS[type]}+${gain} ì„±ì¥+${growth}</div>
                                </div>
                            </button>
                        `;
                    }).join('')}
                </div>
                ${etcFoods.length > 0 ? `
                    <div style="font-weight: 600; margin: 15px 0 10px 0; color: var(--text);">ğŸ“¦ ê¸°íƒ€</div>
                    <div class="food-grid">
                        ${etcFoods.map(([type, count]) => {
                            const item = SYNTH_ITEMS[type];
                            let effectText = item.desc.split('.')[0]; // ì„¤ëª…ì˜ ì²« ë¬¸ì¥ë§Œ
                            return `
                                <button class="option-btn" onclick="feedSpiritFromInventory(${currentSpiritId}, '${type}')">
                                    <span class="option-icon">${item.icon}</span>
                                    <div class="option-info">
                                        <div class="option-name">${item.name} Ã—${count}</div>
                                        <div class="option-effect">${effectText}</div>
                                    </div>
                                </button>
                            `;
                        }).join('')}
                    </div>
                ` : ''}
                <button class="close-btn" onclick="closeModal('feedModal')">ë‹«ê¸°</button>
            `;
            modal.querySelector('.modal-content').innerHTML = content;
        }
        
        function giveMedicineFromModal(spiritId) {
            giveMedicine(spiritId);
            closeModal('feedModal');
        }

        function feedSpiritFromInventory(spiritId, foodType) {
            if (isPaused) {
                showNotification('ê²Œì„ì´ ì¼ì‹œì •ì§€ ìƒíƒœì…ë‹ˆë‹¤');
                return;
            }
            
            const spirit = spirits.find(s => s.id === spiritId);
            if (!spirit) return;
            
            // ë¶ˆë§Œ ìƒíƒœê°€ 10ë¶„ ì´ìƒ ì§€ì†ë˜ë©´ ê±°ë¶€
            if (isSpiritRefusing(spiritId)) {
                spirit.status = getRefusalMessage(spirit.name, 'feed');
                addLog(spirit, spirit.status);
                closeModal('feedModal');
                renderSpirits();
                showNotification('ğŸ˜¢ ì •ë ¹ì´ ë¨¹ì´ë¥¼ ê±°ë¶€í•©ë‹ˆë‹¤...');
                return;
            }

            if (!inventory.food) inventory.food = [];
            const foodIndex = inventory.food.indexOf(foodType);
            if (foodIndex === -1) {
                showNotification('ë¨¹ì´ê°€ ì—†ìŠµë‹ˆë‹¤');
                return;
            }

            // ì „ì„¤ ì¬ë£Œ(ë‹¬ì¹˜ì¦ˆ, í™©ê¸ˆì‚¬ê³¼)ëŠ” ë¨¹ì¼ ìˆ˜ ì—†ìŒ (í•©ì„± ì „ìš©)
            if (foodType === 'moon_cheese' || foodType === 'golden_apple') {
                const itemName = foodType === 'moon_cheese' ? 'ë‹¬ì¹˜ì¦ˆ' : 'í™©ê¸ˆì‚¬ê³¼';
                showNotification(`âŒ ${itemName}ì€(ëŠ”) í•©ì„± ì¬ë£Œë¡œë§Œ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤`);
                return;
            }

            // ì•„ì¹´ì‹œì•„ê¿€, ìˆ˜ì„ í™” ê½ƒìì€ ì•Œ/ë²ˆë°ê¸° ìƒíƒœì—ì„œ ì‚¬ìš© ë¶ˆê°€ (ì•„ì´í…œ ì†Œëª¨ ì „ì— ì²´í¬!)
            if (foodType === 'acacia_honey' || foodType === 'reconciliation_flower') {
                const stage = getStage(spirit.growth);
                if (stage === 'egg' || stage === 'pupa') {
                    const itemName = foodType === 'acacia_honey' ? 'ì•„ì¹´ì‹œì•„ ê¿€' : 'ìˆ˜ì„ í™” ê½ƒì';
                    const stageKorean = stage === 'egg' ? 'ì•Œ' : 'ë²ˆë°ê¸°';
                    showNotification(`âŒ ${stageKorean} ìƒíƒœì—ì„œëŠ” ${itemName} ì‚¬ìš©ì´ ë¶ˆê°€ëŠ¥í•©ë‹ˆë‹¤`);
                    return;
                }
            }

            // ìˆ˜ì„ í™” ê½ƒìì€ ì•™ìˆ™ ê´€ê³„ê°€ ìˆëŠ” ì •ë ¹ì—ê²Œë§Œ ì‚¬ìš© ê°€ëŠ¥ (ì•„ì´í…œ ì†Œëª¨ ì „ì— ì²´í¬!)
            if (foodType === 'reconciliation_flower') {
                const hasRival = spirit.relationships && Object.values(spirit.relationships).some(rel => rel < 0);
                if (!hasRival) {
                    showNotification('âŒ ì•™ìˆ™ ê´€ê³„ì¸ ì •ë ¹ì—ê²Œë§Œ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤');
                    return;
                }
            }

            // ë¨¹ì´ ì†Œëª¨
            inventory.food.splice(foodIndex, 1);

            // ì´ë²¤íŠ¸ ë¨¹ì´ ì²´í¬
            const eventItem = EVENT_ITEMS[foodType];
            if (eventItem && eventItem.type === 'food') {
                // ì´ë²¤íŠ¸ ë¨¹ì´ íš¨ê³¼ ì ìš©
                const effects = eventItem.effects;
                spirit.parameters.intelligence = Math.min(100, spirit.parameters.intelligence + (effects.intelligence || 0));
                spirit.parameters.strength = Math.min(100, spirit.parameters.strength + (effects.strength || 0));
                spirit.parameters.charm = Math.min(100, spirit.parameters.charm + (effects.charm || 0));
                // ì§ˆë³‘ ìƒíƒœê°€ ì•„ë‹ ë•Œë§Œ ì„±ì¥
                if (!spirit.isSick) {
                    spirit.growth += effects.growth || 0;
                }
                spirit.parameters.affection += 3;
                
                spirit.lastFeed = Date.now();
                spirit.lastFed = Date.now();
                spirit.lastInteraction = Date.now();
                spirit.status = 'íŠ¹ë³„í•œ ìŒì‹ì„ ë¨¹ì—ˆìŠµë‹ˆë‹¤!';
                
                if (!spirit.feedCount) spirit.feedCount = 0;
                spirit.feedCount += 1;
                
                addLog(spirit, `ğŸ„ ${eventItem.name}ì„(ë¥¼) ë¨¹ì—ˆìŠµë‹ˆë‹¤!`);
                addLog(spirit, 'ëª¨ë“  ëŠ¥ë ¥ì´ í¬ê²Œ ì˜¬ëìŠµë‹ˆë‹¤!');
                
                if (spirit.growth >= STAGE_REQUIREMENTS.adult && !spirit.isCompleted) {
                    completeSpirit(spirit);
                }
                
                closeModal('feedModal');
                saveGame();
                renderSpirits();
                renderInventory();
                showNotification(`${eventItem.icon} ${eventItem.name}ì„(ë¥¼) ì£¼ì—ˆìŠµë‹ˆë‹¤! (ëª¨ë“  ìŠ¤íƒ¯ +5, ì„±ì¥ +10)`);
                
                // íŠœí† ë¦¬ì–¼ ì²´í¬
                checkTutorialAction('feed');
                return;
            }
            
            // í•©ì„± ë¨¹ì´ ì²´í¬
            const synthItem = SYNTH_ITEMS[foodType];
            if (synthItem && synthItem.type === 'food') {
                // í•©ì„± ë¨¹ì´ íš¨ê³¼ ì ìš©
                if (!spirit.hiddenAttributes) {
                    spirit.hiddenAttributes = { fire: 0, water: 0, wind: 0, earth: 0, light: 0, dark: 0 };
                }
                
                // ì†ì„± ì¦ê°€
                if (synthItem.attr === 'all') {
                    // ì „ì²´ ì†ì„± ì¦ê°€
                    Object.keys(spirit.hiddenAttributes).forEach(attr => {
                        spirit.hiddenAttributes[attr] = Math.min(400, spirit.hiddenAttributes[attr] + synthItem.attrGain);
                    });
                } else if (synthItem.attr === 'dual' && synthItem.dualAttr) {
                    // í˜¼í•© ì†ì„± ì¦ê°€ (ë‘ ì†ì„± ëª¨ë‘)
                    synthItem.dualAttr.forEach(attr => {
                        spirit.hiddenAttributes[attr] = Math.min(400, spirit.hiddenAttributes[attr] + synthItem.attrGain);
                    });
                } else if (synthItem.attr === 'special') {
                    // íŠ¹ìˆ˜ ë¨¹ì´ (ì†ì„± ì¦ê°€ ì—†ìŒ)
                } else {
                    spirit.hiddenAttributes[synthItem.attr] = Math.min(400, spirit.hiddenAttributes[synthItem.attr] + synthItem.attrGain);
                }
                
                // ì• ì •ë„ ì¦ê°€
                spirit.parameters.affection += synthItem.affectionGain || 0;
                
                // ì§ˆë³‘ ìƒíƒœê°€ ì•„ë‹ ë•Œë§Œ ì„±ì¥ (ìŒìˆ˜ ì„±ì¥ë„ í—ˆìš©, ë‹¨ 0 ë¯¸ë§Œìœ¼ë¡œëŠ” ì•ˆ ë‚´ë ¤ê°)
                if (!spirit.isSick) {
                    spirit.growth = Math.max(0, spirit.growth + (synthItem.growthGain || 0));
                }
                
                spirit.lastFeed = Date.now();
                spirit.lastFed = Date.now();
                spirit.lastInteraction = Date.now();
                spirit.status = 'íŠ¹ë³„í•œ ìŒì‹ì„ ë¨¹ì—ˆìŠµë‹ˆë‹¤!';
                
                if (!spirit.feedCount) spirit.feedCount = 0;
                spirit.feedCount += 1;
                
                // ìˆ˜ì„ í™” ê½ƒì íŠ¹ìˆ˜ íš¨ê³¼ (ì•™ìˆ™ ì „ìš© - ì‹¸ì›€ ë°©ì§€)
                if (foodType === 'reconciliation_flower' && synthItem.effectDuration) {
                    spirit.reconciliationUntil = Date.now() + synthItem.effectDuration;
                    addLog(spirit, `${synthItem.icon} ${synthItem.name}ì„(ë¥¼) ë¨¹ì—ˆìŠµë‹ˆë‹¤!`);
                    addLog(spirit, `ğŸŒ¼ 30ë¶„ê°„ ë‹¤ë¥¸ ì •ë ¹ê³¼ ì‹¸ìš°ì§€ ì•ŠìŠµë‹ˆë‹¤!`);
                // ì•„ì¹´ì‹œì•„ ê¿€ íŠ¹ìˆ˜ íš¨ê³¼ (ì¹œë°€ë„ ì¦ê°€)
                } else if (foodType === 'acacia_honey' && synthItem.effectDuration) {
                    spirit.acaciaHoneyUntil = Date.now() + synthItem.effectDuration;
                    addLog(spirit, `${synthItem.icon} ${synthItem.name}ì„(ë¥¼) ë¨¹ì—ˆìŠµë‹ˆë‹¤!`);
                    addLog(spirit, `ğŸ¯ 30ë¶„ê°„ ë‹¤ë¥¸ ì •ë ¹ê³¼ ë¹ ë¥´ê²Œ ì¹œí•´ì§‘ë‹ˆë‹¤!`);
                } else {
                    addLog(spirit, `${synthItem.icon} ${synthItem.name}ì„(ë¥¼) ë¨¹ì—ˆìŠµë‹ˆë‹¤!`);
                }
                
                if (spirit.growth >= STAGE_REQUIREMENTS.adult && !spirit.isCompleted) {
                    completeSpirit(spirit);
                }
                
                closeModal('feedModal');
                saveGame();
                renderSpirits();
                renderInventory();
                
                let effectMsg;
                const isLegendaryMaterial = foodType === 'moon_cheese' || foodType === 'golden_apple';
                if (isLegendaryMaterial) {
                    effectMsg = 'íš¨ê³¼ ì—†ìŒ (í•©ì„± ì¬ë£Œ)';
                } else if (synthItem.attr === 'all') {
                    effectMsg = `ì „ì†ì„± +${synthItem.attrGain}`;
                } else if (synthItem.attr === 'dual' && synthItem.dualAttr) {
                    effectMsg = `${synthItem.dualAttr.join('+')} ê° +${synthItem.attrGain}`;
                } else if (synthItem.attr === 'special') {
                    if (foodType === 'reconciliation_flower') {
                        effectMsg = '30ë¶„ê°„ í™”í•´ íš¨ê³¼';
                    } else if (foodType === 'acacia_honey') {
                        effectMsg = '30ë¶„ê°„ ì¹œë°€ íš¨ê³¼';
                    } else {
                        effectMsg = 'íŠ¹ìˆ˜ íš¨ê³¼';
                    }
                } else {
                    effectMsg = `${synthItem.attr} +${synthItem.attrGain}`;
                }
                const growthText = (!isLegendaryMaterial && synthItem.growthGain) ? `, ì„±ì¥ ${synthItem.growthGain > 0 ? '+' : ''}${synthItem.growthGain}` : '';
                const affectionText = (!isLegendaryMaterial && synthItem.affectionGain) ? `, ì• ì •ë„ +${synthItem.affectionGain}` : '';
                showNotification(`${synthItem.icon} ${synthItem.name}ì„(ë¥¼) ì£¼ì—ˆìŠµë‹ˆë‹¤! (${effectMsg}${affectionText}${growthText})`);
                
                // íŠœí† ë¦¬ì–¼ ì²´í¬
                checkTutorialAction('feed');
                return;
            }

            const isRare = foodType === 'light' || foodType === 'dark';
            const attrGain = isRare ? 3 : 1;  // í¬ê·€ +3, ì¼ë°˜ +1
            const growthGain = 2;  // ëª¨ë‘ +2

            // ì •ë ¹ì˜ ìˆ¨ê²¨ì§„ ì†ì„± ì¦ê°€
            if (!spirit.hiddenAttributes) {
                spirit.hiddenAttributes = {
                    fire: 0, water: 0, wind: 0, earth: 0, light: 0, dark: 0
                };
            }
            spirit.hiddenAttributes[foodType] = Math.min(400, spirit.hiddenAttributes[foodType] + attrGain);

            // ì§ˆë³‘ ìƒíƒœê°€ ì•„ë‹ ë•Œë§Œ ì„±ì¥
            if (!spirit.isSick) {
                spirit.growth += growthGain;
            }
            spirit.lastFeed = Date.now();
            spirit.lastFed = Date.now();  // ë°°ê³ í”” ì²´í¬ìš©
            spirit.lastInteraction = Date.now();  // ìƒí˜¸ì‘ìš© ì‹œê°„ ì—…ë°ì´íŠ¸
            spirit.status = 'ë§›ìˆê²Œ ë¨¹ì—ˆìŠµë‹ˆë‹¤!';
            spirit.parameters.affection += 1;
            
            // ë¨¹ì´ íšŸìˆ˜ ì¦ê°€
            if (!spirit.feedCount) spirit.feedCount = 0;
            spirit.feedCount += 1;

            // ì¼ì§€ ì¶”ê°€
            addLog(spirit, `${FOOD_NAMES[foodType]}ë¥¼ ë¨¹ì—ˆìŠµë‹ˆë‹¤`);
            addLog(spirit, 'ë§›ìˆê²Œ ë¨¹ì—ˆìŠµë‹ˆë‹¤!');

            // ì„±ì¶© ì²´í¬ (100 ì´ìƒì´ë©´ ë¬´ì¡°ê±´ ì™„ë£Œ)
            if (spirit.growth >= STAGE_REQUIREMENTS.adult && !spirit.isCompleted) {
                completeSpirit(spirit);
            }

            closeModal('feedModal');
            saveGame();
            renderSpirits();  // ì „ì²´ ë Œë”ë§ìœ¼ë¡œ ì¿¨íƒ€ì„ í‘œì‹œ ì—…ë°ì´íŠ¸
            renderInventory();
            showNotification(`${ENV_ICONS[foodType]} ${FOOD_NAMES[foodType]} ì„(ë¥¼) ì£¼ì—ˆìŠµë‹ˆë‹¤`);
            
            // íŠœí† ë¦¬ì–¼ ì²´í¬
            checkTutorialAction('feed');
            
            // ì†ì„± ë¶ˆê· í˜• íŠœí† ë¦¬ì–¼ ì²´í¬
            checkImbalanceAndTutorial(spirit);
        }

        function openMusicModal(spiritId) {
            const spirit = spirits.find(s => s.id === spiritId);
            if (!canDoAction(spirit, 'music')) {
                showNotification('ì•„ì§ ìŒì•…ì„ ë“£ê³  ìˆìŠµë‹ˆë‹¤');
                return;
            }
            if (inventory.music.length === 0) {
                showNotification('ë³´ìœ í•œ ìŒì•…ì´ ì—†ìŠµë‹ˆë‹¤. ì±„ì§‘ì„ í•´ë³´ì„¸ìš”!');
                return;
            }
            currentSpiritId = spiritId;
            renderMusicOptions();
            document.getElementById('musicModal').classList.add('active');
        }

        function renderMusicOptions() {
            const container = document.getElementById('musicOptions');
            
            // ìŒì•… ê°œìˆ˜ ì„¸ê¸°
            const musicCounts = {};
            inventory.music.forEach(m => {
                musicCounts[m] = (musicCounts[m] || 0) + 1;
            });
            
            // ì´ë²¤íŠ¸ ìŒì•…ê³¼ ì¼ë°˜ ìŒì•… ë¶„ë¦¬ (í‹°ì–´ë³„ ì •ë ¬)
            const eventMusic = [];
            const tier1Music = []; // ê¸°ë³¸ ì•…ê¸°
            const tier2Music = []; // ì¥ë¥´
            const tier3Music = []; // í”„ë¦¬ë¯¸ì—„
            const tier4Music = []; // ì „ì„¤
            
            // MUSIC_TYPESì—ì„œ ëª¨ë“  ë ˆì½”ë“œ ë¶„ë¥˜
            Object.keys(MUSIC_TYPES).forEach(type => {
                if (musicCounts[type]) {
                    const musicData = MUSIC_TYPES[type];
                    if (musicData.tier === 1) {
                        tier1Music.push([type, musicCounts[type]]);
                    } else if (musicData.tier === 2) {
                        tier2Music.push([type, musicCounts[type]]);
                    } else if (musicData.tier === 3) {
                        tier3Music.push([type, musicCounts[type]]);
                    } else if (musicData.tier === 4) {
                        tier4Music.push([type, musicCounts[type]]);
                    }
                }
            });
            
            // ì´ë²¤íŠ¸ ìŒì•… (ì´ë²¤íŠ¸ ì•„ì´í…œ í‚¤ ìˆœì„œëŒ€ë¡œ)
            Object.keys(EVENT_ITEMS).forEach(type => {
                if (musicCounts[type] && EVENT_ITEMS[type].type === 'music') {
                    eventMusic.push([type, musicCounts[type]]);
                }
            });
            
            // ì´ë²¤íŠ¸ ìŒì•… HTML
            const eventMusicHTML = eventMusic.map(([type, count]) => {
                const item = EVENT_ITEMS[type];
                return `
                    <button class="option-btn" style="border: 2px solid #c41e3a;" onclick="playMusicByType('${type}')">
                        <span class="option-icon">${item.icon}</span>
                        <div class="option-info">
                            <div class="option-name">${item.name} Ã—${count}</div>
                            <div class="option-effect" style="color: #c41e3a;">ì• ì •ë„+10, ë§¤ë ¥+5</div>
                        </div>
                    </button>
                `;
            }).join('');
            
            // í‹°ì–´ë³„ ìŒì•… HTML ìƒì„± í•¨ìˆ˜
            function makeMusicHTML(musicArray, borderColor = 'var(--border)') {
                return musicArray.map(([type, count]) => {
                    const musicData = MUSIC_TYPES[type];
                    return `
                        <button class="option-btn" style="border: 2px solid ${borderColor};" onclick="playMusicByType('${type}')">
                            <span class="option-icon">${musicData.icon}</span>
                            <div class="option-info">
                                <div class="option-name">${musicData.name} Ã—${count}</div>
                                <div class="option-effect">${musicData.effect}</div>
                            </div>
                        </button>
                    `;
                }).join('');
            }
            
            let html = '<div class="music-grid">';
            
            // ì´ë²¤íŠ¸ ìŒì•…
            if (eventMusicHTML) {
                html += `<div style="width: 100%; font-weight: 600; color: #c41e3a; margin-bottom: 10px;">ğŸ„ ì´ë²¤íŠ¸ ìŒì•…</div>`;
                html += eventMusicHTML;
            }
            
            // ì „ì„¤ ë ˆì½”ë“œ (í‹°ì–´ 4)
            if (tier4Music.length > 0) {
                html += `<div style="width: 100%; font-weight: 600; color: #ffd700; margin: 15px 0 10px;">ğŸ‘‘ ì „ì„¤ ë ˆì½”ë“œ</div>`;
                html += makeMusicHTML(tier4Music, '#ffd700');
            }
            
            // í”„ë¦¬ë¯¸ì—„ ë ˆì½”ë“œ (í‹°ì–´ 3)
            if (tier3Music.length > 0) {
                html += `<div style="width: 100%; font-weight: 600; color: #9b59b6; margin: 15px 0 10px;">âœ¨ í”„ë¦¬ë¯¸ì—„ ë ˆì½”ë“œ</div>`;
                html += makeMusicHTML(tier3Music, '#9b59b6');
            }
            
            // ì¥ë¥´ ë ˆì½”ë“œ (í‹°ì–´ 2)
            if (tier2Music.length > 0) {
                html += `<div style="width: 100%; font-weight: 600; color: #3498db; margin: 15px 0 10px;">ğŸµ ì¥ë¥´ ë ˆì½”ë“œ</div>`;
                html += makeMusicHTML(tier2Music, '#3498db');
            }
            
            // ê¸°ë³¸ ì•…ê¸° (í‹°ì–´ 1)
            if (tier1Music.length > 0) {
                html += `<div style="width: 100%; font-weight: 600; color: var(--text); margin: 15px 0 10px;">ğŸ¹ ì•…ê¸° ë ˆì½”ë“œ</div>`;
                html += makeMusicHTML(tier1Music, 'var(--border)');
            }
            
            html += '</div>';
            
            if (!eventMusicHTML && tier1Music.length === 0 && tier2Music.length === 0 && tier3Music.length === 0 && tier4Music.length === 0) {
                html = '<p style="text-align: center; color: #888;">ë ˆì½”ë“œê°€ ì—†ìŠµë‹ˆë‹¤</p>';
            }
            
            container.innerHTML = html;
        }

        function playMusicByType(musicType) {
            const spiritId = currentSpiritId;
            
            // í•´ë‹¹ íƒ€ì…ì˜ ìŒì•… ì°¾ê¸°
            const musicIndex = inventory.music.indexOf(musicType);
            if (musicIndex === -1) {
                showNotification('í•´ë‹¹ ìŒì•…ì´ ì—†ìŠµë‹ˆë‹¤');
                return;
            }
            
            // ê¸°ì¡´ playMusic í•¨ìˆ˜ í˜¸ì¶œ
            playMusic(spiritId, musicType, musicIndex);
        }

        function playMusic(spiritId, musicType, inventoryIndex) {
            if (isPaused) {
                showNotification('ê²Œì„ì´ ì¼ì‹œì •ì§€ ìƒíƒœì…ë‹ˆë‹¤');
                return;
            }
            
            const spirit = spirits.find(s => s.id === spiritId);
            if (!spirit) return;

            // ì´ë²¤íŠ¸ ìŒì•… ì²´í¬
            const eventItem = EVENT_ITEMS[musicType];
            if (eventItem && eventItem.type === 'music') {
                const effects = eventItem.effects;
                spirit.parameters.affection += effects.affection || 0;
                spirit.parameters.charm = Math.min(100, spirit.parameters.charm + (effects.charm || 0));
                
                spirit.lastMusic = Date.now();
                spirit.lastInteraction = Date.now();
                spirit.lastMusicType = musicType;
                
                if (!spirit.musicListened) spirit.musicListened = 0;
                spirit.musicListened += 1;
                
                // ì„±ì¥ ë‹¨ê³„ë³„ ì´ë²¤íŠ¸ ìŒì•… ëŒ€ì‚¬
                const eventStage = getStage(spirit.growth);
                if (eventStage === 'egg') {
                    spirit.status = `${spirit.name}ì—ì„œ í¬ë¦¬ìŠ¤ë§ˆìŠ¤ ìºë¡¤ì— ë°˜ì‘í•˜ëŠ” ë”°ëœ»í•œ ì§„ë™ì´ ëŠê»´ì§‘ë‹ˆë‹¤.`;
                } else if (eventStage === 'pupa') {
                    spirit.status = `${spirit.name}ì´(ê°€) í¬ë¦¬ìŠ¤ë§ˆìŠ¤ ìºë¡¤ì— ë¯¸ì„¸í•˜ê²Œ ê¿ˆí‹€ê±°ë¦½ë‹ˆë‹¤.`;
                } else {
                    spirit.status = `${spirit.name}ì´(ê°€) í¬ë¦¬ìŠ¤ë§ˆìŠ¤ ìºë¡¤ì— ë§ì¶° í–‰ë³µí•´í•©ë‹ˆë‹¤!`;
                }
                addLog(spirit, `ğŸ„ ${eventItem.name}ì„(ë¥¼) ë“¤ì—ˆìŠµë‹ˆë‹¤!`);
                
                inventory.music.splice(inventoryIndex, 1);
                
                closeModal('musicModal');
                saveGame();
                renderSpirits();
                renderInventory();
                showNotification(`${eventItem.icon} ${eventItem.name}ì„(ë¥¼) ë“¤ë ¤ì£¼ì—ˆìŠµë‹ˆë‹¤! (ì• ì •ë„ +10, ë§¤ë ¥ +5)`);
                return;
            }

            const musicData = MUSIC_TYPES[musicType];
            if (!musicData) {
                showNotification('ì•Œ ìˆ˜ ì—†ëŠ” ìŒì•…ì…ë‹ˆë‹¤');
                return;
            }
            
            // ë§Œì¡±ë„ ì¦‰ì‹œ ê³„ì‚°
            spirit.satisfaction = calculateSatisfaction(spirit);
            
            // ì§€ë ¥ 50 ì´ìƒì´ë©´ "ë˜‘ë˜‘í•œ" íš¨ê³¼: ëª¨ë“  ìŠ¤íƒ¯ ë³´ë„ˆìŠ¤ +2
            const smartBonus = spirit.parameters.intelligence >= 50 ? 2 : 0;
            
            // stats ê¸°ë°˜ ë™ì  íš¨ê³¼ ì ìš©
            if (musicData.stats) {
                const statCount = Object.keys(musicData.stats).length;
                // ë‹¨ì¼ ìŠ¤íƒ¯ì´ë©´ +2 ë³´ë„ˆìŠ¤, ë³µìˆ˜ ìŠ¤íƒ¯ì´ë©´ +1 ë³´ë„ˆìŠ¤ (ë§Œì¡±ë„ ë†’ì„ ë•Œ)
                const satisfactionBonus = spirit.satisfaction === 'high' ? (statCount === 1 ? 2 : 1) : 0;
                
                if (musicData.stats.intelligence) {
                    spirit.parameters.intelligence = Math.min(100, spirit.parameters.intelligence + musicData.stats.intelligence + satisfactionBonus + smartBonus);
                }
                if (musicData.stats.strength) {
                    spirit.parameters.strength = Math.min(100, spirit.parameters.strength + musicData.stats.strength + satisfactionBonus + smartBonus);
                }
                if (musicData.stats.charm) {
                    spirit.parameters.charm = Math.min(100, spirit.parameters.charm + musicData.stats.charm + satisfactionBonus + smartBonus);
                }
            } else {
                // ì´ì „ ë²„ì „ í˜¸í™˜ (statsê°€ ì—†ëŠ” ë ˆì½”ë“œ) - ê¸°ì¡´ í•˜ë“œì½”ë”©
                const singleStatBonus = spirit.satisfaction === 'high' ? 2 : 0;
                const dualStatBonus = spirit.satisfaction === 'high' ? 1 : 0;
                
                if (musicType === 'classic') {
                    spirit.parameters.intelligence = Math.min(100, spirit.parameters.intelligence + 10 + singleStatBonus + smartBonus);
                } else if (musicType === 'jazz') {
                    spirit.parameters.charm = Math.min(100, spirit.parameters.charm + 10 + singleStatBonus + smartBonus);
                } else if (musicType === 'rock') {
                    spirit.parameters.strength = Math.min(100, spirit.parameters.strength + 10 + singleStatBonus + smartBonus);
                } else if (musicType === 'pop') {
                    spirit.parameters.intelligence = Math.min(100, spirit.parameters.intelligence + 5 + dualStatBonus + smartBonus);
                    spirit.parameters.charm = Math.min(100, spirit.parameters.charm + 5 + dualStatBonus + smartBonus);
                } else if (musicType === 'ballad') {
                    spirit.parameters.strength = Math.min(100, spirit.parameters.strength + 5 + dualStatBonus + smartBonus);
                    spirit.parameters.charm = Math.min(100, spirit.parameters.charm + 5 + dualStatBonus + smartBonus);
                } else if (musicType === 'edm') {
                    spirit.parameters.intelligence = Math.min(100, spirit.parameters.intelligence + 5 + dualStatBonus + smartBonus);
                    spirit.parameters.strength = Math.min(100, spirit.parameters.strength + 5 + dualStatBonus + smartBonus);
                }
            }

            // ì• ì •ë„ ì¦ê°€ (ë§Œì¡±ë„ ë†’ìœ¼ë©´ +1 ë³´ë„ˆìŠ¤)
            const affectionBonus = spirit.satisfaction === 'high' ? 3 : 2;
            spirit.parameters.affection += affectionBonus;

            spirit.lastMusic = Date.now();
            spirit.lastInteraction = Date.now();  // ìƒí˜¸ì‘ìš© ì‹œê°„ ì—…ë°ì´íŠ¸
            spirit.lastMusicType = musicType; // ë§ˆì§€ë§‰ìœ¼ë¡œ ë“¤ì€ ìŒì•… ì €ì¥
            
            // ìŒì•… ì²­ì·¨ íšŸìˆ˜ ì¦ê°€
            if (!spirit.musicListened) spirit.musicListened = 0;
            spirit.musicListened += 1;
            
            // ì„±ì¥ ë‹¨ê³„ í™•ì¸
            const stage = getStage(spirit.growth);
            const isEgg = stage === 'egg';
            const isPupaStage = stage === 'pupa';
            
            // ìŒì•… ê´€ë ¨ ëœë¤ ë©”ì‹œì§€ (ì„±ì¥ ë‹¨ê³„ë³„)
            let musicMessages = [];
            
            if (isEgg) {
                // ì•Œ ìƒíƒœ ìŒì•… ë°˜ì‘
                musicMessages = [
                    `${spirit.name}ì—ì„œ ìŒì•…ì— ë°˜ì‘í•˜ëŠ” ì§„ë™ì´ ëŠê»´ì§‘ë‹ˆë‹¤.`,
                    `${spirit.name}ì´(ê°€) ${musicData.name}ì˜ ì„ ìœ¨ì— ë¯¸ì„¸í•˜ê²Œ ë–¨ë¦½ë‹ˆë‹¤.`,
                    `${spirit.name}ì˜ ê»ì§ˆì´ ìŒì•…ì— ë§ì¶° í¬ë¯¸í•˜ê²Œ ë¹›ë‚©ë‹ˆë‹¤.`,
                    `${spirit.name} ì•ˆì—ì„œ ìŒì•…ì„ ì¢‹ì•„í•˜ëŠ” ê²ƒ ê°™ì€ ê¸°ìš´ì´ ëŠê»´ì§‘ë‹ˆë‹¤.`,
                    `${spirit.name}ì´(ê°€) ${musicData.name}ì„(ë¥¼) ë“£ê³  í‰ì˜¨í•´ ë³´ì…ë‹ˆë‹¤.`
                ];
            } else if (isPupaStage) {
                // ë²ˆë°ê¸° ìƒíƒœ ìŒì•… ë°˜ì‘
                musicMessages = [
                    `${spirit.name}ì—ì„œ ìŒì•…ì— ë°˜ì‘í•˜ëŠ” ì•½í•œ ì§„ë™ì´ ëŠê»´ì§‘ë‹ˆë‹¤.`,
                    `${spirit.name}ì´(ê°€) ${musicData.name}ì˜ ì„ ìœ¨ì— ë¯¸ì„¸í•˜ê²Œ ê¿ˆí‹€ê±°ë¦½ë‹ˆë‹¤.`,
                    `${spirit.name}ì˜ ê»ì§ˆì´ ìŒì•…ì— ë§ì¶° ì‚´ì§ ë–¨ë¦½ë‹ˆë‹¤.`,
                    `${spirit.name} ì•ˆì—ì„œ ìŒì•…ì„ ì¦ê¸°ëŠ” ê²ƒ ê°™ì€ ê¸°ìš´ì´ ëŠê»´ì§‘ë‹ˆë‹¤.`,
                    `${spirit.name}ì´(ê°€) ${musicData.name}ì„(ë¥¼) ë“¤ìœ¼ë©° ë³€íƒœë¥¼ ì¤€ë¹„í•©ë‹ˆë‹¤.`
                ];
            } else {
                // ì• ë²Œë ˆ ìƒíƒœ ìŒì•… ë°˜ì‘ (ê¸°ì¡´)
                musicMessages = [
                    `${spirit.name}ì´(ê°€) ${musicData.name}ì„(ë¥¼) í¥ì–¼ê±°ë¦½ë‹ˆë‹¤.`,
                    `${spirit.name}ì´(ê°€) ${musicData.name}ì— ë§ì¶° ì¶¤ì„ ì¶¥ë‹ˆë‹¤.`,
                    `${spirit.name}ì´(ê°€) ${musicData.name}ì˜ ì„ ìœ¨ì„ ë– ì˜¬ë¦½ë‹ˆë‹¤.`,
                    `${spirit.name}ì´(ê°€) ìŒì•…ì— ì·¨í•´ ìˆìŠµë‹ˆë‹¤.`,
                    `${spirit.name}ì´(ê°€) ${musicData.name}ì˜ ì—¬ìš´ì— ì –ì–´ ìˆìŠµë‹ˆë‹¤.`
                ];
            }
            spirit.status = musicMessages[Math.floor(Math.random() * musicMessages.length)];

            // ì¼ì§€ ì¶”ê°€
            addLog(spirit, `${musicData.name}ì„(ë¥¼) ë“¤ì—ˆìŠµë‹ˆë‹¤`);

            // ìŒì•… ì†Œëª¨
            inventory.music.splice(inventoryIndex, 1);

            closeModal('musicModal');
            saveGame();
            renderSpirits();  // ì „ì²´ ë Œë”ë§ìœ¼ë¡œ ì¿¨íƒ€ì„ í‘œì‹œ ì—…ë°ì´íŠ¸
            renderInventory();
            const bonusText = spirit.satisfaction === 'high' ? '' : '';
            showNotification(`${musicData.name}ì„(ë¥¼) ë“¤ë ¤ì£¼ì—ˆìŠµë‹ˆë‹¤${bonusText}`);
            
            // íŠœí† ë¦¬ì–¼ ì²´í¬
            checkTutorialAction('music');
        }

        function patSpirit(spiritId) {
            if (isPaused) {
                showNotification('ê²Œì„ì´ ì¼ì‹œì •ì§€ ìƒíƒœì…ë‹ˆë‹¤');
                return;
            }
            
            const spirit = spirits.find(s => s.id === spiritId);
            if (!spirit) return;
            
            // ë¶ˆë§Œ ìƒíƒœê°€ 10ë¶„ ì´ìƒ ì§€ì†ë˜ë©´ ê±°ë¶€
            if (isSpiritRefusing(spiritId)) {
                spirit.status = getRefusalMessage(spirit.name, 'pet');
                addLog(spirit, spirit.status);
                renderSpirits();
                showNotification('ğŸ˜¢ ì •ë ¹ì´ ì“°ë‹¤ë“¬ê¸°ë¥¼ ê±°ë¶€í•©ë‹ˆë‹¤...');
                return;
            }

            if (!canDoAction(spirit, 'pat')) {
                showNotification('ì•„ì§ ì“°ë‹¤ë“¬ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
                return;
            }

            // ë§Œì¡±ë„ ì¦‰ì‹œ ê³„ì‚°
            spirit.satisfaction = calculateSatisfaction(spirit);
            
            const currentAffection = spirit.parameters.affection || 0;
            const affectionBonus = spirit.satisfaction === 'high' ? 2 : 1;
            spirit.parameters.affection += affectionBonus;
            spirit.lastPat = Date.now();
            spirit.lastInteraction = Date.now();  // ìƒí˜¸ì‘ìš© ì‹œê°„ ì—…ë°ì´íŠ¸
            
            // ì„±ì¥ ë‹¨ê³„ í™•ì¸
            const stage = getStage(spirit.growth);
            const isEgg = stage === 'egg';
            const isPupaStage = stage === 'pupa';
            
            // ì• ì •ë„ì— ë”°ë¥¸ ë°˜ì‘ ë©”ì‹œì§€
            let messages = [];
            let notificationEmoji = '';
            
            // ì•Œ ìƒíƒœ ëŒ€ì‚¬
            if (isEgg) {
                if (currentAffection < 10) {
                    messages = [
                        `${spirit.name}ì—ì„œ ì°¨ê°€ìš´ ê¸°ìš´ì´ ëŠê»´ì§‘ë‹ˆë‹¤.`,
                        `${spirit.name}ì´(ê°€) ì•„ì§ ë‚¯ì„  ì˜¨ê¸°ì— ì ì‘ ì¤‘ì…ë‹ˆë‹¤.`,
                        `${spirit.name}ì˜ ê»ì§ˆì´ ì‚´ì§ ë–¨ë¦½ë‹ˆë‹¤.`
                    ];
                    notificationEmoji = 'ğŸ˜Ÿ';
                } else if (currentAffection < 50) {
                    messages = [
                        `${spirit.name}ì—ì„œ ë”°ëœ»í•œ ê¸°ìš´ì´ ëŠê»´ì§‘ë‹ˆë‹¤.`,
                        `${spirit.name}ì´(ê°€) ë‹¹ì‹ ì˜ ì˜¨ê¸°ë¥¼ ì¢‹ì•„í•˜ëŠ” ê²ƒ ê°™ìŠµë‹ˆë‹¤.`,
                        `${spirit.name}ì˜ ê»ì§ˆì—ì„œ ë¯¸ì„¸í•œ ì§„ë™ì´ ëŠê»´ì§‘ë‹ˆë‹¤.`
                    ];
                    notificationEmoji = 'ğŸ˜Š';
                } else {
                    messages = [
                        `${spirit.name}ì—ì„œ í–‰ë³µí•œ ê¸°ìš´ì´ ì „í•´ì§‘ë‹ˆë‹¤.`,
                        `${spirit.name}ì´(ê°€) ë‹¹ì‹ ì˜ ì†ê¸¸ì— ë°˜ì‘í•©ë‹ˆë‹¤.`,
                        `${spirit.name} ì•ˆì—ì„œ ë¬´ì–¸ê°€ ê¸°ë»í•˜ëŠ” ê²ƒ ê°™ìŠµë‹ˆë‹¤.`,
                        `${spirit.name}ì´(ê°€) í¬ê·¼í•œ ì˜¨ê¸°ì— ë§Œì¡±í•´í•©ë‹ˆë‹¤.`
                    ];
                    notificationEmoji = 'ğŸ¥°';
                }
            }
            // ë²ˆë°ê¸° ìƒíƒœ ëŒ€ì‚¬
            else if (isPupaStage) {
                if (currentAffection < 10) {
                    messages = [
                        `${spirit.name}ì—ì„œ ë¯¸ì•½í•œ ë°˜ì‘ì´ ëŠê»´ì§‘ë‹ˆë‹¤.`,
                        `${spirit.name}ì´(ê°€) ì•„ì§ ë‹¹ì‹ ì˜ ì†ê¸¸ì— ìµìˆ™í•˜ì§€ ì•Šì€ ê²ƒ ê°™ìŠµë‹ˆë‹¤.`,
                        `${spirit.name}ì˜ ê»ì§ˆì´ ì‚´ì§ ê²½ì§ë©ë‹ˆë‹¤.`
                    ];
                    notificationEmoji = 'ğŸ˜Ÿ';
                } else if (currentAffection < 50) {
                    messages = [
                        `${spirit.name}ì—ì„œ ë”°ëœ»í•œ ì§„ë™ì´ ëŠê»´ì§‘ë‹ˆë‹¤.`,
                        `${spirit.name}ì´(ê°€) ë‹¹ì‹ ì˜ ì†ê¸¸ì— í¸ì•ˆí•´í•˜ëŠ” ê²ƒ ê°™ìŠµë‹ˆë‹¤.`,
                        `${spirit.name}ì˜ ê»ì§ˆì´ ë¶€ë“œëŸ½ê²Œ ë°˜ì‘í•©ë‹ˆë‹¤.`
                    ];
                    notificationEmoji = 'ğŸ˜Š';
                } else {
                    messages = [
                        `${spirit.name}ì—ì„œ í–‰ë³µí•œ ì§„ë™ì´ ì „í•´ì§‘ë‹ˆë‹¤.`,
                        `${spirit.name}ì´(ê°€) ë‹¹ì‹ ì˜ ì†ê¸¸ì„ ê¸°ë‹¤ë ¸ë˜ ê²ƒ ê°™ìŠµë‹ˆë‹¤.`,
                        `${spirit.name} ì•ˆì—ì„œ ê¸°ì¨ì´ ëŠê»´ì§‘ë‹ˆë‹¤.`,
                        `${spirit.name}ì´(ê°€) ë‹¹ì‹ ì˜ ì‚¬ë‘ì„ ëŠë¼ê³  ìˆìŠµë‹ˆë‹¤.`
                    ];
                    notificationEmoji = 'ğŸ¥°';
                }
            }
            // ì• ë²Œë ˆ ìƒíƒœ ëŒ€ì‚¬ (ê¸°ì¡´)
            else if (currentAffection < 10) {
                // ë‚¯ì„¤ì–´í•¨, ê²½ê³„í•¨
                messages = [
                    `${spirit.name}ì´(ê°€) ë‹¹ì‹ ì„ ë‚¯ì„¤ì–´í•©ë‹ˆë‹¤...`,
                    `${spirit.name}ì´(ê°€) ê²½ê³„í•˜ë©° ë¬¼ëŸ¬ì„­ë‹ˆë‹¤`,
                    `${spirit.name}ì´(ê°€) ì¡°ì‹¬ìŠ¤ëŸ½ê²Œ ë°”ë¼ë´…ë‹ˆë‹¤`,
                    `${spirit.name}ì´(ê°€) ë‹¹ì‹ ì˜ ì†ê¸¸ì„ ë‘ë ¤ì›Œí•©ë‹ˆë‹¤`,
                    `${spirit.name}ì´(ê°€) ë¶ˆì•ˆí•´í•˜ë©° ëª¸ì„ ì›€ì¸ ë¦½ë‹ˆë‹¤`,
                    `${spirit.name}ì´(ê°€) ë‹¹ì‹ ì´ ëˆ„êµ¬ì¸ì§€ ê¶ê¸ˆí•´í•©ë‹ˆë‹¤`,
                    `${spirit.name}ì´(ê°€) ì²œì²œíˆ ë‹¤ê°€ì˜µë‹ˆë‹¤...`
                ];
                notificationEmoji = 'ğŸ˜Ÿ';
            } else if (currentAffection < 50) {
                // ìµìˆ™í•´ì§
                messages = [
                    `${spirit.name}ì´(ê°€) ë‹¹ì‹ ì—ê²Œ ìµìˆ™í•´ì¡ŒìŠµë‹ˆë‹¤`,
                    `${spirit.name}ì´(ê°€) í¸ì•ˆí•´ ë³´ì…ë‹ˆë‹¤`,
                    `${spirit.name}ì´(ê°€) ë‹¹ì‹ ì˜ ì†ê¸¸ì„ ë°›ì•„ë“¤ì…ë‹ˆë‹¤`,
                    `${spirit.name}ì´(ê°€) ì¡°ê¸ˆì”© ë§ˆìŒì„ ì—½ë‹ˆë‹¤`,
                    `${spirit.name}ì´(ê°€) ë‹¹ì‹ ì„ ì‹ ë¢°í•˜ê¸° ì‹œì‘í•©ë‹ˆë‹¤`,
                    `${spirit.name}ì´(ê°€) ê¸°ë¶„ì´ ì¢‹ì•„ ë³´ì…ë‹ˆë‹¤`,
                    `${spirit.name}ì´(ê°€) ë‹¹ì‹  ê³ì— ë¨¸ë­…ë‹ˆë‹¤`
                ];
                notificationEmoji = 'ğŸ˜Š';
            } else {
                // ì¹œí•´ì§, ì˜ ë”°ë¦„
                messages = [
                    `${spirit.name}ì´(ê°€) ë‹¹ì‹ ì„ ë¬´ì²™ ì¢‹ì•„í•©ë‹ˆë‹¤!`,
                    `${spirit.name}ì´(ê°€) ë‹¹ì‹ ì„ ë”°ë¼ë‹¤ë‹™ë‹ˆë‹¤`,
                    `${spirit.name}ì´(ê°€) í–‰ë³µí•˜ê²Œ ë‹¹ì‹ ì„ ë°”ë¼ë´…ë‹ˆë‹¤`,
                    `${spirit.name}ì´(ê°€) ë‹¹ì‹ ì—ê²Œ ì• êµë¥¼ ë¶€ë¦½ë‹ˆë‹¤`,
                    `${spirit.name}ì´(ê°€) ë‹¹ì‹ ì˜ ì†ì„ ë¹„ë¹•ë‹ˆë‹¤`,
                    `${spirit.name}ì´(ê°€) ê¸°ë»í•˜ë©° í„ì© ëœë‹ˆë‹¤!`,
                    `${spirit.name}ì´(ê°€) ë‹¹ì‹  ê³ì„ ë– ë‚˜ì§€ ì•Šìœ¼ë ¤ í•©ë‹ˆë‹¤`,
                    `${spirit.name}ì´(ê°€) ë‹¹ì‹ ì˜ ì‚¬ë‘ì„ ì˜¨ëª¸ìœ¼ë¡œ ëŠë‚ë‹ˆë‹¤`
                ];
                notificationEmoji = 'ğŸ¥°';
            }
            
            spirit.status = messages[Math.floor(Math.random() * messages.length)];

            // ì¼ì§€ ì¶”ê°€
            addLog(spirit, 'ì“°ë‹¤ë“¬ì—ˆìŠµë‹ˆë‹¤');
            addLog(spirit, spirit.status);

            saveGame();
            renderSpirits();  // ì „ì²´ ë Œë”ë§ìœ¼ë¡œ ì¿¨íƒ€ì„ í‘œì‹œ ì—…ë°ì´íŠ¸
            const bonusText = spirit.satisfaction === 'high' ? '' : '';
            showNotification(`ì“°ë‹¤ë“¬ì—ˆìŠµë‹ˆë‹¤ (ì• ì • +${affectionBonus}${bonusText})`);
            
            // íŠœí† ë¦¬ì–¼ ì²´í¬
            checkTutorialAction('pat');
        }
        
        // ì•½ ë¨¹ì´ê¸° í•¨ìˆ˜
        function giveMedicine(spiritId) {
            if (isPaused) {
                showNotification('ê²Œì„ì´ ì¼ì‹œì •ì§€ ìƒíƒœì…ë‹ˆë‹¤');
                return;
            }
            
            const spirit = spirits.find(s => s.id === spiritId);
            if (!spirit) return;
            
            if (!spirit.isSick) {
                showNotification('ì´ ì •ë ¹ì€ ê±´ê°•í•©ë‹ˆë‹¤');
                return;
            }
            
            if (!inventory.food) inventory.food = [];
            const medicineIndex = inventory.food.indexOf('medicine');
            if (medicineIndex === -1) {
                showNotification('ì•½ì´ˆê°€ ì—†ìŠµë‹ˆë‹¤. ìƒì ì—ì„œ êµ¬ë§¤í•˜ì„¸ìš”!');
                return;
            }
            
            // ì•½ì´ˆ ì†Œëª¨
            inventory.food.splice(medicineIndex, 1);
            
            // ë³‘ ì¹˜ë£Œ
            spirit.isSick = false;
            spirit.sickWarned = false;
            delete spirit.sickTime;
            spirit.lastInteraction = Date.now(); // ìƒí˜¸ì‘ìš© ì‹œê°„ ì—…ë°ì´íŠ¸
            
            const healMessages = [
                `${spirit.name}ì´(ê°€) ì•½ì´ˆë¥¼ ë¨¹ê³  ê±´ê°•í•´ì¡ŒìŠµë‹ˆë‹¤! ğŸ’š`,
                `${spirit.name}ì˜ ë³‘ì´ ì™„ì „íˆ ë‚˜ì•˜ìŠµë‹ˆë‹¤!`,
                `${spirit.name}ì´(ê°€) í™œê¸°ë¥¼ ë˜ì°¾ì•˜ìŠµë‹ˆë‹¤! ğŸŒŸ`,
                `${spirit.name}ì´(ê°€) ë‹¹ì‹ ì˜ ë³´ì‚´í•Œì— ê°ì‚¬í•©ë‹ˆë‹¤`
            ];
            
            spirit.status = healMessages[Math.floor(Math.random() * healMessages.length)];
            
            // ì¼ì§€ ì¶”ê°€
            addLog(spirit, 'ì•½ì´ˆë¥¼ ë¨¹ê³  ê±´ê°•í•´ì¡ŒìŠµë‹ˆë‹¤');
            addLog(spirit, spirit.status);
            
            // ì§ˆë³‘ íŠœí† ë¦¬ì–¼: ì•½ì´ˆ ì‚¬ìš© ì•¡ì…˜ ì²´í¬
            checkSickTutorialAction('useMedicine');
            
            saveGame();
            updateSpiritCard(spirit);
            renderInventory();
            showNotification(`${spirit.name}ì˜ ë³‘ì´ ë‚˜ì•˜ìŠµë‹ˆë‹¤!`);
        }

        let inventoryCollapsed = localStorage.getItem('inventoryCollapsed') === 'true';
        
        function toggleInventoryCollapse() {
            inventoryCollapsed = !inventoryCollapsed;
            localStorage.setItem('inventoryCollapsed', inventoryCollapsed);
            updateInventoryCollapseUI();
        }
        
        function updateInventoryCollapseUI() {
            const content = document.getElementById('inventoryContent');
            const icon = document.getElementById('inventoryToggleIcon');
            
            if (content) {
                content.style.display = inventoryCollapsed ? 'none' : 'block';
            }
            if (icon) {
                icon.textContent = inventoryCollapsed ? 'â–¶' : 'â–¼';
            }
        }

        function changeTitle() {
            const select = document.getElementById('titleSelect');
            currentTitle = select.value;
            
            const titleNames = {
                'none': 'ìë™ì±„ì§‘',
                'hawk_eye': 'ğŸ¦… ë§¤ì˜ ëˆˆ',
                'gatherer': 'ğŸ ì±„ì§‘ê¾¼',
                'musician': 'ìŒì•…ê°€',
                'collector': 'ğŸ’ ìˆ˜ì§‘ê°€'
            };
            
            // ìë™ ì±„ì§‘ ìƒíƒœ ì—…ë°ì´íŠ¸
            if (currentTitle === 'none') {
                showNotification(`ì¹­í˜¸ë¥¼ ${titleNames[currentTitle]}(ìœ¼)ë¡œ ë³€ê²½í–ˆìŠµë‹ˆë‹¤`);
            } else {
                showNotification(`ì¹­í˜¸ë¥¼ ${titleNames[currentTitle]}(ìœ¼)ë¡œ ë³€ê²½í–ˆìŠµë‹ˆë‹¤`);
            }
            
            updateGatherButton();
            saveGame();
        }
        
        function changeShopCategory() {
            const select = document.getElementById('shopCategorySelect');
            currentShopCategory = select.value;
            renderShop();
        }

        function changeGatherLocation() {
            const select = document.getElementById('gatherLocationSelect');
            currentGatherLocation = select.value;
            saveGame();
            
            const locationNames = {
                garden: 'ğŸŒ¸ ì •ì›',
                lake: 'ğŸŒŠ í˜¸ìˆ˜',
                forest: 'ğŸŒ² ìˆ²'
            };
            showNotification(`ì±„ì§‘ ì¥ì†Œë¥¼ ${locationNames[currentGatherLocation]}(ìœ¼)ë¡œ ë³€ê²½í–ˆìŠµë‹ˆë‹¤`);
        }

        function goGather() {
            if (isPaused) {
                showNotification('ê²Œì„ì´ ì¼ì‹œì •ì§€ ìƒíƒœì…ë‹ˆë‹¤');
                return;
            }
            
            const now = Date.now();
            const gatherCooldown = 15000; // 15ì´ˆ

            // ì¿¨ë‹¤ìš´ ì²´í¬
            if (lastGatherTime && (now - lastGatherTime < gatherCooldown)) {
                const remainingTime = Math.ceil((gatherCooldown - (now - lastGatherTime)) / 1000);
                showNotification(`${remainingTime}ì´ˆ í›„ì— ë‹¤ì‹œ ì±„ì§‘í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤`);
                return;
            }
            
            // ì„ íƒëœ ì¥ì†Œì—ì„œ ë°”ë¡œ ì±„ì§‘
            gatherAtLocation(currentGatherLocation);
        }
        
        function gatherAtLocation(location, isAuto = false) {
            const now = Date.now();

            if (!inventory.food) inventory.food = [];
            if (!inventory.music) inventory.music = [];
            if (!inventory.decorations) inventory.decorations = [];

            const discoveries = [];
            
            // ìë™ ì±„ì§‘ì¼ ê²½ìš° í™•ë¥  0.5ë°°, ì•„ë‹ ê²½ìš° 1.0ë°°
            const autoGatherMultiplier = isAuto ? 0.5 : 1.0;
            
            // ì¹­í˜¸ë³„ í™•ë¥  ë³´ë„ˆìŠ¤
            const titleBonus = {
                hawk_eye: 1.5,    // ë§¤ì˜ ëˆˆ: ëª¨ë“  í™•ë¥  1.5ë°°
                gatherer: 1.0,    // ì±„ì§‘ê¾¼: ë¨¹ì´ë§Œ 2ë°° (ì•„ë˜ì„œ ë”°ë¡œ ì²˜ë¦¬)
                musician: 1.0,    // ìŒì•…ê°€: ë ˆì½”ë“œë§Œ 2ë°° (ì•„ë˜ì„œ ë”°ë¡œ ì²˜ë¦¬)
                collector: 1.0    // ìˆ˜ì§‘ê°€: í…Œë¼ë¦¬ì›€ë§Œ 2ë°° (ì•„ë˜ì„œ ë”°ë¡œ ì²˜ë¦¬)
            };
            
            const baseBonus = currentTitle !== 'none' && titleBonus[currentTitle] ? titleBonus[currentTitle] : 1.0;
            const foodBonus = currentTitle === 'gatherer' ? 2.0 : baseBonus;
            const decoBonus = currentTitle === 'collector' ? 2.0 : baseBonus;
            const musicBonus = currentTitle === 'musician' ? 2.0 : baseBonus;
            
            // ì¥ì†Œë³„ ë¨¹ì´ íƒ€ì…
            let locationFoodTypes = [];
            let locationDecoTypes = [];
            
            if (location === 'garden') {
                locationFoodTypes = ['fire', 'water', 'wind', 'earth'];  // ì •ì›: ëª¨ë“  ê¸°ë³¸ ì†ì„±
                locationDecoTypes = ['fire', 'water', 'wind', 'earth'];
            } else if (location === 'lake') {
                locationFoodTypes = ['water', 'wind'];  // í˜¸ìˆ˜: ë¬¼, ë°”ëŒ
                locationDecoTypes = ['water', 'wind'];
            } else if (location === 'forest') {
                locationFoodTypes = ['earth', 'fire'];  // ìˆ²: ë•…, ë¶ˆ
                locationDecoTypes = ['earth', 'fire'];
            }
            
            // í•©ì„± ì „ìš© ë¯¸ë‹ˆì–´ì²˜ ëª©ë¡ (ì±„ì§‘ ë¶ˆê°€)
            const synthOnlyDecos = ['flame_lamp', 'aqua_fountain', 'wind_chime', 'earth_statue', 'light_orb', 'shadow_crystal'];
            
            // ===== ìë™ì±„ì§‘ ê°€ëŠ¥ =====
            
            // 1. 80% í™•ë¥ ë¡œ ì¼ë°˜ ë¨¹ì´ ë°œê²¬ (ë¶ˆë¬¼ë•…ë°”ëŒ)
            if (Math.random() < (0.8 * foodBonus * autoGatherMultiplier)) {
                const randomFood = locationFoodTypes[Math.floor(Math.random() * locationFoodTypes.length)];
                inventory.food.push(randomFood);
                discoveries.push(`ğŸ ${FOOD_NAMES[randomFood]}`);
            }

            // 2. 50% í™•ë¥ ë¡œ í¬ê·€ ë¨¹ì´ ë°œê²¬ (ë¹›ì–´ë‘ )
            if (Math.random() < (0.5 * foodBonus * autoGatherMultiplier)) {
                const rareFoodTypes = ['light', 'dark'];
                const randomRareFood = rareFoodTypes[Math.floor(Math.random() * rareFoodTypes.length)];
                inventory.food.push(randomRareFood);
                discoveries.push(`${FOOD_NAMES[randomRareFood]}`);
            }
            
            // 3. 35% í™•ë¥ ë¡œ ì•…ê¸° ë ˆì½”ë“œ ë°œê²¬
            if (Math.random() < (0.35 * musicBonus * autoGatherMultiplier)) {
                const randomMusic = BASIC_MUSIC[Math.floor(Math.random() * BASIC_MUSIC.length)];
                inventory.music.push(randomMusic);
                discoveries.push(`${MUSIC_TYPES[randomMusic].icon} ${MUSIC_TYPES[randomMusic].name}`);
            }
            
            // 4. 50% í™•ë¥ ë¡œ ì¼ë°˜(common) ë¯¸ë‹ˆì–´ì²˜ (ë¶ˆë¬¼ë•…ë°”ëŒ)
            if (Math.random() < (0.5 * decoBonus * autoGatherMultiplier)) {
                const commonDecos = Object.keys(DECORATION_TYPES).filter(key => {
                    const deco = DECORATION_TYPES[key];
                    return deco.quality === 'common' && locationDecoTypes.includes(deco.attr) && !synthOnlyDecos.includes(key);
                });
                if (commonDecos.length > 0) {
                    const randomDeco = commonDecos[Math.floor(Math.random() * commonDecos.length)];
                    inventory.decorations.push(randomDeco);
                    discoveries.push(`${DECORATION_TYPES[randomDeco].icon} ${DECORATION_TYPES[randomDeco].name}`);
                }
            }
            
            // 5. 20% í™•ë¥ ë¡œ ë¹›/ì–´ë‘  ì†ì„± ë¯¸ë‹ˆì–´ì²˜ (common)
            if (Math.random() < (0.2 * decoBonus * autoGatherMultiplier)) {
                const lightDarkDecos = Object.keys(DECORATION_TYPES).filter(key => {
                    const deco = DECORATION_TYPES[key];
                    return deco.quality === 'common' && ['light', 'dark'].includes(deco.attr) && !synthOnlyDecos.includes(key);
                });
                if (lightDarkDecos.length > 0) {
                    const randomDeco = lightDarkDecos[Math.floor(Math.random() * lightDarkDecos.length)];
                    inventory.decorations.push(randomDeco);
                    discoveries.push(`${DECORATION_TYPES[randomDeco].icon} ${DECORATION_TYPES[randomDeco].name}`);
                }
            }
            
            // ===== ìë™ì±„ì§‘ ë¶ˆê°€ =====
            
            // 6. 20% í™•ë¥ ë¡œ í¬ê·€(rare/epic) ë¯¸ë‹ˆì–´ì²˜ - ìë™ ì±„ì§‘ ë¶ˆê°€
            if (!isAuto && Math.random() < (0.2 * decoBonus)) {
                const rareDecos = Object.keys(DECORATION_TYPES).filter(key => {
                    const deco = DECORATION_TYPES[key];
                    return (deco.quality === 'rare' || deco.quality === 'epic') && !synthOnlyDecos.includes(key);
                });
                if (rareDecos.length > 0) {
                    const randomDeco = rareDecos[Math.floor(Math.random() * rareDecos.length)];
                    const qualityLabel = DECORATION_TYPES[randomDeco].quality === 'epic' ? '(ìµœìƒê¸‰!)' : '(í¬ê·€)';
                    inventory.decorations.push(randomDeco);
                    discoveries.push(`${DECORATION_TYPES[randomDeco].icon} ${DECORATION_TYPES[randomDeco].name} ${qualityLabel}`);
                }
            }
            
            // 7. 10% í™•ë¥ ë¡œ ì¥ë¥´ ë ˆì½”ë“œ ë°œê²¬ - ìë™ ì±„ì§‘ ë¶ˆê°€
            if (!isAuto && Math.random() < (0.1 * musicBonus)) {
                const genreRecords = ['classic', 'jazz', 'rock', 'pop', 'ballad', 'edm'];
                const randomGenre = genreRecords[Math.floor(Math.random() * genreRecords.length)];
                inventory.music.push(randomGenre);
                discoveries.push(`${MUSIC_TYPES[randomGenre].icon} ${MUSIC_TYPES[randomGenre].name} (ì¥ë¥´!)`);
            }
            
            // 8. 5% í™•ë¥ ë¡œ ì „ì„¤ ì¬ë£Œ ë°œê²¬ (ë‹¬ì¹˜ì¦ˆ/í™©ê¸ˆì‚¬ê³¼) - ìë™ ì±„ì§‘ ë¶ˆê°€
            if (!isAuto && Math.random() < (0.05 * foodBonus)) {
                const legendaryFoods = ['moon_cheese', 'golden_apple'];
                const randomLegendary = legendaryFoods[Math.floor(Math.random() * legendaryFoods.length)];
                inventory.food.push(randomLegendary);
                const legendaryItem = SYNTH_ITEMS[randomLegendary];
                discoveries.push(`${legendaryItem.icon} ${legendaryItem.name} (ì „ì„¤!)`);
            }

            if (discoveries.length === 0) {
                if (!isAuto) {
                    showNotification('ì•„ë¬´ê²ƒë„ ë°œê²¬í•˜ì§€ ëª»í–ˆìŠµë‹ˆë‹¤...');
                }
            } else {
                const locationNames = { garden: 'ğŸŒ¸ ì •ì›', lake: 'ğŸŒŠ í˜¸ìˆ˜', forest: 'ğŸŒ² ìˆ²' };
                if (isAuto) {
                    showNotification(`ìë™ ì±„ì§‘: ${discoveries.join(', ')}`);
                } else {
                    showNotification(`${locationNames[location]} ì±„ì§‘: ${discoveries.join(', ')}`);
                }
            }

            lastGatherTime = now;
            saveGame();
            renderInventory();
            updateGatherButton();
            
            // ì—°êµ¬ì‹¤ íŠœí† ë¦¬ì–¼ ì²´í¬
            checkInventoryAndLabTutorial();
        }
        
        // ìë™ ì±„ì§‘ (ì¹­í˜¸ ì—†ìŒì¼ ë•Œë§Œ ì‘ë™)
        let autoGatherInterval = null;
        
        function startAutoGather() {
            if (autoGatherInterval) {
                clearInterval(autoGatherInterval);
            }
            
            autoGatherInterval = setInterval(() => {
                // ì¹­í˜¸ê°€ ì—†ìŒ(none)ì¼ ë•Œë§Œ ìë™ ì±„ì§‘
                if (currentTitle !== 'none') return;
                
                // ì¼ì‹œì •ì§€ ìƒíƒœë©´ ìŠ¤í‚µ
                if (isPaused) return;
                
                // ìë™ ì±„ì§‘ ì‹¤í–‰
                gatherAtLocation(currentGatherLocation, true);
            }, 15000); // 15ì´ˆë§ˆë‹¤
        }
        
        function stopAutoGather() {
            if (autoGatherInterval) {
                clearInterval(autoGatherInterval);
                autoGatherInterval = null;
            }
        }

        function updateGatherButton() {
            const gatherBtns = document.querySelectorAll('.walk-btn');
            if (gatherBtns.length === 0) return;

            const now = Date.now();
            const gatherCooldown = 15000; // 15ì´ˆ
            
            // ìë™ ì±„ì§‘ í™œì„±í™” ì—¬ë¶€
            const isAutoGatherActive = currentTitle === 'none';
            
            gatherBtns.forEach(gatherBtn => {
                // ì¼ì‹œì •ì§€ ì¤‘ì´ë©´ ë²„íŠ¼ ë¹„í™œì„±í™”
                if (isPaused) {
                    gatherBtn.disabled = true;
                    gatherBtn.textContent = 'ì±„ì§‘í•˜ê¸° (ì¼ì‹œì •ì§€)';
                    return;
                }

                if (lastGatherTime && (now - lastGatherTime < gatherCooldown)) {
                    gatherBtn.disabled = true;
                    const remainingTime = Math.ceil((gatherCooldown - (now - lastGatherTime)) / 1000);
                    if (isAutoGatherActive) {
                        gatherBtn.textContent = `ìë™ ì±„ì§‘ (${remainingTime}ì´ˆ)`;
                    } else {
                        gatherBtn.textContent = `ì±„ì§‘í•˜ê¸° (${remainingTime}ì´ˆ)`;
                    }
                } else {
                    gatherBtn.disabled = false;
                    if (isAutoGatherActive) {
                        gatherBtn.textContent = 'ìë™ ì±„ì§‘ ì¤‘';
                    } else {
                        gatherBtn.textContent = 'ì±„ì§‘í•˜ê¸°';
                    }
                }
            });
        }

        function confirmDeleteSpirit(spiritId) {
            const spirit = spirits.find(s => s.id === spiritId);
            if (!spirit) return;
            
            // ì—°ê²°ë¡œ íƒœì–´ë‚œ ì •ë ¹ì¸ ê²½ìš° ì½”ë“œ ë°˜í™˜ ì˜µì…˜ ì œê³µ
            if (spirit.isBred && spirit.breedCode) {
                showBreedDeleteConfirm(spirit);
            } else {
                showConfirm(
                    'ì •ë ¹ ë³´ë‚´ê¸°',
                    `ì •ë§ë¡œ ${spirit.name}ì„(ë¥¼) ë³´ë‚´ì‹œê² ìŠµë‹ˆê¹Œ?\n\nì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`,
                    () => deleteSpirit(spiritId, false)
                );
            }
        }
        
        async function showBreedDeleteConfirm(spirit) {
            // ì—°ê²° ì •ë ¹ ì‚­ì œ ì‹œ ì„ íƒì§€ ì œê³µ
            const modal = document.createElement('div');
            modal.className = 'modal active';
            modal.id = 'breedDeleteModal';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 400px;">
                    <h3 style="margin-bottom: 16px;">ğŸ¥š ì—°ê²° ì •ë ¹ ë³´ë‚´ê¸°</h3>
                    <p style="margin-bottom: 8px;">${spirit.name}ì€(ëŠ”) ì—°ê²°ë¡œ íƒœì–´ë‚œ ì •ë ¹ì…ë‹ˆë‹¤.</p>
                    <p style="color: #888; font-size: 0.9rem; margin-bottom: 20px;">ë³´ë‚´ê¸° ë°©ì‹ì„ ì„ íƒí•´ì£¼ì„¸ìš”.</p>
                    
                    <div style="display: flex; flex-direction: column; gap: 10px;">
                        <button onclick="deleteSpirit(${spirit.id}, false); closeBreedDeleteModal();" style="padding: 12px; background: var(--card); border: 1px solid var(--border); border-radius: 8px; cursor: pointer;">
                            ğŸŒ¿ ê·¸ëƒ¥ ë³´ë‚´ê¸°<br>
                            <span style="font-size: 0.8rem; color: #888;">ì—°ê²° ì½”ë“œëŠ” ì‚¬ìš©ëœ ìƒíƒœë¡œ ìœ ì§€</span>
                        </button>
                        <button onclick="deleteSpirit(${spirit.id}, true); closeBreedDeleteModal();" style="padding: 12px; background: linear-gradient(135deg, #667eea, #764ba2); color: white; border: none; border-radius: 8px; cursor: pointer;">
                            ğŸ”„ ì½”ë“œ ë°˜í™˜í•˜ê³  ë³´ë‚´ê¸°<br>
                            <span style="font-size: 0.85rem; opacity: 0.9;">ì—°ê²° ì½”ë“œë¥¼ ë‹¤ì‹œ ì‚¬ìš© ê°€ëŠ¥í•˜ê²Œ</span>
                        </button>
                        <button onclick="closeBreedDeleteModal();" style="padding: 10px; background: transparent; border: 1px solid var(--border); border-radius: 8px; cursor: pointer; color: #888;">
                            ì·¨ì†Œ
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }
        
        function closeBreedDeleteModal() {
            const modal = document.getElementById('breedDeleteModal');
            if (modal) modal.remove();
        }

        function deleteSpirit(spiritId, returnBreedCode = false) {
            const spirit = spirits.find(s => s.id === spiritId);
            if (!spirit) return;
            
            // ì—°ê²° ì½”ë“œ ë°˜í™˜ ì²˜ë¦¬
            if (returnBreedCode && spirit.breedCode) {
                // ì•¨ë²”ì—ì„œë„ í•´ë‹¹ ì½”ë“œ ì‚¬ìš© ê¸°ë¡ ì œê±°
                if (collection) {
                    collection.forEach(s => {
                        if (s.breedCode === spirit.breedCode) {
                            delete s.breedCode;
                        }
                    });
                }
                showNotification('ğŸ”„ ì—°ê²° ì½”ë“œê°€ ë°˜í™˜ë˜ì—ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‚¬ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤!');
            }
            
            spirits = spirits.filter(s => s.id !== spiritId);
            saveGame();
            renderSpirits();
            showNotification('ì •ë ¹ì„ ë– ë‚˜ë³´ëƒˆìŠµë‹ˆë‹¤');
        }

        function renderInventory() {
            // ë¨¹ì´ê°€ ì—†ìœ¼ë©´ ì´ˆê¸°í™”
            if (!inventory.food) {
                inventory.food = [];
            }

            // ë¨¹ì´ ì¸ë²¤í† ë¦¬ (ìˆœì„œ ê³ ì •: fire, water, wind, earth, light, dark + ì´ë²¤íŠ¸ ì•„ì´í…œ)
            const foodContainer = document.getElementById('foodInventory');
            if (inventory.food.length === 0) {
                foodContainer.innerHTML = '<div class="inventory-item">ì—†ìŒ</div>';
            } else {
                const foodCounts = {};
                inventory.food.forEach(f => {
                    foodCounts[f] = (foodCounts[f] || 0) + 1;
                });
                const foodOrder = ['fire', 'water', 'wind', 'earth', 'light', 'dark', 'medicine', 'reconciliation_flower', 'acacia_honey'];
                let foodHTML = foodOrder
                    .filter(type => foodCounts[type])
                    .map(type => {
                        let icon, name;
                        if (type === 'medicine') {
                            icon = MEDICINE.icon;
                            name = MEDICINE.name;
                        } else if (SYNTH_ITEMS[type]) {
                            icon = SYNTH_ITEMS[type].icon;
                            name = SYNTH_ITEMS[type].name;
                        } else {
                            icon = ENV_ICONS[type];
                            name = FOOD_NAMES[type];
                        }
                        return `
                            <div class="inventory-item" title="${name || ''}">
                                ${icon} Ã—${foodCounts[type]}
                            </div>
                        `;
                    }).join('');
                
                // ì´ë²¤íŠ¸ ë¨¹ì´ ì•„ì´í…œ ì¶”ê°€
                Object.keys(foodCounts).forEach(key => {
                    if (EVENT_ITEMS[key] && EVENT_ITEMS[key].type === 'food') {
                        foodHTML += `
                            <div class="inventory-item" title="${EVENT_ITEMS[key].name}">
                                ${EVENT_ITEMS[key].icon} Ã—${foodCounts[key]}
                            </div>
                        `;
                    }
                });
                
                // í•©ì„± ë¨¹ì´ ì•„ì´í…œ ì¶”ê°€ (ìˆ˜ì„ í™” ê½ƒì, ì•„ì¹´ì‹œì•„ ê¿€ì€ ì¼ë°˜ ë¨¹ì´ë¡œ ë¶„ë¥˜ë˜ì–´ ì œì™¸)
                const etcFoods = ['reconciliation_flower', 'acacia_honey'];
                const legendaryMaterials = ['moon_cheese', 'golden_apple'];
                Object.keys(foodCounts).forEach(key => {
                    if (SYNTH_ITEMS[key] && SYNTH_ITEMS[key].type === 'food' && !etcFoods.includes(key)) {
                        const borderColor = legendaryMaterials.includes(key) ? '#ffd700' : '#9b59b6';
                        const label = legendaryMaterials.includes(key) ? 'ğŸŒŒ' : '';
                        foodHTML += `
                            <div class="inventory-item" title="${SYNTH_ITEMS[key].name}" style="border: 2px solid ${borderColor};">
                                ${label}${SYNTH_ITEMS[key].icon} Ã—${foodCounts[key]}
                            </div>
                        `;
                    }
                });
                
                foodContainer.innerHTML = foodHTML || '<div class="inventory-item">ì—†ìŒ</div>';
            }

            // ìŒì•… ì¸ë²¤í† ë¦¬ (ìˆœì„œ ê³ ì •: classic, jazz, rock, pop, ballad + ì´ë²¤íŠ¸ ì•„ì´í…œ)
            const musicContainer = document.getElementById('musicInventory');
            if (!inventory.music) inventory.music = [];
            
            if (inventory.music.length === 0) {
                musicContainer.innerHTML = '<div class="inventory-item">ì—†ìŒ</div>';
            } else {
                const musicCounts = {};
                inventory.music.forEach(m => {
                    musicCounts[m] = (musicCounts[m] || 0) + 1;
                });
                
                // í‹°ì–´ë³„ë¡œ ì •ë ¬í•˜ì—¬ í‘œì‹œ
                let musicHTML = '';
                Object.keys(musicCounts).forEach(type => {
                    const musicData = MUSIC_TYPES[type];
                    if (musicData) {
                        const tierColor = musicData.tier === 4 ? '#ffd700' : musicData.tier === 3 ? '#9b59b6' : musicData.tier === 2 ? '#3498db' : 'var(--border)';
                        const tierLabel = musicData.tier === 4 ? 'ğŸ‘‘' : musicData.tier === 3 ? 'âœ¨' : musicData.tier === 2 ? 'â˜…' : '';
                        musicHTML += `
                            <div class="inventory-item" title="${musicData.name} (${musicData.effect})" style="border: 2px solid ${tierColor};">
                                ${tierLabel}${musicData.icon} Ã—${musicCounts[type]}
                            </div>
                        `;
                    }
                });
                
                // ì´ë²¤íŠ¸ ìŒì•… ì•„ì´í…œ ì¶”ê°€
                Object.keys(musicCounts).forEach(key => {
                    if (EVENT_ITEMS[key] && EVENT_ITEMS[key].type === 'music') {
                        musicHTML += `
                            <div class="inventory-item" title="${EVENT_ITEMS[key].name}" style="border: 2px solid #c41e3a;">
                                ${EVENT_ITEMS[key].icon} Ã—${musicCounts[key]}
                            </div>
                        `;
                    }
                });
                
                musicContainer.innerHTML = musicHTML || '<div class="inventory-item">ì—†ìŒ</div>';
            }

            // ë¯¸ë‹ˆì–´ì²˜ ì¸ë²¤í† ë¦¬ (ë“±ê¸‰ë³„ í‘œì‹œ + ì´ë²¤íŠ¸ ì•„ì´í…œ)
            const decorContainer = document.getElementById('decorInventory');
            if (!inventory.decorations) inventory.decorations = [];
            
            if (inventory.decorations.length === 0) {
                decorContainer.innerHTML = '<div class="inventory-item">ì—†ìŒ</div>';
            } else {
                const decorCounts = {};
                inventory.decorations.forEach(d => {
                    decorCounts[d] = (decorCounts[d] || 0) + 1;
                });
                
                const decorHTML = Object.keys(decorCounts).map(key => {
                    // ì¼ë°˜ ë¯¸ë‹ˆì–´ì²˜ ì²´í¬
                    const decoData = DECORATION_TYPES[key];
                    if (decoData) {
                        const qualityLabel = decoData.quality === 'legendary' ? 'ğŸ‘‘' : decoData.quality === 'epic' ? 'â­' : decoData.quality === 'rare' ? 'ğŸ’' : '';
                        const qualityBorderColor = decoData.quality === 'legendary' ? '#ffd700' : decoData.quality === 'epic' ? '#9b59b6' : decoData.quality === 'rare' ? '#3498db' : 'var(--border)';
                        return `
                            <div class="inventory-item" title="${decoData.name} (${decoData.attr} +${decoData.power})" style="border: 2px solid ${qualityBorderColor};">
                                ${qualityLabel}${decoData.icon} Ã—${decorCounts[key]}
                            </div>
                        `;
                    }
                    
                    // í•©ì„± ë¯¸ë‹ˆì–´ì²˜ ì²´í¬
                    const synthItem = SYNTH_ITEMS[key];
                    if (synthItem && synthItem.type === 'decoration') {
                        return `
                            <div class="inventory-item" title="${synthItem.name} (${synthItem.attr} +${synthItem.power})" style="border: 2px solid #9b59b6;">
                                ${synthItem.icon} Ã—${decorCounts[key]}
                            </div>
                        `;
                    }
                    
                    // ì´ë²¤íŠ¸ ë¯¸ë‹ˆì–´ì²˜ ì²´í¬
                    const eventItem = EVENT_ITEMS[key];
                    if (eventItem && eventItem.type === 'decoration') {
                        const qualityLabel = eventItem.quality === 'legendary' ? 'ğŸ‘‘' : eventItem.quality === 'epic' ? 'â­' : eventItem.quality === 'rare' ? 'ğŸ’' : '';
                        const qualityBorderColor = eventItem.quality === 'legendary' ? '#ffd700' : eventItem.quality === 'epic' ? '#9b59b6' : eventItem.quality === 'rare' ? '#3498db' : '#c41e3a';
                        return `
                            <div class="inventory-item" title="${eventItem.name}" style="border: 2px solid ${qualityBorderColor};">
                                ${qualityLabel}${eventItem.icon} Ã—${decorCounts[key]}
                            </div>
                        `;
                    }
                    
                    return '';
                }).join('');
                
                decorContainer.innerHTML = decorHTML || '<div class="inventory-item">ì—†ìŒ</div>';
            }
        }

        function manualCompleteSpirit(spiritId) {
            if (isPaused) {
                showNotification('ê²Œì„ì´ ì¼ì‹œì •ì§€ ìƒíƒœì…ë‹ˆë‹¤');
                return;
            }
            
            const spirit = spirits.find(s => s.id === spiritId);
            if (!spirit) {
                showNotification('ì •ë ¹ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            
            if (spirit.growth >= 100 && !spirit.isCompleted) {
                try {
                    completeSpirit(spirit);
                    saveGame();
                    renderSpirits();
                    showNotification('âœ¨ ì •ë ¹ì´ ì§„í™”í•©ë‹ˆë‹¤!');
                } catch (error) {
                    console.error('ì§„í™” ì˜¤ë¥˜:', error);
                    showNotification('ì§„í™” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
                }
            } else {
                showNotification(`ì•„ì§ ì§„í™”í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. (ì„±ì¥ë„: ${Math.floor(spirit.growth)}/100)`);
            }
        }

        function completeSpirit(spirit) {
            // ì´ë²¤íŠ¸ ì •ë ¹ ë³„ë„ ì²˜ë¦¬
            if (spirit.isEventSpirit && spirit.eventType) {
                const event = EVENT_TYPES[spirit.eventType];
                if (event) {
                    spirit.isCompleted = true;
                    
                    // ë‚ ê°œ íƒ€ì… ê²°ì •
                    if (!spirit.lightTime) spirit.lightTime = 0;
                    if (!spirit.darkTime) spirit.darkTime = 0;
                    let wingType = spirit.lightTime > spirit.darkTime ? 'butterfly' : 'moth';
                    if (spirit.lightTime === spirit.darkTime) wingType = 'butterfly';
                    spirit.wingType = wingType;
                    
                    // ì´ë¡œì¹˜ ì—¬ë¶€ì— ë”°ë¼ ë‹¤ë¥¸ ë°ì´í„° ì„¤ì •
                    const isShiny = spirit.isShiny && event.shiny;
                    const spiritName = isShiny ? event.shiny.name : event.name;
                    const spiritDesc = isShiny ? event.shiny.desc : event.desc;
                    
                    // adult ì•„ì´ì½˜ (ë‚˜ë¹„/ë‚˜ë°© ë¶„ë¦¬ ì§€ì›)
                    let spiritIcon;
                    const adultStage = isShiny ? event.shiny.stages.adult : event.stages.adult;
                    if (typeof adultStage === 'object' && adultStage.butterfly) {
                        spiritIcon = adultStage[wingType] || adultStage.butterfly;
                    } else {
                        spiritIcon = adultStage;
                    }
                    
                    // encyclopedia í‚¤ (ë‚˜ë¹„/ë‚˜ë°© ë¶„ë¦¬)
                    let eventTypeKey;
                    const hasWingTypes = (isShiny ? event.shiny.stages.adult : event.stages.adult) && 
                                        typeof (isShiny ? event.shiny.stages.adult : event.stages.adult) === 'object';
                    if (hasWingTypes) {
                        eventTypeKey = isShiny ? `event_${spirit.eventType}_shiny_${wingType}` : `event_${spirit.eventType}_${wingType}`;
                    } else {
                        eventTypeKey = isShiny ? `event_${spirit.eventType}_shiny` : `event_${spirit.eventType}`;
                    }
                    
                    spirit.evolutionData = {
                        type: eventTypeKey,
                        attributeType: event.attribute,
                        name: spiritName,
                        icon: spiritIcon,
                        desc: spiritDesc,
                        wingType: wingType,
                        isEvent: true,
                        isShiny: isShiny
                    };
                    
                    // ë„ê° ë“±ë¡ì€ confirmEvolutionì—ì„œ ìˆ˜í–‰ (ì´ì¤‘ ë“±ë¡ ë°©ì§€)
                    
                    saveGame();
                    renderSpirits();
                    
                    if (isShiny) {
                        showNotification(`âœ¨ ${spiritName}ì´(ê°€) ì™„ì„±ë˜ì—ˆìŠµë‹ˆë‹¤! í¬ê·€í•œ ì •ë ¹ì´ì—ìš”!`);
                    } else {
                        showNotification(`ğŸ„ ${spiritName}ì´(ê°€) ì™„ì„±ë˜ì—ˆìŠµë‹ˆë‹¤! ìœ¡ì„± íƒ­ì—ì„œ í™•ì¸í•´ì£¼ì„¸ìš”.`);
                    }
                    return;
                }
            }
            
            // ì—°ê²° ì •ë ¹ ì „ìš© ì§„í™” (100% í™•ë¥ )
            if (spirit.isBred && spirit.fusionType && FUSION_TYPES[spirit.fusionType]) {
                const fusion = FUSION_TYPES[spirit.fusionType];
                spirit.isCompleted = true;
                
                // ë‚ ê°œ íƒ€ì… ê²°ì •
                if (!spirit.lightTime) spirit.lightTime = 0;
                if (!spirit.darkTime) spirit.darkTime = 0;
                let wingType = spirit.lightTime > spirit.darkTime ? 'butterfly' : 'moth';
                
                const evolutionData = {
                    type: spirit.fusionType,
                    attributeType: spirit.fusionType,
                    name: fusion.name,
                    icon: fusion.icon,
                    desc: fusion.desc,
                    wingType: wingType,
                    isFusion: true,
                    fusionRarity: fusion.rarity
                };
                
                spirit.evolutionData = evolutionData;
                
                saveGame();
                renderSpirits();
                
                // ì•¨ë²” ì¶”ê°€ ë° ì •ë ¹ ì œê±°ë¥¼ ìœ„í•œ í™•ì¸ì°½ (ë„ê° ë“±ë¡ì€ ì—¬ê¸°ì„œ ìˆ˜í–‰)
                showConfirm(
                    'í•©ì„± ì •ë ¹ ì™„ì„±',
                    `ğŸ§¬ ${fusion.name}ì´(ê°€) ì™„ì„±ë˜ì—ˆìŠµë‹ˆë‹¤!\nì—°ê²°ì˜ í˜ì´ ë°œí˜„ë˜ì—ˆì–´ìš”!`,
                    () => {
                        // ë„ê° ë“±ë¡ (ìˆ«ì í˜•ì‹ìœ¼ë¡œ í†µì¼) - ë– ë‚˜ë³´ë‚´ê¸° ì‹œì—ë§Œ ë“±ë¡
                        if (!encyclopedia[spirit.fusionType] || typeof encyclopedia[spirit.fusionType] === 'object') {
                            const prevCount = typeof encyclopedia[spirit.fusionType] === 'object' 
                                ? (encyclopedia[spirit.fusionType].count || 0) 
                                : (encyclopedia[spirit.fusionType] || 0);
                            encyclopedia[spirit.fusionType] = prevCount + 1;
                            if (prevCount === 0) {
                                showNotification(`ğŸ‰ ìƒˆë¡œìš´ í•©ì„± ì •ë ¹ "${fusion.name}" ë„ê° ë“±ë¡!`);
                            }
                        } else {
                            encyclopedia[spirit.fusionType]++;
                        }
                        
                        // ë„ê° ìƒì„¸ ì •ë³´ ì €ì¥ (ë³µêµ¬ìš©)
                        if (!encyclopediaDetails[spirit.fusionType]) {
                            encyclopediaDetails[spirit.fusionType] = [];
                        }
                        encyclopediaDetails[spirit.fusionType].push({
                            originalName: spirit.name,
                            parameters: { ...spirit.parameters },
                            hiddenAttributes: { ...spirit.hiddenAttributes },
                            wingType: wingType,
                            lightTime: spirit.lightTime || 0,
                            darkTime: spirit.darkTime || 0,
                            completedAt: Date.now(),
                            isFusion: true,
                            fusionRarity: fusion.rarity,
                            type: spirit.fusionType,
                            attributeType: spirit.fusionType,
                            name: fusion.name,
                            icon: fusion.icon,
                            desc: fusion.desc
                        });
                        
                        // ì•¨ë²”ì— ì¶”ê°€
                        collection.push({
                            id: `album-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`,
                            type: evolutionData.type,
                            attributeType: evolutionData.attributeType,
                            name: evolutionData.name,
                            icon: evolutionData.icon,
                            desc: evolutionData.desc,
                            parameters: { ...spirit.parameters },
                            hiddenAttributes: { ...spirit.hiddenAttributes },
                            originalName: spirit.name,
                            wingType: evolutionData.wingType,
                            lightTime: spirit.lightTime,
                            darkTime: spirit.darkTime,
                            completedAt: Date.now(),
                            isFusion: true,
                            fusionRarity: evolutionData.fusionRarity
                        });
                        
                        // ì½”ì¸ ë³´ìƒ
                        coins += 25;
                        
                        // ì—…ì  ì²´í¬
                        checkAchievements();
                        
                        // ì •ë ¹ ì œê±°
                        spirits = spirits.filter(s => s.id !== spiritId);
                        saveGame();
                        updateCoinDisplay();
                        renderSpirits();
                        
                        showNotification(`âœ¨ ${fusion.name}ì´(ê°€) ì•¨ë²”ì— ë“±ë¡ë˜ê³  ë– ë‚¬ìŠµë‹ˆë‹¤. (+25ì½”ì¸)`);
                    },
                    'ë– ë‚˜ë³´ë‚´ê¸°'
                );
                return;
            }
            
            // ìŠ¤íƒ¯ìœ¼ë¡œ ì§„í™” ê²°ì •
            const params = spirit.parameters;
            
            // ìŠ¤íƒ¯ ê³„ì—´ ê²°ì • (100 ì´ìƒì¸ ê²½ìš°ë§Œ íƒ€ì´í‹€)
            let statType = '';
            let evolutionKey = '';
            
            // í˜„ì ì²´í¬ (ëª¨ë“  ìŠ¤íƒ¯ 100)
            if (params.intelligence >= 100 && params.strength >= 100 && params.charm >= 100) {
                statType = 'sage';
                evolutionKey = 'sage';
            } else {
                // 100 ì´ìƒì¸ ìŠ¤íƒ¯ ì°¾ê¸°
                const maxStats = [];
                if (params.intelligence >= 100) maxStats.push('intelligent');
                if (params.strength >= 100) maxStats.push('strong');
                if (params.charm >= 100) maxStats.push('beautiful');
                
                if (maxStats.length > 0) {
                    // 100 ì´ìƒì¸ ìŠ¤íƒ¯ ì¤‘ ëœë¤ ì„ íƒ
                    statType = maxStats[Math.floor(Math.random() * maxStats.length)];
                    evolutionKey = statType;
                } else {
                    // ì•„ë¬´ ìŠ¤íƒ¯ë„ 100 ë¯¸ë§Œ - íƒ€ì´í‹€ ì—†ìŒ
                    statType = 'nostat';
                    evolutionKey = 'nostat';
                }
            }

            // ì†ì„± ë¶„ì„ (ë¨¹ì´ + í…Œë¼ë¦¬ì›€, ìµœëŒ€ 500)
            const foodAttrs = spirit.hiddenAttributes || { fire: 0, water: 0, wind: 0, earth: 0, light: 0, dark: 0 };
            const terrariumAttrs = terrarium || { fire: 0, water: 0, wind: 0, earth: 0, light: 0, dark: 0 };
            
            // ìµœì¢… ì†ì„± = ë¨¹ì´ ì†ì„± + í…Œë¼ë¦¬ì›€ ì†ì„± (ìµœëŒ€ 500)
            const finalAttrs = {};
            for (let attr in foodAttrs) {
                finalAttrs[attr] = Math.min(500, foodAttrs[attr] + (terrariumAttrs[attr] || 0));
            }
            
            const sortedAttrs = Object.entries(finalAttrs)
                .sort((a, b) => b[1] - a[1]); // ë‚´ë¦¼ì°¨ìˆœ ì •ë ¬
            
            // ìµœê³  ì†ì„±ê°’
            const maxAttrValue = sortedAttrs[0][1];
            
            let attributeKey = '';
            let attributeData = null;
            
            if (maxAttrValue < 50) {
                // ëª¨ë“  ì†ì„±ì´ 50 ë¯¸ë§Œ - ë°±ì˜ ì •ë ¹
                attributeKey = 'normal';
                attributeData = { name: 'ë°±ì˜ ì •ë ¹', icon: 'ğŸ¤', desc: 'ì†ì„±ì´ ê¹ƒë“¤ì§€ ì•Šì€ ìˆœìˆ˜í•œ ì •ë ¹.' };
            } else {
                // 50 ì´ìƒì¸ ì†ì„±ë“¤ë§Œ í•„í„°ë§
                const significantAttrs = sortedAttrs.filter(([_, value]) => value >= 50);
                
                if (significantAttrs.length === 1) {
                    // ë‹¨ì¼ ì†ì„± (í•˜ë‚˜ë§Œ 60 ì´ìƒ)
                    attributeKey = significantAttrs[0][0];
                    attributeData = ATTRIBUTE_NAMES[attributeKey];
                    if (!attributeData) {
                        console.error('Missing ATTRIBUTE_NAMES for:', attributeKey);
                        // ê°€ì¥ ë†’ì€ ë‹¨ì¼ ì†ì„±ìœ¼ë¡œ í´ë°±
                        attributeKey = sortedAttrs[0][0];
                        attributeData = ATTRIBUTE_NAMES[attributeKey] || ATTRIBUTE_NAMES['fire'];
                    }
                } else if (significantAttrs.length === 2) {
                    // 2ì†ì„±: 1ìœ„ì™€ 2ìœ„ ì°¨ì´ê°€ 40% ì´í•˜ë©´ ì¡°í•©, ì´ˆê³¼ë©´ ë‹¨ì¼
                    const first = significantAttrs[0][1];
                    const second = significantAttrs[1][1];
                    const diffPercent = ((first - second) / first) * 100;
                    
                    if (diffPercent <= 40) {
                        // 2ì†ì„± ì¡°í•©
                        const attr1 = significantAttrs[0][0];
                        const attr2 = significantAttrs[1][0];
                        const comboKey = [attr1, attr2].sort().join('-');
                        attributeData = ATTRIBUTE_NAMES[comboKey];
                        attributeKey = comboKey;
                        if (!attributeData) {
                            console.error('Missing ATTRIBUTE_NAMES for combo:', comboKey);
                            // ì¡°í•©ì´ ì—†ìœ¼ë©´ 1ìˆœìœ„ ë‹¨ì¼ ì†ì„±ìœ¼ë¡œ í´ë°±
                            attributeKey = attr1;
                            attributeData = ATTRIBUTE_NAMES[attr1] || ATTRIBUTE_NAMES['fire'];
                        }
                    } else {
                        // ë‹¨ì¼ ì†ì„± (ì°¨ì´ê°€ ë„ˆë¬´ í¼)
                        attributeKey = significantAttrs[0][0];
                        attributeData = ATTRIBUTE_NAMES[attributeKey];
                        if (!attributeData) {
                            console.error('Missing ATTRIBUTE_NAMES for:', attributeKey);
                            // ê°€ì¥ ë†’ì€ ì†ì„±ìœ¼ë¡œ í´ë°±
                            attributeKey = sortedAttrs[0][0];
                            attributeData = ATTRIBUTE_NAMES[attributeKey] || ATTRIBUTE_NAMES['fire'];
                        }
                    }
                } else if (significantAttrs.length >= 3) {
                    // 3ì†ì„± ì´ìƒ - 6ê°œ ì†ì„± ì „ì²´ë¡œ ì¡°í™”/í˜¼ëˆ íŒì •
                    const allSixAttrs = ['fire', 'water', 'earth', 'wind', 'light', 'dark'];
                    const allValues = allSixAttrs.map(attr => finalAttrs[attr] || 0);
                    const maxVal = Math.max(...allValues);
                    const minVal = Math.min(...allValues);
                    
                    // ì°¨ì´ ë¹„ìœ¨ ê³„ì‚° (ìµœëŒ€ê°’ ê¸°ì¤€)
                    const diffPercent = maxVal > 0 ? ((maxVal - minVal) / maxVal) * 100 : 0;
                    
                    if (diffPercent <= 25) {
                        // ì¡°í™” (6ê°œ ì†ì„± ì°¨ì´ 25% ì´ë‚´)
                        attributeKey = 'balanced';
                        attributeData = ATTRIBUTE_NAMES['balanced'];
                    } else {
                        // í˜¼ëˆ (6ê°œ ì†ì„± ì°¨ì´ 25% ì´ˆê³¼)
                        attributeKey = 'multi';
                        attributeData = ATTRIBUTE_NAMES['multi'];
                    }
                    if (!attributeData) {
                        console.error('Missing ATTRIBUTE_NAMES for:', attributeKey);
                        // ê°€ì¥ ë†’ì€ ë‹¨ì¼ ì†ì„±ìœ¼ë¡œ í´ë°±
                        attributeKey = significantAttrs[0][0];
                        attributeData = ATTRIBUTE_NAMES[attributeKey] || ATTRIBUTE_NAMES['fire'];
                    }
                }
            }
            
            // ìµœì¢… ì´ë¦„ê³¼ ì•„ì´ì½˜ ì¡°í•©
            let finalName = '';
            let finalIcon = '';
            let finalDesc = '';
            
            // ë‚ ê°œ íƒ€ì… ë¨¼ì € ê²°ì • (í‹°íƒ€ë‹ˆì•„/ì˜¤ë² ë¡  íŒì •ì— í•„ìš”)
            if (!spirit.lightTime) spirit.lightTime = 0;
            if (!spirit.darkTime) spirit.darkTime = 0;
            
            let wingType = null;
            if (spirit.lightTime > spirit.darkTime) {
                wingType = 'butterfly';
            } else if (spirit.darkTime > spirit.lightTime) {
                wingType = 'moth';
            } else {
                wingType = 'butterfly'; // ë™ì ì´ë©´ ë‚˜ë¹„
            }
            
            // ì†ì„± ì•„ì´ì½˜ ê°€ì ¸ì˜¤ê¸° (ë‚˜ë¹„/ë‚˜ë°©í˜• ì§€ì›)
            const getAttrIcon = (attrData) => {
                if (!attrData || !attrData.icon) return 'ğŸ¤';
                if (typeof attrData.icon === 'object') {
                    return attrData.icon[wingType] || attrData.icon.butterfly || 'ğŸ¤';
                }
                return attrData.icon;
            };
            
            // ì •ë ¹ì™• ì¡°ê±´ ì²´í¬ (ëª¨ë“  ìŠ¤íƒ¯ 100 + ëª¨ë“  ì†ì„± 500)
            const isKingStats = params.intelligence >= 100 && params.strength >= 100 && params.charm >= 100;
            const isKingAttributes = Object.values(finalAttrs).every(val => val >= 500);
            
            // í‹°íƒ€ë‹ˆì•„/ì˜¤ë² ë¡  ì¡°ê±´ ì²´í¬
            // ëª¨ë“  ìŠ¤íƒ¯ 70 ì´ìƒ + ëª¨ë“  ì†ì„± 130 ì´ìƒ
            const isPerfectStats = params.intelligence >= 70 && params.strength >= 70 && params.charm >= 70;
            const isPerfectAttributes = Object.values(finalAttrs).every(val => val >= 250);
            
            // íƒ€ì´í‹€ ì—†ëŠ” ì •ë ¹ ì—¬ë¶€
            const hasNoTitle = evolutionKey === 'nostat';
            
            if (isKingStats && isKingAttributes) {
                // ê¶ê·¹ì˜ ì •ë ¹ - ì •ë ¹ì™•
                finalName = 'ì •ë ¹ì™•';
                finalIcon = 'ğŸ‘‘ğŸŒ¸';
                finalDesc = 'ëª¨ë“  ê²ƒì„ ì´ˆì›”í•œ ë§Œê°œí•œ ìì—°ì˜ í™”ì‹ . ì •ë ¹ê³„ì˜ ìœ ì¼ë¬´ì´í•œ ì§€ë°°ì.';
            } else if (isPerfectStats && isPerfectAttributes) {
                // ì™„ë²½í•œ ì •ë ¹ - í‹°íƒ€ë‹ˆì•„/ì˜¤ë² ë¡ 
                if (wingType === 'butterfly') {
                    finalName = 'í‹°íƒ€ë‹ˆì•„';
                    finalIcon = 'ğŸ¦‹âœ¨';
                    finalDesc = 'ëª¨ë“  í˜ì„ ì™„ë²½íˆ ê°–ì¶˜ ë‚˜ë¹„ì˜ ì—¬ì™•. ë¹›ê³¼ ìƒëª…ì„ ê´€ì¥í•˜ëŠ” ì „ì„¤ì  ì¡´ì¬.';
                } else {
                    finalName = 'ì˜¤ë² ë¡ ';
                    finalIcon = 'ğŸ¦‹ğŸŒ™';
                    finalDesc = 'ëª¨ë“  í˜ì„ ì™„ë²½íˆ ê°–ì¶˜ ë‚˜ë°©ì˜ êµ°ì£¼. ì–´ë‘ ê³¼ ì‹ ë¹„ë¥¼ ì§€ë°°í•˜ëŠ” ì „ì„¤ì  ì¡´ì¬.';
                }
            } else if (attributeKey === 'normal') {
                // ì†ì„± ì—†ìŒ
                if (hasNoTitle) {
                    // ìŠ¤íƒ¯ë„ ë‚®ìŒ - ìˆœìˆ˜í•œ ë°±ì˜ ì •ë ¹
                    if (attributeData) {
                        finalName = attributeData.name;
                        finalIcon = getAttrIcon(attributeData);
                        finalDesc = attributeData.desc;
                    } else {
                        finalName = 'ë°±ì˜ ì •ë ¹';
                        finalIcon = 'ğŸ¤';
                        finalDesc = 'ì†ì„±ì´ ê¹ƒë“¤ì§€ ì•Šì€ ìˆœìˆ˜í•œ ì •ë ¹.';
                    }
                } else {
                    // ìŠ¤íƒ¯ì€ ë†’ìŒ - "ìŠ¤íƒ¯ ê³„ì—´ + ë°±ì˜ ì •ë ¹"
                    const evolution = EVOLUTION_TYPES[evolutionKey];
                    if (evolution && attributeData) {
                        finalName = `${evolution.prefix} ${attributeData.name}`;
                        finalIcon = `${evolution.icon}${getAttrIcon(attributeData)}`;
                        finalDesc = attributeData.desc;
                    } else if (evolution) {
                        // evolutionì€ ìˆëŠ”ë° attributeDataê°€ ì—†ìœ¼ë©´ ë°±ì˜ ì •ë ¹ ì‚¬ìš©
                        finalName = `${evolution.prefix} ë°±ì˜ ì •ë ¹`;
                        finalIcon = `${evolution.icon}ğŸ¤`;
                        finalDesc = 'ì†ì„±ì´ ê¹ƒë“¤ì§€ ì•Šì€ ìˆœìˆ˜í•œ ì •ë ¹.';
                    } else {
                        finalName = 'ë°±ì˜ ì •ë ¹';
                        finalIcon = 'ğŸ¤';
                        finalDesc = 'ì†ì„±ì´ ê¹ƒë“¤ì§€ ì•Šì€ ìˆœìˆ˜í•œ ì •ë ¹.';
                    }
                }
            } else if (hasNoTitle) {
                // ìŠ¤íƒ¯ ë¶€ì¡±í•˜ì§€ë§Œ ì†ì„± ìˆìŒ - ì†ì„± ì´ë¦„ë§Œ (íƒ€ì´í‹€ ì—†ìŒ)
                if (attributeData) {
                    finalName = attributeData.name;
                    finalIcon = getAttrIcon(attributeData);
                    finalDesc = attributeData.desc;
                } else {
                    console.error('attributeData is undefined for key:', attributeKey);
                    // ê°€ì¥ ë†’ì€ ë‹¨ì¼ ì†ì„±ìœ¼ë¡œ í´ë°±
                    const fallbackKey = sortedAttrs[0][0];
                    const fallbackData = ATTRIBUTE_NAMES[fallbackKey] || ATTRIBUTE_NAMES['fire'];
                    finalName = fallbackData.name;
                    finalIcon = getAttrIcon(fallbackData);
                    finalDesc = fallbackData.desc;
                    attributeKey = fallbackKey;
                }
            } else {
                // ìŠ¤íƒ¯ë„ ìˆê³  ì†ì„±ë„ ìˆìŒ - "ìŠ¤íƒ¯ ê³„ì—´ + ì†ì„± ì´ë¦„" í˜•íƒœ
                const evolution = EVOLUTION_TYPES[evolutionKey];
                if (evolution && attributeData) {
                    finalName = `${evolution.prefix} ${attributeData.name}`;
                    finalIcon = `${evolution.icon}${getAttrIcon(attributeData)}`;
                    finalDesc = attributeData.desc;
                } else {
                    console.error('Evolution data missing:', { evolutionKey, attributeKey, evolution, attributeData });
                    // í´ë°±: ì†ì„±ë§Œ ì‚¬ìš©
                    const fallbackKey = sortedAttrs[0][0];
                    const fallbackData = ATTRIBUTE_NAMES[fallbackKey] || ATTRIBUTE_NAMES['fire'];
                    finalName = fallbackData.name;
                    finalIcon = getAttrIcon(fallbackData);
                    finalDesc = fallbackData.desc;
                    attributeKey = fallbackKey;
                }
            }
            
            // evolutionKey ì„¤ì • (ë„ê° ë“±ë¡ìš©)
            let finalEvolutionType = evolutionKey;
            if (isKingStats && isKingAttributes) {
                // ì •ë ¹ì™•
                finalEvolutionType = 'spiritking';
            } else if (isPerfectStats && isPerfectAttributes) {
                // í‹°íƒ€ë‹ˆì•„/ì˜¤ë² ë¡ 
                finalEvolutionType = wingType === 'butterfly' ? 'titania' : 'oberon';
            }
            // nostatì¸ ê²½ìš° evolutionKeyê°€ ì´ë¯¸ 'nostat'ì´ë¯€ë¡œ ê·¸ëŒ€ë¡œ ìœ ì§€
            
            // ì •ë ¹ì„ ì™„ì„± ìƒíƒœë¡œ í‘œì‹œ (ì•„ì§ ì œê±°í•˜ì§€ ì•ŠìŒ)
            spirit.isCompleted = true;
            spirit.evolutionData = {
                type: finalEvolutionType,
                attributeType: attributeKey,
                name: finalName,
                icon: finalIcon,
                desc: finalDesc,
                wingType: wingType
            };
            
            saveGame();
            renderSpirits();
            showNotification('ğŸ‰ ì •ë ¹ì´ ì„±ì¥ì„ ì™„ë£Œí–ˆìŠµë‹ˆë‹¤! ìœ¡ì„± íƒ­ì—ì„œ í™•ì¸í•´ì£¼ì„¸ìš”.');
        }
        
        function confirmEvolution(spiritId) {
            const spirit = spirits.find(s => s.id === spiritId);
            if (!spirit || !spirit.isCompleted) {
                console.log('confirmEvolution failed:', { spirit, spiritId, isCompleted: spirit?.isCompleted });
                return;
            }
            
            const evolutionData = spirit.evolutionData;
            console.log('Evolution data:', evolutionData);
            
            const affection = spirit.parameters.affection || 0;
            
            // ì• ì •ë„ë³„ ì—”ë”© ë©”ì‹œì§€
            let endingMessage = '';
            
            if (affection >= 150) {
                endingMessage = `${spirit.name}ì€(ëŠ”) ë‹¹ì‹ ì—ê²Œ "ã…ã…ã…ã…"ë¼ëŠ” ë§ì„ ë‚¨ê¸°ê³  ë– ë‚©ë‹ˆë‹¤.\n\nì •ë ¹ì–´ ì‚¬ì „ì„ ì°¾ì•„ë³´ë©´ ê·¸ ë§ì€ "ì‚¬ë‘í•´ìš”"ë¼ëŠ” ì˜ë¯¸ì…ë‹ˆë‹¤.`;
            } else if (affection >= 100) {
                endingMessage = `${spirit.name}ì€(ëŠ”) ë‹¹ì‹ ì˜ ëº¨ì— ì…ë§ì¶¤ì„ ë‚¨ê¸°ê³  ë– ë‚©ë‹ˆë‹¤.`;
            } else if (affection >= 50) {
                endingMessage = `${spirit.name}ì€(ëŠ”) ë‹¹ì‹ ì—ê²Œ ê°ì‚¬ì˜ ì¸ì‚¬ë¥¼ ë‚¨ê¸°ê³  ë– ë‚©ë‹ˆë‹¤.`;
            } else {
                endingMessage = `${spirit.name}ì´(ê°€) ë– ë‚˜ê°‘ë‹ˆë‹¤.`;
            }
            
            showConfirm(
                'ì •ë ¹ ì™„ì„±',
                endingMessage,
                () => {
                    // ìƒíƒœ í‚¤ì›Œë“œ ê³„ì‚° (ìœ ì „ ê°€ëŠ¥í•œ ê²ƒë“¤)
                    const statusKeywords = [];
                    if (spirit.parameters.intelligence >= 50) statusKeywords.push('ë˜‘ë˜‘í•œ');
                    if (spirit.parameters.strength >= 50) statusKeywords.push('ê°•í•œ');
                    if (spirit.parameters.charm >= 50) statusKeywords.push('ë§¤ë ¥ì ì¸');
                    
                    // ëª¨ë“  ìƒíƒœ í‚¤ì›Œë“œ ì €ì¥ (ì•¨ë²” í‘œì‹œìš©)
                    const allStatusKeywords = [];
                    
                    // ìŠ¤íƒ¯ ê¸°ë°˜ ê¸ì • í‚¤ì›Œë“œ
                    if (spirit.parameters.intelligence >= 50) allStatusKeywords.push('ë˜‘ë˜‘í•œ');
                    if (spirit.parameters.strength >= 50) allStatusKeywords.push('ê°•í•œ');
                    if (spirit.parameters.charm >= 50) allStatusKeywords.push('ë§¤ë ¥ì ì¸');
                    
                    // ìŠ¤íƒ¯ ê¸°ë°˜ ë¶€ì • í‚¤ì›Œë“œ
                    if (spirit.parameters.intelligence <= 10) allStatusKeywords.push('ì‚¬êµì„±ì´ ì ì€');
                    if (spirit.parameters.strength <= 5) allStatusKeywords.push('ëª¸ì´ ì•½í•œ');
                    
                    // ì• ì •ë„ ê¸°ë°˜
                    if (spirit.parameters.affection >= 100) allStatusKeywords.push('ì‚¬ë‘ì´ ê°€ë“í•œ');
                    else if (spirit.parameters.affection >= 70) allStatusKeywords.push('ì• ì • ì–´ë¦°');
                    
                    // ë§Œì¡±ë„ ê¸°ë°˜
                    if (spirit.satisfaction === 'high') allStatusKeywords.push('í–‰ë³µí•œ');
                    
                    // ë¹›/ì–´ë‘  ì‹œê°„ ê¸°ë°˜
                    const lightTime = spirit.lightTime || 0;
                    const darkTime = spirit.darkTime || 0;
                    if (lightTime >= 10 && lightTime > darkTime) allStatusKeywords.push('íƒœì–‘ì„ ë™ê²½í•˜ëŠ”');
                    else if (darkTime >= 10 && darkTime > lightTime) allStatusKeywords.push('ë‹¬ì„ ìˆ­ë°°í•˜ëŠ”');
                    
                    // ë¨¹ì´/ìŒì•… íšŸìˆ˜ ê¸°ë°˜
                    if (spirit.feedCount >= 20) allStatusKeywords.push('ë¯¸ì‹ê°€');
                    if (spirit.musicListened >= 10) allStatusKeywords.push('ìŒì•…ì„ ì‚¬ë‘í•˜ëŠ”');
                    
                    // ìœ ì „ë°›ì€ í‚¤ì›Œë“œ
                    if (spirit.inheritedKeywords && spirit.inheritedKeywords.length > 0) {
                        spirit.inheritedKeywords.forEach(kw => {
                            if (!allStatusKeywords.includes(kw)) {
                                allStatusKeywords.push(`ğŸ§¬ ${kw}`);
                            }
                        });
                    }
                    
                    // ì•¨ë²”ì— ì¶”ê°€
                collection.push({
                    id: `album-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`, // ê³ ìœ  ID
                    originalSpiritId: spiritId, // ì›ë³¸ ì •ë ¹ ID (íŒŒíŠ¸ë„ˆ ë§¤ì¹­ìš©)
                    type: evolutionData.type,
                    attributeType: evolutionData.attributeType,
                    name: evolutionData.name,
                    icon: evolutionData.icon,
                    desc: evolutionData.desc,
                    parameters: { ...spirit.parameters },
                    hiddenAttributes: { ...spirit.hiddenAttributes },
                    originalName: spirit.name,
                    wingType: evolutionData.wingType,
                    lightTime: spirit.lightTime,
                    darkTime: spirit.darkTime,
                    completedAt: Date.now(),
                    // ì´ë²¤íŠ¸ ì •ë ¹ ì •ë³´ ì €ì¥
                    isEventSpirit: spirit.isEventSpirit || false,
                    eventType: spirit.eventType || null,
                    // ê´€ê³„ ì •ë³´ ì €ì¥
                    bond: spirit.bond || null,
                    // ìƒíƒœ í‚¤ì›Œë“œ ì €ì¥ (ìœ ì „ìš©)
                    statusKeywords: statusKeywords,
                    // ë¶€ëª¨ì—ê²Œì„œ ìœ ì „ë°›ì€ í‚¤ì›Œë“œ
                    inheritedKeywords: spirit.inheritedKeywords || [],
                    // ëª¨ë“  ìƒíƒœ í‚¤ì›Œë“œ (ì•¨ë²” í‘œì‹œìš©)
                    allStatusKeywords: allStatusKeywords
                });
                
                // ë„ê°ì— ë“±ë¡ (ì§„í™” íƒ€ì…ë³„ ì¹´ìš´íŠ¸) - wingType í¬í•¨
                let encyclopediaKey;
                if (evolutionData.type === 'titania' || evolutionData.type === 'oberon' || evolutionData.type === 'spiritking') {
                    // ì „ì„¤ì  ì¡´ì¬ëŠ” ê³ ìœ  í‚¤ ì‚¬ìš©
                    encyclopediaKey = evolutionData.type;
                } else if (evolutionData.type === 'nostat') {
                    // ìˆ˜ì‹ì–´ ì—†ëŠ” ì •ë ¹ (wingType í¬í•¨)
                    encyclopediaKey = `nostat-${evolutionData.attributeType}-${evolutionData.wingType}`;
                } else if (evolutionData.type && evolutionData.type.startsWith('event_')) {
                    // ì´ë²¤íŠ¸ ì •ë ¹ì€ íƒ€ì… ê·¸ëŒ€ë¡œ ì‚¬ìš©
                    encyclopediaKey = evolutionData.type;
                } else {
                    // ì¼ë°˜ ì •ë ¹ (ìŠ¤íƒ¯-ë ˆë²¨-ì†ì„±-wingType)
                    encyclopediaKey = `${evolutionData.type}-${evolutionData.attributeType}-${evolutionData.wingType}`;
                }
                
                // ë„ê°ì— ë“±ë¡ (ìƒˆë¡œìš´ ì¢…ë¥˜ë©´ ì•Œë¦¼)
                const isNewEntry = !encyclopedia[encyclopediaKey];
                if (!encyclopedia[encyclopediaKey]) {
                    encyclopedia[encyclopediaKey] = 0;
                }
                encyclopedia[encyclopediaKey]++;
                
                if (isNewEntry) {
                    if (evolutionData.type && evolutionData.type.startsWith('event_')) {
                        showNotification(`ğŸ‰ ìƒˆë¡œìš´ ì´ë²¤íŠ¸ ì •ë ¹ "${evolutionData.name}" ë„ê° ë“±ë¡!`);
                    } else {
                        showNotification(`ğŸ‰ ìƒˆë¡œìš´ ì •ë ¹ "${evolutionData.name}" ë„ê° ë“±ë¡!`);
                    }
                }
                
                // ë„ê° ìƒì„¸ ì •ë³´ ì €ì¥ (ë³µêµ¬ìš©)
                if (!encyclopediaDetails[encyclopediaKey]) {
                    encyclopediaDetails[encyclopediaKey] = [];
                }
                encyclopediaDetails[encyclopediaKey].push({
                    originalName: spirit.name,
                    parameters: { ...spirit.parameters },
                    hiddenAttributes: { ...spirit.hiddenAttributes },
                    wingType: evolutionData.wingType,
                    lightTime: spirit.lightTime || 0,
                    darkTime: spirit.darkTime || 0,
                    completedAt: Date.now(),
                    isEventSpirit: spirit.isEventSpirit || false,
                    eventType: spirit.eventType || null,
                    // ì§„í™” ì •ë³´
                    type: evolutionData.type,
                    attributeType: evolutionData.attributeType,
                    name: evolutionData.name,
                    icon: evolutionData.icon,
                    desc: evolutionData.desc,
                    // í‚¤ì›Œë“œ ì •ë³´ (ìœ ì „ ë° ì•¨ë²” í‘œì‹œìš©)
                    statusKeywords: statusKeywords,
                    inheritedKeywords: spirit.inheritedKeywords || [],
                    allStatusKeywords: allStatusKeywords
                });
                
                console.log('ë„ê° ë“±ë¡:', encyclopediaKey, 'ì¹´ìš´íŠ¸:', encyclopedia[encyclopediaKey]);
                
                // ì½”ì¸ ë³´ìƒ (25ì½”ì¸)
                coins += 25;
                
                // ì—…ì  ì²´í¬
                checkAchievements();
                
                // ì •ë ¹ ì œê±°
                spirits = spirits.filter(s => s.id !== spiritId);
                saveGame();
                updateCoinDisplay();
                
                // ìë™ ë¡œì»¬ ë°±ì—… (ìµœê·¼ 10ê°œ ìœ ì§€)
                try {
                    const backups = JSON.parse(localStorage.getItem('spiritGarden_autoBackups') || '[]');
                    backups.unshift({
                        timestamp: Date.now(),
                        collection: [...collection],
                        encyclopedia: {...encyclopedia},
                        encyclopediaDetails: JSON.parse(JSON.stringify(encyclopediaDetails))
                    });
                    // ìµœê·¼ 10ê°œë§Œ ìœ ì§€
                    if (backups.length > 10) backups.length = 10;
                    localStorage.setItem('spiritGarden_autoBackups', JSON.stringify(backups));
                } catch (e) {
                    console.warn('ìë™ ë°±ì—… ì‹¤íŒ¨:', e);
                }
                
                    renderSpirits();
                    // ì•Œë¦¼ìš© ì•„ì´ì½˜ (ì´ë¯¸ì§€ íƒœê·¸ê°€ í¬í•¨ëœ ê²½ìš° ì´ëª¨ì§€ë¡œ ëŒ€ì²´)
                    const notifyIcon = evolutionData.icon.includes('<img') ? 'ğŸ¦‹' : evolutionData.icon;
                    showNotification(`${notifyIcon} ${spirit.name}ì´(ê°€) ${evolutionData.name}(ìœ¼)ë¡œ ì•¨ë²”ì— ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤ (+25ğŸ’°)`);
                    
                    // ì—°ëª¨ ì•Œ ì´ë²¤íŠ¸ ì²´í¬
                    checkLoveEggEvent(spirit);
                    
                    // ì²« ë²ˆì§¸ ì •ë ¹ ì™„ì„± ì‹œ ë‘ ë²ˆì§¸ íŠœí† ë¦¬ì–¼ ì‹œì‘
                    if (collection.length === 1 && !localStorage.getItem('spiritGarden_tutorial2Seen')) {
                        setTimeout(() => {
                            startTutorial2();
                        }, 1500);
                    }
                }
            );
        }
        
        // ì—°ëª¨ ì•Œ ì´ë²¤íŠ¸ ì²´í¬
        function checkLoveEggEvent(completedSpirit) {
            // ì—°ëª¨ bondê°€ ìˆëŠ”ì§€ í™•ì¸
            if (!completedSpirit.bond || completedSpirit.bond.type !== 'lover') return;
            
            const partnerId = completedSpirit.bond.partnerId;
            
            // íŒŒíŠ¸ë„ˆê°€ ì•¨ë²”ì— ìˆëŠ”ì§€ í™•ì¸ (originalSpiritIdë¡œ ê²€ìƒ‰)
            const partnerInAlbum = collection.find(item => item.originalSpiritId === partnerId);
            
            if (!partnerInAlbum) {
                // ì•„ì§ íŒŒíŠ¸ë„ˆê°€ ì•¨ë²”ì— ì—†ìŒ - íŒŒíŠ¸ë„ˆê°€ ì™„ì„±ë˜ë©´ ê·¸ë•Œ ì²´í¬ë¨
                return;
            }
            
            // ì´ë¯¸ ì•Œì„ ë°›ì•˜ëŠ”ì§€ ì²´í¬ (ì¤‘ë³µ ë°©ì§€)
            if (partnerInAlbum.loveEggReceived) return;
            
            // 30% í™•ë¥ ë¡œ ì•Œ ì´ë²¤íŠ¸ ë°œìƒ
            if (Math.random() > 0.3) return;
            
            // ë°©ê¸ˆ ì¶”ê°€ëœ ì •ë ¹ ì •ë³´ (ì•¨ë²”ì—ì„œ ê°€ì¥ ìµœê·¼ ê²ƒ)
            const justAdded = collection[collection.length - 1];
            
            // ì¤‘ë³µ ë°©ì§€ í”Œë˜ê·¸ ì„¤ì •
            partnerInAlbum.loveEggReceived = true;
            justAdded.loveEggReceived = true;
            saveGame();
            
            setTimeout(() => {
                showConfirm(
                    'ğŸ’• ì—°ëª¨ì˜ ê²°ì‹¤',
                    `${partnerInAlbum.originalName}ì™€(ê³¼) ${justAdded.originalName}ì˜ ì‚¬ë‘ì´ ê²°ì‹¤ì„ ë§ºì—ˆìŠµë‹ˆë‹¤!\n\nğŸ¥š ë‘˜ ì‚¬ì´ì—ì„œ ì•Œì´ ë‚˜íƒ€ë‚¬ì–´ìš”.\n\nì•Œì„ ë°›ìœ¼ì‹œê² ìŠµë‹ˆê¹Œ?`,
                    () => {
                        // ì•Œ ìƒì„±
                        createLoveEgg(partnerInAlbum, justAdded);
                    },
                    'ë°›ì„ê²Œìš” ğŸ’•',
                    'ê´œì°®ì•„ìš”',
                    () => {
                        showNotification('ì•Œì´ ì‚¬ë¼ì¡ŒìŠµë‹ˆë‹¤...');
                    }
                );
            }, 1500);
        }
        
        // ì—°ëª¨ ì•Œ ìƒì„±
        function createLoveEgg(parent1, parent2) {
            // ìŠ¬ë¡¯ ì²´í¬ (ìµœëŒ€ 6ë§ˆë¦¬)
            if (spirits.length >= 6) {
                showNotification('âŒ ì •ë ¹ ìŠ¬ë¡¯ì´ ê°€ë“ ì°¼ìŠµë‹ˆë‹¤!');
                return;
            }
            
            // ë¶€ëª¨ ì†ì„±ì˜ 25%ì”© = ì´ 50% ìƒì†
            const parent1Attrs = parent1.hiddenAttributes || { fire: 0, water: 0, wind: 0, earth: 0, light: 0, dark: 0 };
            const parent2Attrs = parent2.hiddenAttributes || { fire: 0, water: 0, wind: 0, earth: 0, light: 0, dark: 0 };
            
            const inheritedAttrs = {};
            for (let attr in parent1Attrs) {
                inheritedAttrs[attr] = Math.floor((parent1Attrs[attr] + parent2Attrs[attr]) / 4);
            }
            
            // ë¶€ëª¨ ìŠ¤íƒ¯ì˜ 25%ì”© = ì´ 50% ìƒì†
            const inheritedParams = {
                intelligence: Math.floor((parent1.parameters.intelligence + parent2.parameters.intelligence) / 4),
                strength: Math.floor((parent1.parameters.strength + parent2.parameters.strength) / 4),
                charm: Math.floor((parent1.parameters.charm + parent2.parameters.charm) / 4),
                affection: 10 // ì‚¬ë‘ì˜ ê²°ì‹¤ì´ë¯€ë¡œ ì• ì •ë„ ë³´ë„ˆìŠ¤
            };
            
            // ğŸ§¬ í‚¤ì›Œë“œ ìœ ì „ ì‹œìŠ¤í…œ
            const parent1Keywords = parent1.statusKeywords || [];
            const parent2Keywords = parent2.statusKeywords || [];
            const inheritedKeywords = [];
            
            // ìœ ì „ ê°€ëŠ¥í•œ í‚¤ì›Œë“œ ëª©ë¡
            const heritableKeywords = ['ë˜‘ë˜‘í•œ', 'ê°•í•œ', 'ë§¤ë ¥ì ì¸'];
            
            heritableKeywords.forEach(keyword => {
                const p1Has = parent1Keywords.includes(keyword);
                const p2Has = parent2Keywords.includes(keyword);
                
                if (p1Has && p2Has) {
                    // ì–‘ìª½ ë¶€ëª¨ ëª¨ë‘ ê°€ì§€ê³  ìˆìœ¼ë©´ 100% ìœ ì „
                    inheritedKeywords.push(keyword);
                } else if (p1Has || p2Has) {
                    // í•œìª½ë§Œ ê°€ì§€ê³  ìˆìœ¼ë©´ 50% í™•ë¥ ë¡œ ìœ ì „
                    if (Math.random() < 0.5) {
                        inheritedKeywords.push(keyword);
                    }
                }
            });
            
            // ìœ ì „ëœ í‚¤ì›Œë“œì— ë”°ë¥¸ ìŠ¤íƒ¯ ë³´ë„ˆìŠ¤
            if (inheritedKeywords.includes('ë˜‘ë˜‘í•œ')) {
                inheritedParams.intelligence += 15; // ì§€ë ¥ ë³´ë„ˆìŠ¤
            }
            if (inheritedKeywords.includes('ê°•í•œ')) {
                inheritedParams.strength += 15; // ì²´ë ¥ ë³´ë„ˆìŠ¤
            }
            if (inheritedKeywords.includes('ë§¤ë ¥ì ì¸')) {
                inheritedParams.charm += 15; // ë§¤ë ¥ ë³´ë„ˆìŠ¤
            }
            
            // ì´ë¦„ ìƒì„± (ë¶€ëª¨ ì´ë¦„ ê¸°ë°˜)
            const eggName = `${parent1.originalName}ì™€${parent2.originalName}ì˜ ì•Œ`;
            
            // ìœ ì „ í‚¤ì›Œë“œ ë¡œê·¸ ë©”ì‹œì§€
            let inheritLog = `ğŸ’• ${parent1.originalName}ì™€(ê³¼) ${parent2.originalName}ì˜ ì‚¬ë‘ìœ¼ë¡œ íƒœì–´ë‚¬ìŠµë‹ˆë‹¤.`;
            if (inheritedKeywords.length > 0) {
                inheritLog += ` ğŸ§¬ ìœ ì „ëœ íŠ¹ì„±: ${inheritedKeywords.join(', ')}`;
            }
            
            const spirit = {
                id: Date.now(),
                name: eggName,
                stage: 'egg',
                growth: 0,
                parameters: inheritedParams,
                hiddenAttributes: inheritedAttrs,
                satisfaction: 'high', // ì‚¬ë‘ë°›ëŠ” ì•„ì´
                lastFed: null,
                lastMusic: null,
                lastPat: null,
                lastDecorate: null,
                lastInteraction: Date.now(),
                status: 'ì‚¬ë‘ì˜ ê²°ì‹¤ë¡œ íƒœì–´ë‚œ ì•Œì´ì—ìš” ğŸ’•',
                birthTime: Date.now(),
                logs: [inheritLog],
                lightTime: 0,
                darkTime: 0,
                musicListened: 0,
                feedCount: 0,
                relationships: {},
                bond: null,
                isLoveChild: true, // ì—°ëª¨ ì•Œ í‘œì‹œ
                parents: [parent1.originalName, parent2.originalName],
                inheritedKeywords: inheritedKeywords // ìœ ì „ë°›ì€ í‚¤ì›Œë“œ ì €ì¥
            };
            
            spirits.push(spirit);
            saveGame();
            renderSpirits();
            
            // ìœ ì „ í‚¤ì›Œë“œì— ë”°ë¥¸ ì•Œë¦¼ ë©”ì‹œì§€
            let notification = `ğŸ’• ${eggName}ì´(ê°€) íƒœì–´ë‚¬ìŠµë‹ˆë‹¤! ë¶€ëª¨ì˜ ëŠ¥ë ¥ì„ ì¡°ê¸ˆ ë¬¼ë ¤ë°›ì•˜ì–´ìš”.`;
            if (inheritedKeywords.length > 0) {
                notification += ` ğŸ§¬ ìœ ì „: ${inheritedKeywords.join(', ')}`;
            }
            showNotification(notification);
        }

        function showAlbumDetail(index) {
            const item = collection[index];
            if (!item) return;
            
            // íŠœí† ë¦¬ì–¼2: ì•¨ë²” ìƒì„¸ ì—´ê¸° ì•¡ì…˜ ì²´í¬
            checkTutorialAction('openAlbumDetail');
            
            const modal = document.getElementById('albumDetailModal');
            const modalTitle = document.getElementById('modalTitle');
            const modalContent = document.getElementById('modalContent');
            
            // ìµœì‹  z-index ì ìš©
            modal.style.zIndex = getNextZIndex();
            
            modalTitle.textContent = item.name;
            
            // ì•„ì´ì½˜ì„ ìµœì‹  ë²„ì „ìœ¼ë¡œ ì—…ë°ì´íŠ¸
            let itemIcon = item.icon;
            
            // ì´ë²¤íŠ¸ ì •ë ¹ì¸ ê²½ìš° ìµœì‹  ì•„ì´ì½˜ìœ¼ë¡œ ì—…ë°ì´íŠ¸
            if (item.type && item.type.startsWith('event_')) {
                const typeParts = item.type.replace('event_', '').split('_');
                const eventKey = typeParts[0];
                const isShiny = typeParts.includes('shiny');
                
                // wingType ê²°ì •: ì €ì¥ëœ ê°’ > typeì—ì„œ ì¶”ì¶œ > lightTime/darkTimeìœ¼ë¡œ ê³„ì‚° > ê¸°ë³¸ê°’
                let wingType = item.wingType;
                if (!wingType) {
                    if (typeParts.includes('butterfly')) {
                        wingType = 'butterfly';
                    } else if (typeParts.includes('moth')) {
                        wingType = 'moth';
                    } else if (item.lightTime !== undefined && item.darkTime !== undefined) {
                        wingType = item.lightTime > item.darkTime ? 'butterfly' : 'moth';
                    } else {
                        wingType = 'butterfly';
                    }
                }
                
                const event = EVENT_TYPES[eventKey];
                if (event) {
                    const stages = isShiny && event.shiny ? event.shiny.stages : event.stages;
                    if (stages && stages.adult) {
                        if (typeof stages.adult === 'object' && stages.adult.butterfly) {
                            itemIcon = stages.adult[wingType] || stages.adult.butterfly;
                        } else {
                            itemIcon = stages.adult;
                        }
                    }
                }
            }
            // ì¼ë°˜ ì •ë ¹(ATTRIBUTE_NAMES)ì¸ ê²½ìš°ë„ ìµœì‹  ì•„ì´ì½˜ìœ¼ë¡œ ì—…ë°ì´íŠ¸
            // attributeTypeì„ í™•ì¸í•´ì•¼ í•¨ (typeì€ ìŠ¤íƒ¯ ë ˆë²¨ì„)
            // ì´ë²¤íŠ¸ ì •ë ¹ì´ ì•„ë‹Œ ê²½ìš°ì—ë§Œ ì ìš©
            else if (item.attributeType && ATTRIBUTE_NAMES[item.attributeType]) {
                const attrData = ATTRIBUTE_NAMES[item.attributeType];
                if (attrData && attrData.icon) {
                    // wingType ê²°ì •
                    let wingType = item.wingType;
                    if (!wingType) {
                        if (item.lightTime !== undefined && item.darkTime !== undefined) {
                            wingType = item.lightTime > item.darkTime ? 'butterfly' : 'moth';
                        } else {
                            wingType = 'butterfly';
                        }
                    }
                    
                    // ì´ë¯¸ì§€ê°€ ìˆëŠ” ê²½ìš° (butterfly/moth êµ¬ë¶„)
                    if (typeof attrData.icon === 'object' && attrData.icon.butterfly) {
                        itemIcon = attrData.icon[wingType] || attrData.icon.butterfly;
                    } else {
                        itemIcon = attrData.icon;
                    }
                }
            }
            // í•©ì„± ì •ë ¹(FUSION_TYPES)ì¸ ê²½ìš°ë„ ìµœì‹  ì•„ì´ì½˜ìœ¼ë¡œ ì—…ë°ì´íŠ¸
            else if (item.type && FUSION_TYPES[item.type]) {
                const fusionData = FUSION_TYPES[item.type];
                if (fusionData && fusionData.icon) {
                    itemIcon = fusionData.icon;
                }
            }
            
            // ë‚ ê°œ ì •ë³´
            let wingInfo = '';
            if (item.wingType === 'butterfly') {
                wingInfo = 'ğŸ¦‹ ë‚˜ë¹„ì˜ ë‚ ê°œ';
            } else if (item.wingType === 'moth') {
                wingInfo = 'ğŸ¦‹ ë‚˜ë°©ì˜ ë‚ ê°œ';
            }
            
            // ì¡°ëª… ì‹œê°„ ê³„ì‚°
            const lightMinutes = Math.floor((item.lightTime || 0) / 60);
            const darkMinutes = Math.floor((item.darkTime || 0) / 60);
            
            // ì†ì„± ì •ë³´
            const hiddenAttrs = item.hiddenAttributes || { fire: 0, water: 0, wind: 0, earth: 0, light: 0, dark: 0 };
            
            // ì• ì •ë„ ì²´í¬
            const affection = item.parameters?.affection || 0;
            const canBreed = affection >= 50;
            
            // ê°–ê³ ìˆë˜ ìƒíƒœ í‚¤ì›Œë“œ í‘œì‹œ
            let keywordsHtml = '';
            const allStatusKeywords = item.allStatusKeywords || [];
            
            // ê¸°ì¡´ ë°ì´í„° í˜¸í™˜ (allStatusKeywordsê°€ ì—†ëŠ” ê²½ìš°)
            if (allStatusKeywords.length === 0) {
                const statusKeywords = item.statusKeywords || [];
                const inheritedKeywords = item.inheritedKeywords || [];
                inheritedKeywords.forEach(kw => allStatusKeywords.push(`ğŸ§¬ ${kw}`));
                statusKeywords.forEach(kw => {
                    if (!inheritedKeywords.includes(kw)) allStatusKeywords.push(kw);
                });
            }
            
            if (allStatusKeywords.length > 0) {
                const keywordTags = allStatusKeywords.map(kw => {
                    if (kw.startsWith('ğŸ§¬')) {
                        return `<span style="display: inline-block; padding: 4px 10px; background: linear-gradient(135deg, #9c27b0, #673ab7); color: white; border-radius: 12px; font-size: 0.8rem; margin: 2px;">${kw}</span>`;
                    } else {
                        return `<span style="display: inline-block; padding: 4px 10px; background: var(--card); border: 1px solid var(--border); color: var(--text); border-radius: 12px; font-size: 0.8rem; margin: 2px;">${kw}</span>`;
                    }
                });
                
                keywordsHtml = `
                    <div style="background: var(--bg); padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                        <h3 style="font-size: 1rem; margin-bottom: 10px; color: var(--text);">ğŸ·ï¸ ê°–ê³ ìˆë˜ ìƒíƒœ</h3>
                        <div style="display: flex; flex-wrap: wrap; gap: 4px;">
                            ${keywordTags.join('')}
                        </div>
                    </div>
                `;
            }
            
            modalContent.innerHTML = `
                <div style="text-align: center; margin-bottom: 20px;">
                    <div style="font-size: 4rem; margin-bottom: 10px;">${itemIcon && itemIcon.includes('<img') ? itemIcon.replace(/width:\d+px;height:(auto|\d+px)/g, 'width:auto;height:auto') : (itemIcon + (wingInfo ? 'ğŸ¦‹' : ''))}</div>
                    <div style="font-size: 0.9rem; color: var(--text-muted);">ë³¸ëª…: ${item.originalName || 'ì´ë¦„ ì—†ìŒ'}</div>
                    ${wingInfo ? `<div style="font-size: 0.9rem; color: var(--text-muted); margin-top: 4px;">${wingInfo}</div>` : ''}
                    ${item.desc ? `<div style="font-size: 0.9rem; color: var(--text-muted); margin-top: 8px; line-height: 1.4; font-style: italic;">"${item.desc}"</div>` : ''}
                </div>
                
                <div style="background: var(--bg); padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                    <h3 style="font-size: 1rem; margin-bottom: 10px; color: var(--text);">ğŸ“Š ê¸°ë³¸ ìŠ¤íƒ¯</h3>
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px;">
                        <div class="param">ğŸ§  ì§€ë ¥: ${item.parameters.intelligence}</div>
                        <div class="param">ğŸ’ª ì²´ë ¥: ${item.parameters.strength}</div>
                        <div class="param">ğŸ’– ë§¤ë ¥: ${item.parameters.charm}</div>
                        <div class="param">â¤ï¸ ì• ì •ë„: ${affection}</div>
                    </div>
                </div>
                
                <div style="background: var(--bg); padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                    <h3 style="font-size: 1rem; margin-bottom: 10px; color: var(--text);">ğŸŒˆ ì†ì„±</h3>
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px;">
                        <div style="font-size: 0.85rem; padding: 8px; background: var(--card); border-radius: 4px;">ğŸ”¥ í™”: ${hiddenAttrs.fire}</div>
                        <div style="font-size: 0.85rem; padding: 8px; background: var(--card); border-radius: 4px;">ğŸ’§ ìˆ˜: ${hiddenAttrs.water}</div>
                        <div style="font-size: 0.85rem; padding: 8px; background: var(--card); border-radius: 4px;">ğŸŒ¬ï¸ í’: ${hiddenAttrs.wind}</div>
                        <div style="font-size: 0.85rem; padding: 8px; background: var(--card); border-radius: 4px;">ğŸŒ± ì§€: ${hiddenAttrs.earth}</div>
                        <div style="font-size: 0.85rem; padding: 8px; background: var(--card); border-radius: 4px;">âœ¨ ë¹›: ${hiddenAttrs.light}</div>
                        <div style="font-size: 0.85rem; padding: 8px; background: var(--card); border-radius: 4px;">ğŸŒ™ ì•”: ${hiddenAttrs.dark}</div>
                    </div>
                </div>
                
                <div style="background: var(--bg); padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                    <h3 style="font-size: 1rem; margin-bottom: 10px; color: var(--text);">â±ï¸ ìœ¡ì„± ì •ë³´</h3>
                    <div style="font-size: 0.85rem; line-height: 1.6;">
                        <div>â˜€ï¸ ë¹› ì‹œê°„: ${lightMinutes}ë¶„</div>
                        <div>ğŸŒ™ ì–´ë‘  ì‹œê°„: ${darkMinutes}ë¶„</div>
                        <div style="margin-top: 8px; color: #888;">ë“±ë¡ ë‚ ì§œ: ${new Date(item.completedAt).toLocaleString('ko-KR')}</div>
                    </div>
                </div>
                
                ${keywordsHtml}
                
                <!-- ì—°ê²° ì„¹ì…˜ -->
                <div id="breedSection" style="background: linear-gradient(135deg, rgba(102, 126, 234, 0.1), rgba(118, 75, 162, 0.1)); padding: 15px; border-radius: 8px; border: 1px solid rgba(102, 126, 234, 0.3);">
                    <h3 style="font-size: 1rem; margin-bottom: 10px; color: var(--text);">ğŸ§¬ ì—°ê²°</h3>
                    ${canBreed ? `
                        <p style="font-size: 0.85rem; color: #888; margin-bottom: 12px;">ì´ ì •ë ¹ì˜ ì½”ë“œë¥¼ ê³µìœ í•´ ë‹¤ë¥¸ ì •ë ¹ê³¼ ì—°ê²°í•  ìˆ˜ ìˆì–´ìš”.</p>
                        <div style="display: flex; gap: 8px;">
                            <button onclick="openBreedCodeModal(${index})" style="flex: 1; padding: 10px; background: linear-gradient(135deg, #667eea, #764ba2); color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 0.9rem;">
                                ğŸ“¤ ì½”ë“œ ìƒì„±
                            </button>
                            <button onclick="openBreedWithCodeModal(${index})" style="flex: 1; padding: 10px; background: linear-gradient(135deg, #11998e, #38ef7d); color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 0.9rem;">
                                ğŸ“¥ ì—°ê²°í•˜ê¸°
                            </button>
                        </div>
                    ` : `
                        <p style="font-size: 0.85rem; color: #e74c3c;">â¤ï¸ ì• ì •ë„ 50 ì´ìƒì´ì–´ì•¼ ì—°ê²°í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. (í˜„ì¬: ${affection})</p>
                    `}
                </div>
            `;
            
            modal.style.display = 'flex';
        }
        
        // ì—°ê²° ì½”ë“œ ìƒì„± ëª¨ë‹¬
        function openBreedCodeModal(albumIndex) {
            const item = collection[albumIndex];
            if (!item) return;
            
            // ì•¨ë²” ì•„ì´í…œì— idê°€ ì—†ìœ¼ë©´ ìƒì„±
            const spiritForCode = {
                ...item,
                id: item.id || `album-${albumIndex}`,
                attributes: item.hiddenAttributes || {},
                albumIndex: albumIndex  // ìê¸° ìì‹  ì—°ê²° ë°©ì§€ìš©
            };
            
            const code = encodeSpiritData(spiritForCode);
            
            const modal = document.createElement('div');
            modal.id = 'breedCodeModal';
            const zIndex = getNextZIndex();
            modal.style.cssText = `position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: ${zIndex}; display: flex; justify-content: center; align-items: center;`;
            modal.innerHTML = `
                <div style="background: var(--card); padding: 24px; border-radius: 12px; max-width: 400px; width: 90%; border: 1px solid var(--border);">
                    <h3 style="margin-bottom: 16px;">ğŸ“¤ ì—°ê²° ì½”ë“œ ìƒì„±</h3>
                    <div style="text-align: center; margin-bottom: 16px;">
                        <div style="font-size: 2.5rem;">${item.icon}</div>
                        <div style="font-weight: 700;">${item.name}</div>
                    </div>
                    <div style="margin-bottom: 12px;">
                        <input type="text" id="generatedBreedCode" value="${code}" readonly style="width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 6px; background: var(--bg); color: var(--text); font-family: monospace; font-size: 0.8rem; box-sizing: border-box;">
                    </div>
                    <button onclick="copyGeneratedCode()" style="width: 100%; padding: 12px; background: var(--water); color: white; border: none; border-radius: 6px; cursor: pointer; margin-bottom: 8px;">
                        ğŸ“‹ ì½”ë“œ ë³µì‚¬
                    </button>
                    <p style="font-size: 0.8rem; color: #888; text-align: center; margin-bottom: 12px;">ğŸ“‹ ì½”ë“œëŠ” 1íšŒë§Œ ì‚¬ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤</p>
                    <button onclick="closeBreedCodeModal()" style="width: 100%; padding: 10px; background: var(--card); border: 1px solid var(--border); border-radius: 6px; cursor: pointer;">
                        ë‹«ê¸°
                    </button>
                </div>
            `;
            document.body.appendChild(modal);
        }
        
        function copyGeneratedCode() {
            const input = document.getElementById('generatedBreedCode');
            input.select();
            document.execCommand('copy');
            showNotification('ğŸ“‹ ì½”ë“œê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!');
        }
        
        function closeBreedCodeModal() {
            const modal = document.getElementById('breedCodeModal');
            if (modal) modal.remove();
        }
        
        // ì—°ê²°í•˜ê¸° ëª¨ë‹¬
        function openBreedWithCodeModal(albumIndex) {
            const item = collection[albumIndex];
            if (!item) return;
            
            const modal = document.createElement('div');
            modal.id = 'breedWithCodeModal';
            const zIndex = getNextZIndex();
            modal.style.cssText = `position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: ${zIndex}; display: flex; justify-content: center; align-items: center;`;
            modal.innerHTML = `
                <div style="background: var(--card); padding: 24px; border-radius: 12px; max-width: 450px; width: 90%; max-height: 80vh; overflow-y: auto; border: 1px solid var(--border);">
                    <h3 style="margin-bottom: 16px;">ì •ë ¹ ì½”ë“œë¡œ ì—°ê²°</h3>
                    <div style="display: flex; align-items: center; gap: 12px; padding: 12px; background: var(--bg); border-radius: 8px; margin-bottom: 16px;">
                        <div style="font-size: 2rem;">${item.icon}</div>
                        <div>
                            <div style="font-weight: 700;">${item.name}</div>
                            <div style="font-size: 0.85rem; color: #888;">ë‚´ ì •ë ¹</div>
                        </div>
                    </div>
                    <div style="margin-bottom: 12px;">
                        <input type="text" id="friendBreedCodeInput" placeholder="ì •ë ¹ ì½”ë“œ ì…ë ¥..." style="width: 100%; padding: 12px; border: 1px solid var(--border); border-radius: 6px; background: var(--bg); color: var(--text); font-family: monospace; box-sizing: border-box;">
                    </div>
                    <div id="friendBreedPreview" style="display: none; padding: 12px; background: var(--bg); border-radius: 8px; margin-bottom: 12px;"></div>
                    <div id="breedResultPreview" style="display: none; padding: 12px; background: linear-gradient(135deg, rgba(255,215,0,0.1), rgba(255,255,255,0.05)); border-radius: 8px; margin-bottom: 12px; text-align: center;"></div>
                    <button onclick="executeBreedFromAlbum(${albumIndex})" style="width: 100%; padding: 12px; background: linear-gradient(135deg, #667eea, #764ba2); color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 1rem; margin-bottom: 8px;">
                        ğŸ§¬ ì—°ê²°í•˜ê¸° (50ğŸ’°)
                    </button>
                    <p style="font-size: 0.8rem; color: #888; text-align: center; margin-bottom: 12px;">ë‚´ ì •ë ¹ì€ ìœ ì§€ë˜ê³ , ìƒˆë¡œìš´ ì•Œì´ íƒœì–´ë‚©ë‹ˆë‹¤!</p>
                    <button onclick="closeBreedWithCodeModal()" style="width: 100%; padding: 10px; background: var(--card); border: 1px solid var(--border); border-radius: 6px; cursor: pointer;">
                        ë‹«ê¸°
                    </button>
                </div>
            `;
            document.body.appendChild(modal);
            
            // ì½”ë“œ ì…ë ¥ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
            setTimeout(() => {
                const input = document.getElementById('friendBreedCodeInput');
                if (input) {
                    input.addEventListener('input', () => updateBreedPreviewInModal(albumIndex));
                }
            }, 100);
        }
        
        function closeBreedWithCodeModal() {
            const modal = document.getElementById('breedWithCodeModal');
            if (modal) modal.remove();
        }
        
        function updateBreedPreviewInModal(albumIndex) {
            const item = collection[albumIndex];
            const codeInput = document.getElementById('friendBreedCodeInput');
            const friendPreview = document.getElementById('friendBreedPreview');
            const resultPreview = document.getElementById('breedResultPreview');
            
            const code = codeInput.value.trim();
            if (!code) {
                friendPreview.style.display = 'none';
                resultPreview.style.display = 'none';
                return;
            }
            
            const friendData = decodeSpiritData(code);
            if (!friendData) {
                friendPreview.innerHTML = 'âŒ ìœ íš¨í•˜ì§€ ì•Šì€ ì½”ë“œì…ë‹ˆë‹¤.';
                friendPreview.style.display = 'block';
                friendPreview.style.color = '#e74c3c';
                resultPreview.style.display = 'none';
                return;
            }
            
            // ìê¸° ìì‹  ì²´í¬ - ê³ ìœ  ID ë¹„êµ (IDê°€ ìˆìœ¼ë©´ IDë¡œ, ì—†ìœ¼ë©´ ìŠ¤íƒ¯ ë¹„êµ)
            const isSameSpirit = (myItem, friend) => {
                // ë‘˜ ë‹¤ IDê°€ ìˆìœ¼ë©´ IDë¡œ ë¹„êµ
                if (myItem.id && friend.id) {
                    return myItem.id === friend.id;
                }
                // IDê°€ ì—†ìœ¼ë©´ í•µì‹¬ ë°ì´í„°ë¡œ ë¹„êµ (í•˜ìœ„ í˜¸í™˜ì„±)
                return myItem.name === friend.name &&
                       (myItem.originalName || myItem.name) === (friend.originalName || friend.name) &&
                       (myItem.attributeType || myItem.attribute) === friend.attribute &&
                       (myItem.parameters?.intelligence || 0) === (friend.parameters?.intelligence || 0) &&
                       (myItem.parameters?.strength || 0) === (friend.parameters?.strength || 0) &&
                       (myItem.parameters?.charm || 0) === (friend.parameters?.charm || 0);
            };
            
            if (isSameSpirit(item, friendData)) {
                friendPreview.innerHTML = 'âŒ ìê¸° ìì‹ ê³¼ëŠ” ì—°ê²°í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.';
                friendPreview.style.display = 'block';
                friendPreview.style.color = '#e74c3c';
                resultPreview.style.display = 'none';
                return;
            }
            
            const attr = ATTRIBUTE_NAMES[friendData.attribute] || ATTRIBUTE_NAMES.normal;
            const friendAttrs = friendData.attributes || {};
            const attrDisplay = [];
            ['fire', 'water', 'wind', 'earth', 'light', 'dark'].forEach(a => {
                if (friendAttrs[a] && friendAttrs[a] > 0) {
                    attrDisplay.push(`${ENV_ICONS[a]}${friendAttrs[a]}`);
                }
            });
            
            const originalNameDisplay = (friendData.originalName && friendData.originalName !== friendData.name) 
                ? `<div style="color: #aaa; font-size: 0.8rem; font-style: italic;">ë³¸ëª…: ${friendData.originalName}</div>` 
                : '';
            
            // í‚¤ì›Œë“œ í‘œì‹œ
            let keywordsDisplay = '';
            if (friendData.keywords && friendData.keywords.length > 0) {
                const keywordTags = friendData.keywords.map(kw => {
                    const kwData = STATUS_KEYWORDS[kw];
                    if (kwData) {
                        return `<span style="display: inline-block; padding: 2px 6px; background: rgba(100,100,100,0.3); border-radius: 4px; font-size: 0.75rem; margin: 2px;">${kwData.name}</span>`;
                    }
                    return '';
                }).filter(x => x).join('');
                if (keywordTags) {
                    keywordsDisplay = `<div style="margin-top: 6px;">${keywordTags}</div>`;
                }
            }
            
            friendPreview.innerHTML = `
                <div style="flex: 1;">
                    <div style="font-weight: 700;">âœ… ${friendData.name}</div>
                    ${originalNameDisplay}
                    <div style="font-size: 0.85rem; color: #888;">${attr.name}</div>
                    <div style="font-size: 0.85rem; margin-top: 4px;">
                        ğŸ§ ${friendData.parameters.intelligence} | ğŸ’ª${friendData.parameters.strength} | ğŸ’–${friendData.parameters.charm}
                    </div>
                    ${attrDisplay.length > 0 ? `<div style="font-size: 0.8rem; margin-top: 4px;">${attrDisplay.join(' ')}</div>` : ''}
                    ${keywordsDisplay}
                </div>
            `;
            friendPreview.style.display = 'block';
            friendPreview.style.color = 'var(--text)';
            
            // ì˜ˆìƒ ê²°ê³¼ ê³„ì‚°
            const mySpirit = {
                ...item,
                attributes: item.hiddenAttributes || {}
            };
            const prediction = predictBreedResult(mySpirit, friendData);
            
            // ì˜ˆìƒ ìƒì† ìŠ¤íƒ¯
            const inheritParams = {
                intelligence: Math.floor(((item.parameters?.intelligence || 0) + (friendData.parameters?.intelligence || 0)) / 2),
                strength: Math.floor(((item.parameters?.strength || 0) + (friendData.parameters?.strength || 0)) / 2),
                charm: Math.floor(((item.parameters?.charm || 0) + (friendData.parameters?.charm || 0)) / 2)
            };
            
            // ì•„ì´ì½˜ ì²˜ë¦¬ (ê°ì²´ë©´ ë‚˜ë¹„ ì•„ì´ì½˜ ì‚¬ìš©)
            let displayIcon = prediction.icon;
            if (typeof displayIcon === 'object' && displayIcon !== null) {
                displayIcon = displayIcon.butterfly || 'ğŸ¥š';
            }
            // ì´ë¯¸ì§€ íƒœê·¸ë©´ ì´ëª¨ì§€ë¡œ ëŒ€ì²´
            if (typeof displayIcon === 'string' && displayIcon.includes('<img')) {
                displayIcon = 'ğŸ¥š';
            }
            
            // ë¯¸ë°œê²¬ ì •ë ¹ ì²´í¬ (ë„ê°ì— ì—†ìœ¼ë©´ ë¯¸ë°œê²¬)
            let isDiscovered = false;
            let displayName = prediction.name;
            if (prediction.key) {
                // fusion ì •ë ¹
                isDiscovered = encyclopedia[prediction.key] && encyclopedia[prediction.key] > 0;
            } else if (prediction.isEventResult && prediction.eventType) {
                // ì´ë²¤íŠ¸ ì •ë ¹
                const eventKeys = [`event_${prediction.eventType}`, `event_${prediction.eventType}_butterfly`, `event_${prediction.eventType}_moth`];
                isDiscovered = eventKeys.some(key => encyclopedia[key] && encyclopedia[key] > 0);
            }
            
            if (!isDiscovered && prediction.key) {
                displayName = '???';
                displayIcon = 'â“';
            }
            
            resultPreview.innerHTML = `
                <div style="font-size: 0.85rem; color: #888; margin-bottom: 8px;">ğŸ¥š ì˜ˆìƒ ê²°ê³¼</div>
                <div style="font-size: 2rem;">${displayIcon}</div>
                <div style="font-weight: 700; margin: 4px 0;">${displayName}${!isDiscovered && prediction.key ? ' <span style="font-size: 0.75rem; color: #e67e22;">(ë¯¸ë°œê²¬)</span>' : ''}</div>
                <div style="font-size: 0.8rem; color: ${getRarityColor(prediction.rarity)}; margin-bottom: 8px;">${getRarityText(prediction.rarity)}</div>
                <div style="font-size: 0.8rem; color: #888;">
                    ğŸ“Š ìƒì† ìŠ¤íƒ¯: ğŸ§ ${inheritParams.intelligence} | ğŸ’ª${inheritParams.strength} | ğŸ’–${inheritParams.charm}
                </div>
            `;
            resultPreview.style.display = 'block';
        }
        
        async function executeBreedFromAlbum(albumIndex) {
            const item = collection[albumIndex];
            if (!item) return;
            
            const codeInput = document.getElementById('friendBreedCodeInput');
            const breedCode = codeInput.value.trim();
            
            if (!breedCode) {
                showNotification('âŒ ì •ë ¹ ì½”ë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”');
                return;
            }
            
            // ì •ë ¹ ìŠ¬ë¡¯ ì²´í¬
            if (spirits.length >= 6) {
                showNotification('âŒ ì •ì›ì´ ê°€ë“ ì°¼ìŠµë‹ˆë‹¤! (ìµœëŒ€ 6ë§ˆë¦¬)');
                return;
            }
            
            // ì¤‘ë³µ ì½”ë“œ ì²´í¬
            const allSpiritsAndAlbum = [...spirits, ...(collection || [])];
            const usedCode = allSpiritsAndAlbum.find(s => s.breedCode === breedCode);
            if (usedCode) {
                showNotification('âŒ ì´ë¯¸ ì‚¬ìš©ëœ ì •ë ¹ ì½”ë“œì…ë‹ˆë‹¤!');
                return;
            }
            
            const friendData = decodeSpiritData(breedCode);
            if (!friendData) {
                showNotification('âŒ ìœ íš¨í•˜ì§€ ì•Šì€ ì½”ë“œì…ë‹ˆë‹¤');
                return;
            }
            
            // ìê¸° ìì‹ ê³¼ ì—°ê²° ë°©ì§€ - ê³ ìœ  ID ë¹„êµ
            const isSameSpirit = (myItem, friend) => {
                // ë‘˜ ë‹¤ IDê°€ ìˆìœ¼ë©´ IDë¡œ ë¹„êµ
                if (myItem.id && friend.id) {
                    return myItem.id === friend.id;
                }
                // IDê°€ ì—†ìœ¼ë©´ í•µì‹¬ ë°ì´í„°ë¡œ ë¹„êµ (í•˜ìœ„ í˜¸í™˜ì„±)
                return myItem.name === friend.name &&
                       (myItem.originalName || myItem.name) === (friend.originalName || friend.name) &&
                       (myItem.attributeType || myItem.attribute) === friend.attribute &&
                       (myItem.parameters?.intelligence || 0) === (friend.parameters?.intelligence || 0) &&
                       (myItem.parameters?.strength || 0) === (friend.parameters?.strength || 0) &&
                       (myItem.parameters?.charm || 0) === (friend.parameters?.charm || 0);
            };
            
            if (isSameSpirit(item, friendData)) {
                showNotification('âŒ ìê¸° ìì‹ ê³¼ëŠ” ì—°ê²°í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤!');
                return;
            }
            
            if (coins < BREED_COST) {
                showNotification(`âŒ ì½”ì¸ì´ ë¶€ì¡±í•©ë‹ˆë‹¤ (í•„ìš”: ${BREED_COST}ğŸ’°)`);
                return;
            }
            
            const mySpirit = {
                ...item,
                attributes: item.hiddenAttributes || {},
                type: item.type,
                attributeType: item.attributeType
            };
            const prediction = predictBreedResult(mySpirit, friendData);
            
            // ì—°ê²° ë¶ˆê°€ëŠ¥í•œ ì¡°í•©ì¸ ê²½ìš°
            if (prediction.cannotBreed) {
                showNotification(`âŒ ${prediction.desc}`);
                return;
            }
            
            // ë¨¼ì € ëª¨ë“  ì°½ ë‹«ê¸°
            closeBreedWithCodeModal();
            closeAlbumDetail();
            
            // ë¯¸ë°œê²¬ ì •ë ¹ ì²´í¬
            let isDiscovered = false;
            let displayName = prediction.name;
            if (prediction.key) {
                isDiscovered = encyclopedia[prediction.key] && encyclopedia[prediction.key] > 0;
            } else if (prediction.isEventResult && prediction.eventType) {
                const eventKeys = [`event_${prediction.eventType}`, `event_${prediction.eventType}_butterfly`, `event_${prediction.eventType}_moth`];
                isDiscovered = eventKeys.some(key => encyclopedia[key] && encyclopedia[key] > 0);
            }
            if (!isDiscovered && prediction.key) {
                displayName = '??? (ë¯¸ë°œê²¬)';
            }
            
            const confirmed = await showConfirm('ì—°ê²° í™•ì¸',
                `${item.name}ì™€(ê³¼) ${friendData.name}ì„(ë¥¼) ì—°ê²°í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nì˜ˆìƒ ê²°ê³¼: ${displayName} (${getRarityText(prediction.rarity)})\në¹„ìš©: ${BREED_COST}ğŸ’°`);
            
            if (!confirmed) return;
            
            // ì—°ê²° ê²°ê³¼ ê³„ì‚° (ë¶€ëª¨ ìŠ¤íƒ¯ì˜ 25%ì”© = ì´ 50% ìƒì†)
            const newParams = {
                intelligence: Math.floor(((item.parameters?.intelligence || 0) + (friendData.parameters?.intelligence || 0)) / 4),
                strength: Math.floor(((item.parameters?.strength || 0) + (friendData.parameters?.strength || 0)) / 4),
                charm: Math.floor(((item.parameters?.charm || 0) + (friendData.parameters?.charm || 0)) / 4),
                affection: 0
            };
            
            const myAttrs = item.hiddenAttributes || {};
            const friendAttrs = friendData.attributes || {};
            const newAttrs = {};
            ['fire', 'water', 'wind', 'earth', 'light', 'dark'].forEach(attr => {
                // ë¶€ëª¨ ì†ì„±ì˜ 25%ì”© = ì´ 50% ìƒì†
                const avg = Math.floor(((myAttrs[attr] || 0) + (friendAttrs[attr] || 0)) / 4);
                if (avg > 0) newAttrs[attr] = avg;
            });
            
            const isFusionType = prediction.key && FUSION_TYPES[prediction.key];
            const isEventResult = prediction.isEventResult && prediction.eventType;
            
            const timestamp = new Date().toLocaleString('ko-KR', {
                month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit'
            });
            
            const inheritInfo = [];
            if (newParams.intelligence > 0) inheritInfo.push(`ğŸ§ ${newParams.intelligence}`);
            if (newParams.strength > 0) inheritInfo.push(`ğŸ’ª${newParams.strength}`);
            if (newParams.charm > 0) inheritInfo.push(`ğŸ’–${newParams.charm}`);
            const attrInfo = Object.entries(newAttrs).map(([k, v]) => `${ENV_ICONS[k]}${v}`).join(' ');
            
            let newSpirit;
            
            if (isEventResult) {
                // ì´ë²¤íŠ¸ ì •ë ¹ ì—°ê²° ê²°ê³¼
                const event = EVENT_TYPES[prediction.eventType];
                newSpirit = {
                    id: Date.now(),
                    name: event.name,
                    originalName: event.name,
                    growth: 0,
                    parameters: newParams,
                    hiddenAttributes: {
                        fire: 0, water: 0, wind: 0, earth: 0, light: 0, dark: 0
                    },
                    satisfaction: 'mid',
                    lastFed: null,
                    lastMusic: null,
                    lastPat: null,
                    lastDecorate: null,
                    lastInteraction: Date.now(),
                    status: 'íŠ¹ë³„í•œ ì•Œì´ ë¹›ë‚˜ê³  ìˆìŠµë‹ˆë‹¤...',
                    birthTime: Date.now(),
                    logs: [
                        { time: timestamp, message: `ğŸ„ ${item.name}ì™€(ê³¼) ${friendData.name}ì˜ ì—°ê²°ë¡œ íŠ¹ë³„í•œ ì•Œì´ íƒœì–´ë‚¬ìŠµë‹ˆë‹¤!` },
                        { time: timestamp, message: `ğŸ“Š ë¶€ëª¨ì—ê²Œì„œ ë¬¼ë ¤ë°›ì€ ëŠ¥ë ¥: ${inheritInfo.join(' ')}` }
                    ],
                    lightTime: 0,
                    darkTime: 0,
                    musicListened: 0,
                    feedCount: 0,
                    bredWith: friendData.name,
                    breedCode: breedCode,
                    isBred: true,
                    isEventSpirit: true,
                    eventType: prediction.eventType
                };
            } else {
                // ì¼ë°˜ ì—°ê²° ê²°ê³¼
                const breedEggName = `${item.name}ì™€${friendData.name}ì˜ ì•Œ`;
                newSpirit = {
                    id: Date.now(),
                    name: breedEggName,
                    originalName: null,
                    growth: 0,
                    parameters: newParams,
                    hiddenAttributes: {
                        fire: newAttrs.fire || 0,
                        water: newAttrs.water || 0,
                        wind: newAttrs.wind || 0,
                        earth: newAttrs.earth || 0,
                        light: newAttrs.light || 0,
                        dark: newAttrs.dark || 0
                    },
                    satisfaction: 'mid',
                    lastFed: null,
                    lastMusic: null,
                    lastPat: null,
                    lastDecorate: null,
                    lastInteraction: Date.now(),
                    status: 'ì•Œì´ ë”°ëœ»í•©ë‹ˆë‹¤...',
                    birthTime: Date.now(),
                    logs: [
                        { time: timestamp, message: `ğŸ”— ${item.name}ì™€(ê³¼) ${friendData.name}ì˜ ì—°ê²°ë¡œ íƒœì–´ë‚¬ìŠµë‹ˆë‹¤.` },
                        { time: timestamp, message: `ğŸ“Š ë¶€ëª¨ì—ê²Œì„œ ë¬¼ë ¤ë°›ì€ ëŠ¥ë ¥: ${inheritInfo.join(' ')} ${attrInfo}` }
                    ],
                    lightTime: 0,
                    darkTime: 0,
                    musicListened: 0,
                    feedCount: 0,
                    bredWith: friendData.name,
                    breedCode: breedCode,
                    fusionType: prediction.key || null,
                    fusionRarity: prediction.rarity || 'common',
                    isBred: true
                };
            }
            
            spirits.push(newSpirit);
            coins -= BREED_COST;
            
            if (isFusionType && prediction.key) {
                if (!encyclopedia[prediction.key]) {
                    encyclopedia[prediction.key] = 1;
                    showNotification(`ğŸ‰ ìƒˆë¡œìš´ ì—°ê²° ì •ë ¹ "${prediction.name}" ë„ê° ë“±ë¡!`);
                } else {
                    encyclopedia[prediction.key]++;
                }
            }
            
            saveGame();
            renderSpirits();
            updateCoinDisplay();
            
            showNotification(`ğŸ‰ ì—°ê²° ì„±ê³µ! ${newSpirit.name}ì´(ê°€) íƒœì–´ë‚¬ìŠµë‹ˆë‹¤!`);
            switchTab('garden');
        }
        
        function closeAlbumDetail() {
            const modal = document.getElementById('albumDetailModal');
            modal.style.display = 'none';
        }

        function applyGrowth() {
            if (isPaused) return; // ì¼ì‹œì •ì§€ ì¤‘ì´ë©´ ì„±ì¥ ì•ˆ í•¨
            if (tutorialActive) return; // ì²« íŠœí† ë¦¬ì–¼ ì¤‘ì´ë©´ ì„±ì¥ ì•ˆ í•¨
            
            spirits.forEach(spirit => {
                if (spirit.isDead || spirit.isCompleted) return;
                
                // ì§ˆë³‘ ìƒíƒœë©´ ì„±ì¥ ë©ˆì¶¤
                if (spirit.isSick) return;

                // ì„±ì¥ë„ +1
                const previousGrowth = spirit.growth;
                let growthAmount = 1;
                
                spirit.growth += growthAmount;

                console.log(`Spirit ${spirit.name}: growth ${previousGrowth} â†’ ${spirit.growth}`);

                // ì„±ì¶© ì²´í¬ (100 ì´ìƒì´ë©´ ë¬´ì¡°ê±´ ì™„ë£Œ)
                if (spirit.growth >= STAGE_REQUIREMENTS.adult) {
                    console.log(`Completing spirit ${spirit.name} with growth ${spirit.growth}`);
                    completeSpirit(spirit);
                }
            });

            saveGame();
            updateAllSpiritCards();
        }

        function applyTerrariumGrowth() {
            if (isPaused) return; // ì¼ì‹œì •ì§€ ì¤‘ì´ë©´ ì‹¤í–‰ ì•ˆ í•¨
            if (tutorialActive) return; // ì²« íŠœí† ë¦¬ì–¼ ì¤‘ì´ë©´ ì‹¤í–‰ ì•ˆ í•¨
            
            spirits.forEach(spirit => {
                if (spirit.isDead || spirit.isCompleted) return;  // ì£½ì—ˆê±°ë‚˜ ì™„ì„±ëœ ì •ë ¹ ì œì™¸

                // ì¡°ëª… ëˆ„ì  ì‹œê°„ ì¶”ê°€ (300ì´ˆ = 5ë¶„)
                if (!spirit.lightTime) spirit.lightTime = 0;
                if (!spirit.darkTime) spirit.darkTime = 0;
                
                if (lightMode) {
                    spirit.lightTime += 300;
                } else {
                    spirit.darkTime += 300;
                }

                // ì •ë ¹ì˜ ìˆ¨ê²¨ì§„ ì†ì„±ì— í…Œë¼ë¦¬ì›€ í™˜ê²½ê°’ ì¶”ê°€
                if (!spirit.hiddenAttributes) {
                    spirit.hiddenAttributes = {
                        fire: 0, water: 0, wind: 0, earth: 0, light: 0, dark: 0
                    };
                }

                // í…Œë¼ë¦¬ì›€ì˜ ê° ì†ì„±ê°’ë§Œí¼ ì •ë ¹ì˜ ì†ì„± ì¦ê°€ (ìµœëŒ€ 400)
                Object.keys(terrarium).forEach(attr => {
                    if (terrarium[attr] > 0) {
                        spirit.hiddenAttributes[attr] = Math.min(400, spirit.hiddenAttributes[attr] + terrarium[attr]);
                    }
                });
                
                // ì§ˆë³‘ ì²´í¬ (5ë¶„ë§ˆë‹¤, ì´ë¯¸ ì•„í”„ì§€ ì•Šì€ ê²½ìš°)
                if (!spirit.isSick) {
                    checkForDisease(spirit);
                }
            });
            
            // ì •ë ¹ ê´€ê³„ ì—…ë°ì´íŠ¸ (5ë¶„ë§ˆë‹¤)
            updateSpiritRelationships();

            saveGame();
            updateAllSpiritCards();
        }
        
        // ì •ë ¹ ê´€ê³„ ì—…ë°ì´íŠ¸ (5ë¶„ë§ˆë‹¤ í˜¸ì¶œ)
        function updateSpiritRelationships() {
            // ì‚´ì•„ìˆê³  ì™„ì„±ë˜ì§€ ì•Šì€ ì •ë ¹ë“¤ë§Œ (ì•Œ, ë²ˆë°ê¸°, ì„±ì¶© ì œì™¸)
            const activeSpirits = spirits.filter(s => {
                if (s.isDead || s.isCompleted) return false;
                const stage = getStage(s.growth);
                // ì•Œ(egg), ë²ˆë°ê¸°(pupa), ì„±ì¶©(adult)ëŠ” ì œì™¸ - ì• ë²Œë ˆë§Œ ê´€ê³„ í˜•ì„±
                return stage === 'larva1' || stage === 'larva2' || stage === 'larva3';
            });
            
            if (activeSpirits.length < 2) return;
            
            // ê° ì •ë ¹ ìŒì— ëŒ€í•´ ê´€ê³„ ì—…ë°ì´íŠ¸
            for (let i = 0; i < activeSpirits.length; i++) {
                for (let j = i + 1; j < activeSpirits.length; j++) {
                    const spirit1 = activeSpirits[i];
                    const spirit2 = activeSpirits[j];
                    
                    // relationships ì´ˆê¸°í™”
                    if (!spirit1.relationships) spirit1.relationships = {};
                    if (!spirit2.relationships) spirit2.relationships = {};
                    
                    // í˜„ì¬ ê´€ê³„ ìˆ˜ì¹˜ ê°€ì ¸ì˜¤ê¸°
                    const currentRel1 = spirit1.relationships[spirit2.id] || 0;
                    const currentRel2 = spirit2.relationships[spirit1.id] || 0;
                    
                    // í™”í•´ì˜ ê½ƒ íš¨ê³¼ ì²´í¬ (ì‹¸ì›€ ë°©ì§€ìš©)
                    const now = Date.now();
                    const spirit1HasReconciliation = spirit1.reconciliationUntil && spirit1.reconciliationUntil > now;
                    const spirit2HasReconciliation = spirit2.reconciliationUntil && spirit2.reconciliationUntil > now;
                    const hasReconciliationEffect = spirit1HasReconciliation || spirit2HasReconciliation;
                    
                    // ì§€ë ¥ 10 ì´í•˜ë©´ ì‹¸ì›€ í™•ë¥  20% (í™”í•´ì˜ ê½ƒ íš¨ê³¼ê°€ ìˆìœ¼ë©´ ì‹¸ì›€ ì•ˆ í•¨)
                    const spirit1LowInt = (spirit1.parameters?.intelligence || 0) <= 10;
                    const spirit2LowInt = (spirit2.parameters?.intelligence || 0) <= 10;
                    
                    if ((spirit1LowInt || spirit2LowInt) && !hasReconciliationEffect && Math.random() < 0.2) {
                        // ì‹¸ì›€ ë°œìƒ! ê´€ê³„ ê°ì†Œ
                        const fightDamage = Math.floor(Math.random() * 5) + 1; // -1 ~ -5
                        const newRel1 = Math.max(-100, currentRel1 - fightDamage);
                        const newRel2 = Math.max(-100, currentRel2 - fightDamage);
                        
                        spirit1.relationships[spirit2.id] = newRel1;
                        spirit2.relationships[spirit1.id] = newRel2;
                        
                        // ì•™ìˆ™ ì´ë²¤íŠ¸ (ë‘˜ ë‹¤ 0 ë¯¸ë§Œ ë„ë‹¬ ì‹œ)
                        if (currentRel1 >= 0 && newRel1 < 0 && newRel2 < 0) {
                            showNotification(`${spirit1.name}ì™€(ê³¼) ${spirit2.name}ì´(ê°€) ì•™ìˆ™ì´ ë˜ì—ˆìŠµë‹ˆë‹¤!`);
                            addLog(spirit1, `${spirit2.name}ì™€(ê³¼) ì•™ìˆ™ì´ ë˜ì—ˆìŠµë‹ˆë‹¤.`);
                            addLog(spirit2, `${spirit1.name}ì™€(ê³¼) ì•™ìˆ™ì´ ë˜ì—ˆìŠµë‹ˆë‹¤.`);
                        }
                        
                        // ì‹¸ì›€ ì•Œë¦¼ (ê°€ë”ë§Œ)
                        if (Math.random() < 0.3) {
                            const troublemaker = spirit1LowInt ? spirit1 : spirit2;
                            const other = spirit1LowInt ? spirit2 : spirit1;
                            showNotification(`${troublemaker.name}ì´(ê°€) ${other.name}ì™€(ê³¼) ë‹¤í‰œìŠµë‹ˆë‹¤!`);
                            addLog(troublemaker, `${other.name}ì™€(ê³¼) ë‹¤í‰œìŠµë‹ˆë‹¤. (ì§€ë ¥ ë¶€ì¡±)`);
                            addLog(other, `${troublemaker.name}ì™€(ê³¼) ë‹¤í‰œìŠµë‹ˆë‹¤.`);
                        }
                        continue; // ì‹¸ìš°ë©´ í˜¸ê°ë„ ì¦ê°€ ìŠ¤í‚µ
                    }
                    
                    // ê´€ê³„ ë³€í™”ëŸ‰ (í•¨ê»˜ ìˆìœ¼ë©´ ìì—°ìŠ¤ëŸ½ê²Œ ì¹œí•´ì§)
                    let change = Math.floor(Math.random() * 5) + 4; // +4 ~ +8
                    
                    // ë§¤ë ¥ 50 ì´ìƒì´ë©´ í˜¸ê°ë„ ì¦ê°€ëŸ‰ ë³´ë„ˆìŠ¤ (1.5ë°°)
                    const spirit1HighCharm = (spirit1.parameters?.charm || 0) >= 50;
                    const spirit2HighCharm = (spirit2.parameters?.charm || 0) >= 50;
                    
                    if (spirit1HighCharm || spirit2HighCharm) {
                        change = Math.floor(change * 1.5);
                        // ë§¤ë ¥ ë³´ë„ˆìŠ¤ ì•Œë¦¼ (ë‚®ì€ í™•ë¥ )
                        if (Math.random() < 0.05) {
                            const charmer = spirit1HighCharm ? spirit1 : spirit2;
                            const other = spirit1HighCharm ? spirit2 : spirit1;
                            addLog(charmer, `âœ¨ ${other.name}ì—ê²Œ ë§¤ë ¥ì„ ë°œì‚°í–ˆìŠµë‹ˆë‹¤!`);
                        }
                    }
                    
                    // ì•„ì¹´ì‹œì•„ ê¿€ íš¨ê³¼ ì²´í¬ (30ë¶„ê°„ ì§€ì†) - í˜¸ê°ë„ ì¦ê°€ëŸ‰ 2ë°°
                    const spirit1HasHoney = spirit1.acaciaHoneyUntil && spirit1.acaciaHoneyUntil > now;
                    const spirit2HasHoney = spirit2.acaciaHoneyUntil && spirit2.acaciaHoneyUntil > now;
                    
                    if (spirit1HasHoney || spirit2HasHoney) {
                        change = Math.floor(change * 2);
                        
                        // ë‘˜ ë‹¤ íš¨ê³¼ê°€ ìˆìœ¼ë©´ ì¶”ê°€ ë³´ë„ˆìŠ¤ (ì´ 3ë°°)
                        if (spirit1HasHoney && spirit2HasHoney) {
                            change = Math.floor(change * 1.5);
                        }
                    }
                    
                    // ê´€ê³„ ìˆ˜ì¹˜ ì—…ë°ì´íŠ¸ (ë²”ìœ„: -100 ~ 100)
                    const newRel1 = Math.min(100, currentRel1 + change);
                    const newRel2 = Math.min(100, currentRel2 + change);
                    
                    spirit1.relationships[spirit2.id] = newRel1;
                    spirit2.relationships[spirit1.id] = newRel2;
                    
                    // ì•™ìˆ™ í•´ì œ ì´ë²¤íŠ¸ (ë‘˜ ë‹¤ ìŒìˆ˜ì˜€ëŠ”ë° ë‘˜ ë‹¤ 0 ì´ìƒì´ ë¨)
                    if (currentRel1 < 0 && currentRel2 < 0 && newRel1 >= 0 && newRel2 >= 0) {
                        showNotification(`ğŸŒ¼ ${spirit1.name}ì™€(ê³¼) ${spirit2.name}ì´(ê°€) ì„œë¡œì˜ ì‚¬ê³¼ë¥¼ ë°›ì•„ì£¼ì—ˆìŠµë‹ˆë‹¤.`);
                        addLog(spirit1, `ğŸŒ¼ ${spirit2.name}ì™€(ê³¼) í™”í•´í–ˆìŠµë‹ˆë‹¤.`);
                        addLog(spirit2, `ğŸŒ¼ ${spirit1.name}ì™€(ê³¼) í™”í•´í–ˆìŠµë‹ˆë‹¤.`);
                    }
                    
                    // ì´ë¯¸ bondê°€ ìˆìœ¼ë©´ ì´ë²¤íŠ¸ ìŠ¤í‚µ
                    const hasBond1 = spirit1.bond && spirit1.bond.partnerId;
                    const hasBond2 = spirit2.bond && spirit2.bond.partnerId;
                    
                    // ì§ê¿ ì´ë²¤íŠ¸ (ë‘˜ ë‹¤ 35 ì´ìƒ ë„ë‹¬ ì‹œ, bond ì—†ì„ ë•Œë§Œ)
                    if (!hasBond1 && !hasBond2 && currentRel1 < 35 && newRel1 >= 35 && newRel2 >= 35) {
                        // ì´ë¯¸ ì—°ëª¨ì¸ ê²½ìš° ì•Œë¦¼ ì•ˆ í•¨
                        if (newRel1 < 55 && newRel2 < 55) {
                            // ì˜êµ¬ ê´€ê³„ ê¸°ë¡
                            spirit1.bond = { type: 'bestfriend', partnerId: spirit2.id };
                            spirit2.bond = { type: 'bestfriend', partnerId: spirit1.id };
                            
                            showNotification(`ğŸ’• ${spirit1.name}ì™€(ê³¼) ${spirit2.name}ì´(ê°€) ì§ê¿ì´ ë˜ì—ˆìŠµë‹ˆë‹¤!`);
                            addLog(spirit1, `ğŸ’• ${spirit2.name}ì™€(ê³¼) ì§ê¿ì´ ë˜ì—ˆìŠµë‹ˆë‹¤!`);
                            addLog(spirit2, `ğŸ’• ${spirit1.name}ì™€(ê³¼) ì§ê¿ì´ ë˜ì—ˆìŠµë‹ˆë‹¤!`);
                        }
                    }
                    
                    // ì—°ëª¨ ì´ë²¤íŠ¸ (ë‘˜ ë‹¤ 55 ì´ìƒ ë„ë‹¬ ì‹œ)
                    // ê¸°ì¡´ ì§ê¿ì—ì„œ ì—°ëª¨ìœ¼ë¡œ ìŠ¹ê¸‰ ê°€ëŠ¥
                    const areBestFriends = spirit1.bond?.type === 'bestfriend' && spirit1.bond?.partnerId === spirit2.id;
                    if (currentRel1 < 55 && newRel1 >= 55 && newRel2 >= 55) {
                        if (areBestFriends || (!hasBond1 && !hasBond2)) {
                            // ì˜êµ¬ ê´€ê³„ ê¸°ë¡ (ì—°ëª¨ìœ¼ë¡œ ìŠ¹ê¸‰)
                            spirit1.bond = { type: 'lover', partnerId: spirit2.id };
                            spirit2.bond = { type: 'lover', partnerId: spirit1.id };
                            
                            showNotification(`ğŸ’— ${spirit1.name}ì™€(ê³¼) ${spirit2.name} ì‚¬ì´ì— ì—°ëª¨ì´ ì‹¹í…„ìŠµë‹ˆë‹¤!`);
                            addLog(spirit1, `ğŸ’— ${spirit2.name}ì—ê²Œ ì—°ëª¨ì„ ëŠë¼ê³  ìˆìŠµë‹ˆë‹¤...`);
                            addLog(spirit2, `ğŸ’— ${spirit1.name}ì—ê²Œ ì—°ëª¨ì„ ëŠë¼ê³  ìˆìŠµë‹ˆë‹¤...`);
                        }
                    }
                }
            }
        }
        
        // ì—°ëª¨ ê´€ê³„ì¸ ì •ë ¹ ì°¾ê¸° (bond ê¸°ë°˜)
        function getLover(spirit) {
            // bondê°€ ìˆê³  íƒ€ì…ì´ loverì¸ ê²½ìš°
            if (spirit.bond && spirit.bond.type === 'lover' && spirit.bond.partnerId) {
                const lover = spirits.find(s => s.id === spirit.bond.partnerId && !s.isDead && !s.isCompleted);
                return lover || null;
            }
            return null;
        }
        
        // ì§ê¿ ê´€ê³„ì¸ ì •ë ¹ ì°¾ê¸° (bond ê¸°ë°˜)
        function getBestFriend(spirit) {
            // bondê°€ ìˆê³  íƒ€ì…ì´ bestfriendì¸ ê²½ìš°
            if (spirit.bond && spirit.bond.type === 'bestfriend' && spirit.bond.partnerId) {
                const bestFriend = spirits.find(s => s.id === spirit.bond.partnerId && !s.isDead && !s.isCompleted);
                return bestFriend || null;
            }
            return null;
        }
        
        // ë³‘ê·  ì¹¨ì… ì²´í¬ í•¨ìˆ˜ (ë¯¸ë‹ˆì–´ì²˜ 10ê°œ ì´ˆê³¼ ì‹œ 5% í™•ë¥ )
        function checkGermInvasion() {
            // ë¯¸ë‹ˆì–´ì²˜ 10ê°œ ì´í•˜ë©´ ì²´í¬ ì•ˆ í•¨
            if (installedDecorations.length <= 10) return;
            
            // 5% í™•ë¥ 
            if (Math.random() > 0.05) return;
            
            // ê°ì—¼ ëŒ€ìƒ: ì²´ë ¥ 50 ë¯¸ë§Œ (ê°•í•œ í‚¤ì›Œë“œ ì—†ëŠ”) ì •ë ¹ë“¤
            const vulnerableSpirits = spirits.filter(s => 
                !s.isDead && 
                !s.isCompleted && 
                !s.isSick && 
                s.parameters.strength < 50 &&
                getStage(s.growth) !== 'egg' // ì•Œì€ ì œì™¸
            );
            
            if (vulnerableSpirits.length === 0) {
                // ëª¨ë“  ì •ë ¹ì´ ë©´ì—­ì´ë©´ íŒì—…ë§Œ í‘œì‹œ
                showGermInvasionPopup(0);
                return;
            }
            
            // ì·¨ì•½í•œ ì •ë ¹ë“¤ì—ê²Œ ì§ˆë³‘ ë¶€ì—¬
            vulnerableSpirits.forEach(spirit => {
                spirit.isSick = true;
                spirit.sickTime = Date.now();
                spirit.status = `${spirit.name}ì´(ê°€) ë³‘ê· ì— ê°ì—¼ë˜ì—ˆìŠµë‹ˆë‹¤... ğŸ¦ `;
                addLog(spirit, 'ğŸ¦  í…Œë¼ë¦¬ì›€ì— ì¹¨ì…í•œ ë³‘ê· ì— ê°ì—¼ë˜ì—ˆìŠµë‹ˆë‹¤!');
            });
            
            saveGame();
            renderSpirits();
            
            // ë³‘ê·  ì¹¨ì… íŒì—… í‘œì‹œ
            showGermInvasionPopup(vulnerableSpirits.length);
        }
        
        // ë³‘ê·  ì¹¨ì… íŒì—…
        function showGermInvasionPopup(infectedCount) {
            const existingPopup = document.getElementById('germInvasionPopup');
            if (existingPopup) existingPopup.remove();
            
            let message = '';
            if (infectedCount === 0) {
                message = `
                    <div style="color: #4CAF50; font-size: 1.1rem;">
                        âœ… ëª¨ë“  ì •ë ¹ì´ ë³‘ê· ì„ ì´ê²¨ëƒˆìŠµë‹ˆë‹¤!
                    </div>
                `;
            } else {
                message = `
                    <div style="color: #f44336; font-size: 1.1rem; margin-bottom: 15px;">
                        âš ï¸ ${infectedCount}ë§ˆë¦¬ì˜ ì •ë ¹ì´ ê°ì—¼ë˜ì—ˆìŠµë‹ˆë‹¤!
                    </div>
                    <div style="color: #888; font-size: 0.9rem;">
                        ì•½ì´ˆë¡œ ì¹˜ë£Œí•´ì£¼ì„¸ìš”!
                    </div>
                `;
            }
            
            const popup = document.createElement('div');
            popup.id = 'germInvasionPopup';
            popup.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0,0,0,0.8);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 10000;
            `;
            popup.innerHTML = `
                <div style="background: var(--card); padding: 30px; border-radius: 16px; max-width: 400px; text-align: center; border: 3px solid #f44336;">
                    <div style="font-size: 4rem; margin-bottom: 15px;">ğŸ¦ </div>
                    <p style="color: var(--text); font-size: 1rem; margin-bottom: 20px;">
                        í…Œë¼ë¦¬ì›€ì— ë³‘ê· ì´ ì¹¨ì…í•˜ì—¬<br>ì˜¤ì—¼ë˜ì—ˆìŠµë‹ˆë‹¤!
                    </p>
                    ${message}
                    <button onclick="document.getElementById('germInvasionPopup').remove()" style="
                        margin-top: 20px;
                        padding: 12px 30px;
                        background: #f44336;
                        color: white;
                        border: none;
                        border-radius: 8px;
                        font-size: 1rem;
                        font-weight: 600;
                        cursor: pointer;
                    ">í™•ì¸</button>
                </div>
            `;
            document.body.appendChild(popup);
        }
        
        // ì§ˆë³‘ ì²´í¬ í•¨ìˆ˜
        function checkForDisease(spirit) {
            // ì´ë¯¸ ì•„í”„ë©´ ì²´í¬ ì•ˆ í•¨
            if (spirit.isSick) return;
            
            // ì²´ë ¥ 50 ì´ìƒì´ë©´ "ê°•í•œ" íš¨ê³¼: ì§ˆë³‘ ë©´ì—­
            if (spirit.parameters.strength >= 50) return;
            
            let probability = 0;
            let reason = '';
            
            // ì¡°ê±´ 1: ì²´ë ¥ 5 ì´í•˜ â†’ 10% í™•ë¥ 
            if (spirit.parameters.strength <= 5) {
                probability = 0.1;
                reason = 'ì²´ë ¥ì´ ì•½í•´ ë³‘ì— ê±¸ë ¸ìŠµë‹ˆë‹¤';
            }
            
            // ì¡°ê±´ 2: ì†ì„± ë¶ˆê· í˜• (ìµœê³  ì†ì„± 50 ì´ìƒ & ìµœì € ì†ì„± 10 ì´í•˜) â†’ 10% í™•ë¥ 
            if (probability === 0) {
                const attrs = spirit.hiddenAttributes || { fire: 0, water: 0, wind: 0, earth: 0, light: 0, dark: 0 };
                const attrValues = Object.values(attrs);
                const maxAttr = Math.max(...attrValues);
                const minAttr = Math.min(...attrValues);
                
                if (maxAttr >= 50 && minAttr <= 10) {
                    probability = 0.1;
                    reason = 'ì†ì„± ë¶ˆê· í˜•ìœ¼ë¡œ ì¸í•´ ë³‘ì— ê±¸ë ¸ìŠµë‹ˆë‹¤';
                }
            }
            
            // ì¡°ê±´ 3: 30ë¶„ ì´ìƒ ìƒí˜¸ì‘ìš© ì—†ìŒ â†’ 20% í™•ë¥ 
            if (probability === 0) {
                const now = Date.now();
                const lastFeed = spirit.lastFed || spirit.birthTime;
                const lastMusic = spirit.lastMusic || spirit.birthTime;
                const lastPat = spirit.lastPat || spirit.birthTime;
                
                const lastInteraction = Math.max(lastFeed, lastMusic, lastPat);
                const minutesSinceInteraction = (now - lastInteraction) / 1000 / 60;
                
                if (minutesSinceInteraction >= 30) {
                    probability = 0.2;
                    reason = 'ì˜¤ë«ë™ì•ˆ ëŒë´„ì„ ë°›ì§€ ëª»í•´ ë³‘ì— ê±¸ë ¸ìŠµë‹ˆë‹¤';
                }
            }
            
            // ì¡°ê±´ë³„ í™•ë¥ ë¡œ ì§ˆë³‘ ë°œìƒ
            if (probability > 0 && Math.random() < probability) {
                spirit.isSick = true;
                spirit.sickTime = Date.now();
                spirit.status = `${spirit.name}ì´(ê°€) ì•„íŒŒ ë³´ì…ë‹ˆë‹¤... ğŸ¤’`;
                addLog(spirit, reason);
                showNotification(`${spirit.name}ì´(ê°€) ë³‘ì— ê±¸ë ¸ìŠµë‹ˆë‹¤!`);
                
                // ì²« ì§ˆë³‘ ì‹œ íŠœí† ë¦¬ì–¼ ì‹œì‘
                if (!localStorage.getItem('spiritGarden_sickTutorialSeen')) {
                    setTimeout(() => {
                        startSickTutorial();
                    }, 1000);
                }
            }
        }

        function checkSpiritStatus() {
            // ì²« íŠœí† ë¦¬ì–¼ ì¤‘ì—ëŠ” ìƒíƒœ ì²´í¬ ì•ˆ í•¨
            if (tutorialActive) return;
            
            const now = Date.now();
            spirits.forEach(spirit => {
                if (!spirit.lastFed) {
                    spirit.lastFed = spirit.birthTime;
                }

                const timeSinceLastFed = now - spirit.lastFed;
                const hours = timeSinceLastFed / 1000 / 60 / 60;

                // 24ì‹œê°„ ê²½ê³¼ - ì‚¬ë§ë§Œ ì²´í¬ (ë°°ê³ í”” ë©”ì‹œì§€ëŠ” getRandomMessageì—ì„œ ì²˜ë¦¬)
                if (hours >= 24) {
                    if (getStage(spirit.growth) === 'egg') {
                        spirit.status = 'âŒ ì•Œì´ ê¹¨ì ¸ì„œ ë¯¸ë™ì´ ì—†ìŠµë‹ˆë‹¤...';
                        spirit.isDead = true;
                    } else {
                        spirit.status = 'âŒ í…Œë¼ë¦¬ì›€ ë°–ìœ¼ë¡œ ë‚˜ê°€ ì‚¬ë¼ì¡ŒìŠµë‹ˆë‹¤...';
                        spirit.isDead = true;
                    }
                }
            });
        }

        function updateAllSpiritCards() {
            // ì •ë ¹ë³„ ë¶ˆë§Œ ìƒíƒœ ì§€ì† ì‹œê°„ ì²´í¬
            updateLowSatisfactionTimer();
            
            spirits.forEach(spirit => {
                updateSpiritCard(spirit);
            });
        }

        // ì¿¨íƒ€ì„ í…ìŠ¤íŠ¸ë§Œ ì—…ë°ì´íŠ¸ (ì„±ëŠ¥ ìµœì í™”)
        function updateCooldownDisplay() {
            if (currentTab !== 'garden' || isPaused) return;
            
            const now = Date.now();
            spirits.forEach((spirit, index) => {
                const cards = document.querySelectorAll('.spirit-card');
                const card = cards[index];
                if (!card) return;
                
                // ë²„íŠ¼ë“¤ ì°¾ê¸°
                const buttons = card.querySelectorAll('button');
                buttons.forEach(button => {
                    const text = button.textContent;
                    
                    // ë¨¹ì´ì£¼ê¸° ë²„íŠ¼
                    if (text.includes('ë¨¹ì´ì£¼ê¸°')) {
                        const canFeed = !isPaused && canDoAction(spirit, 'feed') && !spirit.isDead;
                        if (!canFeed && spirit.lastFeed) {
                            const remaining = Math.max(0, Math.ceil((10000 - (now - spirit.lastFeed)) / 1000));
                            button.textContent = `${spirit.isSick ? 'ğŸ¤¢ ' : ''}ë¨¹ì´ì£¼ê¸° (${remaining}ì´ˆ)`;
                        } else if (canFeed) {
                            button.textContent = `${spirit.isSick ? 'ğŸ¤¢ ' : ''}ë¨¹ì´ì£¼ê¸°`;
                        }
                    }
                    
                    // ìŒì•… ë“£ê¸° ë²„íŠ¼
                    if (text.includes('ìŒì•… ë“£ê¸°')) {
                        const canMusic = !isPaused && canDoAction(spirit, 'music') && !spirit.isDead;
                        if (!canMusic && spirit.lastMusic) {
                            const remaining = Math.max(0, Math.ceil((10000 - (now - spirit.lastMusic)) / 1000));
                            button.textContent = `ìŒì•… ë“£ê¸° (${remaining}ì´ˆ)`;
                        } else if (canMusic) {
                            button.textContent = `ìŒì•… ë“£ê¸°`;
                        }
                    }
                    
                    // ì“°ë‹¤ë“¬ê¸° ë²„íŠ¼
                    if (text.includes('ì“°ë‹¤ë“¬ê¸°')) {
                        const canPat = !isPaused && canDoAction(spirit, 'pat') && !spirit.isDead;
                        if (!canPat && spirit.lastPat) {
                            const remaining = Math.max(0, Math.ceil((10000 - (now - spirit.lastPat)) / 1000));
                            button.textContent = `ì“°ë‹¤ë“¬ê¸° (${remaining}ì´ˆ)`;
                        } else if (canPat) {
                            button.textContent = `ì“°ë‹¤ë“¬ê¸°`;
                        }
                    }
                });
            });
        }

        function updateSpiritCard(spirit) {
            const cards = document.querySelectorAll('.spirit-card');
            const index = spirits.findIndex(s => s.id === spirit.id);
            if (index === -1 || !cards[index]) return;

            const card = cards[index];
            const stage = getStage(spirit.growth);
            const nextReq = getNextStageRequirement(spirit.growth);
            const progress = (spirit.growth / nextReq) * 100;
            
            const canFeed = canDoAction(spirit, 'feed') && !spirit.isDead;
            const canMusic = canDoAction(spirit, 'music') && !spirit.isDead;
            const canPat = canDoAction(spirit, 'pat') && !spirit.isDead;

            let icon = getStageIcon(stage, spirit);
            
            // ì´ë²¤íŠ¸ ì •ë ¹ ì•„ì´ì½˜
            if (spirit.isEventSpirit && spirit.eventType) {
                const eventIcon = getEventStageIcon(spirit);
                if (eventIcon) icon = eventIcon;
            }
            // ì¼ë°˜ ì§„í™” ì•„ì´ì½˜
            else if (stage === 'adult' && spirit.evolutionType) {
                const evolutionData = EVOLUTION_TYPES[spirit.evolutionType];
                if (evolutionData) {
                    icon = evolutionData.icon;
                }
            }
            if (spirit.isDead) {
                icon = stage === 'egg' ? 'ğŸ’”' : 'ğŸ‘»';
            }

            // ì•„ì´ì½˜ ì—…ë°ì´íŠ¸
            const iconElement = card.querySelector('.spirit-icon');
            if (iconElement && iconElement.innerHTML !== icon) {
                iconElement.innerHTML = icon;
            }

            // ì´ë¦„ ì—…ë°ì´íŠ¸
            const nameElement = card.querySelector('.spirit-name');
            if (nameElement && nameElement.textContent !== spirit.name) {
                nameElement.textContent = spirit.name;
            }

            // ìŠ¤í…Œì´ì§€ ì—…ë°ì´íŠ¸
            const stageElement = card.querySelector('.spirit-stage');
            if (stageElement) {
                stageElement.textContent = STAGE_NAMES[stage];
            }

            // ì§„í–‰ë„ ì—…ë°ì´íŠ¸
            const progressFill = card.querySelector('.progress-fill');
            if (progressFill) {
                progressFill.style.width = `${Math.min(progress, 100)}%`;
            }

            const progressText = card.querySelector('.progress-text');
            if (progressText) {
                progressText.textContent = `ì„±ì¥ ${spirit.growth} / ${nextReq}`;
            }

            // íŒŒë¼ë¯¸í„° ì—…ë°ì´íŠ¸
            const params = card.querySelectorAll('.param');
            if (params.length >= 4) {
                params[0].innerHTML = `<span class="param-icon">ğŸ§ </span>ì§€ë ¥ ${spirit.parameters.intelligence}`;
                params[1].innerHTML = `<span class="param-icon">ğŸ’ª</span>ì²´ë ¥ ${spirit.parameters.strength}`;
                params[2].innerHTML = `<span class="param-icon">ğŸ’–</span>ë§¤ë ¥ ${spirit.parameters.charm}`;
                params[3].innerHTML = `<span class="param-icon">â¤ï¸</span>ì• ì • ${spirit.parameters.affection}`;
            }

            // ìƒíƒœ ë©”ì‹œì§€ ì—…ë°ì´íŠ¸
            const statusElement = card.querySelector('.spirit-status');
            if (statusElement) {
                statusElement.textContent = spirit.status;
            }

            // ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
            const actionButtons = card.querySelector('.action-buttons');
            if (actionButtons) {
                const buttons = actionButtons.querySelectorAll('button');
                if (buttons.length >= 4) {
                    buttons[0].disabled = !canFeed;
                    buttons[1].disabled = !canMusic;
                    buttons[2].disabled = !canPat;
                    // buttons[3]ëŠ” ë³´ë‚´ê¸° ë²„íŠ¼ì´ë¯€ë¡œ í•­ìƒ í™œì„±í™”
                }
            }
        }

        function toggleLogs(spiritId) {
            const logsDiv = document.getElementById(`logs${spiritId}`);
            const toggleIcon = document.getElementById(`logToggle${spiritId}`);
            
            if (logsDiv.style.display === 'none') {
                logsDiv.style.display = 'block';
                toggleIcon.textContent = 'â–²';
            } else {
                logsDiv.style.display = 'none';
                toggleIcon.textContent = 'â–¼';
            }
        }

        function renderSpirits() {
            const grid = document.getElementById('spiritsGrid');
            const now = Date.now(); // ì¿¨íƒ€ì„ ê³„ì‚°ìš©
            
            if (spirits.length === 0) {
                grid.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">ğŸ¥š</div>
                        <div>ì•„ì§ ì •ë ¹ì´ ì—†ìŠµë‹ˆë‹¤<br>ìƒˆë¡œìš´ ì•Œì„ ë°›ì•„ë³´ì„¸ìš”</div>
                    </div>
                `;
                return;
            }

            grid.innerHTML = spirits.map(spirit => {
                const stage = getStage(spirit.growth);
                const nextReq = getNextStageRequirement(spirit.growth);
                const progress = (spirit.growth / nextReq) * 100;
                
                const canFeed = !isPaused && canDoAction(spirit, 'feed') && !spirit.isDead;
                const canMusic = !isPaused && canDoAction(spirit, 'music') && !spirit.isDead;
                const canPat = !isPaused && canDoAction(spirit, 'pat') && !spirit.isDead;

                let icon = getStageIcon(stage, spirit);
                
                // ì´ë²¤íŠ¸ ì •ë ¹ ì•„ì´ì½˜
                if (spirit.isEventSpirit && spirit.eventType) {
                    const eventIcon = getEventStageIcon(spirit);
                    if (eventIcon) icon = eventIcon;
                }
                // ì¼ë°˜ ì§„í™” ì•„ì´ì½˜
                else if (stage === 'adult' && spirit.evolutionType) {
                    const evolutionData = EVOLUTION_TYPES[spirit.evolutionType];
                    if (evolutionData) {
                        icon = evolutionData.icon;
                    }
                }
                if (spirit.isDead) {
                    icon = stage === 'egg' ? 'ğŸ’”' : 'ğŸ‘»';
                }

                // í•˜ìœ„ í˜¸í™˜ì„±ì„ ìœ„í•œ íŒŒë¼ë¯¸í„° ì²´í¬
                if (!spirit.parameters.affection && spirit.parameters.mystery !== undefined) {
                    spirit.parameters.affection = spirit.parameters.mystery;
                    delete spirit.parameters.mystery;
                }
                if (!spirit.hiddenAttributes) {
                    spirit.hiddenAttributes = {
                        fire: 0, water: 0, wind: 0, earth: 0, light: 0, dark: 0
                    };
                }
                if (!spirit.logs) {
                    spirit.logs = [];
                }
                if (!spirit.lightTime) {
                    spirit.lightTime = 0;
                }
                if (!spirit.darkTime) {
                    spirit.darkTime = 0;
                }
                if (!spirit.musicListened) {
                    spirit.musicListened = 0;
                }
                if (!spirit.feedCount) {
                    spirit.feedCount = 0;
                }
                
                // ì™„ì„±ëœ ì •ë ¹ì¸ ê²½ìš° íŠ¹ë³„í•œ ì¹´ë“œ í‘œì‹œ
                if (spirit.isCompleted && spirit.evolutionData) {
                    // ì´ë¯¸ì§€ ì•„ì´ì½˜ì¸ ê²½ìš° ì›ë³¸ ì‚¬ì´ì¦ˆë¡œ í‘œì‹œ
                    const evolutionIcon = spirit.evolutionData.icon && spirit.evolutionData.icon.includes('<img') 
                        ? spirit.evolutionData.icon.replace(/width:\d+px;height:(auto|\d+px)/g, 'width:auto;height:auto')
                        : spirit.evolutionData.icon;
                    
                    return `
                        <div class="swiper-slide"><div class="spirit-card" style="background: linear-gradient(135deg, #ffd700 0%, #ffed4e 100%); border: 3px solid #ffa500;">
                            <div style="text-align: center; padding: 20px;">
                                <div style="font-size: 4rem; margin-bottom: 15px;">${evolutionIcon}</div>
                                <div style="font-size: 1.3rem; font-weight: 700; color: #333; margin-bottom: 10px;">
                                    ğŸ‰ ë²ˆë°ê¸°ì—ì„œ ì •ë ¹ì´ ë¶€í™”í–ˆìŠµë‹ˆë‹¤! ğŸ‰
                                </div>
                                <div style="font-size: 1rem; color: #555; margin-bottom: 8px;">
                                    ${spirit.name} â†’ ${spirit.evolutionData.name}
                                </div>
                                <div style="font-size: 0.9rem; color: #666; margin-bottom: 20px;">
                                    ì• ì •ë„: ${spirit.parameters.affection || 0}
                                </div>
                                <button onclick="confirmEvolution(${spirit.id})" style="
                                    background: #ff6b6b;
                                    color: white;
                                    border: none;
                                    padding: 15px 30px;
                                    font-size: 1.1rem;
                                    font-weight: 700;
                                    border-radius: 8px;
                                    cursor: pointer;
                                    box-shadow: 0 4px 8px rgba(0,0,0,0.2);
                                ">
                                    í™•ì¸í•˜ê¸°
                                </button>
                            </div>
                        </div></div>
                    `;
                }
                // ì™¸í˜• ë¬˜ì‚¬ ê°€ì ¸ì˜¤ê¸°
                const appearance = getAppearanceDescription(spirit);
                
                // ìƒì„¸ ì •ë³´ í¼ì¹¨ ìƒíƒœ í™•ì¸ (ê¸°ë³¸ê°’: í¼ì¹¨)
                const isCollapsed = spiritCardExpanded[spirit.id] === false;

                return `
                    <div class="swiper-slide"><div class="spirit-card" style="position: relative;">
                        ${(() => {
                            const satisfaction = spirit.satisfaction || 'mid';
                            const satisfactionIcons = { high: '', mid: '', low: '' };
                            const satisfactionTexts = { high: 'ë§Œì¡±', mid: 'ë³´í†µ', low: 'ë¶ˆë§Œ' };
                            const satisfactionColors = { high: '#4caf50', mid: '#ff9800', low: '#f44336' };
                            return `
                                <div style="position: absolute; top: 12px; right: 12px; display: flex; align-items: center; gap: 4px; padding: 4px 8px; background: ${satisfactionColors[satisfaction]}22; border: 1px solid ${satisfactionColors[satisfaction]}; border-radius: 12px; font-size: 0.75rem;">
                                    <span style="font-size: 1rem;">${satisfactionIcons[satisfaction]}</span>
                                    <span style="font-weight: 600; color: ${satisfactionColors[satisfaction]};">${satisfactionTexts[satisfaction]}</span>
                                </div>
                            `;
                        })()}
                        <div class="spirit-header">
                            <div class="spirit-icon">${icon}</div>
                            <div class="spirit-info">
                                <div class="spirit-name" onclick="changeName(${spirit.id})">${spirit.name}</div>
                                <div class="spirit-stage">${STAGE_NAMES[stage]}</div>
                                ${appearance ? `<div class="spirit-appearance" style="font-size: 0.8rem; margin-top: 6px; line-height: 1.4;">${appearance}</div>` : ''}
                            </div>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${Math.min(progress, 100)}%"></div>
                        </div>
                        <div class="progress-text">ì„±ì¥ ${spirit.growth} / ${nextReq}</div>
                        
                        <!-- ìƒì„¸ ì •ë³´ ì„¹ì…˜ (ì ‘ìœ¼ë©´ ìˆ¨ê¹€) -->
                        <div class="spirit-detail-section ${isCollapsed ? '' : 'show'}" id="spiritDetail-${spirit.id}">
                            <div class="parameters">
                                <div class="param"><span class="param-icon">ğŸ§ </span>ì§€ë ¥ ${spirit.parameters.intelligence}</div>
                                <div class="param"><span class="param-icon">ğŸ’ª</span>ì²´ë ¥ ${spirit.parameters.strength}</div>
                                <div class="param"><span class="param-icon">ğŸ’–</span>ë§¤ë ¥ ${spirit.parameters.charm}</div>
                                <div class="param"><span class="param-icon">â¤ï¸</span>ì• ì • ${spirit.parameters.affection}</div>
                            </div>
                            ${(() => {
                                const foodAttrs = spirit.hiddenAttributes || { fire: 0, water: 0, wind: 0, earth: 0, light: 0, dark: 0 };
                                const terrariumAttrs = terrarium || { fire: 0, water: 0, wind: 0, earth: 0, light: 0, dark: 0 };
                                const attrs = {};
                                for (let attr in foodAttrs) {
                                    attrs[attr] = Math.min(500, foodAttrs[attr] + (terrariumAttrs[attr] || 0));
                                }
                                const attrIcons = { fire: 'ğŸ”¥', water: 'ğŸ’§', wind: 'ğŸŒ¬ï¸', earth: 'ğŸŒ±', light: 'âœ¨', dark: 'ğŸŒ™' };
                                const attrValues = Object.values(attrs);
                                const maxAttr = Math.max(...attrValues);
                                const minAttr = Math.min(...attrValues);
                                const isImbalanced = maxAttr >= 50 && minAttr <= 10;
                                
                                return `
                                    <div style="margin: 8px 0; padding: 8px; background: var(--bg); border: 1px solid ${isImbalanced ? '#f44336' : 'var(--border)'}; border-radius: 8px;">
                                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px;">
                                            <span style="font-size: 0.8rem; font-weight: 600; color: var(--text-muted);">ì†ì„± (ë¨¹ì´+í™˜ê²½)</span>
                                            ${isImbalanced ? '<span style="font-size: 0.75rem; color: #f44336; font-weight: 600;">âš ï¸ ë¶ˆê· í˜•</span>' : ''}
                                        </div>
                                        <div style="display: grid; grid-template-columns: repeat(6, 1fr); gap: 4px; text-align: center;">
                                            ${Object.entries(attrs).map(([key, val]) => {
                                                const isMax = val === maxAttr && maxAttr > 0;
                                                const isLow = isImbalanced && val < 10;
                                                const isPerfect = val >= 250;
                                                return `
                                                    <div style="font-size: 0.75rem; ${isPerfect ? 'color: #ff6f00; font-weight: 700;' : isLow ? 'color: #f44336; font-weight: 700;' : isMax ? 'color: #4caf50; font-weight: 700;' : ''}">
                                                        <div>${attrIcons[key]}</div>
                                                        <div>${Math.floor(val)}</div>
                                                    </div>
                                                `;
                                            }).join('')}
                                        </div>
                                    </div>
                                `;
                            })()}
                            ${(() => {
                                const keywords = getStatusKeywords(spirit);
                                if (keywords.length === 0) return '';
                                return `
                                    <div style="margin: 12px 0; padding: 10px; background: var(--bg); border: 1px solid var(--border); display: flex; flex-wrap: wrap; gap: 6px;">
                                        ${keywords.map((kw) => `
                                            <span 
                                                class="keyword-tag"
                                                title="${kw.desc || ''}"
                                                onclick="showKeywordDesc('${kw.text.replace(/'/g, "\\'")}', '${(kw.desc || '').replace(/'/g, "\\'")}')"
                                                style="
                                                    display: inline-flex;
                                                    align-items: center;
                                                    padding: 4px 10px;
                                                    background: #f5f5f5;
                                                    border: 1px solid #ddd;
                                                    font-size: 0.8rem;
                                                    font-weight: 600;
                                                    color: ${kw.color};
                                                    cursor: pointer;
                                                    transition: all 0.2s;
                                                "
                                                onmouseover="this.style.background='#e8e8e8'; this.style.transform='scale(1.02)';"
                                                onmouseout="this.style.background='#f5f5f5'; this.style.transform='scale(1)';"
                                            >
                                                ${kw.text}
                                            </span>
                                        `).join('')}
                                    </div>
                                `;
                            })()}
                        </div>
                        
                        <div class="spirit-status">${spirit.status}</div>
                        
                        ${spirit.logs && spirit.logs.length > 0 ? `
                            <div style="margin-top: 6px; margin-bottom: 16px; border-top: 1px solid var(--border); padding-top: 6px;">
                                <div style="display: flex; justify-content: space-between; align-items: center; cursor: pointer; padding: 8px; background: var(--bg); border-radius: 6px;" onclick="toggleLogs(${spirit.id})">
                                    <span style="font-size: 0.9rem; font-weight: 600;">ì¼ì§€ (${spirit.logs.length}ê°œ)</span>
                                    <span id="logToggle${spirit.id}" style="font-size: 0.8rem;">â–¼</span>
                                </div>
                                <div id="logs${spirit.id}" style="display: none; margin-top: 8px; max-height: 200px; overflow-y: auto;">
                                    ${spirit.logs.map(log => `
                                        <div style="font-size: 0.85rem; color: #888; padding: 4px 0; border-bottom: 1px solid var(--border);">
                                            <span style="color: #666;">${log.time}</span> - ${log.message}
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        ` : ''}
                        
                        <div class="action-buttons">
                            ${spirit.isSick ? `
                                <button onclick="giveMedicine(${spirit.id})" style="background: var(--earth); color: white; font-weight: 700;">
                                    ğŸŒ¿ ì•½ì´ˆ ì‚¬ìš©
                                </button>
                            ` : ''}
                            <button onclick="openFeedModal(${spirit.id})" ${!canFeed ? 'disabled' : ''}>
                                ${spirit.isSick ? 'ğŸ¤’ ' : ''}ë¨¹ì´ì£¼ê¸°${!canFeed && spirit.lastFed ? ` (${Math.max(0, Math.ceil((10000 - (now - spirit.lastFed)) / 1000))}ì´ˆ)` : ''}
                            </button>
                            <button onclick="openMusicModal(${spirit.id})" ${!canMusic ? 'disabled' : ''}>
                                ìŒì•… ë“£ê¸°${!canMusic && spirit.lastMusic ? ` (${Math.max(0, Math.ceil((10000 - (now - spirit.lastMusic)) / 1000))}ì´ˆ)` : ''}
                            </button>
                            <button onclick="patSpirit(${spirit.id})" ${!canPat ? 'disabled' : ''}>
                                ì“°ë‹¤ë“¬ê¸°${!canPat && spirit.lastPat ? ` (${Math.max(0, Math.ceil((10000 - (now - spirit.lastPat)) / 1000))}ì´ˆ)` : ''}
                            </button>
                            ${spirit.growth >= 100 && !spirit.isCompleted ? `
                                <button onclick="manualCompleteSpirit(${spirit.id})" style="background: #ffd700; color: #000; font-weight: 700;">
                                    ì§„í™”í•˜ê¸°
                                </button>
                            ` : ''}
                            <button onclick="confirmDeleteSpirit(${spirit.id})">
                                ë³´ë‚´ê¸°
                            </button>
                        </div>
                        
                        <!-- ì¹´ë“œ í•˜ë‹¨ ì ‘ê¸°/í¼ì¹˜ê¸° ë²„íŠ¼ -->
                        <div class="spirit-card-toggle" onclick="toggleSpiritCardDetail(${spirit.id})">
                            <span>${isCollapsed ? 'â–¼' : 'â–²'}</span>
                        </div>
                    </div></div>
                `;
            }).join('');
            
            // ëª¨ë°”ì¼ Swiper ì´ˆê¸°í™”/ì—…ë°ì´íŠ¸
            initOrUpdateSpiritsSwiper();
            
            // íŠœí† ë¦¬ì–¼ ì§„í–‰ ì¤‘ì´ë©´ ê°•ì¡° í‘œì‹œ ì¬ì ìš©
            if ((tutorialActive || tutorial2Active) && window.tutorialWaitingFor) {
                setTimeout(() => {
                    highlightTutorialTarget(window.tutorialWaitingFor);
                }, 100);
            }
            
            // ì†ì„± ë¶ˆê· í˜• íŠœí† ë¦¬ì–¼ ì²´í¬ (ë‹¤ë¥¸ íŠœí† ë¦¬ì–¼ì´ ì§„í–‰ ì¤‘ì´ì§€ ì•Šì„ ë•Œë§Œ)
            if (!localStorage.getItem('spiritGarden_imbalanceTutorialSeen') && 
                !tutorialActive && !tutorial2Active && !sickTutorialActive && !labTutorialActive && !imbalanceTutorialActive) {
                spirits.forEach(spirit => {
                    if (!spirit.isDead && !spirit.isCompleted) {
                        checkImbalanceAndTutorial(spirit);
                    }
                });
            }
            
            // ëª¨ë°”ì¼ ì •ë ¹ ìŠ¬ë¼ì´ë” ì¸ë””ì¼€ì´í„° ì—…ë°ì´íŠ¸
            updateSpiritSliderIndicator();
        }
        
        // í˜„ì¬ ë³´ê³  ìˆëŠ” ì •ë ¹ ì¸ë±ìŠ¤
        let currentSpiritIndex = 0;
        
        // ëª¨ë°”ì¼ ìŠ¤í¬ë¡¤ ìŠ¬ë¼ì´ë” ì´ˆê¸°í™”
        function initOrUpdateSpiritsSwiper() {
            const paginationContainer = document.getElementById('swiperPaginationContainer');
            const swiperEl = document.querySelector('.spirits-swiper');
            const gridEl = document.querySelector('.spirits-grid');
            const isMobile = window.innerWidth <= 768;
            
            // PC ëª¨ë“œ: ê·¸ë¦¬ë“œ ë³µì›
            if (!isMobile) {
                if (paginationContainer) paginationContainer.style.display = 'none';
                if (swiperEl) {
                    swiperEl.style.overflow = 'visible';
                    swiperEl.style.scrollSnapType = 'none';
                }
                if (gridEl) {
                    gridEl.style.display = '';
                    gridEl.style.transform = '';
                    gridEl.style.width = '';
                }
                document.querySelectorAll('.spirits-grid .swiper-slide').forEach(slide => {
                    slide.style.width = '';
                    slide.style.marginRight = '';
                });
                return;
            }
            
            // ì •ë ¹ì´ ì—†ìœ¼ë©´ ë¬´ì‹œ
            if (spirits.length === 0) {
                if (paginationContainer) paginationContainer.style.display = 'none';
                return;
            }
            
            // ëª¨ë°”ì¼ ëª¨ë“œ: í˜ì´ì§€ë„¤ì´ì…˜ í‘œì‹œ ë° ìŠ¤í¬ë¡¤ ìœ„ì¹˜ ë³µì›
            if (paginationContainer) paginationContainer.style.display = 'block';
            
            // ìœ íš¨í•œ ì¸ë±ìŠ¤ í™•ì¸
            const validIndex = Math.min(Math.max(0, currentSpiritIndex), spirits.length - 1);
            
            // ìŠ¤í¬ë¡¤ ìœ„ì¹˜ ë³µì› (ì•½ê°„ì˜ ë”œë ˆì´ í›„)
            setTimeout(() => {
                if (swiperEl && spirits.length > 0) {
                    // ìŠ¬ë¼ì´ë“œ ë„ˆë¹„ = 100vw - 32px + margin 32px = 100vw
                    const slideWidth = window.innerWidth;
                    swiperEl.scrollLeft = validIndex * slideWidth;
                    updateMobilePagination(validIndex);
                }
            }, 50);
            
            // ìŠ¤í¬ë¡¤ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ (ì¤‘ë³µ ë°©ì§€)
            if (!swiperEl.hasAttribute('data-scroll-listener')) {
                swiperEl.setAttribute('data-scroll-listener', 'true');
                
                let scrollTimeout;
                swiperEl.addEventListener('scroll', function() {
                    clearTimeout(scrollTimeout);
                    scrollTimeout = setTimeout(() => {
                        const slideWidth = window.innerWidth;
                        const newIndex = Math.round(this.scrollLeft / slideWidth);
                        if (newIndex !== currentSpiritIndex && newIndex >= 0 && newIndex < spirits.length) {
                            currentSpiritIndex = newIndex;
                            updateMobilePagination(newIndex);
                        }
                    }, 50);
                });
            }
        }
        
        // ëª¨ë°”ì¼ í˜ì´ì§€ë„¤ì´ì…˜ ì—…ë°ì´íŠ¸
        function updateMobilePagination(activeIndex) {
            const pagination = document.getElementById('spiritsPagination');
            if (!pagination) return;
            
            // í˜ì´ì§€ë„¤ì´ì…˜ HTML ìƒì„±
            let html = '';
            for (let i = 0; i < spirits.length; i++) {
                const activeClass = i === activeIndex ? 'swiper-pagination-bullet-active' : '';
                html += `<span class="swiper-pagination-bullet ${activeClass}" onclick="scrollToSpirit(${i})"></span>`;
            }
            pagination.innerHTML = html;
        }
        
        // íŠ¹ì • ì •ë ¹ìœ¼ë¡œ ìŠ¤í¬ë¡¤
        function scrollToSpirit(index) {
            const swiperEl = document.querySelector('.spirits-swiper');
            if (swiperEl) {
                const slideWidth = window.innerWidth;
                swiperEl.scrollTo({
                    left: index * slideWidth,
                    behavior: 'smooth'
                });
                currentSpiritIndex = index;
                updateMobilePagination(index);
            }
        }
        
        // ìŠ¬ë¼ì´ë” ì¸ë””ì¼€ì´í„° ì—…ë°ì´íŠ¸
        function updateSpiritSliderIndicator() {
            // CSS scroll-snapì´ ìë™ìœ¼ë¡œ ì²˜ë¦¬
        }
        
        // ìŠ¤í¬ë¡¤ ì‹œ í˜„ì¬ ì¸ë±ìŠ¤ ì—…ë°ì´íŠ¸
        function initSpiritSliderScroll() {
            // CSS scroll-snapì´ ìë™ìœ¼ë¡œ ì²˜ë¦¬
        }
        
        // ì •ë ¹ ì¹´ë“œ ìƒì„¸ ì •ë³´ í¼ì¹˜ê¸°/ì ‘ê¸° (ê¸°ë³¸ê°’: í¼ì¹¨)
        function toggleSpiritCardDetail(spiritId) {
            // í˜„ì¬ ìƒíƒœ ë°˜ì „ (undefinedë‚˜ trueë©´ falseë¡œ, falseë©´ trueë¡œ)
            const currentState = spiritCardExpanded[spiritId];
            spiritCardExpanded[spiritId] = currentState === false ? true : false;
            
            // localStorageì— ì €ì¥
            localStorage.setItem('spiritGarden_cardExpanded', JSON.stringify(spiritCardExpanded));
            
            const section = document.getElementById(`spiritDetail-${spiritId}`);
            const card = section?.closest('.spirit-card');
            const toggle = card?.querySelector('.spirit-card-toggle span');
            
            if (spiritCardExpanded[spiritId] === false) {
                // ì ‘í˜ ìƒíƒœ
                if (section) section.classList.remove('show');
                if (toggle) toggle.textContent = 'â–¼';
            } else {
                // í¼ì¹¨ ìƒíƒœ
                if (section) section.classList.add('show');
                if (toggle) toggle.textContent = 'â–²';
            }
        }

        function updateCoinDisplay() {
            const display = document.getElementById('coinDisplay');
            if (display) display.textContent = coins;
            // ëª¨ë°”ì¼ ì½”ì¸ í‘œì‹œë„ ì—…ë°ì´íŠ¸
            const mobileDisplay = document.getElementById('mobileCoinDisplay');
            if (mobileDisplay) mobileDisplay.textContent = coins;
        }

        function changeSellFilter() {
            const select = document.getElementById('sellFilterSelect');
            sellFilter = select.value;
            renderSellList();
        }

        function changeBuyFilter() {
            const select = document.getElementById('buyFilterSelect');
            buyFilter = select.value;
            renderBuyList();
        }

        // ìƒì  ì£¼ì¸ ëŒ€ì‚¬ ì‹œìŠ¤í…œ
        function updateShopkeeperDialogue() {
            const dialogueEl = document.getElementById('shopkeeperDialogue');
            if (!dialogueEl) return;
            
            let dialogue = '';
            let gaveGift = false;
            
            // ì‹¤ì œë¡œ ìƒì  íƒ­ì— ìˆì„ ë•Œë§Œ ëŒ€ì‚¬ ë° ì„ ë¬¼ ì²˜ë¦¬
            const isInShopTab = currentTab === 'shop';
            
            // ìš°ì„ ìˆœìœ„ ëŒ€ì‚¬ ì²´í¬
            if (!hasVisitedShop && isInShopTab) {
                // ì²« ë°©ë¬¸ (ìƒì  íƒ­ì— ìˆì„ ë•Œë§Œ)
                dialogue = 'ì²˜ìŒ ë³´ëŠ” ì–¼êµ´ì´ë„¤ìš”...';
                hasVisitedShop = true;
                saveGame();
            } else if (coins === 0 && isInShopTab) {
                // 0ì½”ì¸ì¼ ë•Œ ì„ ë¬¼ (ìƒì  íƒ­ì— ìˆì„ ë•Œë§Œ)
                dialogue = '...ì´ê±°ë¼ë„ ê°€ì ¸ê°€ìš”.';
                coins += 10;
                gaveGift = true;
                saveGame();
                updateCoinDisplay();
            } else if (coins <= 50) {
                // 50ì½”ì¸ ì´í•˜
                dialogue = 'ì£¼ë¨¸ë‹ˆê°€ ê°€ë²¼ì›Œ ë³´ì´ë„¤ìš”.';
            } else {
                // ì¼ë°˜ ëœë¤ ëŒ€ì‚¬
                const randomDialogues = [
                    'ì–´ì„œì˜¤ì„¸ìš”...',
                    'ë‚ ì”¨ê°€ ì¢‹ë„¤ìš”. ...ì‹«ë‹¤.',
                    'ë‚ ì´ ì¶”ì›Œì„œ ì¼í•˜ê¸° ì‹«ì–´ìš”.',
                    '<ê³„ì‚°ëŒ€ì— ì—ë“œë ¤ ìê³ ìˆë‹¤.>',
                    'ë˜ ì˜¤ì…¨ë„¤ìš”...',
                    'ì²œì²œíˆ ë‘˜ëŸ¬ë³´ì„¸ìš”...',
                    '...ë­˜ ë´ìš”.',
                    'ì˜¤ëŠ˜ì€ íŠ¹ë³„í•œ ê±´ ì—†ì–´ìš”.',
                    '...í•˜í’ˆ.',
                    'ì†ë‹˜ì´ ì˜¤ë©´ ì¼í•´ì•¼ í•˜ì–ì•„ìš”...'
                ];
                dialogue = randomDialogues[Math.floor(Math.random() * randomDialogues.length)];
            }
            
            dialogueEl.textContent = dialogue;
            
            // ì„ ë¬¼ ë°›ì•˜ì„ ë•Œ ì•Œë¦¼
            if (gaveGift) {
                setTimeout(() => {
                    showNotification('ğŸ’° ìƒì  ì£¼ì¸ì—ê²Œ 10ì½”ì¸ì„ ë°›ì•˜ìŠµë‹ˆë‹¤!');
                }, 500);
            }
        }
        
        // ìƒì  ì£¼ì¸ ëŒ€ì‚¬ ì§ì ‘ ì„¤ì •
        function setShopkeeperDialogue(text) {
            const dialogueEl = document.getElementById('shopkeeperDialogue');
            if (dialogueEl) {
                dialogueEl.textContent = text;
            }
        }
        
        function renderShop() {
            // íŠœí† ë¦¬ì–¼ ì§„í–‰ ì¤‘ì´ë©´ ì ‘ê¸° ìƒíƒœ ëª¨ë‘ í¼ì¹˜ê¸° (ì•½ì´ˆ ì°¾ê¸° ì‰½ê²Œ)
            if (sickTutorialActive || tutorialActive || tutorial2Active) {
                shopFoldState = { etc: false, food: false, music: false, decoration: false };
                shopBuyFoldState = { etc: false, food: false, music: false, decoration: false };
            }
            
            updateCoinDisplay();
            updateShopkeeperDialogue();
            renderSellList();
            renderBuyList();
        }
        
        function switchShopTab(tab) {
            currentShopTab = tab;
            
            const sellPage = document.getElementById('shopSellPage');
            const buyPage = document.getElementById('shopBuyPage');
            const sellTabBtn = document.getElementById('shopTabSell');
            const buyTabBtn = document.getElementById('shopTabBuy');
            
            // null ì²´í¬
            if (!sellPage || !buyPage || !sellTabBtn || !buyTabBtn) return;
            
            if (tab === 'sell') {
                sellPage.style.display = 'block';
                buyPage.style.display = 'none';
                sellTabBtn.style.background = 'var(--fire)';
                sellTabBtn.style.color = 'white';
                sellTabBtn.style.border = 'none';
                buyTabBtn.style.background = 'var(--card)';
                buyTabBtn.style.color = 'var(--text)';
                buyTabBtn.style.border = '1px solid var(--border)';
            } else {
                sellPage.style.display = 'none';
                buyPage.style.display = 'block';
                sellTabBtn.style.background = 'var(--card)';
                sellTabBtn.style.color = 'var(--text)';
                sellTabBtn.style.border = '1px solid var(--border)';
                buyTabBtn.style.background = 'var(--water)';
                buyTabBtn.style.color = 'white';
                buyTabBtn.style.border = 'none';
            }
            
            // ìƒë‹¨ ì„œë¸Œíƒ­ ë°” ì—…ë°ì´íŠ¸
            updateShopSubTabUI();
        }
        
        // ìƒì  ì„œë¸Œíƒ­ ë°” UI ì—…ë°ì´íŠ¸
        function updateShopSubTabUI() {
            // ë°ìŠ¤í¬í†± ì„œë¸Œíƒ­ ì—…ë°ì´íŠ¸
            const shopSubTabs = document.getElementById('shopSubTabs');
            if (shopSubTabs) {
                shopSubTabs.querySelectorAll('.sub-tab').forEach(btn => {
                    btn.classList.remove('active');
                    if (btn.dataset.tab === currentShopTab) {
                        btn.classList.add('active');
                    }
                });
            }
            
            // ëª¨ë°”ì¼ ì„œë¸Œíƒ­ ì—…ë°ì´íŠ¸
            const mobileShopSubTabs = document.getElementById('mobileShopSubTabs');
            if (mobileShopSubTabs) {
                mobileShopSubTabs.querySelectorAll('.mobile-sub-tab').forEach(btn => {
                    btn.classList.remove('active');
                    if (btn.dataset.tab === currentShopTab) {
                        btn.classList.add('active');
                    }
                });
            }
        }

        function renderSellList() {
            const container = document.getElementById('sellList');
            if (!container) return;

            // ì¹´í…Œê³ ë¦¬ë³„ ì•„ì´í…œ ë°°ì—´
            const etcItems = [];
            const foodItems = [];
            const musicItems = [];
            const decoItems = [];

            if (currentShopCategory === 'all' || currentShopCategory === 'food') {
                // ë¨¹ì´ íŒë§¤ (ìˆœì„œ ê³ ì •)
                if (inventory.food && inventory.food.length > 0) {
                    const foodCounts = {};
                    inventory.food.forEach(f => {
                        foodCounts[f] = (foodCounts[f] || 0) + 1;
                    });

                    const foodOrder = ['fire', 'water', 'wind', 'earth', 'light', 'dark'];
                    foodOrder.filter(type => foodCounts[type]).forEach(type => {
                        // ì†ì„± í•„í„° ì²´í¬
                        if (sellFilter === 'all') {
                            // ì „ì²´ ë³´ê¸°
                        } else if (['intelligence', 'strength', 'charm'].includes(sellFilter)) {
                            return; // ìŠ¤íƒ¯ í•„í„° ì‹œ ë¨¹ì´ ìˆ¨ê¹€
                        } else if (type !== sellFilter) {
                            return; // ë‹¤ë¥¸ ì†ì„±ì´ë©´ ìˆ¨ê¹€
                        }
                        
                        const count = foodCounts[type];
                        const isRare = type === 'light' || type === 'dark';
                        const price = isRare ? SHOP_PRICES.sell.food_rare : SHOP_PRICES.sell.food_common;
                        const effectText = isRare ? `${ENV_ICONS[type]} ì†ì„± +3, ì„±ì¥ +2` : `${ENV_ICONS[type]} ì†ì„± +1, ì„±ì¥ +2`;
                        const rarityLabel = isRare ? ' <span style="font-size: 0.75rem; color: #9b59b6;">í¬ê·€</span>' : '';
                        const isLocked = lockedItems.food.includes(type);
                        
                        // ì ê¸ˆ ëª¨ë“œì— ë”°ë¥¸ ë²„íŠ¼ ê²°ì •
                        let actionButton;
                        if (isLockMode) {
                            // ì ê¸ˆ ëª¨ë“œ: ì ê¸ˆ/í•´ì œ ë²„íŠ¼
                            actionButton = isLocked 
                                ? `<button onclick="toggleItemLock('food', '${type}')" style="padding: 8px 16px; background: #27ae60; color: white; border: none; border-radius: 4px; cursor: pointer;">í•´ì œ</button>`
                                : `<button onclick="toggleItemLock('food', '${type}')" style="padding: 8px 16px; background: #e74c3c; color: white; border: none; border-radius: 4px; cursor: pointer;">ì ê¸ˆ</button>`;
                        } else {
                            // íŒë§¤ ëª¨ë“œ: íŒë§¤ ë²„íŠ¼ (ì ê¸´ ì•„ì´í…œì€ ë¹„í™œì„±í™”)
                            actionButton = isLocked
                                ? `<button disabled style="padding: 8px 16px; background: #888; color: white; border: none; border-radius: 4px; cursor: not-allowed;">ğŸ”’</button>`
                                : `<button onclick="sellItem('food', '${type}')" style="padding: 8px 16px; background: var(--fire); color: white; border: none; border-radius: 4px; cursor: pointer; white-space: nowrap; min-width: 50px;">íŒë§¤</button>`;
                        }
                        
                        foodItems.push(`
                            <div style="display: flex; flex-direction: column; padding: 12px; background: var(--bg); border: 1px solid ${isLocked ? '#e74c3c' : 'var(--border)'}; border-radius: 8px; ${isLocked && !isLockMode ? 'opacity: 0.7;' : ''}">
                                <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px;">
                                    <span style="font-size: 1.5rem;">${ENV_ICONS[type]}</span>
                                    <div style="flex: 1; min-width: 0;">
                                        <div style="font-weight: 700; font-size: 0.9rem;">${FOOD_NAMES[type]} Ã—${count}${rarityLabel}${isLocked ? ' ğŸ”’' : ''}</div>
                                        <div style="font-size: 0.75rem; color: var(--text-muted);">${effectText}</div>
                                        <div style="font-size: 0.75rem; color: var(--text-muted);">íŒë§¤ê°€: ${price}ğŸ’°</div>
                                    </div>
                                </div>
                                ${actionButton.replace('padding: 8px 16px;', 'padding: 8px 16px; width: 100%;')}
                            </div>
                        `);
                    });
                    
                    // ì´ë²¤íŠ¸ ë¨¹ì´ íŒë§¤
                    Object.keys(foodCounts).forEach(type => {
                        const eventItem = EVENT_ITEMS[type];
                        if (!eventItem || eventItem.type !== 'food') return;
                        // ê¸°íƒ€ í•„í„°ì¼ ë•Œ ì´ë²¤íŠ¸ ì•„ì´í…œ ìˆ¨ê¹€
                        if (sellFilter === 'etc') return;
                        if (sellFilter !== 'all' && !['intelligence', 'strength', 'charm'].includes(sellFilter)) return;
                        
                        const count = foodCounts[type];
                        const isLocked = lockedItems.food.includes(type);
                        
                        let actionButton;
                        if (isLockMode) {
                            actionButton = isLocked 
                                ? `<button onclick="toggleItemLock('food', '${type}')" style="padding: 8px 16px; background: #27ae60; color: white; border: none; border-radius: 4px; cursor: pointer;">í•´ì œ</button>`
                                : `<button onclick="toggleItemLock('food', '${type}')" style="padding: 8px 16px; background: #e74c3c; color: white; border: none; border-radius: 4px; cursor: pointer;">ì ê¸ˆ</button>`;
                        } else {
                            actionButton = isLocked
                                ? `<button disabled style="padding: 8px 16px; background: #888; color: white; border: none; border-radius: 4px; cursor: not-allowed;">ğŸ”’</button>`
                                : `<button onclick="sellItem('food', '${type}')" style="padding: 8px 16px; background: #c41e3a; color: white; border: none; border-radius: 4px; cursor: pointer; white-space: nowrap; min-width: 50px;">íŒë§¤</button>`;
                        }
                        
                        foodItems.push(`
                            <div style="display: flex; flex-direction: column; padding: 12px; background: var(--bg); border: 2px solid ${isLocked ? '#e74c3c' : '#c41e3a'}; border-radius: 8px; ${isLocked && !isLockMode ? 'opacity: 0.7;' : ''}">
                                <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px;">
                                    <span style="font-size: 1.5rem;">ğŸ„${eventItem.icon}</span>
                                    <div style="flex: 1; min-width: 0;">
                                        <div style="font-weight: 700; font-size: 0.9rem;">${eventItem.name} Ã—${count} <span style="font-size: 0.7rem; color: #c41e3a;">ì´ë²¤íŠ¸</span>${isLocked ? ' ğŸ”’' : ''}</div>
                                        <div style="font-size: 0.75rem; color: #c41e3a;">ëª¨ë“  ìŠ¤íƒ¯ +5, ì„±ì¥ +10</div>
                                        <div style="font-size: 0.75rem; color: var(--text-muted);">íŒë§¤ê°€: 15ğŸ’°</div>
                                    </div>
                                </div>
                                ${actionButton.replace('padding: 8px 16px;', 'padding: 8px 16px; width: 100%;')}
                            </div>
                        `);
                    });
                    
                    // í•©ì„± ë¨¹ì´ íŒë§¤
                    Object.keys(foodCounts).forEach(type => {
                        const synthItem = SYNTH_ITEMS[type];
                        if (!synthItem || synthItem.type !== 'food') return;
                        
                        // ê¸°íƒ€ ì•„ì´í…œ (ìˆ˜ì„ í™” ê½ƒì, ì•„ì¹´ì‹œì•„ ê¿€)ì€ ê¸°íƒ€ í•„í„°ì—ì„œë§Œ í‘œì‹œ
                        const isEtcItem = ['reconciliation_flower', 'acacia_honey'].includes(type);
                        if (isEtcItem) {
                            if (sellFilter !== 'all' && sellFilter !== 'etc') return;
                        } else {
                            if (sellFilter !== 'all') return;
                        }
                        
                        const count = foodCounts[type];
                        const isLocked = lockedItems.food.includes(type);
                        
                        let effectText;
                        const isLegendaryMaterial = ['moon_cheese', 'golden_apple'].includes(type);
                        if (isLegendaryMaterial) {
                            effectText = 'íš¨ê³¼ ì—†ìŒ (í•©ì„± ì¬ë£Œ)';
                        } else if (synthItem.attr === 'all') {
                            effectText = `ì „ì†ì„± +${synthItem.attrGain}`;
                        } else if (synthItem.attr === 'dual') {
                            effectText = `${synthItem.dualAttr.join('+')} ê° +${synthItem.attrGain}`;
                        } else if (synthItem.attr === 'special') {
                            effectText = synthItem.desc;
                        } else {
                            effectText = `${synthItem.attr} +${synthItem.attrGain}`;
                        }
                        
                        const labelText = isLegendaryMaterial ? '<span style="font-size: 0.75rem; color: #ffd700;">ğŸŒŒì „ì„¤ì¬ë£Œ</span>' : isEtcItem ? '<span style="font-size: 0.75rem; color: #888;">ê¸°íƒ€</span>' : '<span style="font-size: 0.75rem; color: #9b59b6;">í•©ì„±</span>';
                        const borderColor = isLegendaryMaterial ? '#ffd700' : isEtcItem ? '#888' : '#9b59b6';
                        
                        let actionButton;
                        if (isLockMode) {
                            actionButton = isLocked 
                                ? `<button onclick="toggleItemLock('food', '${type}')" style="padding: 8px 16px; background: #27ae60; color: white; border: none; border-radius: 4px; cursor: pointer;">í•´ì œ</button>`
                                : `<button onclick="toggleItemLock('food', '${type}')" style="padding: 8px 16px; background: #e74c3c; color: white; border: none; border-radius: 4px; cursor: pointer;">ì ê¸ˆ</button>`;
                        } else {
                            actionButton = isLocked
                                ? `<button disabled style="padding: 8px 16px; background: #888; color: white; border: none; border-radius: 4px; cursor: not-allowed;">ğŸ”’</button>`
                                : `<button onclick="sellItem('food', '${type}')" style="padding: 8px 16px; background: #9b59b6; color: white; border: none; border-radius: 4px; cursor: pointer; white-space: nowrap; min-width: 50px;">íŒë§¤</button>`;
                        }
                        
                        const itemHtml = `
                            <div style="display: flex; flex-direction: column; padding: 12px; background: var(--bg); border: 2px solid ${isLocked ? '#e74c3c' : borderColor}; border-radius: 8px; ${isLocked && !isLockMode ? 'opacity: 0.7;' : ''}">
                                <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px;">
                                    <span style="font-size: 1.5rem;">${isLegendaryMaterial ? '' : isEtcItem ? '' : 'ğŸ”¬'}${synthItem.icon}</span>
                                    <div style="flex: 1; min-width: 0;">
                                        <div style="font-weight: 700; font-size: 0.9rem;">${synthItem.name} Ã—${count} ${labelText}${isLocked ? ' ğŸ”’' : ''}</div>
                                        <div style="font-size: 0.75rem; color: ${isLegendaryMaterial ? '#888' : '#9b59b6'};">${effectText}</div>
                                        <div style="font-size: 0.75rem; color: var(--text-muted);">íŒë§¤ê°€: 8ğŸ’°</div>
                                    </div>
                                </div>
                                ${actionButton.replace('padding: 8px 16px;', 'padding: 8px 16px; width: 100%;')}
                            </div>
                        `;
                        if (isEtcItem) {
                            etcItems.push(itemHtml);
                        } else {
                            foodItems.push(itemHtml);
                        }
                    });
                    
                    // ë§Œë³‘í†µì¹˜ ì•½ì´ˆ íŒë§¤
                    if (foodCounts['medicine']) {
                        if (sellFilter === 'all' || sellFilter === 'etc') {
                            const count = foodCounts['medicine'];
                            const isLocked = lockedItems.food.includes('medicine');
                            
                            let actionButton;
                            if (isLockMode) {
                                actionButton = isLocked 
                                    ? `<button onclick="toggleItemLock('food', 'medicine')" style="padding: 8px 16px; background: #27ae60; color: white; border: none; border-radius: 4px; cursor: pointer;">í•´ì œ</button>`
                                    : `<button onclick="toggleItemLock('food', 'medicine')" style="padding: 8px 16px; background: #e74c3c; color: white; border: none; border-radius: 4px; cursor: pointer;">ì ê¸ˆ</button>`;
                            } else {
                                actionButton = isLocked
                                    ? `<button disabled style="padding: 8px 16px; background: #888; color: white; border: none; border-radius: 4px; cursor: not-allowed;">ğŸ”’</button>`
                                    : `<button onclick="sellItem('food', 'medicine')" style="padding: 8px 16px; background: #27ae60; color: white; border: none; border-radius: 4px; cursor: pointer; white-space: nowrap; min-width: 50px;">íŒë§¤</button>`;
                            }
                            
                            etcItems.push(`
                                <div style="display: flex; flex-direction: column; padding: 12px; background: var(--bg); border: 1px solid ${isLocked ? '#e74c3c' : 'var(--border)'}; border-radius: 8px; ${isLocked && !isLockMode ? 'opacity: 0.7;' : ''}">
                                    <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px;">
                                        <span style="font-size: 1.5rem;">${MEDICINE.icon}</span>
                                        <div style="flex: 1; min-width: 0;">
                                            <div style="font-weight: 700; font-size: 0.9rem;">${MEDICINE.name} Ã—${count} <span style="font-size: 0.7rem; color: var(--text-muted);">ê¸°íƒ€</span>${isLocked ? ' ğŸ”’' : ''}</div>
                                            <div style="font-size: 0.75rem; color: var(--text-muted);">${MEDICINE.description}</div>
                                            <div style="font-size: 0.75rem; color: var(--text-muted);">íŒë§¤ê°€: 10ğŸ’°</div>
                                        </div>
                                    </div>
                                    ${actionButton.replace('padding: 8px 16px;', 'padding: 8px 16px; width: 100%;')}
                                </div>
                            `);
                        }
                    }
                }
            }
            
            if (currentShopCategory === 'all' || currentShopCategory === 'decoration') {
                // ë¯¸ë‹ˆì–´ì²˜ íŒë§¤ (ì†ì„± â†’ í’ˆì§ˆ â†’ ì´ë¦„ ìˆœ ì •ë ¬)
                if (inventory.decorations && inventory.decorations.length > 0) {
                    const decorCounts = {};
                    inventory.decorations.forEach(d => {
                        decorCounts[d] = (decorCounts[d] || 0) + 1;
                    });
                    
                    // í•©ì„± ì „ìš© ì•„ì´í…œë„ íŒë§¤ ê°€ëŠ¥í•˜ë„ë¡ ë³€ê²½ (ì œì™¸ ëª©ë¡ ì‚­ì œ)

                    // ì†ì„±ë³„, í’ˆì§ˆë³„, ì´ë¦„ë³„ë¡œ ì •ë ¬
                    const sortedDecoKeys = Object.keys(decorCounts).filter(key => DECORATION_TYPES[key]).sort((a, b) => {
                        const dataA = DECORATION_TYPES[a];
                        const dataB = DECORATION_TYPES[b];
                        if (!dataA || !dataB) return 0;
                        
                        // 1. ì†ì„±ë³„ ì •ë ¬
                        const attrOrder = { fire: 0, water: 1, wind: 2, earth: 3, light: 4, dark: 5 };
                        const attrDiff = (attrOrder[dataA.attr] || 0) - (attrOrder[dataB.attr] || 0);
                        if (attrDiff !== 0) return attrDiff;
                        
                        // 2. í’ˆì§ˆë³„ ì •ë ¬ (ë†’ì€ ìˆœ: legendary > epic > rare > common)
                        const qualityOrder = { legendary: 0, epic: 1, rare: 2, common: 3 };
                        const qualityDiff = (qualityOrder[dataA.quality] || 3) - (qualityOrder[dataB.quality] || 3);
                        if (qualityDiff !== 0) return qualityDiff;
                        
                        // 3. ì´ë¦„ë³„ ì •ë ¬
                        return dataA.name.localeCompare(dataB.name);
                    });
                    
                    sortedDecoKeys.forEach(key => {
                        const decoData = DECORATION_TYPES[key];
                        if (!decoData) return; // ë°ì´í„° ì—†ìœ¼ë©´ ìŠ¤í‚µ
                        
                        // ì†ì„± í•„í„° ì²´í¬
                        if (sellFilter === 'all') {
                            // ì „ì²´ ë³´ê¸°
                        } else if (['intelligence', 'strength', 'charm'].includes(sellFilter)) {
                            return; // ìŠ¤íƒ¯ í•„í„° ì‹œ ë¯¸ë‹ˆì–´ì²˜ ìˆ¨ê¹€
                        } else if (decoData.attr === 'dual') {
                            if (!decoData.dualAttr || !decoData.dualAttr.includes(sellFilter)) return;
                        } else if (decoData.attr === 'all') {
                            // all ì†ì„± ë¯¸ë‹ˆì–´ì²˜ì€ ëª¨ë“  ì†ì„± í•„í„°ì—ì„œ í‘œì‹œ
                        } else if (decoData.attr !== sellFilter) {
                            return; // ë‹¤ë¥¸ ì†ì„±ì´ë©´ ìˆ¨ê¹€
                        }
                        
                        const count = decorCounts[key];
                        
                        const sellPrice = Math.floor(decoData.price * 0.5); // íŒë§¤ê°€ëŠ” êµ¬ë§¤ê°€ì˜ 50%
                        const qualityLabel = decoData.quality === 'legendary' ? 'ğŸ‘‘' : decoData.quality === 'epic' ? 'â­' : decoData.quality === 'rare' ? 'ğŸ’' : '';
                        const qualityText = decoData.quality === 'legendary' ? '<span style="color: #ff6b35;">ì „ì„¤</span>' : decoData.quality === 'epic' ? '<span style="color: #9b59b6;">ìµœìƒê¸‰</span>' : decoData.quality === 'rare' ? '<span style="color: #3498db;">í¬ê·€</span>' : '<span style="color: #888;">ì¼ë°˜</span>';
                        
                        // ë“±ê¸‰ë³„ í…Œë‘ë¦¬ ìƒ‰
                        const qualityBorderColor = decoData.quality === 'legendary' ? '#ffd700' : decoData.quality === 'epic' ? '#9b59b6' : decoData.quality === 'rare' ? '#3498db' : 'var(--border)';
                        
                        // ì†ì„± í‘œì‹œ (ë³µí•© ì†ì„± ì²˜ë¦¬)
                        let attrDisplay = '';
                        if (decoData.attr === 'dual' && decoData.dualAttr) {
                            attrDisplay = decoData.dualAttr.map(a => ENV_ICONS[a]).join('') + ` +${decoData.power}`;
                        } else if (decoData.attr === 'all') {
                            attrDisplay = 'ğŸŒˆ ì „ì²´ ì†ì„± +' + decoData.power;
                        } else {
                            const attrName = { fire: 'ë¶ˆ', water: 'ë¬¼', wind: 'ë°”ëŒ', earth: 'ë•…', light: 'ë¹›', dark: 'ì–´ë‘ ' }[decoData.attr] || '';
                            attrDisplay = `${ENV_ICONS[decoData.attr]} ${attrName} ì†ì„± +${decoData.power}`;
                        }
                        
                        const isLocked = lockedItems.decorations.includes(key);
                        
                        // ì ê¸ˆ ëª¨ë“œì— ë”°ë¥¸ ë²„íŠ¼ ê²°ì •
                        let actionButton;
                        if (isLockMode) {
                            // ì ê¸ˆ ëª¨ë“œ: ì ê¸ˆ/í•´ì œ ë²„íŠ¼
                            actionButton = isLocked 
                                ? `<button onclick="toggleItemLock('decoration', '${key}')" style="padding: 8px 16px; background: #27ae60; color: white; border: none; border-radius: 4px; cursor: pointer;">í•´ì œ</button>`
                                : `<button onclick="toggleItemLock('decoration', '${key}')" style="padding: 8px 16px; background: #e74c3c; color: white; border: none; border-radius: 4px; cursor: pointer;">ì ê¸ˆ</button>`;
                        } else {
                            // íŒë§¤ ëª¨ë“œ: íŒë§¤ ë²„íŠ¼ (ì ê¸´ ì•„ì´í…œì€ ë¹„í™œì„±í™”)
                            actionButton = isLocked
                                ? `<button disabled style="padding: 8px 16px; background: #888; color: white; border: none; border-radius: 4px; cursor: not-allowed;">ğŸ”’</button>`
                                : `<button onclick="sellItem('decoration', '${key}')" style="padding: 8px 16px; background: var(--fire); color: white; border: none; border-radius: 4px; cursor: pointer; white-space: nowrap; min-width: 50px;">íŒë§¤</button>`;
                        }
                        
                        decoItems.push(`
                            <div style="display: flex; flex-direction: column; padding: 12px; background: var(--bg); border: 2px solid ${isLocked ? '#e74c3c' : qualityBorderColor}; border-radius: 8px; ${isLocked && !isLockMode ? 'opacity: 0.7;' : ''}">
                                <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px;">
                                    <span style="font-size: 1.5rem;">${qualityLabel}${decoData.icon}</span>
                                    <div style="flex: 1; min-width: 0;">
                                        <div style="font-weight: 700; font-size: 0.9rem;">${decoData.name} Ã—${count}${isLocked ? ' ğŸ”’' : ''}</div>
                                        <div style="font-size: 0.75rem; color: var(--text-muted);">${attrDisplay} | ${qualityText}</div>
                                        <div style="font-size: 0.75rem; color: var(--text-muted);">íŒë§¤ê°€: ${sellPrice}ğŸ’°</div>
                                    </div>
                                </div>
                                ${actionButton.replace('padding: 8px 16px;', 'padding: 8px 16px; width: 100%;')}
                            </div>
                        `);
                    });
                    
                    // ì´ë²¤íŠ¸ ë¯¸ë‹ˆì–´ì²˜ íŒë§¤
                    Object.keys(decorCounts).forEach(key => {
                        const eventItem = EVENT_ITEMS[key];
                        if (!eventItem || eventItem.type !== 'decoration') return;
                        if (sellFilter !== 'all') return;
                        
                        const count = decorCounts[key];
                        const isLocked = lockedItems.decorations.includes(key);
                        
                        let actionButton;
                        if (isLockMode) {
                            actionButton = isLocked 
                                ? `<button onclick="toggleItemLock('decoration', '${key}')" style="padding: 8px 16px; background: #27ae60; color: white; border: none; border-radius: 4px; cursor: pointer;">í•´ì œ</button>`
                                : `<button onclick="toggleItemLock('decoration', '${key}')" style="padding: 8px 16px; background: #e74c3c; color: white; border: none; border-radius: 4px; cursor: pointer;">ì ê¸ˆ</button>`;
                        } else {
                            actionButton = isLocked
                                ? `<button disabled style="padding: 8px 16px; background: #888; color: white; border: none; border-radius: 4px; cursor: not-allowed;">ğŸ”’</button>`
                                : `<button onclick="sellItem('decoration', '${key}')" style="padding: 8px 16px; background: #c41e3a; color: white; border: none; border-radius: 4px; cursor: pointer; white-space: nowrap; min-width: 50px;">íŒë§¤</button>`;
                        }
                        
                        decoItems.push(`
                            <div style="display: flex; flex-direction: column; padding: 12px; background: var(--bg); border: 2px solid ${isLocked ? '#e74c3c' : '#c41e3a'}; border-radius: 8px; ${isLocked && !isLockMode ? 'opacity: 0.7;' : ''}">
                                <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px;">
                                    <span style="font-size: 1.5rem;">ğŸ‘‘ğŸ„${eventItem.icon}</span>
                                    <div style="flex: 1; min-width: 0;">
                                        <div style="font-weight: 700; font-size: 0.9rem;">${eventItem.name} Ã—${count} <span style="font-size: 0.7rem; color: #c41e3a;">ì´ë²¤íŠ¸</span>${isLocked ? ' ğŸ”’' : ''}</div>
                                        <div style="font-size: 0.75rem; color: #c41e3a;">ëª¨ë“  ì†ì„± +5</div>
                                        <div style="font-size: 0.75rem; color: var(--text-muted);">íŒë§¤ê°€: 25ğŸ’°</div>
                                    </div>
                                </div>
                                ${actionButton.replace('padding: 8px 16px;', 'padding: 8px 16px; width: 100%;')}
                            </div>
                        `);
                    });
                    
                    // í•©ì„± ë¯¸ë‹ˆì–´ì²˜ íŒë§¤
                    Object.keys(decorCounts).forEach(key => {
                        const synthItem = SYNTH_ITEMS[key];
                        if (!synthItem || synthItem.type !== 'decoration') return;
                        if (sellFilter !== 'all') return;
                        
                        const count = decorCounts[key];
                        const isLocked = lockedItems.decorations.includes(key);
                        
                        let actionButton;
                        if (isLockMode) {
                            actionButton = isLocked 
                                ? `<button onclick="toggleItemLock('decoration', '${key}')" style="padding: 8px 16px; background: #27ae60; color: white; border: none; border-radius: 4px; cursor: pointer;">í•´ì œ</button>`
                                : `<button onclick="toggleItemLock('decoration', '${key}')" style="padding: 8px 16px; background: #e74c3c; color: white; border: none; border-radius: 4px; cursor: pointer;">ì ê¸ˆ</button>`;
                        } else {
                            actionButton = isLocked
                                ? `<button disabled style="padding: 8px 16px; background: #888; color: white; border: none; border-radius: 4px; cursor: not-allowed;">ğŸ”’</button>`
                                : `<button onclick="sellItem('decoration', '${key}')" style="padding: 8px 16px; background: #9b59b6; color: white; border: none; border-radius: 4px; cursor: pointer; white-space: nowrap; min-width: 50px;">íŒë§¤</button>`;
                        }
                        
                        decoItems.push(`
                            <div style="display: flex; flex-direction: column; padding: 12px; background: var(--bg); border: 2px solid ${isLocked ? '#e74c3c' : '#9b59b6'}; border-radius: 8px; ${isLocked && !isLockMode ? 'opacity: 0.7;' : ''}">
                                <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px;">
                                    <span style="font-size: 1.5rem;">ğŸ”¬${synthItem.icon}</span>
                                    <div style="flex: 1; min-width: 0;">
                                        <div style="font-weight: 700; font-size: 0.9rem;">${synthItem.name} Ã—${count} <span style="font-size: 0.7rem; color: #9b59b6;">í•©ì„±</span>${isLocked ? ' ğŸ”’' : ''}</div>
                                        <div style="font-size: 0.75rem; color: #9b59b6;">${synthItem.attr} +${synthItem.power}</div>
                                        <div style="font-size: 0.75rem; color: var(--text-muted);">íŒë§¤ê°€: 20ğŸ’°</div>
                                    </div>
                                </div>
                                ${actionButton.replace('padding: 8px 16px;', 'padding: 8px 16px; width: 100%;')}
                            </div>
                        `);
                    });
                }
            }

            

            if (currentShopCategory === 'all' || currentShopCategory === 'music') {
                // ìŒì•… íŒë§¤ (ëª¨ë“  MUSIC_TYPES ë ˆì½”ë“œ)
                if (inventory.music && inventory.music.length > 0) {
                    const musicCounts = {};
                    inventory.music.forEach(m => {
                        musicCounts[m] = (musicCounts[m] || 0) + 1;
                    });

                    // ëª¨ë“  MUSIC_TYPES ë ˆì½”ë“œ í‘œì‹œ (í‹°ì–´ìˆœ ì •ë ¬)
                    Object.keys(MUSIC_TYPES).forEach(type => {
                        if (!musicCounts[type]) return;
                        
                        const musicData = MUSIC_TYPES[type];
                        
                        // ìŠ¤íƒ¯ í•„í„° ì²´í¬ (stats ê¸°ë°˜ ë™ì  í•„í„°ë§)
                        if (sellFilter === 'all') {
                            // ì „ì²´ ë³´ê¸°
                        } else if (sellFilter === 'intelligence') {
                            if (!musicData.stats?.intelligence) return;
                        } else if (sellFilter === 'strength') {
                            if (!musicData.stats?.strength) return;
                        } else if (sellFilter === 'charm') {
                            if (!musicData.stats?.charm) return;
                        } else if (['fire', 'water', 'wind', 'earth', 'light', 'dark'].includes(sellFilter)) {
                            return; // ì†ì„± í•„í„° ì‹œ ìŒì•… ìˆ¨ê¹€
                        }
                        
                        const count = musicCounts[type];
                        const isLocked = lockedItems.music.includes(type);
                        
                        // í‹°ì–´ë³„ ìƒ‰ìƒ
                        const tierColor = musicData.tier === 4 ? '#ffd700' : musicData.tier === 3 ? '#9b59b6' : musicData.tier === 2 ? '#3498db' : 'var(--border)';
                        const tierLabel = musicData.tier === 4 ? ' <span style="color: #ffd700;">ğŸ‘‘ì „ì„¤</span>' : 
                                         musicData.tier === 3 ? ' <span style="color: #9b59b6;">âœ¨í”„ë¦¬ë¯¸ì—„</span>' : 
                                         musicData.tier === 2 ? ' <span style="color: #3498db;">â˜…ì¥ë¥´</span>' : '';
                        
                        // ì ê¸ˆ ëª¨ë“œì— ë”°ë¥¸ ë²„íŠ¼ ê²°ì •
                        let actionBtn;
                        if (isLockMode) {
                            actionBtn = isLocked 
                                ? `<button onclick="toggleItemLock('music', '${type}')" style="padding: 8px 16px; background: #27ae60; color: white; border: none; border-radius: 4px; cursor: pointer;">í•´ì œ</button>`
                                : `<button onclick="toggleItemLock('music', '${type}')" style="padding: 8px 16px; background: #e74c3c; color: white; border: none; border-radius: 4px; cursor: pointer;">ì ê¸ˆ</button>`;
                        } else {
                            actionBtn = isLocked 
                                ? `<button disabled style="padding: 8px 16px; background: #95a5a6; color: white; border: none; border-radius: 4px; cursor: not-allowed;">ğŸ”’ ì ê¸ˆ</button>`
                                : `<button onclick="sellItem('music', '${type}')" style="padding: 8px 16px; background: var(--fire); color: white; border: none; border-radius: 4px; cursor: pointer; white-space: nowrap; min-width: 50px;">íŒë§¤</button>`;
                        }
                        
                        musicItems.push(`
                            <div style="display: flex; flex-direction: column; padding: 12px; background: var(--bg); border: 2px solid ${isLocked ? '#27ae60' : tierColor}; border-radius: 8px;">
                                <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px;">
                                    <span style="font-size: 1.5rem;">${musicData.icon}</span>
                                    <div style="flex: 1; min-width: 0;">
                                        <div style="font-weight: 700; font-size: 0.9rem;">${musicData.name} Ã—${count}${tierLabel}</div>
                                        <div style="font-size: 0.75rem; color: var(--text-muted);">${musicData.effect}</div>
                                        <div style="font-size: 0.75rem; color: var(--text-muted);">íŒë§¤ê°€: ${SHOP_PRICES.sell.music}ğŸ’°</div>
                                    </div>
                                </div>
                                ${actionBtn.replace('padding: 8px 16px;', 'padding: 8px 16px; width: 100%;')}
                            </div>
                        `);
                    });
                    
                    // ì´ë²¤íŠ¸ ìŒì•… íŒë§¤ (ìºë¡¤ ë“±)
                    Object.keys(musicCounts).forEach(type => {
                        const eventItem = EVENT_ITEMS[type];
                        if (!eventItem || eventItem.type !== 'music') return;
                        if (sellFilter !== 'all' && !['intelligence', 'strength', 'charm'].includes(sellFilter)) return;
                        
                        const count = musicCounts[type];
                        const isLocked = lockedItems.music.includes(type);
                        
                        // ì ê¸ˆ ëª¨ë“œì— ë”°ë¥¸ ë²„íŠ¼ ê²°ì •
                        let actionBtn;
                        if (isLockMode) {
                            // ì ê¸ˆ ëª¨ë“œ: ì ê¸ˆ/í•´ì œ ë²„íŠ¼
                            actionBtn = isLocked 
                                ? `<button onclick="toggleItemLock('music', '${type}')" style="padding: 8px 16px; background: #27ae60; color: white; border: none; border-radius: 4px; cursor: pointer;">í•´ì œ</button>`
                                : `<button onclick="toggleItemLock('music', '${type}')" style="padding: 8px 16px; background: #e74c3c; color: white; border: none; border-radius: 4px; cursor: pointer;">ì ê¸ˆ</button>`;
                        } else {
                            // ì¼ë°˜ ëª¨ë“œ: íŒë§¤ ë²„íŠ¼ ë˜ëŠ” ì ê¸ˆ í‘œì‹œ
                            actionBtn = isLocked 
                                ? `<button disabled style="padding: 8px 16px; background: #95a5a6; color: white; border: none; border-radius: 4px; cursor: not-allowed;">ğŸ”’ ì ê¸ˆ</button>`
                                : `<button onclick="sellItem('music', '${type}')" style="padding: 8px 16px; background: #c41e3a; color: white; border: none; border-radius: 4px; cursor: pointer; white-space: nowrap; min-width: 50px;">íŒë§¤</button>`;
                        }
                        
                        musicItems.push(`
                            <div style="display: flex; flex-direction: column; padding: 12px; background: var(--bg); border: 2px solid ${isLocked ? '#27ae60' : '#c41e3a'}; border-radius: 8px;">
                                <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px;">
                                    <span style="font-size: 1.5rem;">ğŸ„${eventItem.icon}</span>
                                    <div style="flex: 1; min-width: 0;">
                                        <div style="font-weight: 700; font-size: 0.9rem;">${eventItem.name} Ã—${count} <span style="font-size: 0.7rem; color: #c41e3a;">ì´ë²¤íŠ¸</span></div>
                                        <div style="font-size: 0.75rem; color: #c41e3a;">ëª¨ë“  ìŠ¤íƒ¯ +5</div>
                                        <div style="font-size: 0.75rem; color: var(--text-muted);">íŒë§¤ê°€: 12ğŸ’°</div>
                                    </div>
                                </div>
                                ${actionBtn.replace('padding: 8px 16px;', 'padding: 8px 16px; width: 100%;')}
                            </div>
                        `);
                    });
                }
            }

            const totalItems = etcItems.length + foodItems.length + musicItems.length + decoItems.length;
            
            if (totalItems === 0) {
                container.innerHTML = '<p style="color: #888; text-align: center; padding: 20px;">íŒë§¤í•  ë¬¼í’ˆì´ ì—†ìŠµë‹ˆë‹¤</p>';
            } else {
                // ì ê¸ˆ ëª¨ë“œì¼ ë•ŒëŠ” ì•ˆë‚´ í‘œì‹œ, ì•„ë‹ ë•ŒëŠ” ì¼ê´„ íŒë§¤ ë“œë¡­ë‹¤ìš´
                let headerHtml = '';
                if (isLockMode) {
                    headerHtml = `
                        <div style="margin-bottom: 15px; padding: 12px; background: #fff3cd; border: 1px solid #ffc107; border-radius: 8px;">
                            <div style="font-weight: 600; color: #856404; font-size: 0.9rem;">ğŸ”’ ì ê¸ˆ ëª¨ë“œ</div>
                            <div style="font-size: 0.85rem; color: #856404; margin-top: 4px;">ì•„ì´í…œì„ í´ë¦­í•˜ë©´ íŒë§¤ê°€ ì ê¸ˆ/í•´ì œë©ë‹ˆë‹¤.</div>
                        </div>
                    `;
                } else {
                    headerHtml = `
                        <div style="margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
                            <select id="bulkSellSelect" style="padding: 8px 12px; font-size: 0.9rem; border: 1px solid var(--border); border-radius: 6px; background: var(--card); color: var(--text); cursor: pointer; flex: 1;">
                                <option value="">ğŸ“¦ ì¼ê´„ íŒë§¤ ì„ íƒ...</option>
                                <optgroup label="ğŸ ë¨¹ì´">
                                    <option value="food_common">ì¼ë°˜ ë¨¹ì´ ì „ì²´</option>
                                    <option value="food_rare">í¬ê·€ ë¨¹ì´ ì „ì²´</option>
                                </optgroup>
                                <optgroup label="ğŸ¨ ë¯¸ë‹ˆì–´ì²˜">
                                    <option value="deco_common">ì¼ë°˜ ë¯¸ë‹ˆì–´ì²˜ ì „ì²´</option>
                                    <option value="deco_rare">í¬ê·€ ì´í•˜ ì „ì²´</option>
                                    <option value="deco_epic">ìµœìƒê¸‰ ì´í•˜ ì „ì²´</option>
                                </optgroup>
                            </select>
                            <button onclick="executeBulkSell()" style="padding: 8px 16px; background: var(--fire); color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; white-space: nowrap;">íŒë§¤</button>
                        </div>
                        <div style="font-size: 0.8rem; color: #888; margin-bottom: 15px;">â€» ì ê¸ˆëœ ì•„ì´í…œì€ ì œì™¸ë©ë‹ˆë‹¤</div>
                    `;
                }
                
                // ì¹´í…Œê³ ë¦¬ë³„ ì ‘ê¸° ê°€ëŠ¥í•œ ì„¹ì…˜ ìƒì„±
                let sectionsHtml = '';
                
                // ê¸°íƒ€ ì„¹ì…˜
                if (etcItems.length > 0) {
                    const isFolded = shopFoldState.etc;
                    sectionsHtml += `
                        <div class="shop-category-section" style="margin-bottom: 15px;">
                            <div onclick="toggleShopFold('etc')" style="display: flex; justify-content: space-between; align-items: center; padding: 10px 12px; background: #888; color: white; border-radius: 6px; cursor: pointer; margin-bottom: ${isFolded ? '0' : '10px'};">
                                <span style="font-weight: 600;">ğŸ“¦ ê¸°íƒ€ (${etcItems.length})</span>
                                <span>${isFolded ? 'â–¶' : 'â–¼'}</span>
                            </div>
                            <div id="shopEtcContent" class="shop-items-grid" style="display: ${isFolded ? 'none' : 'grid'};">
                                ${etcItems.join('')}
                            </div>
                        </div>
                    `;
                }
                
                // ë¨¹ì´ ì„¹ì…˜
                if (foodItems.length > 0) {
                    const isFolded = shopFoldState.food;
                    sectionsHtml += `
                        <div class="shop-category-section" style="margin-bottom: 15px;">
                            <div onclick="toggleShopFold('food')" style="display: flex; justify-content: space-between; align-items: center; padding: 10px 12px; background: var(--fire); color: white; border-radius: 6px; cursor: pointer; margin-bottom: ${isFolded ? '0' : '10px'};">
                                <span style="font-weight: 600;">ğŸ ë¨¹ì´ (${foodItems.length})</span>
                                <span>${isFolded ? 'â–¶' : 'â–¼'}</span>
                            </div>
                            <div id="shopFoodContent" class="shop-items-grid" style="display: ${isFolded ? 'none' : 'grid'};">
                                ${foodItems.join('')}
                            </div>
                        </div>
                    `;
                }
                
                // ë ˆì½”ë“œ ì„¹ì…˜
                if (musicItems.length > 0) {
                    const isFolded = shopFoldState.music;
                    sectionsHtml += `
                        <div class="shop-category-section" style="margin-bottom: 15px;">
                            <div onclick="toggleShopFold('music')" style="display: flex; justify-content: space-between; align-items: center; padding: 10px 12px; background: #9b59b6; color: white; border-radius: 6px; cursor: pointer; margin-bottom: ${isFolded ? '0' : '10px'};">
                                <span style="font-weight: 600;">ğŸµ ë ˆì½”ë“œ (${musicItems.length})</span>
                                <span>${isFolded ? 'â–¶' : 'â–¼'}</span>
                            </div>
                            <div id="shopMusicContent" class="shop-items-grid" style="display: ${isFolded ? 'none' : 'grid'};">
                                ${musicItems.join('')}
                            </div>
                        </div>
                    `;
                }
                
                // ë¯¸ë‹ˆì–´ì²˜ ì„¹ì…˜
                if (decoItems.length > 0) {
                    const isFolded = shopFoldState.decoration;
                    sectionsHtml += `
                        <div class="shop-category-section" style="margin-bottom: 15px;">
                            <div onclick="toggleShopFold('decoration')" style="display: flex; justify-content: space-between; align-items: center; padding: 10px 12px; background: var(--earth); color: white; border-radius: 6px; cursor: pointer; margin-bottom: ${isFolded ? '0' : '10px'};">
                                <span style="font-weight: 600;">ğŸŒ³ ë¯¸ë‹ˆì–´ì²˜ (${decoItems.length})</span>
                                <span>${isFolded ? 'â–¶' : 'â–¼'}</span>
                            </div>
                            <div id="shopDecoContent" class="shop-items-grid" style="display: ${isFolded ? 'none' : 'grid'};">
                                ${decoItems.join('')}
                            </div>
                        </div>
                    `;
                }
                
                container.innerHTML = headerHtml + sectionsHtml;
            }
        }
        
        // ìƒì  ì¹´í…Œê³ ë¦¬ ì ‘ê¸°/í¼ì¹˜ê¸° í† ê¸€
        function toggleShopFold(category) {
            shopFoldState[category] = !shopFoldState[category];
            renderSellList();
        }

        function renderBuyList() {
            const container = document.getElementById('buyList');
            if (!container) return;

            // ì¹´í…Œê³ ë¦¬ë³„ ì•„ì´í…œ ë°°ì—´
            const etcItems = [];
            const foodItems = [];
            const musicItems = [];
            const decoItems = [];
            
            // ì´ë²¤íŠ¸ ì•„ì´í…œ ì„¹ì…˜ (í™œì„±í™”ëœ ì´ë²¤íŠ¸ê°€ ìˆê³ , ê¸°ê°„ ë‚´ì¼ ë•Œë§Œ)
            // ì¹´í…Œê³ ë¦¬ í•„í„°ì— ë§ëŠ” ì´ë²¤íŠ¸ ì•„ì´í…œë§Œ í‘œì‹œ
            if (activatedEvents && activatedEvents.length > 0) {
                activatedEvents.forEach(eventType => {
                    const event = EVENT_TYPES[eventType];
                    if (!event) return;
                    
                    // ì´ë²¤íŠ¸ ê¸°ê°„ ì²´í¬
                    if (event.validUntil && new Date() > new Date(event.validUntil)) return;
                    
                    // í•´ë‹¹ ì´ë²¤íŠ¸ì˜ ì•„ì´í…œë“¤
                    Object.keys(EVENT_ITEMS).forEach(itemKey => {
                        const item = EVENT_ITEMS[itemKey];
                        if (item.event !== eventType) return;
                        
                        // ì¹´í…Œê³ ë¦¬ í•„í„° ì ìš©
                        if (currentShopCategory !== 'all') {
                            if (currentShopCategory === 'food' && item.type !== 'food') return;
                            if (currentShopCategory === 'music' && item.type !== 'music') return;
                            if (currentShopCategory === 'decoration' && item.type !== 'decoration') return;
                        }
                        
                        // ì„¸ë¶€ í•„í„° ì ìš©
                        if (buyFilter !== 'all') {
                            // ê¸°íƒ€ í•„í„°ì¼ ë•Œ ì´ë²¤íŠ¸ ì•„ì´í…œ ìˆ¨ê¹€
                            if (buyFilter === 'etc') return;
                            // ì†ì„± í•„í„°ì¼ ë•Œ ìŒì•…ì€ ìˆ¨ê¹€
                            if (['fire', 'water', 'wind', 'earth', 'light', 'dark'].includes(buyFilter) && item.type === 'music') return;
                            // ìŠ¤íƒ¯ í•„í„°ì¼ ë•Œ ë¨¹ì´/ë¯¸ë‹ˆì–´ì²˜ì€ ìˆ¨ê¹€
                            if (['intelligence', 'strength', 'charm'].includes(buyFilter) && item.type !== 'music') return;
                        }
                        
                        const price = item.type === 'food' ? 30 : item.type === 'music' ? 100 : 50;
                        
                        // ë³´ìœ ëŸ‰ ê³„ì‚°
                        let ownedCount = 0;
                        if (item.type === 'food') {
                            ownedCount = inventory.food ? inventory.food.filter(f => f === itemKey).length : 0;
                        } else if (item.type === 'music') {
                            ownedCount = inventory.music ? inventory.music.filter(m => m === itemKey).length : 0;
                        } else if (item.type === 'decoration') {
                            // ì¸ë²¤í† ë¦¬ + í…Œë¼ë¦¬ì›€ì— ì„¤ì¹˜ëœ ë¯¸ë‹ˆì–´ì²˜
                            const inInventory = inventory.decorations ? inventory.decorations.filter(d => d === itemKey).length : 0;
                            const installed = installedDecorations ? installedDecorations.filter(d => d.type === itemKey).length : 0;
                            ownedCount = inInventory + installed;
                        }
                        
                        const itemHtml = `
                            <div style="display: flex; flex-direction: column; padding: 12px; background: var(--bg); border: 1px solid ${item.quality === 'legendary' ? '#ffd700' : item.quality === 'epic' ? '#9b59b6' : '#c41e3a'}; border-radius: 8px;">
                                <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px;">
                                    <span style="font-size: 1.5rem;">${item.quality === 'legendary' ? 'ğŸ‘‘' : ''}${item.icon}</span>
                                    <div style="flex: 1; min-width: 0;">
                                        <div style="font-weight: 700; font-size: 0.9rem;">${item.name} <span style="font-size: 0.65rem; color: #ffd700;">ğŸ„${item.quality === 'legendary' ? 'ì „ì„¤' : 'í•œì •'}</span> <span style="font-size: 0.7rem; color: var(--text-muted);">(${ownedCount})</span></div>
                                        <div style="font-size: 0.7rem; color: var(--text-muted);">${item.desc}</div>
                                        <div style="font-size: 0.75rem; color: #ffd700;">ê°€ê²©: ${price}ğŸ’°</div>
                                    </div>
                                </div>
                                <button onclick="buyEventItem('${itemKey}', ${price})" style="padding: 8px 16px; width: 100%;">êµ¬ë§¤</button>
                            </div>
                        `;
                        
                        // íƒ€ì…ì— ë”°ë¼ í•´ë‹¹ ì¹´í…Œê³ ë¦¬ì— ì¶”ê°€
                        if (item.type === 'food') foodItems.push(itemHtml);
                        else if (item.type === 'music') musicItems.push(itemHtml);
                        else if (item.type === 'decoration') decoItems.push(itemHtml);
                    });
                });
            }
            
            // ê¸°íƒ€ ì•„ì´í…œ êµ¬ë§¤ (ë§Œë³‘í†µì¹˜ ì•½ì´ˆ, ìˆ˜ì„ í™” ê½ƒì, ì•„ì¹´ì‹œì•„ ê¿€)
            if ((currentShopCategory === 'all' || currentShopCategory === 'food') &&
                (buyFilter === 'all' || buyFilter === 'etc')) {
                // ë§Œë³‘í†µì¹˜ ì•½ì´ˆ
                const medicineCount = inventory.food ? inventory.food.filter(f => f === 'medicine').length : 0;
                etcItems.push(`
                    <div style="display: flex; flex-direction: column; padding: 12px; background: var(--bg); border: 1px solid var(--border); border-radius: 8px;">
                        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px;">
                            <span style="font-size: 1.5rem;">${MEDICINE.icon}</span>
                            <div style="flex: 1; min-width: 0;">
                                <div style="font-weight: 700; font-size: 0.9rem;">${MEDICINE.name} <span style="font-size: 0.7rem; color: var(--text-muted);">ê¸°íƒ€ (${medicineCount})</span></div>
                                <div style="font-size: 0.7rem; color: var(--text-muted);">${MEDICINE.description}</div>
                                <div style="font-size: 0.75rem; color: var(--text-muted);">ê°€ê²©: ${MEDICINE.price}ğŸ’°</div>
                            </div>
                        </div>
                        <button onclick="buyItem('food', 'medicine', ${MEDICINE.price})" style="padding: 8px 16px; width: 100%;">êµ¬ë§¤</button>
                    </div>
                `);
                
                // ìˆ˜ì„ í™” ê½ƒì
                const daffodil = SYNTH_ITEMS['reconciliation_flower'];
                const daffodilCount = inventory.food ? inventory.food.filter(f => f === 'reconciliation_flower').length : 0;
                etcItems.push(`
                    <div style="display: flex; flex-direction: column; padding: 12px; background: var(--bg); border: 1px solid var(--border); border-radius: 8px;">
                        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px;">
                            <span style="font-size: 1.5rem;">${daffodil.icon}</span>
                            <div style="flex: 1; min-width: 0;">
                                <div style="font-weight: 700; font-size: 0.9rem;">${daffodil.name} <span style="font-size: 0.7rem; color: var(--text-muted);">ê¸°íƒ€ (${daffodilCount})</span></div>
                                <div style="font-size: 0.7rem; color: var(--text-muted);">${daffodil.desc}</div>
                                <div style="font-size: 0.75rem; color: var(--text-muted);">ê°€ê²©: 25ğŸ’°</div>
                            </div>
                        </div>
                        <button onclick="buyItem('food', 'reconciliation_flower', 25)" style="padding: 8px 16px; width: 100%;">êµ¬ë§¤</button>
                    </div>
                `);
                
                // ì•„ì¹´ì‹œì•„ ê¿€
                const honey = SYNTH_ITEMS['acacia_honey'];
                const honeyCount = inventory.food ? inventory.food.filter(f => f === 'acacia_honey').length : 0;
                etcItems.push(`
                    <div style="display: flex; flex-direction: column; padding: 12px; background: var(--bg); border: 1px solid var(--border); border-radius: 8px;">
                        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px;">
                            <span style="font-size: 1.5rem;">${honey.icon}</span>
                            <div style="flex: 1; min-width: 0;">
                                <div style="font-weight: 700; font-size: 0.9rem;">${honey.name} <span style="font-size: 0.7rem; color: var(--text-muted);">ê¸°íƒ€ (${honeyCount})</span></div>
                                <div style="font-size: 0.7rem; color: var(--text-muted);">${honey.desc}</div>
                                <div style="font-size: 0.75rem; color: var(--text-muted);">ê°€ê²©: 25ğŸ’°</div>
                            </div>
                        </div>
                        <button onclick="buyItem('food', 'acacia_honey', 25)" style="padding: 8px 16px; width: 100%;">êµ¬ë§¤</button>
                    </div>
                `);
                
                // ë ˆì‹œí”¼ë¶ (ì—°êµ¬ì‹¤ íŠœí† ë¦¬ì–¼ ì™„ë£Œ ë˜ëŠ” ê±´ë„ˆë›°ê¸° í›„ í‘œì‹œ)
                const labTutorialSeen = localStorage.getItem('spiritGarden_labTutorialSeen');
                if (labTutorialSeen) {
                    // ë ˆì‹œí”¼ë¶ (ë¨¹ì´)
                    const foodBookPurchased = purchasedRecipeBooks.includes('food');
                    etcItems.push(`
                        <div style="display: flex; flex-direction: column; padding: 12px; background: var(--bg); border: 2px solid ${foodBookPurchased ? '#27ae60' : '#9b59b6'}; border-radius: 8px;">
                            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px;">
                                <span style="font-size: 1.5rem;">${RECIPE_BOOKS.food.icon}</span>
                                <div style="flex: 1; min-width: 0;">
                                    <div style="font-weight: 700; font-size: 0.9rem;">${RECIPE_BOOKS.food.name} <span style="font-size: 0.7rem; color: #9b59b6;">ë ˆì‹œí”¼</span></div>
                                    <div style="font-size: 0.7rem; color: var(--text-muted);">${RECIPE_BOOKS.food.desc} (${RECIPE_BOOKS.food.recipes.length}ê°œ)</div>
                                    <div style="font-size: 0.75rem; color: var(--text-muted);">ê°€ê²©: ${RECIPE_BOOKS.food.price}ğŸ’°</div>
                                </div>
                            </div>
                            ${foodBookPurchased 
                                ? '<span style="padding: 8px 16px; color: #27ae60; font-weight: 700; text-align: center; display: block;">âœ“ êµ¬ë§¤ì™„ë£Œ</span>'
                                : `<button onclick="buyRecipeBook('food')" style="padding: 8px 16px; width: 100%; background: #9b59b6; color: white;">êµ¬ë§¤</button>`}
                        </div>
                    `);
                    
                    // ë ˆì‹œí”¼ë¶ (ë¯¸ë‹ˆì–´ì²˜)
                    const decoBookPurchased = purchasedRecipeBooks.includes('decoration');
                    etcItems.push(`
                        <div style="display: flex; flex-direction: column; padding: 12px; background: var(--bg); border: 2px solid ${decoBookPurchased ? '#27ae60' : '#9b59b6'}; border-radius: 8px;">
                            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px;">
                                <span style="font-size: 1.5rem;">${RECIPE_BOOKS.decoration.icon}</span>
                                <div style="flex: 1; min-width: 0;">
                                    <div style="font-weight: 700; font-size: 0.9rem;">${RECIPE_BOOKS.decoration.name} <span style="font-size: 0.7rem; color: #9b59b6;">ë ˆì‹œí”¼</span></div>
                                    <div style="font-size: 0.7rem; color: var(--text-muted);">${RECIPE_BOOKS.decoration.desc} (${RECIPE_BOOKS.decoration.recipes.length}ê°œ)</div>
                                    <div style="font-size: 0.75rem; color: var(--text-muted);">ê°€ê²©: ${RECIPE_BOOKS.decoration.price}ğŸ’°</div>
                                </div>
                            </div>
                            ${decoBookPurchased 
                                ? '<span style="padding: 8px 16px; color: #27ae60; font-weight: 700; text-align: center; display: block;">âœ“ êµ¬ë§¤ì™„ë£Œ</span>'
                                : `<button onclick="buyRecipeBook('decoration')" style="padding: 8px 16px; width: 100%; background: #9b59b6; color: white;">êµ¬ë§¤</button>`}
                        </div>
                    `);
                    
                    // ë ˆì‹œí”¼ë¶ (ë ˆì½”ë“œ)
                    const musicBookPurchased = purchasedRecipeBooks.includes('music');
                    etcItems.push(`
                        <div style="display: flex; flex-direction: column; padding: 12px; background: var(--bg); border: 2px solid ${musicBookPurchased ? '#27ae60' : '#9b59b6'}; border-radius: 8px;">
                            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px;">
                                <span style="font-size: 1.5rem;">${RECIPE_BOOKS.music.icon}</span>
                                <div style="flex: 1; min-width: 0;">
                                    <div style="font-weight: 700; font-size: 0.9rem;">${RECIPE_BOOKS.music.name} <span style="font-size: 0.7rem; color: #9b59b6;">ë ˆì‹œí”¼</span></div>
                                    <div style="font-size: 0.7rem; color: var(--text-muted);">${RECIPE_BOOKS.music.desc} (${RECIPE_BOOKS.music.recipes.length}ê°œ)</div>
                                    <div style="font-size: 0.75rem; color: var(--text-muted);">ê°€ê²©: ${RECIPE_BOOKS.music.price}ğŸ’°</div>
                                </div>
                            </div>
                            ${musicBookPurchased 
                                ? '<span style="padding: 8px 16px; color: #27ae60; font-weight: 700; text-align: center; display: block;">âœ“ êµ¬ë§¤ì™„ë£Œ</span>'
                                : `<button onclick="buyRecipeBook('music')" style="padding: 8px 16px; width: 100%; background: #9b59b6; color: white;">êµ¬ë§¤</button>`}
                        </div>
                    `);
                }
            }
            
            // ë¨¹ì´ êµ¬ë§¤ (ì¹´í…Œê³ ë¦¬ê°€ all ë˜ëŠ” food, ì†ì„± í•„í„°ë§Œ ì ìš©)
            if ((currentShopCategory === 'all' || currentShopCategory === 'food') &&
                (buyFilter === 'all' || ['fire', 'water', 'wind', 'earth', 'light', 'dark'].includes(buyFilter))) {
                // ì¼ë°˜ ë¨¹ì´
                ['fire', 'water', 'wind', 'earth'].forEach(type => {
                    if (buyFilter !== 'all' && type !== buyFilter) return;
                    
                    const ownedCount = inventory.food ? inventory.food.filter(f => f === type).length : 0;
                    foodItems.push(`
                        <div style="display: flex; flex-direction: column; padding: 12px; background: var(--bg); border: 1px solid var(--border); border-radius: 8px;">
                            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px;">
                                <span style="font-size: 1.5rem;">${ENV_ICONS[type]}</span>
                                <div style="flex: 1; min-width: 0;">
                                    <div style="font-weight: 700; font-size: 0.9rem;">${FOOD_NAMES[type]} <span style="font-size: 0.7rem; color: var(--text-muted);">(${ownedCount})</span></div>
                                    <div style="font-size: 0.75rem; color: var(--text-muted);">${ENV_ICONS[type]} ì†ì„± +1, ì„±ì¥ +2</div>
                                    <div style="font-size: 0.75rem; color: var(--text-muted);">ê°€ê²©: ${SHOP_PRICES.buy.food_common}ğŸ’°</div>
                                </div>
                            </div>
                            <button onclick="buyItem('food', '${type}', ${SHOP_PRICES.buy.food_common})" style="padding: 8px 16px; width: 100%;">êµ¬ë§¤</button>
                        </div>
                    `);
                });

                // í¬ê·€ ë¨¹ì´
                ['light', 'dark'].forEach(type => {
                    if (buyFilter !== 'all' && type !== buyFilter) return;
                    
                    const ownedCount = inventory.food ? inventory.food.filter(f => f === type).length : 0;
                    foodItems.push(`
                        <div style="display: flex; flex-direction: column; padding: 12px; background: var(--bg); border: 1px solid var(--border); border-radius: 8px;">
                            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px;">
                                <span style="font-size: 1.5rem;">${ENV_ICONS[type]}</span>
                                <div style="flex: 1; min-width: 0;">
                                    <div style="font-weight: 700; font-size: 0.9rem;">${FOOD_NAMES[type]} <span style="font-size: 0.7rem; color: #9b59b6;">í¬ê·€</span> <span style="font-size: 0.7rem; color: var(--text-muted);">(${ownedCount})</span></div>
                                    <div style="font-size: 0.75rem; color: var(--text-muted);">${ENV_ICONS[type]} ì†ì„± +3, ì„±ì¥ +2</div>
                                    <div style="font-size: 0.75rem; color: var(--text-muted);">ê°€ê²©: ${SHOP_PRICES.buy.food_rare}ğŸ’°</div>
                                </div>
                            </div>
                            <button onclick="buyItem('food', '${type}', ${SHOP_PRICES.buy.food_rare})" style="padding: 8px 16px; width: 100%;">êµ¬ë§¤</button>
                        </div>
                    `);
                });
            }

            // ìŒì•… êµ¬ë§¤ (ê¸°ë³¸ ì•…ê¸° ë ˆì½”ë“œë§Œ íŒë§¤)
            if ((currentShopCategory === 'all' || currentShopCategory === 'music') &&
                (buyFilter === 'all' || ['intelligence', 'strength', 'charm'].includes(buyFilter))) {
                BASIC_MUSIC.forEach(type => {
                    const musicData = MUSIC_TYPES[type];
                    if (!musicData) return;
                    
                    // ìŠ¤íƒ¯ë³„ í•„í„°ë§
                    if (buyFilter === 'intelligence' && !musicData.stats?.intelligence) return;
                    if (buyFilter === 'strength' && !musicData.stats?.strength) return;
                    if (buyFilter === 'charm' && !musicData.stats?.charm) return;
                    
                    const ownedCount = inventory.music ? inventory.music.filter(m => m === type).length : 0;
                    musicItems.push(`
                        <div style="display: flex; flex-direction: column; padding: 12px; background: var(--bg); border: 1px solid var(--border); border-radius: 8px;">
                            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px;">
                                <span style="font-size: 1.5rem;">${musicData.icon}</span>
                                <div style="flex: 1; min-width: 0;">
                                    <div style="font-weight: 700; font-size: 0.9rem;">${musicData.name} <span style="font-size: 0.7rem; color: var(--text-muted);">(${ownedCount})</span></div>
                                    <div style="font-size: 0.75rem; color: var(--text-muted);">${musicData.effect}</div>
                                    <div style="font-size: 0.75rem; color: var(--text-muted);">ê°€ê²©: ${SHOP_PRICES.buy.music}ğŸ’°</div>
                                </div>
                            </div>
                            <button onclick="buyItem('music', '${type}', ${SHOP_PRICES.buy.music})" style="padding: 8px 16px; width: 100%;">êµ¬ë§¤</button>
                        </div>
                    `);
                });
            }
            
            // ë¯¸ë‹ˆì–´ì²˜ êµ¬ë§¤ (ì¹´í…Œê³ ë¦¬ê°€ all ë˜ëŠ” decoration, ì†ì„± í•„í„° ì ìš©, legendary ì œì™¸ - ë¯¸ë‹ˆê²Œì„ ì „ìš©)
            if ((currentShopCategory === 'all' || currentShopCategory === 'decoration') &&
                (buyFilter === 'all' || ['fire', 'water', 'wind', 'earth', 'light', 'dark'].includes(buyFilter))) {
                
                // í•©ì„± ì „ìš© ì•„ì´í…œ (ìƒì ì—ì„œ ì œì™¸)
                const synthOnlyItems = ['flame_lamp', 'aqua_fountain', 'wind_chime', 'earth_statue', 'light_orb', 'shadow_crystal'];
                
                // ì†ì„± í‘œì‹œìš© í—¬í¼ í•¨ìˆ˜
                function getDecoAttrDisplay(data) {
                    if (data.attr === 'dual' && data.dualAttr) {
                        return data.dualAttr.map(a => ENV_ICONS[a]).join('') + ` +${data.power}`;
                    } else if (data.attr === 'all') {
                        return 'ğŸŒˆ ì „ì²´ ì†ì„± +' + data.power;
                    } else {
                        return `${ENV_ICONS[data.attr]} +${data.power}`;
                    }
                }
                
                Object.keys(DECORATION_TYPES).forEach(key => {
                    const decoData = DECORATION_TYPES[key];
                    
                    // legendaryëŠ” ìƒì ì—ì„œ íŒë§¤ ì•ˆí•¨ (ë¯¸ë‹ˆê²Œì„ ì „ìš©)
                    if (decoData.quality === 'legendary') return;
                    
                    // í•©ì„± ì „ìš© ì•„ì´í…œ ì œì™¸
                    if (synthOnlyItems.includes(key)) return;
                    
                    // ì†ì„± í•„í„° (ë³µí•© ì†ì„±ì€ all í•„í„°ì—ì„œë§Œ í‘œì‹œí•˜ê±°ë‚˜, í•´ë‹¹ ì†ì„± í¬í•¨ ì‹œ í‘œì‹œ)
                    if (buyFilter !== 'all') {
                        if (decoData.attr === 'dual') {
                            if (!decoData.dualAttr || !decoData.dualAttr.includes(buyFilter)) return;
                        } else if (decoData.attr === 'all') {
                            // all ì†ì„± ë¯¸ë‹ˆì–´ì²˜ì€ ëª¨ë“  ì†ì„± í•„í„°ì—ì„œ í‘œì‹œ
                        } else if (decoData.attr !== buyFilter) {
                            return;
                        }
                    }
                    
                    // ì¸ë²¤í† ë¦¬ + í…Œë¼ë¦¬ì›€ì— ì„¤ì¹˜ëœ ë¯¸ë‹ˆì–´ì²˜
                    const inInventory = inventory.decorations ? inventory.decorations.filter(d => d === key).length : 0;
                    const installed = installedDecorations ? installedDecorations.filter(d => d.type === key).length : 0;
                    const ownedCount = inInventory + installed;
                    const qualityLabel = decoData.quality === 'rare' ? '<span style="font-size: 0.75rem; color: #1565c0;">í¬ê·€</span>' :
                                        decoData.quality === 'epic' ? '<span style="font-size: 0.75rem; color: #e65100;">ìµœìƒê¸‰</span>' : '';
                    
                    // ë“±ê¸‰ë³„ í…Œë‘ë¦¬ ìƒ‰
                    const qualityBorderColor = decoData.quality === 'legendary' ? '#ffd700' : decoData.quality === 'epic' ? '#9b59b6' : decoData.quality === 'rare' ? '#3498db' : 'var(--border)';
                    
                    decoItems.push(`
                        <div style="display: flex; flex-direction: column; padding: 12px; background: var(--bg); border: 2px solid ${qualityBorderColor}; border-radius: 8px;">
                            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px;">
                                <span style="font-size: 1.5rem;">${decoData.icon}</span>
                                <div style="flex: 1; min-width: 0;">
                                    <div style="font-weight: 700; font-size: 0.9rem;">${decoData.name} ${qualityLabel} <span style="font-size: 0.7rem; color: var(--text-muted);">(${ownedCount})</span></div>
                                    <div style="font-size: 0.75rem; color: var(--text-muted);">${decoData.price}ğŸ’° | ${getDecoAttrDisplay(decoData)}</div>
                                </div>
                            </div>
                            <button onclick="buyItem('decoration', '${key}', ${decoData.price})" style="padding: 8px 16px; width: 100%;">êµ¬ë§¤</button>
                        </div>
                    `);
                });
            }

            const totalItems = etcItems.length + foodItems.length + musicItems.length + decoItems.length;
            
            if (totalItems === 0) {
                container.innerHTML = '<p style="color: #888; text-align: center; padding: 20px;">êµ¬ë§¤ ê°€ëŠ¥í•œ ë¬¼í’ˆì´ ì—†ìŠµë‹ˆë‹¤</p>';
            } else {
                // ì¹´í…Œê³ ë¦¬ë³„ ì ‘ê¸° ê°€ëŠ¥í•œ ì„¹ì…˜ ìƒì„±
                let sectionsHtml = '';
                
                // ê¸°íƒ€ ì„¹ì…˜
                if (etcItems.length > 0) {
                    const isFolded = shopBuyFoldState.etc;
                    sectionsHtml += `
                        <div class="shop-category-section" style="margin-bottom: 15px;">
                            <div onclick="toggleShopBuyFold('etc')" style="display: flex; justify-content: space-between; align-items: center; padding: 10px 12px; background: #888; color: white; border-radius: 6px; cursor: pointer; margin-bottom: ${isFolded ? '0' : '10px'};">
                                <span style="font-weight: 600;">ğŸ“¦ ê¸°íƒ€ (${etcItems.length})</span>
                                <span>${isFolded ? 'â–¶' : 'â–¼'}</span>
                            </div>
                            <div class="shop-items-grid" style="display: ${isFolded ? 'none' : 'grid'};">
                                ${etcItems.join('')}
                            </div>
                        </div>
                    `;
                }
                
                // ë¨¹ì´ ì„¹ì…˜
                if (foodItems.length > 0) {
                    const isFolded = shopBuyFoldState.food;
                    sectionsHtml += `
                        <div class="shop-category-section" style="margin-bottom: 15px;">
                            <div onclick="toggleShopBuyFold('food')" style="display: flex; justify-content: space-between; align-items: center; padding: 10px 12px; background: var(--fire); color: white; border-radius: 6px; cursor: pointer; margin-bottom: ${isFolded ? '0' : '10px'};">
                                <span style="font-weight: 600;">ğŸ ë¨¹ì´ (${foodItems.length})</span>
                                <span>${isFolded ? 'â–¶' : 'â–¼'}</span>
                            </div>
                            <div class="shop-items-grid" style="display: ${isFolded ? 'none' : 'grid'};">
                                ${foodItems.join('')}
                            </div>
                        </div>
                    `;
                }
                
                // ë ˆì½”ë“œ ì„¹ì…˜
                if (musicItems.length > 0) {
                    const isFolded = shopBuyFoldState.music;
                    sectionsHtml += `
                        <div class="shop-category-section" style="margin-bottom: 15px;">
                            <div onclick="toggleShopBuyFold('music')" style="display: flex; justify-content: space-between; align-items: center; padding: 10px 12px; background: #9b59b6; color: white; border-radius: 6px; cursor: pointer; margin-bottom: ${isFolded ? '0' : '10px'};">
                                <span style="font-weight: 600;">ğŸµ ë ˆì½”ë“œ (${musicItems.length})</span>
                                <span>${isFolded ? 'â–¶' : 'â–¼'}</span>
                            </div>
                            <div class="shop-items-grid" style="display: ${isFolded ? 'none' : 'grid'};">
                                ${musicItems.join('')}
                            </div>
                        </div>
                    `;
                }
                
                // ë¯¸ë‹ˆì–´ì²˜ ì„¹ì…˜
                if (decoItems.length > 0) {
                    const isFolded = shopBuyFoldState.decoration;
                    sectionsHtml += `
                        <div class="shop-category-section" style="margin-bottom: 15px;">
                            <div onclick="toggleShopBuyFold('decoration')" style="display: flex; justify-content: space-between; align-items: center; padding: 10px 12px; background: var(--earth); color: white; border-radius: 6px; cursor: pointer; margin-bottom: ${isFolded ? '0' : '10px'};">
                                <span style="font-weight: 600;">ğŸŒ³ ë¯¸ë‹ˆì–´ì²˜ (${decoItems.length})</span>
                                <span>${isFolded ? 'â–¶' : 'â–¼'}</span>
                            </div>
                            <div class="shop-items-grid" style="display: ${isFolded ? 'none' : 'grid'};">
                                ${decoItems.join('')}
                            </div>
                        </div>
                    `;
                }
                
                container.innerHTML = sectionsHtml;
            }
        }
        
        // ìƒì  êµ¬ë§¤ ì¹´í…Œê³ ë¦¬ ì ‘ê¸°/í¼ì¹˜ê¸° í† ê¸€
        function toggleShopBuyFold(category) {
            shopBuyFoldState[category] = !shopBuyFoldState[category];
            renderBuyList();
        }

        // ì ê¸ˆ ëª¨ë“œ í† ê¸€
        function toggleLockMode() {
            isLockMode = !isLockMode;
            const btn = document.getElementById('lockModeBtn');
            if (btn) {
                if (isLockMode) {
                    btn.textContent = 'ğŸ”’';
                    btn.style.background = '#e74c3c';
                    btn.style.color = 'white';
                    btn.style.borderColor = '#e74c3c';
                    btn.title = 'íŒë§¤ ëª¨ë“œë¡œ ì „í™˜';
                    showNotification('ğŸ”’ ì ê¸ˆ ëª¨ë“œ: ì•„ì´í…œì„ í´ë¦­í•˜ë©´ ì ê¸ˆë©ë‹ˆë‹¤');
                } else {
                    btn.textContent = 'ğŸ”“';
                    btn.style.background = 'var(--card)';
                    btn.style.color = 'var(--text)';
                    btn.style.borderColor = 'var(--border)';
                    btn.title = 'ì ê¸ˆ ëª¨ë“œë¡œ ì „í™˜';
                    showNotification('ğŸ”“ íŒë§¤ ëª¨ë“œ: ì•„ì´í…œì„ í´ë¦­í•˜ë©´ íŒë§¤ë©ë‹ˆë‹¤');
                }
            }
            renderSellList();
        }

        // ì•„ì´í…œ íŒë§¤ ì ê¸ˆ í† ê¸€
        function toggleItemLock(category, type) {
            let lockCategory;
            if (category === 'food') lockCategory = 'food';
            else if (category === 'decoration') lockCategory = 'decorations';
            else if (category === 'music') lockCategory = 'music';
            else lockCategory = 'decorations';
            
            const index = lockedItems[lockCategory].indexOf(type);
            
            if (index === -1) {
                // ì ê¸ˆ ì¶”ê°€
                lockedItems[lockCategory].push(type);
                showNotification(`ğŸ”’ ${getItemDisplayName(category, type)} íŒë§¤ ì ê¸ˆ`);
            } else {
                // ì ê¸ˆ í•´ì œ
                lockedItems[lockCategory].splice(index, 1);
                showNotification(`ğŸ”“ ${getItemDisplayName(category, type)} ì ê¸ˆ í•´ì œ`);
            }
            
            saveGame();
            renderSellList();
        }
        
        // ì•„ì´í…œ í‘œì‹œ ì´ë¦„ ê°€ì ¸ì˜¤ê¸°
        function getItemDisplayName(category, type) {
            if (category === 'food') {
                if (FOOD_NAMES[type]) return FOOD_NAMES[type];
                if (SYNTH_ITEMS[type]) return SYNTH_ITEMS[type].name;
                if (EVENT_ITEMS[type]) return EVENT_ITEMS[type].name;
                return type;
            } else if (category === 'decoration') {
                const deco = DECORATION_TYPES[type];
                if (deco) return deco.name;
                if (SYNTH_ITEMS[type]) return SYNTH_ITEMS[type].name;
                return type;
            } else if (category === 'music') {
                const music = MUSIC_TYPES[type];
                if (music) return music.name;
                const eventMusic = EVENT_ITEMS[type];
                if (eventMusic) return eventMusic.name;
                return type;
            }
            return type;
        }
        
        // ì¼ê´„ íŒë§¤ í™•ì¸ ëª¨ë‹¬ í‘œì‹œ
        function showBulkSellConfirm(message, onConfirm) {
            const modal = document.createElement('div');
            modal.id = 'bulkSellConfirmModal';
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.7);
                z-index: 100000;
                display: flex;
                justify-content: center;
                align-items: center;
            `;
            
            modal.innerHTML = `
                <div style="background: var(--card); border-radius: 12px; padding: 24px; max-width: 400px; width: 90%; text-align: center;">
                    <div style="font-size: 2rem; margin-bottom: 15px;">ğŸ“¦</div>
                    <div style="font-size: 1rem; margin-bottom: 20px; color: var(--text);">${message}</div>
                    <div style="display: flex; gap: 10px; justify-content: center;">
                        <button id="bulkSellCancelBtn" style="padding: 10px 24px; background: var(--bg); border: 1px solid var(--border); border-radius: 8px; cursor: pointer; font-size: 1rem;">ì·¨ì†Œ</button>
                        <button id="bulkSellConfirmBtn" style="padding: 10px 24px; background: var(--fire); color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 1rem; font-weight: 600;">íŒë§¤</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            document.getElementById('bulkSellCancelBtn').onclick = () => {
                modal.remove();
            };
            
            document.getElementById('bulkSellConfirmBtn').onclick = () => {
                modal.remove();
                if (onConfirm) onConfirm();
            };
            
            modal.onclick = (e) => {
                if (e.target === modal) modal.remove();
            };
        }
        
        // ì¼ê´„ íŒë§¤ ì‹¤í–‰ (ë“œë¡­ë‹¤ìš´ì—ì„œ ì„ íƒ í›„)
        function executeBulkSell() {
            const select = document.getElementById('bulkSellSelect');
            
            if (!select || !select.value) {
                showNotification('íŒë§¤í•  í•­ëª©ì„ ì„ íƒí•´ì£¼ì„¸ìš”');
                return;
            }
            
            const value = select.value;
            
            if (value === 'food_common') {
                bulkSellFood('common');
            } else if (value === 'food_rare') {
                bulkSellFood('rare');
            } else if (value === 'deco_common') {
                bulkSellByQuality('common');
            } else if (value === 'deco_rare') {
                bulkSellByQuality('rare');
            } else if (value === 'deco_epic') {
                bulkSellByQuality('epic');
            }
            
            // ë“œë¡­ë‹¤ìš´ ì´ˆê¸°í™”
            if (select) select.value = '';
        }
        
        // ë¯¸ë‹ˆì–´ì²˜ í’ˆì§ˆë³„ ì¼ê´„ íŒë§¤
        function bulkSellByQuality(maxQuality) {
            const qualityOrder = ['common', 'rare', 'epic', 'legendary'];
            const maxIndex = qualityOrder.indexOf(maxQuality);
            
            if (maxIndex === -1) return;
            
            // íŒë§¤í•  ë¯¸ë‹ˆì–´ì²˜ ì°¾ê¸° (ì ê¸ˆ ì œì™¸)
            const toSell = [];
            inventory.decorations.forEach((type, idx) => {
                const deco = DECORATION_TYPES[type];
                if (!deco) return;
                
                // ì ê¸ˆëœ ì•„ì´í…œì€ ì œì™¸
                if (lockedItems.decorations.includes(type)) return;
                
                const qualityIdx = qualityOrder.indexOf(deco.quality);
                if (qualityIdx !== -1 && qualityIdx <= maxIndex) {
                    toSell.push({ type, idx, price: Math.floor(deco.price * 0.5), name: deco.name });
                }
            });
            
            if (toSell.length === 0) {
                showNotification('íŒë§¤í•  ë¯¸ë‹ˆì–´ì²˜ê°€ ì—†ìŠµë‹ˆë‹¤ (ì ê¸ˆ ì œì™¸)');
                return;
            }
            
            const totalPrice = toSell.reduce((sum, item) => sum + item.price, 0);
            const qualityText = maxQuality === 'common' ? 'ì¼ë°˜' : maxQuality === 'rare' ? 'í¬ê·€ ì´í•˜' : 'ìµœìƒê¸‰ ì´í•˜';
            
            showBulkSellConfirm(`${qualityText} ë¯¸ë‹ˆì–´ì²˜ ${toSell.length}ê°œë¥¼ ${totalPrice}ğŸ’°ì— íŒë§¤í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`, () => {
                // ì—­ìˆœìœ¼ë¡œ ì‚­ì œ (ì¸ë±ìŠ¤ ë³€ê²½ ë°©ì§€)
                const typesToRemove = toSell.map(item => item.type);
                typesToRemove.forEach(type => {
                    const idx = inventory.decorations.indexOf(type);
                    if (idx !== -1) inventory.decorations.splice(idx, 1);
                });
                
                coins += totalPrice;
                showNotification(`ğŸ“¦ ${toSell.length}ê°œ ë¯¸ë‹ˆì–´ì²˜ íŒë§¤ ì™„ë£Œ! +${totalPrice}ğŸ’°`);
                setShopkeeperDialogue('...ëŒ€ëŸ‰ ê±°ë˜ ê°ì‚¬í•©ë‹ˆë‹¤.');
                
                saveGame();
                renderSellList();
                renderBuyList();
                updateCoinDisplay();
                renderInventory();
            });
        }
        
        // ë¨¹ì´ ì¼ê´„ íŒë§¤
        function bulkSellFood(type) {
            let targetTypes = [];
            let price = 0;
            let label = '';
            
            if (type === 'common') {
                targetTypes = ['fire', 'water', 'wind', 'earth'];
                price = SHOP_PRICES.sell.food_common;
                label = 'ì¼ë°˜';
            } else if (type === 'rare') {
                targetTypes = ['light', 'dark'];
                price = SHOP_PRICES.sell.food_rare;
                label = 'í¬ê·€';
            }
            
            const toSell = [];
            inventory.food.forEach((foodType, idx) => {
                if (targetTypes.includes(foodType) && !lockedItems.food.includes(foodType)) {
                    toSell.push({ type: foodType, price: price });
                }
            });
            
            if (toSell.length === 0) {
                showNotification(`íŒë§¤í•  ${label} ë¨¹ì´ê°€ ì—†ìŠµë‹ˆë‹¤ (ì ê¸ˆ ì œì™¸)`);
                return;
            }
            
            const totalPrice = toSell.reduce((sum, item) => sum + item.price, 0);
            
            // ì»¤ìŠ¤í…€ í™•ì¸ ëª¨ë‹¬ í‘œì‹œ
            showBulkSellConfirm(`${label} ë¨¹ì´ ${toSell.length}ê°œë¥¼ ${totalPrice}ğŸ’°ì— íŒë§¤í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`, () => {
                toSell.forEach(item => {
                    const idx = inventory.food.indexOf(item.type);
                    if (idx !== -1) inventory.food.splice(idx, 1);
                });
                
                coins += totalPrice;
                showNotification(`ğŸ“¦ ${toSell.length}ê°œ ë¨¹ì´ íŒë§¤ ì™„ë£Œ! +${totalPrice}ğŸ’°`);
                setShopkeeperDialogue('...ëŒ€ëŸ‰ ê±°ë˜ ê°ì‚¬í•©ë‹ˆë‹¤.');
                
                saveGame();
                renderSellList();
                renderBuyList();
                updateCoinDisplay();
                renderInventory();
            });
        }
        
        function sellItem(category, type) {
            // ì ê¸ˆ ì²´í¬
            if (category === 'food' && lockedItems.food.includes(type)) {
                showNotification('ğŸ”’ ì´ ì•„ì´í…œì€ íŒë§¤ ì ê¸ˆ ìƒíƒœì…ë‹ˆë‹¤');
                return;
            }
            if (category === 'decoration' && lockedItems.decorations.includes(type)) {
                showNotification('ğŸ”’ ì´ ì•„ì´í…œì€ íŒë§¤ ì ê¸ˆ ìƒíƒœì…ë‹ˆë‹¤');
                return;
            }
            if (category === 'music' && lockedItems.music.includes(type)) {
                showNotification('ğŸ”’ ì´ ì•„ì´í…œì€ íŒë§¤ ì ê¸ˆ ìƒíƒœì…ë‹ˆë‹¤');
                return;
            }
            
            // ì´ë²¤íŠ¸ ì•„ì´í…œ ì²´í¬
            const eventItem = EVENT_ITEMS[type];
            if (eventItem) {
                let inventoryArray;
                if (eventItem.type === 'food') inventoryArray = inventory.food;
                else if (eventItem.type === 'music') inventoryArray = inventory.music;
                else if (eventItem.type === 'decoration') inventoryArray = inventory.decorations;
                
                const index = inventoryArray ? inventoryArray.indexOf(type) : -1;
                if (index === -1) return;
                
                inventoryArray.splice(index, 1);
                const sellPrice = eventItem.type === 'food' ? 15 : eventItem.type === 'music' ? 12 : 25;
                coins += sellPrice;
                showShopNotification(eventItem.name, 'sell', sellPrice);
                setShopkeeperDialogue(`${sellPrice}ì½”ì¸ì…ë‹ˆë‹¤.`);
                
                saveGame();
                renderSellList();
                renderBuyList();
                updateCoinDisplay();
                renderInventory();
                return;
            }
            
            // í•©ì„± ì•„ì´í…œ ì²´í¬
            const synthItem = SYNTH_ITEMS[type];
            if (synthItem) {
                let inventoryArray;
                if (synthItem.type === 'food') inventoryArray = inventory.food;
                else if (synthItem.type === 'decoration') inventoryArray = inventory.decorations;
                
                const index = inventoryArray ? inventoryArray.indexOf(type) : -1;
                if (index === -1) return;
                
                inventoryArray.splice(index, 1);
                const sellPrice = synthItem.type === 'food' ? 8 : 20;
                coins += sellPrice;
                showShopNotification(synthItem.name, 'sell', sellPrice);
                setShopkeeperDialogue(`${sellPrice}ì½”ì¸ì…ë‹ˆë‹¤.`);
                
                saveGame();
                renderSellList();
                renderBuyList();
                updateCoinDisplay();
                renderInventory();
                return;
            }
            
            let sellPrice = 0;
            let itemName = '';
            if (category === 'food') {
                const index = inventory.food.indexOf(type);
                if (index === -1) return;
                inventory.food.splice(index, 1);
                
                // medicineì€ ë³„ë„ ì²˜ë¦¬
                if (type === 'medicine') {
                    sellPrice = 10; // íŒë§¤ê°€ 10
                    itemName = MEDICINE.name;
                } else {
                    const isRare = type === 'light' || type === 'dark';
                    sellPrice = isRare ? SHOP_PRICES.sell.food_rare : SHOP_PRICES.sell.food_common;
                    itemName = FOOD_NAMES[type];
                }
                coins += sellPrice;
                showShopNotification(itemName, 'sell', sellPrice);
            } else if (category === 'decoration') {
                const index = inventory.decorations.indexOf(type);
                if (index === -1) return;
                inventory.decorations.splice(index, 1);
                
                const decoData = DECORATION_TYPES[type];
                sellPrice = Math.floor(decoData.price * 0.5);
                itemName = decoData.name;
                coins += sellPrice;
                showShopNotification(itemName, 'sell', sellPrice);
            } else if (category === 'music') {
                const index = inventory.music.indexOf(type);
                if (index === -1) return;
                inventory.music.splice(index, 1);
                sellPrice = SHOP_PRICES.sell.music;
                itemName = MUSIC_TYPES[type].name;
                coins += sellPrice;
                showShopNotification(itemName, 'sell', sellPrice);
            }

            setShopkeeperDialogue(`${sellPrice}ì½”ì¸ì…ë‹ˆë‹¤.`);
            saveGame();
            renderSellList();
            renderBuyList();
            updateCoinDisplay();
            renderInventory();
        }

        // ë ˆì‹œí”¼ë¶ êµ¬ë§¤
        async function buyRecipeBook(bookType) {
            const book = RECIPE_BOOKS[bookType];
            if (!book) return;
            
            if (purchasedRecipeBooks.includes(bookType)) {
                showNotification('ì´ë¯¸ êµ¬ë§¤í•œ ë ˆì‹œí”¼ë¶ì…ë‹ˆë‹¤!');
                return;
            }
            
            if (coins < book.price) {
                showNotification('ì½”ì¸ì´ ë¶€ì¡±í•©ë‹ˆë‹¤!');
                setShopkeeperDialogue('...ëˆì´ ë¶€ì¡±í•´ ë³´ì´ë„¤ìš”.');
                return;
            }
            
            const confirmed = await showConfirm(
                'ë ˆì‹œí”¼ë¶ êµ¬ë§¤',
                `${book.icon} ${book.name}ì„(ë¥¼) ${book.price}ğŸ’°ì— êµ¬ë§¤í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\n${book.recipes.length}ê°œì˜ ë ˆì‹œí”¼ê°€ ì—°êµ¬ì‹¤ì— ì¶”ê°€ë©ë‹ˆë‹¤.\n\nâš ï¸ ë ˆì‹œí”¼ë¶ìœ¼ë¡œ í•´ê¸ˆëœ ë ˆì‹œí”¼ëŠ” "ì§ì ‘ ë°œê²¬" ì—…ì ì— í¬í•¨ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.`
            );
            
            if (!confirmed) return;
            
            coins -= book.price;
            purchasedRecipeBooks.push(bookType);
            
            // í•´ë‹¹ ë ˆì‹œí”¼ë“¤ì„ ë°œê²¬ëœ ë ˆì‹œí”¼ì— ì¶”ê°€ (ì´ë¯¸ ë°œê²¬í•œ ê²ƒì€ ì œì™¸)
            let newRecipes = 0;
            book.recipes.forEach(recipeId => {
                if (!discoveredRecipes.includes(recipeId)) {
                    discoveredRecipes.push(recipeId);
                    newRecipes++;
                }
            });
            
            saveGame();
            renderBuyList();
            updateCoinDisplay();
            applyRecipeFilters();
            checkAchievements(); // ë ˆì‹œí”¼ ì—…ì  ì²´í¬
            
            showNotification(`${book.icon} ${book.name} êµ¬ë§¤ ì™„ë£Œ! (${newRecipes}ê°œì˜ ìƒˆ ë ˆì‹œí”¼ í•´ê¸ˆ)`);
            setShopkeeperDialogue(`${book.name}ì´êµ°ìš”! ì—°êµ¬ì‹¤ì—ì„œ í™•ì¸í•´ë³´ì„¸ìš”.`);
            
            // 0ì›ì´ ë˜ë©´ 10ì½”ì¸ ì§€ê¸‰
            if (coins === 0) {
                setTimeout(() => {
                    coins += 10;
                    saveGame();
                    updateCoinDisplay();
                    setShopkeeperDialogue('...ì´ê±°ë¼ë„ ê°€ì ¸ê°€ìš”.');
                    showNotification('ğŸ’° ìƒì  ì£¼ì¸ì—ê²Œ 10ì½”ì¸ì„ ë°›ì•˜ìŠµë‹ˆë‹¤!');
                }, 800);
            }
        }

        function buyItem(category, type, price) {
            if (coins < price) {
                showNotification('ì½”ì¸ì´ ë¶€ì¡±í•©ë‹ˆë‹¤!');
                setShopkeeperDialogue('...ëˆì´ ë¶€ì¡±í•´ ë³´ì´ë„¤ìš”.');
                return;
            }

            coins -= price;
            let itemName = '';

            if (category === 'food') {
                if (!inventory.food) inventory.food = [];
                inventory.food.push(type);
                if (type === 'medicine') {
                    itemName = MEDICINE.name;
                    showShopNotification(itemName, 'buy', price);
                    // ì§ˆë³‘ íŠœí† ë¦¬ì–¼: ì•½ì´ˆ êµ¬ë§¤ ì•¡ì…˜ ì²´í¬
                    checkSickTutorialAction('buyMedicine');
                } else if (SYNTH_ITEMS[type]) {
                    // í•©ì„± ì•„ì´í…œ (ìˆ˜ì„ í™” ê½ƒì, ì•„ì¹´ì‹œì•„ ê¿€ ë“±)
                    itemName = SYNTH_ITEMS[type].name;
                    showShopNotification(itemName, 'buy', price);
                } else {
                    itemName = FOOD_NAMES[type];
                    showShopNotification(itemName, 'buy', price);
                }
            } else if (category === 'music') {
                if (!inventory.music) inventory.music = [];
                inventory.music.push(type);
                itemName = MUSIC_TYPES[type].name;
                showShopNotification(itemName, 'buy', price);
            } else if (category === 'decoration') {
                if (!inventory.decorations) inventory.decorations = [];
                inventory.decorations.push(type);
                itemName = DECORATION_TYPES[type].name;
                showShopNotification(itemName, 'buy', price);
            }

            setShopkeeperDialogue('...ê°ì‚¬í•©ë‹ˆë‹¤. ë˜ ì˜¤ì„¸ìš”.(ì˜¤ì§€ë§ˆ)');
            saveGame();
            renderSellList();
            renderBuyList();
            updateCoinDisplay();
            renderInventory();
            
            // 0ì›ì´ ë˜ë©´ 10ì½”ì¸ ì§€ê¸‰
            if (coins === 0) {
                setTimeout(() => {
                    coins += 10;
                    saveGame();
                    updateCoinDisplay();
                    setShopkeeperDialogue('...ì´ê±°ë¼ë„ ê°€ì ¸ê°€ìš”.');
                    showNotification('ğŸ’° ìƒì  ì£¼ì¸ì—ê²Œ 10ì½”ì¸ì„ ë°›ì•˜ìŠµë‹ˆë‹¤!');
                }, 800);
            }
            
            // ì—°êµ¬ì‹¤ íŠœí† ë¦¬ì–¼ ì²´í¬
            checkInventoryAndLabTutorial();
        }
        
        // ì´ë²¤íŠ¸ ì•„ì´í…œ êµ¬ë§¤
        function buyEventItem(itemKey, price) {
            if (coins < price) {
                showNotification('ì½”ì¸ì´ ë¶€ì¡±í•©ë‹ˆë‹¤!');
                setShopkeeperDialogue('...ëˆì´ ë¶€ì¡±í•´ ë³´ì´ë„¤ìš”.');
                return;
            }
            
            const item = EVENT_ITEMS[itemKey];
            if (!item) {
                showNotification('ì•„ì´í…œì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
                return;
            }
            
            // ì´ë²¤íŠ¸ ê¸°ê°„ ì²´í¬
            const event = EVENT_TYPES[item.event];
            if (event && event.validUntil && new Date() > new Date(event.validUntil)) {
                showNotification('ì´ë²¤íŠ¸ ê¸°ê°„ì´ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤');
                return;
            }
            
            coins -= price;
            
            if (item.type === 'food') {
                if (!inventory.food) inventory.food = [];
                inventory.food.push(itemKey);
            } else if (item.type === 'music') {
                if (!inventory.music) inventory.music = [];
                inventory.music.push(itemKey);
            } else if (item.type === 'decoration') {
                if (!inventory.decorations) inventory.decorations = [];
                inventory.decorations.push(itemKey);
            }
            
            showShopNotification(`ğŸ„ ${item.name}`, 'buy', price);
            setShopkeeperDialogue('...ê°ì‚¬í•©ë‹ˆë‹¤. ë˜ ì˜¤ì„¸ìš”.(ì˜¤ì§€ë§ˆ)');
            
            saveGame();
            renderSellList();
            renderBuyList();
            updateCoinDisplay();
            renderInventory();
            
            // 0ì›ì´ ë˜ë©´ 10ì½”ì¸ ì§€ê¸‰
            if (coins === 0) {
                setTimeout(() => {
                    coins += 10;
                    saveGame();
                    updateCoinDisplay();
                    setShopkeeperDialogue('...ì´ê±°ë¼ë„ ê°€ì ¸ê°€ìš”.');
                    showNotification('ğŸ’° ìƒì  ì£¼ì¸ì—ê²Œ 10ì½”ì¸ì„ ë°›ì•˜ìŠµë‹ˆë‹¤!');
                }, 800);
            }
            
            // ì—°êµ¬ì‹¤ íŠœí† ë¦¬ì–¼ ì²´í¬
            checkInventoryAndLabTutorial();
        }

        // ì•¨ë²” ë°ì´í„°ë¡œë¶€í„° ë„ê° ì¬êµ¬ì„±
        function rebuildEncyclopediaFromAlbum() {
            console.log('ì•¨ë²”ì—ì„œ ë„ê° ì¬êµ¬ì„± ì‹œì‘...');
            console.log('ì•¨ë²” ë°ì´í„°:', collection);
            
            const newEncyclopedia = {};
            
            collection.forEach(spirit => {
                let encyclopediaKey;
                const wingType = spirit.wingType || 'butterfly'; // ê¸°ë³¸ê°’ ë‚˜ë¹„í˜•
                
                if (spirit.type === 'titania' || spirit.type === 'oberon' || spirit.type === 'spiritking') {
                    // ì „ì„¤ì  ì¡´ì¬ëŠ” ê³ ìœ  í‚¤ ì‚¬ìš©
                    encyclopediaKey = spirit.type;
                } else if (spirit.type === 'nostat') {
                    // ìˆ˜ì‹ì–´ ì—†ëŠ” ì •ë ¹ (wingType í¬í•¨)
                    encyclopediaKey = `nostat-${spirit.attributeType}-${wingType}`;
                } else if (spirit.type && spirit.type.startsWith('fusion-')) {
                    // ì—°ê²° ì •ë ¹ì€ íƒ€ì… ê·¸ëŒ€ë¡œ ì‚¬ìš©
                    encyclopediaKey = spirit.type;
                } else if (spirit.type && spirit.type.startsWith('event_')) {
                    // ì´ë²¤íŠ¸ ì •ë ¹ - ë‚˜ë¹„/ë‚˜ë°© êµ¬ë¶„ í•„ìš”
                    // ê¸°ì¡´ í‚¤ì—ì„œ ì´ë²¤íŠ¸ íƒ€ì…ê³¼ ì´ë¡œì¹˜ ì—¬ë¶€ ì¶”ì¶œ
                    const typeParts = spirit.type.replace('event_', '').split('_');
                    const eventKey = typeParts[0]; // christmas2025
                    const isShiny = typeParts.includes('shiny');
                    const event = EVENT_TYPES[eventKey];
                    
                    // ì´ë²¤íŠ¸ê°€ ë‚˜ë¹„/ë‚˜ë°© ë¶„ë¦¬ë¥¼ ì§€ì›í•˜ëŠ”ì§€ í™•ì¸
                    const stages = isShiny && event?.shiny ? event.shiny.stages : event?.stages;
                    const hasWingTypes = stages?.adult && typeof stages.adult === 'object' && stages.adult.butterfly;
                    
                    if (hasWingTypes) {
                        // ë‚˜ë¹„/ë‚˜ë°© ë¶„ë¦¬
                        encyclopediaKey = isShiny ? `event_${eventKey}_shiny_${wingType}` : `event_${eventKey}_${wingType}`;
                    } else {
                        // ë¶„ë¦¬ ì—†ìŒ - ê¸°ì¡´ í‚¤ ì‚¬ìš©
                        encyclopediaKey = spirit.type;
                    }
                } else {
                    // ì¼ë°˜ ì •ë ¹ (ìŠ¤íƒ¯-ì†ì„±-wingType)
                    encyclopediaKey = `${spirit.type}-${spirit.attributeType}-${wingType}`;
                }
                
                if (!newEncyclopedia[encyclopediaKey]) {
                    newEncyclopedia[encyclopediaKey] = 0;
                }
                newEncyclopedia[encyclopediaKey]++;
            });
            
            console.log('ì¬êµ¬ì„±ëœ ë„ê°:', newEncyclopedia);
            encyclopedia = newEncyclopedia;
            saveGame();
            
            return Object.keys(newEncyclopedia).length;
        }

        async function manualRebuildEncyclopedia() {
            if (collection.length === 0) {
                showNotification('ì•¨ë²”ì— ë°ì´í„°ê°€ ì—†ì–´ ë³µêµ¬í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
                return;
            }
            
            const confirmed = await showConfirm(
                'ë„ê° ë³µêµ¬',
                `ì•¨ë²”ì— ìˆëŠ” ${collection.length}ë§ˆë¦¬ì˜ ì •ë ¹ ë°ì´í„°ë¡œ ë„ê°ì„ ë‹¤ì‹œ êµ¬ì„±í•©ë‹ˆë‹¤.\n\nê¸°ì¡´ ë„ê° ë°ì´í„°ëŠ” ë®ì–´ì”Œì›Œì§‘ë‹ˆë‹¤.\nê³„ì†í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`
            );
            
            if (!confirmed) {
                return;
            }
            
            const recoveredCount = rebuildEncyclopediaFromAlbum();
            renderEncyclopedia();
            showNotification(`âœ… ë„ê°ì„ ë³µêµ¬í–ˆìŠµë‹ˆë‹¤! (${recoveredCount}ì¢…)`);
        }
        
        // ë„ê° â†’ ì•¨ë²” ë³µêµ¬ (ë„ê°ì— ìˆëŠ”ë° ì•¨ë²”ì— ì—†ëŠ” ì •ë ¹ ë³µêµ¬)
        async function recoverAlbumFromEncyclopedia() {
            // ì•¨ë²”ì— ìˆëŠ” íƒ€ì…ë“¤ ìˆ˜ì§‘ (íƒ€ì…ë³„ ì¹´ìš´íŠ¸)
            const albumCounts = {};
            collection.forEach(item => {
                if (!item.type) return;
                
                let key;
                if (item.type === 'nostat') {
                    key = `nostat-${item.attributeType}`;
                } else if (item.type.startsWith('event_') || item.type === 'titania' || item.type === 'oberon' || item.type === 'spiritking' || FUSION_TYPES[item.type]) {
                    key = item.type;
                } else {
                    key = `${item.type}-${item.attributeType}`;
                }
                albumCounts[key] = (albumCounts[key] || 0) + 1;
            });
            
            let recoveredCount = 0;
            const recoveredNames = [];
            
            // ë„ê° ìˆœíšŒ
            Object.entries(encyclopedia).forEach(([key, value]) => {
                const encyclopediaCount = typeof value === 'object' ? (value.count || 0) : (value || 0);
                if (encyclopediaCount <= 0) return;
                
                const albumCount = albumCounts[key] || 0;
                
                // ìƒì„¸ ì •ë³´ ë°°ì—´ í™•ì¸
                const details = encyclopediaDetails[key] || [];
                
                // ìƒì„¸ ì •ë³´ ê°œìˆ˜ë¥¼ ê¸°ì¤€ìœ¼ë¡œ ë³µêµ¬ (ë„ê° ì¹´ìš´íŠ¸ê°€ ì•„ë‹Œ ì‹¤ì œ ì €ì¥ëœ ìƒì„¸ ì •ë³´)
                // ìƒì„¸ ì •ë³´ê°€ ì—†ìœ¼ë©´ ìµœëŒ€ 1ê°œë§Œ ë³µêµ¬ (ì¤‘ë³µ ë°©ì§€)
                const availableDetails = details.length > 0 ? details.length : Math.min(1, encyclopediaCount);
                
                // ì•¨ë²”ì— ì—†ëŠ” ê²ƒë§Œ ë³µêµ¬
                const missingCount = Math.max(0, availableDetails - albumCount);
                if (missingCount <= 0) return;
                
                // ë³µêµ¬í•  ì •ë ¹ ì •ë³´ ìƒì„±
                for (let i = 0; i < missingCount; i++) {
                    // ìƒì„¸ ì •ë³´ ì¸ë±ìŠ¤: ì•¨ë²”ì— ìˆëŠ” ìˆ˜ + i
                    const detailIndex = albumCount + i;
                    const recoveredSpirit = createRecoveredSpirit(key, detailIndex < details.length ? detailIndex : null);
                    if (recoveredSpirit) {
                        collection.push(recoveredSpirit);
                        recoveredCount++;
                        if (!recoveredNames.includes(recoveredSpirit.name)) {
                            recoveredNames.push(recoveredSpirit.name);
                        }
                    }
                }
            });
            
            if (recoveredCount > 0) {
                saveGame();
                renderCollection();
            }
            
            return { count: recoveredCount, names: recoveredNames };
        }
        
        // ë³µêµ¬ìš© ì •ë ¹ ë°ì´í„° ìƒì„± (ìƒì„¸ ì •ë³´ê°€ ìˆìœ¼ë©´ ì‚¬ìš©, ì—†ìœ¼ë©´ ê¸°ë³¸ê°’)
        function createRecoveredSpirit(encyclopediaKey, detailIndex = null) {
            // ìƒì„¸ ì •ë³´ê°€ ìˆìœ¼ë©´ ê·¸ê±¸ ì‚¬ìš©
            if (encyclopediaDetails[encyclopediaKey] && detailIndex !== null) {
                const detail = encyclopediaDetails[encyclopediaKey][detailIndex];
                if (detail) {
                    return {
                        id: `recovered-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`,
                        type: detail.type || encyclopediaKey,
                        attributeType: detail.attributeType || encyclopediaKey,
                        name: detail.name || 'ë³µêµ¬ëœ ì •ë ¹',
                        icon: detail.icon || 'âœ¨',
                        desc: detail.desc || '',
                        parameters: { ...detail.parameters },
                        hiddenAttributes: { ...detail.hiddenAttributes },
                        originalName: detail.originalName || '(ë³µêµ¬ë¨)',
                        wingType: detail.wingType,
                        lightTime: detail.lightTime || 0,
                        darkTime: detail.darkTime || 0,
                        completedAt: detail.completedAt || Date.now(),
                        isEventSpirit: detail.isEventSpirit || false,
                        eventType: detail.eventType || null,
                        isFusion: detail.isFusion || false,
                        fusionRarity: detail.fusionRarity || null,
                        isRecovered: true,
                        recoveredFromDetails: true, // ìƒì„¸ ì •ë³´ì—ì„œ ë³µêµ¬ë¨
                        // í‚¤ì›Œë“œ ì •ë³´ ë³µêµ¬
                        statusKeywords: detail.statusKeywords || [],
                        inheritedKeywords: detail.inheritedKeywords || [],
                        allStatusKeywords: detail.allStatusKeywords || []
                    };
                }
            }
            
            // ìƒì„¸ ì •ë³´ê°€ ì—†ìœ¼ë©´ ê¸°ë³¸ê°’ìœ¼ë¡œ ìƒì„±
            const baseSpirit = {
                id: `recovered-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`,
                completedAt: Date.now(),
                originalName: '(ë³µêµ¬ë¨)',
                isRecovered: true, // ë³µêµ¬ëœ ì •ë ¹ í‘œì‹œ
                parameters: { intelligence: 50, strength: 50, charm: 50, affection: 50 },
                hiddenAttributes: { fire: 0, water: 0, wind: 0, earth: 0, light: 0, dark: 0 }
            };
            
            // ì „ì„¤ ì •ë ¹
            if (encyclopediaKey === 'titania') {
                return {
                    ...baseSpirit,
                    type: 'titania',
                    attributeType: 'light',
                    name: 'í‹°íƒ€ë‹ˆì•„',
                    icon: 'ğŸ¦‹âœ¨',
                    desc: '(ë³µêµ¬ëœ ì •ë ¹)',
                    wingType: 'butterfly',
                    parameters: { intelligence: 100, strength: 100, charm: 100, affection: 100 }
                };
            }
            if (encyclopediaKey === 'oberon') {
                return {
                    ...baseSpirit,
                    type: 'oberon',
                    attributeType: 'dark',
                    name: 'ì˜¤ë² ë¡ ',
                    icon: 'ğŸ¦‹ğŸŒ™',
                    desc: '(ë³µêµ¬ëœ ì •ë ¹)',
                    wingType: 'moth',
                    parameters: { intelligence: 100, strength: 100, charm: 100, affection: 100 }
                };
            }
            if (encyclopediaKey === 'spiritking') {
                return {
                    ...baseSpirit,
                    type: 'spiritking',
                    attributeType: 'balanced',
                    name: 'ì •ë ¹ì™•',
                    icon: 'ğŸ‘‘ğŸŒ¸',
                    desc: '(ë³µêµ¬ëœ ì •ë ¹)',
                    wingType: 'butterfly',
                    parameters: { intelligence: 100, strength: 100, charm: 100, affection: 150 }
                };
            }
            
            // í•©ì„±/ì—°ê²° ì •ë ¹
            if (FUSION_TYPES[encyclopediaKey]) {
                const fusion = FUSION_TYPES[encyclopediaKey];
                return {
                    ...baseSpirit,
                    type: encyclopediaKey,
                    attributeType: encyclopediaKey,
                    name: fusion.name,
                    icon: fusion.icon,
                    desc: '(ë³µêµ¬ëœ ì •ë ¹)',
                    isFusion: true,
                    fusionRarity: fusion.rarity
                };
            }
            
            // ì´ë²¤íŠ¸ ì •ë ¹
            if (encyclopediaKey.startsWith('event_')) {
                const eventKey = encyclopediaKey.replace('event_', '').replace('_shiny', '');
                const isShiny = encyclopediaKey.includes('_shiny');
                const event = EVENT_TYPES[eventKey];
                if (event) {
                    const data = isShiny && event.shiny ? event.shiny : event;
                    return {
                        ...baseSpirit,
                        type: encyclopediaKey,
                        attributeType: event.attribute,
                        name: data.name,
                        icon: data.stages ? data.stages.adult : 'ğŸ„',
                        desc: '(ë³µêµ¬ëœ ì •ë ¹)',
                        isEventSpirit: true,
                        eventType: eventKey,
                        isShiny: isShiny
                    };
                }
                return null;
            }
            
            // ìˆ˜ì‹ì–´ ì—†ëŠ” ì •ë ¹ (nostat-{attr}-{wingType})
            if (encyclopediaKey.startsWith('nostat-')) {
                const keyParts = encyclopediaKey.replace('nostat-', '').split('-');
                let attrType, wingType;
                
                if (keyParts.length >= 2) {
                    // ìƒˆ í˜•ì‹: nostat-fire-butterfly
                    wingType = keyParts.pop(); // ë§ˆì§€ë§‰ì€ wingType
                    attrType = keyParts.join('-'); // ë‚˜ë¨¸ì§€ëŠ” ì†ì„± (ë³µí•©ì†ì„± ëŒ€ì‘)
                } else {
                    // êµ¬ í˜•ì‹: nostat-fire
                    attrType = keyParts[0];
                    wingType = 'butterfly'; // ê¸°ë³¸ê°’
                }
                
                const attrData = ATTRIBUTE_NAMES[attrType];
                if (attrData) {
                    const attrIcon = typeof attrData.icon === 'object' ? attrData.icon[wingType] || attrData.icon.butterfly : attrData.icon;
                    return {
                        ...baseSpirit,
                        type: 'nostat',
                        attributeType: attrType,
                        name: `${attrData.name}`,
                        icon: attrIcon,
                        desc: '(ë³µêµ¬ëœ ì •ë ¹)',
                        wingType: wingType,
                        parameters: { intelligence: 10, strength: 10, charm: 10, affection: 50 }
                    };
                }
                return null;
            }
            
            // ì¼ë°˜ ì •ë ¹ (statType-attrType-wingType) - ìƒˆ ì‹œìŠ¤í…œ
            const parts = encyclopediaKey.split('-');
            if (parts.length >= 2) {
                let statType, attrType, wingType;
                
                // ë§ˆì§€ë§‰ì´ butterfly ë˜ëŠ” mothë©´ wingType
                const lastPart = parts[parts.length - 1];
                if (lastPart === 'butterfly' || lastPart === 'moth') {
                    wingType = parts.pop();
                } else {
                    wingType = 'butterfly'; // ê¸°ë³¸ê°’
                }
                
                if (parts.length === 2) {
                    // statType-attrType (ë‹¨ì¼ ì†ì„±)
                    [statType, attrType] = parts;
                } else if (parts.length === 3) {
                    // statType-attr1-attr2 (ë³µí•© ì†ì„±)
                    statType = parts[0];
                    attrType = `${parts[1]}-${parts[2]}`;
                }
                
                const evolution = EVOLUTION_TYPES[statType];
                const attrData = ATTRIBUTE_NAMES[attrType];
                
                if (evolution && attrData) {
                    // ìŠ¤íƒ¯ íƒ€ì…ì— ë”°ë¥¸ ìŠ¤íƒ¯ ì„¤ì •
                    const params = { intelligence: 30, strength: 30, charm: 30, affection: 50 };
                    if (statType === 'intelligent') params.intelligence = 100;
                    else if (statType === 'strong') params.strength = 100;
                    else if (statType === 'beautiful') params.charm = 100;
                    else if (statType === 'sage') {
                        params.intelligence = 100;
                        params.strength = 100;
                        params.charm = 100;
                    }
                    
                    const attrIcon = typeof attrData.icon === 'object' ? attrData.icon[wingType] || attrData.icon.butterfly : attrData.icon;
                    
                    return {
                        ...baseSpirit,
                        type: statType,
                        attributeType: attrType,
                        name: `${evolution.prefix} ${attrData.name}`,
                        icon: `${evolution.icon}${attrIcon}`,
                        desc: '(ë³µêµ¬ëœ ì •ë ¹)',
                        wingType: wingType,
                        parameters: params
                    };
                }
            }
            
            return null;
        }
        
        // ì•¨ë²” ë³µêµ¬ UI
        async function showAlbumRecoveryDialog() {
            // ë¨¼ì € ë³µêµ¬ ê°€ëŠ¥í•œ ì •ë ¹ ìˆ˜ ê³„ì‚°
            const albumTypes = {};
            collection.forEach(item => {
                const key = getEncyclopediaKeyFromAlbumItem(item);
                if (key) {
                    albumTypes[key] = (albumTypes[key] || 0) + 1;
                }
            });
            
            let missingCount = 0;
            let withDetailsCount = 0; // ìƒì„¸ ì •ë³´ê°€ ìˆëŠ” ì •ë ¹ ìˆ˜
            let noDetailsCount = 0; // ìƒì„¸ ì •ë³´ê°€ ì—†ëŠ” ì •ë ¹ ìˆ˜
            
            Object.entries(encyclopedia).forEach(([key, value]) => {
                const encyclopediaCount = typeof value === 'object' ? (value.count || 0) : (value || 0);
                if (encyclopediaCount <= 0) return;
                
                const albumCount = albumTypes[key] || 0;
                const details = encyclopediaDetails[key] || [];
                
                // ìƒì„¸ ì •ë³´ ê°œìˆ˜ë¥¼ ê¸°ì¤€ìœ¼ë¡œ ë³µêµ¬ ê°€ëŠ¥ ìˆ˜ ê³„ì‚°
                const availableDetails = details.length > 0 ? details.length : Math.min(1, encyclopediaCount);
                const missing = Math.max(0, availableDetails - albumCount);
                
                if (missing > 0) {
                    missingCount += missing;
                    
                    for (let i = 0; i < missing; i++) {
                        const detailIndex = albumCount + i;
                        if (detailIndex < details.length) {
                            withDetailsCount++;
                        } else {
                            noDetailsCount++;
                        }
                    }
                }
            });
            
            if (missingCount === 0) {
                showNotification('âœ… ëª¨ë“  ì •ë ¹ì´ ì•¨ë²”ì— ìˆìŠµë‹ˆë‹¤. ë³µêµ¬í•  í•­ëª©ì´ ì—†ì–´ìš”!');
                return;
            }
            
            let message = `ë„ê°ì—ëŠ” ìˆì§€ë§Œ ì•¨ë²”ì— ì—†ëŠ” ì •ë ¹ì´ ${missingCount}ë§ˆë¦¬ ë°œê²¬ë˜ì—ˆìŠµë‹ˆë‹¤.\n\n`;
            
            if (withDetailsCount > 0) {
                message += `ğŸ“‹ ìƒì„¸ ì •ë³´ ë³´ì¡´: ${withDetailsCount}ë§ˆë¦¬\n(ë³¸ëª…, ìŠ¤íƒ¯ ë“± ì™„ë²½ ë³µêµ¬)\n\n`;
            }
            if (noDetailsCount > 0) {
                message += `âš ï¸ ê¸°ë³¸ê°’ ë³µêµ¬: ${noDetailsCount}ë§ˆë¦¬\n(ì´ì „ ë²„ì „ì—ì„œ ì§„í™”í•œ ì •ë ¹ - ìŠ¤íƒ¯ì´ ê¸°ë³¸ê°’ìœ¼ë¡œ ì„¤ì •ë¨)\n\n`;
            }
            
            message += `ë³µêµ¬í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`;
            
            const confirmed = await showConfirmAsync(
                'ì•¨ë²” ë³µêµ¬',
                message,
                'ë³µêµ¬í•˜ê¸°',
                'ì·¨ì†Œ'
            );
            
            if (confirmed) {
                const result = await recoverAlbumFromEncyclopedia();
                if (result.count > 0) {
                    showNotification(`âœ… ${result.count}ë§ˆë¦¬ ë³µêµ¬ ì™„ë£Œ!\n${result.names.slice(0, 3).join(', ')}${result.names.length > 3 ? ' ì™¸ ' + (result.names.length - 3) + 'ì¢…' : ''}`);
                    renderCollection();
                } else {
                    showNotification('ë³µêµ¬í•  ì •ë ¹ì´ ì—†ìŠµë‹ˆë‹¤.');
                }
            }
        }
        
        // ì•¨ë²” ì•„ì´í…œì—ì„œ ë„ê° í‚¤ ì¶”ì¶œ
        function getEncyclopediaKeyFromAlbumItem(item) {
            if (!item.type) return null;
            
            if (item.type === 'titania' || item.type === 'oberon' || item.type === 'spiritking') {
                return item.type;
            } else if (item.type === 'nostat') {
                return `nostat-${item.attributeType}`;
            } else if (item.type.startsWith('event_')) {
                return item.type;
            } else if (FUSION_TYPES[item.type]) {
                return item.type;
            } else {
                return `${item.type}-${item.attributeType}`;
            }
        }
        
        // Promise ê¸°ë°˜ í™•ì¸ì°½ (showConfirmì´ ì´ë¯¸ Promise ë°˜í™˜)
        function showConfirmAsync(title, message, confirmText = 'í™•ì¸', cancelText = 'ì·¨ì†Œ') {
            return showConfirm(title, message);
        }
        
        // ì•¨ë²” ë°±ì—… ë³µêµ¬ ê¸°ëŠ¥
        async function showAlbumBackupRestore() {
            const backups = JSON.parse(localStorage.getItem('spiritGarden_autoBackups') || '[]');
            
            if (backups.length === 0) {
                showNotification('ì €ì¥ëœ ë°±ì—…ì´ ì—†ìŠµë‹ˆë‹¤. ì •ë ¹ì„ ì™„ì„±í•˜ë©´ ìë™ìœ¼ë¡œ ë°±ì—…ë©ë‹ˆë‹¤.');
                return;
            }
            
            // ë°±ì—… ëª©ë¡ HTML ìƒì„±
            let backupListHtml = '';
            backups.forEach((backup, index) => {
                const date = new Date(backup.timestamp);
                const dateStr = date.toLocaleString('ko-KR', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit'
                });
                const albumCount = backup.collection ? backup.collection.length : 0;
                const encyclopediaCount = backup.encyclopedia ? Object.keys(backup.encyclopedia).length : 0;
                const eventCount = backup.collection ? backup.collection.filter(item => item.type && item.type.startsWith('event_')).length : 0;
                const hasDetails = backup.encyclopediaDetails && Object.keys(backup.encyclopediaDetails).length > 0;
                
                const eventText = eventCount > 0 ? ' Â· <span style="color: #c41e3a;">ğŸ„ ì´ë²¤íŠ¸ ' + eventCount + 'ë§ˆë¦¬</span>' : '';
                const detailsText = hasDetails ? ' Â· <span style="color: #27ae60;">ğŸ“‹ ìƒì„¸ì •ë³´</span>' : '';
                
                backupListHtml += '<div style="padding: 16px; background: var(--bg); border-radius: 8px; border: 1px solid var(--border);">' +
                    '<div style="display: flex; justify-content: space-between; align-items: center;">' +
                        '<div>' +
                            '<div style="font-weight: 700; margin-bottom: 4px;">' + dateStr + '</div>' +
                            '<div style="font-size: 0.85rem; color: #888;">' +
                                'ì•¨ë²”: ' + albumCount + 'ë§ˆë¦¬ Â· ë„ê°: ' + encyclopediaCount + 'ì¢…' + eventText + detailsText +
                            '</div>' +
                        '</div>' +
                        '<button onclick="restoreAlbumBackup(' + index + ')" style="padding: 8px 16px; background: #333; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">' +
                            'ë³µêµ¬' +
                        '</button>' +
                    '</div>' +
                '</div>';
            });
            
            // ë°±ì—… ëª©ë¡ ëª¨ë‹¬ í‘œì‹œ
            const modal = document.createElement('div');
            modal.className = 'modal active';
            modal.id = 'backupRestoreModal';
            modal.innerHTML = 
                '<div class="modal-content" style="max-width: 600px; max-height: 80vh; overflow-y: auto;">' +
                    '<h3 style="margin-bottom: 16px;">ğŸ“š ì•¨ë²” ë°±ì—… ë³µêµ¬</h3>' +
                    '<p style="margin-bottom: 8px; color: #888;">ì •ë ¹ ì™„ì„± ì‹œ ìë™ ì €ì¥ëœ ë°±ì—… ëª©ë¡ì…ë‹ˆë‹¤ (ìµœê·¼ 10ê°œ)</p>' +
                    '<p style="margin-bottom: 16px; color: #e67e22; font-size: 0.85rem;">âš ï¸ ë³µêµ¬ ì‹œ í˜„ì¬ ì•¨ë²”ê³¼ ë„ê°ì´ ë°±ì—… ì‹œì ìœ¼ë¡œ ë®ì–´ì”Œì›Œì§‘ë‹ˆë‹¤.</p>' +
                    '<div style="display: flex; flex-direction: column; gap: 12px; margin-bottom: 20px;">' +
                        backupListHtml +
                    '</div>' +
                    '<div style="display: flex; gap: 12px;">' +
                        '<button onclick="exportAlbumBackup()" style="flex: 1; padding: 12px; background: var(--water); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">' +
                            'ğŸ’¾ ì•¨ë²” ë°±ì—… ë‹¤ìš´ë¡œë“œ' +
                        '</button>' +
                        '<button onclick="importAlbumBackup()" style="flex: 1; padding: 12px; background: var(--wind); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">' +
                            'ğŸ“‚ ì•¨ë²” ë°±ì—… ë¶ˆëŸ¬ì˜¤ê¸°' +
                        '</button>' +
                    '</div>' +
                    '<button onclick="closeBackupModal()" style="width: 100%; margin-top: 16px; padding: 12px; background: #6c757d; color: white; border: none; border-radius: 8px; cursor: pointer;">' +
                        'ë‹«ê¸°' +
                    '</button>' +
                '</div>';
            document.body.appendChild(modal);
        }
        
        function closeBackupModal() {
            const modal = document.getElementById('backupRestoreModal');
            if (modal) modal.remove();
        }
        
        async function restoreAlbumBackup(index) {
            const backups = JSON.parse(localStorage.getItem('spiritGarden_autoBackups') || '[]');
            const backup = backups[index];
            
            if (!backup) {
                showNotification('ë°±ì—…ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            
            const date = new Date(backup.timestamp).toLocaleString('ko-KR');
            const confirmed = await showConfirm(
                'ì•¨ë²” ë³µêµ¬',
                `${date} ì‹œì ì˜ ë°±ì—…ìœ¼ë¡œ ë³µêµ¬í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nì•¨ë²”: ${backup.collection.length}ë§ˆë¦¬\në„ê°: ${Object.keys(backup.encyclopedia).length}ì¢…\n\nâš ï¸ í˜„ì¬ ì•¨ë²”ê³¼ ë„ê°ì´ ë®ì–´ì”Œì›Œì§‘ë‹ˆë‹¤.`
            );
            
            if (!confirmed) return;
            
            collection = backup.collection || [];
            encyclopedia = backup.encyclopedia || {};
            if (backup.encyclopediaDetails) {
                encyclopediaDetails = backup.encyclopediaDetails;
            }
            saveGame();
            
            closeBackupModal();
            renderCollection();
            renderEncyclopedia();
            showNotification(`âœ… ${date} ì‹œì ìœ¼ë¡œ ì•¨ë²”ì„ ë³µêµ¬í–ˆìŠµë‹ˆë‹¤!`);
        }
        
        function exportAlbumBackup() {
            const backupData = {
                exportDate: new Date().toISOString(),
                collection: collection,
                encyclopedia: encyclopedia,
                encyclopediaDetails: encyclopediaDetails
            };
            
            const blob = new Blob([JSON.stringify(backupData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `spirit-garden-album-backup-${new Date().toISOString().slice(0,10)}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showNotification('ğŸ’¾ ì•¨ë²” ë°±ì—… íŒŒì¼ì„ ë‹¤ìš´ë¡œë“œí–ˆìŠµë‹ˆë‹¤.');
        }
        
        function importAlbumBackup() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = async (e) => {
                const file = e.target.files[0];
                if (!file) return;
                
                try {
                    const text = await file.text();
                    const data = JSON.parse(text);
                    
                    if (!data.collection || !Array.isArray(data.collection)) {
                        showNotification('âŒ ìœ íš¨í•˜ì§€ ì•Šì€ ë°±ì—… íŒŒì¼ì…ë‹ˆë‹¤.');
                        return;
                    }
                    
                    const confirmed = await showConfirm(
                        'ì•¨ë²” ë³µêµ¬',
                        `ë°±ì—… íŒŒì¼ì—ì„œ ë³µêµ¬í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nì•¨ë²”: ${data.collection.length}ë§ˆë¦¬\në„ê°: ${data.encyclopedia ? Object.keys(data.encyclopedia).length : 0}ì¢…\n\nâš ï¸ í˜„ì¬ ì•¨ë²”ê³¼ ë„ê°ì´ ë®ì–´ì”Œì›Œì§‘ë‹ˆë‹¤.`
                    );
                    
                    if (!confirmed) return;
                    
                    collection = data.collection;
                    encyclopedia = data.encyclopedia || {};
                    if (data.encyclopediaDetails) {
                        encyclopediaDetails = data.encyclopediaDetails;
                    }
                    
                    // ë„ê°ì´ ë¹„ì–´ìˆìœ¼ë©´ ì•¨ë²”ì—ì„œ ì¬êµ¬ì„±
                    if (Object.keys(encyclopedia).length === 0 && collection.length > 0) {
                        rebuildEncyclopediaFromAlbum();
                    }
                    
                    saveGame();
                    closeBackupModal();
                    renderCollection();
                    renderEncyclopedia();
                    showNotification(`âœ… ë°±ì—… íŒŒì¼ì—ì„œ ì•¨ë²”ì„ ë³µêµ¬í–ˆìŠµë‹ˆë‹¤!`);
                } catch (err) {
                    console.error('ë°±ì—… ë³µêµ¬ ì˜¤ë¥˜:', err);
                    showNotification('âŒ ë°±ì—… íŒŒì¼ì„ ì½ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                }
            };
            input.click();
        }
        
        // ì—°ê²° ì •ë ¹ ê´€ë¦¬ ê¸°ëŠ¥
        async function repairBrokenSpirits() {
            // ì—°ê²°ë¡œ íƒœì–´ë‚œ ì •ë ¹ ì°¾ê¸°
            const bredSpirits = spirits.filter(spirit => spirit.isBred || spirit.breedCode);
            
            if (bredSpirits.length === 0) {
                showNotification('ì—°ê²°ë¡œ íƒœì–´ë‚œ ì •ë ¹ì´ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            
            // ì—°ê²° ì •ë ¹ ëª©ë¡ í‘œì‹œ
            const modal = document.createElement('div');
            modal.className = 'modal active';
            modal.id = 'repairModal';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 500px; max-height: 80vh; overflow-y: auto;">
                    <h3 style="margin-bottom: 16px;">ğŸ”§ ì—°ê²° ì •ë ¹ ê´€ë¦¬</h3>
                    <p style="margin-bottom: 16px; color: #888;">ì—°ê²°ë¡œ íƒœì–´ë‚œ ì •ë ¹: ${bredSpirits.length}ë§ˆë¦¬</p>
                    
                    <div style="display: flex; flex-direction: column; gap: 12px; margin-bottom: 20px;">
                        ${bredSpirits.map(spirit => {
                            const stage = getStage(spirit.growth);
                            return `
                            <div style="padding: 12px; background: var(--bg); border-radius: 8px; border: 1px solid var(--border);">
                                <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px;">
                                    <span style="font-size: 1.5rem;">${getStageIcon(stage, spirit) || 'ğŸ¥š'}</span>
                                    <div>
                                        <div style="font-weight: 700;">${spirit.name || 'ì´ë¦„ ì—†ìŒ'}</div>
                                        <div style="font-size: 0.8rem; color: #888;">${STAGE_NAMES[stage] || 'ì•Œ'} Â· ì„±ì¥ ${spirit.growth || 0}</div>
                                    </div>
                                </div>
                                <div style="font-size: 0.85rem; color: #888; margin-bottom: 8px;">
                                    ğŸ”— ${spirit.bredWith || 'ì•Œ ìˆ˜ ì—†ìŒ'}ì˜ ì½”ë“œë¡œ ì—°ê²°
                                </div>
                                <div style="display: flex; gap: 8px;">
                                    <button onclick="repairSpirit(${spirit.id})" style="flex: 1; padding: 8px; background: var(--water); color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 0.85rem;">
                                        ğŸ”§ ë³µêµ¬
                                    </button>
                                    <button onclick="deleteBrokenSpirit(${spirit.id}, true)" style="flex: 1; padding: 8px; background: #e74c3c; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 0.85rem;">
                                        ğŸ—‘ï¸ ì‚­ì œ (ì½”ë“œë°˜í™˜)
                                    </button>
                                </div>
                            </div>
                        `}).join('')}
                    </div>
                    
                    <div style="display: flex; gap: 10px;">
                        <button onclick="repairAllSpirits()" style="flex: 1; padding: 12px; background: var(--water); color: white; border: none; border-radius: 8px; cursor: pointer;">
                            ğŸ”§ ëª¨ë‘ ë³µêµ¬
                        </button>
                        <button onclick="closeRepairModal()" style="flex: 1; padding: 12px; background: var(--card); border: 1px solid var(--border); border-radius: 8px; cursor: pointer;">
                            ë‹«ê¸°
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }
        
        function closeRepairModal() {
            const modal = document.getElementById('repairModal');
            if (modal) modal.remove();
        }
        
        function repairSpirit(spiritId) {
            const spirit = spirits.find(s => String(s.id) === String(spiritId));
            if (!spirit) {
                showNotification('âŒ ì •ë ¹ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
                return;
            }
            
            const timestamp = new Date().toLocaleString('ko-KR', {
                month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit'
            });
            
            // í•„ìˆ˜ í•„ë“œ ë³µêµ¬
            if (!spirit.parameters) {
                spirit.parameters = { intelligence: 0, strength: 0, charm: 0, affection: 0 };
            }
            if (spirit.parameters.affection === undefined) spirit.parameters.affection = 0;
            
            if (!spirit.hiddenAttributes) {
                spirit.hiddenAttributes = { fire: 0, water: 0, wind: 0, earth: 0, light: 0, dark: 0 };
            }
            
            if (!spirit.satisfaction) spirit.satisfaction = 'mid';
            if (!spirit.status) spirit.status = 'ë³µêµ¬ë˜ì—ˆìŠµë‹ˆë‹¤';
            if (!spirit.birthTime) spirit.birthTime = Date.now();
            if (!spirit.lastInteraction) spirit.lastInteraction = Date.now();
            if (spirit.lightTime === undefined) spirit.lightTime = 0;
            if (spirit.darkTime === undefined) spirit.darkTime = 0;
            if (spirit.musicListened === undefined) spirit.musicListened = 0;
            if (spirit.feedCount === undefined) spirit.feedCount = 0;
            if (spirit.growth === undefined) spirit.growth = 0;
            
            // logs í˜•ì‹ ë³µêµ¬
            if (!spirit.logs) {
                spirit.logs = [];
            } else if (spirit.logs.length > 0 && typeof spirit.logs[0] === 'string') {
                // ë¬¸ìì—´ ë°°ì—´ì„ ê°ì²´ ë°°ì—´ë¡œ ë³€í™˜
                spirit.logs = spirit.logs.map(msg => ({
                    time: timestamp,
                    message: msg
                }));
            }
            
            // ë³µêµ¬ ë¡œê·¸ ì¶”ê°€
            spirit.logs.unshift({ time: timestamp, message: 'ğŸ”§ ë°ì´í„°ê°€ ë³µêµ¬ë˜ì—ˆìŠµë‹ˆë‹¤.' });
            
            saveGame();
            renderSpirits();
            closeRepairModal();
            showNotification(`âœ… ${spirit.name} ë³µêµ¬ ì™„ë£Œ!`);
        }
        
        function repairAllSpirits() {
            const bredSpirits = spirits.filter(spirit => spirit.isBred || spirit.breedCode);
            
            bredSpirits.forEach(spirit => {
                repairSpiritSilent(spirit);
            });
            
            saveGame();
            renderSpirits();
            closeRepairModal();
            showNotification(`âœ… ${bredSpirits.length}ë§ˆë¦¬ ì •ë ¹ ë³µêµ¬ ì™„ë£Œ!`);
        }
        
        function repairSpiritSilent(spirit) {
            const timestamp = new Date().toLocaleString('ko-KR', {
                month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit'
            });
            
            if (!spirit.parameters) {
                spirit.parameters = { intelligence: 0, strength: 0, charm: 0, affection: 0 };
            }
            if (spirit.parameters.affection === undefined) spirit.parameters.affection = 0;
            
            if (!spirit.hiddenAttributes) {
                spirit.hiddenAttributes = { fire: 0, water: 0, wind: 0, earth: 0, light: 0, dark: 0 };
            }
            
            if (!spirit.satisfaction) spirit.satisfaction = 'mid';
            if (!spirit.status) spirit.status = 'ë³µêµ¬ë˜ì—ˆìŠµë‹ˆë‹¤';
            if (!spirit.birthTime) spirit.birthTime = Date.now();
            if (!spirit.lastInteraction) spirit.lastInteraction = Date.now();
            if (spirit.lightTime === undefined) spirit.lightTime = 0;
            if (spirit.darkTime === undefined) spirit.darkTime = 0;
            if (spirit.musicListened === undefined) spirit.musicListened = 0;
            if (spirit.feedCount === undefined) spirit.feedCount = 0;
            if (spirit.growth === undefined) spirit.growth = 0;
            
            if (!spirit.logs) {
                spirit.logs = [];
            } else if (spirit.logs.length > 0 && typeof spirit.logs[0] === 'string') {
                spirit.logs = spirit.logs.map(msg => ({ time: timestamp, message: msg }));
            }
            
            spirit.logs.unshift({ time: timestamp, message: 'ğŸ”§ ë°ì´í„°ê°€ ë³µêµ¬ë˜ì—ˆìŠµë‹ˆë‹¤.' });
        }
        
        function deleteBrokenSpirit(spiritId, returnCode) {
            const spirit = spirits.find(s => String(s.id) === String(spiritId));
            if (!spirit) {
                console.log('Spirit not found:', spiritId);
                showNotification('âŒ ì •ë ¹ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
                return;
            }
            
            if (returnCode && spirit.breedCode) {
                // ì•¨ë²”ì—ì„œë„ í•´ë‹¹ ì½”ë“œ ì‚¬ìš© ê¸°ë¡ ì œê±°
                if (collection) {
                    collection.forEach(s => {
                        if (s.breedCode === spirit.breedCode) {
                            delete s.breedCode;
                        }
                    });
                }
                showNotification('ğŸ”„ ì—°ê²° ì½”ë“œê°€ ë°˜í™˜ë˜ì—ˆìŠµë‹ˆë‹¤!');
            }
            
            spirits = spirits.filter(s => String(s.id) !== String(spiritId));
            saveGame();
            renderSpirits();
            closeRepairModal();
            showNotification(`ğŸ—‘ï¸ ${spirit.name} ì‚­ì œ ì™„ë£Œ`);
        }

        // ========== í•©ì„± ì‹œìŠ¤í…œ ==========
        
        function switchFusionMode(mode) {
            const localBtn = document.getElementById('fusionModeLocal');
            const shareBtn = document.getElementById('fusionModeShare');
            const localPanel = document.getElementById('localFusionPanel');
            const sharePanel = document.getElementById('shareFusionPanel');
            
            if (mode === 'local') {
                localBtn.style.background = 'var(--text)';
                localBtn.style.color = 'var(--bg)';
                shareBtn.style.background = 'var(--card)';
                shareBtn.style.color = 'var(--text)';
                localPanel.style.display = 'block';
                sharePanel.style.display = 'none';
            } else {
                localBtn.style.background = 'var(--card)';
                localBtn.style.color = 'var(--text)';
                shareBtn.style.background = 'var(--text)';
                shareBtn.style.color = 'var(--bg)';
                localPanel.style.display = 'none';
                sharePanel.style.display = 'block';
                updateShareSpiritList();
            }
        }
        
        function getCompletedSpirits() {
            // í˜„ì¬ ìœ¡ì„± ì¤‘ì¸ ì™„ì„± ì •ë ¹
            const currentCompleted = spirits.filter(s => s.isCompleted && !s.isDead);
            
            // ì•¨ë²”ì— ìˆëŠ” ì™„ì„± ì •ë ¹ (idê°€ ì—†ìœ¼ë©´ ìƒì„±)
            const albumSpirits = (collection || []).map((s, index) => ({
                ...s,
                id: s.id || `album-${index}`,
                isFromAlbum: true,
                isCompleted: true
            }));
            
            return [...currentCompleted, ...albumSpirits];
        }
        
        function getCompletedSpiritsForBreeding() {
            // ì—°ê²°ìš©: í˜„ì¬ ìœ¡ì„± ì¤‘ì¸ ì™„ì„± ì •ë ¹ + ì•¨ë²” ì •ë ¹ (í•©ì„±ìœ¼ë¡œ ë– ë‚œ ì •ë ¹ ì œì™¸)
            const currentCompleted = spirits.filter(s => s.isCompleted && !s.isDead);
            
            const albumSpirits = (collection || [])
                .filter(s => !s.fusedAway) // í•©ì„±ìœ¼ë¡œ ë– ë‚œ ì •ë ¹ ì œì™¸
                .map((s, index) => ({
                    ...s,
                    id: s.id || `album-${index}`,
                    isFromAlbum: true,
                    isCompleted: true
                }));
            
            return [...currentCompleted, ...albumSpirits];
        }
        
        function selectFusionSpirit(slot) {
            const completed = getCompletedSpirits();
            if (completed.length === 0) {
                showNotification('âŒ ì™„ì„±ëœ ì •ë ¹ì´ ì—†ìŠµë‹ˆë‹¤');
                return;
            }
            
            // ì´ë¯¸ ë‹¤ë¥¸ ìŠ¬ë¡¯ì— ì„ íƒëœ ì •ë ¹ ì œì™¸
            const otherSlotSpirit = slot === 1 ? fusionSlot2Spirit : fusionSlot1Spirit;
            const available = completed.filter(s => !otherSlotSpirit || s.id !== otherSlotSpirit.id);
            
            if (available.length === 0) {
                showNotification('âŒ ì„ íƒ ê°€ëŠ¥í•œ ì •ë ¹ì´ ì—†ìŠµë‹ˆë‹¤');
                return;
            }
            
            // ì„ íƒ ëª¨ë‹¬ í‘œì‹œ
            const modalHtml = `
                <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 10000; display: flex; justify-content: center; align-items: center;">
                    <div style="background: var(--card); padding: 24px; border-radius: 12px; max-width: 400px; width: 90%; max-height: 70vh; overflow-y: auto;">
                        <h3 style="margin-bottom: 16px;">ì •ë ¹ ì„ íƒ (ìŠ¬ë¡¯ ${slot})</h3>
                        <div style="display: flex; flex-direction: column; gap: 10px;">
                            ${available.map(s => {
                                const attrName = ATTRIBUTE_NAMES[s.attribute] || ATTRIBUTE_NAMES.normal;
                                return `
                                    <div onclick="confirmFusionSpirit(${slot}, '${s.id}')" style="display: flex; align-items: center; gap: 12px; padding: 12px; background: var(--bg); border-radius: 8px; cursor: pointer; transition: transform 0.2s;" onmouseover="this.style.transform='scale(1.02)'" onmouseout="this.style.transform='scale(1)'">
                                        <span style="font-size: 2rem;">${getSpiritEmoji(s)}</span>
                                        <div>
                                            <div style="font-weight: 700;">${s.name}</div>
                                            <div style="font-size: 0.85rem; color: #888;">${attrName.icon} ${attrName.name}</div>
                                            <div style="font-size: 0.8rem; color: #666;">ğŸ’– ì• ì •ë„: ${s.parameters?.affection || 0}</div>
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                        <button onclick="closeFusionModal()" style="margin-top: 16px; width: 100%; padding: 12px; background: var(--border); border: none; border-radius: 6px; cursor: pointer;">ì·¨ì†Œ</button>
                    </div>
                </div>
            `;
            
            const modal = document.createElement('div');
            modal.id = 'fusionSelectModal';
            modal.innerHTML = modalHtml;
            document.body.appendChild(modal);
        }
        
        function closeFusionModal() {
            const modal = document.getElementById('fusionSelectModal');
            if (modal) modal.remove();
        }
        
        function confirmFusionSpirit(slot, spiritId) {
            const spirit = spirits.find(s => s.id === spiritId);
            if (!spirit) return;
            
            if (slot === 1) {
                fusionSlot1Spirit = spirit;
            } else {
                fusionSlot2Spirit = spirit;
            }
            
            closeFusionModal();
            updateFusionSlots();
        }
        
        function updateFusionSlots() {
            const slot1 = document.getElementById('fusionSlot1');
            const slot2 = document.getElementById('fusionSlot2');
            const result = document.getElementById('fusionResult');
            const info = document.getElementById('fusionInfo');
            const btn = document.getElementById('fusionBtn');
            
            // ìŠ¬ë¡¯ 1 ì—…ë°ì´íŠ¸
            if (fusionSlot1Spirit) {
                const attr1 = ATTRIBUTE_NAMES[fusionSlot1Spirit.attribute] || ATTRIBUTE_NAMES.normal;
                slot1.innerHTML = `
                    <div style="font-size: 2.5rem;">${getSpiritEmoji(fusionSlot1Spirit)}</div>
                    <div style="font-weight: 700; font-size: 0.9rem;">${fusionSlot1Spirit.name}</div>
                    <div style="font-size: 0.8rem; color: #888;">${attr1.icon} ${attr1.name}</div>
                `;
                slot1.style.borderStyle = 'solid';
                slot1.style.background = 'linear-gradient(135deg, rgba(102, 126, 234, 0.1), rgba(118, 75, 162, 0.1))';
            } else {
                slot1.innerHTML = `
                    <div style="font-size: 3rem; opacity: 0.3;">ğŸ¥š</div>
                    <div style="color: #888; font-size: 0.9rem;">ì •ë ¹ ì„ íƒ</div>
                `;
                slot1.style.borderStyle = 'dashed';
                slot1.style.background = 'transparent';
            }
            
            // ìŠ¬ë¡¯ 2 ì—…ë°ì´íŠ¸
            if (fusionSlot2Spirit) {
                const attr2 = ATTRIBUTE_NAMES[fusionSlot2Spirit.attribute] || ATTRIBUTE_NAMES.normal;
                slot2.innerHTML = `
                    <div style="font-size: 2.5rem;">${getSpiritEmoji(fusionSlot2Spirit)}</div>
                    <div style="font-weight: 700; font-size: 0.9rem;">${fusionSlot2Spirit.name}</div>
                    <div style="font-size: 0.8rem; color: #888;">${attr2.icon} ${attr2.name}</div>
                `;
                slot2.style.borderStyle = 'solid';
                slot2.style.background = 'linear-gradient(135deg, rgba(102, 126, 234, 0.1), rgba(118, 75, 162, 0.1))';
            } else {
                slot2.innerHTML = `
                    <div style="font-size: 3rem; opacity: 0.3;">ğŸ¥š</div>
                    <div style="color: #888; font-size: 0.9rem;">ì •ë ¹ ì„ íƒ</div>
                `;
                slot2.style.borderStyle = 'dashed';
                slot2.style.background = 'transparent';
            }
            
            // ê²°ê³¼ ì˜ˆì¸¡
            if (fusionSlot1Spirit && fusionSlot2Spirit) {
                const prediction = predictFusionResult(fusionSlot1Spirit, fusionSlot2Spirit);
                result.innerHTML = `
                    <div style="font-size: 2.5rem;">${prediction.icon}</div>
                    <div style="font-weight: 700; font-size: 0.9rem;">${prediction.name}</div>
                    <div style="font-size: 0.75rem; color: ${getRarityColor(prediction.rarity)};">${getRarityText(prediction.rarity)}</div>
                `;
                result.style.background = 'linear-gradient(135deg, rgba(255,215,0,0.2), rgba(255,255,255,0.1))';
                
                // ì• ì •ë„ ì²´í¬
                const affection1 = fusionSlot1Spirit.parameters?.affection || 0;
                const affection2 = fusionSlot2Spirit.parameters?.affection || 0;
                const minAffection = 50;
                
                if (affection1 < minAffection || affection2 < minAffection) {
                    info.innerHTML = `âŒ ë‘ ì •ë ¹ ëª¨ë‘ ì• ì •ë„ ${minAffection} ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.<br>(${fusionSlot1Spirit.name}: ${affection1}, ${fusionSlot2Spirit.name}: ${affection2})`;
                    info.style.color = '#e74c3c';
                    btn.disabled = true;
                    btn.style.opacity = '0.5';
                } else if (coins < FUSION_COST) {
                    info.innerHTML = `âŒ ì½”ì¸ì´ ë¶€ì¡±í•©ë‹ˆë‹¤. (í•„ìš”: ${FUSION_COST}ğŸ’°, ë³´ìœ : ${coins}ğŸ’°)`;
                    info.style.color = '#e74c3c';
                    btn.disabled = true;
                    btn.style.opacity = '0.5';
                } else {
                    info.innerHTML = `âœ… í•©ì„± ì¤€ë¹„ ì™„ë£Œ! ë‘ ì •ë ¹ì€ ìì—°ìœ¼ë¡œ ëŒì•„ê°€ê³  ìƒˆ ì•Œì´ íƒœì–´ë‚©ë‹ˆë‹¤.`;
                    info.style.color = '#27ae60';
                    btn.disabled = false;
                    btn.style.opacity = '1';
                }
            } else {
                result.innerHTML = `
                    <div style="font-size: 3rem; opacity: 0.3;">â“</div>
                    <div style="color: #888; font-size: 0.9rem;">ê²°ê³¼</div>
                `;
                result.style.background = 'linear-gradient(135deg, rgba(255,215,0,0.1), rgba(255,255,255,0.1))';
                info.innerHTML = 'ë‘ ì •ë ¹ì„ ì„ íƒí•´ì£¼ì„¸ìš”.';
                info.style.color = '#888';
                btn.disabled = true;
                btn.style.opacity = '0.5';
            }
        }
        
        function getMainAttribute(spirit) {
            const attrs = spirit.attributes || spirit.hiddenAttributes || {};
            let maxAttr = 'normal';
            let maxVal = 0;
            
            ['fire', 'water', 'wind', 'earth', 'light', 'dark'].forEach(attr => {
                if ((attrs[attr] || 0) > maxVal) {
                    maxVal = attrs[attr] || 0;
                    maxAttr = attr;
                }
            });
            
            return maxVal >= 50 ? maxAttr : 'normal';
        }
        
        function getStatType(spirit) {
            const params = spirit.parameters || {};
            const intel = params.intelligence || 0;
            const str = params.strength || 0;
            const charm = params.charm || 0;
            
            if (intel > str && intel > charm && intel >= 70) return 'intelligent';
            if (str > intel && str > charm && str >= 70) return 'strong';
            if (charm > intel && charm > str && charm >= 70) return 'beautiful';
            return null;
        }
        
        function predictFusionResult(spirit1, spirit2) {
            // íƒ€ì… ì¶”ë¡  í—¬í¼ í•¨ìˆ˜ (predictBreedResultì™€ ë™ì¼)
            const getSpiritTypeInfo = (spirit) => {
                const type = spirit.type || spirit.evolutionType || spirit.evolutionData?.type;
                const name = spirit.name || '';
                
                // ì •ë ¹ì™• ì²´í¬ (ìµœìƒìœ„)
                if (type === 'spiritking' || name === 'ì •ë ¹ì™•') return { special: 'spiritking' };
                
                // ì „ì„¤ ì •ë ¹ ì²´í¬
                if (type === 'titania' || name === 'í‹°íƒ€ë‹ˆì•„') return { special: 'titania' };
                if (type === 'oberon' || name === 'ì˜¤ë² ë¡ ') return { special: 'oberon' };
                
                // ì •ë ¹ì™•ì˜ ë¶€ë¦„ì„ ë°›ì€ (ëª¨ë“  ìŠ¤íƒ¯ 100) ì²´í¬
                if (type === 'sage' || name.includes('ì •ë ¹ì™•ì˜ ë¶€ë¦„ì„ ë°›ì€')) return { special: 'sage' };
                
                // ì¡°í™”/í˜¼ëˆ ì²´í¬
                if (type === 'balanced' || name.includes('ì¡°í™”ì˜ ì •ë ¹')) return { special: 'balanced' };
                if (type === 'multi' || name.includes('í˜¼ëˆì˜ ì •ë ¹')) return { special: 'multi' };
                
                // ìŠ¤íƒ¯ ê³„ì—´ ì²´í¬
                const params = spirit.parameters || {};
                const intel = params.intelligence || 0;
                const str = params.strength || 0;
                const charm = params.charm || 0;
                
                if (intel >= 100 && str >= 100 && charm >= 100) return { special: 'sage' };
                
                // ì´ë¦„ì—ì„œ ìŠ¤íƒ¯ ê³„ì—´ ì¶”ë¡  (ìƒˆ íƒ€ì´í‹€)
                if (name.includes('ì§€ì‹ì˜ ì”¨ì•—')) return { stat: 'intelligent' };
                if (name.includes('ë¶ˆêµ´ì˜ ê¸°ì‚¬')) return { stat: 'strong' };
                if (name.includes('ë‹¬ì½¤í•œ í–¥ê¸°')) return { stat: 'beautiful' };
                
                // ìŠ¤íƒ¯ ìˆ˜ì¹˜ ê¸°ë°˜ (100 ì´ìƒ)
                if (intel >= 100) return { stat: 'intelligent' };
                if (str >= 100) return { stat: 'strong' };
                if (charm >= 100) return { stat: 'beautiful' };
                
                // ì†ì„± ì²´í¬
                if (name.includes('í™”ì—¼') || name.includes('ë¶ˆê½ƒ')) return { attr: 'fire' };
                if (name.includes('ë¹™í•˜') || name.includes('ë¬¼')) return { attr: 'water' };
                if (name.includes('ì§ˆí’') || name.includes('ë°”ëŒ')) return { attr: 'wind' };
                if (name.includes('ëŒ€ì§€') || name.includes('ë•…')) return { attr: 'earth' };
                if (name.includes('ê´‘ëª…') || name.includes('ë¹›')) return { attr: 'light' };
                if (name.includes('ì•”í‘') || name.includes('ì–´ë‘ ')) return { attr: 'dark' };
                
                return {};
            };
            
            const info1 = getSpiritTypeInfo(spirit1);
            const info2 = getSpiritTypeInfo(spirit2);
            
            // 1. í‹°íƒ€ë‹ˆì•„ + ì˜¤ë² ë¡  = ì˜¤ë¸”ë¦¬ë¹„ì˜¨
            if ((info1.special === 'titania' && info2.special === 'oberon') ||
                (info1.special === 'oberon' && info2.special === 'titania')) {
                return { ...FUSION_TYPES['fusion-oblivion'], key: 'fusion-oblivion' };
            }
            
            // 2. ì¡°í™”/í˜¼ëˆ ì¡°í•© ì²´í¬
            if (info1.special === 'balanced' && info2.special === 'balanced') {
                return { ...FUSION_TYPES['fusion-spirit-king'], key: 'fusion-spirit-king' };
            }
            if (info1.special === 'multi' && info2.special === 'multi') {
                return { ...FUSION_TYPES['fusion-chaos-king'], key: 'fusion-chaos-king' };
            }
            if ((info1.special === 'balanced' && info2.special === 'multi') ||
                (info1.special === 'multi' && info2.special === 'balanced')) {
                return { ...FUSION_TYPES['fusion-balance-chaos'], key: 'fusion-balance-chaos' };
            }
            
            // 3. ì†ì„± ê¸°ë°˜ í•©ì„±
            const attr1 = info1.attr || getMainAttribute(spirit1);
            const attr2 = info2.attr || getMainAttribute(spirit2);
            
            // ì •í™•í•œ ë ˆì‹œí”¼ ë§¤ì¹­
            for (const [key, fusion] of Object.entries(FUSION_TYPES)) {
                const recipe = fusion.recipe;
                if ((recipe[0] === attr1 && recipe[1] === attr2) ||
                    (recipe[0] === attr2 && recipe[1] === attr1)) {
                    return { ...fusion, key };
                }
            }
            
            // 4. ê¸°ë³¸ ê²°ê³¼ - ë¶€ëª¨ ì¤‘ í•˜ë‚˜ì˜ ì†ì„± ëœë¤ ê³„ìŠ¹
            const inheritedAttr = Math.random() > 0.5 ? attr1 : attr2;
            const attrInfo = ATTRIBUTE_NAMES[inheritedAttr] || ATTRIBUTE_NAMES.normal;
            const attrIcon = typeof attrInfo.icon === 'object' ? attrInfo.icon.butterfly : attrInfo.icon;
            return {
                name: attrInfo.name,
                icon: attrIcon,
                desc: attrInfo.desc,
                rarity: 'common',
                inheritedAttr
            };
        }
        
        function getRarityColor(rarity) {
            switch(rarity) {
                case 'mythic': return '#ff00ff';
                case 'legendary': return '#ff6b35';
                case 'epic': return '#9b59b6';
                case 'rare': return '#3498db';
                case 'event': return '#c41e3a';
                default: return '#888';
            }
        }
        
        function getRarityText(rarity) {
            switch(rarity) {
                case 'mythic': return 'ğŸŒŒ ì‹ í™”';
                case 'legendary': return 'â­ ì „ì„¤';
                case 'epic': return 'ğŸ’œ ìµœìƒê¸‰';
                case 'rare': return 'ğŸ’™ í¬ê·€';
                case 'event': return 'ğŸ„ ì´ë²¤íŠ¸';
                default: return 'ì¼ë°˜';
            }
        }
        
        async function performFusion() {
            if (!fusionSlot1Spirit || !fusionSlot2Spirit) return;
            
            const affection1 = fusionSlot1Spirit.parameters?.affection || 0;
            const affection2 = fusionSlot2Spirit.parameters?.affection || 0;
            
            if (affection1 < 50 || affection2 < 50) {
                showNotification('âŒ ì• ì •ë„ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤');
                return;
            }
            
            if (coins < FUSION_COST) {
                showNotification('âŒ ì½”ì¸ì´ ë¶€ì¡±í•©ë‹ˆë‹¤');
                return;
            }
            
            const confirm = await showConfirm('ì •ë ¹ í•©ì„±', 
                `${fusionSlot1Spirit.name}ì™€(ê³¼) ${fusionSlot2Spirit.name}ì„(ë¥¼) í•©ì„±í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\në‘ ì •ë ¹ì€ ìì—°ìœ¼ë¡œ ëŒì•„ê°€ê³  ìƒˆ ì•Œì´ íƒœì–´ë‚©ë‹ˆë‹¤.\në¹„ìš©: ${FUSION_COST}ğŸ’°`);
            
            if (!confirm) return;
            
            // ê²°ê³¼ ê³„ì‚°
            const result = predictFusionResult(fusionSlot1Spirit, fusionSlot2Spirit);
            
            // ìŠ¤íƒ¯ ê³„ìŠ¹ (ë¶€ëª¨ í‰ê· ì˜ 50~80%)
            const inheritRatio = 0.5 + Math.random() * 0.3;
            const newParams = {
                intelligence: Math.floor(((fusionSlot1Spirit.parameters?.intelligence || 0) + (fusionSlot2Spirit.parameters?.intelligence || 0)) / 2 * inheritRatio),
                strength: Math.floor(((fusionSlot1Spirit.parameters?.strength || 0) + (fusionSlot2Spirit.parameters?.strength || 0)) / 2 * inheritRatio),
                charm: Math.floor(((fusionSlot1Spirit.parameters?.charm || 0) + (fusionSlot2Spirit.parameters?.charm || 0)) / 2 * inheritRatio),
                affection: 0
            };
            
            // ë¶€ëª¨ ì •ë ¹ ì œê±° (ì•¨ë²”ì— ì¶”ê°€)
            [fusionSlot1Spirit, fusionSlot2Spirit].forEach(parent => {
                // íƒ€ì… ê²°ì •: type > evolutionType > evolutionData.type > 'normal'
                const parentType = parent.type || parent.evolutionType || parent.evolutionData?.type || 'normal';
                
                // ì•¨ë²”ì— ì¶”ê°€
                collection.push({
                    id: `album-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`, // ê³ ìœ  ID
                    name: parent.name,
                    type: parentType,
                    attribute: parent.attribute,
                    attributeType: parent.attributeType,
                    parameters: { ...parent.parameters },
                    attributes: { ...parent.attributes },
                    wingType: parent.wingType || 'butterfly',
                    completedAt: new Date().toISOString(),
                    fusedAway: true // í•©ì„±ìœ¼ë¡œ ë– ë‚¨ í‘œì‹œ
                });
                
                // spiritsì—ì„œ ì œê±°
                const idx = spirits.findIndex(s => s.id === parent.id);
                if (idx !== -1) spirits.splice(idx, 1);
            });
            
            // ìƒˆ ì•Œ ìƒì„±
            const newAttribute = result.inheritedAttr || getMainAttribute(fusionSlot1Spirit);
            const isFusionType = result.key && FUSION_TYPES[result.key];
            const fusionEggName = `${fusionSlot1Spirit.name}ì™€${fusionSlot2Spirit.name}ì˜ ì•Œ`;
            
            const newSpirit = {
                id: Date.now().toString(),
                name: fusionEggName,
                stage: 'egg',
                growth: 0,
                parameters: newParams,
                attributes: {},
                createdAt: new Date().toISOString(),
                logs: [`ğŸ§¬ ${fusionSlot1Spirit.name}ì™€(ê³¼) ${fusionSlot2Spirit.name}ì˜ í•©ì„±ìœ¼ë¡œ íƒœì–´ë‚¬ìŠµë‹ˆë‹¤.`],
                fusionType: result.key || null, // í•©ì„± íƒ€ì… ì €ì¥
                fusionRarity: result.rarity || 'common'
            };
            
            // ì´ˆê¸° ì†ì„± ì„¤ì • (í•©ì„± íƒ€ì…ì´ë©´ íŠ¹ë³„ ì†ì„±)
            if (isFusionType) {
                // í•©ì„± ì „ìš© ì •ë ¹ì€ ë¶€ëª¨ ì†ì„± í•©
                const attrs1 = fusionSlot1Spirit.attributes || fusionSlot1Spirit.hiddenAttributes || {};
                const attrs2 = fusionSlot2Spirit.attributes || fusionSlot2Spirit.hiddenAttributes || {};
                ['fire', 'water', 'wind', 'earth', 'light', 'dark'].forEach(attr => {
                    newSpirit.attributes[attr] = Math.floor(((attrs1[attr] || 0) + (attrs2[attr] || 0)) / 2);
                });
            }
            
            spirits.push(newSpirit);
            coins -= FUSION_COST;
            
            // í•©ì„± ë„ê° ë“±ë¡
            if (isFusionType && result.key) {
                if (!encyclopedia[result.key]) {
                    encyclopedia[result.key] = 1;
                    showNotification(`ğŸ‰ ìƒˆë¡œìš´ í•©ì„± ì •ë ¹ "${result.name}" ë„ê° ë“±ë¡!`);
                } else {
                    encyclopedia[result.key]++;
                }
            }
            
            // ì´ˆê¸°í™”
            fusionSlot1Spirit = null;
            fusionSlot2Spirit = null;
            
            saveGame();
            updateFusionSlots();
            renderSpirits();
            renderFusionEncyclopedia();
            updateCoinDisplay();
            
            showNotification(`ğŸ§¬ í•©ì„± ì„±ê³µ! ${result.name}ì˜ ì•Œì´ íƒœì–´ë‚¬ìŠµë‹ˆë‹¤!`);
        }
        
        function renderFusionEncyclopedia() {
            const container = document.getElementById('fusionEncyclopedia');
            if (!container) return;
            
            const entries = Object.entries(FUSION_TYPES).map(([key, data]) => {
                const rawValue = encyclopedia[key];
                const discovered = rawValue ? true : false;
                const count = typeof rawValue === 'object' ? (rawValue.count || 0) : (rawValue || 0);
                return `
                    <div style="padding: 12px; background: ${discovered ? 'var(--bg)' : 'rgba(0,0,0,0.3)'}; border: 1px solid ${discovered ? getRarityColor(data.rarity) : 'var(--border)'}; border-radius: 8px; text-align: center;">
                        <div style="font-size: 2rem; ${discovered ? '' : 'filter: grayscale(1); opacity: 0.3;'}">${data.icon}</div>
                        <div style="font-weight: 700; font-size: 0.85rem; margin-top: 4px; ${discovered ? '' : 'color: #666;'}">${discovered ? data.name : '???'}</div>
                        <div style="font-size: 0.75rem; color: ${getRarityColor(data.rarity)};">${getRarityText(data.rarity)}</div>
                        ${discovered ? `<div style="font-size: 0.7rem; color: #888; margin-top: 4px;">x${count}</div>` : ''}
                    </div>
                `;
            });
            
            container.innerHTML = entries.join('');
        }
        
        // ========== ì—°ê²° ì½”ë“œ ê³µìœ  ì‹œìŠ¤í…œ ==========
        
        function updateShareSpiritList() {
            const select1 = document.getElementById('shareSpritSelect');
            const select2 = document.getElementById('myBreedSpirit');
            const completed = getCompletedSpiritsForBreeding();
            
            const options = completed.map(s => {
                const attr = ATTRIBUTE_NAMES[s.attribute] || ATTRIBUTE_NAMES.normal;
                const affection = s.parameters?.affection || 0;
                const fromAlbum = s.isFromAlbum ? ' [ì•¨ë²”]' : '';
                const affectionMark = affection >= 50 ? 'ğŸ’•' : 'ğŸ’”';
                return `<option value="${s.id}">${s.name} (${attr.icon} ${affectionMark}${affection})${fromAlbum}</option>`;
            }).join('');
            
            if (select1) select1.innerHTML = '<option value="">ì™„ì„±ëœ ì •ë ¹ ì„ íƒ...</option>' + options;
            if (select2) select2.innerHTML = '<option value="">ë‚´ ì •ë ¹ ì„ íƒ...</option>' + options;
        }
        
        function encodeSpiritData(spirit) {
            // íƒ€ì… ê²°ì •: type > evolutionType > evolutionData.type > 'normal'
            const spiritType = spirit.type || spirit.evolutionType || spirit.evolutionData?.type || 'normal';
            // ì†ì„± ê²°ì •: attributeType > attribute > typeì—ì„œ ì¶”ì¶œ
            const spiritAttr = spirit.attributeType || spirit.attribute || (() => {
                const attrs = ['fire', 'water', 'wind', 'earth', 'light', 'dark'];
                for (const attr of attrs) {
                    if (spiritType.includes(attr)) return attr;
                }
                return 'normal';
            })();
            
            // í‚¤ì›Œë“œ ìˆ˜ì§‘
            const allKeywords = spirit.allStatusKeywords || spirit.statusKeywords || [];
            
            const data = {
                id: spirit.id || null, // ê³ ìœ  ID ì¶”ê°€
                n: spirit.name,
                o: spirit.originalName || spirit.name, // ë³¸ëª… ì¶”ê°€
                a: spiritAttr, // ì†ì„±
                t: spiritType, // íƒ€ì…
                i: spirit.parameters?.intelligence || 0,
                s: spirit.parameters?.strength || 0,
                c: spirit.parameters?.charm || 0,
                at: spirit.attributes || spirit.hiddenAttributes || {},
                ts: Date.now(),
                // ì´ë²¤íŠ¸ ì •ë ¹ ì •ë³´
                ev: spirit.isEventSpirit ? spirit.eventType : null,
                // í‚¤ì›Œë“œ ì •ë³´
                kw: allKeywords.length > 0 ? allKeywords : null
            };
            
            console.log('ì—°ê²° ì½”ë“œ ìƒì„±:', { spiritType, spiritAttr, spirit: spirit.name }); // ë””ë²„ê¹…ìš©
            
            try {
                const json = JSON.stringify(data);
                const base64 = btoa(unescape(encodeURIComponent(json)));
                return 'SG1-' + base64;
            } catch (e) {
                console.error('ì¸ì½”ë”© ì˜¤ë¥˜:', e);
                return null;
            }
        }
        
        function decodeSpiritData(code) {
            try {
                if (!code.startsWith('SG1-')) return null;
                const base64 = code.substring(4);
                const json = decodeURIComponent(escape(atob(base64)));
                const data = JSON.parse(json);
                
                // ìœ íš¨ì„± ê²€ì‚¬
                if (!data.n || !data.ts) return null;
                
                return {
                    id: data.id || null, // ê³ ìœ  ID ì¶”ê°€
                    name: data.n,
                    originalName: data.o || data.n, // ë³¸ëª… ì¶”ê°€
                    attribute: data.a || 'normal',
                    attributeType: data.a || 'normal', // attributeTypeë„ ì¶”ê°€
                    type: data.t || 'normal', // typeë„ ì¶”ê°€
                    evolutionType: data.t || 'normal',
                    parameters: {
                        intelligence: data.i || 0,
                        strength: data.s || 0,
                        charm: data.c || 0
                    },
                    attributes: data.at || {},
                    // ì´ë²¤íŠ¸ ì •ë ¹ ì •ë³´
                    isEventSpirit: !!data.ev,
                    eventType: data.ev || null,
                    // í‚¤ì›Œë“œ ì •ë³´
                    keywords: data.kw || []
                };
            } catch (e) {
                console.error('ë””ì½”ë”© ì˜¤ë¥˜:', e);
                return null;
            }
        }
        
        function updateShareCode() {
            const select = document.getElementById('shareSpritSelect');
            const display = document.getElementById('shareCodeDisplay');
            const input = document.getElementById('shareCodeInput');
            
            if (!select.value) {
                display.style.display = 'none';
                return;
            }
            
            // í˜„ì¬ ì •ë ¹ ë˜ëŠ” ì•¨ë²”ì—ì„œ ì°¾ê¸°
            const allCompleted = getCompletedSpiritsForBreeding();
            const spirit = allCompleted.find(s => s.id === select.value);
            if (!spirit) return;
            
            const code = encodeSpiritData(spirit);
            if (code) {
                input.value = code;
                display.style.display = 'flex';
            }
        }
        
        function copyShareCode() {
            const input = document.getElementById('shareCodeInput');
            input.select();
            document.execCommand('copy');
            showNotification('ğŸ“‹ ì½”ë“œê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!');
        }
        
        // ì¹œêµ¬ ì½”ë“œ ì…ë ¥ ì‹œ ë¯¸ë¦¬ë³´ê¸°
        document.addEventListener('DOMContentLoaded', () => {
            const friendInput = document.getElementById('friendCodeInput');
            if (friendInput) {
                friendInput.addEventListener('input', () => {
                    const preview = document.getElementById('friendCodePreview');
                    const code = friendInput.value.trim();
                    
                    if (!code) {
                        preview.style.display = 'none';
                        updateBreedPreview();
                        return;
                    }
                    
                    const data = decodeSpiritData(code);
                    if (!data) {
                        preview.innerHTML = 'âŒ ìœ íš¨í•˜ì§€ ì•Šì€ ì½”ë“œì…ë‹ˆë‹¤.';
                        preview.style.display = 'block';
                        preview.style.color = '#e74c3c';
                        document.getElementById('breedPreview').style.display = 'none';
                    } else {
                        const attr = ATTRIBUTE_NAMES[data.attribute] || ATTRIBUTE_NAMES.normal;
                        
                        // ì†ì„±ì¹˜ í‘œì‹œ
                        const friendAttrs = data.attributes || {};
                        const attrDisplay = [];
                        ['fire', 'water', 'wind', 'earth', 'light', 'dark'].forEach(a => {
                            if (friendAttrs[a] && friendAttrs[a] > 0) {
                                attrDisplay.push(`${ENV_ICONS[a]}${friendAttrs[a]}`);
                            }
                        });
                        
                        // ë³¸ëª…ì´ í˜„ì¬ ì´ë¦„ê³¼ ë‹¤ë¥´ë©´ í‘œì‹œ
                        const originalNameDisplay = (data.originalName && data.originalName !== data.name) 
                            ? `<div style="color: #aaa; font-size: 0.8rem; font-style: italic;">ë³¸ëª…: ${data.originalName}</div>` 
                            : '';
                        
                        preview.innerHTML = `
                            <div style="display: flex; align-items: center; gap: 12px;">
                                <div style="font-size: 2.5rem;">${attr.icon}</div>
                                <div style="flex: 1;">
                                    <div style="font-weight: 700; font-size: 1.1rem;">âœ… ${data.name}</div>
                                    ${originalNameDisplay}
                                    <div style="color: #888; font-size: 0.85rem;">${attr.name}</div>
                                    <div style="margin-top: 6px; font-size: 0.9rem;">
                                        ğŸ§  ${data.parameters.intelligence} | ğŸ’ª ${data.parameters.strength} | ğŸ’– ${data.parameters.charm}
                                    </div>
                                    ${attrDisplay.length > 0 ? `<div style="margin-top: 4px; font-size: 0.85rem;">${attrDisplay.join(' ')}</div>` : ''}
                                </div>
                            </div>
                        `;
                        preview.style.display = 'block';
                        preview.style.color = 'var(--text)';
                        updateBreedPreview();
                    }
                });
            }
        });
        
        async function breedWithCode() {
            const mySelect = document.getElementById('myBreedSpirit');
            const codeInput = document.getElementById('friendCodeInput');
            const breedCode = codeInput.value.trim();
            
            if (!mySelect.value) {
                showNotification('âŒ ë‚´ ì •ë ¹ì„ ì„ íƒí•´ì£¼ì„¸ìš”');
                return;
            }
            
            // ì •ë ¹ ìŠ¬ë¡¯ ì²´í¬ (ìµœëŒ€ 6ë§ˆë¦¬)
            if (spirits.length >= 6) {
                showNotification('âŒ ì •ì›ì´ ê°€ë“ ì°¼ìŠµë‹ˆë‹¤! (ìµœëŒ€ 6ë§ˆë¦¬) ì •ë ¹ì„ ìì—°ìœ¼ë¡œ ë³´ë‚´ì£¼ì„¸ìš”.');
                return;
            }
            
            // ì¤‘ë³µ ì½”ë“œ ì²´í¬ (ì´ë¯¸ ì‚¬ìš©ëœ ì½”ë“œì¸ì§€)
            const allSpiritsAndAlbum = [...spirits, ...(collection || [])];
            const usedCode = allSpiritsAndAlbum.find(s => s.breedCode === breedCode);
            if (usedCode) {
                showNotification('âŒ ì´ë¯¸ ì‚¬ìš©ëœ ì—°ê²° ì½”ë“œì…ë‹ˆë‹¤!');
                return;
            }
            
            // í˜„ì¬ ì •ë ¹ ë˜ëŠ” ì•¨ë²”ì—ì„œ ì°¾ê¸°
            const allCompleted = getCompletedSpiritsForBreeding();
            const mySpirit = allCompleted.find(s => s.id === mySelect.value);
            if (!mySpirit) {
                showNotification('âŒ ì •ë ¹ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
                return;
            }
            
            const friendData = decodeSpiritData(breedCode);
            if (!friendData) {
                showNotification('âŒ ìœ íš¨í•˜ì§€ ì•Šì€ ì½”ë“œì…ë‹ˆë‹¤');
                return;
            }
            
            // ì• ì •ë„ ì²´í¬
            const myAffection = mySpirit.parameters?.affection || 0;
            if (myAffection < 50) {
                showNotification(`âŒ ë‚´ ì •ë ¹ì˜ ì• ì •ë„ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤ (í˜„ì¬: ${myAffection}, í•„ìš”: 50)`);
                return;
            }
            
            if (coins < BREED_COST) {
                showNotification(`âŒ ì½”ì¸ì´ ë¶€ì¡±í•©ë‹ˆë‹¤ (í•„ìš”: ${BREED_COST}ğŸ’°)`);
                return;
            }
            
            // ê²°ê³¼ ì˜ˆì¸¡
            const prediction = predictBreedResult(mySpirit, friendData);
            
            // ë¯¸ë°œê²¬ ì •ë ¹ ì²´í¬
            let isDiscovered = false;
            let displayName = prediction.name;
            if (prediction.key) {
                isDiscovered = encyclopedia[prediction.key] && encyclopedia[prediction.key] > 0;
            } else if (prediction.isEventResult && prediction.eventType) {
                const eventKeys = [`event_${prediction.eventType}`, `event_${prediction.eventType}_butterfly`, `event_${prediction.eventType}_moth`];
                isDiscovered = eventKeys.some(key => encyclopedia[key] && encyclopedia[key] > 0);
            }
            if (!isDiscovered && prediction.key) {
                displayName = '??? (ë¯¸ë°œê²¬)';
            }
            
            const confirm = await showConfirm('ì—°ê²° í™•ì¸',
                `${mySpirit.name}ì™€(ê³¼) ${friendData.name}(ì¹œêµ¬ ì •ë ¹)ì„(ë¥¼) ì—°ê²°í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nì˜ˆìƒ ê²°ê³¼: ${displayName} (${getRarityText(prediction.rarity)})\në‚´ ì •ë ¹ì€ ìœ ì§€ë˜ê³  ìƒˆ ì•Œì´ íƒœì–´ë‚©ë‹ˆë‹¤.\në¹„ìš©: ${BREED_COST}ğŸ’°`);
            
            if (!confirm) return;
            
            // ì—°ê²° ê²°ê³¼ ê³„ì‚° (ë¶€ëª¨ ìŠ¤íƒ¯ì˜ 25%ì”© = ì´ 50% ìƒì†)
            const newParams = {
                intelligence: Math.floor(((mySpirit.parameters?.intelligence || 0) + (friendData.parameters?.intelligence || 0)) / 4),
                strength: Math.floor(((mySpirit.parameters?.strength || 0) + (friendData.parameters?.strength || 0)) / 4),
                charm: Math.floor(((mySpirit.parameters?.charm || 0) + (friendData.parameters?.charm || 0)) / 4),
                affection: 0
            };
            
            // ë¶€ëª¨ ì†ì„±ì˜ 25%ì”© = ì´ 50% ìƒì†
            const myAttrs = mySpirit.attributes || mySpirit.hiddenAttributes || {};
            const friendAttrs = friendData.attributes || {};
            const newAttrs = {};
            ['fire', 'water', 'wind', 'earth', 'light', 'dark'].forEach(attr => {
                const avg = Math.floor(((myAttrs[attr] || 0) + (friendAttrs[attr] || 0)) / 4);
                if (avg > 0) newAttrs[attr] = avg;
            });
            
            // í•©ì„± íƒ€ì… ì •ë ¹ì¸ì§€ í™•ì¸
            const isFusionType = prediction.key && FUSION_TYPES[prediction.key];
            
            // ìƒì† ì •ë³´ ë¬¸ìì—´ ìƒì„±
            const inheritInfo = [];
            if (newParams.intelligence > 0) inheritInfo.push(`ğŸ§ ${newParams.intelligence}`);
            if (newParams.strength > 0) inheritInfo.push(`ğŸ’ª${newParams.strength}`);
            if (newParams.charm > 0) inheritInfo.push(`ğŸ’–${newParams.charm}`);
            const attrInfo = Object.entries(newAttrs).map(([k, v]) => `${ENV_ICONS[k]}${v}`).join(' ');
            
            // ë¡œê·¸ ì‹œê°„ í¬ë§·
            const timestamp = new Date().toLocaleString('ko-KR', {
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            });
            
            // ìƒˆ ì•Œ ìƒì„± (createNewSpiritê³¼ ë™ì¼í•œ êµ¬ì¡°)
            const breedEggName = `${mySpirit.name}ì™€${friendData.name}ì˜ ì•Œ`;
            const newSpirit = {
                id: Date.now(),
                name: breedEggName,
                originalName: null,
                growth: 0,
                // ê³µê°œ ìŠ¤íƒ¯ (ë¶€ëª¨ì—ê²Œì„œ ìƒì†)
                parameters: newParams,
                // ìˆ¨ê²¨ì§„ ì†ì„± (ë¶€ëª¨ì—ê²Œì„œ ìƒì†)
                hiddenAttributes: {
                    fire: newAttrs.fire || 0,
                    water: newAttrs.water || 0,
                    wind: newAttrs.wind || 0,
                    earth: newAttrs.earth || 0,
                    light: newAttrs.light || 0,
                    dark: newAttrs.dark || 0
                },
                satisfaction: 'mid',
                lastFed: null,
                lastMusic: null,
                lastPat: null,
                lastDecorate: null,
                lastInteraction: Date.now(),
                status: 'ì•Œì´ ë”°ëœ»í•©ë‹ˆë‹¤...',
                birthTime: Date.now(),
                logs: [
                    { time: timestamp, message: `ğŸ”— ${mySpirit.name}ì™€(ê³¼) ${friendData.name}ì˜ ì—°ê²°ë¡œ íƒœì–´ë‚¬ìŠµë‹ˆë‹¤.` },
                    { time: timestamp, message: `ğŸ“Š ë¶€ëª¨ì—ê²Œì„œ ë¬¼ë ¤ë°›ì€ ëŠ¥ë ¥: ${inheritInfo.join(' ')} ${attrInfo}` }
                ],
                lightTime: 0,
                darkTime: 0,
                musicListened: 0,
                feedCount: 0,
                // ì—°ê²° ê´€ë ¨ ì •ë³´
                bredWith: friendData.name,
                breedCode: breedCode,
                fusionType: prediction.key || null,
                fusionRarity: prediction.rarity || 'common',
                isBred: true
            };
            
            spirits.push(newSpirit);
            coins -= BREED_COST;
            
            console.log('ğŸ¥š ìƒˆ ì•Œ ìƒì„±ë¨:', newSpirit);
            console.log('ğŸ“‹ í˜„ì¬ spirits:', spirits);
            
            // í•©ì„± ë„ê° ë“±ë¡
            if (isFusionType && prediction.key) {
                if (!encyclopedia[prediction.key]) {
                    encyclopedia[prediction.key] = 1;
                    showNotification(`ğŸ‰ ìƒˆë¡œìš´ ì—°ê²° ì •ë ¹ "${prediction.name}" ë„ê° ë“±ë¡!`);
                } else {
                    encyclopedia[prediction.key]++;
                }
            }
            
            saveGame();
            renderSpirits();
            updateCoinDisplay();
            renderFusionEncyclopedia();
            
            showNotification(`ğŸ‰ ì—°ê²° ì„±ê³µ! ${isFusionType ? prediction.name : newSpirit.name}ì´(ê°€) íƒœì–´ë‚¬ìŠµë‹ˆë‹¤!`);
            
            // ì…ë ¥ ì´ˆê¸°í™”
            codeInput.value = '';
            mySelect.value = '';
            document.getElementById('friendCodePreview').style.display = 'none';
            document.getElementById('breedPreview').style.display = 'none';
            
            // ì •ì› íƒ­ìœ¼ë¡œ ì´ë™í•´ì„œ ìƒˆ ì•Œ ë³´ì—¬ì£¼ê¸°
            switchTab('garden');
        }
        
        function predictBreedResult(mySpirit, friendData) {
            // íƒ€ì… ì¶”ë¡  í—¬í¼ í•¨ìˆ˜ (type í•„ë“œ + ì´ë¦„ ê¸°ë°˜)
            const getSpiritTypeInfo = (spirit) => {
                const type = spirit.type || spirit.evolutionType || spirit.evolutionData?.type;
                const name = spirit.name || '';
                
                // ì •ë ¹ì™• ì²´í¬ (ìµœìƒìœ„)
                if (type === 'spiritking' || name === 'ì •ë ¹ì™•') return { special: 'spiritking' };
                
                // ì „ì„¤ ì •ë ¹ ì²´í¬
                if (type === 'titania' || name === 'í‹°íƒ€ë‹ˆì•„') return { special: 'titania' };
                if (type === 'oberon' || name === 'ì˜¤ë² ë¡ ') return { special: 'oberon' };
                
                // ì •ë ¹ì™•ì˜ ë¶€ë¦„ì„ ë°›ì€ (ëª¨ë“  ìŠ¤íƒ¯ 100) ì²´í¬
                if (type === 'sage' || name.includes('ì •ë ¹ì™•ì˜ ë¶€ë¦„ì„ ë°›ì€')) return { special: 'sage' };
                
                // ì¡°í™”/í˜¼ëˆ ì²´í¬
                if (type === 'balanced' || name.includes('ì¡°í™”ì˜ ì •ë ¹')) return { special: 'balanced' };
                if (type === 'multi' || name.includes('í˜¼ëˆì˜ ì •ë ¹')) return { special: 'multi' };
                
                // ìŠ¤íƒ¯ ê³„ì—´ ì²´í¬
                const params = spirit.parameters || {};
                const intel = params.intelligence || 0;
                const str = params.strength || 0;
                const charm = params.charm || 0;
                
                // ìŠ¤íƒ¯ì´ 100 ì´ìƒì´ë©´ í™•ì‹¤íˆ í•´ë‹¹ ê³„ì—´
                if (intel >= 100 && str >= 100 && charm >= 100) return { special: 'sage' };
                
                // ì´ë¦„ì—ì„œ ìŠ¤íƒ¯ ê³„ì—´ ì¶”ë¡  (ìƒˆ íƒ€ì´í‹€)
                if (name.includes('ì§€ì‹ì˜ ì”¨ì•—')) return { stat: 'intelligent' };
                if (name.includes('ë¶ˆêµ´ì˜ ê¸°ì‚¬')) return { stat: 'strong' };
                if (name.includes('ë‹¬ì½¤í•œ í–¥ê¸°')) return { stat: 'beautiful' };
                
                // ìŠ¤íƒ¯ ìˆ˜ì¹˜ ê¸°ë°˜ (100 ì´ìƒ)
                if (intel >= 100) return { stat: 'intelligent' };
                if (str >= 100) return { stat: 'strong' };
                if (charm >= 100) return { stat: 'beautiful' };
                
                // ì†ì„± ì²´í¬ (ì´ë¦„ ê¸°ë°˜)
                if (name.includes('í™”ì—¼') || name.includes('ë¶ˆê½ƒ')) return { attr: 'fire' };
                if (name.includes('ë¹™í•˜') || name.includes('ë¬¼')) return { attr: 'water' };
                if (name.includes('ì§ˆí’') || name.includes('ë°”ëŒ')) return { attr: 'wind' };
                if (name.includes('ëŒ€ì§€') || name.includes('ë•…')) return { attr: 'earth' };
                if (name.includes('ê´‘ëª…') || name.includes('ë¹›')) return { attr: 'light' };
                if (name.includes('ì•”í‘') || name.includes('ì–´ë‘ ')) return { attr: 'dark' };
                
                return {};
            };
            
            const myInfo = getSpiritTypeInfo(mySpirit);
            const friendInfo = getSpiritTypeInfo(friendData);
            
            console.log('ì—°ê²° íƒ€ì… ì²´í¬:', { 
                myName: mySpirit.name, 
                friendName: friendData.name,
                myInfo, 
                friendInfo 
            });
            
            // 1. í‹°íƒ€ë‹ˆì•„ + ì˜¤ë² ë¡  = ì˜¤ë¸”ë¦¬ë¹„ì˜¨
            if ((myInfo.special === 'titania' && friendInfo.special === 'oberon') ||
                (myInfo.special === 'oberon' && friendInfo.special === 'titania')) {
                return { ...FUSION_TYPES['fusion-oblivion'], key: 'fusion-oblivion' };
            }
            
            // 2. ì¡°í™”/í˜¼ëˆ ì¡°í•© ì²´í¬
            if (myInfo.special === 'balanced' && friendInfo.special === 'balanced') {
                return { ...FUSION_TYPES['fusion-spirit-king'], key: 'fusion-spirit-king' };
            }
            if (myInfo.special === 'multi' && friendInfo.special === 'multi') {
                return { ...FUSION_TYPES['fusion-chaos-king'], key: 'fusion-chaos-king' };
            }
            if ((myInfo.special === 'balanced' && friendInfo.special === 'multi') ||
                (myInfo.special === 'multi' && friendInfo.special === 'balanced')) {
                return { ...FUSION_TYPES['fusion-balance-chaos'], key: 'fusion-balance-chaos' };
            }
            
            // 3. ì´ë²¤íŠ¸ ì •ë ¹ ì—°ê²°
            const myEventType = mySpirit.isEventSpirit ? mySpirit.eventType : null;
            const friendEventType = friendData.isEventSpirit ? friendData.eventType : null;
            
            if (myEventType || friendEventType) {
                const eventType = myEventType || friendEventType;
                const event = EVENT_TYPES[eventType];
                if (event) {
                    return {
                        name: event.name,
                        icon: event.stages.egg,
                        desc: event.desc,
                        rarity: 'event',
                        isEventResult: true,
                        eventType: eventType
                    };
                }
            }
            
            // 4. ì†ì„± ê¸°ë°˜ í•©ì„±
            // ì†ì„± ê°ì§€ ê°•í™” - attributeType, typeì—ì„œë„ ì¶”ì¶œ
            const extractAttrFromType = (typeStr) => {
                if (!typeStr) return null;
                // nostat-fire-butterfly, intelligent-water-moth ë“±ì—ì„œ ì†ì„± ì¶”ì¶œ
                const attrs = ['fire', 'water', 'wind', 'earth', 'light', 'dark'];
                for (const attr of attrs) {
                    if (typeStr.includes(attr)) return attr;
                }
                return null;
            };
            
            // ì†ì„± ê°ì§€ í•¨ìˆ˜ - ì—¬ëŸ¬ ì†ŒìŠ¤ì—ì„œ í™•ì‹¤í•œ ì†ì„± ì°¾ê¸°
            const detectAttribute = (spirit) => {
                // 1. attributeType ì§ì ‘ ì‚¬ìš© (ê°€ì¥ í™•ì‹¤)
                if (spirit.attributeType && spirit.attributeType !== 'normal') {
                    const validAttrs = ['fire', 'water', 'wind', 'earth', 'light', 'dark'];
                    if (validAttrs.includes(spirit.attributeType)) {
                        return spirit.attributeType;
                    }
                }
                
                // 2. type ë¬¸ìì—´ì—ì„œ ì¶”ì¶œ
                const typeAttr = extractAttrFromType(spirit.type);
                if (typeAttr) return typeAttr;
                
                // 3. attribute í•„ë“œ (ë””ì½”ë”©ëœ ë°ì´í„°ìš©)
                if (spirit.attribute && spirit.attribute !== 'normal') {
                    const validAttrs = ['fire', 'water', 'wind', 'earth', 'light', 'dark'];
                    if (validAttrs.includes(spirit.attribute)) {
                        return spirit.attribute;
                    }
                }
                
                // 4. hiddenAttributesì—ì„œ ì¶”ì¶œ
                const attrs = spirit.attributes || spirit.hiddenAttributes || {};
                let maxAttr = null;
                let maxVal = 0;
                ['fire', 'water', 'wind', 'earth', 'light', 'dark'].forEach(attr => {
                    if ((attrs[attr] || 0) > maxVal) {
                        maxVal = attrs[attr] || 0;
                        maxAttr = attr;
                    }
                });
                if (maxVal >= 30) return maxAttr; // 30 ì´ìƒì´ë©´ í•´ë‹¹ ì†ì„±ìœ¼ë¡œ ì¸ì • (ê¸°ì¡´ 50ì—ì„œ ì™„í™”)
                
                // 5. ì´ë¦„ ê¸°ë°˜ ì¶”ì¶œ
                const name = spirit.name || '';
                if (name.includes('í™”ì—¼') || name.includes('ë¶ˆê½ƒ')) return 'fire';
                if (name.includes('ë¹™í•˜') || name.includes('ë¬¼')) return 'water';
                if (name.includes('ì§ˆí’') || name.includes('ë°”ëŒ')) return 'wind';
                if (name.includes('ëŒ€ì§€') || name.includes('ë•…')) return 'earth';
                if (name.includes('ê´‘ëª…') || name.includes('ë¹›')) return 'light';
                if (name.includes('ì•”í‘') || name.includes('ì–´ë‘ ')) return 'dark';
                
                return 'normal';
            };
            
            let myAttr = myInfo.attr || detectAttribute(mySpirit);
            let friendAttr = friendInfo.attr || detectAttribute(friendData);
            
            console.log('ì†ì„± ë§¤ì¹­:', { 
                myAttr, 
                friendAttr,
                mySpirit: { type: mySpirit.type, attributeType: mySpirit.attributeType, name: mySpirit.name },
                friendData: { type: friendData.type, attributeType: friendData.attributeType, attribute: friendData.attribute, name: friendData.name }
            });
            
            // ì •í™•í•œ ë ˆì‹œí”¼ ë§¤ì¹­
            for (const [key, fusion] of Object.entries(FUSION_TYPES)) {
                const recipe = fusion.recipe;
                if ((recipe[0] === myAttr && recipe[1] === friendAttr) ||
                    (recipe[0] === friendAttr && recipe[1] === myAttr)) {
                    return { ...fusion, key };
                }
            }
            
            // 5. FUSION_TYPESì— ì—†ëŠ” ì¡°í•© - ì—°ê²° ë¶ˆê°€ í‘œì‹œ
            return {
                name: 'ì—°ê²° ë¶ˆê°€',
                icon: 'âŒ',
                desc: `${myAttr}ì™€ ${friendAttr} ì†ì„±ì€ ì•„ì§ ì—°ê²°í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`,
                rarity: 'invalid',
                cannotBreed: true,
                myAttr,
                friendAttr
            };
        }
        
        // friendDataì—ì„œ ì†ì„± ì¶”ì¶œ (ì½”ë“œì—ì„œ ë””ì½”ë”©ëœ ë°ì´í„°ìš©)
        function getMainAttributeFromData(data) {
            const attrs = data.attributes || {};
            let maxAttr = 'normal';
            let maxVal = 0;
            
            ['fire', 'water', 'wind', 'earth', 'light', 'dark'].forEach(attr => {
                if ((attrs[attr] || 0) > maxVal) {
                    maxVal = attrs[attr] || 0;
                    maxAttr = attr;
                }
            });
            
            return maxVal >= 50 ? maxAttr : (data.attribute || 'normal');
        }
        
        function getStatTypeFromData(data) {
            const params = data.parameters || {};
            const intel = params.intelligence || 0;
            const str = params.strength || 0;
            const charm = params.charm || 0;
            
            if (intel > str && intel > charm && intel >= 70) return 'intelligent';
            if (str > intel && str > charm && str >= 70) return 'strong';
            if (charm > intel && charm > str && charm >= 70) return 'beautiful';
            return null;
        }
        
        function updateBreedPreview() {
            const mySelect = document.getElementById('myBreedSpirit');
            const codeInput = document.getElementById('friendCodeInput');
            const preview = document.getElementById('breedPreview');
            
            if (!mySelect.value || !codeInput.value.trim()) {
                preview.style.display = 'none';
                return;
            }
            
            // í˜„ì¬ ì •ë ¹ ë˜ëŠ” ì•¨ë²”ì—ì„œ ì°¾ê¸°
            const allCompleted = getCompletedSpiritsForBreeding();
            const mySpirit = allCompleted.find(s => s.id === mySelect.value);
            const friendData = decodeSpiritData(codeInput.value.trim());
            
            if (!mySpirit || !friendData) {
                preview.style.display = 'none';
                return;
            }
            
            const prediction = predictBreedResult(mySpirit, friendData);
            
            // ì˜ˆìƒ ìƒì† ìŠ¤íƒ¯ ê³„ì‚°
            const inheritParams = {
                intelligence: Math.floor(((mySpirit.parameters?.intelligence || 0) + (friendData.parameters?.intelligence || 0)) / 2),
                strength: Math.floor(((mySpirit.parameters?.strength || 0) + (friendData.parameters?.strength || 0)) / 2),
                charm: Math.floor(((mySpirit.parameters?.charm || 0) + (friendData.parameters?.charm || 0)) / 2)
            };
            
            // ì˜ˆìƒ ìƒì† ì†ì„± ê³„ì‚°
            const myAttrs = mySpirit.attributes || mySpirit.hiddenAttributes || {};
            const friendAttrs = friendData.attributes || {};
            const inheritAttrs = [];
            ['fire', 'water', 'wind', 'earth', 'light', 'dark'].forEach(attr => {
                const avg = Math.floor(((myAttrs[attr] || 0) + (friendAttrs[attr] || 0)) / 2);
                if (avg > 0) inheritAttrs.push(`${ENV_ICONS[attr]}${avg}`);
            });
            
            // ì•„ì´ì½˜ ì²˜ë¦¬ (ê°ì²´ë©´ ë‚˜ë¹„ ì•„ì´ì½˜ ì‚¬ìš©)
            let displayIcon = prediction.icon;
            if (typeof displayIcon === 'object' && displayIcon !== null) {
                displayIcon = displayIcon.butterfly || 'ğŸ¥š';
            }
            // ì´ë¯¸ì§€ íƒœê·¸ë©´ ì´ëª¨ì§€ë¡œ ëŒ€ì²´
            if (typeof displayIcon === 'string' && displayIcon.includes('<img')) {
                displayIcon = 'ğŸ¥š';
            }
            
            // ë¯¸ë°œê²¬ ì •ë ¹ ì²´í¬ (ë„ê°ì— ì—†ìœ¼ë©´ ë¯¸ë°œê²¬)
            let isDiscovered = false;
            let displayName = prediction.name;
            if (prediction.key) {
                // fusion ì •ë ¹
                isDiscovered = encyclopedia[prediction.key] && encyclopedia[prediction.key] > 0;
            } else if (prediction.isEventResult && prediction.eventType) {
                // ì´ë²¤íŠ¸ ì •ë ¹
                const eventKeys = [`event_${prediction.eventType}`, `event_${prediction.eventType}_butterfly`, `event_${prediction.eventType}_moth`];
                isDiscovered = eventKeys.some(key => encyclopedia[key] && encyclopedia[key] > 0);
            }
            
            if (!isDiscovered && prediction.key) {
                displayName = '???';
                displayIcon = 'â“';
            }
            
            preview.innerHTML = `
                <div style="font-size: 0.85rem; color: #888; margin-bottom: 8px;">ğŸ¥š ì˜ˆìƒ ê²°ê³¼</div>
                <div style="font-size: 2rem;">${displayIcon}</div>
                <div style="font-weight: 700; margin: 4px 0;">${displayName}${!isDiscovered && prediction.key ? ' <span style="font-size: 0.75rem; color: #e67e22;">(ë¯¸ë°œê²¬)</span>' : ''}</div>
                <div style="font-size: 0.8rem; color: ${getRarityColor(prediction.rarity)}; margin-bottom: 8px;">${getRarityText(prediction.rarity)}</div>
                <div style="font-size: 0.8rem; color: #888; border-top: 1px solid var(--border); padding-top: 8px;">
                    <div style="margin-bottom: 4px;">ğŸ“Š ìƒì† ìŠ¤íƒ¯</div>
                    <div>ğŸ§ ${inheritParams.intelligence} | ğŸ’ª${inheritParams.strength} | ğŸ’–${inheritParams.charm}</div>
                    ${inheritAttrs.length > 0 ? `<div style="margin-top: 4px;">${inheritAttrs.join(' ')}</div>` : ''}
                </div>
            `;
            preview.style.display = 'block';
        }

        function toggleEncyclopediaGroup(groupId) {
            encyclopediaFoldState[groupId] = !encyclopediaFoldState[groupId];
            renderEncyclopedia();
        }
        
        function renderEncyclopedia() {
            try {
                console.log('ë„ê° ë Œë”ë§ ì‹œì‘');
                console.log('í˜„ì¬ ë„ê°:', encyclopedia);
                console.log('í˜„ì¬ ì•¨ë²”:', collection);
                
                // ë„ê° ì¹´ìš´íŠ¸ ê°€ì ¸ì˜¤ê¸° (ìˆ«ì/ê°ì²´ í˜•ì‹ ëª¨ë‘ ì²˜ë¦¬)
                function getEncyclopediaCount(key) {
                    const value = encyclopedia[key];
                    if (!value) return 0;
                    if (typeof value === 'object') return value.count || 0;
                    return value;
                }
                
                const grid = document.getElementById('encyclopediaGrid');
                if (!grid) {
                    console.error('encyclopediaGrid ì—˜ë¦¬ë¨¼íŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
                    return;
                }
                
                // encyclopediaê°€ nullì´ê±°ë‚˜ undefinedì¸ ê²½ìš° ì´ˆê¸°í™”
                if (!encyclopedia || typeof encyclopedia !== 'object') {
                    console.warn('âš ï¸ ë„ê° ë°ì´í„°ê°€ ìœ íš¨í•˜ì§€ ì•ŠìŒ - ì´ˆê¸°í™”');
                    encyclopedia = {};
                }
                
                // ë„ê°ì´ ë¹„ì–´ìˆëŠ”ë° ì•¨ë²”ì— ë°ì´í„°ê°€ ìˆìœ¼ë©´ ìë™ ë³µêµ¬
                if (Object.keys(encyclopedia).length === 0 && collection && collection.length > 0) {
                    console.log('âš ï¸ ë„ê°ì´ ë¹„ì–´ìˆì§€ë§Œ ì•¨ë²”ì— ë°ì´í„° ì¡´ì¬ - ìë™ ë³µêµ¬ ì‹œì‘');
                    try {
                        const recoveredCount = rebuildEncyclopediaFromAlbum();
                        showNotification(`ë„ê°ì„ ë³µêµ¬í–ˆìŠµë‹ˆë‹¤! (${recoveredCount}ì¢…)`);
                    } catch (rebuildError) {
                        console.error('ë„ê° ë³µêµ¬ ì‹¤íŒ¨:', rebuildError);
                    }
                }
            
            const statTypes = [
                { key: 'nostat', name: '(íƒ€ì´í‹€ ì—†ìŒ)' },
                { key: 'intelligent', name: 'ì§€ì‹ì˜ ì”¨ì•—' },
                { key: 'strong', name: 'ë¶ˆêµ´ì˜ ê¸°ì‚¬' },
                { key: 'beautiful', name: 'ë‹¬ì½¤í•œ í–¥ê¸°' },
                { key: 'sage', name: 'ì •ë ¹ì™•ì˜ ë¶€ë¦„ì„ ë°›ì€ ì' }
            ];
            
            // ì†ì„±ë³„ ê·¸ë£¹ ì •ì˜
            const attributeGroups = [
                {
                    title: 'âšª ìˆœìˆ˜',
                    attrs: ['normal']
                },
                {
                    title: 'ğŸ”¥ğŸ’§ğŸŒ¬ï¸ğŸŒ±âœ¨ğŸŒ™ ê¸°ë³¸ ì†ì„±',
                    attrs: ['fire', 'water', 'wind', 'earth', 'light', 'dark']
                },
                {
                    title: 'ğŸ”¥ í™”ì—¼ ì¡°í•©',
                    attrs: ['fire-water', 'fire-wind', 'earth-fire', 'fire-light', 'dark-fire']
                },
                {
                    title: 'ğŸ’§ ë¹™í•˜ ì¡°í•©',
                    attrs: ['water-wind', 'earth-water', 'light-water', 'dark-water']
                },
                {
                    title: 'ğŸŒ¬ï¸ ì§ˆí’ ì¡°í•©',
                    attrs: ['earth-wind', 'light-wind', 'dark-wind']
                },
                {
                    title: 'ğŸŒ± ëŒ€ì§€ ì¡°í•©',
                    attrs: ['earth-light', 'dark-earth']
                },
                {
                    title: 'âœ¨ğŸŒ™ í™˜í˜¹',
                    attrs: ['dark-light']
                },
                {
                    title: 'âš–ï¸ğŸŒªï¸ ë‹¤ì†ì„±',
                    attrs: ['balanced', 'multi']
                }
            ];
            
            let html = '';
            
            // ì „ì„¤ì  ì¡´ì¬ (í‹°íƒ€ë‹ˆì•„/ì˜¤ë² ë¡ ) - ë§¨ ìœ„ì— íŠ¹ë³„ í‘œì‹œ
            const legendaryFolded = encyclopediaFoldState['legendary'] || false;
            html += `<div style="grid-column: 1 / -1; margin-top: 10px; margin-bottom: 15px;">
                <div style="display: flex; justify-content: space-between; align-items: center; border-bottom: 3px solid gold; padding-bottom: 10px; cursor: pointer;" onclick="toggleEncyclopediaGroup('legendary')">
                    <h2 style="font-family: 'Nanum Myeongjo', serif; font-size: 1.5rem; color: var(--text); margin: 0;">
                        ì „ì„¤ì  ì¡´ì¬
                    </h2>
                    <span style="font-size: 1rem; color: var(--text-muted);">${legendaryFolded ? 'â–¼ í¼ì¹˜ê¸°' : 'â–² ì ‘ê¸°'}</span>
                </div>
            </div>`;
            
            if (!legendaryFolded) {
            // ì •ë ¹ì™•
            const spiritkingCount = getEncyclopediaCount('spiritking');
            const spiritkingUnlocked = spiritkingCount > 0;
            html += `
                <div class="${spiritkingUnlocked ? 'encyclopedia-card unlocked' : 'encyclopedia-card locked'}" style="min-height: 120px; border: 2px solid #ff69b4; background: ${spiritkingUnlocked ? 'linear-gradient(135deg, rgba(255,105,180,0.2), rgba(255,215,0,0.2))' : 'var(--card)'};">
                    <div class="encyclopedia-icon" style="font-size: 3rem;">${spiritkingUnlocked ? 'ğŸ‘‘ğŸŒ¸' : '?'}</div>
                    <div class="encyclopedia-name" style="font-size: 1rem; font-weight: 700;">${spiritkingUnlocked ? 'ì •ë ¹ì™•' : '???????'}</div>
                    <div class="encyclopedia-count" style="font-size: 0.8rem;">${spiritkingUnlocked ? `${spiritkingCount}íšŒ` : 'ë¯¸ë‹¬ì„±'}</div>
                    <div style="font-size: 0.7rem; color: ${spiritkingUnlocked ? '#ff69b4' : '#888'}; margin-top: 5px;">${spiritkingUnlocked ? ENCYCLOPEDIA_HINTS['spiritking'] : 'ë§Œê°œí•œ ìì—°ì˜ í™”ì‹ .'}</div>
                </div>
            `;
            
            // í‹°íƒ€ë‹ˆì•„
            const titaniaCount = getEncyclopediaCount('titania');
            const titaniaUnlocked = titaniaCount > 0;
            html += `
                <div class="${titaniaUnlocked ? 'encyclopedia-card unlocked' : 'encyclopedia-card locked'}" style="min-height: 120px; border: 2px solid gold;">
                    <div class="encyclopedia-icon" style="font-size: 3rem;">${titaniaUnlocked ? 'ğŸ¦‹âœ¨' : '?'}</div>
                    <div class="encyclopedia-name" style="font-size: 1rem; font-weight: 700;">${titaniaUnlocked ? 'í‹°íƒ€ë‹ˆì•„' : '???????'}</div>
                    <div class="encyclopedia-count" style="font-size: 0.8rem;">${titaniaUnlocked ? `${titaniaCount}íšŒ` : 'ë¯¸ë‹¬ì„±'}</div>
                    <div style="font-size: 0.7rem; color: ${titaniaUnlocked ? 'gold' : '#888'}; margin-top: 5px;">${titaniaUnlocked ? ENCYCLOPEDIA_HINTS['titania'] : 'ë‚˜ë¹„ë¥¼ ê±°ëŠë¦¬ëŠ” ì •ë ¹ë“¤ì˜ êµ°ì£¼.'}</div>
                </div>
            `;
            
            // ì˜¤ë² ë¡ 
            const oberonCount = getEncyclopediaCount('oberon');
            const oberonUnlocked = oberonCount > 0;
            html += `
                <div class="${oberonUnlocked ? 'encyclopedia-card unlocked' : 'encyclopedia-card locked'}" style="min-height: 120px; border: 2px solid gold;">
                    <div class="encyclopedia-icon" style="font-size: 3rem;">${oberonUnlocked ? 'ğŸ¦‹ğŸŒ™' : '?'}</div>
                    <div class="encyclopedia-name" style="font-size: 1rem; font-weight: 700;">${oberonUnlocked ? 'ì˜¤ë² ë¡ ' : '???????'}</div>
                    <div class="encyclopedia-count" style="font-size: 0.8rem;">${oberonUnlocked ? `${oberonCount}íšŒ` : 'ë¯¸ë‹¬ì„±'}</div>
                    <div style="font-size: 0.7rem; color: ${oberonUnlocked ? 'gold' : '#888'}; margin-top: 5px;">${oberonUnlocked ? ENCYCLOPEDIA_HINTS['oberon'] : 'ë‚˜ë°©ì„ ê±°ëŠë¦¬ëŠ” ì •ë ¹ë“¤ì˜ êµ°ì£¼.'}</div>
                </div>
            `;
            
            // ì˜¤ë¸”ë¦¬ë¹„ì˜¨
            const oblivionCount = getEncyclopediaCount('fusion-oblivion');
            const oblivionUnlocked = oblivionCount > 0;
            html += `
                <div class="${oblivionUnlocked ? 'encyclopedia-card unlocked' : 'encyclopedia-card locked'}" style="min-height: 120px; border: 2px solid #ff00ff;">
                    <div class="encyclopedia-icon" style="font-size: 3rem;">${oblivionUnlocked ? 'ğŸ¦‹ğŸŒŒ' : '?'}</div>
                    <div class="encyclopedia-name" style="font-size: 1rem; font-weight: 700;">${oblivionUnlocked ? 'ì˜¤ë¸”ë¦¬ë¹„ì˜¨' : '???????'}</div>
                    <div class="encyclopedia-count" style="font-size: 0.8rem;">${oblivionUnlocked ? `${oblivionCount}íšŒ` : 'ë¯¸ë‹¬ì„±'}</div>
                    <div style="font-size: 0.7rem; color: ${oblivionUnlocked ? '#ff00ff' : '#888'}; margin-top: 5px;">${oblivionUnlocked ? 'ì •ë ¹ì˜ êµ°ì£¼ë“¤ ì‚¬ì´ì—ì„œ íƒœì–´ë‚œ ë§ê°ì˜ ì •ë ¹.' : 'êµ°ì£¼ë“¤ì˜ í›„ì˜ˆ.'}</div>
                </div>
            `;
            }
            
            attributeGroups.forEach((group, groupIndex) => {
                const groupId = `encycGroup_${groupIndex}`;
                const isFolded = encyclopediaFoldState[groupId] || false;
                
                // ê·¸ë£¹ í—¤ë” (ì ‘ê¸°/í¼ì¹˜ê¸° ë²„íŠ¼ í¬í•¨)
                html += `<div style="grid-column: 1 / -1; margin-top: 30px; margin-bottom: 15px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; border-bottom: 3px solid var(--fire); padding-bottom: 10px; cursor: pointer;" onclick="toggleEncyclopediaGroup('${groupId}')">
                        <h2 style="font-family: 'Nanum Myeongjo', serif; font-size: 1.5rem; color: var(--text); margin: 0;">
                            ${group.title}
                        </h2>
                        <span style="font-size: 1rem; color: var(--text-muted);">${isFolded ? 'â–¼ í¼ì¹˜ê¸°' : 'â–² ì ‘ê¸°'}</span>
                    </div>
                </div>`;
                
                // ì ‘í˜€ìˆìœ¼ë©´ ë‚´ìš© ìŠ¤í‚µ
                if (isFolded) return;
                
                group.attrs.forEach(attrType => {
                    const attributeData = ATTRIBUTE_NAMES[attrType];
                    if (!attributeData) return;
                    
                    // ì†ì„± ì•„ì´ì½˜ (ì´ë¯¸ì§€ê°€ ìˆëŠ” ê²½ìš° ì´ëª¨í‹°ì½˜ìœ¼ë¡œ ëŒ€ì²´)
                    const attrEmojis = {
                        fire: 'ğŸ”¥', water: 'ğŸ’§', wind: 'ğŸŒ¬ï¸', earth: 'ğŸŒ±', light: 'âœ¨', dark: 'ğŸŒ™', normal: 'âšª',
                        'fire-water': 'ğŸ’¨', 'fire-wind': 'ğŸŒªï¸', 'earth-fire': 'ğŸŒ‹', 'fire-light': 'â˜€ï¸', 'dark-fire': 'ğŸ’¨',
                        'water-wind': 'â˜ï¸', 'earth-water': 'ğŸª¨', 'light-water': 'ğŸŒˆ', 'dark-water': 'ğŸŒ«ï¸',
                        'earth-wind': 'ğŸœï¸', 'light-wind': 'ğŸŒŒ', 'dark-wind': 'ğŸŒ€',
                        'earth-light': 'ğŸ’', 'dark-earth': 'â›°ï¸', 'dark-light': 'âœ¨ğŸŒ™',
                        balanced: 'âš–ï¸', multi: 'ğŸŒªï¸'
                    };
                    const butterflyIcon = typeof attributeData.icon === 'object' ? attributeData.icon.butterfly : attributeData.icon;
                    const mothIcon = typeof attributeData.icon === 'object' ? attributeData.icon.moth : attributeData.icon;
                    const headerEmoji = attrEmojis[attrType] || 'âœ¨';
                    
                    // ì†ì„± í—¤ë” (ì´ë¯¸ì§€ ì—†ì´ ì´ë¦„ë§Œ)
                    html += `<div style="grid-column: 1 / -1; margin-top: 20px; margin-bottom: 10px;">
                        <h3 style="font-family: 'Nanum Myeongjo', serif; font-size: 1.2rem; color: var(--text); display: flex; align-items: center; gap: 10px;">
                            <span style="font-size: 1.5rem;">${headerEmoji}</span>
                            <span>${attributeData.name}</span>
                        </h3>
                    </div>`;
                    
                    // ë‚˜ë¹„í˜•/ë‚˜ë°©í˜• ê°ê° í‘œì‹œ
                    const wingTypes = [
                        { key: 'butterfly', name: 'ë‚˜ë¹„í˜•', emoji: 'ğŸ¦‹' },
                        { key: 'moth', name: 'ë‚˜ë°©í˜•', emoji: 'ğŸ¦‹' }
                    ];
                    
                    wingTypes.forEach(wingInfo => {
                        const currentIcon = wingInfo.key === 'butterfly' ? butterflyIcon : mothIcon;
                        
                        // ë‚ ê°œ íƒ€ì… ì„œë¸Œí—¤ë”
                        html += `<div style="grid-column: 1 / -1; margin-top: 10px; margin-bottom: 5px;">
                            <span style="font-size: 0.9rem; color: var(--text-muted); font-weight: 600;">
                                ${wingInfo.emoji} ${wingInfo.name}
                            </span>
                        </div>`;
                        
                        // ê°€ë¡œë¡œ ë‚˜ì—´ (ìˆ˜ì‹ì–´ ì—†ìŒ + 3ê°œ ìŠ¤íƒ¯ ê³„ì—´ + í˜„ì)
                        statTypes.forEach(statInfo => {
                            let count = 0;
                            let displayName = '???????';
                            let displayIcon = '?';
                            let isUnlocked = false;
                            
                            // ì´ëª¨í‹°ì½˜ ë²„ì „ ì•„ì´ì½˜
                            const emojiIcon = headerEmoji;
                            
                            if (statInfo.key === 'nostat') {
                                // ìˆ˜ì‹ì–´ ì—†ëŠ” ì •ë ¹ - ì´ë¯¸ì§€ ì‚¬ìš© (ë„ê°ìš© 180x247)
                                count = getEncyclopediaCount(`nostat-${attrType}-${wingInfo.key}`);
                                isUnlocked = count > 0;
                                displayName = isUnlocked ? '(íƒ€ì´í‹€ ì—†ìŒ)' : '???????';
                                // ì´ë¯¸ì§€ì¸ ê²½ìš° 180x247ë¡œ ì¡°ì • (ì›ë³¸ 270x370ì˜ 2/3)
                                if (isUnlocked && currentIcon.includes('<img')) {
                                    displayIcon = currentIcon.replace(/width:\d+px;height:(auto|\d+px)/g, 'width:180px;height:247px');
                                } else {
                                    displayIcon = isUnlocked ? currentIcon : '?';
                                }
                            } else if (statInfo.key === 'sage') {
                                // ì •ë ¹ì™•ì˜ ë¶€ë¦„ì„ ë°›ì€ ì - ì´ëª¨í‹°ì½˜ ì‚¬ìš©
                                count = getEncyclopediaCount(`sage-${attrType}-${wingInfo.key}`);
                                isUnlocked = count > 0;
                                
                                if (isUnlocked) {
                                    const sageData = EVOLUTION_TYPES['sage'];
                                    displayName = sageData.prefix;
                                    displayIcon = `${sageData.icon}${emojiIcon}`;
                                }
                            } else {
                                // ìŠ¤íƒ¯ ê³„ì—´ ì •ë ¹ (intelligent, strong, beautiful) - ì´ëª¨í‹°ì½˜ ì‚¬ìš©
                                count = getEncyclopediaCount(`${statInfo.key}-${attrType}-${wingInfo.key}`);
                                isUnlocked = count > 0;
                                
                                if (isUnlocked) {
                                    const statData = EVOLUTION_TYPES[statInfo.key];
                                    displayName = statData.prefix;
                                    displayIcon = `${statData.icon}${emojiIcon}`;
                                }
                            }
                            
                            const cardClass = isUnlocked ? 'encyclopedia-card unlocked' : 'encyclopedia-card locked';
                            const countText = isUnlocked ? `${count}íšŒ` : 'ë¯¸ë‹¬ì„±';
                            
                            // ì •ë ¹ ì „ì²´ ì´ë¦„ ìƒì„±
                            let fullName = '???????';
                            let hintKey = '';
                            
                            if (isUnlocked) {
                                if (statInfo.key === 'nostat') {
                                    fullName = attributeData.name;
                                    hintKey = `nostat-${attrType}`;
                                } else if (statInfo.key === 'sage') {
                                    const sageData = EVOLUTION_TYPES['sage'];
                                    fullName = `${sageData.prefix} ${attributeData.name}`;
                                    hintKey = `sage-${attrType}`;
                                } else {
                                    const statData = EVOLUTION_TYPES[statInfo.key];
                                    fullName = `${statData.prefix} ${attributeData.name}`;
                                    hintKey = `${statInfo.key}-${attrType}`;
                                }
                            }
                            
                            // íŒíŠ¸ í‘œì‹œ
                            let hint = '';
                            if (isUnlocked) {
                                hint = ENCYCLOPEDIA_HINTS[hintKey] || '';
                            } else {
                                if (statInfo.key === 'nostat') {
                                    hint = ENCYCLOPEDIA_HINTS[`nostat-${attrType}`] || '???';
                                } else if (statInfo.key === 'sage') {
                                    hint = ENCYCLOPEDIA_HINTS[`sage-${attrType}`] || 'ì •ë ¹ì™•ì˜ ë¶€ë¦„ì„ ë°›ì€ ì •ë ¹.';
                                } else {
                                    hint = ENCYCLOPEDIA_HINTS[`${statInfo.key}-${attrType}`] || '???';
                                }
                            }
                            
                            // ì•„ì´ì½˜ì´ ì´ë¯¸ì§€ì¸ì§€ ì´ëª¨í‹°ì½˜ì¸ì§€ì— ë”°ë¼ ìŠ¤íƒ€ì¼ ë‹¤ë¥´ê²Œ
                            const isImageIcon = displayIcon.includes('<img');
                            const iconStyle = isImageIcon ? '' : 'font-size: 2.5rem;';
                            
                            html += `
                                <div class="${cardClass}" style="min-height: 120px;">
                                    <div class="encyclopedia-icon" style="${iconStyle}">${displayIcon}</div>
                                    <div class="encyclopedia-name" style="font-size: 0.85rem; font-weight: 600;">${fullName}</div>
                                    <div class="encyclopedia-count" style="font-size: 0.75rem; margin-top: 4px;">${countText}</div>
                                    ${hint ? `<div style="font-size: 0.7rem; color: #888; margin-top: 6px; line-height: 1.3; padding: 0 8px; text-align: center;">${hint}</div>` : ''}
                                </div>
                            `;
                        });
                    });
                });
            });
            
            // ì´ë²¤íŠ¸ ì •ë ¹ ì„¹ì…˜
            const eventFolded = encyclopediaFoldState['event'] || false;
            html += `<div style="grid-column: 1 / -1; margin-top: 30px; margin-bottom: 15px;">
                <div style="display: flex; justify-content: space-between; align-items: center; border-bottom: 3px solid #c41e3a; padding-bottom: 10px; cursor: pointer;" onclick="toggleEncyclopediaGroup('event')">
                    <h2 style="font-family: 'Nanum Myeongjo', serif; font-size: 1.5rem; color: #c41e3a; margin: 0;">
                        ğŸ„ ì´ë²¤íŠ¸ ì •ë ¹
                    </h2>
                    <span style="font-size: 1rem; color: var(--text-muted);">${eventFolded ? 'â–¼ í¼ì¹˜ê¸°' : 'â–² ì ‘ê¸°'}</span>
                </div>
            </div>`;
            
            if (!eventFolded) {
            Object.entries(EVENT_TYPES).forEach(([eventKey, event]) => {
                // adultê°€ ë‚˜ë¹„/ë‚˜ë°©ìœ¼ë¡œ ë¶„ë¦¬ëœ ê²½ìš°
                const hasWingTypes = event.stages.adult && typeof event.stages.adult === 'object' && event.stages.adult.butterfly;
                
                if (hasWingTypes) {
                    // ë‚˜ë¹„ ë²„ì „
                    const butterflyKey = `event_${eventKey}_butterfly`;
                    const butterflyCount = encyclopedia[butterflyKey] || 0;
                    const isButterflyUnlocked = butterflyCount > 0;
                    let butterflyIcon = isButterflyUnlocked ? event.stages.adult.butterfly : event.stages.egg;
                    if (isButterflyUnlocked && butterflyIcon.includes('<img')) {
                        butterflyIcon = butterflyIcon.replace(/width:\d+px;height:\d+px/g, 'width:180px;height:247px');
                    }
                    
                    html += `
                        <div class="${isButterflyUnlocked ? 'encyclopedia-card unlocked' : 'encyclopedia-card locked'}" style="min-height: 120px; border: 2px solid #c41e3a;">
                            <div class="encyclopedia-icon" style="font-size: 3rem;">${butterflyIcon}</div>
                            <div class="encyclopedia-name" style="font-size: 1rem; font-weight: 700; color: #c41e3a;">${isButterflyUnlocked ? event.name : '???'} (ë‚˜ë¹„í˜•)</div>
                            <div class="encyclopedia-count" style="font-size: 0.8rem;">${isButterflyUnlocked ? `${butterflyCount}íšŒ` : 'ë¯¸ë‹¬ì„±'}</div>
                            <div style="font-size: 0.7rem; color: ${isButterflyUnlocked ? '#c41e3a' : '#888'}; margin-top: 5px;">${isButterflyUnlocked ? event.desc : 'ì´ë²¤íŠ¸ ì½”ë“œë¡œ íšë“í•  ìˆ˜ ìˆëŠ” íŠ¹ë³„í•œ ì •ë ¹.'}</div>
                        </div>
                    `;
                    
                    // ë‚˜ë°© ë²„ì „
                    const mothKey = `event_${eventKey}_moth`;
                    const mothCount = encyclopedia[mothKey] || 0;
                    const isMothUnlocked = mothCount > 0;
                    let mothIcon = isMothUnlocked ? event.stages.adult.moth : event.stages.egg;
                    if (isMothUnlocked && mothIcon.includes('<img')) {
                        mothIcon = mothIcon.replace(/width:\d+px;height:\d+px/g, 'width:180px;height:247px');
                    }
                    
                    html += `
                        <div class="${isMothUnlocked ? 'encyclopedia-card unlocked' : 'encyclopedia-card locked'}" style="min-height: 120px; border: 2px solid #c41e3a;">
                            <div class="encyclopedia-icon" style="font-size: 3rem;">${mothIcon}</div>
                            <div class="encyclopedia-name" style="font-size: 1rem; font-weight: 700; color: #c41e3a;">${isMothUnlocked ? event.name : '???'} (ë‚˜ë°©í˜•)</div>
                            <div class="encyclopedia-count" style="font-size: 0.8rem;">${isMothUnlocked ? `${mothCount}íšŒ` : 'ë¯¸ë‹¬ì„±'}</div>
                            <div style="font-size: 0.7rem; color: ${isMothUnlocked ? '#c41e3a' : '#888'}; margin-top: 5px;">${isMothUnlocked ? event.desc : 'ì´ë²¤íŠ¸ ì½”ë“œë¡œ íšë“í•  ìˆ˜ ìˆëŠ” íŠ¹ë³„í•œ ì •ë ¹.'}</div>
                        </div>
                    `;
                } else {
                    // ì¼ë°˜ ì´ë²¤íŠ¸ ì •ë ¹ (ë‚˜ë¹„/ë‚˜ë°© ë¶„ë¦¬ ì—†ìŒ)
                    const eventEncKey = `event_${eventKey}`;
                    const eventCount = encyclopedia[eventEncKey] || 0;
                    const isUnlocked = eventCount > 0;
                    
                    html += `
                        <div class="${isUnlocked ? 'encyclopedia-card unlocked' : 'encyclopedia-card locked'}" style="min-height: 120px; border: 2px solid #c41e3a;">
                            <div class="encyclopedia-icon" style="font-size: 3rem;">${isUnlocked ? event.stages.adult : event.stages.egg}</div>
                            <div class="encyclopedia-name" style="font-size: 1rem; font-weight: 700; color: #c41e3a;">${isUnlocked ? event.name : '???'}</div>
                            <div class="encyclopedia-count" style="font-size: 0.8rem;">${isUnlocked ? `${eventCount}íšŒ` : 'ë¯¸ë‹¬ì„±'}</div>
                            <div style="font-size: 0.7rem; color: ${isUnlocked ? '#c41e3a' : '#888'}; margin-top: 5px;">${isUnlocked ? event.desc : 'ì´ë²¤íŠ¸ ì½”ë“œë¡œ íšë“í•  ìˆ˜ ìˆëŠ” íŠ¹ë³„í•œ ì •ë ¹.'}</div>
                        </div>
                    `;
                }
                
                // ì´ë¡œì¹˜ ë²„ì „ì´ ìˆìœ¼ë©´ ë³„ë„ í‘œì‹œ
                if (event.shiny) {
                    const shinyHasWingTypes = event.shiny.stages.adult && typeof event.shiny.stages.adult === 'object' && event.shiny.stages.adult.butterfly;
                    
                    if (shinyHasWingTypes) {
                        // ì´ë¡œì¹˜ ë‚˜ë¹„ ë²„ì „
                        const shinyButterflyKey = `event_${eventKey}_shiny_butterfly`;
                        const shinyButterflyCount = encyclopedia[shinyButterflyKey] || 0;
                        const isShinyButterflyUnlocked = shinyButterflyCount > 0;
                        let shinyButterflyIcon = isShinyButterflyUnlocked ? event.shiny.stages.adult.butterfly : event.shiny.stages.egg;
                        if (isShinyButterflyUnlocked && shinyButterflyIcon.includes('<img')) {
                            shinyButterflyIcon = shinyButterflyIcon.replace(/width:\d+px;height:\d+px/g, 'width:180px;height:247px');
                        }
                        
                        html += `
                            <div class="${isShinyButterflyUnlocked ? 'encyclopedia-card unlocked' : 'encyclopedia-card locked'}" style="min-height: 120px; border: 2px solid #87CEEB; background: ${isShinyButterflyUnlocked ? 'linear-gradient(135deg, rgba(135,206,235,0.1), rgba(255,255,255,0.1))' : 'var(--card)'};">
                                <div class="encyclopedia-icon" style="font-size: 3rem;">${shinyButterflyIcon}</div>
                                <div class="encyclopedia-name" style="font-size: 1rem; font-weight: 700; color: #87CEEB;">${isShinyButterflyUnlocked ? event.shiny.name : '???'} (ë‚˜ë¹„í˜•) ${isShinyButterflyUnlocked ? 'âœ¨' : ''}</div>
                                <div class="encyclopedia-count" style="font-size: 0.8rem;">${isShinyButterflyUnlocked ? `${shinyButterflyCount}íšŒ` : 'ë¯¸ë‹¬ì„±'}</div>
                                <div style="font-size: 0.7rem; color: ${isShinyButterflyUnlocked ? '#87CEEB' : '#888'}; margin-top: 5px;">${isShinyButterflyUnlocked ? event.shiny.desc : 'ì´ë²¤íŠ¸ì—ì„œ ë“œë¬¼ê²Œ ë‚˜íƒ€ë‚˜ëŠ” íŠ¹ë³„í•œ ì •ë ¹.'}</div>
                            </div>
                        `;
                        
                        // ì´ë¡œì¹˜ ë‚˜ë°© ë²„ì „
                        const shinyMothKey = `event_${eventKey}_shiny_moth`;
                        const shinyMothCount = encyclopedia[shinyMothKey] || 0;
                        const isShinyMothUnlocked = shinyMothCount > 0;
                        let shinyMothIcon = isShinyMothUnlocked ? event.shiny.stages.adult.moth : event.shiny.stages.egg;
                        if (isShinyMothUnlocked && shinyMothIcon.includes('<img')) {
                            shinyMothIcon = shinyMothIcon.replace(/width:\d+px;height:\d+px/g, 'width:180px;height:247px');
                        }
                        
                        html += `
                            <div class="${isShinyMothUnlocked ? 'encyclopedia-card unlocked' : 'encyclopedia-card locked'}" style="min-height: 120px; border: 2px solid #87CEEB; background: ${isShinyMothUnlocked ? 'linear-gradient(135deg, rgba(135,206,235,0.1), rgba(255,255,255,0.1))' : 'var(--card)'};">
                                <div class="encyclopedia-icon" style="font-size: 3rem;">${shinyMothIcon}</div>
                                <div class="encyclopedia-name" style="font-size: 1rem; font-weight: 700; color: #87CEEB;">${isShinyMothUnlocked ? event.shiny.name : '???'} (ë‚˜ë°©í˜•) ${isShinyMothUnlocked ? 'âœ¨' : ''}</div>
                                <div class="encyclopedia-count" style="font-size: 0.8rem;">${isShinyMothUnlocked ? `${shinyMothCount}íšŒ` : 'ë¯¸ë‹¬ì„±'}</div>
                                <div style="font-size: 0.7rem; color: ${isShinyMothUnlocked ? '#87CEEB' : '#888'}; margin-top: 5px;">${isShinyMothUnlocked ? event.shiny.desc : 'ì´ë²¤íŠ¸ì—ì„œ ë“œë¬¼ê²Œ ë‚˜íƒ€ë‚˜ëŠ” íŠ¹ë³„í•œ ì •ë ¹.'}</div>
                            </div>
                        `;
                    } else {
                        // ì´ë¡œì¹˜ (ë‚˜ë¹„/ë‚˜ë°© ë¶„ë¦¬ ì—†ìŒ)
                        const shinyEncKey = `event_${eventKey}_shiny`;
                        const shinyCount = encyclopedia[shinyEncKey] || 0;
                        const isShinyUnlocked = shinyCount > 0;
                        
                        html += `
                            <div class="${isShinyUnlocked ? 'encyclopedia-card unlocked' : 'encyclopedia-card locked'}" style="min-height: 120px; border: 2px solid #87CEEB; background: ${isShinyUnlocked ? 'linear-gradient(135deg, rgba(135,206,235,0.1), rgba(255,255,255,0.1))' : 'var(--card)'};">
                                <div class="encyclopedia-icon" style="font-size: 3rem;">${isShinyUnlocked ? event.shiny.stages.adult : event.shiny.stages.egg}</div>
                                <div class="encyclopedia-name" style="font-size: 1rem; font-weight: 700; color: #87CEEB;">${isShinyUnlocked ? event.shiny.name : '???'} ${isShinyUnlocked ? 'âœ¨' : ''}</div>
                                <div class="encyclopedia-count" style="font-size: 0.8rem;">${isShinyUnlocked ? `${shinyCount}íšŒ` : 'ë¯¸ë‹¬ì„±'}</div>
                                <div style="font-size: 0.7rem; color: ${isShinyUnlocked ? '#87CEEB' : '#888'}; margin-top: 5px;">${isShinyUnlocked ? event.shiny.desc : 'ì´ë²¤íŠ¸ì—ì„œ ë“œë¬¼ê²Œ ë‚˜íƒ€ë‚˜ëŠ” íŠ¹ë³„í•œ ì •ë ¹.'}</div>
                            </div>
                        `;
                    }
                }
            });
            }
            
            // ì—°ê²° ì •ë ¹ ì„¹ì…˜
            const fusionFolded = encyclopediaFoldState['fusion'] || false;
            html += '<div style="grid-column: 1 / -1; margin-top: 30px; margin-bottom: 15px;">' +
                '<div style="display: flex; justify-content: space-between; align-items: center; border-bottom: 3px solid #9b59b6; padding-bottom: 10px; cursor: pointer;" onclick="toggleEncyclopediaGroup(\'fusion\')">' +
                    '<h2 style="font-family: \'Nanum Myeongjo\', serif; font-size: 1.5rem; color: #9b59b6; margin: 0;">' +
                        'ğŸ’œ ì—°ê²° ì •ë ¹' +
                    '</h2>' +
                    '<span style="font-size: 1rem; color: var(--text-muted);">' + (fusionFolded ? 'â–¼ í¼ì¹˜ê¸°' : 'â–² ì ‘ê¸°') + '</span>' +
                '</div>' +
            '</div>';
            
            if (!fusionFolded) {
            // ë ˆì–´ë¦¬í‹°ë³„ ê·¸ë£¹í™”
            const fusionGroups = {
                'rare': { title: 'ğŸ’ í¬ê·€', entries: [] },
                'epic': { title: 'â­ ìµœìƒê¸‰', entries: [] },
                'legendary': { title: 'ğŸ‘‘ ì „ì„¤', entries: [] }
            };
            
            Object.entries(FUSION_TYPES).forEach(([key, data]) => {
                if (fusionGroups[data.rarity]) {
                    fusionGroups[data.rarity].entries.push({ key, ...data });
                }
            });
            
            // ë ˆì–´ë¦¬í‹° ìˆœì„œëŒ€ë¡œ í‘œì‹œ
            ['rare', 'epic', 'legendary'].forEach(rarity => {
                const group = fusionGroups[rarity];
                if (group.entries.length === 0) return;
                
                // ë ˆì–´ë¦¬í‹° ì†Œì œëª©
                const rarityColors = { rare: '#3498db', epic: '#9b59b6', legendary: '#f1c40f' };
                html += '<div style="grid-column: 1 / -1; margin-top: 20px; margin-bottom: 10px;">' +
                    '<h3 style="font-family: \'Nanum Myeongjo\', serif; font-size: 1.1rem; color: ' + rarityColors[rarity] + ';">' + group.title + '</h3>' +
                '</div>';
                
                group.entries.forEach(fusion => {
                    const fusionCount = encyclopedia[fusion.key] || 0;
                    const isUnlocked = fusionCount > 0;
                    const borderColor = rarityColors[rarity];
                    
                    // ë ˆì‹œí”¼ íŒíŠ¸ ìƒì„±
                    let recipeHint = '';
                    if (fusion.recipe) {
                        const recipeNames = fusion.recipe.map(r => {
                            if (ATTRIBUTE_NAMES[r]) {
                                const icon = ATTRIBUTE_NAMES[r].icon;
                                // iconì´ objectì¸ ê²½ìš° (fire ë“±) ì´ëª¨ì§€ë¡œ ëŒ€ì²´
                                if (typeof icon === 'object') {
                                    const attrEmojis = { fire: 'ğŸ”¥', water: 'ğŸ’§', wind: 'ğŸŒ¬ï¸', earth: 'ğŸŒ±', light: 'âœ¨', dark: 'ğŸŒ™' };
                                    return attrEmojis[r] || 'âœ¨';
                                }
                                return icon;
                            }
                            if (r === 'intelligent') return 'ğŸ§ ';
                            if (r === 'strong') return 'ğŸ’ª';
                            if (r === 'beautiful') return 'ğŸ’–';
                            if (r === 'balanced') return 'âš–ï¸';
                            return r;
                        });
                        recipeHint = recipeNames.join(' + ');
                    }
                    
                    html += '<div class="' + (isUnlocked ? 'encyclopedia-card unlocked' : 'encyclopedia-card locked') + '" style="min-height: 120px; border: 2px solid ' + borderColor + ';">' +
                        '<div class="encyclopedia-icon" style="font-size: 2.5rem;">' + (isUnlocked ? fusion.icon : '?') + '</div>' +
                        '<div class="encyclopedia-name" style="font-size: 0.9rem; font-weight: 700; color: ' + borderColor + ';">' + (isUnlocked ? fusion.name : '???') + '</div>' +
                        '<div class="encyclopedia-count" style="font-size: 0.75rem;">' + (isUnlocked ? fusionCount + 'íšŒ' : 'ë¯¸ë‹¬ì„±') + '</div>' +
                        '<div style="font-size: 0.7rem; color: #888; margin-top: 5px;">' + (isUnlocked ? fusion.desc : 'ì—°ê²°: ' + recipeHint) + '</div>' +
                    '</div>';
                });
            });
            }
            
            grid.innerHTML = html;
            } catch (error) {
                console.error('ë„ê° ë Œë”ë§ ì˜¤ë¥˜:', error);
                console.error('ì˜¤ë¥˜ ìŠ¤íƒ:', error.stack);
                console.error('í˜„ì¬ ë„ê° ë°ì´í„°:', encyclopedia);
                console.error('í˜„ì¬ ì•¨ë²” ë°ì´í„°:', collection);
                
                const grid = document.getElementById('encyclopediaGrid');
                if (grid) {
                    grid.innerHTML = `
                        <div style="text-align: center; padding: 40px;">
                            <div style="color: #f44336; font-size: 1.2rem; margin-bottom: 20px;">âš ï¸ ë„ê° ë Œë”ë§ ì˜¤ë¥˜</div>
                            <div style="color: #666; margin-bottom: 20px;">
                                ì˜¤ë¥˜: ${error.message}<br>
                                ë„ê° í•­ëª©: ${Object.keys(encyclopedia).length}ê°œ<br>
                                ì•¨ë²” í•­ëª©: ${collection.length}ê°œ
                            </div>
                            <button onclick="manualRebuildEncyclopedia()" style="padding: 12px 24px; background: var(--water); color: white; border: none; border-radius: 8px; font-weight: 700; cursor: pointer; margin-right: 10px;">
                                ğŸ“š ì•¨ë²”ì—ì„œ ë„ê° ë³µêµ¬
                            </button>
                            <button onclick="renderEncyclopedia()" style="padding: 12px 24px; background: var(--fire); color: white; border: none; border-radius: 8px; font-weight: 700; cursor: pointer;">
                                ğŸ”„ ë‹¤ì‹œ ì‹œë„
                            </button>
                        </div>
                    `;
                }
            }
        }

        // ì•¨ë²” ìƒì„¸ ì´ë¯¸ì§€ ì €ì¥ ê¸°ëŠ¥
        async function saveAlbumDetailImage() {
            showNotification('ğŸ“· ì´ë¯¸ì§€ ìƒì„± ì¤‘...');
            
            try {
                const content = document.getElementById('albumDetailContent');
                
                // ìŠ¤í¬ë¡¤ ìœ„ì¹˜ ì €ì¥ ë° ë§¨ ìœ„ë¡œ ì´ë™
                const originalScrollTop = content.scrollTop;
                content.scrollTop = 0;
                
                // ì €ì¥ ë²„íŠ¼ ì„ì‹œ ìˆ¨ê¸°ê¸°
                const saveBtn = content.querySelector('button[onclick="saveAlbumDetailImage()"]').parentElement;
                const originalSaveBtnDisplay = saveBtn.style.display;
                saveBtn.style.display = 'none';
                
                // X ë²„íŠ¼ ì„ì‹œ ìˆ¨ê¸°ê¸°
                const closeBtn = content.querySelector('button[onclick="closeAlbumDetail()"]');
                const originalCloseBtnDisplay = closeBtn.style.display;
                closeBtn.style.display = 'none';
                
                // ì—°ê²° ì„¹ì…˜ ì„ì‹œ ìˆ¨ê¸°ê¸°
                const breedSection = document.getElementById('breedSection');
                const originalBreedDisplay = breedSection ? breedSection.style.display : '';
                if (breedSection) breedSection.style.display = 'none';
                
                // ìŠ¤í¬ë¡¤ë°” ì„ì‹œ ì œê±° ë° ì „ì²´ ë†’ì´ë¡œ í™•ì¥
                const originalOverflow = content.style.overflowY;
                const originalMaxHeight = content.style.maxHeight;
                content.style.overflowY = 'visible';
                content.style.maxHeight = 'none';
                
                const canvas = await html2canvas(content, {
                    backgroundColor: getComputedStyle(document.body).getPropertyValue('--card') || '#ffffff',
                    scale: 2,
                    useCORS: true,
                    logging: false,
                    windowHeight: content.scrollHeight,
                    height: content.scrollHeight
                });
                
                // ëª¨ë“  ìš”ì†Œ ë³µì›
                saveBtn.style.display = originalSaveBtnDisplay;
                closeBtn.style.display = originalCloseBtnDisplay;
                if (breedSection) breedSection.style.display = originalBreedDisplay;
                content.style.overflowY = 'auto';
                content.style.maxHeight = '80vh';
                content.scrollTop = originalScrollTop;
                
                // ì •ë ¹ ì´ë¦„ ê°€ì ¸ì˜¤ê¸°
                const spiritName = document.getElementById('modalTitle').textContent || 'spirit';
                
                // ì´ë¯¸ì§€ ë‹¤ìš´ë¡œë“œ
                const link = document.createElement('a');
                link.download = `${spiritName}-${new Date().toISOString().slice(0,10)}.png`;
                link.href = canvas.toDataURL('image/png');
                link.click();
                
                showNotification('âœ… ì´ë¯¸ì§€ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!');
            } catch (error) {
                console.error('ì´ë¯¸ì§€ ìƒì„± ì˜¤ë¥˜:', error);
                showNotification('âŒ ì´ë¯¸ì§€ ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤');
            }
        }

        function renderCollection() {
            try {
                console.log('ì•¨ë²” ë Œë”ë§ ì‹œì‘');
                const grid = document.getElementById('collectionGrid');
                if (!grid) {
                    console.error('collectionGrid ì—˜ë¦¬ë¨¼íŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
                    return;
                }
            
            if (collection.length === 0) {
                grid.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">ğŸ“–</div>
                        <div>ì•„ì§ ë“±ë¡ëœ ì •ë ¹ì´ ì—†ìŠµë‹ˆë‹¤<br>ì •ë ¹ì„ ì„±ì¶©ê¹Œì§€ í‚¤ì›Œë³´ì„¸ìš”</div>
                    </div>
                `;
                return;
            }

            // ì—­ìˆœìœ¼ë¡œ í‘œì‹œ (ìµœê·¼ ê²ƒì´ ë§¨ ì•ì—)
            const reversedCollection = [...collection].reverse();
            
            grid.innerHTML = reversedCollection.map((item, reverseIndex) => {
                const index = collection.length - 1 - reverseIndex; // ì›ë³¸ ì¸ë±ìŠ¤
                // descëŠ” ë„ê° ì•„ì´í…œì— ì €ì¥ë˜ì–´ ìˆìŒ
                const desc = item.desc || '';
                const originalName = item.originalName || item.name || 'ì´ë¦„ ì—†ìŒ';
                
                // ì•„ì´ì½˜ì„ ìµœì‹  ë²„ì „ìœ¼ë¡œ ì—…ë°ì´íŠ¸
                let itemIcon = item.icon;
                
                // ì´ë²¤íŠ¸ ì •ë ¹ì¸ ê²½ìš° ìµœì‹  ì•„ì´ì½˜ìœ¼ë¡œ ì—…ë°ì´íŠ¸
                if (item.type && item.type.startsWith('event_')) {
                    // event_christmas2025_shiny_butterfly í˜•ì‹ íŒŒì‹±
                    const typeParts = item.type.replace('event_', '').split('_');
                    const eventKey = typeParts[0]; // christmas2025
                    const isShiny = typeParts.includes('shiny');
                    
                    // wingType ê²°ì •: ì €ì¥ëœ ê°’ > typeì—ì„œ ì¶”ì¶œ > lightTime/darkTimeìœ¼ë¡œ ê³„ì‚° > ê¸°ë³¸ê°’
                    let wingType = item.wingType;
                    if (!wingType) {
                        if (typeParts.includes('butterfly')) {
                            wingType = 'butterfly';
                        } else if (typeParts.includes('moth')) {
                            wingType = 'moth';
                        } else if (item.lightTime !== undefined && item.darkTime !== undefined) {
                            wingType = item.lightTime > item.darkTime ? 'butterfly' : 'moth';
                        } else {
                            wingType = 'butterfly';
                        }
                    }
                    
                    const event = EVENT_TYPES[eventKey];
                    if (event) {
                        const stages = isShiny && event.shiny ? event.shiny.stages : event.stages;
                        if (stages && stages.adult) {
                            // adultê°€ ë‚˜ë¹„/ë‚˜ë°©ìœ¼ë¡œ ë¶„ë¦¬ëœ ê²½ìš°
                            if (typeof stages.adult === 'object' && stages.adult.butterfly) {
                                itemIcon = stages.adult[wingType] || stages.adult.butterfly;
                            } else {
                                itemIcon = stages.adult;
                            }
                        }
                    }
                }
                // ì¼ë°˜ ì •ë ¹(ATTRIBUTE_NAMES)ì¸ ê²½ìš°ë„ ìµœì‹  ì•„ì´ì½˜ìœ¼ë¡œ ì—…ë°ì´íŠ¸
                // attributeTypeì„ í™•ì¸í•´ì•¼ í•¨ (typeì€ ìŠ¤íƒ¯ ë ˆë²¨ì„)
                // ì´ë²¤íŠ¸ ì •ë ¹ì´ ì•„ë‹Œ ê²½ìš°ì—ë§Œ ì ìš©
                else if (item.attributeType && ATTRIBUTE_NAMES[item.attributeType]) {
                    const attrData = ATTRIBUTE_NAMES[item.attributeType];
                    if (attrData && attrData.icon) {
                        // wingType ê²°ì •
                        let wingType = item.wingType;
                        if (!wingType) {
                            if (item.lightTime !== undefined && item.darkTime !== undefined) {
                                wingType = item.lightTime > item.darkTime ? 'butterfly' : 'moth';
                            } else {
                                wingType = 'butterfly';
                            }
                        }
                        
                        // ì´ë¯¸ì§€ê°€ ìˆëŠ” ê²½ìš° (butterfly/moth êµ¬ë¶„)
                        if (typeof attrData.icon === 'object' && attrData.icon.butterfly) {
                            itemIcon = attrData.icon[wingType] || attrData.icon.butterfly;
                        } else {
                            itemIcon = attrData.icon;
                        }
                    }
                }
                // í•©ì„± ì •ë ¹(FUSION_TYPES)ì¸ ê²½ìš°ë„ ìµœì‹  ì•„ì´ì½˜ìœ¼ë¡œ ì—…ë°ì´íŠ¸
                else if (item.type && FUSION_TYPES[item.type]) {
                    const fusionData = FUSION_TYPES[item.type];
                    if (fusionData && fusionData.icon) {
                        itemIcon = fusionData.icon;
                    }
                }
                
                // ì´ë¯¸ì§€ ì•„ì´ì½˜ì¸ì§€ í™•ì¸
                const isImageIcon = itemIcon && itemIcon.includes('<img');
                
                // ë‚ ê°œ ì´ëª¨ì§€ ê²°ì • (ì´ë¯¸ì§€ ì•„ì´ì½˜ì´ë©´ ë¶™ì´ì§€ ì•ŠìŒ)
                let wingEmoji = '';
                if (!isImageIcon) {
                    if (item.wingType === 'butterfly') {
                        wingEmoji = 'ğŸ¦‹';
                    } else if (item.wingType === 'moth') {
                        wingEmoji = 'ğŸ¦‹'; // ë‚˜ë°©ë„ ë‚˜ë¹„ ì´ëª¨ì§€ ì‚¬ìš© (ì‹œê°ì ìœ¼ë¡œ êµ¬ë¶„)
                    } else if (item.wingType === 'both') {
                        wingEmoji = 'ğŸ¦‹ğŸ¦‹';
                    }
                }
                
                // ì•„ì´ì½˜ í‘œì‹œ (ì´ë¯¸ì§€ì¸ ê²½ìš° 180x247ë¡œ ì¡°ì • - ì›ë³¸ 270x370ì˜ 2/3)
                let displayIcon = itemIcon;
                if (isImageIcon) {
                    displayIcon = itemIcon.replace(/width:\d+px;height:(auto|\d+px)/g, 'width:180px;height:247px');
                }
                
                return `
                    <div class="collection-card" onclick="showAlbumDetail(${index})" style="cursor: pointer; transition: transform 0.2s;${item.isRecovered ? (item.recoveredFromDetails ? ' border: 2px dashed #27ae60;' : ' border: 2px dashed #e67e22;') : ''}" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
                        <div class="collection-icon">${displayIcon}${wingEmoji}</div>
                        <div class="collection-name">${item.name}${item.isRecovered ? (item.recoveredFromDetails ? ' <span style="font-size: 0.7rem; color: #27ae60;">âœ“ë³µêµ¬</span>' : ' <span style="font-size: 0.7rem; color: #e67e22;">ë³µêµ¬</span>') : ''}</div>
                        <div style="font-size: 0.85rem; color: #666; margin-top: 4px;">ë³¸ëª…: ${originalName}</div>
                        ${item.wingType ? `<div style="font-size: 0.85rem; color: #888; margin-top: 4px;">${item.wingType === 'butterfly' ? 'ë‚˜ë¹„ì˜ ë‚ ê°œ' : item.wingType === 'moth' ? 'ë‚˜ë°©ì˜ ë‚ ê°œ' : 'ë‚˜ë¹„ì™€ ë‚˜ë°©ì˜ ë‚ ê°œ'}</div>` : ''}
                        ${desc ? `<div style="font-size: 0.85rem; color: #888; margin-top: 8px; line-height: 1.4;">${desc}</div>` : ''}
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; margin-top: 12px;">
                            <div class="param">ğŸ’• ${item.parameters.affection || 0}</div>
                            <div class="param">ğŸ’ª ${item.parameters.strength}</div>
                            <div class="param">ğŸ§  ${item.parameters.intelligence}</div>
                            <div class="param">ğŸ’– ${item.parameters.charm}</div>
                        </div>
                        <div style="font-size: 0.75rem; color: #999; margin-top: 12px; text-align: center;">ğŸ“Š í´ë¦­í•˜ì—¬ ìƒì„¸ ì •ë³´ ë³´ê¸°</div>
                    </div>
                `;
            }).join('');
            } catch (error) {
                console.error('ì•¨ë²” ë Œë”ë§ ì˜¤ë¥˜:', error);
                console.error('ì˜¤ë¥˜ ìŠ¤íƒ:', error.stack);
                const grid = document.getElementById('collectionGrid');
                if (grid) {
                    grid.innerHTML = `
                        <div style="text-align: center; padding: 40px;">
                            <div style="color: #f44336; font-size: 1.2rem; margin-bottom: 20px;">âš ï¸ ì•¨ë²” ë Œë”ë§ ì˜¤ë¥˜</div>
                            <div style="color: #666;">ì˜¤ë¥˜: ${error.message}</div>
                        </div>
                    `;
                }
            }
        }

        function switchTab(tab) {
            try {
                console.log('íƒ­ ì „í™˜:', tab);
                currentTab = tab; // í˜„ì¬ íƒ­ ì €ì¥
                
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
                
                // ë°ìŠ¤í¬í†± ì„œë¸Œíƒ­ ë°” ìˆ¨ê¸°ê¸°
                const subTabBar = document.getElementById('subTabBar');
                const shopSubTabs = document.getElementById('shopSubTabs');
                const journalSubTabs = document.getElementById('journalSubTabs');
                if (subTabBar) subTabBar.style.display = 'none';
                if (shopSubTabs) shopSubTabs.style.display = 'none';
                if (journalSubTabs) journalSubTabs.style.display = 'none';
                
                // ëª¨ë°”ì¼ ì„œë¸Œíƒ­ ë°” ìˆ¨ê¸°ê¸°
                const mobileSubTabBar = document.getElementById('mobileSubTabBar');
                const mobileShopSubTabs = document.getElementById('mobileShopSubTabs');
                const mobileJournalSubTabs = document.getElementById('mobileJournalSubTabs');
                if (mobileSubTabBar) mobileSubTabBar.style.display = 'none';
                if (mobileShopSubTabs) mobileShopSubTabs.style.display = 'none';
                if (mobileJournalSubTabs) mobileJournalSubTabs.style.display = 'none';
                
                // ì•ˆì „í•˜ê²Œ íƒ­ í™œì„±í™” (null ì²´í¬)
                const activateTab = (selector) => {
                    const tabEl = document.querySelector(selector);
                    if (tabEl) tabEl.classList.add('active');
                };
                
                if (tab === 'garden') {
                    activateTab('.desktop-tabs .tab:nth-child(1)');
                    document.getElementById('gardenSection')?.classList.add('active');
                    // ì§ˆë³‘ íŠœí† ë¦¬ì–¼: ìœ¡ì„± íƒ­ ì—´ê¸° ì•¡ì…˜ ì²´í¬
                    checkSickTutorialAction('openGarden');
                } else if (tab === 'terrarium') {
                    activateTab('.desktop-tabs .tab:nth-child(2)');
                    document.getElementById('terrariumSection')?.classList.add('active');
                    renderTerrariumManagement();
                } else if (tab === 'lab') {
                    activateTab('.desktop-tabs .tab:nth-child(3)');
                    document.getElementById('labSection')?.classList.add('active');
                    
                    // ë“œë¡­ë‹¤ìš´ UIë¥¼ ì „ì—­ë³€ìˆ˜ì™€ ë™ê¸°í™”
                    const categorySelect = document.getElementById('recipeFilterSelect');
                    const attrSelect = document.getElementById('recipeAttrFilter');
                    const qualitySelect = document.getElementById('recipeQualityFilter');
                    if (categorySelect) categorySelect.value = labCategoryFilter;
                    if (attrSelect) attrSelect.value = labAttrFilter;
                    if (qualitySelect) qualitySelect.value = labQualityFilter;
                    
                    renderRecipeList(labCategoryFilter, labAttrFilter, labQualityFilter);
                    updateLabUI();
                    checkRecipe();
                    // ì—°êµ¬ì‹¤ íŠœí† ë¦¬ì–¼: ì—°êµ¬ì‹¤ íƒ­ ì—´ê¸° ì•¡ì…˜ ì²´í¬
                    checkLabTutorialAction('openLab');
                } else if (tab === 'shop') {
                    activateTab('.desktop-tabs .tab:nth-child(4)');
                    document.getElementById('shopSection')?.classList.add('active');
                    
                    // ë°ìŠ¤í¬í†± ì„œë¸Œíƒ­ ë°” í‘œì‹œ ë° ìœ„ì¹˜ ì¡°ì •
                    if (subTabBar) {
                        subTabBar.style.display = 'block';
                        // ìƒì  íƒ­ ìœ„ì¹˜ì— ë§ì¶° ì„œë¸Œíƒ­ ìœ„ì¹˜ ì¡°ì • (í™”ë©´ í¬ê¸° ê³ ë ¤)
                        const shopTab = document.querySelector('.desktop-tabs .tab:nth-child(4)');
                        if (shopTab) {
                            const tabLeft = shopTab.offsetLeft;
                            const subTabWidth = 150; // ì„œë¸Œíƒ­ ì˜ˆìƒ ë„ˆë¹„
                            const windowWidth = window.innerWidth;
                            const maxPadding = Math.max(0, Math.min(tabLeft, windowWidth - subTabWidth - 50));
                            subTabBar.style.paddingLeft = maxPadding + 'px';
                        }
                    }
                    if (shopSubTabs) shopSubTabs.style.display = 'flex';
                    
                    // ëª¨ë°”ì¼ ì„œë¸Œíƒ­ ë°” í‘œì‹œ
                    if (mobileSubTabBar) mobileSubTabBar.style.display = 'flex';
                    if (mobileShopSubTabs) mobileShopSubTabs.style.display = 'flex';
                    
                    updateShopSubTabUI();
                    
                    try {
                        renderShop();
                    } catch (e) {
                        console.error('renderShop ì˜¤ë¥˜:', e);
                    }
                    // ì§ˆë³‘ íŠœí† ë¦¬ì–¼: ìƒì  íƒ­ ì—´ê¸° ì•¡ì…˜ ì²´í¬ + êµ¬ë§¤ íƒ­ìœ¼ë¡œ ì „í™˜
                    if (sickTutorialActive) {
                        try {
                            switchShopTab('buy');
                        } catch (e) {
                            console.error('switchShopTab ì˜¤ë¥˜:', e);
                        }
                    }
                    try {
                        checkSickTutorialAction('openShop');
                    } catch (e) {
                        console.error('checkSickTutorialAction ì˜¤ë¥˜:', e);
                    }
                } else if (tab === 'minigame') {
                    activateTab('.desktop-tabs .tab:nth-child(5)');
                    document.getElementById('minigameSection')?.classList.add('active');
                    // ë¯¸ë‹ˆê²Œì„ íƒ­ ì „í™˜ ì‹œ ê²Œì„ ì¤‘ì´ë©´ ì¼ì‹œì •ì§€
                    if (minigameActive) {
                        pauseMinigame();
                    }
                } else if (tab === 'encyclopedia') {
                    // ë„ê°ì€ ì¼ì§€ íƒ­ì˜ ì„œë¸Œíƒ­ìœ¼ë¡œ ì´ë™
                    activateTab('.desktop-tabs .tab:nth-child(6)');
                    document.getElementById('journalSection')?.classList.add('active');
                    
                    // ë°ìŠ¤í¬í†± ì„œë¸Œíƒ­ ë°” í‘œì‹œ ë° ìœ„ì¹˜ ì¡°ì • (í™”ë©´ í¬ê¸° ê³ ë ¤)
                    if (subTabBar) {
                        subTabBar.style.display = 'block';
                        const journalTab = document.querySelector('.desktop-tabs .tab:nth-child(6)');
                        if (journalTab) {
                            const tabLeft = journalTab.offsetLeft;
                            const subTabWidth = 350; // ì¼ì§€ ì„œë¸Œíƒ­ ì˜ˆìƒ ë„ˆë¹„ (5ê°œ)
                            const windowWidth = window.innerWidth;
                            const maxPadding = Math.max(0, Math.min(tabLeft, windowWidth - subTabWidth - 50));
                            subTabBar.style.paddingLeft = maxPadding + 'px';
                        }
                    }
                    if (journalSubTabs) journalSubTabs.style.display = 'flex';
                    
                    // ëª¨ë°”ì¼ ì„œë¸Œíƒ­ ë°” í‘œì‹œ
                    if (mobileSubTabBar) mobileSubTabBar.style.display = 'flex';
                    if (mobileJournalSubTabs) mobileJournalSubTabs.style.display = 'flex';
                    
                    switchJournalTab('encyclopedia');
                } else if (tab === 'album') {
                    // ì•¨ë²”ì€ ì¼ì§€ íƒ­ì˜ ì„œë¸Œíƒ­ìœ¼ë¡œ ì´ë™
                    activateTab('.desktop-tabs .tab:nth-child(6)');
                    document.getElementById('journalSection')?.classList.add('active');
                    
                    // ë°ìŠ¤í¬í†± ì„œë¸Œíƒ­ ë°” í‘œì‹œ ë° ìœ„ì¹˜ ì¡°ì • (í™”ë©´ í¬ê¸° ê³ ë ¤)
                    if (subTabBar) {
                        subTabBar.style.display = 'block';
                        const journalTab = document.querySelector('.desktop-tabs .tab:nth-child(6)');
                        if (journalTab) {
                            const tabLeft = journalTab.offsetLeft;
                            const subTabWidth = 350;
                            const windowWidth = window.innerWidth;
                            const maxPadding = Math.max(0, Math.min(tabLeft, windowWidth - subTabWidth - 50));
                            subTabBar.style.paddingLeft = maxPadding + 'px';
                        }
                    }
                    if (journalSubTabs) journalSubTabs.style.display = 'flex';
                    
                    // ëª¨ë°”ì¼ ì„œë¸Œíƒ­ ë°” í‘œì‹œ
                    if (mobileSubTabBar) mobileSubTabBar.style.display = 'flex';
                    if (mobileJournalSubTabs) mobileJournalSubTabs.style.display = 'flex';
                    
                    switchJournalTab('album');
                } else if (tab === 'journal') {
                    activateTab('.desktop-tabs .tab:nth-child(6)');
                    document.getElementById('journalSection')?.classList.add('active');
                    
                    // ë°ìŠ¤í¬í†± ì„œë¸Œíƒ­ ë°” í‘œì‹œ ë° ìœ„ì¹˜ ì¡°ì • (í™”ë©´ í¬ê¸° ê³ ë ¤)
                    if (subTabBar) {
                        subTabBar.style.display = 'block';
                        const journalTab = document.querySelector('.desktop-tabs .tab:nth-child(6)');
                        if (journalTab) {
                            const tabLeft = journalTab.offsetLeft;
                            const subTabWidth = 350;
                            const windowWidth = window.innerWidth;
                            const maxPadding = Math.max(0, Math.min(tabLeft, windowWidth - subTabWidth - 50));
                            subTabBar.style.paddingLeft = maxPadding + 'px';
                        }
                    }
                    if (journalSubTabs) journalSubTabs.style.display = 'flex';
                    
                    // ëª¨ë°”ì¼ ì„œë¸Œíƒ­ ë°” í‘œì‹œ
                    if (mobileSubTabBar) mobileSubTabBar.style.display = 'flex';
                    if (mobileJournalSubTabs) mobileJournalSubTabs.style.display = 'flex';
                    
                    // í˜„ì¬ ì„œë¸Œíƒ­ ìœ ì§€ ë˜ëŠ” ê¸°ë³¸ ë„ê° í‘œì‹œ
                    switchJournalTab(currentJournalTab || 'encyclopedia');
                    checkAchievements();
                    // íŠœí† ë¦¬ì–¼2: ì¼ì§€ íƒ­ ì—´ê¸° ì•¡ì…˜ ì²´í¬
                    checkTutorialAction('openJournal');
                } else if (tab === 'settings') {
                    // ì„¤ì •ì€ íƒ­ ë°”ì— ì—†ìœ¼ë¯€ë¡œ active ì²˜ë¦¬ ì•ˆí•¨
                    document.getElementById('settingsSection')?.classList.add('active');
                    updateSettingsInfo();
                }
                
                // ëª¨ë°”ì¼ ì •ë ¹ ìŠ¬ë¼ì´ë” ì¸ë””ì¼€ì´í„° ì—…ë°ì´íŠ¸
                updateSpiritSliderIndicator();
            } catch (error) {
                console.error('íƒ­ ì „í™˜ ì˜¤ë¥˜:', error);
                console.error('ì˜¤ë¥˜ ìŠ¤íƒ:', error.stack);
                // ê¸°ëŠ¥ì—ëŠ” ë¬¸ì œ ì—†ìœ¼ë¯€ë¡œ ì•Œë¦¼ í‘œì‹œí•˜ì§€ ì•ŠìŒ
            }
        }

        // ì„¤ì • ì •ë³´ ì—…ë°ì´íŠ¸
        function updateSettingsInfo() {
            // ë¼ì´íŠ¸ëª¨ë“œ í† ê¸€ ìƒíƒœ ì—…ë°ì´íŠ¸
            const lightToggle = document.getElementById('lightModeToggle');
            const lightSlider = document.getElementById('lightModeSlider');
            if (lightToggle) {
                lightToggle.checked = lightModeLocked;
                if (lightModeLocked) {
                    lightSlider.style.transform = 'translateX(28px)';
                    lightSlider.parentElement.style.backgroundColor = '#FFD700';
                } else {
                    lightSlider.style.transform = 'translateX(0)';
                    lightSlider.parentElement.style.backgroundColor = '#ccc';
                }
            }
            
            // ë‹¤í¬ëª¨ë“œ í† ê¸€ ìƒíƒœ ì—…ë°ì´íŠ¸
            const toggle = document.getElementById('darkModeToggle');
            const slider = document.getElementById('darkModeSlider');
            if (toggle) {
                toggle.checked = darkModeLocked;
                if (darkModeLocked) {
                    slider.style.transform = 'translateX(28px)';
                    slider.parentElement.style.backgroundColor = '#4CAF50';
                } else {
                    slider.style.transform = 'translateX(0)';
                    slider.parentElement.style.backgroundColor = '#ccc';
                }
            }
        }
        
        // ì´ë²¤íŠ¸ ì½”ë“œ ì‚¬ìš©
        async function redeemEventCode() {
            const input = document.getElementById('eventCodeInput');
            const code = input.value.trim();
            
            if (!code) {
                showNotification('âŒ ì´ë²¤íŠ¸ ì½”ë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”');
                return;
            }
            
            // ì •ë ¹ ìŠ¬ë¡¯ ì²´í¬
            if (spirits.length >= 6) {
                showNotification('âŒ ì •ì›ì´ ê°€ë“ ì°¼ìŠµë‹ˆë‹¤! (ìµœëŒ€ 6ë§ˆë¦¬)');
                return;
            }
            
            const decoded = decodeEventCode(code);
            
            if (!decoded) {
                showNotification('âŒ ìœ íš¨í•˜ì§€ ì•Šì€ ì´ë²¤íŠ¸ ì½”ë“œì…ë‹ˆë‹¤');
                return;
            }
            
            if (decoded.expired) {
                showNotification('âŒ ì´ë²¤íŠ¸ ê¸°ê°„ì´ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤');
                return;
            }
            
            const event = decoded.event;
            
            const confirmed = await showConfirm('ì´ë²¤íŠ¸ ì½”ë“œ ì‚¬ìš©',
                `${event.icon} ${event.name} ì•Œì„ ë°›ìœ¼ì‹œê² ìŠµë‹ˆê¹Œ?\n\n${event.desc}\n\nğŸ ì´ë²¤íŠ¸ ê¸°ê°„ ë™ì•ˆ ìƒì ì—ì„œ íŠ¹ë³„ ì•„ì´í…œì„ êµ¬ë§¤í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤!`);
            
            if (!confirmed) return;
            
            // ì´ë²¤íŠ¸ ì •ë ¹ ìƒì„±
            const newSpirit = createEventSpirit(decoded.eventType);
            if (!newSpirit) {
                showNotification('âŒ ì´ë²¤íŠ¸ ì •ë ¹ ìƒì„± ì‹¤íŒ¨');
                return;
            }
            
            spirits.push(newSpirit);
            
            // ì´ë²¤íŠ¸ í™œì„±í™” (ìƒì ì— ì•„ì´í…œ ì¶”ê°€)
            if (!activatedEvents) activatedEvents = [];
            if (!activatedEvents.includes(decoded.eventType)) {
                activatedEvents.push(decoded.eventType);
            }
            
            saveGame();
            renderSpirits();
            renderShop();
            
            input.value = '';
            showNotification(`ğŸ„ ${event.name} ì•Œì´ íƒœì–´ë‚¬ìŠµë‹ˆë‹¤! ìƒì ì—ì„œ ì´ë²¤íŠ¸ ì•„ì´í…œì„ í™•ì¸í•˜ì„¸ìš”!`);
            switchTab('garden');
        }
        
        // ë¼ì´íŠ¸ ëª¨ë“œ ê³ ì • í† ê¸€
        function toggleLightModeLock() {
            lightModeLocked = !lightModeLocked;
            
            // ë¼ì´íŠ¸ ëª¨ë“œ ê³ ì • ì‹œ ë‹¤í¬ ëª¨ë“œ ê³ ì • í•´ì œ
            if (lightModeLocked && darkModeLocked) {
                darkModeLocked = false;
                const darkSlider = document.getElementById('darkModeSlider');
                const darkToggle = document.getElementById('darkModeToggle');
                if (darkSlider) {
                    darkSlider.style.transform = 'translateX(0)';
                    darkSlider.parentElement.style.backgroundColor = '#ccc';
                }
                if (darkToggle) darkToggle.checked = false;
            }
            
            const slider = document.getElementById('lightModeSlider');
            if (lightModeLocked) {
                slider.style.transform = 'translateX(28px)';
                slider.parentElement.style.backgroundColor = '#FFD700';
                showNotification('â˜€ï¸ ë¼ì´íŠ¸ ëª¨ë“œê°€ ê³ ì •ë˜ì—ˆìŠµë‹ˆë‹¤');
            } else {
                slider.style.transform = 'translateX(0)';
                slider.parentElement.style.backgroundColor = '#ccc';
                showNotification('ğŸŒ“ ì¡°ëª…ì— ë”°ë¼ í…Œë§ˆê°€ ë³€ê²½ë©ë‹ˆë‹¤');
            }
            
            applyLightMode();
            saveGame();
        }
        
        // ë‹¤í¬ ëª¨ë“œ ê³ ì • í† ê¸€
        function toggleDarkModeLock() {
            darkModeLocked = !darkModeLocked;
            
            // ë‹¤í¬ ëª¨ë“œ ê³ ì • ì‹œ ë¼ì´íŠ¸ ëª¨ë“œ ê³ ì • í•´ì œ
            if (darkModeLocked && lightModeLocked) {
                lightModeLocked = false;
                const lightSlider = document.getElementById('lightModeSlider');
                const lightToggle = document.getElementById('lightModeToggle');
                if (lightSlider) {
                    lightSlider.style.transform = 'translateX(0)';
                    lightSlider.parentElement.style.backgroundColor = '#ccc';
                }
                if (lightToggle) lightToggle.checked = false;
            }
            
            const slider = document.getElementById('darkModeSlider');
            if (darkModeLocked) {
                slider.style.transform = 'translateX(28px)';
                slider.parentElement.style.backgroundColor = '#4CAF50';
                showNotification('ğŸŒ™ ë‹¤í¬ ëª¨ë“œê°€ ê³ ì •ë˜ì—ˆìŠµë‹ˆë‹¤');
            } else {
                slider.style.transform = 'translateX(0)';
                slider.parentElement.style.backgroundColor = '#ccc';
                showNotification('ğŸŒ“ ì¡°ëª…ì— ë”°ë¼ í…Œë§ˆê°€ ë³€ê²½ë©ë‹ˆë‹¤');
            }
            
            applyLightMode();
            saveGame();
        }
        
        // ===== ì—°êµ¬ì‹¤ í•©ì„± ì‹œìŠ¤í…œ í•¨ìˆ˜ =====
        
        // ì•„ì´í…œ ì•„ì´ì½˜ ê°€ì ¸ì˜¤ê¸°
        function getItemIcon(type, category) {
            if (category === 'food') {
                // í•©ì„± ì•„ì´í…œì¸ì§€ í™•ì¸
                if (SYNTH_ITEMS[type]) {
                    return SYNTH_ITEMS[type].icon;
                }
                // ê¸°ë³¸ ë¨¹ì´
                const icons = { fire: 'ğŸ”¥', water: 'ğŸ’§', wind: 'ğŸŒ¬ï¸', earth: 'ğŸŒ±', light: 'âœ¨', dark: 'ğŸŒ™' };
                return icons[type] || 'â“';
            } else if (category === 'decoration') {
                // í•©ì„± ë¯¸ë‹ˆì–´ì²˜ì¸ì§€ í™•ì¸
                if (SYNTH_ITEMS[type]) {
                    return SYNTH_ITEMS[type].icon;
                }
                // ê¸°ë³¸ ë¯¸ë‹ˆì–´ì²˜
                return DECORATION_TYPES[type]?.icon || 'â“';
            } else if (category === 'music') {
                return MUSIC_TYPES[type]?.icon || 'ğŸµ';
            }
            return 'â“';
        }
        
        // ì•„ì´í…œ ì´ë¦„ ê°€ì ¸ì˜¤ê¸°
        function getItemName(type, category) {
            if (category === 'food') {
                if (SYNTH_ITEMS[type]) {
                    return SYNTH_ITEMS[type].name;
                }
                return FOOD_NAMES[type] || type;
            } else if (category === 'decoration') {
                if (SYNTH_ITEMS[type]) {
                    return SYNTH_ITEMS[type].name;
                }
                return DECORATION_TYPES[type]?.name || type;
            } else if (category === 'music') {
                return MUSIC_TYPES[type]?.name || type;
            }
            return type;
        }
        
        // ì¸ë²¤í† ë¦¬ì—ì„œ ì•„ì´í…œ ê°œìˆ˜ ì„¸ê¸°
        function countInventoryItem(type, category) {
            let count = 0;
            if (category === 'food') {
                count = inventory.food.filter(f => f === type).length;
            } else if (category === 'decoration') {
                count = inventory.decorations.filter(d => d === type).length;
            } else if (category === 'music') {
                count = inventory.music ? inventory.music.filter(m => m === type).length : 0;
            }
            return count;
        }
        
        // ê°€ìš©ëŸ‰ ì²´í¬ (ìŠ¬ë¡¯ì— ì˜¬ë¦° ê²ƒ ì œì™¸)
        function getAvailableCount(type, category) {
            let count = countInventoryItem(type, category);
            
            // ìŠ¬ë¡¯ì— ê°™ì€ ì¬ë£Œê°€ ì˜¬ë¼ê°€ ìˆìœ¼ë©´ ë¹¼ê¸°
            if (labSlot1 && labSlot1.type === type && labSlot1.category === category) {
                count -= labSlot1.count;
            }
            if (labSlot2 && labSlot2.type === type && labSlot2.category === category) {
                count -= labSlot2.count;
            }
            
            return Math.max(0, count);
        }
        
        // ì—°êµ¬ì‹¤ ìŠ¬ë¡¯ ëª¨ë‹¬ ì—´ê¸°
        function openLabSlotModal(slotNum) {
            currentLabSlot = slotNum;
            
            // ì—°êµ¬ì‹¤ íŠœí† ë¦¬ì–¼: ìŠ¬ë¡¯ í´ë¦­ ì•¡ì…˜ ì²´í¬
            if (slotNum === 1) {
                checkLabTutorialAction('clickSlot1');
            }
            
            // ë¨¹ì´ì™€ ë¯¸ë‹ˆì–´ì²˜ ëª©ë¡ ìƒì„± (í˜„ì¬ ì¸ë²¤í† ë¦¬ ê¸°ì¤€)
            const foodCounts = {};
            inventory.food.forEach(f => {
                foodCounts[f] = (foodCounts[f] || 0) + 1;
            });
            
            const decoCounts = {};
            inventory.decorations.forEach(d => {
                decoCounts[d] = (decoCounts[d] || 0) + 1;
            });
            
            // ë‹¤ë¥¸ ìŠ¬ë¡¯ì— ì˜¬ë¦° ì¬ë£ŒëŠ” ê°€ìš©ëŸ‰ì—ì„œ ì œì™¸ (í˜„ì¬ ìŠ¬ë¡¯ì€ ë®ì–´ì“°ê¸° ë  ê²ƒì´ë¯€ë¡œ í¬í•¨)
            const otherSlot = currentLabSlot === 1 ? labSlot2 : labSlot1;
            if (otherSlot) {
                if (otherSlot.category === 'food') {
                    foodCounts[otherSlot.type] = (foodCounts[otherSlot.type] || 0) - otherSlot.count;
                    if (foodCounts[otherSlot.type] < 0) foodCounts[otherSlot.type] = 0;
                } else if (otherSlot.category === 'decoration') {
                    decoCounts[otherSlot.type] = (decoCounts[otherSlot.type] || 0) - otherSlot.count;
                    if (decoCounts[otherSlot.type] < 0) decoCounts[otherSlot.type] = 0;
                }
                // music ì¹´í…Œê³ ë¦¬ëŠ” ë ˆì½”ë“œ ì„¹ì…˜ì—ì„œ ë³„ë„ ì²˜ë¦¬
            }
            
            // ë ˆì‹œí”¼ì—ì„œ í•„ìš”í•œ ê°œìˆ˜ ê°€ì ¸ì˜¤ê¸° (í•œ ìŠ¬ë¡¯ë‹¹)
            // ê°™ì€ ì¬ë£Œë¼ë¦¬ í•©ì„±í•˜ëŠ” ë ˆì‹œí”¼ê°€ ìˆìœ¼ë©´ ê·¸ ê°œìˆ˜ ìš°ì„ 
            function getNeededCount(type, category) {
                const otherSlot = currentLabSlot === 1 ? labSlot2 : labSlot1;
                const isSameMaterial = otherSlot && otherSlot.type === type && otherSlot.category === category;
                
                let needed = 999;
                let sameMatRecipeCount = null;
                
                // ê°™ì€ ì¬ë£Œë¼ë¦¬ í•©ì„±í•˜ëŠ” ë ˆì‹œí”¼ í™•ì¸
                Object.values(RECIPES).forEach(recipe => {
                    if (recipe.ingredients.length === 2 &&
                        recipe.ingredients[0].type === type &&
                        recipe.ingredients[0].category === category &&
                        recipe.ingredients[1].type === type &&
                        recipe.ingredients[1].category === category) {
                        sameMatRecipeCount = recipe.ingredients[0].count;
                    }
                });
                
                // ê°™ì€ ì¬ë£Œ ì¡°í•©ì´ê±°ë‚˜, ìŠ¬ë¡¯1ì— ë„£ì„ ë•Œ ê°™ì€ì¬ë£Œ ë ˆì‹œí”¼ê°€ ìˆìœ¼ë©´ ê·¸ ê°œìˆ˜
                if (isSameMaterial && sameMatRecipeCount) {
                    needed = sameMatRecipeCount;
                } else if (!isSameMaterial && sameMatRecipeCount && currentLabSlot === 1) {
                    needed = sameMatRecipeCount;
                } else {
                    // ë‹¤ë¥¸ ì¬ë£Œ ì¡°í•© - ìµœì†Œ í•„ìš” ê°œìˆ˜
                    Object.values(RECIPES).forEach(recipe => {
                        recipe.ingredients.forEach(ing => {
                            if (ing.type === type && ing.category === category) {
                                needed = Math.min(needed, ing.count);
                            }
                        });
                    });
                }
                
                return needed === 999 ? 1 : needed;
            }
            
            let html = `
                <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 10000; display: flex; justify-content: center; align-items: center;" onclick="if(event.target === this) closeLabModal()">
                    <div style="background: var(--card); padding: 20px; max-width: 500px; width: 90%; max-height: 80vh; overflow-y: auto;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                            <h3 style="font-family: 'Nanum Myeongjo', serif; margin: 0; font-size: 1.1rem;">ì¬ë£Œ ì„ íƒ (ìŠ¬ë¡¯ ${slotNum})</h3>
                            <button onclick="closeLabModal()" style="background: none; border: none; font-size: 1.3rem; cursor: pointer;">âœ•</button>
                        </div>
                        
                        <div style="margin-bottom: 15px;">
                            <div style="font-weight: 600; margin-bottom: 8px; font-size: 0.95rem;">ğŸ ë¨¹ì´</div>
                            <div style="display: flex; flex-wrap: wrap; gap: 6px;">
            `;
            
            // ë¨¹ì´ ë²„íŠ¼ë“¤
            const foodOrder = ['fire', 'water', 'wind', 'earth', 'light', 'dark'];
            let hasFood = false;
            foodOrder.forEach(type => {
                const count = foodCounts[type] || 0;
                if (count > 0) {
                    hasFood = true;
                    const needed = getNeededCount(type, 'food');
                    const isInsufficient = count < needed;
                    if (isInsufficient) {
                        html += `
                            <button onclick="showNotification('âš ï¸ ${FOOD_NAMES[type]} ë¶€ì¡±! (ë³´ìœ : ${count}ê°œ, í•„ìš”: ${needed}ê°œ)')" style="padding: 8px 12px; border: 1px solid #e74c3c; background: var(--bg); cursor: pointer; display: flex; align-items: center; gap: 4px; opacity: 0.5; font-size: 0.85rem;">
                                ${getItemIcon(type, 'food')} ${FOOD_NAMES[type]} Ã—${count} <span style="color: #e74c3c; font-size: 0.7rem;">(${needed}ê°œ í•„ìš”)</span>
                            </button>
                        `;
                    } else {
                        html += `
                            <button onclick="selectLabItem('${type}', 'food')" style="padding: 8px 12px; border: 1px solid var(--border); background: var(--bg); cursor: pointer; display: flex; align-items: center; gap: 4px; font-size: 0.85rem;">
                                ${getItemIcon(type, 'food')} ${FOOD_NAMES[type]} Ã—${count}
                            </button>
                        `;
                    }
                }
            });
            
            // í•©ì„± ë¨¹ì´ë„ í‘œì‹œ
            Object.keys(SYNTH_ITEMS).forEach(type => {
                if (SYNTH_ITEMS[type].type === 'food') {
                    const count = foodCounts[type] || 0;
                    if (count > 0) {
                        hasFood = true;
                        html += `
                            <button onclick="selectLabItem('${type}', 'food')" style="padding: 8px 12px; border: 1px solid var(--border); background: var(--bg); cursor: pointer; display: flex; align-items: center; gap: 4px; font-size: 0.85rem;">
                                ${SYNTH_ITEMS[type].icon} ${SYNTH_ITEMS[type].name} Ã—${count}
                            </button>
                        `;
                    }
                }
            });
            
            if (!hasFood) {
                html += `<div style="color: #888; font-size: 0.85rem;">ë¨¹ì´ê°€ ì—†ìŠµë‹ˆë‹¤</div>`;
            }
            
            html += `
                            </div>
                        </div>
                        
                        <div>
                            <div style="font-weight: 600; margin-bottom: 8px; font-size: 0.95rem;">ğŸŒ³ ë¯¸ë‹ˆì–´ì²˜</div>
                            <div style="display: flex; flex-wrap: wrap; gap: 6px;">
            `;
            
            // ë¯¸ë‹ˆì–´ì²˜ ë²„íŠ¼ë“¤
            let hasDeco = false;
            Object.keys(decoCounts).forEach(type => {
                const count = decoCounts[type];
                const deco = DECORATION_TYPES[type] || SYNTH_ITEMS[type];
                if (deco && count > 0) {
                    hasDeco = true;
                    const needed = getNeededCount(type, 'decoration');
                    const isInsufficient = count < needed;
                    if (isInsufficient) {
                        html += `
                            <button onclick="showNotification('âš ï¸ ${deco.name} ë¶€ì¡±! (ë³´ìœ : ${count}ê°œ, í•„ìš”: ${needed}ê°œ)')" style="padding: 8px 12px; border: 1px solid #e74c3c; background: var(--bg); cursor: pointer; display: flex; align-items: center; gap: 4px; opacity: 0.5; font-size: 0.85rem;">
                                ${deco.icon} ${deco.name} Ã—${count} <span style="color: #e74c3c; font-size: 0.7rem;">(${needed}ê°œ í•„ìš”)</span>
                            </button>
                        `;
                    } else {
                        html += `
                            <button onclick="selectLabItem('${type}', 'decoration')" style="padding: 8px 12px; border: 1px solid var(--border); background: var(--bg); cursor: pointer; display: flex; align-items: center; gap: 4px; font-size: 0.85rem;">
                                ${deco.icon} ${deco.name} Ã—${count}
                            </button>
                        `;
                    }
                }
            });
            
            if (!hasDeco) {
                html += `<div style="color: #888; font-size: 0.85rem;">ë¯¸ë‹ˆì–´ì²˜ê°€ ì—†ìŠµë‹ˆë‹¤</div>`;
            }
            
            html += `
                            </div>
                        </div>
                        
                        <div style="margin-top: 15px;">
                            <div style="font-weight: 600; margin-bottom: 8px; font-size: 0.95rem;">ğŸµ ë ˆì½”ë“œ</div>
                            <div style="display: flex; flex-wrap: wrap; gap: 6px;">
            `;
            
            // ë ˆì½”ë“œ ì¹´ìš´íŠ¸
            const musicCounts = {};
            if (inventory.music) {
                inventory.music.forEach(m => {
                    musicCounts[m] = (musicCounts[m] || 0) + 1;
                });
            }
            
            // ë‹¤ë¥¸ ìŠ¬ë¡¯ì— ì˜¬ë¦° ë ˆì½”ë“œ ê°€ìš©ëŸ‰ì—ì„œ ì œì™¸
            if (otherSlot && otherSlot.category === 'music') {
                musicCounts[otherSlot.type] = (musicCounts[otherSlot.type] || 0) - otherSlot.count;
                if (musicCounts[otherSlot.type] < 0) musicCounts[otherSlot.type] = 0;
            }
            
            // ë ˆì½”ë“œ ë²„íŠ¼ë“¤ (ëª¨ë“  í‹°ì–´ í‘œì‹œ)
            let hasMusic = false;
            Object.keys(MUSIC_TYPES).forEach(type => {
                const count = musicCounts[type] || 0;
                if (count > 0) {
                    hasMusic = true;
                    const musicData = MUSIC_TYPES[type];
                    const needed = getNeededCount(type, 'music');
                    const isInsufficient = count < needed;
                    const tierLabel = musicData.tier === 1 ? '' : musicData.tier === 2 ? 'â˜…' : musicData.tier === 3 ? 'â˜…â˜…' : 'â˜…â˜…â˜…';
                    const tierColor = musicData.tier === 1 ? 'var(--border)' : musicData.tier === 2 ? '#3498db' : musicData.tier === 3 ? '#9b59b6' : '#ffd700';
                    
                    if (isInsufficient) {
                        html += `
                            <button onclick="showNotification('âš ï¸ ${musicData.name} ë¶€ì¡±! (ë³´ìœ : ${count}ê°œ, í•„ìš”: ${needed}ê°œ)')" style="padding: 8px 12px; border: 2px solid ${tierColor}; background: var(--bg); cursor: pointer; display: flex; align-items: center; gap: 4px; opacity: 0.5; font-size: 0.85rem;">
                                ${musicData.icon} ${musicData.name} Ã—${count} <span style="color: #e74c3c; font-size: 0.7rem;">(${needed}ê°œ í•„ìš”)</span>
                            </button>
                        `;
                    } else {
                        html += `
                            <button onclick="selectLabItem('${type}', 'music')" style="padding: 8px 12px; border: 2px solid ${tierColor}; background: var(--bg); cursor: pointer; display: flex; align-items: center; gap: 4px; font-size: 0.85rem;">
                                ${musicData.icon} ${musicData.name} ${tierLabel} Ã—${count}
                            </button>
                        `;
                    }
                }
            });
            
            if (!hasMusic) {
                html += `<div style="color: #888; font-size: 0.85rem;">ë ˆì½”ë“œê°€ ì—†ìŠµë‹ˆë‹¤</div>`;
            }
            
            html += `
                            </div>
                        </div>
                        
                        <div style="margin-top: 15px; text-align: center;">
                            <button onclick="clearLabSlot(${slotNum})" style="padding: 8px 16px; background: #e74c3c; color: white; border: none; cursor: pointer; font-size: 0.9rem;">ìŠ¬ë¡¯ ë¹„ìš°ê¸°</button>
                        </div>
                    </div>
                </div>
            `;
            
            // ëª¨ë‹¬ ì¶”ê°€
            const modal = document.createElement('div');
            modal.id = 'labModal';
            modal.innerHTML = html;
            document.body.appendChild(modal);
        }
        
        // ì—°êµ¬ì‹¤ ëª¨ë‹¬ ë‹«ê¸°
        function closeLabModal() {
            const modal = document.getElementById('labModal');
            if (modal) modal.remove();
        }
        
        // ì—°êµ¬ì‹¤ ìŠ¬ë¡¯ì— ì•„ì´í…œ ì„ íƒ
        function selectLabItem(type, category) {
            const totalCount = countInventoryItem(type, category);
            if (totalCount <= 0) {
                showNotification('í•´ë‹¹ ì•„ì´í…œì´ ì—†ìŠµë‹ˆë‹¤');
                closeLabModal();
                return;
            }
            
            // ë‹¤ë¥¸ ìŠ¬ë¡¯ì— ì´ë¯¸ ê°™ì€ ì¬ë£Œê°€ ìˆëŠ”ì§€ í™•ì¸
            const otherSlot = currentLabSlot === 1 ? labSlot2 : labSlot1;
            const isSameMaterial = otherSlot && otherSlot.type === type && otherSlot.category === category;
            
            // ê°€ìš©ëŸ‰ ê³„ì‚° (ë‹¤ë¥¸ ìŠ¬ë¡¯ì— ì˜¬ë¦° ê²ƒ ì œì™¸)
            let availableCount = totalCount;
            if (otherSlot && otherSlot.type === type && otherSlot.category === category) {
                availableCount -= otherSlot.count;
            }
            
            // ë ˆì‹œí”¼ì—ì„œ í•„ìš”í•œ ê°œìˆ˜ ì°¾ê¸°
            let neededCount = 999;
            let sameMatRecipeCount = null; // ê°™ì€ ì¬ë£Œë¼ë¦¬ í•©ì„±í•˜ëŠ” ë ˆì‹œí”¼ì˜ ê°œìˆ˜
            
            // ë¨¼ì € ê°™ì€ ì¬ë£Œë¼ë¦¬ í•©ì„±í•˜ëŠ” ë ˆì‹œí”¼ê°€ ìˆëŠ”ì§€ í™•ì¸
            Object.values(RECIPES).forEach(recipe => {
                if (recipe.ingredients.length === 2 &&
                    recipe.ingredients[0].type === type &&
                    recipe.ingredients[0].category === category &&
                    recipe.ingredients[1].type === type &&
                    recipe.ingredients[1].category === category) {
                    sameMatRecipeCount = recipe.ingredients[0].count;
                }
            });
            
            // ê°™ì€ ì¬ë£Œë¥¼ ìŠ¬ë¡¯2ì— ë„£ê±°ë‚˜, ìŠ¬ë¡¯1ì— ë„£ëŠ”ë° ê°™ì€ì¬ë£Œ ë ˆì‹œí”¼ê°€ ìˆìœ¼ë©´ ê·¸ ê°œìˆ˜ ì‚¬ìš©
            if (isSameMaterial && sameMatRecipeCount) {
                neededCount = sameMatRecipeCount;
            } else if (!isSameMaterial && sameMatRecipeCount && currentLabSlot === 1) {
                // ìŠ¬ë¡¯1ì— ë„£ì„ ë•Œ, ê°™ì€ ì¬ë£Œ ë ˆì‹œí”¼ê°€ ìˆìœ¼ë©´ ê·¸ ê°œìˆ˜ ì‚¬ìš© (ë‚˜ì¤‘ì— ê°™ì€ ì¬ë£Œ ë„£ì„ ìˆ˜ ìˆìœ¼ë¯€ë¡œ)
                neededCount = sameMatRecipeCount;
            } else {
                // ë‹¤ë¥¸ ì¬ë£Œ ì¡°í•© - ìµœì†Œ í•„ìš” ê°œìˆ˜ ì‚¬ìš©
                Object.values(RECIPES).forEach(recipe => {
                    recipe.ingredients.forEach(ing => {
                        if (ing.type === type && ing.category === category) {
                            neededCount = Math.min(neededCount, ing.count);
                        }
                    });
                });
            }
            
            if (neededCount === 999) neededCount = 1;
            
            // ì¬ë£Œ ë¶€ì¡± ì²´í¬ (ê°€ìš©ëŸ‰ ê¸°ì¤€)
            if (availableCount < neededCount) {
                const itemName = getItemName(type, category);
                showNotification(`âš ï¸ ${itemName} ë¶€ì¡±! (ì‚¬ìš© ê°€ëŠ¥: ${availableCount}ê°œ, í•„ìš”: ${neededCount}ê°œ)`);
                closeLabModal();
                return;
            }
            
            // í•„ìš” ê°œìˆ˜ë§Œí¼ ì„ íƒ
            let selectedCount = neededCount;
            
            // ê°™ì€ ì¬ë£Œë¥¼ ìŠ¬ë¡¯2ì— ë„£ì„ ë•Œ, ìŠ¬ë¡¯1ì˜ ê°œìˆ˜ê°€ ë‹¤ë¥´ë©´ ì¡°ì •
            if (isSameMaterial && currentLabSlot === 2 && otherSlot.count !== neededCount) {
                // ì´ ì¬ë£Œê°€ ì¶©ë¶„í•œì§€ ì²´í¬ (ì–‘ìª½ ìŠ¬ë¡¯ í•©ê³„)
                if (totalCount < neededCount * 2) {
                    const itemName = getItemName(type, category);
                    showNotification(`âš ï¸ ${itemName} ë¶€ì¡±! (ë³´ìœ : ${totalCount}ê°œ, í•„ìš”: ${neededCount * 2}ê°œ)`);
                    closeLabModal();
                    return;
                }
                
                // ìŠ¬ë¡¯1 ê°œìˆ˜ë§Œ ì¡°ì • (ì¸ë²¤í† ë¦¬ ì¡°ì‘ ì—†ìŒ)
                labSlot1 = { type, category, count: neededCount };
            }
            
            // ìŠ¬ë¡¯ì— ì •ë³´ë§Œ ê¸°ë¡ (ì¸ë²¤í† ë¦¬ ì°¨ê°ì€ í•©ì„± ì‹œì ì—)
            if (currentLabSlot === 1) {
                labSlot1 = { type, category, count: selectedCount };
                // ì—°êµ¬ì‹¤ íŠœí† ë¦¬ì–¼: ì¬ë£Œ1 ì„ íƒ ì•¡ì…˜ ì²´í¬
                checkLabTutorialAction('selectIngredient1');
                // ìŠ¬ë¡¯2 ìë™ ê°•ì¡° (íŠœí† ë¦¬ì–¼ ì§„í–‰ ì¤‘ì´ë©´)
                if (labTutorialActive && window.tutorialWaitingFor === null) {
                    setTimeout(() => {
                        window.tutorialWaitingFor = 'selectIngredient2';
                        highlightLabTutorialTarget('selectIngredient2');
                    }, 100);
                }
            } else {
                labSlot2 = { type, category, count: selectedCount };
                // ì—°êµ¬ì‹¤ íŠœí† ë¦¬ì–¼: ì¬ë£Œ2 ì„ íƒ ì•¡ì…˜ ì²´í¬
                checkLabTutorialAction('selectIngredient2');
                
                // ìŠ¬ë¡¯2ì— ë‹¤ë¥¸ ì¬ë£Œë¥¼ ë„£ì—ˆì„ ë•Œ, ìŠ¬ë¡¯1 ê°œìˆ˜ê°€ ë ˆì‹œí”¼ì™€ ë§ì§€ ì•Šìœ¼ë©´ ì¡°ì •
                if (labSlot1 && !isSameMaterial) {
                    // í˜„ì¬ ì¡°í•©ì— ë§ëŠ” ë ˆì‹œí”¼ ì°¾ê¸°
                    let correctSlot1Count = null;
                    Object.values(RECIPES).forEach(recipe => {
                        const ing1 = recipe.ingredients[0];
                        const ing2 = recipe.ingredients[1];
                        
                        // ìŠ¬ë¡¯1-ì¬ë£Œ1, ìŠ¬ë¡¯2-ì¬ë£Œ2 ë§¤ì¹­
                        if (labSlot1.type === ing1.type && labSlot1.category === ing1.category &&
                            type === ing2.type && category === ing2.category) {
                            correctSlot1Count = ing1.count;
                        }
                        // ìŠ¬ë¡¯1-ì¬ë£Œ2, ìŠ¬ë¡¯2-ì¬ë£Œ1 ë§¤ì¹­
                        if (labSlot1.type === ing2.type && labSlot1.category === ing2.category &&
                            type === ing1.type && category === ing1.category) {
                            correctSlot1Count = ing2.count;
                        }
                    });
                    
                    // ìŠ¬ë¡¯1 ê°œìˆ˜ê°€ ë ˆì‹œí”¼ì™€ ë‹¤ë¥´ë©´ ì¡°ì • (ì¸ë²¤í† ë¦¬ ì¡°ì‘ ì—†ì´)
                    if (correctSlot1Count !== null && labSlot1.count !== correctSlot1Count) {
                        labSlot1.count = correctSlot1Count;
                    }
                }
            }
            
            closeLabModal();
            updateLabUI();
            checkRecipe();
            renderInventory();
            saveGame();
        }
        
        // ìŠ¬ë¡¯ ë¹„ìš°ê¸° (ì¸ë²¤í† ë¦¬ ë³€ê²½ ì—†ìŒ - í•©ì„± ì „ê¹Œì§€ ì°¨ê° ì•ˆ í•¨)
        function clearLabSlot(slotNum) {
            if (slotNum === 1) {
                labSlot1 = null;
            } else {
                labSlot2 = null;
            }
            closeLabModal();
            updateLabUI();
            checkRecipe();
            renderInventory();
            saveGame();
        }
        
        // ì—°êµ¬ì‹¤ UI ì—…ë°ì´íŠ¸
        function updateLabUI() {
            const slot1El = document.getElementById('labSlot1');
            const slot2El = document.getElementById('labSlot2');
            
            if (slot1El) {
                if (labSlot1) {
                    slot1El.innerHTML = `
                        <div style="font-size: 1.3rem; margin-bottom: 1px;">${getItemIcon(labSlot1.type, labSlot1.category)}</div>
                        <div style="font-size: 0.6rem; color: var(--text); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 60px;">${getItemName(labSlot1.type, labSlot1.category)}</div>
                        <div style="font-size: 0.65rem; color: #888;">Ã—${labSlot1.count}</div>
                        <button onclick="event.stopPropagation(); clearLabSlotDirect(1)" style="position: absolute; top: 2px; right: 2px; width: 16px; height: 16px; border-radius: 50%; border: none; background: #e74c3c; color: white; font-size: 0.6rem; cursor: pointer; display: flex; align-items: center; justify-content: center; padding: 0;">âœ•</button>
                    `;
                    slot1El.style.borderStyle = 'solid';
                    slot1El.style.borderColor = '#9b59b6';
                    slot1El.style.position = 'relative';
                } else {
                    slot1El.innerHTML = `
                        <div style="font-size: 1.3rem; margin-bottom: 2px;">â•</div>
                        <div style="font-size: 0.65rem; color: #888;">ì¬ë£Œ1</div>
                    `;
                    slot1El.style.borderStyle = 'dashed';
                    slot1El.style.borderColor = 'var(--border)';
                }
            }
            
            if (slot2El) {
                if (labSlot2) {
                    slot2El.innerHTML = `
                        <div style="font-size: 1.3rem; margin-bottom: 1px;">${getItemIcon(labSlot2.type, labSlot2.category)}</div>
                        <div style="font-size: 0.6rem; color: var(--text); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 60px;">${getItemName(labSlot2.type, labSlot2.category)}</div>
                        <div style="font-size: 0.65rem; color: #888;">Ã—${labSlot2.count}</div>
                        <button onclick="event.stopPropagation(); clearLabSlotDirect(2)" style="position: absolute; top: 2px; right: 2px; width: 16px; height: 16px; border-radius: 50%; border: none; background: #e74c3c; color: white; font-size: 0.6rem; cursor: pointer; display: flex; align-items: center; justify-content: center; padding: 0;">âœ•</button>
                    `;
                    slot2El.style.borderStyle = 'solid';
                    slot2El.style.borderColor = '#9b59b6';
                    slot2El.style.position = 'relative';
                } else {
                    slot2El.innerHTML = `
                        <div style="font-size: 1.3rem; margin-bottom: 2px;">â•</div>
                        <div style="font-size: 0.65rem; color: #888;">ì¬ë£Œ2</div>
                    `;
                    slot2El.style.borderStyle = 'dashed';
                    slot2El.style.borderColor = 'var(--border)';
                }
            }
        }
        
        // ìŠ¬ë¡¯ ì§ì ‘ ë¹„ìš°ê¸° (ëª¨ë‹¬ ì—†ì´)
        function clearLabSlotDirect(slotNum) {
            // ìŠ¬ë¡¯ë§Œ ë¹„ìš°ê¸° (í˜„ì¬ ì‹œìŠ¤í…œì€ ìŠ¬ë¡¯ì— ì˜¬ë ¤ë„ ì¸ë²¤í† ë¦¬ì—ì„œ ì°¨ê° ì•ˆ í•¨)
            if (slotNum === 1) {
                labSlot1 = null;
            } else {
                labSlot2 = null;
            }
            
            updateLabUI();
            checkRecipe();
            renderInventory();
            saveGame();
        }
        
        // ë ˆì‹œí”¼ ì²´í¬
        function checkRecipe() {
            const resultSlot = document.getElementById('labResultSlot');
            const synthesizeBtn = document.getElementById('synthesizeBtn');
            const labMessage = document.getElementById('labMessage');
            
            if (!labSlot1 || !labSlot2) {
                if (resultSlot) {
                    resultSlot.innerHTML = `
                        <div style="font-size: 1.3rem; margin-bottom: 2px;">â“</div>
                        <div style="font-size: 0.65rem; color: #888;">ê²°ê³¼</div>
                    `;
                }
                if (synthesizeBtn) {
                    synthesizeBtn.disabled = true;
                    synthesizeBtn.style.opacity = '0.5';
                }
                if (labMessage) labMessage.textContent = 'ì¬ë£Œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”';
                return null;
            }
            
            // ë ˆì‹œí”¼ ë§¤ì¹­
            for (const [recipeId, recipe] of Object.entries(RECIPES)) {
                const ing1 = recipe.ingredients[0];
                const ing2 = recipe.ingredients[1];
                
                // ìŠ¬ë¡¯1-ì¬ë£Œ1, ìŠ¬ë¡¯2-ì¬ë£Œ2 ë§¤ì¹­ í™•ì¸
                const match1 = (labSlot1.type === ing1.type && labSlot1.category === ing1.category && labSlot1.count >= ing1.count) &&
                              (labSlot2.type === ing2.type && labSlot2.category === ing2.category && labSlot2.count >= ing2.count);
                
                // ìŠ¬ë¡¯1-ì¬ë£Œ2, ìŠ¬ë¡¯2-ì¬ë£Œ1 ë§¤ì¹­ í™•ì¸ (ìˆœì„œ ë°”ê¿”ì„œ)
                const match2 = (labSlot1.type === ing2.type && labSlot1.category === ing2.category && labSlot1.count >= ing2.count) &&
                              (labSlot2.type === ing1.type && labSlot2.category === ing1.category && labSlot2.count >= ing1.count);
                
                if (match1 || match2) {
                    // ë ˆì‹œí”¼ ë°œê²¬!
                    let resultIcon, resultName;
                    if (recipe.category === 'music') {
                        const musicItem = MUSIC_TYPES[recipe.result.type];
                        resultIcon = musicItem?.icon || 'ğŸµ';
                        resultName = musicItem?.name || recipe.result.type;
                    } else {
                        const resultItem = SYNTH_ITEMS[recipe.result.type];
                        resultIcon = resultItem?.icon || 'â“';
                        resultName = resultItem?.name || recipe.result.type;
                    }
                    const isDiscovered = discoveredRecipes.includes(recipeId);
                    
                    if (resultSlot) {
                        if (isDiscovered) {
                            // ë°œê²¬í•œ ë ˆì‹œí”¼ - ê²°ê³¼ë¬¼ í‘œì‹œ
                            resultSlot.innerHTML = `
                                <div style="font-size: 1.3rem; margin-bottom: 1px;">${resultIcon}</div>
                                <div style="font-size: 0.6rem; color: var(--text); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 60px;">${resultName}</div>
                                <div style="font-size: 0.65rem; color: #9b59b6;">Ã—${recipe.result.count}</div>
                            `;
                        } else {
                            // ë¯¸ë°œê²¬ ë ˆì‹œí”¼ - '?' í‘œì‹œ
                            resultSlot.innerHTML = `
                                <div style="font-size: 1.3rem; margin-bottom: 1px;">â“</div>
                                <div style="font-size: 0.6rem; color: #9b59b6;">ìƒˆ ë ˆì‹œí”¼!</div>
                                <div style="font-size: 0.65rem; color: #888;">Ã—?</div>
                            `;
                        }
                        resultSlot.style.borderColor = '#9b59b6';
                    }
                    if (synthesizeBtn) {
                        synthesizeBtn.disabled = false;
                        synthesizeBtn.style.opacity = '1';
                    }
                    if (labMessage) {
                        if (isDiscovered) {
                            labMessage.innerHTML = `<span style="color: #9b59b6;">âœ¨ í•©ì„± ê°€ëŠ¥!</span>`;
                        } else {
                            labMessage.innerHTML = `<span style="color: #9b59b6;">âœ¨ ìƒˆë¡œìš´ ë ˆì‹œí”¼ ë°œê²¬?!</span>`;
                        }
                    }
                    return recipeId;
                }
            }
            
            // ë§¤ì¹­ë˜ëŠ” ë ˆì‹œí”¼ ì—†ìŒ
            if (resultSlot) {
                resultSlot.innerHTML = `
                    <div style="font-size: 1.3rem; margin-bottom: 2px;">ğŸ’¨</div>
                    <div style="font-size: 0.65rem; color: #888;">ì‹¤íŒ¨</div>
                `;
                resultSlot.style.borderColor = 'var(--border)';
            }
            if (synthesizeBtn) {
                synthesizeBtn.disabled = true;
                synthesizeBtn.style.opacity = '0.5';
            }
            if (labMessage) {
                labMessage.textContent = 'ì´ ì¡°í•©ìœ¼ë¡œëŠ” ë§Œë“¤ ìˆ˜ ì—†ìŠµë‹ˆë‹¤';
            }
            return null;
        }
        
        // í•©ì„± ì‹¤í–‰
        function synthesize() {
            const recipeId = checkRecipe();
            if (!recipeId) {
                showNotification('í•©ì„±í•  ìˆ˜ ì—†ëŠ” ì¡°í•©ì…ë‹ˆë‹¤');
                return;
            }
            
            const recipe = RECIPES[recipeId];
            
            // ì¬ë£Œ ì°¨ê° (í•©ì„± ì‹œì ì— ì¸ë²¤í† ë¦¬ì—ì„œ ì œê±°)
            if (labSlot1) {
                if (labSlot1.category === 'food') {
                    for (let i = 0; i < labSlot1.count; i++) {
                        const idx = inventory.food.indexOf(labSlot1.type);
                        if (idx !== -1) inventory.food.splice(idx, 1);
                    }
                } else if (labSlot1.category === 'decoration') {
                    for (let i = 0; i < labSlot1.count; i++) {
                        const idx = inventory.decorations.indexOf(labSlot1.type);
                        if (idx !== -1) inventory.decorations.splice(idx, 1);
                    }
                } else if (labSlot1.category === 'music') {
                    for (let i = 0; i < labSlot1.count; i++) {
                        const idx = inventory.music.indexOf(labSlot1.type);
                        if (idx !== -1) inventory.music.splice(idx, 1);
                    }
                }
            }
            
            if (labSlot2) {
                if (labSlot2.category === 'food') {
                    for (let i = 0; i < labSlot2.count; i++) {
                        const idx = inventory.food.indexOf(labSlot2.type);
                        if (idx !== -1) inventory.food.splice(idx, 1);
                    }
                } else if (labSlot2.category === 'decoration') {
                    for (let i = 0; i < labSlot2.count; i++) {
                        const idx = inventory.decorations.indexOf(labSlot2.type);
                        if (idx !== -1) inventory.decorations.splice(idx, 1);
                    }
                } else if (labSlot2.category === 'music') {
                    for (let i = 0; i < labSlot2.count; i++) {
                        const idx = inventory.music.indexOf(labSlot2.type);
                        if (idx !== -1) inventory.music.splice(idx, 1);
                    }
                }
            }
            
            // ê²°ê³¼ë¬¼ ì¶”ê°€
            let resultIcon, resultName;
            if (recipe.category === 'music') {
                const musicItem = MUSIC_TYPES[recipe.result.type];
                resultIcon = musicItem?.icon || 'ğŸµ';
                resultName = musicItem?.name || recipe.result.type;
                for (let i = 0; i < recipe.result.count; i++) {
                    inventory.music.push(recipe.result.type);
                }
            } else {
                const resultItem = SYNTH_ITEMS[recipe.result.type];
                resultIcon = resultItem?.icon || 'â“';
                resultName = resultItem?.name || recipe.result.type;
                for (let i = 0; i < recipe.result.count; i++) {
                    if (resultItem.type === 'food') {
                        inventory.food.push(recipe.result.type);
                    } else if (resultItem.type === 'decoration') {
                        inventory.decorations.push(recipe.result.type);
                    }
                }
            }
            
            // ë ˆì‹œí”¼ ë°œê²¬ ê¸°ë¡
            if (!discoveredRecipes.includes(recipeId)) {
                discoveredRecipes.push(recipeId);
                // ì§ì ‘ ë°œê²¬í•œ ë ˆì‹œí”¼ë¡œë„ ê¸°ë¡ (ë ˆì‹œí”¼ë¶ìœ¼ë¡œ í•´ê¸ˆë˜ì§€ ì•Šì€ ê²½ìš°)
                if (!selfDiscoveredRecipes.includes(recipeId)) {
                    selfDiscoveredRecipes.push(recipeId);
                }
                checkAchievements(); // ë ˆì‹œí”¼ ì—…ì  ì²´í¬
            }
            
            // ìŠ¬ë¡¯ ì´ˆê¸°í™”
            labSlot1 = null;
            labSlot2 = null;
            
            // UI ì—…ë°ì´íŠ¸
            updateLabUI();
            checkRecipe();
            renderInventory();
            applyRecipeFilters(); // í˜„ì¬ í•„í„° ìœ ì§€í•˜ë©´ì„œ ë ˆì‹œí”¼ ëª©ë¡ ê°±ì‹ 
            saveGame();
            
            showNotification(`âœ¨ ${resultIcon} ${resultName} Ã—${recipe.result.count} í•©ì„± ì„±ê³µ!`);
            
            // ì—°êµ¬ì‹¤ íŠœí† ë¦¬ì–¼: í•©ì„± ì•¡ì…˜ ì²´í¬
            checkLabTutorialAction('synthesize');
        }
        
        // í•©ì„± ìˆ˜ëŸ‰ ì„ íƒ ëª¨ë‹¬ ì—´ê¸°
        let currentSynthRecipeId = null;
        let currentSynthMaxCount = 1;
        
        function openSynthesizeModal(recipeId, maxCount) {
            currentSynthRecipeId = recipeId;
            currentSynthMaxCount = maxCount;
            
            const recipe = RECIPES[recipeId];
            let resultIcon, resultName;
            if (recipe.category === 'music') {
                const musicItem = MUSIC_TYPES[recipe.result.type];
                resultIcon = musicItem?.icon || 'ğŸµ';
                resultName = musicItem?.name || recipe.result.type;
            } else {
                const resultItem = SYNTH_ITEMS[recipe.result.type];
                resultIcon = resultItem?.icon || 'â“';
                resultName = resultItem?.name || recipe.result.type;
            }
            
            const modal = document.createElement('div');
            modal.id = 'synthesizeModal';
            const zIndex = getNextZIndex();
            modal.style.cssText = `position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: ${zIndex}; display: flex; justify-content: center; align-items: center;`;
            modal.onclick = (e) => { if (e.target === modal) closeSynthesizeModal(); };
            
            modal.innerHTML = `
                <div style="background: var(--card); padding: 24px; border-radius: 12px; max-width: 350px; width: 90%; border: 2px solid var(--border);">
                    <div style="text-align: center; margin-bottom: 20px;">
                        <span style="font-size: 2.5rem;">${resultIcon}</span>
                        <h3 style="font-family: 'Nanum Myeongjo', serif; margin-top: 8px; font-size: 1.2rem;">${resultName} ì œì‘</h3>
                        <div style="font-size: 0.85rem; color: #888; margin-top: 4px;">1íšŒ ì œì‘ ì‹œ ${recipe.result.count}ê°œ íšë“</div>
                    </div>
                    
                    <div style="display: flex; align-items: center; justify-content: center; gap: 8px; margin-bottom: 20px;">
                        <button onclick="setSynthCount(1)" style="padding: 8px 12px; background: var(--bg); border: 1px solid var(--border); font-size: 0.85rem; cursor: pointer; border-radius: 4px;">ìµœì†Œ</button>
                        <button onclick="adjustSynthCount(-1)" style="width: 40px; height: 40px; background: var(--bg); border: 1px solid var(--border); font-size: 1.4rem; cursor: pointer; border-radius: 4px; display: flex; align-items: center; justify-content: center;">âˆ’</button>
                        <input type="number" id="synthCountInput" value="1" min="1" max="${maxCount}" 
                               style="width: 70px; height: 40px; text-align: center; font-size: 1.2rem; font-weight: 700; border: 2px solid #9b59b6; border-radius: 6px; background: var(--bg); color: var(--text);"
                               onchange="validateSynthCount()">
                        <button onclick="adjustSynthCount(1)" style="width: 40px; height: 40px; background: var(--bg); border: 1px solid var(--border); font-size: 1.4rem; cursor: pointer; border-radius: 4px; display: flex; align-items: center; justify-content: center;">+</button>
                        <button onclick="setSynthCount(${maxCount})" style="padding: 8px 12px; background: #27ae60; color: white; border: none; font-size: 0.85rem; cursor: pointer; border-radius: 4px; font-weight: 600;">ìµœëŒ€</button>
                    </div>
                    
                    <div id="synthPreview" style="background: var(--bg); padding: 12px; border-radius: 8px; margin-bottom: 16px; font-size: 0.9rem;">
                        <!-- ë¯¸ë¦¬ë³´ê¸° ë‚´ìš© -->
                    </div>
                    
                    <div style="display: flex; gap: 8px;">
                        <button onclick="closeSynthesizeModal()" style="flex: 1; padding: 12px; background: var(--bg); border: 1px solid var(--border); cursor: pointer; border-radius: 6px;">ì·¨ì†Œ</button>
                        <button onclick="executeSynthesize()" style="flex: 1; padding: 12px; background: #9b59b6; color: white; border: none; cursor: pointer; border-radius: 6px; font-weight: 600;">ğŸ”® ì œì‘</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            updateSynthPreview();
        }
        
        function closeSynthesizeModal() {
            const modal = document.getElementById('synthesizeModal');
            if (modal) modal.remove();
            currentSynthRecipeId = null;
        }
        
        function adjustSynthCount(delta) {
            const input = document.getElementById('synthCountInput');
            let value = parseInt(input.value) || 1;
            value = Math.max(1, Math.min(currentSynthMaxCount, value + delta));
            input.value = value;
            updateSynthPreview();
        }
        
        function setSynthCount(value) {
            const input = document.getElementById('synthCountInput');
            input.value = Math.max(1, Math.min(currentSynthMaxCount, value));
            updateSynthPreview();
        }
        
        function validateSynthCount() {
            const input = document.getElementById('synthCountInput');
            let value = parseInt(input.value) || 1;
            value = Math.max(1, Math.min(currentSynthMaxCount, value));
            input.value = value;
            updateSynthPreview();
        }
        
        function updateSynthPreview() {
            const preview = document.getElementById('synthPreview');
            if (!preview || !currentSynthRecipeId) return;
            
            const recipe = RECIPES[currentSynthRecipeId];
            let resultIcon, resultName;
            if (recipe.category === 'music') {
                const musicItem = MUSIC_TYPES[recipe.result.type];
                resultIcon = musicItem?.icon || 'ğŸµ';
                resultName = musicItem?.name || recipe.result.type;
            } else {
                const resultItem = SYNTH_ITEMS[recipe.result.type];
                resultIcon = resultItem?.icon || 'â“';
                resultName = resultItem?.name || recipe.result.type;
            }
            const count = parseInt(document.getElementById('synthCountInput').value) || 1;
            
            const ing1 = recipe.ingredients[0];
            const ing2 = recipe.ingredients[1];
            const ing1Name = getItemName(ing1.type, ing1.category);
            const ing2Name = getItemName(ing2.type, ing2.category);
            
            const totalResult = recipe.result.count * count;
            const totalIng1 = ing1.count * count;
            const totalIng2 = ing2.count * count;
            
            // ê°™ì€ ì¬ë£Œì¸ ê²½ìš° í•©ì³ì„œ í‘œì‹œ
            let ingredientsHtml = '';
            if (ing1.type === ing2.type && ing1.category === ing2.category) {
                // ê°™ì€ ì¬ë£Œë©´ í•©ì‚°
                ingredientsHtml = `<div>${ing1Name} Ã—${totalIng1 + totalIng2}</div>`;
            } else {
                // ë‹¤ë¥¸ ì¬ë£Œë©´ ë”°ë¡œ í‘œì‹œ
                ingredientsHtml = `
                    <div>${ing1Name} Ã—${totalIng1}</div>
                    <div>${ing2Name} Ã—${totalIng2}</div>
                `;
            }
            
            preview.innerHTML = `
                <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                    <span style="color: #888;">ì†Œëª¨ ì¬ë£Œ:</span>
                </div>
                <div style="margin-left: 10px; margin-bottom: 8px;">
                    ${ingredientsHtml}
                </div>
                <div style="border-top: 1px solid var(--border); padding-top: 8px; display: flex; justify-content: space-between; align-items: center;">
                    <span style="color: #888;">íšë“:</span>
                    <span style="font-weight: 700; color: #9b59b6; font-size: 1.1rem;">${resultIcon} ${resultName} Ã—${totalResult}</span>
                </div>
            `;
        }
        
        function executeSynthesize() {
            if (!currentSynthRecipeId) return;
            
            const count = parseInt(document.getElementById('synthCountInput').value) || 1;
            quickSynthesize(currentSynthRecipeId, count);
            closeSynthesizeModal();
        }
        
        // níšŒ ì¦‰ì‹œ í•©ì„± (ë‚´ë¶€ í•¨ìˆ˜)
        function quickSynthesize(recipeId, times) {
            const recipe = RECIPES[recipeId];
            if (!recipe) {
                showNotification('ë ˆì‹œí”¼ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
                return;
            }
            
            const ing1 = recipe.ingredients[0];
            const ing2 = recipe.ingredients[1];
            
            // ì¬ë£Œ ë³´ìœ ëŸ‰ ì²´í¬
            const ing1Count = countInventoryItem(ing1.type, ing1.category);
            const ing2Count = countInventoryItem(ing2.type, ing2.category);
            
            // ìµœëŒ€ í•©ì„± ê°€ëŠ¥ íšŸìˆ˜ ê³„ì‚° (ê°™ì€ ì¬ë£Œì¸ ê²½ìš° í•©ì‚°í•´ì„œ ê³„ì‚°)
            let maxCraftCount;
            if (ing1.type === ing2.type && ing1.category === ing2.category) {
                // ê°™ì€ ì¬ë£Œ: ì´ í•„ìš”ëŸ‰ìœ¼ë¡œ ê³„ì‚°
                const totalNeeded = ing1.count + ing2.count;
                maxCraftCount = Math.floor(ing1Count / totalNeeded);
            } else {
                // ë‹¤ë¥¸ ì¬ë£Œ: ê°ê° ê³„ì‚°
                const maxCraft1 = Math.floor(ing1Count / ing1.count);
                const maxCraft2 = Math.floor(ing2Count / ing2.count);
                maxCraftCount = Math.min(maxCraft1, maxCraft2);
            }
            
            // ì‹¤ì œ í•©ì„± íšŸìˆ˜
            const actualTimes = Math.min(times, maxCraftCount);
            
            if (actualTimes <= 0) {
                showNotification('âš ï¸ ì¬ë£Œê°€ ë¶€ì¡±í•©ë‹ˆë‹¤');
                return;
            }
            
            // ì¬ë£Œ ì°¨ê° (ê°™ì€ ì¬ë£Œì¸ ê²½ìš° í•©ì‚°í•´ì„œ ì°¨ê°)
            if (ing1.type === ing2.type && ing1.category === ing2.category) {
                // ê°™ì€ ì¬ë£Œ: í•©ì‚°í•´ì„œ í•œ ë²ˆì— ì°¨ê°
                const totalToRemove = (ing1.count + ing2.count) * actualTimes;
                if (ing1.category === 'food') {
                    for (let i = 0; i < totalToRemove; i++) {
                        const idx = inventory.food.indexOf(ing1.type);
                        if (idx !== -1) inventory.food.splice(idx, 1);
                    }
                } else if (ing1.category === 'decoration') {
                    for (let i = 0; i < totalToRemove; i++) {
                        const idx = inventory.decorations.indexOf(ing1.type);
                        if (idx !== -1) inventory.decorations.splice(idx, 1);
                    }
                } else if (ing1.category === 'music') {
                    for (let i = 0; i < totalToRemove; i++) {
                        const idx = inventory.music.indexOf(ing1.type);
                        if (idx !== -1) inventory.music.splice(idx, 1);
                    }
                }
            } else {
                // ë‹¤ë¥¸ ì¬ë£Œ: ê°ê° ì°¨ê°
                const ing1Total = ing1.count * actualTimes;
                const ing2Total = ing2.count * actualTimes;
                
                if (ing1.category === 'food') {
                    for (let i = 0; i < ing1Total; i++) {
                        const idx = inventory.food.indexOf(ing1.type);
                        if (idx !== -1) inventory.food.splice(idx, 1);
                    }
                } else if (ing1.category === 'decoration') {
                    for (let i = 0; i < ing1Total; i++) {
                        const idx = inventory.decorations.indexOf(ing1.type);
                        if (idx !== -1) inventory.decorations.splice(idx, 1);
                    }
                } else if (ing1.category === 'music') {
                    for (let i = 0; i < ing1Total; i++) {
                        const idx = inventory.music.indexOf(ing1.type);
                        if (idx !== -1) inventory.music.splice(idx, 1);
                    }
                }
                
                if (ing2.category === 'food') {
                    for (let i = 0; i < ing2Total; i++) {
                        const idx = inventory.food.indexOf(ing2.type);
                        if (idx !== -1) inventory.food.splice(idx, 1);
                    }
                } else if (ing2.category === 'decoration') {
                    for (let i = 0; i < ing2Total; i++) {
                        const idx = inventory.decorations.indexOf(ing2.type);
                        if (idx !== -1) inventory.decorations.splice(idx, 1);
                    }
                } else if (ing2.category === 'music') {
                    for (let i = 0; i < ing2Total; i++) {
                        const idx = inventory.music.indexOf(ing2.type);
                        if (idx !== -1) inventory.music.splice(idx, 1);
                    }
                }
            }
            
            // ê²°ê³¼ë¬¼ ì¶”ê°€
            const totalResult = recipe.result.count * actualTimes;
            
            // ê²°ê³¼ë¬¼ ì •ë³´ ê°€ì ¸ì˜¤ê¸° (ì¹´í…Œê³ ë¦¬ì— ë”°ë¼)
            let resultItem;
            let resultIcon, resultName;
            
            if (recipe.category === 'music') {
                resultItem = MUSIC_TYPES[recipe.result.type];
                resultIcon = resultItem?.icon || 'ğŸµ';
                resultName = resultItem?.name || recipe.result.type;
                for (let i = 0; i < totalResult; i++) {
                    inventory.music.push(recipe.result.type);
                }
            } else {
                resultItem = SYNTH_ITEMS[recipe.result.type];
                resultIcon = resultItem?.icon || 'â“';
                resultName = resultItem?.name || recipe.result.type;
                for (let i = 0; i < totalResult; i++) {
                    if (resultItem.type === 'food') {
                        inventory.food.push(recipe.result.type);
                    } else if (resultItem.type === 'decoration') {
                        inventory.decorations.push(recipe.result.type);
                    }
                }
            }
            
            // ë ˆì‹œí”¼ ë°œê²¬ ê¸°ë¡
            if (!discoveredRecipes.includes(recipeId)) {
                discoveredRecipes.push(recipeId);
                // ì§ì ‘ ë°œê²¬í•œ ë ˆì‹œí”¼ë¡œë„ ê¸°ë¡ (ë ˆì‹œí”¼ë¶ìœ¼ë¡œ í•´ê¸ˆë˜ì§€ ì•Šì€ ê²½ìš°)
                if (!selfDiscoveredRecipes.includes(recipeId)) {
                    selfDiscoveredRecipes.push(recipeId);
                }
                checkAchievements(); // ë ˆì‹œí”¼ ì—…ì  ì²´í¬
            }
            
            // ìŠ¬ë¡¯ ì´ˆê¸°í™” (í˜¹ì‹œ ë¬´ì–¸ê°€ ìˆì„ ê²½ìš°)
            labSlot1 = null;
            labSlot2 = null;
            
            // UI ì—…ë°ì´íŠ¸
            updateLabUI();
            checkRecipe();
            renderInventory();
            applyRecipeFilters(); // í˜„ì¬ í•„í„° ìœ ì§€í•˜ë©´ì„œ ë ˆì‹œí”¼ ëª©ë¡ ê°±ì‹ 
            saveGame();
            
            showNotification(`âœ¨ ${resultIcon} ${resultName} Ã—${totalResult} í•©ì„± ì„±ê³µ! (${actualTimes}íšŒ)`);
            
            // ì—°êµ¬ì‹¤ íŠœí† ë¦¬ì–¼: í•©ì„± ì•¡ì…˜ ì²´í¬
            checkLabTutorialAction('synthesize');
        }
        
        // ë ˆì‹œí”¼ ëª©ë¡ ë Œë”ë§
        function renderRecipeList(categoryFilter = 'all', attrFilter = 'all', qualityFilter = 'all') {
            const container = document.getElementById('recipeList');
            if (!container) return;
            
            let html = '';
            let filteredCount = 0;
            
            Object.entries(RECIPES).forEach(([recipeId, recipe]) => {
                // ë°œê²¬í•œ ë ˆì‹œí”¼ë§Œ í‘œì‹œ
                if (!discoveredRecipes.includes(recipeId)) return;
                
                // ê²°ê³¼ë¬¼ ì •ë³´ ê°€ì ¸ì˜¤ê¸° (ì¹´í…Œê³ ë¦¬ì— ë”°ë¼)
                let resultItem, resultIcon, resultName;
                if (recipe.category === 'music') {
                    resultItem = MUSIC_TYPES[recipe.result.type];
                    if (!resultItem) return;
                    resultIcon = resultItem.icon;
                    resultName = resultItem.name;
                } else {
                    resultItem = SYNTH_ITEMS[recipe.result.type];
                    if (!resultItem) return;
                    resultIcon = resultItem.icon;
                    resultName = resultItem.name;
                }
                
                // ì¹´í…Œê³ ë¦¬ í•„í„°
                if (categoryFilter !== 'all' && recipe.category !== categoryFilter) return;
                
                // ì†ì„± í•„í„°
                if (attrFilter !== 'all') {
                    if (attrFilter === 'all_attr') {
                        // ì „ì†ì„± ì•„ì´í…œë§Œ
                        if (resultItem.attr !== 'all') return;
                    } else {
                        // ë‹¨ì¼ ì†ì„± ë˜ëŠ” ë³µí•© ì†ì„±ì— í¬í•¨
                        const itemAttr = resultItem.attr;
                        const dualAttrs = resultItem.dualAttr || [];
                        if (itemAttr !== attrFilter && !dualAttrs.includes(attrFilter)) return;
                    }
                }
                
                // í’ˆì§ˆ í•„í„° (ë¯¸ë‹ˆì–´ì²˜ë§Œ í•´ë‹¹)
                if (qualityFilter !== 'all') {
                    if (resultItem.type === 'decoration') {
                        if (resultItem.quality !== qualityFilter) return;
                    } else {
                        // ë¨¹ì´ëŠ” í’ˆì§ˆì´ ì—†ìœ¼ë¯€ë¡œ í’ˆì§ˆ í•„í„° ì‹œ ì œì™¸
                        return;
                    }
                }
                
                filteredCount++;
                const ing1 = recipe.ingredients[0];
                const ing2 = recipe.ingredients[1];
                
                const ing1Name = getItemName(ing1.type, ing1.category);
                const ing2Name = getItemName(ing2.type, ing2.category);
                const ing1Icon = getItemIcon(ing1.type, ing1.category);
                const ing2Icon = getItemIcon(ing2.type, ing2.category);
                
                // ì¬ë£Œ ë³´ìœ ëŸ‰ ì²´í¬ (ê°™ì€ ì¬ë£Œì¸ ê²½ìš° í•©ì‚°í•´ì„œ ê³„ì‚°)
                const ing1Count = countInventoryItem(ing1.type, ing1.category);
                const ing2Count = countInventoryItem(ing2.type, ing2.category);
                
                let canCraft, maxCraftCount;
                if (ing1.type === ing2.type && ing1.category === ing2.category) {
                    // ê°™ì€ ì¬ë£Œ: ì´ í•„ìš”ëŸ‰ìœ¼ë¡œ ê³„ì‚°
                    const totalNeeded = ing1.count + ing2.count;
                    canCraft = ing1Count >= totalNeeded;
                    maxCraftCount = Math.floor(ing1Count / totalNeeded);
                } else {
                    // ë‹¤ë¥¸ ì¬ë£Œ: ê°ê° ê³„ì‚°
                    canCraft = ing1Count >= ing1.count && ing2Count >= ing2.count;
                    const maxCraft1 = Math.floor(ing1Count / ing1.count);
                    const maxCraft2 = Math.floor(ing2Count / ing2.count);
                    maxCraftCount = Math.min(maxCraft1, maxCraft2);
                }
                
                // íš¨ê³¼ í…ìŠ¤íŠ¸
                let effectText = '';
                if (recipe.category === 'music') {
                    effectText = resultItem.effect || '';
                } else if (resultItem.type === 'food') {
                    const effects = [];
                    if (resultItem.attrGain) {
                        if (resultItem.attr === 'all') {
                            effects.push(`ì „ì†ì„± +${resultItem.attrGain}`);
                        } else if (resultItem.attr === 'dual' && resultItem.dualAttr) {
                            effects.push(`${resultItem.dualAttr.join('+')} ê° +${resultItem.attrGain}`);
                        } else {
                            effects.push(`${resultItem.attr} +${resultItem.attrGain}`);
                        }
                    }
                    if (resultItem.affectionGain) effects.push(`ì• ì •ë„ +${resultItem.affectionGain}`);
                    if (resultItem.growthGain) effects.push(`ì„±ì¥ +${resultItem.growthGain}`);
                    effectText = effects.join(', ');
                } else if (resultItem.type === 'decoration') {
                    effectText = `${resultItem.attr} +${resultItem.power} (${resultItem.quality})`;
                }
                
                // ì¬ë£Œ ë³´ìœ ëŸ‰ í‘œì‹œ (ê°™ì€ ì¬ë£Œì¸ ê²½ìš° í•©ì³ì„œ í‘œì‹œ)
                let ingredientDisplay;
                if (ing1.type === ing2.type && ing1.category === ing2.category) {
                    // ê°™ì€ ì¬ë£Œ: í•©ì‚°í•´ì„œ í‘œì‹œ
                    const totalNeeded = ing1.count + ing2.count;
                    const statusColor = ing1Count >= totalNeeded ? '#27ae60' : '#e74c3c';
                    ingredientDisplay = `${ing1Icon} ${ing1Name} Ã—${totalNeeded} (<span style="color: ${statusColor};">${ing1Count}</span>)`;
                } else {
                    // ë‹¤ë¥¸ ì¬ë£Œ: ë”°ë¡œ í‘œì‹œ
                    const ing1Status = ing1Count >= ing1.count ? `<span style="color: #27ae60;">${ing1Count}</span>` : `<span style="color: #e74c3c;">${ing1Count}</span>`;
                    const ing2Status = ing2Count >= ing2.count ? `<span style="color: #27ae60;">${ing2Count}</span>` : `<span style="color: #e74c3c;">${ing2Count}</span>`;
                    ingredientDisplay = `${ing1Icon} ${ing1Name} Ã—${ing1.count} (${ing1Status}) + ${ing2Icon} ${ing2Name} Ã—${ing2.count} (${ing2Status})`;
                }
                
                // ê²°ê³¼ë¬¼ ë³´ìœ ëŸ‰
                const resultCategory = recipe.category === 'music' ? 'music' : (resultItem.type === 'decoration' ? 'decoration' : 'food');
                const resultCount = countInventoryItem(recipe.result.type, resultCategory);
                
                // ì§ì ‘ ë°œê²¬ vs ë ˆì‹œí”¼ë¶ í•´ê¸ˆ ì²´í¬
                const isSelfDiscovered = selfDiscoveredRecipes.includes(recipeId);
                const discoveryTag = isSelfDiscovered 
                    ? '<span style="font-size: 0.65rem; background: #27ae60; color: white; padding: 2px 5px; border-radius: 3px; margin-left: 6px;">âœ¨ì§ì ‘ë°œê²¬</span>'
                    : '<span style="font-size: 0.65rem; background: #888; color: white; padding: 2px 5px; border-radius: 3px; margin-left: 6px;">ğŸ“–ë ˆì‹œí”¼ë¶</span>';
                
                // ì œì‘ ë²„íŠ¼ (ì œì‘ ê°€ëŠ¥í•  ë•Œë§Œ)
                let craftButton = '';
                if (canCraft) {
                    craftButton = `
                        <div style="margin-top: 8px;" onclick="event.stopPropagation();">
                            <button onclick="openSynthesizeModal('${recipeId}', ${maxCraftCount})" style="width: 100%; padding: 8px; background: #9b59b6; color: white; border: none; font-size: 0.9rem; font-weight: 600; cursor: pointer;">
                                ğŸ”® ì œì‘í•˜ê¸° (ìµœëŒ€ ${maxCraftCount}íšŒ)
                            </button>
                        </div>
                    `;
                }
                
                // í‹°ì–´ í‘œì‹œ (ë ˆì½”ë“œ)
                const tierBadge = recipe.category === 'music' && resultItem.tier > 1 
                    ? `<span style="font-size: 0.65rem; background: ${resultItem.tier === 2 ? '#3498db' : resultItem.tier === 3 ? '#9b59b6' : '#ffd700'}; color: white; padding: 2px 5px; border-radius: 3px; margin-left: 6px;">Tier ${resultItem.tier}</span>`
                    : '';
                
                html += `
                    <div onclick="autoFillRecipe('${recipeId}')" style="background: var(--bg); border: 2px solid ${canCraft ? '#27ae60' : 'var(--border)'}; padding: 12px; cursor: pointer; transition: all 0.2s; ${canCraft ? 'box-shadow: 0 0 8px rgba(39, 174, 96, 0.3);' : ''}" 
                         onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(0,0,0,0.15)';" 
                         onmouseout="this.style.transform=''; this.style.boxShadow='${canCraft ? '0 0 8px rgba(39, 174, 96, 0.3)' : ''}';">
                        <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px; flex-wrap: wrap;">
                            <span style="font-size: 1.5rem;">${resultIcon}</span>
                            <span style="font-weight: 600;">${resultName}</span>
                            ${tierBadge}
                            ${discoveryTag}
                            <span style="color: #9b59b6; font-size: 0.85rem;">Ã—${recipe.result.count}</span>
                            <span style="color: #888; font-size: 0.75rem; margin-left: 4px;">(ë³´ìœ : ${resultCount})</span>
                            ${canCraft ? '<span style="margin-left: auto; font-size: 0.75rem; background: #27ae60; color: white; padding: 2px 6px;">ì œì‘ ê°€ëŠ¥</span>' : ''}
                        </div>
                        <div style="font-size: 0.85rem; color: #888; margin-bottom: 5px;">
                            ${ingredientDisplay}
                        </div>
                        <div style="font-size: 0.8rem; color: #9b59b6;">
                            íš¨ê³¼: ${effectText}
                        </div>
                        ${craftButton}
                        ${!canCraft ? `<div style="font-size: 0.75rem; color: #888; margin-top: 5px; text-align: center;">ğŸ‘† í´ë¦­í•˜ì—¬ ìë™ ë°°ì¹˜</div>` : ''}
                    </div>
                `;
            });
            
            const totalRecipes = Object.keys(RECIPES).length;
            
            // ë°œê²¬í•œ ë ˆì‹œí”¼ ìˆ«ìë¥¼ ìƒë‹¨ì— í‘œì‹œ
            const countDisplay = document.getElementById('recipeCountDisplay');
            if (countDisplay) {
                countDisplay.textContent = `${discoveredRecipes.length} / ${totalRecipes}`;
            }
            
            const noResultMsg = filteredCount === 0 && discoveredRecipes.length > 0 
                ? '<div style="color: #888; text-align: center; padding: 20px;">ì¡°ê±´ì— ë§ëŠ” ë ˆì‹œí”¼ê°€ ì—†ìŠµë‹ˆë‹¤.</div>'
                : '<div style="color: #888; text-align: center; padding: 20px;">ì•„ì§ ë°œê²¬í•œ ë ˆì‹œí”¼ê°€ ì—†ìŠµë‹ˆë‹¤.<br>ì¬ë£Œë¥¼ ì¡°í•©í•´ ìƒˆë¡œìš´ ë ˆì‹œí”¼ë¥¼ ë°œê²¬í•´ë³´ì„¸ìš”!</div>';
            
            container.innerHTML = html || noResultMsg;
        }
        
        // ë ˆì‹œí”¼ ìë™ ë°°ì¹˜
        function autoFillRecipe(recipeId) {
            const recipe = RECIPES[recipeId];
            if (!recipe) {
                showNotification('ë ˆì‹œí”¼ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
                return;
            }
            
            const ing1 = recipe.ingredients[0];
            const ing2 = recipe.ingredients[1];
            
            // ì¬ë£Œ ë³´ìœ ëŸ‰ ì²´í¬ (ê°™ì€ ì¬ë£Œì¸ ê²½ìš° í•©ì‚°í•´ì„œ ê³„ì‚°)
            const ing1Count = countInventoryItem(ing1.type, ing1.category);
            const ing2Count = countInventoryItem(ing2.type, ing2.category);
            
            let hasEnough;
            if (ing1.type === ing2.type && ing1.category === ing2.category) {
                // ê°™ì€ ì¬ë£Œ: ì´ í•„ìš”ëŸ‰ìœ¼ë¡œ ì²´í¬
                const totalNeeded = ing1.count + ing2.count;
                hasEnough = ing1Count >= totalNeeded;
                if (!hasEnough) {
                    const ing1Name = getItemName(ing1.type, ing1.category);
                    showNotification(`âš ï¸ ì¬ë£Œ ë¶€ì¡±: ${ing1Name} ${totalNeeded - ing1Count}ê°œ`);
                    return;
                }
            } else {
                // ë‹¤ë¥¸ ì¬ë£Œ: ê°ê° ì²´í¬
                hasEnough = ing1Count >= ing1.count && ing2Count >= ing2.count;
                if (!hasEnough) {
                    const ing1Name = getItemName(ing1.type, ing1.category);
                    const ing2Name = getItemName(ing2.type, ing2.category);
                    let missing = [];
                    if (ing1Count < ing1.count) missing.push(`${ing1Name} ${ing1.count - ing1Count}ê°œ`);
                    if (ing2Count < ing2.count) missing.push(`${ing2Name} ${ing2.count - ing2Count}ê°œ`);
                    showNotification(`âš ï¸ ì¬ë£Œ ë¶€ì¡±: ${missing.join(', ')}`);
                    return;
                }
            }
            
            // ìŠ¬ë¡¯ì— ì •ë³´ë§Œ ê¸°ë¡ (ì¸ë²¤í† ë¦¬ ì°¨ê°ì€ í•©ì„± ì‹œì ì—)
            labSlot1 = { type: ing1.type, category: ing1.category, count: ing1.count };
            labSlot2 = { type: ing2.type, category: ing2.category, count: ing2.count };
            
            // UI ì—…ë°ì´íŠ¸
            updateLabUI();
            checkRecipe();
            renderInventory();
            // í˜„ì¬ í•„í„° ìœ ì§€í•˜ë©´ì„œ ë ˆì‹œí”¼ ëª©ë¡ ê°±ì‹ 
            applyRecipeFilters();
            saveGame();
            
            // íŒì—… ì—†ì´ ì¡°ìš©íˆ ë°°ì¹˜ (UIë¡œ í™•ì¸ ê°€ëŠ¥)
        }
        
        // ë ˆì‹œí”¼ í•„í„° ì ìš©
        function applyRecipeFilters() {
            const categoryFilter = document.getElementById('recipeFilterSelect')?.value || 'all';
            const attrFilter = document.getElementById('recipeAttrFilter')?.value || 'all';
            const qualityFilter = document.getElementById('recipeQualityFilter')?.value || 'all';
            
            // ì „ì—­ ë³€ìˆ˜ì— ì €ì¥ (íƒ­ ì „í™˜ ì‹œ ìœ ì§€ìš©)
            labCategoryFilter = categoryFilter;
            labAttrFilter = attrFilter;
            labQualityFilter = qualityFilter;
            
            renderRecipeList(categoryFilter, attrFilter, qualityFilter);
        }
        
        // ë ˆì‹œí”¼ í•„í„° (í•˜ìœ„ í˜¸í™˜ì„±)
        function filterRecipes(filter) {
            document.getElementById('recipeFilterSelect').value = filter;
            applyRecipeFilters();
        }
        
        // ê²Œì„ ë°ì´í„° ë‚´ë³´ë‚´ê¸°
        function exportGameData() {
            const gameData = {
                version: '2.3.0',
                exportDate: new Date().toISOString(),
                spirits: spirits,
                collection: collection,
                encyclopedia: encyclopedia,
                encyclopediaDetails: encyclopediaDetails,
                inventory: inventory,
                coins: coins,
                totalEggsCreated: totalEggsCreated,
                terrarium: terrarium,
                installedDecorations: installedDecorations,
                lightMode: lightMode,
                isPaused: isPaused,
                darkModeLocked: darkModeLocked,
                lightModeLocked: lightModeLocked,
                lowSatisfactionStartTime: lowSatisfactionStartTime,
                discoveredRecipes: discoveredRecipes,
                purchasedRecipeBooks: purchasedRecipeBooks,
                selfDiscoveredRecipes: selfDiscoveredRecipes,
                lockedItems: lockedItems,
                activatedEvents: activatedEvents,
                hasVisitedShop: hasVisitedShop,
                currentTitle: currentTitle,
                achievements: achievements,
                claimedAchievementRewards: claimedAchievementRewards,
                lastGatherTime: lastGatherTime,
                currentGatherLocation: currentGatherLocation
                // labSlotì€ ì €ì¥í•˜ì§€ ì•ŠìŒ (ìƒˆ ì‹œìŠ¤í…œì—ì„œëŠ” í•©ì„± ì „ê¹Œì§€ ì¸ë²¤í† ë¦¬ ì°¨ê° ì•ˆ í•¨)
            };
            
            try {
                const json = JSON.stringify(gameData);
                const base64 = btoa(unescape(encodeURIComponent(json)));
                const code = 'SGDATA-' + base64;
                
                // ì½”ë“œ í‘œì‹œ ëª¨ë‹¬
                const modal = document.createElement('div');
                modal.id = 'exportCodeModal';
                const zIndex = getNextZIndex();
                modal.style.cssText = `position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: ${zIndex}; display: flex; justify-content: center; align-items: center;`;
                modal.innerHTML = `
                    <div style="background: var(--card); padding: 24px; border-radius: 12px; max-width: 500px; width: 90%; border: 1px solid var(--border);">
                        <h3 style="margin-bottom: 16px;">ğŸ“¤ ê²Œì„ ë°ì´í„° ë‚´ë³´ë‚´ê¸°</h3>
                        <p style="font-size: 0.9rem; color: #888; margin-bottom: 12px;">ì•„ë˜ ì½”ë“œë¥¼ ë³µì‚¬í•´ì„œ ì•ˆì „í•œ ê³³ì— ì €ì¥í•˜ì„¸ìš”.</p>
                        <div style="margin-bottom: 12px;">
                            <textarea id="exportCodeText" readonly style="width: 100%; height: 120px; padding: 10px; border: 1px solid var(--border); border-radius: 6px; background: var(--bg); color: var(--text); font-family: monospace; font-size: 0.75rem; resize: none; box-sizing: border-box;">${code}</textarea>
                        </div>
                        <div style="display: flex; gap: 8px; margin-bottom: 12px;">
                            <button onclick="copyExportCode()" style="flex: 1; padding: 12px; background: var(--water); color: white; border: none; border-radius: 6px; cursor: pointer;">
                                ğŸ“‹ ì½”ë“œ ë³µì‚¬
                            </button>
                            <button onclick="downloadExportCode()" style="flex: 1; padding: 12px; background: var(--earth); color: white; border: none; border-radius: 6px; cursor: pointer;">
                                ğŸ’¾ íŒŒì¼ë¡œ ì €ì¥
                            </button>
                        </div>
                        <p style="font-size: 0.8rem; color: #888; text-align: center; margin-bottom: 12px;">
                            ğŸ“Š ì •ë ¹: ${spirits.length}ë§ˆë¦¬ | ì•¨ë²”: ${collection.length}ë§ˆë¦¬ | ë ˆì‹œí”¼: ${discoveredRecipes.length}ê°œ | ğŸ’° ${coins}
                        </p>
                        <button onclick="closeExportCodeModal()" style="width: 100%; padding: 10px; background: var(--card); border: 1px solid var(--border); border-radius: 6px; cursor: pointer;">
                            ë‹«ê¸°
                        </button>
                    </div>
                `;
                document.body.appendChild(modal);
            } catch (e) {
                console.error('ë°ì´í„° ë‚´ë³´ë‚´ê¸° ì˜¤ë¥˜:', e);
                showNotification('âŒ ë°ì´í„° ë‚´ë³´ë‚´ê¸° ì‹¤íŒ¨');
            }
        }
        
        function copyExportCode() {
            const textarea = document.getElementById('exportCodeText');
            textarea.select();
            document.execCommand('copy');
            showNotification('ğŸ“‹ ì½”ë“œê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!');
        }
        
        function downloadExportCode() {
            const textarea = document.getElementById('exportCodeText');
            const code = textarea.value;
            const blob = new Blob([code], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `spirit-garden-backup-${new Date().toISOString().slice(0, 10)}.txt`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            showNotification('ğŸ’¾ íŒŒì¼ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!');
        }
        
        function closeExportCodeModal() {
            const modal = document.getElementById('exportCodeModal');
            if (modal) modal.remove();
        }
        
        // ê²Œì„ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°
        function importGameData() {
            const modal = document.createElement('div');
            modal.id = 'importCodeModal';
            const zIndex = getNextZIndex();
            modal.style.cssText = `position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: ${zIndex}; display: flex; justify-content: center; align-items: center;`;
            modal.innerHTML = `
                <div style="background: var(--card); padding: 24px; border-radius: 12px; max-width: 500px; width: 90%; border: 1px solid var(--border);">
                    <h3 style="margin-bottom: 16px;">ğŸ“¥ ê²Œì„ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°</h3>
                    <p style="font-size: 0.9rem; color: #888; margin-bottom: 12px;">ë°±ì—… ì½”ë“œë¥¼ ë¶™ì—¬ë„£ê±°ë‚˜ íŒŒì¼ì„ ì„ íƒí•˜ì„¸ìš”.</p>
                    <div style="margin-bottom: 12px;">
                        <textarea id="importCodeText" placeholder="SGDATA-ë¡œ ì‹œì‘í•˜ëŠ” ì½”ë“œë¥¼ ë¶™ì—¬ë„£ìœ¼ì„¸ìš”..." style="width: 100%; height: 120px; padding: 10px; border: 1px solid var(--border); border-radius: 6px; background: var(--bg); color: var(--text); font-family: monospace; font-size: 0.75rem; resize: none; box-sizing: border-box;"></textarea>
                    </div>
                    <div style="display: flex; gap: 8px; margin-bottom: 12px;">
                        <button onclick="executeImportCode()" style="flex: 1; padding: 12px; background: var(--water); color: white; border: none; border-radius: 6px; cursor: pointer;">
                            ğŸ“¥ ì½”ë“œë¡œ ë¶ˆëŸ¬ì˜¤ê¸°
                        </button>
                        <button onclick="importFromFile()" style="flex: 1; padding: 12px; background: var(--earth); color: white; border: none; border-radius: 6px; cursor: pointer;">
                            ğŸ“ íŒŒì¼ ì„ íƒ
                        </button>
                    </div>
                    <p style="font-size: 0.8rem; color: #e74c3c; text-align: center; margin-bottom: 12px;">
                        âš ï¸ í˜„ì¬ ë°ì´í„°ëŠ” ë®ì–´ì”Œì›Œì§‘ë‹ˆë‹¤!
                    </p>
                    <button onclick="closeImportCodeModal()" style="width: 100%; padding: 10px; background: var(--card); border: 1px solid var(--border); border-radius: 6px; cursor: pointer;">
                        ë‹«ê¸°
                    </button>
                </div>
            `;
            document.body.appendChild(modal);
        }
        
        function closeImportCodeModal() {
            const modal = document.getElementById('importCodeModal');
            if (modal) modal.remove();
        }
        
        async function executeImportCode() {
            const textarea = document.getElementById('importCodeText');
            const code = textarea.value.trim();
            
            if (!code) {
                showNotification('âŒ ì½”ë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”');
                return;
            }
            
            try {
                let gameData;
                
                if (code.startsWith('SGDATA-')) {
                    // ì½”ë“œ í˜•ì‹
                    const base64 = code.substring(7);
                    const json = decodeURIComponent(escape(atob(base64)));
                    gameData = JSON.parse(json);
                } else if (code.startsWith('{')) {
                    // JSON í˜•ì‹ (í•˜ìœ„ í˜¸í™˜)
                    gameData = JSON.parse(code);
                } else {
                    throw new Error('ì˜¬ë°”ë¥¸ í˜•ì‹ì´ ì•„ë‹™ë‹ˆë‹¤');
                }
                
                // ë°ì´í„° ìœ íš¨ì„± ê²€ì‚¬
                if (!gameData.spirits || !gameData.collection || !gameData.inventory) {
                    throw new Error('ì˜¬ë°”ë¥¸ ê²Œì„ ë°ì´í„°ê°€ ì•„ë‹™ë‹ˆë‹¤');
                }
                
                const confirmed = await showConfirm(
                    'ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°',
                    `ë°±ì—… ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ì‹œê² ìŠµë‹ˆê¹Œ?\n\në°±ì—… ì¼ì‹œ: ${new Date(gameData.exportDate).toLocaleString()}\nì •ë ¹ ìˆ˜: ${gameData.spirits.length}\nì•¨ë²”: ${gameData.collection.length}\në°œê²¬ ë ˆì‹œí”¼: ${(gameData.discoveredRecipes || []).length}ê°œ\nğŸ’° ${gameData.coins}\n\ní˜„ì¬ ë°ì´í„°ëŠ” ë®ì–´ì”Œì›Œì§‘ë‹ˆë‹¤.`
                );
                
                if (!confirmed) return;
                
                // ë°ì´í„° ë³µì›
                applyGameData(gameData);
                closeImportCodeModal();
                showNotification('âœ… ê²Œì„ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤');
                switchTab('garden');
            } catch (error) {
                console.error('ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸° ì˜¤ë¥˜:', error);
                showNotification('âŒ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨: ' + error.message);
            }
        }
        
        function importFromFile() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json,.txt';
            
            input.onchange = async (e) => {
                const file = e.target.files[0];
                if (!file) return;
                
                try {
                    const text = await file.text();
                    document.getElementById('importCodeText').value = text.trim();
                    showNotification('ğŸ“ íŒŒì¼ì„ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤. "ì½”ë“œë¡œ ë¶ˆëŸ¬ì˜¤ê¸°"ë¥¼ í´ë¦­í•˜ì„¸ìš”.');
                } catch (error) {
                    showNotification('âŒ íŒŒì¼ ì½ê¸° ì‹¤íŒ¨');
                }
            };
            
            input.click();
        }
        
        function applyGameData(gameData) {
            spirits = gameData.spirits || [];
            
            // ë¬¸ìì—´ idë¥¼ ìˆ«ì idë¡œ ë³€í™˜ (ì—°ëª¨ ì•Œ í˜¸í™˜ì„±)
            spirits.forEach(spirit => {
                if (typeof spirit.id === 'string') {
                    spirit.id = Date.now() + Math.floor(Math.random() * 10000);
                }
            });
            
            collection = gameData.collection || [];
            encyclopedia = gameData.encyclopedia || {};
            
            // ë„ê° ë°ì´í„° í˜•ì‹ í†µì¼ (ê°ì²´ â†’ ìˆ«ì)
            Object.keys(encyclopedia).forEach(key => {
                if (typeof encyclopedia[key] === 'object' && encyclopedia[key] !== null) {
                    encyclopedia[key] = encyclopedia[key].count || 1;
                }
            });
            
            // ===== ìŠ¤íƒ¯ íƒ€ì… ë§ˆì´ê·¸ë ˆì´ì…˜ (v41 ì´ì „ â†’ v41+) =====
            // ì´ì „ ë²„ì „: intelligent-low, intelligent-mid, intelligent-high
            // ìƒˆ ë²„ì „: intelligent
            const statLevelPattern = /^(intelligent|strong|beautiful)-(low|mid|high)$/;
            
            // ìœ¡ì„± ì¤‘ì¸ ì •ë ¹ ë§ˆì´ê·¸ë ˆì´ì…˜
            spirits.forEach(spirit => {
                if (spirit.evolutionType && statLevelPattern.test(spirit.evolutionType)) {
                    spirit.evolutionType = spirit.evolutionType.replace(/-(low|mid|high)$/, '');
                }
                if (spirit.evolutionData && spirit.evolutionData.type && statLevelPattern.test(spirit.evolutionData.type)) {
                    spirit.evolutionData.type = spirit.evolutionData.type.replace(/-(low|mid|high)$/, '');
                }
            });
            
            // ì•¨ë²” ë§ˆì´ê·¸ë ˆì´ì…˜
            collection.forEach(spirit => {
                if (spirit.type && statLevelPattern.test(spirit.type)) {
                    spirit.type = spirit.type.replace(/-(low|mid|high)$/, '');
                }
            });
            
            // ë„ê° ë§ˆì´ê·¸ë ˆì´ì…˜ (í‚¤ ë³€í™˜ ë° í•©ì‚°)
            const newEncyclopedia = {};
            Object.entries(encyclopedia).forEach(([key, count]) => {
                // í‚¤ì—ì„œ -low, -mid, -high ì œê±°
                // ì˜ˆ: intelligent-mid-fire-butterfly â†’ intelligent-fire-butterfly
                const newKey = key.replace(/-(low|mid|high)-/, '-');
                
                if (!newEncyclopedia[newKey]) {
                    newEncyclopedia[newKey] = 0;
                }
                newEncyclopedia[newKey] += count;
            });
            encyclopedia = newEncyclopedia;
            // ===== ë§ˆì´ê·¸ë ˆì´ì…˜ ë =====
            
            inventory = gameData.inventory || { food: [], music: [], decorations: [], medicine: [] };
            coins = gameData.coins || 0;
            totalEggsCreated = gameData.totalEggsCreated || 0;
            
            // ê¸°ì¡´ ë°ì´í„° í˜¸í™˜: totalEggsCreatedê°€ ì—†ìœ¼ë©´ ì•¨ë²”+í˜„ì¬ì •ë ¹ ìˆ˜ë¡œ ì¶”ì •
            if (gameData.totalEggsCreated === undefined) {
                totalEggsCreated = (collection.length || 0) + (spirits.length || 0);
            }
            
            terrarium = gameData.terrarium || { fire: 0, water: 0, wind: 0, earth: 0, light: 0, dark: 0 };
            installedDecorations = gameData.installedDecorations || [];
            lightMode = gameData.lightMode !== undefined ? gameData.lightMode : true;
            isPaused = gameData.isPaused || false;
            darkModeLocked = gameData.darkModeLocked || false;
            lightModeLocked = gameData.lightModeLocked || false;
            lowSatisfactionStartTime = gameData.lowSatisfactionStartTime || {};
            discoveredRecipes = gameData.discoveredRecipes || [];
            purchasedRecipeBooks = gameData.purchasedRecipeBooks || [];
            selfDiscoveredRecipes = gameData.selfDiscoveredRecipes || [];
            
            // ê¸°ì¡´ ë°ì´í„° í˜¸í™˜: selfDiscoveredRecipesê°€ ì—†ìœ¼ë©´ discoveredRecipesë¥¼ ë³µì‚¬
            // (ë ˆì‹œí”¼ë¶ ì‹œìŠ¤í…œ ë„ì… ì „ì— ë°œê²¬í•œ ë ˆì‹œí”¼ëŠ” ì§ì ‘ ë°œê²¬ìœ¼ë¡œ ê°„ì£¼)
            if (gameData.selfDiscoveredRecipes === undefined && discoveredRecipes.length > 0) {
                selfDiscoveredRecipes = [...discoveredRecipes];
            }
            
            lockedItems = gameData.lockedItems || { food: [], decorations: [], music: [] };
            if (!lockedItems.music) lockedItems.music = []; // ê¸°ì¡´ ì„¸ì´ë¸Œ í˜¸í™˜
            encyclopediaDetails = gameData.encyclopediaDetails || {};
            activatedEvents = gameData.activatedEvents || [];
            hasVisitedShop = gameData.hasVisitedShop || false;
            lastGatherTime = gameData.lastGatherTime || null;
            currentGatherLocation = gameData.currentGatherLocation || 'garden';
            currentTitle = gameData.currentTitle || 'none';
            achievements = gameData.achievements || {};
            claimedAchievementRewards = gameData.claimedAchievementRewards || [];
            
            // ìŠ¬ë¡¯ ë¹„ìš°ê¸° (í˜„ì¬ ì‹œìŠ¤í…œì€ ìŠ¬ë¡¯ì— ì˜¬ë ¤ë„ ì¸ë²¤í† ë¦¬ì—ì„œ ì°¨ê° ì•ˆ í•¨)
            labSlot1 = null;
            labSlot2 = null;
            
            // ì„¤ì¹˜ëœ ë¯¸ë‹ˆì–´ì²˜ë¡œ í™˜ê²½ ì¬ê³„ì‚°
            if (installedDecorations.length > 0) {
                recalculateTerrariumEnvironment();
            }
            
            // ê¸°ì¡´ ì •ë ¹ë“¤ì˜ ë§Œì¡±ë„ ì´ˆê¸°í™” ë° ë°°ê³ í”” íƒ€ì´ë¨¸ ë¦¬ì…‹
            const now = Date.now();
            spirits.forEach(spirit => {
                if (!spirit.satisfaction) {
                    spirit.satisfaction = 'mid';
                }
                // ë¶ˆëŸ¬ì˜¤ê¸° ì‹œ ë°°ê³ í”” íƒ€ì´ë¨¸ ë¦¬ì…‹ (ì˜¤í”„ë¼ì¸ ë™ì•ˆ ì£½ì§€ ì•Šë„ë¡)
                if (!spirit.isDead && !spirit.isCompleted) {
                    spirit.lastFed = now;
                }
                
                // hiddenAttributes 400 ìº¡ ë§ˆì´ê·¸ë ˆì´ì…˜ (v2.3.0+)
                if (spirit.hiddenAttributes) {
                    Object.keys(spirit.hiddenAttributes).forEach(attr => {
                        if (spirit.hiddenAttributes[attr] > 400) {
                            spirit.hiddenAttributes[attr] = 400;
                        }
                    });
                }
            });
            
            saveGame();
            
            // UI ìƒˆë¡œê³ ì¹¨
            renderSpirits();
            renderInventory();
            updateCoinDisplay();
            applyLightMode();
            updateSettingsInfo();
            renderRecipeList(); // ë ˆì‹œí”¼ ëª©ë¡ë„ ê°±ì‹ 
            checkAchievements(); // ì—…ì  ì²´í¬ (ê¸°ì¡´ ë°±ì—… ë°ì´í„°ì— ì—…ì ì´ ì—†ì„ ê²½ìš° ì¬ê³„ì‚°)
            
            // í˜„ì¬ ì¼ì§€ íƒ­ì´ ì—´ë ¤ìˆìœ¼ë©´ í•´ë‹¹ ì„œë¸Œíƒ­ë„ ê°±ì‹ 
            if (document.getElementById('journalSection')?.classList.contains('active')) {
                switchJournalTab(currentJournalTab || 'encyclopedia');
            }
            
            showNotification('ğŸ’¡ ì •ë ¹ë“¤ì˜ ë°°ê³ í”” ìƒíƒœê°€ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤!');
        }

        function recalculateTerrariumEnvironment() {
            // í™˜ê²½ ì´ˆê¸°í™”
            terrarium = {
                fire: 0,
                water: 0,
                wind: 0,
                earth: 0,
                light: 0,
                dark: 0
            };

            // ëª¨ë“  ë¯¸ë‹ˆì–´ì²˜ì˜ ì†ì„± í•©ê³„ ê³„ì‚°
            installedDecorations.forEach(deco => {
                // ë¬¸ìì—´ ë˜ëŠ” ê°ì²´ ëª¨ë‘ ì§€ì›
                const decoKey = typeof deco === 'string' ? deco : deco.type;
                const decoData = DECORATION_TYPES[decoKey] || SYNTH_ITEMS[decoKey];
                const eventItem = EVENT_ITEMS[decoKey];
                
                // ì¼ë°˜ ë¯¸ë‹ˆì–´ì²˜ ì²˜ë¦¬
                if (decoData) {
                    const attr = decoData.attr;
                    const power = decoData.power;
                    
                    if (attr === 'dual' && decoData.dualAttr) {
                        // ë³µí•© ì†ì„±: ë‘ ì†ì„± ëª¨ë‘ ì¦ê°€
                        decoData.dualAttr.forEach(dualAttr => {
                            terrarium[dualAttr] += power;
                        });
                    } else if (attr === 'all') {
                        // ì „ì†ì„±: ëª¨ë“  ì†ì„± ì¦ê°€
                        ['fire', 'water', 'wind', 'earth', 'light', 'dark'].forEach(allAttr => {
                            terrarium[allAttr] += power;
                        });
                    } else {
                        // ë‹¨ì¼ ì†ì„±
                        terrarium[attr] += power;
                    }
                }
                
                // ì´ë²¤íŠ¸ ë¯¸ë‹ˆì–´ì²˜ ì²˜ë¦¬ (effects ê°ì²´ ì‚¬ìš©)
                if (eventItem && eventItem.type === 'decoration' && eventItem.effects) {
                    Object.entries(eventItem.effects).forEach(([attr, power]) => {
                        if (terrarium.hasOwnProperty(attr) && power > 0) {
                            terrarium[attr] += power;
                        }
                    });
                }
            });
            
            // 3ë‹¨ê³„: ìµœëŒ€ê°’ 100ìœ¼ë¡œ ì œí•œ
            Object.keys(terrarium).forEach(attr => {
                terrarium[attr] = Math.min(100, terrarium[attr]);
            });
        }

        function toggleLight() {
            const now = Date.now();
            
            // í˜„ì¬ ì¡°ëª… ë³€ê²½ ê¸°ë¡
            lightToggleHistory.push(now);
            
            // 1ë¶„(60ì´ˆ) ì´ì „ ê¸°ë¡ ì œê±°
            lightToggleHistory = lightToggleHistory.filter(time => (now - time) < 60000);
            
            // 1ë¶„ ì´ë‚´ 5íšŒ ì´ìƒ ë³€ê²½ ì²´í¬
            const isSpamming = lightToggleHistory.length >= 5;
            
            lightMode = !lightMode;
            
            // ì •ë ¹ë“¤ ë°˜ì‘
            spirits.forEach(spirit => {
                if (!spirit.isDead && !spirit.isCompleted) {
                    if (isSpamming) {
                        // ì¡°ëª… ë‚¨ìš© ì‹œ í™”ë‚´ê±°ë‚˜ ì¶¤ì¶”ê¸°
                        const spamMessages = [
                            `${spirit.name}ì´(ê°€) ë‹¹ì‹ ì˜ ì¥ë‚œì— í™”ë¥¼ ëƒ…ë‹ˆë‹¤.`,
                            `${spirit.name}ì´(ê°€) ê²©í•œ ì¶¤ì„ ì¶¥ë‹ˆë‹¤.`,
                            `${spirit.name}ì´(ê°€) ì¡°ëª… ì¥ë‚œì— ì§œì¦ì„ ëƒ…ë‹ˆë‹¤.`,
                            `${spirit.name}ì´(ê°€) ì–´ì§€ëŸ¬ì›Œí•©ë‹ˆë‹¤!`
                        ];
                        spirit.status = spamMessages[Math.floor(Math.random() * spamMessages.length)];
                        
                        // ì¼ì§€ ì¶”ê°€
                        addLog(spirit, spirit.status);
                        
                        // ì• ì •ë„ -1
                        spirit.parameters.affection = Math.max(0, spirit.parameters.affection - 1);
                    } else {
                        // ì •ìƒì ì¸ ì¡°ëª… ì „í™˜ ë°˜ì‘
                        if (lightMode) {
                            // ì¡°ëª… ì¼œì§
                            spirit.status = `${spirit.name}ì´(ê°€) ê°‘ìê¸° ì£¼ë³€ì´ í™˜í•´ì ¸ ê¹œì§ ë†€ëë‹ˆë‹¤.`;
                        } else {
                            // ì¡°ëª… êº¼ì§
                            spirit.status = `${spirit.name}ì´(ê°€) ê°‘ìê¸° ì£¼ë³€ì´ ì–´ë‘ì›Œì ¸ ê¹œì§ ë†€ëë‹ˆë‹¤.`;
                        }
                        
                        // ì¼ì§€ ì¶”ê°€
                        addLog(spirit, spirit.status);
                    }
                }
            });
            
            applyLightMode();
            recalculateTerrariumEnvironment();
            saveGame();
            updateAllSpiritCards();
            if (document.getElementById('terrariumSection').classList.contains('active')) {
                renderTerrariumManagement();
            }
            
            if (isSpamming) {
                showNotification(lightMode ? 'â˜€ï¸ ì¡°ëª…ì„ ì¼°ìŠµë‹ˆë‹¤ (ì •ë ¹ì´ í™”ë¥¼ ëƒ…ë‹ˆë‹¤!)' : 'ğŸŒ™ ì¡°ëª…ì„ ê»ìŠµë‹ˆë‹¤ (ì •ë ¹ì´ í™”ë¥¼ ëƒ…ë‹ˆë‹¤!)');
            } else {
                showNotification(lightMode ? 'â˜€ï¸ ì¡°ëª…ì„ ì¼°ìŠµë‹ˆë‹¤' : 'ğŸŒ™ ì¡°ëª…ì„ ê»ìŠµë‹ˆë‹¤');
            }
            
            // íŠœí† ë¦¬ì–¼ ì•¡ì…˜ ì²´í¬
            checkTutorialAction('toggleLight');
        }

        function applyLightMode() {
            const lightIcon = document.getElementById('lightIcon');
            
            // ë‹¤í¬ëª¨ë“œ í´ë˜ìŠ¤ ì œê±°
            document.body.classList.remove('dark-mode');
            
            // ë¼ì´íŠ¸ ëª¨ë“œ ê³ ì •ì´ í™œì„±í™”ë˜ì–´ ìˆìœ¼ë©´
            if (lightModeLocked) {
                // í•­ìƒ ê¸°ë³¸ ë¼ì´íŠ¸ ëª¨ë“œ ìœ ì§€
                if (lightIcon) lightIcon.textContent = lightMode ? 'â˜€ï¸' : 'ğŸŒ™';
                return;
            }
            
            // ë‹¤í¬ ëª¨ë“œ ê³ ì •ì´ í™œì„±í™”ë˜ì–´ ìˆìœ¼ë©´
            if (darkModeLocked) {
                document.body.classList.add('dark-mode');
                if (lightIcon) lightIcon.textContent = lightMode ? 'â˜€ï¸' : 'ğŸŒ™';
                return;
            }
            
            // ë‘˜ ë‹¤ ê³ ì • ì•ˆ ë¨ - ì¡°ëª…ì— ë”°ë¼ í…Œë§ˆ ë³€ê²½
            if (lightMode) {
                if (lightIcon) lightIcon.textContent = 'â˜€ï¸';
            } else {
                document.body.classList.add('dark-mode');
                if (lightIcon) lightIcon.textContent = 'ğŸŒ™';
            }
        }
        
        // ì¼ì‹œì •ì§€ í† ê¸€
        function togglePause() {
            isPaused = !isPaused;
            const pauseBtn = document.getElementById('pauseBtn');
            
            if (isPaused) {
                pausedAt = Date.now(); // ì¼ì‹œì •ì§€ ì‹œì‘ ì‹œê°„ ê¸°ë¡
                if (pauseBtn) {
                    pauseBtn.textContent = 'â–¶ï¸';
                    pauseBtn.style.background = '#4CAF50';
                }
                showNotification('â¸ï¸ ê²Œì„ì´ ì¼ì‹œì •ì§€ë˜ì—ˆìŠµë‹ˆë‹¤');
            } else {
                if (pausedAt) {
                    const pausedDuration = Date.now() - pausedAt;
                    // ì¼ì‹œì •ì§€í–ˆë˜ ì‹œê°„ì„ ëˆ„ì 
                    totalPausedTime += pausedDuration;
                    
                    // ëª¨ë“  ì •ë ¹ì˜ lastInteraction ì‹œê°„ ë³´ì • (ì¼ì‹œì •ì§€ ì‹œê°„ë§Œí¼ ì•ìœ¼ë¡œ ë‹¹ê¹€)
                    spirits.forEach(spirit => {
                        if (spirit.lastInteraction) {
                            spirit.lastInteraction += pausedDuration;
                        }
                    });
                    
                    pausedAt = null;
                }
                if (pauseBtn) {
                    pauseBtn.textContent = 'â¸ï¸';
                    pauseBtn.style.background = '#ff9800';
                }
                showNotification('â–¶ï¸ ê²Œì„ì´ ì¬ê°œë˜ì—ˆìŠµë‹ˆë‹¤');
            }
            
            // ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
            updateGatherButton();
            updateAllSpiritCards();
            
            saveGame();
        }
        
        // ê²Œì„ ë¦¬ì…‹
        async function resetGame() {
            const confirm1 = await showConfirm(
                'ê²Œì„ ì´ˆê¸°í™”',
                'ì •ë§ë¡œ ê²Œì„ì„ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nëª¨ë“  ì •ë ¹, ë¯¸ë‹ˆì–´ì²˜, ë¨¹ì´, ìŒì•…, ì½”ì¸, ë„ê°ì´ ì‚­ì œë©ë‹ˆë‹¤.\nì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!'
            );
            
            if (!confirm1) {
                return;
            }
            
            const confirm2 = await showConfirm(
                'ìµœì¢… í™•ì¸',
                'ë‹¤ì‹œ í•œ ë²ˆ í™•ì¸í•©ë‹ˆë‹¤.\nì •ë§ë¡œ ëª¨ë“  ë°ì´í„°ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?'
            );
            
            if (!confirm2) {
                return;
            }
            
            // ëª¨ë“  ë°ì´í„° ì´ˆê¸°í™”
            spirits = [];
            collection = [];
            encyclopedia = {};
            inventory = {
                music: [],
                decorations: [],
                food: ['fire', 'fire', 'fire', 'water', 'water', 'water', 'wind', 'wind', 'wind', 'earth', 'earth', 'earth']
            };
            terrarium = {
                fire: 0,
                water: 0,
                wind: 0,
                earth: 0,
                light: 0,
                dark: 0
            };
            installedDecorations = [];
            lightMode = true;
            coins = 0;
            currentTitle = 'none';
            lastGatherTime = null;
            isPaused = false;
            pausedAt = null;
            totalPausedTime = 0;
            
            // ì¶”ê°€ ë³€ìˆ˜ ì´ˆê¸°í™”
            discoveredRecipes = [];
            purchasedRecipeBooks = [];
            selfDiscoveredRecipes = [];
            achievements = {};
            claimedAchievementRewards = [];
            labSlot1 = null;
            labSlot2 = null;
            lockedItems = { food: [], decorations: [], music: [] };
            activatedEvents = [];
            lowSatisfactionStartTime = {};
            hasVisitedShop = false;
            darkModeLocked = false;
            lightModeLocked = false;
            
            // localStorage ì‚­ì œ
            localStorage.removeItem('spiritGardenV2');
            localStorage.removeItem('spiritGarden_openingSeen'); // ì˜¤í”„ë‹ë„ ë‹¤ì‹œ ë³´ì´ê²Œ
            localStorage.removeItem('spiritGarden_tutorialSeen'); // íŠœí† ë¦¬ì–¼ë„ ë‹¤ì‹œ ë³´ì´ê²Œ
            localStorage.removeItem('spiritGarden_tutorial2Seen'); // íŠœí† ë¦¬ì–¼2ë„ ë‹¤ì‹œ ë³´ì´ê²Œ
            localStorage.removeItem('spiritGarden_labTutorialSeen'); // ì—°êµ¬ì‹¤ íŠœí† ë¦¬ì–¼ë„ ë‹¤ì‹œ ë³´ì´ê²Œ
            localStorage.removeItem('spiritGarden_sickTutorialSeen'); // ì§ˆë³‘ íŠœí† ë¦¬ì–¼ë„ ë‹¤ì‹œ ë³´ì´ê²Œ
            localStorage.removeItem('spiritGarden_imbalanceTutorialSeen'); // ë¶ˆê· í˜• íŠœí† ë¦¬ì–¼ë„ ë‹¤ì‹œ ë³´ì´ê²Œ
            
            // UI ì—…ë°ì´íŠ¸
            renderSpirits();
            renderInventory();
            renderShop();
            updateCoinDisplay();
            applyLightMode();
            renderEncyclopedia();
            renderCollection();
            renderRecipeList(); // ì—°êµ¬ì‹¤ ë ˆì‹œí”¼ ëª©ë¡ë„ ì´ˆê¸°í™”
            
            const titleSelect = document.getElementById('titleSelect');
            if (titleSelect) {
                titleSelect.value = 'none';
            }
            
            const pauseBtn = document.getElementById('pauseBtn');
            if (pauseBtn) {
                pauseBtn.textContent = 'â¸ï¸';
                pauseBtn.classList.remove('paused');
            }
            
            showNotification('ğŸ”„ ê²Œì„ì´ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤');
            
            // ìœ¡ì„± íƒ­ìœ¼ë¡œ ì´ë™ í›„ ì˜¤í”„ë‹ í‘œì‹œ (ì•½ê°„ì˜ ë”œë ˆì´)
            switchTab('garden');
            setTimeout(() => {
                console.log('ì˜¤í”„ë‹ í‘œì‹œ ì‹œë„...');
                showOpening();
            }, 500);
        }

        function renderTerrariumManagement() {
            // í™˜ê²½ ë°” ì—…ë°ì´íŠ¸ (ìµœëŒ€ 100)
            Object.entries(terrarium).forEach(([attr, value]) => {
                const bar = document.getElementById(`terr${attr.charAt(0).toUpperCase() + attr.slice(1)}Bar`);
                const valueSpan = document.getElementById(`terr${attr.charAt(0).toUpperCase() + attr.slice(1)}Value`);
                if (bar) bar.style.width = `${(value / 100) * 100}%`;
                if (valueSpan) valueSpan.textContent = value;
            });
            
            // í’ˆì§ˆ í•©ê³„ ì—…ë°ì´íŠ¸
            const qualityEl = document.getElementById('terrariumQuality');
            if (qualityEl) {
                const totalQuality = calculateTerrariumQuality();
                
                qualityEl.textContent = totalQuality.toFixed(0);
                
                // í’ˆì§ˆì— ë”°ë¥¸ ìƒ‰ìƒ ë³€ê²½
                // í’ˆì§ˆ ì ìˆ˜: ì¼ë°˜=1, í¬ê·€=3, ìµœìƒê¸‰=5, í•©ì„±=6, ì „ì„¤=7
                if (totalQuality >= 35) {
                    qualityEl.style.color = '#9c27b0'; // ë³´ë¼ (ì „ì„¤ 5ê°œ)
                } else if (totalQuality >= 21) {
                    qualityEl.style.color = '#4caf50'; // ì´ˆë¡ (ì „ì„¤ 3ê°œ)
                } else if (totalQuality >= 15) {
                    qualityEl.style.color = '#ff9800'; // ì£¼í™© (ìµœìƒê¸‰ 3ê°œ)
                } else {
                    qualityEl.style.color = '#f44336'; // ë¹¨ê°•
                }
            }

            // ì„¤ì¹˜ëœ ë¯¸ë‹ˆì–´ì²˜ ê°œìˆ˜ ì—…ë°ì´íŠ¸
            const installedCountEl = document.getElementById('installedCount');
            if (installedCountEl) {
                installedCountEl.textContent = `${installedDecorations.length} / 20`;
            }
            
            // ì „ì„¤ ë“±ê¸‰ ê°œìˆ˜ ì—…ë°ì´íŠ¸
            const legendaryCountEl = document.getElementById('legendaryCount');
            if (legendaryCountEl) {
                const legendaryCount = installedDecorations.filter(d => {
                    const type = typeof d === 'string' ? d : d.type;
                    const dData = DECORATION_TYPES[type] || SYNTH_ITEMS[type];
                    const eData = EVENT_ITEMS[type];
                    return (dData?.quality === 'legendary') || (eData?.quality === 'legendary');
                }).length;
                legendaryCountEl.textContent = legendaryCount;
                legendaryCountEl.style.color = legendaryCount >= 5 ? '#f44336' : '#9c27b0';
            }

            // ì„¤ì¹˜ëœ ë¯¸ë‹ˆì–´ì²˜ ëª©ë¡
            const installedContainer = document.getElementById('installedDecorList');
            if (installedDecorations.length === 0) {
                installedContainer.innerHTML = '<p style="color: #888; text-align: center; padding: 20px;">ì„¤ì¹˜ëœ ë¯¸ë‹ˆì–´ì²˜ê°€ ì—†ìŠµë‹ˆë‹¤</p>';
            } else {
                const installedCounts = {};
                installedDecorations.forEach(d => {
                    // ë¬¸ìì—´ ë˜ëŠ” ê°ì²´ ëª¨ë‘ ì§€ì›
                    const decoType = typeof d === 'string' ? d : d.type;
                    installedCounts[decoType] = (installedCounts[decoType] || 0) + 1;
                });

                // ì†ì„±ë³„, ì´ë¦„ë³„ë¡œ ì •ë ¬ (ìˆœì„œ ê³ ì •)
                const sortedEntries = Object.entries(installedCounts).sort((a, b) => {
                    const dataA = DECORATION_TYPES[a[0]] || SYNTH_ITEMS[a[0]] || EVENT_ITEMS[a[0]];
                    const dataB = DECORATION_TYPES[b[0]] || SYNTH_ITEMS[b[0]] || EVENT_ITEMS[b[0]];
                    if (!dataA || !dataB) return 0;
                    
                    // ì´ë²¤íŠ¸ ì•„ì´í…œì€ ë§¨ ìœ„ë¡œ
                    const isEventA = !!EVENT_ITEMS[a[0]];
                    const isEventB = !!EVENT_ITEMS[b[0]];
                    if (isEventA && !isEventB) return -1;
                    if (!isEventA && isEventB) return 1;
                    
                    if (!isEventA && !isEventB) {
                        // 1. ì†ì„±ë³„ ì •ë ¬
                        const attrOrder = { fire: 0, water: 1, wind: 2, earth: 3, light: 4, dark: 5 };
                        const attrDiff = (attrOrder[dataA.attr] || 0) - (attrOrder[dataB.attr] || 0);
                        if (attrDiff !== 0) return attrDiff;
                        
                        // 2. í’ˆì§ˆë³„ ì •ë ¬ (ë†’ì€ ìˆœ)
                        const qualityOrder = { legendary: 0, epic: 1, rare: 2, common: 3 };
                        const qualityDiff = (qualityOrder[dataA.quality] || 3) - (qualityOrder[dataB.quality] || 3);
                        if (qualityDiff !== 0) return qualityDiff;
                        
                        // 3. ì´ë¦„ë³„ ì •ë ¬
                        return dataA.name.localeCompare(dataB.name);
                    }
                    
                    return 0;
                });
                
                installedContainer.innerHTML = `
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                        ${sortedEntries.map(([key, count]) => {
                            // ì¼ë°˜/í•©ì„± ë¯¸ë‹ˆì–´ì²˜ ì²´í¬
                            const decoData = DECORATION_TYPES[key] || SYNTH_ITEMS[key];
                            if (decoData) {
                                const qualityLabel = decoData.quality === 'legendary' ? 'ğŸ‘‘' : decoData.quality === 'epic' ? 'â­' : decoData.quality === 'rare' ? 'ğŸ’' : '';
                                const isSynth = SYNTH_ITEMS[key] && !DECORATION_TYPES[key];
                                const qualityBorderColor = isSynth ? '#9b59b6' : (decoData.quality === 'legendary' ? '#ffd700' : decoData.quality === 'epic' ? '#9b59b6' : decoData.quality === 'rare' ? '#3498db' : 'var(--border)');
                                return `
                                    <div style="display: flex; align-items: center; justify-content: space-between; padding: 12px; background: var(--bg); border: 2px solid ${qualityBorderColor}; border-radius: 6px;">
                                        <div style="display: flex; align-items: center; gap: 8px;">
                                            <span style="font-size: 1.3rem;">${isSynth ? 'ğŸ”¬' : qualityLabel}${decoData.icon}</span>
                                            <div>
                                                <div style="font-weight: 700; font-size: 0.9rem;">${decoData.name} Ã—${count}${isSynth ? ' <span style="font-size: 0.7rem; color: #9b59b6;">í•©ì„±</span>' : ''}</div>
                                                <div style="font-size: 0.75rem; color: #888;">${decoData.attr} +${decoData.power}</div>
                                            </div>
                                        </div>
                                        <button onclick="removeDecorationFromTerrarium('${key}')" style="padding: 6px 10px; background: #dc3545; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.8rem;">
                                            íšŒìˆ˜
                                        </button>
                                    </div>
                                `;
                            }
                            
                            // ì´ë²¤íŠ¸ ë¯¸ë‹ˆì–´ì²˜ ì²´í¬
                            const eventItem = EVENT_ITEMS[key];
                            if (eventItem && eventItem.type === 'decoration') {
                                const qualityLabel = eventItem.quality === 'legendary' ? 'ğŸ‘‘' : eventItem.quality === 'epic' ? 'â­' : eventItem.quality === 'rare' ? 'ğŸ’' : '';
                                const qualityBorderColor = eventItem.quality === 'legendary' ? '#ffd700' : eventItem.quality === 'epic' ? '#9b59b6' : eventItem.quality === 'rare' ? '#3498db' : '#c41e3a';
                                // íš¨ê³¼ ì •ë³´ ìƒì„±
                                const effectsText = eventItem.effects ? Object.entries(eventItem.effects)
                                    .filter(([k, v]) => v > 0)
                                    .map(([k, v]) => {
                                        const attrNames = { fire: 'ğŸ”¥', water: 'ğŸ’§', wind: 'ğŸŒªï¸', earth: 'ğŸŒ±', light: 'âœ¨', dark: 'ğŸŒ™' };
                                        return `${attrNames[k] || k}+${v}`;
                                    }).join(' ') : 'íŠ¹ë³„ íš¨ê³¼';
                                return `
                                    <div style="display: flex; align-items: center; justify-content: space-between; padding: 12px; background: var(--bg); border: 2px solid ${qualityBorderColor}; border-radius: 6px;">
                                        <div style="display: flex; align-items: center; gap: 8px;">
                                            <span style="font-size: 1.3rem;">${qualityLabel}${eventItem.icon}</span>
                                            <div>
                                                <div style="font-weight: 700; font-size: 0.9rem;">${eventItem.name} Ã—${count}</div>
                                                <div style="font-size: 0.75rem; color: #888;">${effectsText}</div>
                                            </div>
                                        </div>
                                        <button onclick="removeDecorationFromTerrarium('${key}')" style="padding: 6px 10px; background: #dc3545; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.8rem;">
                                            íšŒìˆ˜
                                        </button>
                                    </div>
                                `;
                            }
                            
                            return '';
                        }).join('')}
                    </div>
                `;
            }

            // ì¸ë²¤í† ë¦¬ ë¯¸ë‹ˆì–´ì²˜ ëª©ë¡
            const listContainer = document.getElementById('terrariumDecorList');
            const filterArea = document.getElementById('terrariumFilterArea');
            if (!inventory.decorations) inventory.decorations = [];
            
            // í•„í„° UIë¥¼ ì˜¤ë¥¸ìª½ ìƒë‹¨ì— ë Œë”ë§
            if (filterArea) {
                filterArea.innerHTML = `
                    <select id="terrariumAttrFilter" onchange="setTerrariumFilter(this.value, 'attr')" style="padding: 6px 10px; border: 1px solid var(--border); background: var(--bg); font-size: 0.85rem;">
                        <option value="all" ${terrariumInvFilter === 'all' ? 'selected' : ''}>ì†ì„±</option>
                        <option value="event" ${terrariumInvFilter === 'event' ? 'selected' : ''}>ğŸ„ ì´ë²¤íŠ¸</option>
                        <option value="fire" ${terrariumInvFilter === 'fire' ? 'selected' : ''}>ğŸ”¥ ë¶ˆ</option>
                        <option value="water" ${terrariumInvFilter === 'water' ? 'selected' : ''}>ğŸ’§ ë¬¼</option>
                        <option value="wind" ${terrariumInvFilter === 'wind' ? 'selected' : ''}>ğŸŒªï¸ ë°”ëŒ</option>
                        <option value="earth" ${terrariumInvFilter === 'earth' ? 'selected' : ''}>ğŸŒ± ë•…</option>
                        <option value="light" ${terrariumInvFilter === 'light' ? 'selected' : ''}>âœ¨ ë¹›</option>
                        <option value="dark" ${terrariumInvFilter === 'dark' ? 'selected' : ''}>ğŸŒ™ ì–´ë‘ </option>
                    </select>
                    <select id="terrariumQualityFilterSelect" onchange="setTerrariumFilter(this.value, 'quality')" style="padding: 6px 10px; border: 1px solid var(--border); background: var(--bg); font-size: 0.85rem;">
                        <option value="all" ${terrariumQualityFilter === 'all' ? 'selected' : ''}>í’ˆì§ˆ</option>
                        <option value="common" ${terrariumQualityFilter === 'common' ? 'selected' : ''}>ì¼ë°˜</option>
                        <option value="rare" ${terrariumQualityFilter === 'rare' ? 'selected' : ''}>ğŸ’ í¬ê·€</option>
                        <option value="epic" ${terrariumQualityFilter === 'epic' ? 'selected' : ''}>â­ ìµœìƒê¸‰</option>
                        <option value="legendary" ${terrariumQualityFilter === 'legendary' ? 'selected' : ''}>ğŸ‘‘ ì „ì„¤</option>
                    </select>
                `;
            }
            
            if (inventory.decorations.length === 0) {
                listContainer.innerHTML = '<p style="color: #888; text-align: center; padding: 20px;">ë³´ìœ í•œ ë¯¸ë‹ˆì–´ì²˜ê°€ ì—†ìŠµë‹ˆë‹¤</p>';
                return;
            }

            const decorCounts = {};
            inventory.decorations.forEach(d => {
                decorCounts[d] = (decorCounts[d] || 0) + 1;
            });

            const canInstall = installedDecorations.length < 20;
            
            // ì „ì„¤ ë“±ê¸‰ í˜„ì¬ ê°œìˆ˜ ê³„ì‚°
            const legendaryCount = installedDecorations.filter(d => {
                const type = typeof d === 'string' ? d : d.type;
                const dData = DECORATION_TYPES[type] || SYNTH_ITEMS[type];
                const eData = EVENT_ITEMS[type];
                return (dData?.quality === 'legendary') || (eData?.quality === 'legendary');
            }).length;
            const canInstallLegendary = legendaryCount < 5;

            // ì†ì„±ë³„, í’ˆì§ˆë³„, ì´ë¦„ë³„ë¡œ ì •ë ¬ (ìˆœì„œ ê³ ì •)
            let sortedDecorEntries = Object.entries(decorCounts).sort((a, b) => {
                const dataA = DECORATION_TYPES[a[0]] || SYNTH_ITEMS[a[0]] || EVENT_ITEMS[a[0]];
                const dataB = DECORATION_TYPES[b[0]] || SYNTH_ITEMS[b[0]] || EVENT_ITEMS[b[0]];
                if (!dataA || !dataB) return 0;
                
                // ì´ë²¤íŠ¸ ì•„ì´í…œì€ ë§¨ ìœ„ë¡œ
                const isEventA = !!EVENT_ITEMS[a[0]];
                const isEventB = !!EVENT_ITEMS[b[0]];
                if (isEventA && !isEventB) return -1;
                if (!isEventA && isEventB) return 1;
                
                // ì¼ë°˜ ë¯¸ë‹ˆì–´ì²˜ ì •ë ¬
                if (!isEventA && !isEventB) {
                    // 1. ì†ì„±ë³„ ì •ë ¬
                    const attrOrder = { fire: 0, water: 1, wind: 2, earth: 3, light: 4, dark: 5 };
                    const attrDiff = (attrOrder[dataA.attr] || 0) - (attrOrder[dataB.attr] || 0);
                    if (attrDiff !== 0) return attrDiff;
                    
                    // 2. í’ˆì§ˆë³„ ì •ë ¬ (ë†’ì€ ìˆœ)
                    const qualityOrder = { legendary: 0, epic: 1, rare: 2, common: 3 };
                    const qualityDiff = (qualityOrder[dataA.quality] || 3) - (qualityOrder[dataB.quality] || 3);
                    if (qualityDiff !== 0) return qualityDiff;
                    
                    // 3. ì´ë¦„ë³„ ì •ë ¬
                    return dataA.name.localeCompare(dataB.name);
                }
                
                return 0;
            });
            
            // í•„í„° ì ìš©
            sortedDecorEntries = sortedDecorEntries.filter(([key, count]) => {
                const decoData = DECORATION_TYPES[key] || SYNTH_ITEMS[key];
                const eventItem = EVENT_ITEMS[key];
                const isEvent = !!eventItem;
                
                // ì†ì„± í•„í„°
                if (terrariumInvFilter !== 'all') {
                    if (terrariumInvFilter === 'event') {
                        if (!isEvent) return false;
                    } else {
                        if (isEvent) return false; // ì´ë²¤íŠ¸ ì•„ì´í…œì€ ì†ì„± í•„í„°ì—ì„œ ì œì™¸
                        if (decoData && decoData.attr !== terrariumInvFilter) return false;
                    }
                }
                
                // í’ˆì§ˆ í•„í„°
                if (terrariumQualityFilter !== 'all') {
                    if (isEvent) {
                        // ì´ë²¤íŠ¸ ì•„ì´í…œì€ ì „ì„¤ê¸‰ìœ¼ë¡œ ì·¨ê¸‰
                        if (terrariumQualityFilter !== 'legendary') return false;
                    } else {
                        if (decoData && decoData.quality !== terrariumQualityFilter) return false;
                    }
                }
                
                return true;
            });
            
            if (sortedDecorEntries.length === 0) {
                listContainer.innerHTML = '<p style="color: #888; text-align: center; padding: 20px;">ì¡°ê±´ì— ë§ëŠ” ë¯¸ë‹ˆì–´ì²˜ê°€ ì—†ìŠµë‹ˆë‹¤</p>';
                return;
            }

            listContainer.innerHTML = `
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                    ${sortedDecorEntries.map(([key, count]) => {
                        // ì¼ë°˜/í•©ì„± ë¯¸ë‹ˆì–´ì²˜ ì²´í¬
                        const decoData = DECORATION_TYPES[key] || SYNTH_ITEMS[key];
                        if (decoData) {
                            const qualityLabel = decoData.quality === 'legendary' ? 'ğŸ‘‘' : decoData.quality === 'epic' ? 'â­' : decoData.quality === 'rare' ? 'ğŸ’' : '';
                            const isLegendary = decoData.quality === 'legendary';
                            const canInstallThis = canInstall && (!isLegendary || canInstallLegendary);
                            const buttonText = !canInstall ? 'ê°€ë“' : (isLegendary && !canInstallLegendary) ? 'ì œí•œ' : 'ì„¤ì¹˜';
                            const isSynth = SYNTH_ITEMS[key] && !DECORATION_TYPES[key];
                            const qualityBorderColor = isSynth ? '#9b59b6' : (decoData.quality === 'legendary' ? '#ffd700' : decoData.quality === 'epic' ? '#9b59b6' : decoData.quality === 'rare' ? '#3498db' : 'var(--border)');
                            return `
                                <div style="display: flex; align-items: center; justify-content: space-between; padding: 12px; background: var(--bg); border: 2px solid ${qualityBorderColor}; border-radius: 6px;">
                                    <div style="display: flex; align-items: center; gap: 8px;">
                                        <span style="font-size: 1.3rem;">${isSynth ? 'ğŸ”¬' : qualityLabel}${decoData.icon}</span>
                                        <div>
                                            <div style="font-weight: 700; font-size: 0.9rem;">${decoData.name} Ã—${count}${isSynth ? ' <span style="font-size: 0.7rem; color: #9b59b6;">í•©ì„±</span>' : ''}</div>
                                            <div style="font-size: 0.75rem; color: #888;">${decoData.attr} +${decoData.power}</div>
                                        </div>
                                    </div>
                                    <button onclick="placeDecorationInTerrarium('${key}')" style="padding: 6px 10px; border: none; border-radius: 4px; cursor: pointer; font-size: 0.8rem;" ${!canInstallThis ? 'disabled' : ''}>
                                        ${buttonText}
                                    </button>
                                </div>
                            `;
                        }
                        
                        // ì´ë²¤íŠ¸ ë¯¸ë‹ˆì–´ì²˜ ì²´í¬ (ì „ì„¤ê¸‰ ì·¨ê¸‰)
                        const eventItem = EVENT_ITEMS[key];
                        if (eventItem && eventItem.type === 'decoration') {
                            const qualityLabel = eventItem.quality === 'legendary' ? 'ğŸ‘‘' : eventItem.quality === 'epic' ? 'â­' : eventItem.quality === 'rare' ? 'ğŸ’' : '';
                            const qualityBorderColor = eventItem.quality === 'legendary' ? '#ffd700' : eventItem.quality === 'epic' ? '#9b59b6' : eventItem.quality === 'rare' ? '#3498db' : '#c41e3a';
                            // íš¨ê³¼ ì •ë³´ ìƒì„±
                            const effectsText = eventItem.effects ? Object.entries(eventItem.effects)
                                .filter(([k, v]) => v > 0)
                                .map(([k, v]) => {
                                    const attrNames = { fire: 'ğŸ”¥', water: 'ğŸ’§', wind: 'ğŸŒªï¸', earth: 'ğŸŒ±', light: 'âœ¨', dark: 'ğŸŒ™' };
                                    return `${attrNames[k] || k}+${v}`;
                                }).join(' ') : 'íŠ¹ë³„ íš¨ê³¼';
                            const isEventLegendary = eventItem.quality === 'legendary';
                            const canInstallThis = canInstall && (!isEventLegendary || canInstallLegendary);
                            const buttonText = !canInstall ? 'ê°€ë“' : (isEventLegendary && !canInstallLegendary) ? 'ì œí•œ' : 'ì„¤ì¹˜';
                            return `
                                <div style="display: flex; align-items: center; justify-content: space-between; padding: 12px; background: var(--bg); border: 2px solid ${qualityBorderColor}; border-radius: 6px;">
                                    <div style="display: flex; align-items: center; gap: 8px;">
                                        <span style="font-size: 1.3rem;">${qualityLabel}${eventItem.icon}</span>
                                        <div>
                                            <div style="font-weight: 700; font-size: 0.9rem;">${eventItem.name} Ã—${count}</div>
                                            <div style="font-size: 0.75rem; color: #888;">${effectsText}</div>
                                        </div>
                                    </div>
                                    <button onclick="placeDecorationInTerrarium('${key}')" style="padding: 6px 10px; border: none; border-radius: 4px; cursor: pointer; font-size: 0.8rem;" ${!canInstallThis ? 'disabled' : ''}>
                                        ${buttonText}
                                    </button>
                                </div>
                            `;
                        }
                        
                        return '';
                    }).join('')}
                </div>
            `;
        }
        
        function setTerrariumFilter(value, type) {
            if (type === 'attr') {
                terrariumInvFilter = value;
            } else if (type === 'quality') {
                terrariumQualityFilter = value;
            }
            renderTerrariumManagement();
        }

        function placeDecorationInTerrarium(decorationType) {
            if (!inventory.decorations) inventory.decorations = [];
            
            // ìµœëŒ€ 20ê°œ ì²´í¬
            if (installedDecorations.length >= 20) {
                showNotification('í…Œë¼ë¦¬ì›€ì´ ê°€ë“ ì°¼ìŠµë‹ˆë‹¤ (ìµœëŒ€ 20ê°œ)');
                return;
            }

            const invIndex = inventory.decorations.indexOf(decorationType);
            if (invIndex === -1) return;

            const decoData = DECORATION_TYPES[decorationType];
            const eventItem = EVENT_ITEMS[decorationType];
            const synthItem = SYNTH_ITEMS[decorationType];
            
            if (!decoData && !eventItem && !synthItem) return;
            
            // ì „ì„¤ ë“±ê¸‰ ë¯¸ë‹ˆì–´ì²˜ ìµœëŒ€ 5ê°œ ì œí•œ
            const itemQuality = decoData?.quality || eventItem?.quality || null;
            if (itemQuality === 'legendary') {
                const legendaryCount = installedDecorations.filter(d => {
                    const type = typeof d === 'string' ? d : d.type;
                    const dData = DECORATION_TYPES[type];
                    const eData = EVENT_ITEMS[type];
                    return (dData?.quality === 'legendary') || (eData?.quality === 'legendary');
                }).length;
                
                if (legendaryCount >= 5) {
                    showNotification('ğŸ‘‘ ì „ì„¤ ë“±ê¸‰ ë¯¸ë‹ˆì–´ì²˜ì€ ìµœëŒ€ 5ê°œê¹Œì§€ë§Œ ì„¤ì¹˜í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤');
                    return;
                }
            }

            // ê°™ì€ íƒ€ì…ì˜ ë¯¸ë‹ˆì–´ì²˜ê°€ ìˆëŠ”ì§€ í™•ì¸ (ìœ„ì¹˜ ê³ ì •ì„ ìœ„í•´)
            const existingIndices = installedDecorations
                .map((d, i) => ({ type: typeof d === 'string' ? d : d.type, index: i }))
                .filter(d => d.type === decorationType)
                .map(d => d.index);
            
            let targetIndex = installedDecorations.length; // ê¸°ë³¸ê°’: ë§¨ ë’¤
            
            if (existingIndices.length > 0) {
                // ê°™ì€ íƒ€ì…ì´ ìˆìœ¼ë©´ ê·¸ ë‹¤ìŒ ìœ„ì¹˜ì— ë°°ì¹˜
                targetIndex = Math.max(...existingIndices) + 1;
            }

            // ì¸ë²¤í† ë¦¬ì—ì„œ ì œê±°
            inventory.decorations.splice(invIndex, 1);
            
            // ì„¤ì¹˜ ëª©ë¡ì— ì¶”ê°€ (ìœ„ì¹˜ ì •ë³´ í¬í•¨)
            installedDecorations.splice(targetIndex, 0, { type: decorationType, index: targetIndex });
            
            // ì¸ë±ìŠ¤ ì¬ì •ë ¬
            installedDecorations.forEach((d, i) => {
                if (typeof d === 'object') {
                    d.index = i;
                }
            });

            // í™˜ê²½ ì¬ê³„ì‚°
            recalculateTerrariumEnvironment();

            // ë§Œì¡±ë„ ì¦‰ì‹œ ì—…ë°ì´íŠ¸
            spirits.forEach(spirit => {
                if (!spirit.isDead && !spirit.isCompleted) {
                    spirit.satisfaction = calculateSatisfaction(spirit);
                }
            });
            
            const itemData = decoData || eventItem || synthItem;
            saveGame();
            renderTerrariumManagement();
            renderInventory();
            renderSpirits();  // ë§Œì¡±ë„ ë³€ê²½ ë°˜ì˜
            showNotification(`${itemData.icon} ${itemData.name} ì„¤ì¹˜ ì™„ë£Œ`);
            
            // ë³‘ê·  ì¹¨ì… ì²´í¬ (ë¯¸ë‹ˆì–´ì²˜ 10ê°œ ì´ˆê³¼ ì‹œ 5% í™•ë¥ )
            checkGermInvasion();
        }

        function removeDecorationFromTerrarium(decorationType) {
            // ë¬¸ìì—´ ë˜ëŠ” ê°ì²´ ëª¨ë‘ ì§€ì›
            const index = installedDecorations.findIndex(d => 
                (typeof d === 'string' ? d : d.type) === decorationType
            );
            if (index === -1) return;

            const decoData = DECORATION_TYPES[decorationType] || SYNTH_ITEMS[decorationType];
            const eventItem = EVENT_ITEMS[decorationType];
            const itemData = decoData || eventItem;
            
            if (!itemData) return;

            // ì„¤ì¹˜ ëª©ë¡ì—ì„œ ì œê±°í•˜ê³  ì¸ë²¤í† ë¦¬ì— ì¶”ê°€
            installedDecorations.splice(index, 1);
            
            // ì¸ë±ìŠ¤ ì¬ì •ë ¬
            installedDecorations.forEach((d, i) => {
                if (typeof d === 'object') {
                    d.index = i;
                }
            });
            
            if (!inventory.decorations) inventory.decorations = [];
            inventory.decorations.push(decorationType);

            // í™˜ê²½ ì¬ê³„ì‚°
            recalculateTerrariumEnvironment();
            
            // ì •ë ¹ë“¤ì´ ì‚¬ë¼ì§„ ì¥ì‹ì„ ì°¾ëŠ” ë©”ì‹œì§€ (3ë¶„ ì´ë‚´ ëœë¤)
            spirits.forEach(spirit => {
                if (!spirit.isDead && !spirit.isCompleted) {
                    const searchMessages = [
                        `${spirit.name}ì´(ê°€) ${itemData.name}ì´(ê°€) ì–´ë””ê°”ëŠ”ì§€ ì°¾ìŠµë‹ˆë‹¤.`,
                        `${spirit.name}ì´(ê°€) ${itemData.name}ì„(ë¥¼) ë‘ë¦¬ë²ˆê±°ë¦¬ë©° ì°¾ìŠµë‹ˆë‹¤.`,
                        `${spirit.name}ì´(ê°€) ì‚¬ë¼ì§„ ${itemData.name}ì„(ë¥¼) ì°¾ì•„ í—¤ë§µë‹ˆë‹¤.`,
                        `${spirit.name}ì´(ê°€) ${itemData.name}ì´(ê°€) ì—†ì–´ì ¸ì„œ ìŠ¬í¼í•©ë‹ˆë‹¤.`,
                        `${spirit.name}ì´(ê°€) ${itemData.name}ì´(ê°€) ê·¸ë¦¬ì›Œ ë³´ì…ë‹ˆë‹¤.`
                    ];
                    const randomMessage = searchMessages[Math.floor(Math.random() * searchMessages.length)];
                    
                    // 0~180ì´ˆ(3ë¶„) ì‚¬ì´ ëœë¤ íƒ€ì´ë°
                    const randomDelay = Math.random() * 180000; // 0 ~ 180000ms (0 ~ 3ë¶„)
                    
                    console.log(`${spirit.name}: ${randomDelay/1000}ì´ˆ í›„ì— "${randomMessage}" í‘œì‹œ ì˜ˆì •`);
                    
                    setTimeout(() => {
                        // íƒ€ì„ì•„ì›ƒ ì‹¤í–‰ ì‹œì ì—ë„ ì •ë ¹ì´ ì‚´ì•„ìˆê³  ì™„ì„±ë˜ì§€ ì•Šì•˜ëŠ”ì§€ ì¬í™•ì¸
                        const currentSpirit = spirits.find(s => s.id === spirit.id);
                        if (currentSpirit && !currentSpirit.isDead && !currentSpirit.isCompleted) {
                            console.log(`${currentSpirit.name}: ë¯¸ë‹ˆì–´ì²˜ ë°˜ì‘ í‘œì‹œ - "${randomMessage}"`);
                            currentSpirit.status = randomMessage;
                            
                            // ì¼ì§€ ì¶”ê°€
                            addLog(currentSpirit, randomMessage);
                            
                            updateSpiritCard(currentSpirit);
                        }
                    }, randomDelay);
                }
            });

            // ë§Œì¡±ë„ ì¦‰ì‹œ ì—…ë°ì´íŠ¸
            spirits.forEach(spirit => {
                if (!spirit.isDead && !spirit.isCompleted) {
                    spirit.satisfaction = calculateSatisfaction(spirit);
                }
            });
            
            saveGame();
            renderTerrariumManagement();
            renderInventory();
            renderSpirits();  // ë§Œì¡±ë„ ë³€ê²½ ë°˜ì˜
            showNotification(`${itemData.icon} ${itemData.name} íšŒìˆ˜ ì™„ë£Œ`);
        }

        // ëœë¤ ë©”ì‹œì§€ ìƒì„±
        function getRandomMessage(spirit) {
            if (spirit.isDead || spirit.isCompleted) return spirit.status;
            
            const affection = spirit.parameters.affection || 0;
            const now = Date.now();
            const timeSinceLastFed = spirit.lastFed ? (now - spirit.lastFed) / 1000 : Infinity;
            const timeSinceLastMusic = spirit.lastMusic ? (now - spirit.lastMusic) / 1000 : Infinity;
            const stage = getStage(spirit.growth);
            
            // ì•Œ/ë²ˆë°ê¸° ìƒíƒœì¸ì§€ í™•ì¸
            const isEgg = stage === 'egg';
            const isPupa = stage === 'pupa';
            
            let availableMessages = [];
            
            // í¬ë¦¬ìŠ¤ë§ˆìŠ¤ ì´ë²¤íŠ¸ ì •ë ¹ ì²´í¬ (ì•Œ/ë²ˆë°ê¸°ê°€ ì•„ë‹ ë•Œë§Œ)
            if (!isEgg && !isPupa) {
                const hasChristmasSpirit = spirits.some(s => s.isEventSpirit && s.eventType === 'christmas2025' && !s.isDead && !s.isCompleted);
                const isChristmasSpirit = spirit.isEventSpirit && spirit.eventType === 'christmas2025';
                
                // í¬ë¦¬ìŠ¤ë§ˆìŠ¤ ì¥ì‹ ì²´í¬
                const hasChristmasTree = installedDecorations.some(d => {
                    const decoType = typeof d === 'string' ? d : d.type;
                    return decoType === 'christmas_tree';
                });
                const hasChristmasGift = installedDecorations.some(d => {
                    const decoType = typeof d === 'string' ? d : d.type;
                    return decoType === 'christmas_gift';
                });
                
                // í¬ë¦¬ìŠ¤ë§ˆìŠ¤ ì´ë²¤íŠ¸ ëŒ€ì‚¬ (25% í™•ë¥ ë¡œ ìš°ì„  ì¶œë ¥)
                if ((hasChristmasSpirit || isChristmasSpirit) && Math.random() < 0.25) {
                    let christmasMessages = [];
                    
                    // ì´ë²¤íŠ¸ ì •ë ¹ ê°œì¸ ëŒ€ì‚¬
                    if (isChristmasSpirit) {
                        christmasMessages.push(
                            `${spirit.name}ì´(ê°€) ìºë¡¤ì„ í¥ì–¼ê±°ë¦½ë‹ˆë‹¤ ğŸµ`,
                            `${spirit.name} ì£¼ë³€ìœ¼ë¡œ ëˆˆì†¡ì´ê°€ ë‚´ë¦½ë‹ˆë‹¤ â„ï¸`,
                            `${spirit.name}ì´(ê°€) ë¹¨ê°„ ëª¨ìë¥¼ ê³ ì³ ì”ë‹ˆë‹¤ ğŸ…`
                        );
                        if (hasChristmasGift) {
                            christmasMessages.push(`${spirit.name}ì´(ê°€) ì„ ë¬¼ ìƒìë¥¼ ê¶ê¸ˆí•´í•©ë‹ˆë‹¤ ğŸ`);
                        }
                        if (hasChristmasTree) {
                            christmasMessages.push(`${spirit.name}ì´(ê°€) íŠ¸ë¦¬ ìœ„ ë°˜ì§ì´ëŠ” ë³„ì„ ë°”ë¼ë´…ë‹ˆë‹¤ â­`);
                        }
                    }
                    
                    // í¬ë¦¬ìŠ¤ë§ˆìŠ¤ ì •ë ¹ ì—†ì–´ë„ ì¥ì‹ì´ ìˆìœ¼ë©´ ê°œì¸ ë°˜ì‘
                    if (!isChristmasSpirit && hasChristmasSpirit) {
                        if (hasChristmasTree) {
                            christmasMessages.push(`${spirit.name}ì´(ê°€) í¬ë¦¬ìŠ¤ë§ˆìŠ¤ íŠ¸ë¦¬ë¥¼ ì‹ ê¸°í•˜ê²Œ ë°”ë¼ë´…ë‹ˆë‹¤ ğŸ„`);
                        }
                        if (hasChristmasGift) {
                            christmasMessages.push(`${spirit.name}ì´(ê°€) ì„ ë¬¼ ìƒì ì£¼ë³€ì„ ë§´ë•ë‹ˆë‹¤ ğŸ`);
                        }
                    }
                    
                    if (christmasMessages.length > 0) {
                        return christmasMessages[Math.floor(Math.random() * christmasMessages.length)];
                    }
                }
            }
            
            // === ì•Œ ìƒíƒœ ëŒ€ì‚¬ ===
            if (isEgg) {
                // ë°°ê³ í”” (5ë¶„ ì´ìƒ ì•ˆ ë¨¹ì„) - 70% í™•ë¥ 
                if (timeSinceLastFed > 300 && Math.random() < 0.7) {
                    availableMessages = [...RANDOM_MESSAGES.egg_hungry];
                }
                // ìµœê·¼ì— ìŒì•… ë“¤ìŒ (5ë¶„ ì´ë‚´, 30% í™•ë¥ )
                else if (timeSinceLastMusic < 300 && spirit.lastMusicType && Math.random() < 0.3) {
                    const musicData = MUSIC_TYPES[spirit.lastMusicType];
                    const musicName = musicData ? musicData.name : 'ìŒì•…';
                    availableMessages = RANDOM_MESSAGES.egg_music.map(msg => 
                        msg.replace('{music}', musicName)
                    );
                }
                // ì  (15% í™•ë¥ )
                else if (Math.random() < 0.15) {
                    if (lightMode) {
                        availableMessages = [...RANDOM_MESSAGES.egg_napLight];
                    } else {
                        availableMessages = [...RANDOM_MESSAGES.egg_sleepDark];
                    }
                }
                // ì• ì •ë„ ë‚®ìŒ (20% í™•ë¥ )
                else if (affection < 30 && Math.random() < 0.2) {
                    availableMessages = [...RANDOM_MESSAGES.egg_affectionLow];
                }
                // ê¸°ë³¸ ëŒ€ì‚¬
                if (availableMessages.length === 0) {
                    availableMessages = [...RANDOM_MESSAGES.egg_basic];
                }
                
                const randomMessage = availableMessages[Math.floor(Math.random() * availableMessages.length)];
                return randomMessage.replace('{name}', spirit.name);
            }
            
            // === ë²ˆë°ê¸° ìƒíƒœ ëŒ€ì‚¬ ===
            if (isPupa) {
                // ë°°ê³ í”” (5ë¶„ ì´ìƒ ì•ˆ ë¨¹ì„) - 70% í™•ë¥ 
                if (timeSinceLastFed > 300 && Math.random() < 0.7) {
                    availableMessages = [...RANDOM_MESSAGES.pupa_hungry];
                }
                // ìµœê·¼ì— ìŒì•… ë“¤ìŒ (5ë¶„ ì´ë‚´, 30% í™•ë¥ )
                else if (timeSinceLastMusic < 300 && spirit.lastMusicType && Math.random() < 0.3) {
                    const musicData = MUSIC_TYPES[spirit.lastMusicType];
                    const musicName = musicData ? musicData.name : 'ìŒì•…';
                    availableMessages = RANDOM_MESSAGES.pupa_music.map(msg => 
                        msg.replace('{music}', musicName)
                    );
                }
                // ì  (15% í™•ë¥ )
                else if (Math.random() < 0.15) {
                    if (lightMode) {
                        availableMessages = [...RANDOM_MESSAGES.pupa_napLight];
                    } else {
                        availableMessages = [...RANDOM_MESSAGES.pupa_sleepDark];
                    }
                }
                // ì• ì •ë„ ë‚®ìŒ (20% í™•ë¥ )
                else if (affection < 30 && Math.random() < 0.2) {
                    availableMessages = [...RANDOM_MESSAGES.pupa_affectionLow];
                }
                // ê¸°ë³¸ ëŒ€ì‚¬
                if (availableMessages.length === 0) {
                    availableMessages = [...RANDOM_MESSAGES.pupa_basic];
                }
                
                const randomMessage = availableMessages[Math.floor(Math.random() * availableMessages.length)];
                return randomMessage.replace('{name}', spirit.name);
            }
            
            // === ì• ë²Œë ˆ ìƒíƒœ ëŒ€ì‚¬ (ê¸°ì¡´ ë¡œì§) ===
            // ë°°ê³ í”” (5ë¶„=300ì´ˆ ì´ìƒ ì•ˆ ë¨¹ì„) - 70% í™•ë¥ ë¡œ ë°°ê³ í”” ë©”ì‹œì§€
            if (timeSinceLastFed > 300 && Math.random() < 0.7) {
                availableMessages = [...RANDOM_MESSAGES.hungry];
            }
            // ë°°ê³ í””ì´ ì•„ë‹ˆê±°ë‚˜, ë°°ê³ í””ì´ì§€ë§Œ 30% í™•ë¥ ë¡œ ë‹¤ë¥¸ ë©”ì‹œì§€
            else {
                // ìµœê·¼ì— ìŒì•… ë“¤ìŒ (5ë¶„=300ì´ˆ ì´ë‚´, 30% í™•ë¥ )
                if (timeSinceLastMusic < 300 && spirit.lastMusicType && Math.random() < 0.3) {
                    const musicName = MUSIC_TYPES[spirit.lastMusicType].name;
                    availableMessages = RANDOM_MESSAGES.music.map(msg => 
                        msg.replace('{music}', musicName)
                    );
                }
                // ë¯¸ë‹ˆì–´ì²˜ ì„¤ì¹˜ë¨ (30% í™•ë¥ )
                else if (installedDecorations.length > 0 && Math.random() < 0.3) {
                    const randomDeco = installedDecorations[Math.floor(Math.random() * installedDecorations.length)];
                    const decoType = typeof randomDeco === 'string' ? randomDeco : randomDeco.type;
                    if (RANDOM_MESSAGES.decorations[decoType]) {
                        availableMessages = [...RANDOM_MESSAGES.decorations[decoType]];
                    }
                }
                // í…Œë¼ë¦¬ì›€ì´ í…… ë¹„ì–´ìˆìŒ (30% í™•ë¥ )
                else if (installedDecorations.length === 0 && Math.random() < 0.3) {
                    availableMessages = [
                        `${spirit.name}ì´(ê°€) í…… ë¹ˆ í…Œë¼ë¦¬ì›€ ì•ˆì„ ë¹™ê¸€ë¹™ê¸€ ëŒì•„ë‹¤ë‹™ë‹ˆë‹¤.`,
                        `${spirit.name}ì´(ê°€) ì‹¬ì‹¬í•´ ë³´ì…ë‹ˆë‹¤.`,
                        `${spirit.name}ì´(ê°€) ì•„ë¬´ê²ƒë„ ì—†ëŠ” ê³µê°„ì„ ë‘ë¦¬ë²ˆê±°ë¦½ë‹ˆë‹¤.`,
                        `${spirit.name}ì´(ê°€) ë¬´ë£Œí•´ ë³´ì…ë‹ˆë‹¤.`
                    ];
                }
                // ì  (ì¡°ëª…ì— ë”°ë¼, 15% í™•ë¥ )
                else if (Math.random() < 0.15) {
                    if (lightMode) {
                        availableMessages = [...RANDOM_MESSAGES.napLight];
                    } else {
                        availableMessages = [...RANDOM_MESSAGES.sleepDark];
                    }
                }
            }
            
            // ìœ„ ì¡°ê±´ì— í•´ë‹¹ ì•ˆ ë˜ë©´ ì• ì •ë„ë³„ ë©”ì‹œì§€
            if (availableMessages.length === 0) {
                if (affection >= 100) {
                    availableMessages = [...RANDOM_MESSAGES.affectionVeryHigh, ...RANDOM_MESSAGES.basic];
                } else if (affection >= 50) {
                    availableMessages = [...RANDOM_MESSAGES.affectionHigh, ...RANDOM_MESSAGES.basic];
                } else if (affection >= 30) {
                    availableMessages = [...RANDOM_MESSAGES.affectionMedium, ...RANDOM_MESSAGES.basic];
                } else if (affection >= 10) {
                    availableMessages = [...RANDOM_MESSAGES.affectionLow, ...RANDOM_MESSAGES.basic];
                } else {
                    availableMessages = [...RANDOM_MESSAGES.affectionVeryLow, ...RANDOM_MESSAGES.basic];
                }
            }
            
            // ëœë¤ ì„ íƒ
            const randomMessage = availableMessages[Math.floor(Math.random() * availableMessages.length)];
            return randomMessage.replace('{name}', spirit.name);
        }
        
        // 30ì´ˆë§ˆë‹¤ ëœë¤ ë©”ì‹œì§€ ì—…ë°ì´íŠ¸
        // 30ì´ˆë§ˆë‹¤ ëœë¤ ë©”ì‹œì§€ ì—…ë°ì´íŠ¸
        // ì •ë ¹ ê°„ ìƒí˜¸ì‘ìš©
        function triggerSpiritInteraction() {
            
            if (isPaused) {
                return false;
            }
            
            // ì‚´ì•„ìˆê³  ì™„ì„±ë˜ì§€ ì•Šì€ ì •ë ¹ë§Œ (ì•Œ, ë²ˆë°ê¸° ì œì™¸ - ì›€ì§ì¼ ìˆ˜ ì—†ìŒ)
            const activeSpirits = spirits.filter(s => {
                if (s.isDead || s.isCompleted) return false;
                const stage = getStage(s.growth);
                // ì•Œ(egg)ê³¼ ë²ˆë°ê¸°(pupa)ëŠ” ì›€ì§ì¼ ìˆ˜ ì—†ìœ¼ë¯€ë¡œ ì œì™¸
                return stage === 'larva1' || stage === 'larva2' || stage === 'larva3';
            });
            
            // 2ë§ˆë¦¬ ì´ìƒì¼ ë•Œë§Œ ìƒí˜¸ì‘ìš©
            if (activeSpirits.length < 2) {
                return false;
            }
            
            // ê¸°ë³¸ 50% í™•ë¥ , ë§¤ë ¥ 50 ì´ìƒì¸ ì •ë ¹ì´ ìˆìœ¼ë©´ 70%ë¡œ ìƒìŠ¹
            const hasCharmingSpirit = activeSpirits.some(s => s.parameters.charm >= 50);
            const interactionChance = hasCharmingSpirit ? 0.7 : 0.5;
            
            const randomValue = Math.random();
            if (randomValue > interactionChance) {
                return false;
            }
            
            
            // ëœë¤í•˜ê²Œ 2ë§ˆë¦¬ ì„ íƒ
            const spirit1 = activeSpirits[Math.floor(Math.random() * activeSpirits.length)];
            let spirit2;
            do {
                spirit2 = activeSpirits[Math.floor(Math.random() * activeSpirits.length)];
            } while (spirit2.id === spirit1.id);
            
            // ìƒí˜¸ì‘ìš© ì¢…ë¥˜ ê²°ì •
            const interactionTypes = ['decoration', 'sharing', 'fight', 'rest', 'song', 'play', 'talk'];
            const weights = [20, 10, 5, 15, 10, 25, 15]; // ê°€ì¤‘ì¹˜ (%)
            
            let random = Math.random() * 100;
            let selectedType = 'play'; // ê¸°ë³¸ê°’
            let cumulative = 0;
            
            for (let i = 0; i < interactionTypes.length; i++) {
                cumulative += weights[i];
                if (random < cumulative) {
                    selectedType = interactionTypes[i];
                    break;
                }
            }
            
            
            // ë©”ì‹œì§€ ì„ íƒ ë° ì ìš©
            const messages = RANDOM_MESSAGES.interaction[selectedType];
            
            let message = messages[Math.floor(Math.random() * messages.length)];
            
            message = message
                .replace('{name1}', spirit1.name)
                .replace('{name2}', spirit2.name);
            
            
            // ë¯¸ë‹ˆì–´ì²˜ ìƒí˜¸ì‘ìš©ì¼ ê²½ìš° ë¯¸ë‹ˆì–´ì²˜ ì´ë¦„ ì¶”ê°€
            if (selectedType === 'decoration') {
                if (installedDecorations.length > 0) {
                    const randomDeco = installedDecorations[Math.floor(Math.random() * installedDecorations.length)];
                    const decoType = typeof randomDeco === 'string' ? randomDeco : randomDeco.type;
                    const decoData = DECORATION_TYPES[decoType];
                    if (decoData) {
                        message = message.replace('{deco}', decoData.name);
                        console.log('[ìƒí˜¸ì‘ç”¨] ë¯¸ë‹ˆì–´ì²˜ ì´ë¦„ ì ìš©:', decoData.name);
                    } else {
                        return false; // ë¯¸ë‹ˆì–´ì²˜ ë°ì´í„° ì—†ìœ¼ë©´ ì·¨ì†Œ
                    }
                } else {
                    return false; // ë¯¸ë‹ˆì–´ì²˜ ì—†ìœ¼ë©´ ì·¨ì†Œ
                }
            }
            
            // íš¨ê³¼ ì ìš©
            switch (selectedType) {
                case 'sharing': // ë¨¹ì´ ë‚˜ëˆ” - ë‘˜ ë‹¤ ì„±ì¥ +1
                    spirit1.growth = Math.min(100, spirit1.growth + 1);
                    spirit2.growth = Math.min(100, spirit2.growth + 1);
                    break;
                    
                case 'song': // ë…¸ë˜ - ëœë¤ ìŠ¤íƒ¯ +1
                    const statTypes = ['intelligence', 'strength', 'charm'];
                    const randomStat = statTypes[Math.floor(Math.random() * statTypes.length)];
                    spirit2.parameters[randomStat] += 1;
                    break;
                    
                case 'fight': // ì‹¸ì›€ - ì•½ê°„ì˜ ìŠ¤íŠ¸ë ˆìŠ¤, ì• ì •ë„ -1
                    spirit1.parameters.affection = Math.max(0, spirit1.parameters.affection - 1);
                    spirit2.parameters.affection = Math.max(0, spirit2.parameters.affection - 1);
                    break;
                    
                case 'rest': // íœ´ì‹ - ë§Œì¡±ë„ íšŒë³µ
                    // íŠ¹ë³„í•œ íš¨ê³¼ ì—†ìŒ, ë©”ì‹œì§€ë§Œ
                    break;
            }
            
            // ë‘ ì •ë ¹ ëª¨ë‘ ê°™ì€ ë©”ì‹œì§€ í‘œì‹œ
            spirit1.status = message;
            spirit2.status = message;
            
            // ìƒí˜¸ì‘ìš© ì‹œê°„ ê¸°ë¡ (ë©”ì‹œì§€ ìœ ì§€ìš©)
            const now = Date.now();
            spirit1.lastSpiritInteraction = now;
            spirit2.lastSpiritInteraction = now;
            
            // ì¼ì§€ì— ê¸°ë¡
            addLog(spirit1, message);
            
            // ì„±ì¥ë„ ì²´í¬ (100 ì´ìƒì´ë©´ ì§„í™”)
            if (spirit1.growth >= 100 && !spirit1.isCompleted) {
                completeSpirit(spirit1);
            }
            if (spirit2.growth >= 100 && !spirit2.isCompleted) {
                completeSpirit(spirit2);
            }
            
            saveGame();
            updateAllSpiritCards();
            
            return true; // ìƒí˜¸ì‘ìš© ë°œìƒ!
        }

        function updateRandomMessages() {
            if (isPaused) return; // ì¼ì‹œì •ì§€ ì¤‘ì´ë©´ ì‹¤í–‰ ì•ˆ í•¨
            
            // ì •ë ¹ ê°„ ìƒí˜¸ì‘ìš© ë¨¼ì € ì‹œë„ (ë©”ì‹œì§€ ë®ì–´ì“°ê¸° ë°©ì§€)
            const interactionOccurred = triggerSpiritInteraction();
            
            const now = Date.now();
            const activeSpirits = spirits.filter(s => !s.isDead && !s.isCompleted);
            
            // ì „ì²´ ì •ë ¹ ë©”ì‹œì§€ ë¨¼ì € ê²°ì • (í¬ë¦¬ìŠ¤ë§ˆìŠ¤ ì •ë ¹ì´ ìˆê³  2ë§ˆë¦¬ ì´ìƒì¼ ë•Œ)
            let globalMessage = null;
            const hasChristmasSpirit = spirits.some(s => s.isEventSpirit && s.eventType === 'christmas2025' && !s.isDead && !s.isCompleted);
            const hasChristmasTree = installedDecorations.some(d => {
                const decoType = typeof d === 'string' ? d : d.type;
                return decoType === 'christmas_tree';
            });
            
            if (hasChristmasSpirit && activeSpirits.length >= 2 && Math.random() < 0.15) {
                const globalMessages = [
                    `ì •ë ¹ë“¤ì´ ë‹¤ ê°™ì´ ìºë¡¤ì„ ë¶€ë¦…ë‹ˆë‹¤ ğŸ¶`,
                    `ì •ë ¹ë“¤ì´ ì„œë¡œ ì„ ë¬¼ì„ êµí™˜í•˜ëŠ” ê²ƒ ê°™ìŠµë‹ˆë‹¤ ğŸ`,
                    `ì •ë ¹ë“¤ì´ í•¨ê»˜ ëˆˆì‹¸ì›€ì„ í•©ë‹ˆë‹¤ â›„`,
                    `ì •ë ¹ë“¤ì´ ëª¨ë‘ ëª¨ì—¬ ë”°ëœ»í•œ ì‹œê°„ì„ ë³´ëƒ…ë‹ˆë‹¤ â˜•`
                ];
                if (hasChristmasTree) {
                    globalMessages.push(`ì •ë ¹ë“¤ì´ ë‹¤ ê°™ì´ ëª¨ì—¬ í¬ë¦¬ìŠ¤ë§ˆìŠ¤ íŠ¸ë¦¬ë¥¼ êµ¬ê²½í•©ë‹ˆë‹¤ ğŸ„`);
                }
                globalMessage = globalMessages[Math.floor(Math.random() * globalMessages.length)];
            }
            
            // ì „ì²´ ë©”ì‹œì§€ê°€ ì„ íƒë˜ë©´ ëª¨ë“  ì •ë ¹ì—ê²Œ ê°•ì œ ì ìš©
            if (globalMessage) {
                spirits.forEach(spirit => {
                    if (!spirit.isDead && !spirit.isCompleted) {
                        const oldStatus = spirit.status;
                        if (globalMessage !== oldStatus) {
                            addLog(spirit, globalMessage);
                        }
                        spirit.status = globalMessage;
                    }
                });
                updateAllSpiritCards();
                return;
            }
            
            // ì „ì²´ ë©”ì‹œì§€ê°€ ì—†ìœ¼ë©´ ê°œë³„ ë©”ì‹œì§€ ì²˜ë¦¬
            spirits.forEach(spirit => {
                if (!spirit.isDead && !spirit.isCompleted) {
                    // ì •ë ¹ ê°„ ìƒí˜¸ì‘ìš©ì´ ë°œìƒí–ˆìœ¼ë©´ í•´ë‹¹ ì •ë ¹ ë©”ì‹œì§€ ìœ ì§€
                    if (interactionOccurred && spirit.lastSpiritInteraction && now - spirit.lastSpiritInteraction < 15000) {
                        return;
                    }
                    
                    // ìµœê·¼ 10ì´ˆ ì´ë‚´ì— í”Œë ˆì´ì–´ ìƒí˜¸ì‘ìš©í–ˆìœ¼ë©´ ë©”ì‹œì§€ ìœ ì§€
                    const recentInteraction = (
                        (spirit.lastFeed && now - spirit.lastFeed < 10000) ||
                        (spirit.lastPat && now - spirit.lastPat < 10000) ||
                        (spirit.lastMusic && now - spirit.lastMusic < 10000)
                    );
                    
                    if (recentInteraction) {
                        return; // ë©”ì‹œì§€ ìœ ì§€
                    }
                    
                    const oldStatus = spirit.status;
                    const newStatus = getRandomMessage(spirit);
                    
                    // ë©”ì‹œì§€ê°€ ë³€ê²½ë˜ì—ˆê³ , íŠ¹ì • ì‹œìŠ¤í…œ ë©”ì‹œì§€ê°€ ì•„ë‹ˆë©´ ì¼ì§€ì— ê¸°ë¡
                    if (newStatus !== oldStatus && !newStatus.includes('ë“£ê³  ìˆìŠµë‹ˆë‹¤')) {
                        addLog(spirit, newStatus);
                    }
                    
                    spirit.status = newStatus;
                }
            });
            
            updateAllSpiritCards();
        }
        
        // 5ë¶„ ë°©ì¹˜ ì²´í¬ (ì• ì •ë„ ê°ì†Œ)
        function checkNeglect() {
            if (isPaused) return; // ì¼ì‹œì •ì§€ ì¤‘ì´ë©´ ì‹¤í–‰ ì•ˆ í•¨
            if (tutorialActive) return; // ì²« íŠœí† ë¦¬ì–¼ ì¤‘ì´ë©´ ì‹¤í–‰ ì•ˆ í•¨
            
            const now = Date.now();
            spirits.forEach(spirit => {
                if (spirit.isDead || spirit.isCompleted) return;
                
                // ì•Œ, ì• ë²Œë ˆ, ë²ˆë°ê¸° ìƒíƒœì—ì„œëŠ” ë°©ì¹˜ ì²´í¬ ì•ˆ í•¨
                if (!spirit.stage || spirit.stage === 'egg' || spirit.stage === 'larva' || spirit.stage === 'pupa') {
                    return;
                }
                
                // lastInteractionì´ ì—†ìœ¼ë©´ í˜„ì¬ ì‹œê°„ìœ¼ë¡œ ì´ˆê¸°í™” (êµ¬ë²„ì „ í˜¸í™˜)
                if (!spirit.lastInteraction) {
                    spirit.lastInteraction = now;
                    return;
                }
                
                // ì¼ì‹œì •ì§€ ì‹œê°„ ì œì™¸í•œ ì‹¤ì œ ê²½ê³¼ ì‹œê°„ ê³„ì‚°
                const currentPausedTime = isPaused ? (now - pausedAt) : 0;
                const effectivePausedTime = totalPausedTime + currentPausedTime;
                
                const timeSinceLastInteraction = (now - spirit.lastInteraction - effectivePausedTime) / 1000; // ì´ˆ
                const minutesSinceInteraction = timeSinceLastInteraction / 60;
                
                // 5ë¶„ë§ˆë‹¤ ì• ì •ë„ -1 ê°ì†Œ
                // lastAffectionDropì´ ì—†ê±°ë‚˜ 5ë¶„ ì´ìƒ ì§€ë‚¬ìœ¼ë©´ ê°ì†Œ
                if (!spirit.lastAffectionDrop) {
                    spirit.lastAffectionDrop = now;
                }
                
                const timeSinceAffectionDrop = (now - spirit.lastAffectionDrop - effectivePausedTime) / 1000; // ì´ˆ
                if (timeSinceAffectionDrop >= 300) { // 5ë¶„ = 300ì´ˆ
                    if (spirit.parameters.affection > 0) {
                        spirit.parameters.affection -= 1;
                        spirit.lastAffectionDrop = now;
                        addLog(spirit, 'ë°©ì¹˜ë˜ì–´ ì• ì •ë„ê°€ ê°ì†Œí–ˆìŠµë‹ˆë‹¤ (-1)');
                        saveGame();
                    }
                }
                
                // ì•„í”ˆ ìƒíƒœì—ì„œ 30ë¶„ ë°©ì¹˜ ì‹œ ë„ë§ê°
                if (spirit.isSick && !spirit.sickWarned && minutesSinceInteraction >= 30) {
                    spirit.sickWarned = true;
                    spirit.status = `${spirit.name}ì´(ê°€) ì•„íŒŒì„œ ê´´ë¡œì›Œí•©ë‹ˆë‹¤... ğŸ¤’ğŸ’”`;
                    addLog(spirit, 'ì•„í”ˆ ìƒíƒœë¡œ ì˜¤ë˜ ë°©ì¹˜ë˜ê³  ìˆìŠµë‹ˆë‹¤!');
                    showNotification(`${spirit.name}ì´(ê°€) ë§¤ìš° ê´´ë¡œì›Œí•©ë‹ˆë‹¤! ê³§ ë– ë‚  ìˆ˜ ìˆìŠµë‹ˆë‹¤!`);
                    saveGame();
                }
                
                // ì•„í”ˆ ìƒíƒœì—ì„œ 1ì‹œê°„ ë°©ì¹˜ ì‹œ ë„ë§ê°
                if (spirit.isSick && minutesSinceInteraction >= 60) {
                    spirit.status = `${spirit.name}ì´(ê°€) í…Œë¼ë¦¬ì›€ì„ ë– ë‚¬ìŠµë‹ˆë‹¤... ğŸ˜¢`;
                    addLog(spirit, 'ì•„í”ˆ ìƒíƒœë¡œ ë°©ì¹˜ë˜ì–´ ë– ë‚¬ìŠµë‹ˆë‹¤');
                    showNotification(`ğŸ˜¢ ${spirit.name}ì´(ê°€) í…Œë¼ë¦¬ì›€ì„ ë– ë‚¬ìŠµë‹ˆë‹¤...`);
                    deleteSpirit(spirit.id);
                    return;
                }
                
                // ê±´ê°•í•œ ìƒíƒœì—ì„œ 1ì‹œê°„(3600ì´ˆ) ë°©ì¹˜ ì‹œ ë„ë§ê°
                if (!spirit.isSick && timeSinceLastInteraction >= 3600) {
                    spirit.status = `${spirit.name}ì´(ê°€) ì™¸ë¡œì›Œì„œ í…Œë¼ë¦¬ì›€ì„ ë– ë‚¬ìŠµë‹ˆë‹¤... ğŸ˜¢`;
                    addLog(spirit, 'ì˜¤ë˜ ë°©ì¹˜ë˜ì–´ ë– ë‚¬ìŠµë‹ˆë‹¤');
                    showNotification(`ğŸ˜¢ ${spirit.name}ì´(ê°€) ì™¸ë¡œì›Œì„œ ë– ë‚¬ìŠµë‹ˆë‹¤...`);
                    deleteSpirit(spirit.id);
                    return;
                }
            });
            updateAllSpiritCards();
        }

        // ë°ì´í„° ë°±ì—… ì‹œìŠ¤í…œ
        function createBackup() {
            const backupData = {
                version: GAME_VERSION,
                collection: collection,
                encyclopedia: encyclopedia,
                timestamp: Date.now()
            };
            
            const backupJson = JSON.stringify(backupData, null, 2);
            const blob = new Blob([backupJson], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `spirit-garden-backup-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
            
            showNotification('ë°±ì—… íŒŒì¼ì´ ë‹¤ìš´ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤!');
        }
        
        function importBackup() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const backupData = JSON.parse(event.target.result);
                        
                        // ë°±ì—… ë°ì´í„° ë³‘í•© (ê¸°ì¡´ ë°ì´í„° ìœ ì§€)
                        if (backupData.collection && Array.isArray(backupData.collection)) {
                            backupData.collection.forEach(item => {
                                // ì¤‘ë³µ ì²´í¬ (ê°™ì€ ì •ë ¹ì´ ì´ë¯¸ ìˆëŠ”ì§€)
                                const exists = collection.some(c => 
                                    c.name === item.name && 
                                    c.originalName === item.originalName &&
                                    c.completedAt === item.completedAt
                                );
                                if (!exists) {
                                    collection.push(item);
                                }
                            });
                        }
                        
                        if (backupData.encyclopedia && typeof backupData.encyclopedia === 'object') {
                            // ë„ê° ë°ì´í„° ë³‘í•© (ì¹´ìš´íŠ¸ ëˆ„ì )
                            for (let key in backupData.encyclopedia) {
                                if (!encyclopedia[key]) {
                                    encyclopedia[key] = 0;
                                }
                                encyclopedia[key] += backupData.encyclopedia[key];
                            }
                        }
                        
                        saveGame();
                        renderCollection();
                        renderEncyclopedia();
                        showNotification(`ë°±ì—… ë³µì› ì™„ë£Œ! (ì•¨ë²” ${backupData.collection?.length || 0}ê°œ ë³µì›)`);
                    } catch (err) {
                        showNotification('ë°±ì—… íŒŒì¼ì„ ì½ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: ' + err.message);
                    }
                };
                reader.readAsText(file);
            };
            input.click();
        }

        function removeAllDecorations() {
            if (installedDecorations.length === 0) {
                showNotification('ì„¤ì¹˜ëœ ë¯¸ë‹ˆì–´ì²˜ê°€ ì—†ìŠµë‹ˆë‹¤');
                return;
            }
            
            showConfirm(
                'ë¯¸ë‹ˆì–´ì²˜ ì „ì²´ í•´ì œ',
                `ì„¤ì¹˜ëœ ë¯¸ë‹ˆì–´ì²˜ ${installedDecorations.length}ê°œë¥¼ ëª¨ë‘ í•´ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`,
                () => {
                    // ëª¨ë“  ë¯¸ë‹ˆì–´ì²˜ë¥¼ ì¸ë²¤í† ë¦¬ë¡œ ë°˜í™˜
                installedDecorations.forEach(deco => {
                    // ë¬¸ìì—´ ë˜ëŠ” ê°ì²´ ëª¨ë‘ ì§€ì›
                    const decoType = typeof deco === 'string' ? deco : deco.type;
                    inventory.decorations.push(decoType);
                    
                    // í…Œë¼ë¦¬ì›€ ì†ì„± ê°ì†Œ
                    const decoData = DECORATION_TYPES[decoType];
                    if (decoData && terrarium[decoData.attr] !== undefined) {
                        terrarium[decoData.attr] = Math.max(0, terrarium[decoData.attr] - decoData.power);
                    }
                });
                
                installedDecorations = [];
                
                // í…Œë¼ë¦¬ì›€ í™˜ê²½ ì¬ê³„ì‚°
                recalculateTerrariumEnvironment();
                
                // ë§Œì¡±ë„ ì¦‰ì‹œ ì—…ë°ì´íŠ¸
                spirits.forEach(spirit => {
                    if (!spirit.isDead && !spirit.isCompleted) {
                        spirit.satisfaction = calculateSatisfaction(spirit);
                    }
                });
                
                saveGame();
                    renderTerrariumManagement();
                    renderInventory();
                    renderSpirits();  // ë§Œì¡±ë„ ë³€ê²½ ë°˜ì˜
                    showNotification('ëª¨ë“  ë¯¸ë‹ˆì–´ì²˜ë¥¼ í•´ì œí–ˆìŠµë‹ˆë‹¤');
                }
            );
        }
        // ==================== ë¯¸ë‹ˆê²Œì„: ì •ë ¹ ì§€í‚¤ê¸° ====================
        let minigameActive = false;
        let minigameScore = 0;
        let minigameLives = 3;
        let minigameWords = [];
        let minigameInterval = null;
        let minigameSpawnInterval = null;
        let minigameTimerInterval = null;
        let minigameTimeLeft = 60;
        let minigameDifficulty = 'normal';
        let minigameDefeated = 0;
        let minigamePaused = false;
        
        // ë–¨ì–´ì§€ëŠ” ë‹¨ì–´ ëª©ë¡ (í•´ì¶©, ë…ì´ˆ, ì¡ì´ˆ ë“±)
        const MINIGAME_ENEMIES = {
            easy: [
                // í•´ì¶©
                { word: 'ì• ë²Œë ˆ', icon: 'ğŸ›' },
                { word: 'í•´ì¶©', icon: 'ğŸª²' },
                { word: 'ë°”í€´', icon: 'ğŸª³' },
                { word: 'ì§„ë”§ë¬¼', icon: 'ğŸœ' },
                { word: 'ë‹¬íŒ½ì´', icon: 'ğŸŒ' },
                { word: 'ì§€ë ì´', icon: 'ğŸª±' },
                { word: 'ë”±ì •ë²Œë ˆ', icon: 'ğŸª²' },
                { word: 'ë©”ëšœê¸°', icon: 'ğŸ¦—' },
                { word: 'ê·€ëšœë¼ë¯¸', icon: 'ğŸ¦—' },
                { word: 'í•˜ë£¨ì‚´ì´', icon: 'ğŸª°' },
                { word: 'ë‚˜ë¹„ìœ ì¶©', icon: 'ğŸ›' },
                // ë…ì´ˆ/ì¡ì´ˆ
                { word: 'ë…í’€', icon: 'ğŸŒ¿' },
                { word: 'ì—‰ê²…í€´', icon: 'ğŸŒ¾' },
                { word: 'ìê¸°í’€', icon: 'ğŸŒ¿' },
                { word: 'ë©êµ´', icon: 'ğŸŒ±' },
                { word: 'ê°€ì‹œë¤ë¶ˆ', icon: 'ğŸŒµ' },
                { word: 'í™˜ì‚¼ë©êµ´', icon: 'ğŸŒ¿' },
                { word: 'ë¼ì§€í’€', icon: 'ğŸŒ¾' },
                { word: 'ë„ê¼¬ë§ˆë¦¬', icon: 'ğŸŒ¿' },
                { word: 'ê°€ì‹œìƒì¶”', icon: 'ğŸŒ¿' },
                { word: 'ë…ë³´ë¦¬', icon: 'ğŸŒ¾' },
                { word: 'ë¯¸ë‚˜ë¦¬ëƒ‰ì´', icon: 'ğŸŒ¿' },
                // ë…ë²„ì„¯
                { word: 'ë…ë²„ì„¯', icon: 'ğŸ„' },
                { word: 'ê´‘ëŒ€ë²„ì„¯', icon: 'ğŸ„' },
                { word: 'ë…ìš°ì‚°ë²„ì„¯', icon: 'ğŸ„' },
                { word: 'í™”ê²½ë²„ì„¯', icon: 'ğŸ„' },
                { word: 'ë•€ë²„ì„¯', icon: 'ğŸ„' },
                { word: 'ì™¸ëŒ€ë²„ì„¯', icon: 'ğŸ„' },
                { word: 'ë…ì²­ë²„ì„¯', icon: 'ğŸ„' },
                { word: 'í°ë…ë²„ì„¯', icon: 'ğŸ„' },
                { word: 'ë…¸ë€ë‹¤ë°œë²„ì„¯', icon: 'ğŸ„' },
                { word: 'ì‚¿ê°“ì™¸ëŒ€ë²„ì„¯', icon: 'ğŸ„' },
                { word: 'í™”ê²½ì†”ë²„ì„¯', icon: 'ğŸ„' },
                { word: 'ê³°íŒ¡ì´', icon: 'ğŸ¦ ' },
                { word: 'ì´ë¼ë¥˜', icon: 'ğŸª¨' },
                // ê¸°íƒ€
                { word: 'ê±°ë¯¸ì¤„', icon: 'ğŸ•¸ï¸' },
                { word: 'ë¨¼ì§€', icon: 'ğŸ’¨' }
            ],
            hard: [
                // í•´ì¶©
                { word: 'ë°”í€´ë²Œë ˆ', icon: 'ğŸª³' },
                { word: 'ì§‘ê²Œë²Œë ˆ', icon: 'ğŸª²' },
                { word: 'í•˜ëŠ˜ì†Œ', icon: 'ğŸª²' },
                { word: 'ë…¸ë¦°ì¬', icon: 'ğŸª²' },
                { word: 'ì´ì±„ë²Œë ˆ', icon: 'ğŸ¦Ÿ' },
                { word: 'ì‘ì• ', icon: 'ğŸ•·ï¸' },
                { word: 'ì§„ë“œê¸°', icon: 'ğŸ•·ï¸' },
                { word: 'ë…ê±°ë¯¸', icon: 'ğŸ•·ï¸' },
                { word: 'ì§€ë„¤', icon: 'ğŸ›' },
                { word: 'ê·¸ë¦¬ë§ˆ', icon: 'ğŸ›' },
                { word: 'ë§ë²Œ', icon: 'ğŸ' },
                { word: 'ë•…ë²Œ', icon: 'ğŸ' },
                { word: 'ìŒ€ë°”êµ¬ë¯¸', icon: 'ğŸª²' },
                { word: 'í°ê°œë¯¸', icon: 'ğŸœ' },
                { word: 'ê¸°ìƒì¶©', icon: 'ğŸª±' },
                // ë…ì´ˆ/ì¡ì´ˆ
                { word: 'ë…ë¯¸ë‚˜ë¦¬', icon: 'ğŸŒ¿' },
                { word: 'íˆ¬êµ¬ê½ƒ', icon: 'ğŸŒ¸' },
                { word: 'ë¯¸ì¹˜ê´‘ì´í’€', icon: 'ğŸŒ¿' },
                { word: 'í˜‘ì£½ë„', icon: 'ğŸŒº' },
                { word: 'ì²œë‚¨ì„±', icon: 'ğŸŒ±' },
                { word: 'ì‚¿ê°“ë‚˜ë¬¼', icon: 'ğŸ€' },
                { word: 'ì• ê¸°ë˜¥í’€', icon: 'ğŸŒ¼' },
                { word: 'ê´‘ëŒ€ì‹¸ë¦¬', icon: 'ğŸŒ¿' },
                { word: 'ë…ë§í’€', icon: 'ğŸŒ¸' },
                { word: 'ì€ë°©ìš¸ê½ƒ', icon: 'ğŸŒ¸' },
                { word: 'í”¼ë§ˆì', icon: 'ğŸŒ¿' },
                { word: 'ì„ì‚°', icon: 'ğŸŒº' },
                { word: 'ë°”ê³³', icon: 'ğŸŒ¸' },
                { word: 'ìë¦¬ê³µ', icon: 'ğŸŒ¿' },
                { word: 'ë°•ìƒˆ', icon: 'ğŸŒ¿' },
                { word: 'ì—¬ë¡œ', icon: 'ğŸŒ±' },
                { word: 'ë™ì˜ë‚˜ë¬¼', icon: 'ğŸŒ¿' },
                { word: 'ë‹¨í’ìë¼ì§€í’€', icon: 'ğŸŒ¾' },
                { word: 'ì„œì–‘ë“±ê³¨ë‚˜ë¬¼', icon: 'ğŸŒ¿' },
                { word: 'ë…í™œ', icon: 'ğŸŒ¿' },
                { word: 'ê°œê°ìˆ˜', icon: 'ğŸŒ¿' },
                { word: 'í°ë…ë§í’€', icon: 'ğŸŒ¸' },
                // ë…ë²„ì„¯
                { word: 'ê³°íŒ¡ì´ê· ', icon: 'ğŸ¦ ' },
                { word: 'ì•Œê´‘ëŒ€ë²„ì„¯', icon: 'ğŸ„' },
                { word: 'ë§ˆê·€ê´‘ëŒ€ë²„ì„¯', icon: 'ğŸ„' },
                { word: 'ê°œë‚˜ë¦¬ê´‘ëŒ€ë²„ì„¯', icon: 'ğŸ„' },
                { word: 'ë¶‰ì€ì‚¬ìŠ´ë¿”ë²„ì„¯', icon: 'ğŸ„' },
                { word: 'ë…í°ê°ˆëŒ€ë²„ì„¯', icon: 'ğŸ„' },
                { word: 'í°ì˜¤ëšœê¸°ê´‘ëŒ€ë²„ì„¯', icon: 'ğŸ„' },
                { word: 'ì ë°•ì´ê´‘ëŒ€ë²„ì„¯', icon: 'ğŸ„' },
                { word: 'ê°ˆìƒ‰ê³ ë¦¬ê°“ë²„ì„¯', icon: 'ğŸ„' },
                { word: 'íŒŒë¦¬ë²„ì„¯', icon: 'ğŸ„' },
                { word: 'í°ì•Œê´‘ëŒ€ë²„ì„¯', icon: 'ğŸ„' },
                { word: 'í°ì£¼ë¨¸ë‹ˆê´‘ëŒ€ë²„ì„¯', icon: 'ğŸ„' },
                { word: 'ë…ê¹”ë•Œê¸°ë²„ì„¯', icon: 'ğŸ„' },
                { word: 'ë‘ì—„ë¨¹ë¬¼ë²„ì„¯', icon: 'ğŸ„' },
                { word: 'ê¾€ê¼¬ë¦¬ë•€ë²„ì„¯', icon: 'ğŸ„' },
                { word: 'ë…¸ë€ëŒ€ê´‘ëŒ€ë²„ì„¯', icon: 'ğŸ„' },
                { word: 'ë±€ê»ì§ˆê´‘ëŒ€ë²„ì„¯', icon: 'ğŸ„' },
                // ê¸°íƒ€
                { word: 'í•´ì¶©ë–¼', icon: 'ğŸª²' },
                { word: 'ë…ê±°ë¯¸ì¤„', icon: 'ğŸ•¸ï¸' }
            ]
        };
        
        // ë‚œì´ë„ë³„ ì„¤ì •
        const MINIGAME_SETTINGS = {
            easy: { spawnRate: 1700, fallSpeed: 2.2, maxWords: 5, coinMultiplier: 1 },
            hard: { spawnRate: 1200, fallSpeed: 2.8, maxWords: 8, coinMultiplier: 2 }
        };
        
        // ëª¨ë°”ì¼ ê°ì§€
        function isMobile() {
            return window.innerWidth <= 768;
        }
        
        // ëª¨ë°”ì¼ìš© ì†ë„ ì¡°ì • (í™”ë©´ì´ ì‘ìœ¼ë‹ˆ ë” ëŠë¦¬ê²Œ)
        function getMobileAdjustedSpeed(speed) {
            if (isMobile()) {
                return speed * 0.5; // ëª¨ë°”ì¼ì—ì„œ 50% ì†ë„
            }
            return speed;
        }
        
        function startMinigame() {
            minigameDifficulty = document.getElementById('minigameDifficulty').value;
            minigameActive = true;
            minigameScore = 0;
            minigameLives = 3;
            minigameWords = [];
            minigameDefeated = 0;
            minigamePaused = false;
            
            // ëª¨ë°”ì¼ ëŒ€ì‘: bodyì— í´ë˜ìŠ¤ ì¶”ê°€
            document.body.classList.add('minigame-active');
            
            // í™”ë©´ ì „í™˜
            document.getElementById('minigameIntro').style.display = 'none';
            document.getElementById('minigamePlay').style.display = 'block';
            document.getElementById('minigameResult').style.display = 'none';
            
            // UI ì´ˆê¸°í™”
            updateMinigameUI();
            
            // ì…ë ¥ í•„ë“œ ì´ˆê¸°í™” (ì¹´ìš´íŠ¸ë‹¤ìš´ ì¤‘ì—ë„ ì…ë ¥ ê°€ëŠ¥)
            const input = document.getElementById('minigameInput');
            input.value = '';
            input.disabled = false; // ì¹´ìš´íŠ¸ë‹¤ìš´ ì¤‘ì—ë„ í™œì„±í™”
            
            // ë°”ë¡œ í¬ì»¤ìŠ¤ (ì¹´ìš´íŠ¸ë‹¤ìš´ ì¤‘ ì¤€ë¹„ ê°€ëŠ¥)
            setTimeout(() => {
                input.focus();
            }, 100);
            
            // ì¹´ìš´íŠ¸ë‹¤ìš´ ì‹œì‘
            showMinigameCountdown(() => {
                // ì¹´ìš´íŠ¸ë‹¤ìš´ ì™„ë£Œ í›„ ê²Œì„ ì‹œì‘
                
                // ëª¨ë°”ì¼: í¬ì»¤ìŠ¤ ì¬í™•ì¸
                setTimeout(() => {
                    input.focus();
                }, 100);
                
                // ì…ë ¥ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ (í•œê¸€ ì¡°í•© ì™„ë£Œ í›„ ì²˜ë¦¬)
                let isComposing = false;
                
                input.addEventListener('compositionstart', () => {
                    isComposing = true;
                });
                
                input.addEventListener('compositionend', (e) => {
                    isComposing = false;
                });
                
                // ìŠ¤í˜ì´ìŠ¤ë°”ë‚˜ ì—”í„°ë¡œ ë‹¨ì–´ í™•ì •
                input.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' || e.key === ' ') {
                        e.preventDefault();
                        if (!isComposing) {
                            confirmMinigameInput();
                        }
                    }
                });
                
                // ê²Œì„ ì‹œì‘
                const settings = MINIGAME_SETTINGS[minigameDifficulty];
                
                // ëª¨ë°”ì¼ì—ì„œëŠ” ìµœëŒ€ ë‹¨ì–´ ìˆ˜ ì¤„ì´ê¸°
                const maxWords = isMobile() ? Math.min(settings.maxWords, 3) : settings.maxWords;
                
                // ë‹¨ì–´ ìƒì„± ì¸í„°ë²Œ (ëª¨ë°”ì¼ì—ì„œëŠ” ë” ëŠë¦¬ê²Œ)
                const spawnRate = isMobile() ? settings.spawnRate * 1.3 : settings.spawnRate;
                
                minigameSpawnInterval = setInterval(() => {
                    if (!minigamePaused && minigameWords.length < maxWords) {
                        spawnMinigameWord();
                    }
                }, spawnRate);
                
                // ê²Œì„ ë£¨í”„ (ë‹¨ì–´ ì´ë™)
                minigameInterval = setInterval(() => {
                    if (!minigamePaused) {
                        updateMinigameWords();
                    }
                }, 50);
                
                // íƒ€ì´ë¨¸ ì‹œì‘ (1ë¶„ ì œí•œ)
                minigameTimeLeft = 60;
                document.getElementById('minigameTimer').textContent = minigameTimeLeft;
                minigameTimerInterval = setInterval(() => {
                    if (!minigamePaused) {
                        minigameTimeLeft--;
                        document.getElementById('minigameTimer').textContent = minigameTimeLeft;
                        
                        // 10ì´ˆ ì´í•˜ë©´ ë¹¨ê°„ìƒ‰ìœ¼ë¡œ í‘œì‹œ
                        if (minigameTimeLeft <= 10) {
                            document.getElementById('minigameTimer').style.color = '#e74c3c';
                        }
                        
                        // ì‹œê°„ ì¢…ë£Œ
                        if (minigameTimeLeft <= 0) {
                            endMinigame();
                        }
                    }
                }, 1000);
                
                // ì²« ë‹¨ì–´ ë°”ë¡œ ìƒì„±
                spawnMinigameWord();
            });
        }
        
        // ë¯¸ë‹ˆê²Œì„ ì¹´ìš´íŠ¸ë‹¤ìš´
        function showMinigameCountdown(onComplete) {
            const gameArea = document.getElementById('minigameArea');
            
            // ì¹´ìš´íŠ¸ë‹¤ìš´ ì˜¤ë²„ë ˆì´ ìƒì„±
            const overlay = document.createElement('div');
            overlay.id = 'minigameCountdown';
            overlay.style.cssText = `
                position: absolute;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.8);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 1000;
            `;
            
            const countText = document.createElement('div');
            countText.style.cssText = `
                font-size: 5rem;
                font-weight: bold;
                color: white;
                text-shadow: 0 0 20px rgba(255, 255, 255, 0.5);
                animation: countPulse 0.5s ease-out;
            `;
            
            // ì• ë‹ˆë©”ì´ì…˜ ìŠ¤íƒ€ì¼ ì¶”ê°€
            if (!document.getElementById('countdownStyle')) {
                const style = document.createElement('style');
                style.id = 'countdownStyle';
                style.textContent = `
                    @keyframes countPulse {
                        0% { transform: scale(1.5); opacity: 0; }
                        50% { transform: scale(1.1); opacity: 1; }
                        100% { transform: scale(1); opacity: 1; }
                    }
                `;
                document.head.appendChild(style);
            }
            
            overlay.appendChild(countText);
            gameArea.style.position = 'relative';
            gameArea.appendChild(overlay);
            
            const counts = ['3', '2', '1', 'ğŸ® START!'];
            let index = 0;
            
            function showNext() {
                if (index < counts.length) {
                    countText.textContent = counts[index];
                    countText.style.animation = 'none';
                    countText.offsetHeight; // ë¦¬í”Œë¡œìš° íŠ¸ë¦¬ê±°
                    countText.style.animation = 'countPulse 0.5s ease-out';
                    
                    if (counts[index] === 'ğŸ® START!') {
                        countText.style.fontSize = '3rem';
                        countText.style.color = '#2ecc71';
                    }
                    
                    index++;
                    
                    if (index < counts.length) {
                        setTimeout(showNext, 800);
                    } else {
                        // START! í‘œì‹œ í›„ ì ì‹œ ëŒ€ê¸° í›„ ì œê±°
                        setTimeout(() => {
                            overlay.remove();
                            if (onComplete) onComplete();
                        }, 500);
                    }
                }
            }
            
            showNext();
        }
        
        function spawnMinigameWord() {
            const area = document.getElementById('minigameArea');
            const areaWidth = area.offsetWidth;
            const enemies = MINIGAME_ENEMIES[minigameDifficulty];
            const enemy = enemies[Math.floor(Math.random() * enemies.length)];
            
            // ë‹¨ì–´ ê¸¸ì´ì— ë”°ë¥¸ ì˜ˆìƒ ë„ˆë¹„ ê³„ì‚° (ê¸€ìë‹¹ ì•½ 18px + íŒ¨ë”© + ì•„ì´ì½˜)
            const estimatedWidth = (enemy.word.length * 18) + 60;
            // ìµœì†Œ 20px ì—¬ë°±, ìµœëŒ€ (í™”ë©´ë„ˆë¹„ - ì˜ˆìƒë„ˆë¹„ - 20px)
            const maxX = Math.max(20, areaWidth - estimatedWidth - 20);
            
            // ëª¨ë°”ì¼ì—ì„œëŠ” ì†ë„ ê°ì†Œ
            const baseSpeed = MINIGAME_SETTINGS[minigameDifficulty].fallSpeed + (Math.random() * 0.5);
            const adjustedSpeed = getMobileAdjustedSpeed(baseSpeed);
            
            const wordObj = {
                id: Date.now() + Math.random(),
                word: enemy.word,
                icon: enemy.icon,
                x: Math.random() * maxX + 10,
                y: -50,
                speed: adjustedSpeed
            };
            
            // DOM ìš”ì†Œ ìƒì„±
            const wordEl = document.createElement('div');
            wordEl.id = 'word-' + wordObj.id;
            wordEl.className = 'minigame-word';
            wordEl.style.cssText = `
                position: absolute;
                left: ${wordObj.x}px;
                top: ${wordObj.y}px;
                background: linear-gradient(135deg, #2c3e50, #34495e);
                color: white;
                padding: 8px 14px;
                border-radius: 20px;
                font-size: 1rem;
                font-weight: 600;
                white-space: nowrap;
                box-shadow: 0 4px 15px rgba(0,0,0,0.3);
                display: flex;
                align-items: center;
                gap: 6px;
                z-index: 10;
                transition: transform 0.1s;
            `;
            wordEl.innerHTML = `${enemy.word}`;
            
            area.appendChild(wordEl);
            minigameWords.push(wordObj);
        }
        
        function updateMinigameWords() {
            const area = document.getElementById('minigameArea');
            const areaHeight = area.offsetHeight;
            const settings = MINIGAME_SETTINGS[minigameDifficulty];
            
            minigameWords.forEach((wordObj, index) => {
                wordObj.y += wordObj.speed;
                
                const wordEl = document.getElementById('word-' + wordObj.id);
                if (wordEl) {
                    wordEl.style.top = wordObj.y + 'px';
                }
                
                // ë°”ë‹¥ì— ë„ë‹¬
                if (wordObj.y > areaHeight - 100) {
                    removeMinigameWord(wordObj.id, false);
                    minigameLives--;
                    
                    // ì •ë ¹ í”¼ê²© íš¨ê³¼
                    const spirit = document.getElementById('minigameSpirit');
                    spirit.style.transform = 'translateX(-50%) scale(0.8)';
                    spirit.style.filter = 'drop-shadow(0 4px 8px rgba(0,0,0,0.3)) brightness(0.5)';
                    setTimeout(() => {
                        spirit.style.transform = 'translateX(-50%) scale(1)';
                        spirit.style.filter = 'drop-shadow(0 4px 8px rgba(0,0,0,0.3))';
                    }, 300);
                    
                    updateMinigameUI();
                    
                    if (minigameLives <= 0) {
                        endMinigame();
                    }
                }
            });
        }
        
        function confirmMinigameInput() {
            const input = document.getElementById('minigameInput');
            const typed = input.value.trim();
            
            if (!typed) return;
            
            // ì •í™•íˆ ì¼ì¹˜í•˜ëŠ” ë‹¨ì–´ ì°¾ê¸° (ì—¬ëŸ¬ ê°œë©´ ì•„ë˜ì— ìˆëŠ” ê²ƒ ìš°ì„ )
            const exactMatches = minigameWords
                .filter(w => w.word === typed)
                .sort((a, b) => b.y - a.y);
            
            if (exactMatches.length > 0) {
                processMatchedWord(exactMatches[0], input);
            } else {
                // ì¼ì¹˜í•˜ëŠ” ë‹¨ì–´ ì—†ìŒ - ì…ë ¥ ì´ˆê¸°í™” (í‹€ë¦° ê²ƒ)
                setTimeout(() => {
                    input.value = '';
                }, 0);
            }
        }
        
        function processMatchedWord(matched, input) {
            // ì ìˆ˜ ê³„ì‚° (ë‹¨ì–´ ê¸¸ì´ + ë¹ ë¥¸ ì²˜ì¹˜ ë³´ë„ˆìŠ¤)
            const lengthBonus = matched.word.length * 10;
            const speedBonus = Math.max(0, Math.floor((400 - matched.y) / 10));
            minigameScore += lengthBonus + speedBonus;
            minigameDefeated++;
            
            // ì œê±° íš¨ê³¼
            removeMinigameWord(matched.id, true);
            
            // ë³´í˜¸ë§‰ íš¨ê³¼
            const shield = document.getElementById('shieldEffect');
            shield.style.opacity = '1';
            setTimeout(() => {
                shield.style.opacity = '0';
            }, 200);
            
            // ì…ë ¥ ì´ˆê¸°í™” (setTimeoutìœ¼ë¡œ ì¡°í•© ì™„ë£Œ í›„ í´ë¦¬ì–´)
            setTimeout(() => {
                input.value = '';
            }, 0);
            
            updateMinigameUI();
        }
        
        function removeMinigameWord(id, success) {
            const wordEl = document.getElementById('word-' + id);
            if (wordEl) {
                if (success) {
                    // ì„±ê³µ íš¨ê³¼
                    wordEl.style.transform = 'scale(1.3)';
                    wordEl.style.opacity = '0';
                    wordEl.style.background = 'linear-gradient(135deg, #27ae60, #2ecc71)';
                    setTimeout(() => wordEl.remove(), 200);
                } else {
                    // ì‹¤íŒ¨ íš¨ê³¼ (ë¹¨ê°„ìƒ‰)
                    wordEl.style.background = 'linear-gradient(135deg, #c0392b, #e74c3c)';
                    wordEl.style.transform = 'scale(0.5)';
                    wordEl.style.opacity = '0';
                    setTimeout(() => wordEl.remove(), 300);
                }
            }
            minigameWords = minigameWords.filter(w => w.id !== id);
        }
        
        function updateMinigameUI() {
            document.getElementById('minigameScore').textContent = minigameScore;
            
            let hearts = '';
            for (let i = 0; i < 3; i++) {
                hearts += i < minigameLives ? 'â¤ï¸' : 'ğŸ–¤';
            }
            document.getElementById('minigameLives').textContent = hearts;
        }
        
        function pauseMinigame() {
            minigamePaused = true;
        }
        
        function resumeMinigame() {
            minigamePaused = false;
            document.getElementById('minigameInput').focus();
        }
        
        function endMinigame() {
            minigameActive = false;
            
            // ëª¨ë°”ì¼ ëŒ€ì‘: body í´ë˜ìŠ¤ ì œê±°
            document.body.classList.remove('minigame-active');
            
            // ì¸í„°ë²Œ ì •ë¦¬
            if (minigameInterval) {
                clearInterval(minigameInterval);
                minigameInterval = null;
            }
            if (minigameSpawnInterval) {
                clearInterval(minigameSpawnInterval);
                minigameSpawnInterval = null;
            }
            if (minigameTimerInterval) {
                clearInterval(minigameTimerInterval);
                minigameTimerInterval = null;
            }
            
            // íƒ€ì´ë¨¸ ìƒ‰ìƒ ì´ˆê¸°í™”
            document.getElementById('minigameTimer').style.color = '';
            
            // ë‚¨ì€ ë‹¨ì–´ ì œê±°
            minigameWords.forEach(w => {
                const el = document.getElementById('word-' + w.id);
                if (el) el.remove();
            });
            minigameWords = [];
            
            // ê²°ê³¼ í™”ë©´ í‘œì‹œ
            document.getElementById('minigamePlay').style.display = 'none';
            document.getElementById('minigameResult').style.display = 'block';
            
            // ê²°ê³¼ ì—…ë°ì´íŠ¸
            document.getElementById('finalScore').textContent = minigameScore;
            document.getElementById('defeatedCount').textContent = minigameDefeated;
            
            // ê²°ê³¼ ì•„ì´ì½˜ & ë©”ì‹œì§€
            let icon, title;
            if (minigameScore >= 500) {
                icon = 'ğŸ†';
                title = 'ëŒ€ë‹¨í•´ìš”!';
            } else if (minigameScore >= 200) {
                icon = 'ğŸ‰';
                title = 'ì˜í–ˆì–´ìš”!';
            } else if (minigameScore >= 100) {
                icon = 'ğŸ‘';
                title = 'ì¢‹ì•„ìš”!';
            } else {
                icon = 'ğŸ’ª';
                title = 'ë‹¤ìŒì—” ë” ì˜í•  ìˆ˜ ìˆì–´ìš”!';
            }
            document.getElementById('resultIcon').textContent = icon;
            document.getElementById('resultTitle').textContent = title;
            
            // ë³´ìƒ ê³„ì‚° (ì½”ì¸ì€ ì ìˆ˜ì˜ 1/10 * ë‚œì´ë„ ë°°ìˆ˜)
            const settings = MINIGAME_SETTINGS[minigameDifficulty];
            const coinReward = Math.floor(minigameScore / 10 * settings.coinMultiplier);
            document.getElementById('coinRewardAmount').textContent = '+' + coinReward;
        }
        
        function claimReward(type) {
            const settings = MINIGAME_SETTINGS[minigameDifficulty];
            
            if (type === 'coin') {
                const reward = Math.floor(minigameScore / 10 * settings.coinMultiplier);
                coins += reward;
                updateCoinDisplay();
                saveGame();
                showNotification(`ğŸ’° ${reward} ì½”ì¸ì„ íšë“í–ˆìŠµë‹ˆë‹¤!`);
            } else if (type === 'item') {
                // ë‚œì´ë„ì™€ ì ìˆ˜ì— ë”°ë¼ ì•„ì´í…œ ë“±ê¸‰ ê²°ì •
                let itemPool = [];
                
                if (minigameDifficulty === 'hard' && minigameScore >= 400) {
                    // ì–´ë ¤ì›€ + ê³ ë“ì : ì „ì„¤ê¸‰ ì•„ì´í…œ (ë¯¸ë‹ˆê²Œì„ ì „ìš©)
                    itemPool = [
                        { type: 'decoration', item: 'fire_legendary', name: 'íƒœì´ˆì˜ ë¶ˆê½ƒ' },
                        { type: 'decoration', item: 'water_legendary', name: 'ì‹¬í•´ì˜ ì‹¬ì¥' },
                        { type: 'decoration', item: 'wind_legendary', name: 'í­í’ì˜ ëˆˆ' },
                        { type: 'decoration', item: 'earth_legendary', name: 'ëŒ€ì§€ì˜ ì •ìˆ˜' },
                        { type: 'decoration', item: 'light_legendary', name: 'ì²œìƒì˜ ê´‘íœ˜' },
                        { type: 'decoration', item: 'dark_legendary', name: 'ì˜ì›í•œ ì–´ë‘ ' }
                    ];
                    showNotification('ğŸŒŸ ì „ì„¤ê¸‰ ì•„ì´í…œ íšë“ ê¸°íšŒ!');
                } else if (minigameDifficulty === 'hard' && minigameScore >= 250) {
                    // ì–´ë ¤ì›€ + ì¤‘ê°„ ì ìˆ˜: ì—í”½ ì•„ì´í…œ
                    itemPool = [
                        { type: 'decoration', item: 'fire_epic', name: 'ë¶ˆì‚¬ì¡° ê¹ƒí„¸' },
                        { type: 'decoration', item: 'water_epic', name: 'ì¸ì–´ì˜ ëˆˆë¬¼' },
                        { type: 'decoration', item: 'wind_epic', name: 'í•˜ëŠ˜ì˜ ê¹ƒí„¸' },
                        { type: 'decoration', item: 'earth_epic', name: 'ì„¸ê³„ìˆ˜ ê°€ì§€' },
                        { type: 'decoration', item: 'light_epic', name: 'ë³„ì˜ íŒŒí¸' },
                        { type: 'decoration', item: 'dark_epic', name: 'ë°¤ì˜ ì •ìˆ˜' },
                        { type: 'food', item: 'light', name: 'ë¹›ë‚˜ëŠ” ë„¥íƒ€' },
                        { type: 'food', item: 'dark', name: 'ê²€ì€ ê½ƒê°€ë£¨' }
                    ];
                } else if (minigameScore >= 200) {
                    // ì‰¬ì›€ ê³ ë“ì  ë˜ëŠ” ì–´ë ¤ì›€ ì €ë“ì : ë ˆì–´ ì•„ì´í…œ
                    itemPool = [
                        { type: 'decoration', item: 'fire_rare1', name: 'ë¶ˆê½ƒ ì¡°ê°ìƒ' },
                        { type: 'decoration', item: 'water_rare1', name: 'ì‚°í˜¸ ì¥ì‹' },
                        { type: 'decoration', item: 'wind_rare1', name: 'í’ê²½' },
                        { type: 'decoration', item: 'earth_rare1', name: 'ë‚˜ë¬´ ì¡°ê°' },
                        { type: 'decoration', item: 'light_rare1', name: 'ë¹›ë‚˜ëŠ” ë³´ì„' },
                        { type: 'decoration', item: 'dark_rare1', name: 'ë‹¬ë¹›ì„' },
                        { type: 'food', item: 'light', name: 'ë¹›ë‚˜ëŠ” ë„¥íƒ€' },
                        { type: 'food', item: 'dark', name: 'ê²€ì€ ê½ƒê°€ë£¨' }
                    ];
                } else if (minigameScore >= 100) {
                    // ì¤‘ê°„ ì ìˆ˜: ì¼ë°˜ ì•„ì´í…œ
                    itemPool = [
                        { type: 'food', item: 'fire', name: 'ë¶ˆê½ƒì—´ë§¤' },
                        { type: 'food', item: 'water', name: 'ë§‘ì€ì´ìŠ¬' },
                        { type: 'food', item: 'wind', name: 'ë°”ëŒê¿€' },
                        { type: 'food', item: 'earth', name: 'ëŒ€ì§€ë²„ì„¯' },
                        { type: 'decoration', item: 'fire_common1', name: 'ìš©ì•”ì„' },
                        { type: 'decoration', item: 'water_common1', name: 'ë¶„ìˆ˜' },
                        { type: 'decoration', item: 'wind_common1', name: 'ë°”ëŒê°œë¹„' },
                        { type: 'decoration', item: 'earth_common1', name: 'í™”ë¶„' }
                    ];
                } else {
                    // ë‚®ì€ ì ìˆ˜: ê¸°ë³¸ ë¨¹ì´ë§Œ
                    itemPool = [
                        { type: 'food', item: 'fire', name: 'ë¶ˆê½ƒì—´ë§¤' },
                        { type: 'food', item: 'water', name: 'ë§‘ì€ì´ìŠ¬' },
                        { type: 'food', item: 'wind', name: 'ë°”ëŒê¿€' },
                        { type: 'food', item: 'earth', name: 'ëŒ€ì§€ë²„ì„¯' }
                    ];
                }
                
                const reward = itemPool[Math.floor(Math.random() * itemPool.length)];
                
                // ì¸ë²¤í† ë¦¬ì— ì¶”ê°€
                if (reward.type === 'food') {
                    inventory.food.push(reward.item);
                } else if (reward.type === 'decoration') {
                    inventory.decorations.push(reward.item);
                } else if (reward.type === 'music') {
                    inventory.music.push(reward.item);
                }
                
                // ì „ì„¤ê¸‰ ì•„ì´í…œì´ë©´ íŠ¹ë³„ ì•Œë¦¼
                const decoData = DECORATION_TYPES[reward.item];
                if (decoData && decoData.quality === 'legendary') {
                    showNotification(`ğŸŒŸ ì „ì„¤ê¸‰! ${decoData.icon} ${reward.name}ì„(ë¥¼) íšë“í–ˆìŠµë‹ˆë‹¤!`);
                } else {
                    showNotification(`ğŸ ${reward.name}ì„(ë¥¼) íšë“í–ˆìŠµë‹ˆë‹¤!`);
                }
                
                saveGame();
                renderInventory();
            }
            
            // ë³´ìƒ ë²„íŠ¼ ë¹„í™œì„±í™”
            document.getElementById('rewardSection').innerHTML = `
                <div style="color: var(--wind); font-size: 1.2rem; font-weight: 700;">âœ“ ë³´ìƒì„ ë°›ì•˜ìŠµë‹ˆë‹¤!</div>
            `;
        }
        
        function backToMinigameIntro() {
            document.getElementById('minigameIntro').style.display = 'block';
            document.getElementById('minigamePlay').style.display = 'none';
            document.getElementById('minigameResult').style.display = 'none';
            
            // ë³´ìƒ ì„¹ì…˜ ë³µêµ¬
            document.getElementById('rewardSection').innerHTML = `
                <h4 style="font-size: 1.2rem; margin-bottom: 20px; color: var(--text);">ë³´ìƒì„ ì„ íƒí•˜ì„¸ìš”</h4>
                <div style="display: flex; gap: 20px; justify-content: center; flex-wrap: wrap;">
                    <button onclick="claimReward('coin')" class="reward-btn" style="padding: 20px 30px; background: linear-gradient(135deg, #FFD700, #FFA500); color: #333; border: none; border-radius: 12px; cursor: pointer; min-width: 150px;">
                        <div style="font-size: 2rem; margin-bottom: 8px;">ğŸ’°</div>
                        <div style="font-weight: 700;">ì½”ì¸ ë°›ê¸°</div>
                        <div id="coinRewardAmount" style="font-size: 0.9rem; margin-top: 4px;">+0</div>
                    </button>
                    <button onclick="claimReward('item')" class="reward-btn" style="padding: 20px 30px; background: linear-gradient(135deg, #9B59B6, #8E44AD); color: white; border: none; border-radius: 12px; cursor: pointer; min-width: 150px;">
                        <div style="font-size: 2rem; margin-bottom: 8px;">ğŸ</div>
                        <div style="font-weight: 700;">ì•„ì´í…œ ë°›ê¸°</div>
                        <div style="font-size: 0.9rem; margin-top: 4px;">ëœë¤ ë³´ìƒ</div>
                    </button>
                </div>
            `;
        }
        // ==================== ë¯¸ë‹ˆê²Œì„ ë ====================

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        // ìƒì  ì•Œë¦¼ìš© ë³€ìˆ˜
        let shopNotificationData = {
            element: null,
            itemName: null,
            action: null, // 'buy' or 'sell'
            count: 0,
            price: 0,
            timeout: null
        };
        
        function showShopNotification(itemName, action, price) {
            // ê°™ì€ ì•„ì´í…œ, ê°™ì€ ì•¡ì…˜ì´ë©´ ê¸°ì¡´ ì•Œë¦¼ ì—…ë°ì´íŠ¸
            if (shopNotificationData.element && 
                shopNotificationData.itemName === itemName && 
                shopNotificationData.action === action) {
                
                shopNotificationData.count++;
                shopNotificationData.price += price;
                
                const actionText = action === 'sell' ? 'íŒë§¤' : 'êµ¬ë§¤';
                shopNotificationData.element.textContent = `${itemName}(ì„)ë¥¼ ${shopNotificationData.count}ê°œ ${shopNotificationData.price}ğŸ’°ì— ${actionText}í–ˆìŠµë‹ˆë‹¤`;
                
                // íƒ€ì´ë¨¸ ë¦¬ì…‹
                if (shopNotificationData.timeout) {
                    clearTimeout(shopNotificationData.timeout);
                }
                
                const currentElement = shopNotificationData.element;
                shopNotificationData.timeout = setTimeout(() => {
                    // í˜„ì¬ elementê°€ ì €ì¥ëœ elementì™€ ê°™ì„ ë•Œë§Œ ì²˜ë¦¬
                    if (currentElement && currentElement === shopNotificationData.element) {
                        currentElement.style.animation = 'slideOut 0.3s ease-out';
                        setTimeout(() => {
                            if (currentElement.parentNode) {
                                currentElement.remove();
                            }
                            // ì•„ì§ ê°™ì€ elementë¥¼ ê°€ë¦¬í‚¤ê³  ìˆì„ ë•Œë§Œ ì´ˆê¸°í™”
                            if (shopNotificationData.element === currentElement) {
                                shopNotificationData = { element: null, itemName: null, action: null, count: 0, price: 0, timeout: null };
                            }
                        }, 300);
                    }
                }, 2000);
                
                return;
            }
            
            // ê¸°ì¡´ ìƒì  ì•Œë¦¼ì´ ìˆìœ¼ë©´ ì¦‰ì‹œ ì œê±°
            if (shopNotificationData.element) {
                if (shopNotificationData.element.parentNode) {
                    shopNotificationData.element.remove();
                }
                if (shopNotificationData.timeout) {
                    clearTimeout(shopNotificationData.timeout);
                }
            }
            
            // ìƒˆ ì•Œë¦¼ ìƒì„±
            const notif = document.createElement('div');
            notif.className = 'notification shop-notification';
            const actionText = action === 'sell' ? 'íŒë§¤' : 'êµ¬ë§¤';
            notif.textContent = `${itemName}(ì„)ë¥¼ 1ê°œ ${price}ğŸ’°ì— ${actionText}í–ˆìŠµë‹ˆë‹¤`;
            notif.style.top = '80px';
            document.body.appendChild(notif);
            
            shopNotificationData = {
                element: notif,
                itemName: itemName,
                action: action,
                count: 1,
                price: price,
                timeout: setTimeout(() => {
                    // í˜„ì¬ notifê°€ ì €ì¥ëœ elementì™€ ê°™ì„ ë•Œë§Œ ì²˜ë¦¬
                    if (notif === shopNotificationData.element) {
                        notif.style.animation = 'slideOut 0.3s ease-out';
                        setTimeout(() => {
                            if (notif.parentNode) {
                                notif.remove();
                            }
                            // ì•„ì§ ê°™ì€ elementë¥¼ ê°€ë¦¬í‚¤ê³  ìˆì„ ë•Œë§Œ ì´ˆê¸°í™”
                            if (shopNotificationData.element === notif) {
                                shopNotificationData = { element: null, itemName: null, action: null, count: 0, price: 0, timeout: null };
                            }
                        }, 300);
                    }
                }, 2000)
            };
        }
        
        function showNotification(message) {
            // ê¸°ì¡´ ì•Œë¦¼ë“¤ì˜ ê°œìˆ˜ë¥¼ ì„¸ì„œ ìœ„ì¹˜ ì¡°ì • (ìƒì  ì•Œë¦¼ ì œì™¸)
            const existingNotifs = document.querySelectorAll('.notification:not(.shop-notification)');
            const shopNotifExists = document.querySelector('.shop-notification') ? 1 : 0;
            const offset = (existingNotifs.length + shopNotifExists) * 70;
            
            const notif = document.createElement('div');
            notif.className = 'notification';
            notif.textContent = message;
            notif.style.top = `${80 + offset}px`;
            document.body.appendChild(notif);
            
            setTimeout(() => {
                notif.style.animation = 'slideOut 0.3s ease-out';
                setTimeout(() => notif.remove(), 300);
            }, 3000);
        }
        
        // í‚¤ì›Œë“œ ì„¤ëª… í‘œì‹œ (ëª¨ë°”ì¼ìš© í´ë¦­/í„°ì¹˜)
        function showKeywordDesc(keyword, desc) {
            if (!desc) return;
            
            // ê¸°ì¡´ í‚¤ì›Œë“œ íˆ´íŒì´ ìˆìœ¼ë©´ ì œê±°
            const existingTooltip = document.querySelector('.keyword-tooltip');
            if (existingTooltip) {
                existingTooltip.remove();
            }
            
            const tooltip = document.createElement('div');
            tooltip.className = 'keyword-tooltip';
            tooltip.innerHTML = `
                <div style="font-weight: 600; margin-bottom: 6px; color: var(--text);">${keyword}</div>
                <div style="color: #666; line-height: 1.5;">${desc}</div>
            `;
            tooltip.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: var(--card);
                border: 2px solid var(--border);
                border-radius: 12px;
                padding: 16px 20px;
                max-width: 300px;
                box-shadow: 0 4px 20px rgba(0,0,0,0.2);
                z-index: 10001;
                animation: fadeIn 0.2s ease-out;
            `;
            
            // ë°°ê²½ ì˜¤ë²„ë ˆì´
            const overlay = document.createElement('div');
            overlay.className = 'keyword-tooltip-overlay';
            overlay.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0,0,0,0.3);
                z-index: 10000;
            `;
            overlay.onclick = () => {
                tooltip.remove();
                overlay.remove();
            };
            
            document.body.appendChild(overlay);
            document.body.appendChild(tooltip);
            
            // 3ì´ˆ í›„ ìë™ ë‹«ê¸°
            setTimeout(() => {
                if (document.body.contains(tooltip)) {
                    tooltip.remove();
                    overlay.remove();
                }
            }, 5000);
        }

        function updateTimeDisplay() {
            const now = new Date();
            const timeStr = now.toLocaleTimeString('ko-KR', { 
                hour: '2-digit', 
                minute: '2-digit',
                second: '2-digit'
            });
            document.getElementById('timeDisplay').textContent = timeStr;
        }

        // ê²Œì„ ë£¨í”„
        setInterval(() => {
            saveGame();
        }, 5000);

        // 1ì´ˆë§ˆë‹¤ ë²„íŠ¼ ìƒíƒœ ë° ì •ë ¹ ìƒíƒœ ì²´í¬
        setInterval(() => {
            if (isPaused) {
                // ì¼ì‹œì •ì§€ ì¤‘ì—ëŠ” ì±„ì§‘ ë²„íŠ¼ë§Œ ì—…ë°ì´íŠ¸
                updateGatherButton();
                return;
            }
            checkSpiritStatus();
            // garden íƒ­ì´ í™œì„±í™”ëœ ê²½ìš°ì—ë§Œ ì¹´ë“œ ì—…ë°ì´íŠ¸
            if (currentTab === 'garden') {
                updateCooldownDisplay();  // ì¿¨íƒ€ì„ í…ìŠ¤íŠ¸ë§Œ ì—…ë°ì´íŠ¸ (ì„±ëŠ¥ ìµœì í™”)
                spirits.forEach(spirit => {
                    updateSpiritCard(spirit);
                });
            }
            updateGatherButton();
        }, 1000);

        // 1ë¶„ë§ˆë‹¤ ì„±ì¥ë„ ì¦ê°€
        setInterval(() => {
            if (isPaused) return; // ì´ì¤‘ ì²´í¬
            applyGrowth();
        }, 60000);  // 60000ms = 1ë¶„

        // 5ë¶„ë§ˆë‹¤ í…Œë¼ë¦¬ì›€ í™˜ê²½ íš¨ê³¼ ì ìš©
        setInterval(() => {
            if (isPaused) return; // ì´ì¤‘ ì²´í¬
            applyTerrariumGrowth();
        }, 300000);  // 300000ms = 5ë¶„

        // ë§Œì¡±ë„ ì—…ë°ì´íŠ¸ (1ë¶„ë§ˆë‹¤)
        setInterval(() => {
            if (isPaused) return; // ì¼ì‹œì •ì§€ ì¤‘ì´ë©´ ì‹¤í–‰ ì•ˆ í•¨
            if (tutorialActive) return; // ì²« íŠœí† ë¦¬ì–¼ ì¤‘ì´ë©´ ì‹¤í–‰ ì•ˆ í•¨
            
            spirits.forEach(spirit => {
                if (spirit.isDead || spirit.isCompleted) return;
                
                // ì„±ì¥ë„ ì²´í¬ (100 ì´ìƒì´ë©´ ìë™ ì§„í™”)
                if (spirit.growth >= STAGE_REQUIREMENTS.adult && !spirit.isCompleted) {
                    completeSpirit(spirit);
                    return;
                }
                
                const oldSatisfaction = spirit.satisfaction || 'mid';
                const newSatisfaction = calculateSatisfaction(spirit);
                spirit.satisfaction = newSatisfaction;
                
                // ë§Œì¡±ë„ ë†’ì„ ë•Œ ì• ì •ë„ ì¦ê°€
                if (newSatisfaction === 'high') {
                    spirit.parameters.affection += 1;
                }
                
                // ë§Œì¡±ë„ ë‚®ì„ ë•Œ ì• ì •ë„ ê°ì†Œ
                if (newSatisfaction === 'low') {
                    spirit.parameters.affection = Math.max(0, spirit.parameters.affection - 1);
                }
                
                // ë§Œì¡±ë„ê°€ ë³€ê²½ë˜ì—ˆì„ ë•Œ ë¡œê·¸
                if (oldSatisfaction !== newSatisfaction) {
                    const satisfactionTexts = {
                        high: 'ë§¤ìš° ë§Œì¡±ìŠ¤ëŸ¬ì›Œ ë³´ì…ë‹ˆë‹¤!',
                        mid: 'í‰ì˜¨í•´ ë³´ì…ë‹ˆë‹¤.',
                        low: 'ë¶ˆë§Œì¡±ìŠ¤ëŸ¬ì›Œ ë³´ì…ë‹ˆë‹¤...'
                    };
                    addLog(spirit, satisfactionTexts[newSatisfaction]);
                }
            });
            saveGame();
            updateAllSpiritCards();
        }, 60000); // 60ì´ˆë§ˆë‹¤

        setInterval(updateTimeDisplay, 1000);
        setInterval(updateRandomMessages, 15000); // 15ì´ˆë§ˆë‹¤ ëœë¤ ë©”ì‹œì§€ ì—…ë°ì´íŠ¸
        setInterval(checkNeglect, 60000); // 1ë¶„ë§ˆë‹¤ ë°©ì¹˜ ì²´í¬

        // ì˜¤í”„ë‹ ìŠ¤í† ë¦¬
        const OPENING_SCENES = [
            "ë¨¼ ë¯¸ë˜...",
            "ì¸ê°„ë“¤ì— ì˜í•œ ì˜¤ì—¼ìœ¼ë¡œ\nì§€êµ¬ì—ì„œ ì •ë ¹ë“¤ì˜ ì„œì‹ì§€ê°€\nì¤„ì–´ë“¤ê¸° ì‹œì‘í–ˆë‹¤.",
            "ìì—°ìŠ¤ëŸ½ê²Œ ì •ë ¹ë“¤ì˜ ìˆ«ìëŠ” ì¤„ì–´ë“¤ì–´ê°”ê³ \nì§€êµ¬ì˜ ìì •ì‘ìš©ì€ ê¸°ëŠ¥ì„ ìƒê²Œ ëœë‹¤.",
            "í‘¸ë¥¸ ìì—°ì€ ì‚¬ë¼ì§€ê³ \nê¸°ê³„ì™€ ì“°ë ˆê¸°ì˜ ì‚°ë§Œ ìŒ“ì—¬ê°€ë˜ ì–´ëŠ ë‚ ...",
            "ì •ë ¹ì˜ ì•Œì´ ì—´ë¦¬ëŠ” ì‹ë¬¼ì„\në°œê²¬í•œ ì¸ê°„ì´ ìˆì—ˆë‹¤.",
            "ëª¨ë‘ê°€ ë¶ˆê°€ëŠ¥í•˜ë¦¬ë¼ ì˜ˆìƒí–ˆì§€ë§Œ\nê·¸ëŠ” ì‘ì€ í…Œë¼ë¦¬ì›€ ì•ˆì—ì„œ\nì •ë ¹ì„ ê¸¸ëŸ¬ë‚´ëŠ” ë° ì„±ê³µí•œë‹¤.",
            "ê·¸ ì´í›„ë¡œë„ ê·¸ë¥¼ ë”°ë¼\ní…Œë¼ë¦¬ì›€ì—ì„œ ì •ë ¹ì„ ì¸ê³µì‚¬ìœ¡í•˜ì—¬\nìì—°ìœ¼ë¡œ ë°©ì‚¬í•˜ëŠ” ì‚¬ëŒë“¤ì´ ëŠ˜ì–´ê°”ë‹¤.",
            "ë‹¤ë¥¸ ì‚¬ëŒë“¤ì€ ê·¸ë“¤ì„\n'í…Œë¼ë¦¬ì›€ í‚¤í¼'ë¼ê³  ë¶ˆë €ë‹¤.",
            "ì´ê²ƒì€ ì‘ì€ í…Œë¼ë¦¬ì›€ì—ì„œ ì‹œì‘ë˜ëŠ”\në‹¹ì‹ ì˜ ì´ì•¼ê¸°."
        ];
        
        let currentOpeningScene = 0;
        
        function showOpening() {
            console.log('showOpening í•¨ìˆ˜ ì‹¤í–‰ë¨');
            const modal = document.getElementById('openingModal');
            console.log('ëª¨ë‹¬ ìš”ì†Œ:', modal);
            if (modal) {
                modal.style.display = 'flex';
                currentOpeningScene = 0;
                showOpeningText();
                console.log('ì˜¤í”„ë‹ ëª¨ë‹¬ í‘œì‹œë¨');
            } else {
                console.error('ì˜¤í”„ë‹ ëª¨ë‹¬ì„ ì°¾ì„ ìˆ˜ ì—†ìŒ!');
            }
        }
        
        function showOpeningText() {
            const textEl = document.getElementById('openingText');
            const nextBtn = document.getElementById('openingNextBtn');
            
            textEl.style.opacity = '0';
            
            setTimeout(() => {
                textEl.innerHTML = OPENING_SCENES[currentOpeningScene].replace(/\n/g, '<br>');
                textEl.style.opacity = '1';
                
                setTimeout(() => {
                    nextBtn.style.display = 'inline-block';
                    if (currentOpeningScene === OPENING_SCENES.length - 1) {
                        nextBtn.textContent = 'ì‹œì‘í•˜ê¸°';
                    } else {
                        nextBtn.textContent = 'ë‹¤ìŒ';
                    }
                }, 500);
            }, 300);
        }
        
        function nextOpeningScene() {
            const nextBtn = document.getElementById('openingNextBtn');
            nextBtn.style.display = 'none';
            
            currentOpeningScene++;
            
            if (currentOpeningScene >= OPENING_SCENES.length) {
                closeOpening();
            } else {
                showOpeningText();
            }
        }
        
        function skipOpening() {
            closeOpening();
        }
        
        function closeOpening() {
            const modal = document.getElementById('openingModal');
            modal.style.opacity = '0';
            modal.style.transition = 'opacity 0.5s';
            
            setTimeout(() => {
                modal.style.display = 'none';
                modal.style.opacity = '1';
                // ì˜¤í”„ë‹ ë³¸ ê²ƒìœ¼ë¡œ ì €ì¥
                localStorage.setItem('spiritGarden_openingSeen', 'true');
                // íŠœí† ë¦¬ì–¼ ì‹œì‘
                startTutorial();
            }, 500);
        }
        
        // ========== íŠœí† ë¦¬ì–¼ ì‹œìŠ¤í…œ ==========
        let tutorialStep = 0;
        let tutorialActive = false;
        
        const TUTORIAL_STEPS = [
            {
                type: 'dialog',
                text: 'ì•„, ìƒˆë¡œ ì˜¨ ìˆ˜ìŠµì´ ë„ˆêµ¬ë‚˜? ì–´ì„œì™€! ë‚˜ëŠ” ì´ ì—°êµ¬ì†Œë¥¼ ê´€ë¦¬í•˜ëŠ” í…Œë¼ë¦¬ì›€ í‚¤í¼ê³  ì•ìœ¼ë¡œ ë„ ì±…ì„ì§ˆ ì„ ë°°ì•¼.'
            },
            {
                type: 'dialog',
                text: 'ì¼ì„ í•˜ëŠ”ê±´ ì²˜ìŒì´ë‹ˆ ê¸°ë³¸ì ì¸ ê²ƒë“¤ì„ ì•Œë ¤ì¤„ê²Œ. ì˜ ë“¤ì–´ë‘¬.'
            },
            {
                type: 'action',
                action: 'getEgg',
                text: 'ì, ë¨¼ì € ì •ë ¹ ì•Œì„ ë°›ì•„ë³´ì. ì•„ë˜ë¡œ ë‚´ë¦¬ë©´ "ìƒˆë¡œìš´ ì•Œ ë°›ê¸°" ë²„íŠ¼ì´ ìˆì„ê±°ì•¼.'
            },
            {
                type: 'dialog',
                text: 'ì˜í•˜ëŠ”ë°? ì •ë ¹ë“¤ì˜ ì•Œì€ ì •ë ¹ë‚˜ë¬´ì˜ ì—´ë§¤ë¼ëŠ”ê±° ì•Œì§€? ì´ ì•Œë“¤ì€ ê¸°ë³¸ì ìœ¼ë¡œ ë¬´ì†ì„±ì´ì•¼.'
            },
            {
                type: 'dialog',
                text: 'ê·¸ë¦¬ê³  ë¨¹ì´ì™€ í…Œë¼ë¦¬ì›€ì„ ê¾¸ë©° ì†ì„±ì„ ê°€ì§„ ì •ë ¹ìœ¼ë¡œ ìë„ ìˆ˜ ìˆê²Œ ê´€ë¦¬í•˜ëŠ” ê²Œ ìš°ë¦¬ í…Œë¼ë¦¬ì›€ í‚¤í¼ë“¤ì˜ ì„ë¬´ì§€.'
            },
            {
                type: 'action',
                action: 'feed',
                text: 'ì•„ì°¨, ë§ì´ ë„ˆë¬´ ê¸¸ì–´ì¡Œë„¤. ì•Œì´ ë°°ê³ íŒŒí•˜ëŠ” ê²ƒ ê°™ì€ë°? "ë¨¹ì´ì£¼ê¸°" ë²„íŠ¼ì„ ëˆŒëŸ¬ì„œ ë¨¹ì´ë¥¼ ì¤˜ë´.'
            },
            {
                type: 'dialog',
                text: 'ë¨¹ì´ë§ˆë‹¤ ë‹¤ë¥¸ ì†ì„±ì´ ìˆì–´ì„œ, ì–´ë–¤ ë¨¹ì´ë¥¼ ì£¼ëŠëƒì— ë”°ë¼ ì •ë ¹ì˜ ì†ì„±ì¹˜ê°€ ë‹¬ë¼ì ¸.'
            },
            {
                type: 'action',
                action: 'music',
                text: 'ê·¸ë¦¬ê³  ì •ë ¹ë“¤ì˜ ì–¸ì–´ê°€ ë…¸ë˜ë¼ëŠ” ê²ƒë„ í•™ì›ì—ì„œ ë°°ì› ê² ì§€? ì •ë ¹ë“¤ì€ ë…¸ë˜ë¥¼ ë“¤ìœ¼ë©° ì„¸ìƒì˜ ì§€ì‹ì„ í¡ìˆ˜í•´. "ìŒì•… ë“£ê¸°"ë¥¼ ëˆŒëŸ¬ë´.'
            },
            {
                type: 'dialog',
                text: 'ìŒì•…ë„ ì¢…ë¥˜ë§ˆë‹¤ ë‹¤ë¥¸ ëŠ¥ë ¥ì¹˜ë¥¼ ì˜¬ë ¤ì¤˜. í´ë˜ì‹ì€ ì§€ë ¥, íŒì€ ë§¤ë ¥ ê°™ì€ ì‹ì´ì§€.'
            },
            {
                type: 'action',
                action: 'pat',
                text: 'ì–´ì°¨í”¼ ë– ë‚˜ë³´ë‚´ì•¼ í•œë‹¤ê³  ë¨¹ì´ë§Œ ì£¼ëŠ” ë…€ì„ë“¤ë„ ìˆì§€ë§Œ... ìš°ë¦¬ ì—°êµ¬ì†ŒëŠ” ì •ë ¹ê³¼ êµê°í•˜ëŠ” ê²ƒë„ ì¤‘ìš”í•˜ë‹¤ê³  ìƒê°í•´. "ì“°ë‹¤ë“¬ê¸°"ë¥¼ ëˆŒëŸ¬ë´.'
            },
            {
                type: 'action',
                action: 'clickName',
                text: 'ê·¸ë¦¬ê³  ì •ë ¹ì—ê²Œ ì´ë¦„ì„ ì§€ì–´ì¤„ ìˆ˜ë„ ìˆì–´. ì •ë ¹ ì¹´ë“œì—ì„œ ë…¸ë€ìƒ‰ìœ¼ë¡œ ê°•ì¡°ëœ ì´ë¦„ ë¶€ë¶„ì„ ëˆŒëŸ¬ë´.'
            },
            {
                type: 'action',
                action: 'rename',
                text: 'ì, ì…ë ¥ì°½ì— ìƒˆ ì´ë¦„ì„ ì§€ì–´ì£¼ê³  í™•ì¸ì„ ëˆ„ë¥´ë©´ ë¼.'
            },
            {
                type: 'dialog',
                text: 'ì˜í–ˆì–´. ê¼­ ì´ë¦„ì„ ì§€ì–´ì¤˜ì•¼ í•˜ëŠ” ê±´ ì•„ë‹ˆì§€ë§Œ, ê·¸ë˜ë„ ë¶ˆëŸ¬ì¤„ ì´ë¦„ì´ ìˆëŠ” í¸ì´ í›¨ì”¬ ì¢‹ë‹¤ê³  ìƒê°í•˜ê±°ë“ .'
            },
            {
                type: 'dialog',
                text: 'ì´ê²Œ ê¸°ë³¸ì ì¸ ì •ë ¹ ìœ¡ì„± ë°©ë²•ì´ì•¼. í…Œë¼ë¦¬ì›€ ê´€ë¦¬ê¹Œì§€ ìƒê°í•˜ë©´ ë” ë³µì¡í•˜ì§€ë§Œ ê·¸ê±´ ì²œì²œíˆ ìµíˆë„ë¡ í•´.'
            },
            {
                type: 'dialog',
                text: 'ì•„ê¹Œ ì†ì„± ì´ì•¼ê¸°ë¥¼ ì ê¹ í–ˆì§€? ì´ë¯¸ ì•Œê³  ìˆê² ì§€ë§Œ ë³µìŠµí•  ê²¸ ë‹¤ì‹œ ì´ì•¼ê¸°í•˜ìë©´.'
            },
            {
                type: 'dialog',
                text: 'ì†ì„±ì—ëŠ” <span style="color:#e74c3c;font-weight:bold;">ë¶ˆ</span>, <span style="color:#3498db;font-weight:bold;">ë¬¼</span>, <span style="color:#27ae60;font-weight:bold;">ë•…</span>, <span style="color:#1abc9c;font-weight:bold;">ë°”ëŒ</span> ê¸°ë³¸ 4ëŒ€ì›ì†Œì™€ í¬ê·€ì›ì†Œì¸ <span style="color:#f1c40f;font-weight:bold;">ë¹›</span>, <span style="color:#9b59b6;font-weight:bold;">ì–´ë‘ </span>ì´ ìˆì–´.'
            },
            {
                type: 'dialog',
                text: 'ìœ ì¶© ìƒíƒœì˜ ì •ë ¹ì€ ì´ ì—¬ì„¯ ê°€ì§€ ì†ì„±ì˜ ì˜í–¥ì„ ë°›ì•„ ìë¼ê²Œ ë¼. ë¶ˆì†ì„±ì„ ë§ì´ ì ‘í•˜ë©´ ë¶ˆì˜ ì •ë ¹ì´ ë˜ê³ , ë¬¼ì†ì„±ì„ ë§ì´ ì ‘í•˜ë©´ ë¬¼ì˜ ì •ë ¹ì´ ë˜ì§€.'
            },
            {
                type: 'dialog',
                text: 'ê°€ë” ë‘ ê°€ì§€ ì†ì„±ì´ ì„ì—¬ ë‹¤ë¥¸ ì†ì„±ì˜ ì •ë ¹ìœ¼ë¡œ ì§„í™”í•˜ê¸°ë„ í•˜ì§€ë§Œ, ì²˜ìŒì—” í•œ ê°€ì§€ ì†ì„±ì— ì§‘ì¤‘í•˜ëŠ” ê²Œ ì¢‹ì•„.'
            },
            {
                type: 'dialog',
                text: 'ê·¸ë¦¬ê³  ë‹¤ë¥¸ ì†ì„±ì´ ë‘ ê°œ ë” ìˆëŠ”ë°... ê·¸ê±´ ë°”ë¡œ <span style="color:#f39c12;font-weight:bold;">íƒœì–‘</span>ê³¼ <span style="color:#95a5a6;font-weight:bold;">ë‹¬</span>ì´ì•¼.'
            },
            {
                type: 'action',
                action: 'toggleLight',
                text: 'íƒ­ ë§¨ ì˜¤ë¥¸ìª½ì— ìˆëŠ” íƒœì–‘ ë²„íŠ¼ì„ ëˆŒëŸ¬ë³¼ë˜?'
            },
            {
                type: 'dialog',
                text: 'ê·¸ ë²„íŠ¼ìœ¼ë¡œ í…Œë¼ë¦¬ì›€ì˜ ì¡°ë„ë¥¼ ì„¤ì •í•  ìˆ˜ ìˆì–´. ì¡°ë„ì˜ ì–‘ì— ë”°ë¼ <span style="color:#95a5a6;font-weight:bold;">ë‹¬</span>ì˜ ì •ë ¹ì´ ë˜ëŠ”ì§€ <span style="color:#f39c12;font-weight:bold;">íƒœì–‘</span>ì˜ ì •ë ¹ì´ ë˜ëŠ”ì§€ ë‹¬ë¼ì§€ë‹ˆê¹Œ ì´ê²ƒë„ ì‹ ê²½ì“°ëŠ” ê²Œ ì¢‹ì•„.'
            },
            {
                type: 'dialog',
                text: 'ê·¸ë¦¬ê³  ë¨¹ì´ë‚˜ ë ˆì½”ë“œ, í…Œë¼ë¦¬ì›€ì„ ì¥ì‹í•  ì¥ì‹í’ˆë“¤ì€ ì±„ì§‘ìœ¼ë¡œ ì–»ì„ ìˆ˜ ìˆì–´.'
            },
            {
                type: 'dialog',
                text: 'ë„ì €íˆ ì°¾ì„ ìˆ˜ ì—†ëŠ” ê²Œ ìˆë‹¤ë©´ ìƒì ì— ê°€ë©´ ë˜ê³ .'
            },
            {
                type: 'dialog',
                text: 'ë„ˆë¬´ ìª¼ë“¤ë¦°ë‹¤ë©´ ì•„ë¥´ë°”ì´íŠ¸ë„ í•´ì•¼ í•˜ë‹ˆê¹Œ ê°ì˜¤í•´. ì „ì„¸ê³„ ëª¨ë“  í…Œë¼ë¦¬ì›€ ê´€ë¦¬ ì—°êµ¬ì†Œê°€ ê·¸ë ‡ì§€ë§Œ ì—°êµ¬ë¹„ê°€ ë„‰ë„‰ì¹˜ ì•Šê±°ë“ .'
            },
            {
                type: 'dialog',
                text: 'ì, ê·¸ëŸ¼ ì„ ë°°ë¡œì„œ ì„¤ëª…í•´ì¤„ ê±´ ì—¬ê¸°ê¹Œì§€ì•¼. ë‚˜ë¨¸ì§€ëŠ” ì§ì ‘ ë¶€ë”ªí˜€ ê°€ë©´ì„œ ë°°ìš°ë„ë¡ í•´. ê·¸ëŸ¼ ì´ë§Œ!'
            }
        ];
        
        // íŠœí† ë¦¬ì–¼ ë‹¤ì‹œë³´ê¸° ëª©ë¡ ë Œë”ë§
        function renderTutorialReplayList() {
            const container = document.getElementById('tutorialReplayList');
            if (!container) return;
            
            const tutorials = [
                {
                    id: 'basic',
                    name: 'ê¸°ë³¸ íŠœí† ë¦¬ì–¼',
                    desc: 'ì •ë ¹ ìœ¡ì„±ì˜ ê¸°ì´ˆë¥¼ ë°°ì›ë‹ˆë‹¤',
                    icon: 'ğŸ¥š',
                    gradient: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                    seenKey: 'spiritGarden_tutorialSeen',
                    completedKey: 'spiritGarden_tutorialCompleted',
                    reward: 25,
                    alwaysUnlocked: true // ê¸°ë³¸ íŠœí† ë¦¬ì–¼ì€ í•­ìƒ ì—´ë ¤ìˆìŒ
                },
                {
                    id: 'album',
                    name: 'ì•¨ë²” & ë„ê° íŠœí† ë¦¬ì–¼',
                    desc: 'ì •ë ¹ ì™„ì„± í›„ ì•¨ë²”ê³¼ ë„ê° ì‚¬ìš©ë²•',
                    icon: 'ğŸ’',
                    gradient: 'linear-gradient(135deg, #f093fb 0%, #f5576c 100%)',
                    seenKey: 'spiritGarden_tutorial2Seen',
                    completedKey: 'spiritGarden_tutorial2Completed',
                    reward: 25,
                    unlockCondition: () => collection.length > 0 // ì•¨ë²”ì— ì •ë ¹ì´ ìˆì–´ì•¼ í•´ê¸ˆ
                },
                {
                    id: 'sick',
                    name: 'ì§ˆë³‘ íŠœí† ë¦¬ì–¼',
                    desc: 'ì •ë ¹ì´ ì•„í”Œ ë•Œ ì¹˜ë£Œí•˜ëŠ” ë°©ë²•',
                    icon: 'ğŸ’Š',
                    gradient: 'linear-gradient(135deg, #4facfe 0%, #00f2fe 100%)',
                    seenKey: 'spiritGarden_sickTutorialSeen',
                    completedKey: 'spiritGarden_sickTutorialCompleted',
                    reward: 25,
                    unlockCondition: () => localStorage.getItem('spiritGarden_tutorialSeen') // ê¸°ë³¸ íŠœí† ë¦¬ì–¼ ì™„ë£Œ í›„
                },
                {
                    id: 'lab',
                    name: 'ì—°êµ¬ì‹¤ íŠœí† ë¦¬ì–¼',
                    desc: 'í•©ì„±ê³¼ ì—°ê²° ì‹œìŠ¤í…œ ì‚¬ìš©ë²•',
                    icon: 'ğŸ”¬',
                    gradient: 'linear-gradient(135deg, #fa709a 0%, #fee140 100%)',
                    seenKey: 'spiritGarden_labTutorialSeen',
                    completedKey: 'spiritGarden_labTutorialCompleted',
                    reward: 25,
                    unlockCondition: () => collection.length >= 2 // ì•¨ë²”ì— ì •ë ¹ 2ë§ˆë¦¬ ì´ìƒ
                }
            ];
            
            let html = '';
            
            tutorials.forEach(tutorial => {
                const seen = localStorage.getItem(tutorial.seenKey);
                const completed = localStorage.getItem(tutorial.completedKey);
                // ì´ë¯¸ ë³¸ íŠœí† ë¦¬ì–¼ì€ í•­ìƒ í•´ê¸ˆ ìƒíƒœë¡œ í‘œì‹œ
                const isUnlocked = tutorial.alwaysUnlocked || seen || (tutorial.unlockCondition && tutorial.unlockCondition());
                
                if (!isUnlocked) {
                    // ì ê¸´ íŠœí† ë¦¬ì–¼
                    html += `
                        <div style="padding: 16px; background: #333; color: #666; border: none; border-radius: 10px; font-size: 1rem; display: flex; align-items: center; gap: 12px; opacity: 0.6;">
                            <span style="font-size: 1.5rem;">ğŸ”’</span>
                            <div style="flex: 1;">
                                <div style="font-weight: 600;">${tutorial.name}</div>
                                <div style="font-size: 0.8rem; margin-top: 4px;">ì¡°ê±´ì„ ë‹¬ì„±í•˜ë©´ í•´ê¸ˆë©ë‹ˆë‹¤</div>
                            </div>
                        </div>
                    `;
                } else {
                    // í•´ê¸ˆëœ íŠœí† ë¦¬ì–¼
                    html += `
                        <div style="display: flex; gap: 10px; align-items: stretch;">
                            <button onclick="replayTutorial('${tutorial.id}')" style="flex: 1; padding: 16px; background: ${tutorial.gradient}; color: white; border: none; border-radius: 10px; font-size: 1rem; font-weight: 600; cursor: pointer; text-align: left; display: flex; align-items: center; gap: 12px;">
                                <span style="font-size: 1.5rem;">${tutorial.icon}</span>
                                <div>
                                    <div>${tutorial.name}</div>
                                    <div style="font-size: 0.8rem; opacity: 0.8; margin-top: 4px;">${tutorial.desc}</div>
                                </div>
                            </button>
                            ${completed ? 
                                `<div style="padding: 16px; background: #2d5a2d; color: #7fbf7f; border-radius: 10px; display: flex; align-items: center; justify-content: center; min-width: 90px; font-weight: 600;">
                                    âœ“ ì™„ë£Œ
                                </div>` :
                                (seen ?
                                    `<button onclick="claimTutorialReward('${tutorial.id}')" style="padding: 16px; background: linear-gradient(135deg, #f1c40f 0%, #f39c12 100%); color: #333; border: none; border-radius: 10px; cursor: pointer; min-width: 90px; font-weight: 700; font-size: 0.9rem;">
                                        ğŸ’° +${tutorial.reward}
                                    </button>` :
                                    `<div style="padding: 16px; background: #444; color: #888; border-radius: 10px; display: flex; align-items: center; justify-content: center; min-width: 90px; font-size: 0.85rem;">
                                        ë¯¸ì™„ë£Œ
                                    </div>`
                                )
                            }
                        </div>
                    `;
                }
            });
            
            container.innerHTML = html;
        }
        
        // íŠœí† ë¦¬ì–¼ ë³´ìƒ ë°›ê¸°
        function claimTutorialReward(tutorialId) {
            const rewardMap = {
                'basic': { completedKey: 'spiritGarden_tutorialCompleted', seenKey: 'spiritGarden_tutorialSeen', reward: 25, name: 'ê¸°ë³¸ íŠœí† ë¦¬ì–¼' },
                'album': { completedKey: 'spiritGarden_tutorial2Completed', seenKey: 'spiritGarden_tutorial2Seen', reward: 25, name: 'ì•¨ë²” & ë„ê° íŠœí† ë¦¬ì–¼' },
                'sick': { completedKey: 'spiritGarden_sickTutorialCompleted', seenKey: 'spiritGarden_sickTutorialSeen', reward: 25, name: 'ì§ˆë³‘ íŠœí† ë¦¬ì–¼' },
                'lab': { completedKey: 'spiritGarden_labTutorialCompleted', seenKey: 'spiritGarden_labTutorialSeen', reward: 25, name: 'ì—°êµ¬ì‹¤ íŠœí† ë¦¬ì–¼' }
            };
            
            const info = rewardMap[tutorialId];
            if (!info) return;
            
            // ì´ë¯¸ ë³´ìƒì„ ë°›ì•˜ëŠ”ì§€ í™•ì¸
            if (localStorage.getItem(info.completedKey)) {
                showNotification('âš ï¸ ì´ë¯¸ ë³´ìƒì„ ë°›ì•˜ìŠµë‹ˆë‹¤');
                return;
            }
            
            // íŠœí† ë¦¬ì–¼ì„ ì™„ë£Œí–ˆëŠ”ì§€ í™•ì¸
            if (!localStorage.getItem(info.seenKey)) {
                showNotification('âš ï¸ íŠœí† ë¦¬ì–¼ì„ ë¨¼ì € ì™„ë£Œí•´ì£¼ì„¸ìš”');
                return;
            }
            
            // ë³´ìƒ ì§€ê¸‰
            localStorage.setItem(info.completedKey, 'true');
            coins += info.reward;
            saveGame();
            updateCoinDisplay();
            showNotification(`ğŸ“ ${info.name} ë³´ìƒ! +${info.reward}ğŸ’°`);
            
            // UI ì—…ë°ì´íŠ¸
            renderTutorialReplayList();
        }
        
        // íŠœí† ë¦¬ì–¼ ë‹¤ì‹œë³´ê¸° í•¨ìˆ˜
        function replayTutorial(type) {
            // ì§„í–‰ ì¤‘ì¸ íŠœí† ë¦¬ì–¼ì´ ìˆìœ¼ë©´ ì¤‘ë‹¨
            if (tutorialActive || tutorial2Active || sickTutorialActive || labTutorialActive) {
                showNotification('âš ï¸ ì§„í–‰ ì¤‘ì¸ íŠœí† ë¦¬ì–¼ì´ ìˆìŠµë‹ˆë‹¤');
                return;
            }
            
            switch(type) {
                case 'basic':
                    // ê¸°ë³¸ íŠœí† ë¦¬ì–¼ í”Œë˜ê·¸ ë¦¬ì…‹
                    localStorage.removeItem('spiritGarden_tutorialSeen');
                    tutorialStep = 0;
                    tutorialActive = true;
                    switchTab('garden');
                    showTutorialStep();
                    break;
                    
                case 'album':
                    // ì•¨ë²”/ë„ê° íŠœí† ë¦¬ì–¼ í”Œë˜ê·¸ ë¦¬ì…‹
                    localStorage.removeItem('spiritGarden_tutorial2Seen');
                    tutorial2Step = 0;
                    tutorial2Active = true;
                    switchTab('garden');
                    showTutorial2Step();
                    break;
                    
                case 'sick':
                    // ì§ˆë³‘ íŠœí† ë¦¬ì–¼ í”Œë˜ê·¸ ë¦¬ì…‹
                    localStorage.removeItem('spiritGarden_sickTutorialSeen');
                    sickTutorialStep = 0;
                    sickTutorialActive = true;
                    switchTab('garden');
                    showSickTutorialStep();
                    break;
                    
                case 'lab':
                    // ì—°êµ¬ì‹¤ íŠœí† ë¦¬ì–¼ í”Œë˜ê·¸ ë¦¬ì…‹
                    localStorage.removeItem('spiritGarden_labTutorialSeen');
                    labTutorialStep = 0;
                    labTutorialActive = true;
                    switchTab('lab');
                    showLabTutorialStep();
                    break;
                    
                default:
                    showNotification('âŒ ì•Œ ìˆ˜ ì—†ëŠ” íŠœí† ë¦¬ì–¼ì…ë‹ˆë‹¤');
            }
        }
        
        function startTutorial() {
            const tutorialSeen = localStorage.getItem('spiritGarden_tutorialSeen');
            if (tutorialSeen) return;
            
            // ì´ë¯¸ ê¸°ë³¸ íŠœí† ë¦¬ì–¼ì´ ì§„í–‰ ì¤‘ì´ë©´ ì‹œì‘í•˜ì§€ ì•ŠìŒ
            if (tutorialActive) return;
            
            // ë‹¤ë¥¸ íŠœí† ë¦¬ì–¼ì´ ì§„í–‰ ì¤‘ì´ë©´ ì‹œì‘í•˜ì§€ ì•ŠìŒ
            if (tutorial2Active || sickTutorialActive || imbalanceTutorialActive || labTutorialActive) return;
            
            // íŠœí† ë¦¬ì–¼ìš© ê¸°ë³¸ ì•„ì´í…œ ì§€ê¸‰
            if (!inventory.food) inventory.food = [];
            if (!inventory.music) inventory.music = [];
            
            // ê¸°ë³¸ ë¨¹ì´ 3ê°œ ì§€ê¸‰
            if (inventory.food.length === 0) {
                inventory.food.push('fire', 'water', 'earth');
            }
            // í´ë˜ì‹ ë ˆì½”ë“œ 1ê°œ ì§€ê¸‰
            if (inventory.music.length === 0) {
                inventory.music.push('classic');
            }
            saveGame();
            renderInventory();
            
            tutorialStep = 0;
            tutorialActive = true;
            showTutorialStep();
        }
        
        function showTutorialStep() {
            console.log('showTutorialStep í˜¸ì¶œë¨, tutorialStep:', tutorialStep, '/ ì „ì²´:', TUTORIAL_STEPS.length);
            if (tutorialStep >= TUTORIAL_STEPS.length) {
                console.log('íŠœí† ë¦¬ì–¼ ì™„ë£Œ ì¡°ê±´ ì¶©ì¡±, endTutorial í˜¸ì¶œ');
                endTutorial();
                return;
            }
            
            const step = TUTORIAL_STEPS[tutorialStep];
            
            if (step.type === 'dialog') {
                showTutorialDialog(step.text);
            } else if (step.type === 'action') {
                showTutorialAction(step.text, step.action);
            }
        }
        
        let tutorialCollapsed = false;
        
        function toggleTutorialCollapse() {
            tutorialCollapsed = !tutorialCollapsed;
            const content = document.getElementById('tutorialContent');
            const image = document.getElementById('tutorialImage');
            const toggleBtn = document.getElementById('tutorialToggleBtn');
            
            if (tutorialCollapsed) {
                content.style.display = 'none';
                if (image) image.style.display = 'none';
                toggleBtn.textContent = 'â–¼ í¼ì¹˜ê¸°';
            } else {
                content.style.display = 'block';
                if (image) image.style.display = 'block';
                toggleBtn.textContent = 'â–² ì ‘ê¸°';
            }
        }
        
        function showTutorialDialog(text) {
            const modal = document.createElement('div');
            modal.id = 'tutorialModal';
            modal.style.cssText = `
                position: fixed;
                top: 10px;
                left: 50%;
                transform: translateX(-50%);
                width: 90%;
                max-width: 500px;
                background: var(--card);
                border: 2px solid #555;
                border-radius: 16px;
                padding: 15px;
                z-index: 100000;
                box-shadow: 0 8px 32px rgba(0,0,0,0.3);
            `;
            
            modal.innerHTML = `
                <div style="display: flex; gap: 15px; align-items: flex-start;">
                    <img id="tutorialImage" src="https://raw.githubusercontent.com/mongyeonlab-cpu/mylittleterrarium/main/images/NPC_%EC%84%A0%EB%B0%B0.png" alt="ì„ ë°°" style="width: 150px; height: 150px; object-fit: cover; flex-shrink: 0; display: ${tutorialCollapsed ? 'none' : 'block'};">
                    <div style="flex: 1;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: ${tutorialCollapsed ? '0' : '10px'};">
                            <span style="font-size: 1rem; font-weight: 600; color: #555;">ì„ ë°°</span>
                            <div style="display: flex; gap: 6px;">
                                <button onclick="skipTutorial()" style="padding: 4px 10px; background: var(--bg); border: 1px solid var(--border); border-radius: 6px; cursor: pointer; font-size: 0.75rem; color: var(--text-muted);">ê±´ë„ˆë›°ê¸°</button>
                                <button id="tutorialToggleBtn" onclick="toggleTutorialCollapse()" style="padding: 4px 10px; background: var(--bg); border: 1px solid var(--border); border-radius: 6px; cursor: pointer; font-size: 0.75rem; color: var(--text-muted);">
                                    ${tutorialCollapsed ? 'â–¼ í¼ì¹˜ê¸°' : 'â–² ì ‘ê¸°'}
                                </button>
                            </div>
                        </div>
                        <div id="tutorialContent" style="display: ${tutorialCollapsed ? 'none' : 'block'};">
                            <div style="font-size: 0.95rem; line-height: 1.6; color: var(--text); margin-bottom: 12px; word-break: keep-all;">${text}</div>
                            <div style="display: flex; justify-content: flex-end;">
                                <button onclick="nextTutorialStep()" style="padding: 8px 20px; background: #333; color: white; border: none; border-radius: 6px; font-size: 0.9rem; cursor: pointer; font-weight: 600;">ë‹¤ìŒ</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // ê¸°ì¡´ íŠœí† ë¦¬ì–¼ ëª¨ë‹¬ ì œê±°
            const existing = document.getElementById('tutorialModal');
            if (existing) existing.remove();
            
            document.body.appendChild(modal);
        }
        
        function showTutorialAction(text, action) {
            const modal = document.createElement('div');
            modal.id = 'tutorialModal';
            modal.style.cssText = `
                position: fixed;
                top: 10px;
                left: 50%;
                transform: translateX(-50%);
                width: 90%;
                max-width: 500px;
                background: var(--card);
                border: 2px solid #f39c12;
                border-radius: 16px;
                padding: 15px;
                z-index: 100000;
                box-shadow: 0 8px 32px rgba(0,0,0,0.3);
            `;
            
            modal.innerHTML = `
                <div style="display: flex; gap: 15px; align-items: flex-start;">
                    <img id="tutorialImage" src="https://raw.githubusercontent.com/mongyeonlab-cpu/mylittleterrarium/main/images/NPC_%EC%84%A0%EB%B0%B0.png" alt="ì„ ë°°" style="width: 150px; height: 150px; object-fit: cover; flex-shrink: 0; display: ${tutorialCollapsed ? 'none' : 'block'};">
                    <div style="flex: 1;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: ${tutorialCollapsed ? '0' : '10px'};">
                            <span style="font-size: 1rem; font-weight: 600; color: #f39c12;">ì„ ë°°</span>
                            <div style="display: flex; gap: 6px;">
                                <button onclick="skipTutorial()" style="padding: 4px 10px; background: var(--bg); border: 1px solid var(--border); border-radius: 6px; cursor: pointer; font-size: 0.75rem; color: var(--text-muted);">ê±´ë„ˆë›°ê¸°</button>
                                <button id="tutorialToggleBtn" onclick="toggleTutorialCollapse()" style="padding: 4px 10px; background: var(--bg); border: 1px solid var(--border); border-radius: 6px; cursor: pointer; font-size: 0.75rem; color: var(--text-muted);">
                                    ${tutorialCollapsed ? 'â–¼ í¼ì¹˜ê¸°' : 'â–² ì ‘ê¸°'}
                                </button>
                            </div>
                        </div>
                        <div id="tutorialContent" style="display: ${tutorialCollapsed ? 'none' : 'block'};">
                            <div style="font-size: 0.95rem; line-height: 1.6; color: var(--text); margin-bottom: 8px; word-break: keep-all;">${text}</div>
                            <div style="padding: 6px 10px; background: #f39c1222; border-radius: 6px; font-size: 0.8rem; color: #f39c12;">
                                ğŸ‘‡ ì•„ë˜ ë²„íŠ¼ì„ ëˆŒëŸ¬ë³´ì„¸ìš”!
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // ê¸°ì¡´ íŠœí† ë¦¬ì–¼ ëª¨ë‹¬ ì œê±°
            const existing = document.getElementById('tutorialModal');
            if (existing) existing.remove();
            
            document.body.appendChild(modal);
            
            // í•´ë‹¹ ì•¡ì…˜ì„ ê¸°ë‹¤ë¦¼
            window.tutorialWaitingFor = action;
            
            // ê°•ì¡°í•  ìš”ì†Œ ì°¾ì•„ì„œ í•˜ì´ë¼ì´íŠ¸
            highlightTutorialTarget(action);
        }
        
        // íŠœí† ë¦¬ì–¼ ëŒ€ìƒ ìš”ì†Œ ê°•ì¡°
        function highlightTutorialTarget(action) {
            // ê¸°ì¡´ ê°•ì¡° ì œê±°
            clearTutorialHighlight();
            
            let targetSelector = null;
            
            switch(action) {
                case 'getEgg':
                    targetSelector = '.new-spirit-btn';
                    break;
                case 'clickName':
                    targetSelector = '.spirit-name';
                    break;
                case 'rename':
                    targetSelector = '#nameInput';
                    break;
                case 'feed':
                    targetSelector = 'button[onclick*="openFeedModal"]';
                    break;
                case 'music':
                    targetSelector = 'button[onclick*="openMusicModal"]';
                    break;
                case 'pat':
                    targetSelector = 'button[onclick*="patSpirit"]';
                    break;
                case 'toggleLight':
                    targetSelector = '#lightBtn';
                    break;
                case 'openAlbum':
                    targetSelector = '#journalSubTabs .sub-tab[data-tab="album"]';
                    break;
                case 'openJournal':
                    targetSelector = '.tab:nth-child(6)';
                    break;
                case 'openAlbumDetail':
                    targetSelector = '.collection-card';
                    break;
            }
            
            if (targetSelector) {
                const target = document.querySelector(targetSelector);
                if (target) {
                    target.classList.add('tutorial-highlight');
                    // í•´ë‹¹ ìš”ì†Œë¡œ ìŠ¤í¬ë¡¤
                    target.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
            }
        }
        
        // íŠœí† ë¦¬ì–¼ ê°•ì¡° ì œê±°
        function clearTutorialHighlight() {
            document.querySelectorAll('.tutorial-highlight').forEach(el => {
                el.classList.remove('tutorial-highlight');
            });
        }
        
        function checkTutorialAction(action) {
            if (!tutorialActive && !tutorial2Active) return;
            if (window.tutorialWaitingFor === action) {
                window.tutorialWaitingFor = null;
                clearTutorialHighlight();
                if (tutorial2Active) {
                    nextTutorial2Step();
                } else {
                    nextTutorialStep();
                }
            }
        }
        
        function nextTutorialStep() {
            tutorialStep++;
            showTutorialStep();
        }
        
        function skipTutorial() {
            // ê±´ë„ˆë›°ê¸°ëŠ” ë³´ìƒ ì—†ì´ ì¢…ë£Œ
            tutorialActive = false;
            window.tutorialWaitingFor = null;
            clearTutorialHighlight();
            
            const modal = document.getElementById('tutorialModal');
            if (modal) {
                modal.style.opacity = '0';
                modal.style.transition = 'opacity 0.3s';
                setTimeout(() => modal.remove(), 300);
            }
            
            localStorage.setItem('spiritGarden_tutorialSeen', 'true');
            showNotification('íŠœí† ë¦¬ì–¼ì„ ê±´ë„ˆë›°ì—ˆìŠµë‹ˆë‹¤.');
        }
        
        function endTutorial() {
            console.log('endTutorial í˜¸ì¶œë¨');
            tutorialActive = false;
            window.tutorialWaitingFor = null;
            clearTutorialHighlight();
            
            const modal = document.getElementById('tutorialModal');
            if (modal) {
                modal.style.opacity = '0';
                modal.style.transition = 'opacity 0.3s';
                setTimeout(() => modal.remove(), 300);
            }
            
            localStorage.setItem('spiritGarden_tutorialSeen', 'true');
            
            // ë³´ìƒ ë¯¸ìˆ˜ë ¹ ìƒíƒœë©´ ì•ˆë‚´
            const alreadyCompleted = localStorage.getItem('spiritGarden_tutorialCompleted');
            if (!alreadyCompleted) {
                setTimeout(() => {
                    showNotification('ğŸ“ íŠœí† ë¦¬ì–¼ ì™„ë£Œ! ì¼ì§€â†’ë„ì›€ë§ì—ì„œ ë³´ìƒì„ ë°›ìœ¼ì„¸ìš”');
                }, 500);
            }
        }
        
        // ===== ë‘ ë²ˆì§¸ íŠœí† ë¦¬ì–¼ (ì²« ì •ë ¹ ì™„ì„± í›„) =====
        let tutorial2Step = 0;
        let tutorial2Active = false;
        
        const TUTORIAL2_STEPS = [
            {
                type: 'dialog',
                text: 'ì¶•í•˜í•´! ë„¤ê°€ í‚¤ì›Œë‚¸ ì²« ë²ˆì§¸ ì •ë ¹ì´ë„¤.'
            },
            {
                type: 'dialog',
                text: 'ì„±ì¥í•œ ì •ë ¹ì€ ìì—°ìœ¼ë¡œ ëŒì•„ê°€ì§€ë§Œ, ì•„ì˜ˆ ë‹¤ì‹œ ë³¼ ìˆ˜ ì—†ëŠ” ê±´ ì•„ë‹ˆì•¼.'
            },
            {
                type: 'action',
                action: 'openJournal',
                text: 'ì¼ì§€ íƒ­ì„ ëˆŒëŸ¬ë´.'
            },
            {
                type: 'action',
                action: 'openAlbum',
                text: 'ì´ì œ ì•¨ë²” ë²„íŠ¼ì„ ëˆŒëŸ¬ë´.'
            },
            {
                type: 'dialog',
                text: 'ì—¬ê¸°ì—ì„œ ë„¤ê°€ í‚¤ìš´ ì •ë ¹ë“¤ì„ ë‹¤ì‹œ ë³¼ ìˆ˜ ìˆì–´. ë„¤ê°€ ì–¼ë§ˆë‚˜ ì˜ í‚¤ì›ŒëƒˆëŠ”ì§€ë„ í™•ì¸í•  ìˆ˜ ìˆê³ .'
            },
            {
                type: 'dialog',
                text: 'ê·¸ë¦¬ê³  ì •ë ¹ ê°„ì˜ ì—°ê²°ë„ ê°€ëŠ¥í•˜ì§€.'
            },
            {
                type: 'action',
                action: 'openAlbumDetail',
                text: 'ì„±ì¥í•œ ì •ë ¹ì˜ ì•¨ë²”ì„ ëˆŒëŸ¬ë´.'
            },
            {
                type: 'dialog',
                text: 'ì•„ë˜ì— ë³´ë©´ ì½”ë“œ ìƒì„±ê³¼ ì—°ê²°í•˜ê¸°ê°€ ìˆì§€? ì •ë ¹ì˜ ì½”ë“œë¥¼ ë³µì‚¬í•´ ë‹¤ë¥¸ ì •ë ¹ê³¼ ì—°ê²°ì´ ê°€ëŠ¥í•´.'
            },
            {
                type: 'dialog',
                text: 'ë¬´ì†ì„± ì•Œë¡œëŠ” ë³´ì§€ ëª»í•˜ëŠ” ì •ë ¹ë“¤ë„ ìˆìœ¼ë‹ˆê¹Œ ë‚˜ì¤‘ì— ì‹œë„í•´ë³´ë„ë¡ í•´.'
            },
            {
                type: 'dialog',
                text: 'ì, ì´ì œ ì •ë§ í˜¼ìì„œë„ ì˜ í•  ìˆ˜ ìˆì„ ê±°ì•¼. ì•ìœ¼ë¡œë„ í™”ì´íŒ…!'
            }
        ];
        
        function startTutorial2() {
            // ì´ë¯¸ ë³¸ ì  ìˆìœ¼ë©´ ì‹œì‘í•˜ì§€ ì•ŠìŒ
            if (localStorage.getItem('spiritGarden_tutorial2Seen')) return;
            
            // ì´ë¯¸ íŠœí† ë¦¬ì–¼2ê°€ ì§„í–‰ ì¤‘ì´ë©´ ì‹œì‘í•˜ì§€ ì•ŠìŒ
            if (tutorial2Active) return;
            
            // ë‹¤ë¥¸ íŠœí† ë¦¬ì–¼ì´ ì§„í–‰ ì¤‘ì´ë©´ ì‹œì‘í•˜ì§€ ì•ŠìŒ
            if (tutorialActive || sickTutorialActive || imbalanceTutorialActive || labTutorialActive) return;
            
            tutorial2Step = 0;
            tutorial2Active = true;
            showTutorial2Step();
        }
        
        function showTutorial2Step() {
            if (tutorial2Step >= TUTORIAL2_STEPS.length) {
                endTutorial2();
                return;
            }
            
            const step = TUTORIAL2_STEPS[tutorial2Step];
            
            if (step.type === 'dialog') {
                showTutorial2Dialog(step.text);
            } else if (step.type === 'action') {
                showTutorial2Action(step.text, step.action);
            }
        }
        
        function showTutorial2Dialog(text) {
            const modal = document.createElement('div');
            modal.id = 'tutorialModal';
            modal.style.cssText = `
                position: fixed;
                top: 10px;
                left: 50%;
                transform: translateX(-50%);
                width: 90%;
                max-width: 500px;
                background: var(--card);
                border: 2px solid #555;
                border-radius: 16px;
                padding: 15px;
                z-index: 100000;
                box-shadow: 0 8px 32px rgba(0,0,0,0.3);
            `;
            
            modal.innerHTML = `
                <div style="display: flex; gap: 15px; align-items: flex-start;">
                    <img id="tutorialImage" src="https://raw.githubusercontent.com/mongyeonlab-cpu/mylittleterrarium/main/images/NPC_%EC%84%A0%EB%B0%B0.png" alt="ì„ ë°°" style="width: 150px; height: 150px; object-fit: cover; flex-shrink: 0; display: ${tutorialCollapsed ? 'none' : 'block'};">
                    <div style="flex: 1;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: ${tutorialCollapsed ? '0' : '10px'};">
                            <span style="font-size: 1rem; font-weight: 600; color: #555;">ì„ ë°°</span>
                            <div style="display: flex; gap: 6px;">
                                <button onclick="skipTutorial2()" style="padding: 4px 10px; background: var(--bg); border: 1px solid var(--border); border-radius: 6px; cursor: pointer; font-size: 0.75rem; color: var(--text-muted);">ê±´ë„ˆë›°ê¸°</button>
                                <button id="tutorialToggleBtn" onclick="toggleTutorialCollapse()" style="padding: 4px 10px; background: var(--bg); border: 1px solid var(--border); border-radius: 6px; cursor: pointer; font-size: 0.75rem; color: var(--text-muted);">
                                    ${tutorialCollapsed ? 'â–¼ í¼ì¹˜ê¸°' : 'â–² ì ‘ê¸°'}
                                </button>
                            </div>
                        </div>
                        <div id="tutorialContent" style="display: ${tutorialCollapsed ? 'none' : 'block'};">
                            <div style="font-size: 0.95rem; line-height: 1.6; color: var(--text); margin-bottom: 12px; word-break: keep-all;">${text}</div>
                            <div style="display: flex; justify-content: flex-end;">
                                <button onclick="nextTutorial2Step()" style="padding: 8px 20px; background: #333; color: white; border: none; border-radius: 6px; font-size: 0.9rem; cursor: pointer; font-weight: 600;">ë‹¤ìŒ</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            const existing = document.getElementById('tutorialModal');
            if (existing) existing.remove();
            
            document.body.appendChild(modal);
        }
        
        function showTutorial2Action(text, action) {
            const modal = document.createElement('div');
            modal.id = 'tutorialModal';
            modal.style.cssText = `
                position: fixed;
                top: 10px;
                left: 50%;
                transform: translateX(-50%);
                width: 90%;
                max-width: 500px;
                background: var(--card);
                border: 2px solid #f39c12;
                border-radius: 16px;
                padding: 15px;
                z-index: 100000;
                box-shadow: 0 8px 32px rgba(0,0,0,0.3);
            `;
            
            modal.innerHTML = `
                <div style="display: flex; gap: 15px; align-items: flex-start;">
                    <img id="tutorialImage" src="https://raw.githubusercontent.com/mongyeonlab-cpu/mylittleterrarium/main/images/NPC_%EC%84%A0%EB%B0%B0.png" alt="ì„ ë°°" style="width: 150px; height: 150px; object-fit: cover; flex-shrink: 0; display: ${tutorialCollapsed ? 'none' : 'block'};">
                    <div style="flex: 1;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: ${tutorialCollapsed ? '0' : '10px'};">
                            <span style="font-size: 1rem; font-weight: 600; color: #f39c12;">ì„ ë°°</span>
                            <div style="display: flex; gap: 6px;">
                                <button onclick="skipTutorial2()" style="padding: 4px 10px; background: var(--bg); border: 1px solid var(--border); border-radius: 6px; cursor: pointer; font-size: 0.75rem; color: var(--text-muted);">ê±´ë„ˆë›°ê¸°</button>
                                <button id="tutorialToggleBtn" onclick="toggleTutorialCollapse()" style="padding: 4px 10px; background: var(--bg); border: 1px solid var(--border); border-radius: 6px; cursor: pointer; font-size: 0.75rem; color: var(--text-muted);">
                                    ${tutorialCollapsed ? 'â–¼ í¼ì¹˜ê¸°' : 'â–² ì ‘ê¸°'}
                                </button>
                            </div>
                        </div>
                        <div id="tutorialContent" style="display: ${tutorialCollapsed ? 'none' : 'block'};">
                            <div style="font-size: 0.95rem; line-height: 1.6; color: var(--text); margin-bottom: 8px; word-break: keep-all;">${text}</div>
                            <div style="padding: 6px 10px; background: #f39c1222; border-radius: 6px; font-size: 0.8rem; color: #f39c12;">
                                ğŸ‘‡ í•´ë‹¹ ë²„íŠ¼ì„ ëˆŒëŸ¬ë³´ì„¸ìš”!
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            const existing = document.getElementById('tutorialModal');
            if (existing) existing.remove();
            
            document.body.appendChild(modal);
            
            window.tutorialWaitingFor = action;
            
            // ê°•ì¡°í•  ìš”ì†Œ ì°¾ì•„ì„œ í•˜ì´ë¼ì´íŠ¸
            highlightTutorialTarget(action);
        }
        
        function nextTutorial2Step() {
            tutorial2Step++;
            showTutorial2Step();
        }
        
        function skipTutorial2() {
            // ê±´ë„ˆë›°ê¸°ëŠ” ë³´ìƒ ì—†ì´ ì¢…ë£Œ
            tutorial2Active = false;
            window.tutorialWaitingFor = null;
            clearTutorialHighlight();
            
            const modal = document.getElementById('tutorialModal');
            if (modal) {
                modal.style.opacity = '0';
                modal.style.transition = 'opacity 0.3s';
                setTimeout(() => modal.remove(), 300);
            }
            
            localStorage.setItem('spiritGarden_tutorial2Seen', 'true');
            showNotification('íŠœí† ë¦¬ì–¼ì„ ê±´ë„ˆë›°ì—ˆìŠµë‹ˆë‹¤.');
        }
        
        function endTutorial2() {
            tutorial2Active = false;
            window.tutorialWaitingFor = null;
            clearTutorialHighlight();
            
            const modal = document.getElementById('tutorialModal');
            if (modal) {
                modal.style.opacity = '0';
                modal.style.transition = 'opacity 0.3s';
                setTimeout(() => modal.remove(), 300);
            }
            
            localStorage.setItem('spiritGarden_tutorial2Seen', 'true');
            
            // ë³´ìƒ ë¯¸ìˆ˜ë ¹ ìƒíƒœë©´ ì•ˆë‚´
            if (!localStorage.getItem('spiritGarden_tutorial2Completed')) {
                setTimeout(() => {
                    showNotification('ğŸ“ íŠœí† ë¦¬ì–¼ ì™„ë£Œ! ì¼ì§€â†’ë„ì›€ë§ì—ì„œ ë³´ìƒì„ ë°›ìœ¼ì„¸ìš”');
                }, 500);
            }
        }
        
        // ===== ì§ˆë³‘ íŠœí† ë¦¬ì–¼ (ì²« ì§ˆë³‘ ë°œìƒ ì‹œ) =====
        let sickTutorialStep = 0;
        let sickTutorialActive = false;
        let sickTutorialCollapsed = false;
        
        const SICK_TUTORIAL_STEPS = [
            {
                type: 'dialog',
                text: 'ì •ë ¹ì´ ì§ˆë³‘ì— ê±¸ë ¸êµ¬ë‚˜. ìœ ì•„ê¸°ì˜ ì •ë ¹ë“¤ì€ ì•½í•´ì„œ ì¢…ì¢… ì´ëŸ° ì¼ì´ ì¼ì–´ë‚˜ê³¤ í•´.'
            },
            {
                type: 'dialog',
                text: 'ê·¸ë˜ë„ ê±±ì •í•˜ì§€ë§ˆ. ìƒì ì—ì„œ ì•½ì´ˆë¥¼ ì‚¬ì„œ ë¨¹ì´ë©´ ë˜ë‹ˆê¹Œ.'
            },
            {
                type: 'action',
                action: 'openShop',
                text: 'ìƒì  íƒ­ì„ ëˆŒëŸ¬ë³¼ë˜?'
            },
            {
                type: 'dialog',
                text: 'ì•ˆë…•, ìƒì  ì£¼ì¸. ì˜¤ëŠ˜ë„ ì˜ìš•ì´ ì—†ì–´ë³´ì´ë„¤.'
            },
            {
                type: 'shopkeeper',
                text: 'ì‹œë¹„ê±¸ê±°ë©´ ê°€ì„¸ìš”...'
            },
            {
                type: 'dialog',
                text: 'ì €ë ‡ë‹¤ë‹ˆê¹Œ. ì•„, ì•½ì´ˆë¥¼ ì‚¬ëŸ¬ ì™”ì—ˆì§€. êµ¬ë§¤ íƒ­ì—ì„œ ê¸°íƒ€ ì¹´í…Œê³ ë¦¬ë¥¼ ì—´ì–´ ì•½ì´ˆë¥¼ ì°¾ì•„ êµ¬ë§¤í•´ë´.'
            },
            {
                type: 'action',
                action: 'buyMedicine',
                text: 'ì•½ì´ˆë¥¼ êµ¬ë§¤í•´ë´!'
            },
            {
                type: 'dialog',
                text: 'ì•½ì´ˆë¥¼ ìƒ€ìœ¼ë©´ ì´ì œ ìœ¡ì„±íƒ­ìœ¼ë¡œ ëŒì•„ê°€ì.'
            },
            {
                type: 'action',
                action: 'openGarden',
                text: 'ìœ¡ì„± íƒ­ì„ ëˆŒëŸ¬ë´.'
            },
            {
                type: 'action',
                action: 'useMedicine',
                text: 'ì§ˆë³‘ì— ê±¸ë¦° ì •ë ¹ì—ê²Œ ì•½ì´ˆ ì‚¬ìš©ì„ ëˆŒëŸ¬ë´.'
            },
            {
                type: 'dialog',
                text: 'ì, ê¸ˆë°© ë‚˜ì•˜ì§€? ì•ìœ¼ë¡œë„ ë‹¹í™©í•˜ì§€ë§ê³  ì´ë ‡ê²Œ í•˜ë©´ ë¼. ê·¸ëŸ¼ ê³„ì† í˜ë‚´ë¼ê³ ~'
            }
        ];
        
        function startSickTutorial() {
            // ì´ë¯¸ ë³¸ ì  ìˆìœ¼ë©´ ì‹œì‘í•˜ì§€ ì•ŠìŒ
            if (localStorage.getItem('spiritGarden_sickTutorialSeen')) return;
            
            // ì´ë¯¸ ì§ˆë³‘ íŠœí† ë¦¬ì–¼ì´ ì§„í–‰ ì¤‘ì´ë©´ ì‹œì‘í•˜ì§€ ì•ŠìŒ
            if (sickTutorialActive) return;
            
            // ë‹¤ë¥¸ íŠœí† ë¦¬ì–¼ì´ ì§„í–‰ ì¤‘ì´ë©´ ì‹œì‘í•˜ì§€ ì•ŠìŒ
            if (tutorialActive || tutorial2Active || imbalanceTutorialActive || labTutorialActive) return;
            
            // ì•½ì´ˆ êµ¬ë§¤ë¥¼ ìœ„í•œ ì½”ì¸ ì§€ê¸‰ (50ì½”ì¸ ë¯¸ë§Œì´ë©´ 50ì½”ì¸ìœ¼ë¡œ ë§ì¶°ì¤Œ)
            if (coins < 50) {
                coins = 50;
                updateCoinDisplay();
                saveGame();
            }
            
            // ìœ¡ì„± íƒ­ìœ¼ë¡œ ì´ë™
            switchTab('garden');
            
            sickTutorialStep = 0;
            sickTutorialActive = true;
            showSickTutorialStep();
        }
        
        function showSickTutorialStep() {
            if (sickTutorialStep >= SICK_TUTORIAL_STEPS.length) {
                endSickTutorial();
                return;
            }
            
            const step = SICK_TUTORIAL_STEPS[sickTutorialStep];
            
            if (step.type === 'dialog') {
                showSickTutorialDialog(step.text);
            } else if (step.type === 'shopkeeper') {
                showSickTutorialShopkeeper(step.text);
            } else if (step.type === 'action') {
                showSickTutorialAction(step.text, step.action);
            }
        }
        
        function showSickTutorialDialog(text) {
            const modal = document.createElement('div');
            modal.id = 'tutorialModal';
            modal.style.cssText = `
                position: fixed;
                top: 10px;
                left: 50%;
                transform: translateX(-50%);
                width: 90%;
                max-width: 500px;
                background: var(--card);
                border: 2px solid #f39c12;
                border-radius: 16px;
                padding: 15px;
                z-index: 100000;
                box-shadow: 0 8px 32px rgba(0,0,0,0.3);
            `;
            
            modal.innerHTML = `
                <div style="display: flex; gap: 15px; align-items: flex-start;">
                    <img src="https://raw.githubusercontent.com/mongyeonlab-cpu/mylittleterrarium/main/images/NPC_%EC%84%A0%EB%B0%B0.png" alt="ì„ ë°°" style="width: 150px; height: 150px; object-fit: cover; flex-shrink: 0; display: ${sickTutorialCollapsed ? 'none' : 'block'};">
                    <div style="flex: 1;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: ${sickTutorialCollapsed ? '0' : '10px'};">
                            <span style="font-size: 1rem; font-weight: 600; color: #f39c12;">ì„ ë°°</span>
                            <div style="display: flex; gap: 6px;">
                                <button onclick="skipSickTutorial()" style="padding: 4px 10px; background: var(--bg); border: 1px solid var(--border); border-radius: 6px; cursor: pointer; font-size: 0.75rem; color: var(--text-muted);">ê±´ë„ˆë›°ê¸°</button>
                                <button onclick="toggleSickTutorialCollapse()" style="padding: 4px 10px; background: var(--bg); border: 1px solid var(--border); border-radius: 6px; cursor: pointer; font-size: 0.75rem; color: var(--text-muted);">
                                    ${sickTutorialCollapsed ? 'â–¼ í¼ì¹˜ê¸°' : 'â–² ì ‘ê¸°'}
                                </button>
                            </div>
                        </div>
                        <div id="sickTutorialContent" style="display: ${sickTutorialCollapsed ? 'none' : 'block'};">
                            <div style="font-size: 0.95rem; line-height: 1.6; color: var(--text); margin-bottom: 12px; word-break: keep-all;">${text}</div>
                            <div style="display: flex; justify-content: flex-end;">
                                <button onclick="nextSickTutorialStep()" style="padding: 8px 20px; background: #f39c12; color: white; border: none; border-radius: 6px; font-size: 0.9rem; cursor: pointer; font-weight: 600;">ë‹¤ìŒ</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            const existing = document.getElementById('tutorialModal');
            if (existing) existing.remove();
            
            document.body.appendChild(modal);
        }
        
        function showSickTutorialShopkeeper(text) {
            const modal = document.createElement('div');
            modal.id = 'tutorialModal';
            modal.style.cssText = `
                position: fixed;
                top: 10px;
                left: 50%;
                transform: translateX(-50%);
                width: 90%;
                max-width: 500px;
                background: var(--card);
                border: 2px solid #888;
                border-radius: 16px;
                padding: 15px;
                z-index: 100000;
                box-shadow: 0 8px 32px rgba(0,0,0,0.3);
            `;
            
            modal.innerHTML = `
                <div style="display: flex; gap: 15px; align-items: flex-start;">
                    <img src="https://raw.githubusercontent.com/mongyeonlab-cpu/mylittleterrarium/main/images/NPC_%EC%83%81%EC%A0%90%EC%A3%BC%EC%9D%B8.png" alt="ìƒì  ì£¼ì¸" style="width: 150px; height: 150px; object-fit: cover; flex-shrink: 0; display: ${sickTutorialCollapsed ? 'none' : 'block'};">
                    <div style="flex: 1;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: ${sickTutorialCollapsed ? '0' : '10px'};">
                            <span style="font-size: 1rem; font-weight: 600; color: #888;">ìƒì  ì£¼ì¸</span>
                            <div style="display: flex; gap: 6px;">
                                <button onclick="skipSickTutorial()" style="padding: 4px 10px; background: var(--bg); border: 1px solid var(--border); border-radius: 6px; cursor: pointer; font-size: 0.75rem; color: var(--text-muted);">ê±´ë„ˆë›°ê¸°</button>
                                <button onclick="toggleSickTutorialCollapse()" style="padding: 4px 10px; background: var(--bg); border: 1px solid var(--border); border-radius: 6px; cursor: pointer; font-size: 0.75rem; color: var(--text-muted);">
                                    ${sickTutorialCollapsed ? 'â–¼ í¼ì¹˜ê¸°' : 'â–² ì ‘ê¸°'}
                                </button>
                            </div>
                        </div>
                        <div id="sickTutorialContent" style="display: ${sickTutorialCollapsed ? 'none' : 'block'};">
                            <div style="font-size: 0.95rem; line-height: 1.6; color: var(--text); margin-bottom: 12px; word-break: keep-all;">${text}</div>
                            <div style="display: flex; justify-content: flex-end;">
                                <button onclick="nextSickTutorialStep()" style="padding: 8px 20px; background: #888; color: white; border: none; border-radius: 6px; font-size: 0.9rem; cursor: pointer; font-weight: 600;">ë‹¤ìŒ</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            const existing = document.getElementById('tutorialModal');
            if (existing) existing.remove();
            
            document.body.appendChild(modal);
        }
        
        function showSickTutorialAction(text, action) {
            const modal = document.createElement('div');
            modal.id = 'tutorialModal';
            modal.style.cssText = `
                position: fixed;
                top: 10px;
                left: 50%;
                transform: translateX(-50%);
                width: 90%;
                max-width: 500px;
                background: var(--card);
                border: 2px solid #f39c12;
                border-radius: 16px;
                padding: 15px;
                z-index: 100000;
                box-shadow: 0 8px 32px rgba(0,0,0,0.3);
            `;
            
            modal.innerHTML = `
                <div style="display: flex; gap: 15px; align-items: flex-start;">
                    <img src="https://raw.githubusercontent.com/mongyeonlab-cpu/mylittleterrarium/main/images/NPC_%EC%84%A0%EB%B0%B0.png" alt="ì„ ë°°" style="width: 150px; height: 150px; object-fit: cover; flex-shrink: 0; display: ${sickTutorialCollapsed ? 'none' : 'block'};">
                    <div style="flex: 1;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: ${sickTutorialCollapsed ? '0' : '10px'};">
                            <span style="font-size: 1rem; font-weight: 600; color: #f39c12;">ì„ ë°°</span>
                            <div style="display: flex; gap: 6px;">
                                <button onclick="skipSickTutorial()" style="padding: 4px 10px; background: var(--bg); border: 1px solid var(--border); border-radius: 6px; cursor: pointer; font-size: 0.75rem; color: var(--text-muted);">ê±´ë„ˆë›°ê¸°</button>
                                <button onclick="toggleSickTutorialCollapse()" style="padding: 4px 10px; background: var(--bg); border: 1px solid var(--border); border-radius: 6px; cursor: pointer; font-size: 0.75rem; color: var(--text-muted);">
                                    ${sickTutorialCollapsed ? 'â–¼ í¼ì¹˜ê¸°' : 'â–² ì ‘ê¸°'}
                                </button>
                            </div>
                        </div>
                        <div id="sickTutorialContent" style="display: ${sickTutorialCollapsed ? 'none' : 'block'};">
                            <div style="font-size: 0.95rem; line-height: 1.6; color: var(--text); margin-bottom: 8px; word-break: keep-all;">${text}</div>
                            <div style="padding: 6px 10px; background: #f39c1222; border-radius: 6px; font-size: 0.8rem; color: #f39c12;">
                                ğŸ‘‡ í•´ë‹¹ ë²„íŠ¼ì„ ëˆŒëŸ¬ë³´ì„¸ìš”!
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            const existing = document.getElementById('tutorialModal');
            if (existing) existing.remove();
            
            document.body.appendChild(modal);
            
            window.tutorialWaitingFor = action;
            
            // ê°•ì¡°í•  ìš”ì†Œ ì°¾ì•„ì„œ í•˜ì´ë¼ì´íŠ¸
            highlightSickTutorialTarget(action);
        }
        
        function highlightSickTutorialTarget(action) {
            clearTutorialHighlight();
            
            let targetSelector = '';
            
            if (action === 'openShop') {
                targetSelector = 'button.tab[onclick*="shop"]';
            } else if (action === 'buyMedicine') {
                targetSelector = 'button[onclick*="buyItem"][onclick*="medicine"]';
            } else if (action === 'openGarden') {
                targetSelector = 'button.tab[onclick*="garden"]';
            } else if (action === 'useMedicine') {
                targetSelector = 'button[onclick*="giveMedicine"]';
            }
            
            if (targetSelector) {
                const target = document.querySelector(targetSelector);
                if (target) {
                    target.classList.add('tutorial-highlight');
                    // ê°•ì¡°ëœ ìš”ì†Œë¡œ ìŠ¤í¬ë¡¤
                    setTimeout(() => {
                        target.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }, 100);
                }
            }
        }
        
        function nextSickTutorialStep() {
            sickTutorialStep++;
            showSickTutorialStep();
        }
        
        function toggleSickTutorialCollapse() {
            sickTutorialCollapsed = !sickTutorialCollapsed;
            showSickTutorialStep();
        }
        
        function skipSickTutorial() {
            // ê±´ë„ˆë›°ê¸°ëŠ” ë³´ìƒ ì—†ì´ ì¢…ë£Œ
            sickTutorialActive = false;
            window.tutorialWaitingFor = null;
            clearTutorialHighlight();
            
            const modal = document.getElementById('tutorialModal');
            if (modal) {
                modal.style.opacity = '0';
                modal.style.transition = 'opacity 0.3s';
                setTimeout(() => modal.remove(), 300);
            }
            
            localStorage.setItem('spiritGarden_sickTutorialSeen', 'true');
            showNotification('íŠœí† ë¦¬ì–¼ì„ ê±´ë„ˆë›°ì—ˆìŠµë‹ˆë‹¤.');
        }
        
        function endSickTutorial() {
            sickTutorialActive = false;
            window.tutorialWaitingFor = null;
            clearTutorialHighlight();
            
            const modal = document.getElementById('tutorialModal');
            if (modal) {
                modal.style.opacity = '0';
                modal.style.transition = 'opacity 0.3s';
                setTimeout(() => modal.remove(), 300);
            }
            
            localStorage.setItem('spiritGarden_sickTutorialSeen', 'true');
            
            // ë³´ìƒ ë¯¸ìˆ˜ë ¹ ìƒíƒœë©´ ì•ˆë‚´
            if (!localStorage.getItem('spiritGarden_sickTutorialCompleted')) {
                setTimeout(() => {
                    showNotification('ğŸ“ íŠœí† ë¦¬ì–¼ ì™„ë£Œ! ì¼ì§€â†’ë„ì›€ë§ì—ì„œ ë³´ìƒì„ ë°›ìœ¼ì„¸ìš”');
                }, 500);
            }
        }
        
        // ì§ˆë³‘ íŠœí† ë¦¬ì–¼ìš© ì•¡ì…˜ ì²´í¬
        function checkSickTutorialAction(action) {
            if (!sickTutorialActive) return;
            if (window.tutorialWaitingFor !== action) return;
            
            clearTutorialHighlight();
            sickTutorialStep++;
            showSickTutorialStep();
        }
        
        // ===== ì†ì„± ë¶ˆê· í˜• íŠœí† ë¦¬ì–¼ (ì²« ë¶ˆê· í˜• ë°œìƒ ì‹œ) =====
        let imbalanceTutorialStep = 0;
        let imbalanceTutorialActive = false;
        let imbalanceTutorialCollapsed = false;
        
        const IMBALANCE_TUTORIAL_STEPS = [
            {
                type: 'dialog',
                text: 'ì²˜ìŒì—” í•œ ì†ì„±ì—ë§Œ ì‹ ê²½ì“°ëŠ”ê²Œ ì¢‹ë‹¤ê³  í–ˆë”ë‹ˆ ê·¸ ë§ì„ ì•„ì£¼ ì˜ ë“¤ì—ˆêµ¬ë‚˜, í›„ë°°...'
            },
            {
                type: 'dialog',
                text: 'ì, ë´. ì†ì„± ìˆ˜ì¹˜ë¥¼ ë³´ë©´ ë†’ì€ ì†ì„±ì´ 50ì´ìƒ, ë‚®ì€ ì†ì„±ì€ 10 ì´í•˜ì§€?'
            },
            {
                type: 'dialog',
                text: 'ì´ëŸ° ê²½ìš°ì—” ì •ë ¹ì—ê²Œ ì†ì„± ë¶ˆê· í˜•ì´ ì°¾ì•„ì™€.'
            },
            {
                type: 'dialog',
                text: 'ìì—°ì—ì„œëŠ” ëª¨ë“  ì†ì„±ì„ ê³¨ê³ ë£¨ ìŒ“ì„ ìˆ˜ ìˆì§€ë§Œ ì¸ê³µ í…Œë¼ë¦¬ì›€ì—ì„  ê·¸ëŸ¬ê¸° ì‰½ì§€ ì•Šê±°ë“ .'
            },
            {
                type: 'dialog',
                text: 'ì†ì„± ë¶ˆê· í˜•ì€ ë‚®ì€ ì†ì„±ì„ 10 ì´ìƒìœ¼ë¡œ ì˜¬ë ¤ì£¼ë©´ ìì—°ìŠ¤ëŸ½ê²Œ í’€ë¦´ê±°ì•¼.'
            },
            {
                type: 'dialog',
                text: '...ê·¸ëŸ°ê±°ë©´ ì²˜ìŒë¶€í„° ë§í•´ë‹¬ë¼ê³ ? ì´ ë…€ì„ì´.'
            },
            {
                type: 'dialog',
                text: 'ì¼ë‹¨ ë‚œ ì„¤ëª…í•´ì¤¬ìœ¼ë‹ˆ ê°„ë‹¤. í˜ë‚´ë¼~'
            }
        ];
        
        function startImbalanceTutorial() {
            // ì´ë¯¸ ë³¸ ì  ìˆìœ¼ë©´ ì‹œì‘í•˜ì§€ ì•ŠìŒ
            if (localStorage.getItem('spiritGarden_imbalanceTutorialSeen')) return;
            
            // ì´ë¯¸ ë¶ˆê· í˜• íŠœí† ë¦¬ì–¼ì´ ì§„í–‰ ì¤‘ì´ë©´ ì‹œì‘í•˜ì§€ ì•ŠìŒ
            if (imbalanceTutorialActive) return;
            
            // ë‹¤ë¥¸ íŠœí† ë¦¬ì–¼ì´ ì§„í–‰ ì¤‘ì´ë©´ ì‹œì‘í•˜ì§€ ì•ŠìŒ
            if (tutorialActive || tutorial2Active || sickTutorialActive || labTutorialActive) return;
            
            // ìœ¡ì„± íƒ­ìœ¼ë¡œ ì´ë™
            switchTab('garden');
            
            imbalanceTutorialStep = 0;
            imbalanceTutorialActive = true;
            showImbalanceTutorialStep();
        }
        
        function showImbalanceTutorialStep() {
            if (imbalanceTutorialStep >= IMBALANCE_TUTORIAL_STEPS.length) {
                endImbalanceTutorial();
                return;
            }
            
            const step = IMBALANCE_TUTORIAL_STEPS[imbalanceTutorialStep];
            showImbalanceTutorialDialog(step.text);
        }
        
        function showImbalanceTutorialDialog(text) {
            const modal = document.createElement('div');
            modal.id = 'tutorialModal';
            modal.style.cssText = `
                position: fixed;
                top: 10px;
                left: 50%;
                transform: translateX(-50%);
                width: 90%;
                max-width: 500px;
                background: var(--card);
                border: 2px solid #f39c12;
                border-radius: 16px;
                padding: 15px;
                z-index: 100000;
                box-shadow: 0 8px 32px rgba(0,0,0,0.3);
            `;
            
            modal.innerHTML = `
                <div style="display: flex; gap: 15px; align-items: flex-start;">
                    <img src="https://raw.githubusercontent.com/mongyeonlab-cpu/mylittleterrarium/main/images/NPC_%EC%84%A0%EB%B0%B0.png" alt="ì„ ë°°" style="width: 150px; height: 150px; object-fit: cover; flex-shrink: 0; display: ${imbalanceTutorialCollapsed ? 'none' : 'block'};">
                    <div style="flex: 1;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: ${imbalanceTutorialCollapsed ? '0' : '10px'};">
                            <span style="font-size: 1rem; font-weight: 600; color: #f39c12;">ì„ ë°°</span>
                            <div style="display: flex; gap: 6px;">
                                <button onclick="skipImbalanceTutorial()" style="padding: 4px 10px; background: var(--bg); border: 1px solid var(--border); border-radius: 6px; cursor: pointer; font-size: 0.75rem; color: var(--text-muted);">ê±´ë„ˆë›°ê¸°</button>
                                <button onclick="toggleImbalanceTutorialCollapse()" style="padding: 4px 10px; background: var(--bg); border: 1px solid var(--border); border-radius: 6px; cursor: pointer; font-size: 0.75rem; color: var(--text-muted);">
                                    ${imbalanceTutorialCollapsed ? 'â–¼ í¼ì¹˜ê¸°' : 'â–² ì ‘ê¸°'}
                                </button>
                            </div>
                        </div>
                        <div id="imbalanceTutorialContent" style="display: ${imbalanceTutorialCollapsed ? 'none' : 'block'};">
                            <div style="font-size: 0.95rem; line-height: 1.6; color: var(--text); margin-bottom: 12px; word-break: keep-all;">${text}</div>
                            <div style="display: flex; justify-content: flex-end;">
                                <button onclick="nextImbalanceTutorialStep()" style="padding: 8px 20px; background: #f39c12; color: white; border: none; border-radius: 6px; font-size: 0.9rem; cursor: pointer; font-weight: 600;">ë‹¤ìŒ</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            const existing = document.getElementById('tutorialModal');
            if (existing) existing.remove();
            
            document.body.appendChild(modal);
        }
        
        function nextImbalanceTutorialStep() {
            imbalanceTutorialStep++;
            showImbalanceTutorialStep();
        }
        
        function toggleImbalanceTutorialCollapse() {
            imbalanceTutorialCollapsed = !imbalanceTutorialCollapsed;
            showImbalanceTutorialStep();
        }
        
        function skipImbalanceTutorial() {
            // ê±´ë„ˆë›°ê¸° (ë³´ìƒ ì—†ìŒ)
            imbalanceTutorialActive = false;
            
            const modal = document.getElementById('tutorialModal');
            if (modal) {
                modal.style.opacity = '0';
                modal.style.transition = 'opacity 0.3s';
                setTimeout(() => modal.remove(), 300);
            }
            
            localStorage.setItem('spiritGarden_imbalanceTutorialSeen', 'true');
            showNotification('íŠœí† ë¦¬ì–¼ì„ ê±´ë„ˆë›°ì—ˆìŠµë‹ˆë‹¤.');
        }
        
        function endImbalanceTutorial() {
            imbalanceTutorialActive = false;
            
            const modal = document.getElementById('tutorialModal');
            if (modal) {
                modal.style.opacity = '0';
                modal.style.transition = 'opacity 0.3s';
                setTimeout(() => modal.remove(), 300);
            }
            
            localStorage.setItem('spiritGarden_imbalanceTutorialSeen', 'true');
        }
        
        // ì†ì„± ë¶ˆê· í˜• ì²´í¬ í•¨ìˆ˜ (ìµœì¢… ì†ì„± ê¸°ì¤€)
        function checkImbalanceAndTutorial(spirit) {
            if (!spirit || !spirit.hiddenAttributes) return;
            if (localStorage.getItem('spiritGarden_imbalanceTutorialSeen')) return;
            
            // ë‹¤ë¥¸ íŠœí† ë¦¬ì–¼ì´ ì§„í–‰ ì¤‘ì´ë©´ ì²´í¬í•˜ì§€ ì•ŠìŒ
            if (tutorialActive || tutorial2Active || sickTutorialActive || labTutorialActive || imbalanceTutorialActive) return;
            
            // ë¨¹ì´ ì†ì„±
            const foodAttrs = spirit.hiddenAttributes;
            // í…Œë¼ë¦¬ì›€ ì†ì„±
            const terrariumAttrs = terrarium || { fire: 0, water: 0, wind: 0, earth: 0, light: 0, dark: 0 };
            
            // ìµœì¢… ì†ì„± ê³„ì‚° (ë¨¹ì´ + í…Œë¼ë¦¬ì›€, ìµœëŒ€ 500)
            const finalAttrs = {};
            for (let attr in foodAttrs) {
                finalAttrs[attr] = Math.min(500, foodAttrs[attr] + (terrariumAttrs[attr] || 0));
            }
            
            const attrValues = Object.values(finalAttrs);
            const maxAttr = Math.max(...attrValues);
            const minAttr = Math.min(...attrValues);
            
            // ë¶ˆê· í˜• ì¡°ê±´: ìµœê³  50 ì´ìƒ & ìµœì € 10 ì´í•˜
            if (maxAttr >= 50 && minAttr <= 10) {
                setTimeout(() => {
                    startImbalanceTutorial();
                }, 500);
            }
        }
        
        // ===== ì—°êµ¬ì‹¤ íŠœí† ë¦¬ì–¼ (ì†Œì§€í’ˆ 100ê°œ ì´ìƒ) =====
        let labTutorialStep = 0;
        let labTutorialActive = false;
        let labTutorialCollapsed = false;
        
        const LAB_TUTORIAL_STEPS = [
            {
                type: 'dialog',
                text: 'ì´ì œ ìŠ¬ìŠ¬ ì¸ë²¤í† ë¦¬ì— ìˆëŠ” ë¨¹ì´ë‘ ì¥ì‹í’ˆë•Œë¬¸ì— ê³¨ì¹˜ê°€ ì•„í”„ì§€?'
            },
            {
                type: 'action',
                action: 'openLab',
                text: 'ê·¸ ë…€ì„ë“¤ì„ ì²˜ë¦¬í•  ìˆ˜ ìˆëŠ” ë°©ë²•ì„ ì•Œë ¤ì¤„ê²Œ. ì—°êµ¬ì‹¤ íƒ­ì„ ëˆŒëŸ¬ë´.'
            },
            {
                type: 'dialog',
                text: 'ì—¬ê¸°ì—ì„  ë¨¹ì´ì™€ ì¥ì‹í’ˆì„ í•©ì„±í•´ì„œ ìƒˆë¡œìš´ ë¨¹ì´ì™€ ì¥ì‹í’ˆì„ ì–»ì„ ìˆ˜ ìˆì–´.'
            },
            {
                type: 'dialog',
                text: 'íš¨ê³¼ë„ ì›ì¬ë£Œì™€ ë‹¤ë¥´ë‹ˆê¹Œ ì˜ ì´ìš©í•´ë´.'
            },
            {
                type: 'action',
                action: 'clickSlot1',
                text: 'ì¬ë£Œ1ì„ ëˆŒëŸ¬ë´.'
            },
            {
                type: 'action',
                action: 'selectIngredient1',
                text: 'ë¨¹ì´ ì¤‘ì— 5ê°œ ì´ìƒ ìˆëŠ” ì¬ë£Œë¥¼ ì„ íƒí•´.'
            },
            {
                type: 'action',
                action: 'selectIngredient2',
                text: 'ê·¸ë¦¬ê³  ì¬ë£Œ2ì—ë„ ë˜‘ê°™ì´ ë¨¹ì´ë¥¼ ë„£ì–´ë´.'
            },
            {
                type: 'action',
                action: 'synthesize',
                text: 'ì˜í–ˆì–´. ì´ì œ í•©ì„±í•˜ê¸° ë²„íŠ¼ì„ ëˆŒëŸ¬.'
            },
            {
                type: 'dialog',
                text: 'ì§ , ì™„ì„±! ì´ì œ í•˜ëŠ” ë°©ë²•ì„ ì•Œê² ì§€?'
            },
            {
                type: 'dialog',
                text: 'ë­? ë ˆì‹œí”¼ëŠ” ì—†ëƒê³ ? ë‹¹ì—°íˆ ìˆì§€.'
            },
            {
                type: 'dialog',
                text: 'ì•ˆì¤„ê±°ëƒê³ ? ì‘ ì•ˆì¤„ê±´ë°.'
            },
            {
                type: 'dialog',
                text: '......'
            },
            {
                type: 'dialog',
                text: 'ë†ë‹´ì´ê³ , ì–¼ë§ˆì „ì— ë¶€íƒí•´ì„œ ê³§ ìƒì ì— ë“¤ì–´ì˜¬ê±°ì•¼.'
            },
            {
                type: 'dialog',
                text: 'ê·¸ë˜ë„ ì§ì ‘ ë ˆì‹œí”¼ë¥¼ ì°¾ëŠ” ì¬ë¯¸ë„ ìˆìœ¼ë‹ˆê¹Œ ì •ë§ ë„ì €íˆ ëª¨ë¥´ê² ìœ¼ë©´ ê·¸ë•Œ ì‚¬ ë´.'
            },
            {
                type: 'dialog',
                text: 'ê·¸ëŸ¼ ì—°êµ¬ í˜ë‚´ë¼~'
            }
        ];
        
        function startLabTutorial() {
            const tutorialSeen = localStorage.getItem('spiritGarden_labTutorialSeen');
            if (tutorialSeen) return;
            
            // ì´ë¯¸ ì—°êµ¬ì‹¤ íŠœí† ë¦¬ì–¼ì´ ì§„í–‰ ì¤‘ì´ë©´ ì‹œì‘í•˜ì§€ ì•ŠìŒ
            if (labTutorialActive) return;
            
            // ë‹¤ë¥¸ íŠœí† ë¦¬ì–¼ì´ ì§„í–‰ ì¤‘ì´ë©´ ì‹œì‘í•˜ì§€ ì•ŠìŒ
            if (tutorialActive || tutorial2Active || sickTutorialActive || imbalanceTutorialActive) return;
            
            labTutorialStep = 0;
            labTutorialActive = true;
            showLabTutorialStep();
        }
        
        function showLabTutorialStep() {
            if (labTutorialStep >= LAB_TUTORIAL_STEPS.length) {
                endLabTutorial();
                return;
            }
            
            const step = LAB_TUTORIAL_STEPS[labTutorialStep];
            
            if (step.type === 'dialog') {
                showLabTutorialDialog(step.text);
            } else if (step.type === 'action') {
                showLabTutorialAction(step.text, step.action);
            }
        }
        
        function showLabTutorialDialog(text) {
            const modal = document.createElement('div');
            modal.id = 'tutorialModal';
            modal.style.cssText = `
                position: fixed;
                top: 10px;
                left: 50%;
                transform: translateX(-50%);
                width: 90%;
                max-width: 500px;
                background: var(--card);
                border: 2px solid #555;
                border-radius: 16px;
                padding: 15px;
                z-index: 100000;
                box-shadow: 0 8px 32px rgba(0,0,0,0.3);
            `;
            
            modal.innerHTML = `
                <div style="display: flex; gap: 15px; align-items: flex-start;">
                    <img src="https://raw.githubusercontent.com/mongyeonlab-cpu/mylittleterrarium/main/images/NPC_%EC%84%A0%EB%B0%B0.png" alt="ì„ ë°°" style="width: 150px; height: 150px; object-fit: cover; flex-shrink: 0; display: ${labTutorialCollapsed ? 'none' : 'block'};">
                    <div style="flex: 1;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: ${labTutorialCollapsed ? '0' : '10px'};">
                            <span style="font-size: 1rem; font-weight: 600; color: #555;">ì„ ë°°</span>
                            <div style="display: flex; gap: 6px;">
                                <button onclick="skipLabTutorial()" style="padding: 4px 10px; background: var(--bg); border: 1px solid var(--border); border-radius: 6px; cursor: pointer; font-size: 0.75rem; color: var(--text-muted);">ê±´ë„ˆë›°ê¸°</button>
                                <button onclick="toggleLabTutorialCollapse()" style="padding: 4px 10px; background: var(--bg); border: 1px solid var(--border); border-radius: 6px; cursor: pointer; font-size: 0.75rem; color: var(--text-muted);">
                                    ${labTutorialCollapsed ? 'â–¼ í¼ì¹˜ê¸°' : 'â–² ì ‘ê¸°'}
                                </button>
                            </div>
                        </div>
                        <div id="labTutorialContent" style="display: ${labTutorialCollapsed ? 'none' : 'block'};">
                            <div style="font-size: 0.95rem; line-height: 1.6; color: var(--text); margin-bottom: 12px; word-break: keep-all;">${text}</div>
                            <div style="display: flex; justify-content: flex-end;">
                                <button onclick="nextLabTutorialStep()" style="padding: 8px 20px; background: #333; color: white; border: none; border-radius: 6px; font-size: 0.9rem; cursor: pointer; font-weight: 600;">ë‹¤ìŒ</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            const existing = document.getElementById('tutorialModal');
            if (existing) existing.remove();
            
            document.body.appendChild(modal);
        }
        
        function showLabTutorialAction(text, action) {
            const modal = document.createElement('div');
            modal.id = 'tutorialModal';
            modal.style.cssText = `
                position: fixed;
                top: 10px;
                left: 50%;
                transform: translateX(-50%);
                width: 90%;
                max-width: 500px;
                background: var(--card);
                border: 2px solid #555;
                border-radius: 16px;
                padding: 15px;
                z-index: 100000;
                box-shadow: 0 8px 32px rgba(0,0,0,0.3);
            `;
            
            modal.innerHTML = `
                <div style="display: flex; gap: 15px; align-items: flex-start;">
                    <img src="https://raw.githubusercontent.com/mongyeonlab-cpu/mylittleterrarium/main/images/NPC_%EC%84%A0%EB%B0%B0.png" alt="ì„ ë°°" style="width: 150px; height: 150px; object-fit: cover; flex-shrink: 0; display: ${labTutorialCollapsed ? 'none' : 'block'};">
                    <div style="flex: 1;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: ${labTutorialCollapsed ? '0' : '10px'};">
                            <span style="font-size: 1rem; font-weight: 600; color: #555;">ì„ ë°°</span>
                            <div style="display: flex; gap: 6px;">
                                <button onclick="skipLabTutorial()" style="padding: 4px 10px; background: var(--bg); border: 1px solid var(--border); border-radius: 6px; cursor: pointer; font-size: 0.75rem; color: var(--text-muted);">ê±´ë„ˆë›°ê¸°</button>
                                <button onclick="toggleLabTutorialCollapse()" style="padding: 4px 10px; background: var(--bg); border: 1px solid var(--border); border-radius: 6px; cursor: pointer; font-size: 0.75rem; color: var(--text-muted);">
                                    ${labTutorialCollapsed ? 'â–¼ í¼ì¹˜ê¸°' : 'â–² ì ‘ê¸°'}
                                </button>
                            </div>
                        </div>
                        <div id="labTutorialContent" style="display: ${labTutorialCollapsed ? 'none' : 'block'};">
                            <div style="font-size: 0.95rem; line-height: 1.6; color: var(--text); word-break: keep-all;">${text}</div>
                        </div>
                    </div>
                </div>
            `;
            
            const existing = document.getElementById('tutorialModal');
            if (existing) existing.remove();
            
            document.body.appendChild(modal);
            
            window.tutorialWaitingFor = action;
            highlightLabTutorialTarget(action);
        }
        
        function highlightLabTutorialTarget(action) {
            clearTutorialHighlight();
            
            let targetSelector = null;
            switch(action) {
                case 'openLab':
                    targetSelector = 'button[onclick*="switchTab(\'lab\')"]';
                    break;
                case 'clickSlot1':
                    targetSelector = '#labSlot1';
                    break;
                case 'selectIngredient1':
                    targetSelector = '.lab-item-btn';
                    break;
                case 'selectIngredient2':
                    targetSelector = '#labSlot2';
                    break;
                case 'synthesize':
                    targetSelector = '#synthesizeBtn';
                    break;
            }
            
            if (targetSelector) {
                const target = document.querySelector(targetSelector);
                if (target) {
                    target.classList.add('tutorial-highlight');
                    target.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
            }
        }
        
        function checkLabTutorialAction(action) {
            if (!labTutorialActive) return;
            if (window.tutorialWaitingFor === action) {
                window.tutorialWaitingFor = null;
                clearTutorialHighlight();
                nextLabTutorialStep();
            }
        }
        
        function nextLabTutorialStep() {
            labTutorialStep++;
            showLabTutorialStep();
        }
        
        function toggleLabTutorialCollapse() {
            labTutorialCollapsed = !labTutorialCollapsed;
            showLabTutorialStep();
        }
        
        function skipLabTutorial() {
            // ê±´ë„ˆë›°ê¸°ëŠ” ë³´ìƒ ì—†ì´ ì¢…ë£Œ
            labTutorialActive = false;
            window.tutorialWaitingFor = null;
            clearTutorialHighlight();
            
            const modal = document.getElementById('tutorialModal');
            if (modal) {
                modal.style.opacity = '0';
                modal.style.transition = 'opacity 0.3s';
                setTimeout(() => modal.remove(), 300);
            }
            
            localStorage.setItem('spiritGarden_labTutorialSeen', 'true');
            showNotification('íŠœí† ë¦¬ì–¼ì„ ê±´ë„ˆë›°ì—ˆìŠµë‹ˆë‹¤.');
        }
        
        function endLabTutorial() {
            labTutorialActive = false;
            window.tutorialWaitingFor = null;
            clearTutorialHighlight();
            
            const modal = document.getElementById('tutorialModal');
            if (modal) {
                modal.style.opacity = '0';
                modal.style.transition = 'opacity 0.3s';
                setTimeout(() => modal.remove(), 300);
            }
            
            localStorage.setItem('spiritGarden_labTutorialSeen', 'true');
            
            // ë³´ìƒ ë¯¸ìˆ˜ë ¹ ìƒíƒœë©´ ì•ˆë‚´
            if (!localStorage.getItem('spiritGarden_labTutorialCompleted')) {
                setTimeout(() => {
                    showNotification('ğŸ“ íŠœí† ë¦¬ì–¼ ì™„ë£Œ! ì¼ì§€â†’ë„ì›€ë§ì—ì„œ ë³´ìƒì„ ë°›ìœ¼ì„¸ìš”');
                }, 500);
            }
        }
        
        // ì†Œì§€í’ˆ ê°œìˆ˜ ì²´í¬ ë° ì—°êµ¬ì‹¤ íŠœí† ë¦¬ì–¼ ì‹œì‘
        function checkInventoryAndLabTutorial() {
            if (localStorage.getItem('spiritGarden_labTutorialSeen')) return;
            
            // ì´ë¯¸ ì—°êµ¬ì‹¤ íŠœí† ë¦¬ì–¼ì´ ì§„í–‰ ì¤‘ì´ë©´ ì²´í¬í•˜ì§€ ì•ŠìŒ
            if (labTutorialActive) return;
            
            // ì´ ì†Œì§€í’ˆ ê°œìˆ˜ ê³„ì‚°
            const foodCount = (inventory.food || []).length;
            const decoCount = (inventory.decorations || []).length;
            const totalCount = foodCount + decoCount;
            
            if (totalCount >= 100) {
                setTimeout(() => {
                    startLabTutorial();
                }, 500);
            }
        }
        
        function checkAndShowOpening() {
            const seen = localStorage.getItem('spiritGarden_openingSeen');
            if (!seen) {
                showOpening();
            } else {
                // ì˜¤í”„ë‹ì€ ë´¤ì§€ë§Œ íŠœí† ë¦¬ì–¼ì€ ì•ˆ ë³¸ ê²½ìš°
                const tutorialSeen = localStorage.getItem('spiritGarden_tutorialSeen');
                if (!tutorialSeen) {
                    startTutorial();
                }
            }
        }

        // ëª¨ë°”ì¼ ë””ë²„ê¹… ì •ë³´
        console.log('=== ëª¨ë°”ì¼ ë””ë²„ê¹… ì •ë³´ ===');
        console.log('í˜„ì¬ ì‹œê°„:', new Date().toISOString());
        
        // ì´ˆê¸°í™”
        try {
            console.log('ê²Œì„ ì´ˆê¸°í™” ì‹œì‘...');
            loadGame();
            renderSpirits();
            renderInventory();
            renderShop();
            updateTimeDisplay();
            applyLightMode();
            updateCoinDisplay();
            updateInventoryCollapseUI(); // ì†Œì§€í’ˆ ì ‘í˜ ìƒíƒœ ì ìš©
            startAutoGather(); // ìë™ ì±„ì§‘ ì‹œì‘
            checkAndShowOpening(); // ì˜¤í”„ë‹ ì²´í¬
            checkAchievements(); // ì—…ì  ì²´í¬ (ê¸°ì¡´ ë°ì´í„°ìš©)
            
            // ì—°êµ¬ì‹¤ íŠœí† ë¦¬ì–¼ ì²´í¬ (ì•½ê°„ì˜ ë”œë ˆì´ë¡œ ë‹¤ë¥¸ íŠœí† ë¦¬ì–¼ê³¼ ì¶©ëŒ ë°©ì§€)
            setTimeout(() => {
                checkInventoryAndLabTutorial();
            }, 3000);
            
            console.log('ğŸ‰ ê²Œì„ ì´ˆê¸°í™” ì™„ë£Œ!');
        } catch (error) {
            console.error('âŒ ì´ˆê¸°í™” ì˜¤ë¥˜:', error);
            console.error('ì˜¤ë¥˜ ìŠ¤íƒ:', error.stack);
            alert('ê²Œì„ ì´ˆê¸°í™” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
        }

        // ëª¨ë‹¬ ë°°ê²½ í´ë¦­ ì‹œ ë‹«ê¸°
        document.querySelectorAll('.modal').forEach(modal => {
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.classList.remove('active');
                }
            });
        });
        
        // ===== ëª¨ë°”ì¼ ë ˆì´ì•„ì›ƒ í•¨ìˆ˜ë“¤ =====
        
        function initMobileLayout() {
            const checkMobile = () => {
                const wasMobile = isMobileMode;
                isMobileMode = window.innerWidth <= 768;
                
                if (isMobileMode !== wasMobile) {
                    applyMobileLayout(isMobileMode);
                }
                
                // ìŠ¬ë¼ì´ë” ì¸ë””ì¼€ì´í„° ì—…ë°ì´íŠ¸
                updateSpiritSliderIndicator();
            };
            
            checkMobile();
            window.addEventListener('resize', checkMobile);
            window.addEventListener('resize', updateSubTabPosition);
            
            // ìŠ¬ë¼ì´ë” ìŠ¤í¬ë¡¤ ì´ë²¤íŠ¸ ì´ˆê¸°í™”
            initSpiritSliderScroll();
        }
        
        // ì„œë¸Œíƒ­ ìœ„ì¹˜ ì—…ë°ì´íŠ¸ (ì°½ í¬ê¸° ë³€ê²½ ì‹œ)
        function updateSubTabPosition() {
            const subTabBar = document.getElementById('subTabBar');
            if (!subTabBar || subTabBar.style.display === 'none') return;
            
            if (currentTab === 'shop') {
                const shopTab = document.querySelector('.desktop-tabs .tab:nth-child(4)');
                if (shopTab) {
                    const tabLeft = shopTab.offsetLeft;
                    const subTabWidth = 150;
                    const windowWidth = window.innerWidth;
                    const maxPadding = Math.max(0, Math.min(tabLeft, windowWidth - subTabWidth - 50));
                    subTabBar.style.paddingLeft = maxPadding + 'px';
                }
            } else if (currentTab === 'journal' || currentTab === 'encyclopedia' || currentTab === 'album') {
                const journalTab = document.querySelector('.desktop-tabs .tab:nth-child(6)');
                if (journalTab) {
                    const tabLeft = journalTab.offsetLeft;
                    const subTabWidth = 350;
                    const windowWidth = window.innerWidth;
                    const maxPadding = Math.max(0, Math.min(tabLeft, windowWidth - subTabWidth - 50));
                    subTabBar.style.paddingLeft = maxPadding + 'px';
                }
            }
        }
        
        function applyMobileLayout(isMobile) {
            const mobileHeader = document.getElementById('mobileHeader');
            const mobileGather = document.getElementById('mobileGatherSection');
            const mobileTabs = document.getElementById('mobileTabs');
            const desktopHeaders = document.querySelectorAll('.desktop-header');
            const desktopTabs = document.querySelector('.desktop-tabs');
            
            if (isMobile) {
                document.body.classList.add('mobile-layout');
                if (mobileHeader) mobileHeader.style.display = 'flex';
                if (mobileGather) mobileGather.style.display = 'flex';
                if (mobileTabs) mobileTabs.style.display = 'flex';
                desktopHeaders.forEach(el => el.style.display = 'none');
                if (desktopTabs) desktopTabs.style.display = 'none';
                
                // ì¸ë²¤í† ë¦¬ ë™ê¸°í™” - ì¦‰ì‹œ ë° ì§€ì—° í˜¸ì¶œ
                updateMobileInventoryDisplay();
                syncMobileSelects();
                
                // ìŠ¤í¬ë¡¤ ìŠ¬ë¼ì´ë” ì´ˆê¸°í™”
                setTimeout(() => {
                    initOrUpdateSpiritsSwiper();
                    // ì¸ë²¤í† ë¦¬ ë‹¤ì‹œ ì—…ë°ì´íŠ¸
                    updateMobileInventoryDisplay();
                }, 200);
            } else {
                document.body.classList.remove('mobile-layout');
                document.body.classList.remove('gather-expanded');
                if (mobileHeader) mobileHeader.style.display = 'none';
                if (mobileGather) mobileGather.style.display = 'none';
                if (mobileTabs) mobileTabs.style.display = 'none';
                desktopHeaders.forEach(el => el.style.display = '');
                if (desktopTabs) desktopTabs.style.display = '';
                
                // PCì—ì„œëŠ” ê·¸ë¦¬ë“œ ë³µì›
                initOrUpdateSpiritsSwiper();
            }
        }
        
        function toggleMobileGatherSection() {
            mobileGatherExpanded = !mobileGatherExpanded;
            const content = document.getElementById('mobileGatherContent');
            const arrow = document.getElementById('mobileGatherArrow');
            const toggle = document.querySelector('.mobile-gather-toggle');
            
            if (mobileGatherExpanded) {
                content.classList.add('show');
                arrow.textContent = 'â–²';
                toggle.classList.add('expanded');
                document.body.classList.add('gather-expanded');
                updateMobileInventoryDisplay();
            } else {
                content.classList.remove('show');
                arrow.textContent = 'â–¼';
                toggle.classList.remove('expanded');
                document.body.classList.remove('gather-expanded');
            }
        }
        
        function updateMobileInventoryDisplay() {
            const display = document.getElementById('mobileInventoryDisplay');
            if (!display) return;
            
            // inventoryê°€ ì´ˆê¸°í™”ë˜ì§€ ì•Šì•˜ìœ¼ë©´ ê¸°ë³¸ê°’ ì‚¬ìš©
            if (typeof inventory === 'undefined') return;
            
            let html = '';
            
            // ë¨¹ì´ ì¸ë²¤í† ë¦¬ í‘œì‹œ
            html += '<div style="margin-bottom: 12px;">';
            html += '<div style="color: var(--text-muted); font-size: 0.85rem; margin-bottom: 6px;">ğŸ ë¨¹ì´</div>';
            html += '<div style="display: flex; flex-wrap: wrap; gap: 6px;">';
            
            if (inventory.food && inventory.food.length > 0) {
                const foodCounts = {};
                inventory.food.forEach(f => {
                    foodCounts[f] = (foodCounts[f] || 0) + 1;
                });
                const foodOrder = ['fire', 'water', 'wind', 'earth', 'light', 'dark', 'medicine', 'reconciliation_flower', 'acacia_honey'];
                
                // ê¸°ë³¸ ë¨¹ì´
                foodOrder.forEach(type => {
                    if (foodCounts[type]) {
                        let icon;
                        if (type === 'medicine') {
                            icon = (typeof MEDICINE !== 'undefined' && MEDICINE.icon) || 'ğŸ’Š';
                        } else if (typeof SYNTH_ITEMS !== 'undefined' && SYNTH_ITEMS[type]) {
                            icon = SYNTH_ITEMS[type].icon;
                        } else {
                            icon = (typeof ENV_ICONS !== 'undefined' && ENV_ICONS[type]) || 'ğŸ';
                        }
                        html += `<div style="padding: 4px 8px; background: var(--bg); border: 1px solid var(--border); border-radius: 4px; font-size: 0.8rem;">${icon} Ã—${foodCounts[type]}</div>`;
                    }
                });
                
                // ì´ë²¤íŠ¸ ë¨¹ì´
                Object.keys(foodCounts).forEach(key => {
                    if (!foodOrder.includes(key)) {
                        let icon = 'ğŸ';
                        let borderColor = 'var(--border)';
                        let label = '';
                        const legendaryMaterials = ['moon_cheese', 'golden_apple'];
                        if (typeof EVENT_ITEMS !== 'undefined' && EVENT_ITEMS[key]) {
                            icon = EVENT_ITEMS[key].icon;
                            borderColor = '#c41e3a';
                        } else if (typeof SYNTH_ITEMS !== 'undefined' && SYNTH_ITEMS[key]) {
                            icon = SYNTH_ITEMS[key].icon;
                            if (legendaryMaterials.includes(key)) {
                                borderColor = '#ffd700';
                                label = 'ğŸŒŒ';
                            } else {
                                borderColor = '#9b59b6';
                            }
                        }
                        html += `<div style="padding: 4px 8px; background: var(--bg); border: 2px solid ${borderColor}; border-radius: 4px; font-size: 0.8rem;">${label}${icon} Ã—${foodCounts[key]}</div>`;
                    }
                });
            } else {
                html += '<div style="padding: 4px 8px; background: var(--bg); border: 1px solid var(--border); border-radius: 4px; font-size: 0.8rem; color: var(--text-muted);">ì—†ìŒ</div>';
            }
            html += '</div></div>';
            
            // ë ˆì½”ë“œ ì¸ë²¤í† ë¦¬ í‘œì‹œ
            html += '<div style="margin-bottom: 12px;">';
            html += '<div style="color: var(--text-muted); font-size: 0.85rem; margin-bottom: 6px;">ğŸ¼ ë ˆì½”ë“œ</div>';
            html += '<div style="display: flex; flex-wrap: wrap; gap: 6px;">';
            
            if (inventory.music && inventory.music.length > 0) {
                const musicCounts = {};
                inventory.music.forEach(m => {
                    musicCounts[m] = (musicCounts[m] || 0) + 1;
                });
                
                // ëª¨ë“  MUSIC_TYPES ë ˆì½”ë“œ í‘œì‹œ
                Object.keys(musicCounts).forEach(type => {
                    if (typeof MUSIC_TYPES !== 'undefined' && MUSIC_TYPES[type]) {
                        const musicData = MUSIC_TYPES[type];
                        const tierColor = musicData.tier === 4 ? '#ffd700' : musicData.tier === 3 ? '#9b59b6' : musicData.tier === 2 ? '#3498db' : 'var(--border)';
                        const tierLabel = musicData.tier === 4 ? 'ğŸ‘‘' : musicData.tier === 3 ? 'âœ¨' : musicData.tier === 2 ? 'â˜…' : '';
                        html += `<div style="padding: 4px 8px; background: var(--bg); border: 2px solid ${tierColor}; border-radius: 4px; font-size: 0.8rem;">${tierLabel}${musicData.icon} Ã—${musicCounts[type]}</div>`;
                    }
                });
                
                // ì´ë²¤íŠ¸ ìŒì•…
                Object.keys(musicCounts).forEach(key => {
                    if (typeof EVENT_ITEMS !== 'undefined' && EVENT_ITEMS[key] && EVENT_ITEMS[key].type === 'music') {
                        html += `<div style="padding: 4px 8px; background: var(--bg); border: 2px solid #c41e3a; border-radius: 4px; font-size: 0.8rem;">${EVENT_ITEMS[key].icon} Ã—${musicCounts[key]}</div>`;
                    }
                });
            } else {
                html += '<div style="padding: 4px 8px; background: var(--bg); border: 1px solid var(--border); border-radius: 4px; font-size: 0.8rem; color: var(--text-muted);">ì—†ìŒ</div>';
            }
            html += '</div></div>';
            
            // ë¯¸ë‹ˆì–´ì³ ì¸ë²¤í† ë¦¬ í‘œì‹œ
            html += '<div style="margin-bottom: 12px;">';
            html += '<div style="color: var(--text-muted); font-size: 0.85rem; margin-bottom: 6px;">ğŸª´ ë¯¸ë‹ˆì–´ì³</div>';
            html += '<div style="display: flex; flex-wrap: wrap; gap: 6px;">';
            
            if (inventory.decorations && inventory.decorations.length > 0) {
                const decorCounts = {};
                inventory.decorations.forEach(d => {
                    decorCounts[d] = (decorCounts[d] || 0) + 1;
                });
                
                Object.keys(decorCounts).forEach(key => {
                    let icon = 'ğŸª´';
                    let borderColor = 'var(--border)';
                    let qualityLabel = '';
                    
                    // ì¼ë°˜ ë¯¸ë‹ˆì–´ì²˜
                    if (typeof DECORATION_TYPES !== 'undefined' && DECORATION_TYPES[key]) {
                        const decoData = DECORATION_TYPES[key];
                        icon = decoData.icon;
                        qualityLabel = decoData.quality === 'legendary' ? 'ğŸ‘‘' : decoData.quality === 'epic' ? 'â­' : decoData.quality === 'rare' ? 'ğŸ’' : '';
                        borderColor = decoData.quality === 'legendary' ? '#ffd700' : decoData.quality === 'epic' ? '#9b59b6' : decoData.quality === 'rare' ? '#3498db' : 'var(--border)';
                    }
                    // í•©ì„± ë¯¸ë‹ˆì–´ì²˜
                    else if (typeof SYNTH_ITEMS !== 'undefined' && SYNTH_ITEMS[key] && SYNTH_ITEMS[key].type === 'decoration') {
                        icon = SYNTH_ITEMS[key].icon;
                        borderColor = '#9b59b6';
                    }
                    // ì´ë²¤íŠ¸ ë¯¸ë‹ˆì–´ì²˜
                    else if (typeof EVENT_ITEMS !== 'undefined' && EVENT_ITEMS[key] && EVENT_ITEMS[key].type === 'decoration') {
                        icon = EVENT_ITEMS[key].icon;
                        qualityLabel = EVENT_ITEMS[key].quality === 'legendary' ? 'ğŸ‘‘' : EVENT_ITEMS[key].quality === 'epic' ? 'â­' : EVENT_ITEMS[key].quality === 'rare' ? 'ğŸ’' : '';
                        borderColor = EVENT_ITEMS[key].quality === 'legendary' ? '#ffd700' : EVENT_ITEMS[key].quality === 'epic' ? '#9b59b6' : EVENT_ITEMS[key].quality === 'rare' ? '#3498db' : '#c41e3a';
                    }
                    
                    html += `<div style="padding: 4px 8px; background: var(--bg); border: 2px solid ${borderColor}; border-radius: 4px; font-size: 0.8rem;">${qualityLabel}${icon} Ã—${decorCounts[key]}</div>`;
                });
            } else {
                html += '<div style="padding: 4px 8px; background: var(--bg); border: 1px solid var(--border); border-radius: 4px; font-size: 0.8rem; color: var(--text-muted);">ì—†ìŒ</div>';
            }
            html += '</div></div>';
            
            // ì½”ì¸ í‘œì‹œ
            html += `<div style="font-size: 0.9rem; font-weight: 600;">ğŸ’° ì½”ì¸: ${typeof coins !== 'undefined' ? coins : 0}</div>`;
            
            display.innerHTML = html;
        }
        
        function syncMobileSelects() {
            const desktopTitle = document.getElementById('titleSelect');
            const mobileTitle = document.getElementById('mobileTitleSelect');
            const desktopLocation = document.getElementById('gatherLocationSelect');
            const mobileLocation = document.getElementById('mobileLocationSelect');
            
            if (desktopTitle && mobileTitle) {
                mobileTitle.value = desktopTitle.value;
            }
            if (desktopLocation && mobileLocation) {
                mobileLocation.value = desktopLocation.value;
            }
        }
        
        // ì¸ë²¤í† ë¦¬ ì—…ë°ì´íŠ¸ ì‹œ ëª¨ë°”ì¼ í‘œì‹œë„ ì—…ë°ì´íŠ¸
        const originalRenderInventory = typeof renderInventory === 'function' ? renderInventory : null;
        if (originalRenderInventory) {
            renderInventory = function() {
                originalRenderInventory();
                if (isMobileMode) {
                    updateMobileInventoryDisplay();
                }
            };
        }
        
        // ì½”ì¸ ì—…ë°ì´íŠ¸ ì‹œ ëª¨ë°”ì¼ë„ ì—…ë°ì´íŠ¸
        const originalUpdateCoinDisplay = typeof updateCoinDisplay === 'function' ? updateCoinDisplay : null;
        if (originalUpdateCoinDisplay) {
            updateCoinDisplay = function() {
                originalUpdateCoinDisplay();
                if (isMobileMode) {
                    updateMobileInventoryDisplay();
                }
            };
        }
        
        // íƒ­ ì „í™˜ ì‹œ ì±„ì§‘ ì„¹ì…˜ í‘œì‹œ/ìˆ¨ê¹€
        const originalSwitchTab = switchTab;
        switchTab = function(tabName) {
            originalSwitchTab(tabName);
            
            if (isMobileMode) {
                const mobileGather = document.getElementById('mobileGatherSection');
                if (tabName === 'garden') {
                    if (mobileGather) mobileGather.style.display = 'flex';
                    document.body.classList.add('mobile-layout');
                    if (mobileGatherExpanded) {
                        document.body.classList.add('gather-expanded');
                    }
                } else {
                    if (mobileGather) mobileGather.style.display = 'none';
                    document.body.classList.remove('gather-expanded');
                }
                
                // íƒ­ í™œì„±í™” ìƒíƒœ ë™ê¸°í™”
                document.querySelectorAll('#mobileTabs .tab').forEach(tab => {
                    const tabText = tab.textContent.trim();
                    const tabMap = {
                        'ìœ¡ì„±': 'garden',
                        'í…Œë¼ë¦¬ì›€': 'terrarium', 
                        'ì—°êµ¬ì‹¤': 'lab',
                        'ìƒì ': 'shop',
                        'ê²Œì„': 'minigame',
                        'ì¼ì§€': 'journal'
                    };
                    tab.classList.toggle('active', tabMap[tabText] === tabName);
                });
            }
        };
        
        // ì´ˆê¸°í™” ì‹œ ëª¨ë°”ì¼ ë ˆì´ì•„ì›ƒ ì²´í¬
        setTimeout(() => {
            initMobileLayout();
        }, 100);
    </script>
    
    <!-- í”Œë¡œíŒ… ìŠ¤í¬ë¡¤ ë²„íŠ¼ -->
    <div class="scroll-buttons">
        <button class="scroll-btn" onclick="window.scrollTo({top: 0, behavior: 'smooth'})" title="ë§¨ ìœ„ë¡œ">â¬†ï¸</button>
        <button class="scroll-btn" onclick="window.scrollTo({top: document.body.scrollHeight, behavior: 'smooth'})" title="ë§¨ ì•„ë˜ë¡œ">â¬‡ï¸</button>
    </div>
</body>
</html>
